!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,(function(r){return o(e[i][1][r]||r)}),p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */function binarySearch(arr,target,comparator){return function(arr,target,comparator){var left=0,right=arr.length,middle=0,found=!1;for(;left<right;){var compareResult=comparator(target,arr[middle=left+(right-left>>>1)]);compareResult>0?left=middle+1:(right=middle,found=!compareResult)}return found?left:-left-1}(arr,target,comparator||defaultComparator)}function defaultComparator(a,b){return a>b?1:a<b?-1:0}Object.defineProperty(exports,"__esModule",{value:!0}),exports.binaryInsert=function(arr,element,comparator){var index=binarySearch(arr,element,comparator),insertionPoint=index<0?-(index+1):index;arr.splice(insertionPoint,0,element)},exports.binarySearch=binarySearch},{}],2:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.EPSILON_FLOAT32=1e-7,exports.EPSILON_FLOAT16=1e-4;var DataStorage=function(){function DataStorage(backend,dataMover){this.backend=backend,this.dataMover=dataMover,this.data=new WeakMap,this.dataIdsCount=0}return DataStorage.prototype.get=function(dataId){return this.data.has(dataId)||this.dataMover.moveData(this.backend,dataId),this.data.get(dataId)},DataStorage.prototype.set=function(dataId,value){this.dataIdsCount++,this.data.set(dataId,value)},DataStorage.prototype.has=function(dataId){return this.data.has(dataId)},DataStorage.prototype.delete=function(dataId){return this.dataIdsCount--,this.data.delete(dataId)},DataStorage.prototype.numDataIds=function(){return this.dataIdsCount},DataStorage}();exports.DataStorage=DataStorage;var KernelBackend=function(){function KernelBackend(){}return KernelBackend.prototype.time=function(f){return notYetImplemented("time")},KernelBackend.prototype.read=function(dataId){return notYetImplemented("read")},KernelBackend.prototype.readSync=function(dataId){return notYetImplemented("readSync")},KernelBackend.prototype.numDataIds=function(){return notYetImplemented("numDataIds")},KernelBackend.prototype.disposeData=function(dataId){return notYetImplemented("disposeData")},KernelBackend.prototype.write=function(values,shape,dtype){return notYetImplemented("write")},KernelBackend.prototype.move=function(dataId,values,shape,dtype){return notYetImplemented("move")},KernelBackend.prototype.memory=function(){return notYetImplemented("memory")},KernelBackend.prototype.floatPrecision=function(){return notYetImplemented("floatPrecision")},KernelBackend.prototype.epsilon=function(){return 32===this.floatPrecision()?exports.EPSILON_FLOAT32:exports.EPSILON_FLOAT16},KernelBackend.prototype.batchMatMul=function(a,b,transposeA,transposeB){return notYetImplemented("batchMatMul")},KernelBackend.prototype.fusedBatchMatMul=function(_a){_a.a,_a.b,_a.transposeA,_a.transposeB,_a.bias,_a.activation,_a.preluActivationWeights;return notYetImplemented("fusedBatchMatMul")},KernelBackend.prototype.slice=function(x,begin,size){return notYetImplemented("slice")},KernelBackend.prototype.stridedSlice=function(x,begin,end,strides){return notYetImplemented("stridedSlice")},KernelBackend.prototype.unstack=function(x,axis){return notYetImplemented("unstack")},KernelBackend.prototype.reverse=function(a,axis){return notYetImplemented("reverse")},KernelBackend.prototype.concat=function(tensors,axis){return notYetImplemented("concat")},KernelBackend.prototype.neg=function(a){return notYetImplemented("neg")},KernelBackend.prototype.add=function(a,b){return notYetImplemented("add")},KernelBackend.prototype.addN=function(tensors){return notYetImplemented("addN")},KernelBackend.prototype.subtract=function(a,b){return notYetImplemented("subtract")},KernelBackend.prototype.multiply=function(a,b){return notYetImplemented("multiply")},KernelBackend.prototype.realDivide=function(a,b){return notYetImplemented("realDivide")},KernelBackend.prototype.floorDiv=function(a,b){return notYetImplemented("floorDiv")},KernelBackend.prototype.sum=function(x,axes){return notYetImplemented("sum")},KernelBackend.prototype.prod=function(x,axes){return notYetImplemented("prod")},KernelBackend.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){return notYetImplemented("unsortedSegmentSum")},KernelBackend.prototype.argMin=function(x,axis){return notYetImplemented("argMin")},KernelBackend.prototype.argMax=function(x,axis){return notYetImplemented("argMax")},KernelBackend.prototype.equal=function(a,b){return notYetImplemented("equal")},KernelBackend.prototype.notEqual=function(a,b){return notYetImplemented("notEqual")},KernelBackend.prototype.less=function(a,b){return notYetImplemented("less")},KernelBackend.prototype.lessEqual=function(a,b){return notYetImplemented("lessEqual")},KernelBackend.prototype.greater=function(a,b){return notYetImplemented("greater")},KernelBackend.prototype.greaterEqual=function(a,b){return notYetImplemented("greaterEqual")},KernelBackend.prototype.logicalNot=function(a){return notYetImplemented("logicalNot")},KernelBackend.prototype.logicalAnd=function(a,b){return notYetImplemented("logicalAnd")},KernelBackend.prototype.logicalOr=function(a,b){return notYetImplemented("logicalOr")},KernelBackend.prototype.where=function(condition){return notYetImplemented("where")},KernelBackend.prototype.select=function(condition,a,b){return notYetImplemented("select")},KernelBackend.prototype.topk=function(x,k,sorted){return notYetImplemented("topk")},KernelBackend.prototype.min=function(x,axes){return notYetImplemented("min")},KernelBackend.prototype.minimum=function(a,b){return notYetImplemented("minimum")},KernelBackend.prototype.mod=function(a,b){return notYetImplemented("mod")},KernelBackend.prototype.max=function(x,axes){return notYetImplemented("max")},KernelBackend.prototype.maximum=function(a,b){return notYetImplemented("maximum")},KernelBackend.prototype.all=function(x,axes){return notYetImplemented("all")},KernelBackend.prototype.any=function(x,axes){return notYetImplemented("any")},KernelBackend.prototype.squaredDifference=function(a,b){return notYetImplemented("squaredDifference")},KernelBackend.prototype.ceil=function(x){return notYetImplemented("ceil")},KernelBackend.prototype.floor=function(x){return notYetImplemented("floor")},KernelBackend.prototype.round=function(x){return notYetImplemented("round")},KernelBackend.prototype.sign=function(x){return notYetImplemented("sign")},KernelBackend.prototype.isNaN=function(x){return notYetImplemented("isNaN")},KernelBackend.prototype.isInf=function(x){return notYetImplemented("isInf")},KernelBackend.prototype.isFinite=function(x){return notYetImplemented("isFinite")},KernelBackend.prototype.pow=function(a,b){return notYetImplemented("pow")},KernelBackend.prototype.exp=function(x){return notYetImplemented("exp")},KernelBackend.prototype.expm1=function(x){return notYetImplemented("expm1")},KernelBackend.prototype.softmax=function(x,dim){return notYetImplemented("softmax")},KernelBackend.prototype.log=function(x){return notYetImplemented("log")},KernelBackend.prototype.log1p=function(x){return notYetImplemented("log1p")},KernelBackend.prototype.sqrt=function(x){return notYetImplemented("sqrt")},KernelBackend.prototype.rsqrt=function(x){return notYetImplemented("rsqrt")},KernelBackend.prototype.square=function(x){return notYetImplemented("square")},KernelBackend.prototype.reciprocal=function(x){return notYetImplemented("reciprocal")},KernelBackend.prototype.relu=function(x){return notYetImplemented("relu")},KernelBackend.prototype.relu6=function(x){return notYetImplemented("relu6")},KernelBackend.prototype.prelu=function(x,a){return notYetImplemented("prelu")},KernelBackend.prototype.elu=function(x){return notYetImplemented("elu")},KernelBackend.prototype.eluDer=function(dy,y){return notYetImplemented("eluDer")},KernelBackend.prototype.selu=function(x){return notYetImplemented("selu")},KernelBackend.prototype.int=function(x){return notYetImplemented("int")},KernelBackend.prototype.clip=function(x,min,max){return notYetImplemented("clip")},KernelBackend.prototype.abs=function(x){return notYetImplemented("abs")},KernelBackend.prototype.complexAbs=function(x){return notYetImplemented("complexAbs")},KernelBackend.prototype.sigmoid=function(x){return notYetImplemented("sigmoid")},KernelBackend.prototype.softplus=function(x){return notYetImplemented("softplus")},KernelBackend.prototype.sin=function(x){return notYetImplemented("sin")},KernelBackend.prototype.cos=function(x){return notYetImplemented("cos")},KernelBackend.prototype.tan=function(x){return notYetImplemented("tan")},KernelBackend.prototype.asin=function(x){return notYetImplemented("asin")},KernelBackend.prototype.acos=function(x){return notYetImplemented("acos")},KernelBackend.prototype.atan=function(x){return notYetImplemented("atan")},KernelBackend.prototype.atan2=function(a,b){return notYetImplemented("atan2")},KernelBackend.prototype.sinh=function(x){return notYetImplemented("sinh")},KernelBackend.prototype.cosh=function(x){return notYetImplemented("cosh")},KernelBackend.prototype.tanh=function(x){return notYetImplemented("tanh")},KernelBackend.prototype.asinh=function(x){return notYetImplemented("asinh")},KernelBackend.prototype.acosh=function(x){return notYetImplemented("acosh")},KernelBackend.prototype.atanh=function(x){return notYetImplemented("atanh")},KernelBackend.prototype.erf=function(x){return notYetImplemented("erf")},KernelBackend.prototype.step=function(x,alpha){return notYetImplemented("step")},KernelBackend.prototype.fusedConv2d=function(_a){_a.input,_a.filter,_a.convInfo,_a.bias,_a.activation,_a.preluActivationWeights;return notYetImplemented("fusedConv2d")},KernelBackend.prototype.conv2d=function(x,filter,convInfo){return notYetImplemented("conv2d")},KernelBackend.prototype.conv2dDerInput=function(dy,filter,convInfo){return notYetImplemented("conv2dDerInput")},KernelBackend.prototype.conv2dDerFilter=function(x,dY,convInfo){return notYetImplemented("conv2dDerFilter")},KernelBackend.prototype.fusedDepthwiseConv2D=function(_a){_a.input,_a.filter,_a.convInfo,_a.bias,_a.activation,_a.preluActivationWeights;return notYetImplemented("fusedDepthwiseConv2D")},KernelBackend.prototype.depthwiseConv2D=function(input,filter,convInfo){return notYetImplemented("depthwiseConv2D")},KernelBackend.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){return notYetImplemented("depthwiseConv2DDerInput")},KernelBackend.prototype.depthwiseConv2DDerFilter=function(x,dY,convInfo){return notYetImplemented("depthwiseConv2DDerFilter")},KernelBackend.prototype.conv3d=function(x,filter,convInfo){return notYetImplemented("conv3d")},KernelBackend.prototype.conv3dDerInput=function(dy,filter,convInfo){return notYetImplemented("conv3dDerInput")},KernelBackend.prototype.conv3dDerFilter=function(x,dY,convInfo){return notYetImplemented("conv3dDerFilter")},KernelBackend.prototype.maxPool=function(x,convInfo){return notYetImplemented("maxPool")},KernelBackend.prototype.maxPoolBackprop=function(dy,x,y,convInfo){return notYetImplemented("maxPoolBackprop")},KernelBackend.prototype.avgPool=function(x,convInfo){return notYetImplemented("avgPool")},KernelBackend.prototype.avgPoolBackprop=function(dy,x,convInfo){return notYetImplemented("avgPoolBackprop")},KernelBackend.prototype.avgPool3d=function(x,convInfo){return notYetImplemented("avgPool3d")},KernelBackend.prototype.avgPool3dBackprop=function(dy,x,convInfo){return notYetImplemented("avgPool3dBackprop")},KernelBackend.prototype.maxPool3d=function(x,convInfo){return notYetImplemented("maxPool3d")},KernelBackend.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){return notYetImplemented("maxPool3dBackprop")},KernelBackend.prototype.reshape=function(x,shape){return notYetImplemented("reshape")},KernelBackend.prototype.cast=function(x,dtype){return notYetImplemented("cast")},KernelBackend.prototype.tile=function(x,reps){return notYetImplemented("tile")},KernelBackend.prototype.pad=function(x,paddings,constantValue){return notYetImplemented("pad")},KernelBackend.prototype.transpose=function(x,perm){return notYetImplemented("transpose")},KernelBackend.prototype.gather=function(x,indices,axis){return notYetImplemented("gather")},KernelBackend.prototype.gatherND=function(x,indices){return notYetImplemented("gatherND")},KernelBackend.prototype.scatterND=function(indices,updates,shape){return notYetImplemented("scatterND")},KernelBackend.prototype.batchToSpaceND=function(x,blockShape,crops){return notYetImplemented("batchToSpaceND")},KernelBackend.prototype.spaceToBatchND=function(x,blockShape,paddings){return notYetImplemented("spaceToBatchND")},KernelBackend.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){return notYetImplemented("resizeBilinear")},KernelBackend.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){return notYetImplemented("resizeBilinearBackprop")},KernelBackend.prototype.resizeNearestNeighbor=function(x,newHEight,newWidth,alignCorners){return notYetImplemented("resizeNearestNeighbor")},KernelBackend.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){return notYetImplemented("resizeNearestNeighborBackprop")},KernelBackend.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){return notYetImplemented("batchNormalization")},KernelBackend.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){return notYetImplemented("localResponseNormalization4D")},KernelBackend.prototype.LRNGrad=function(dy,inputImage,outputImage,radius,bias,alpha,beta){return notYetImplemented("LRNGrad")},KernelBackend.prototype.multinomial=function(logits,normalized,numSamples,seed){return notYetImplemented("multinomial")},KernelBackend.prototype.oneHot=function(indices,depth,onValue,offValue){return notYetImplemented("oneHot")},KernelBackend.prototype.cumsum=function(x,axis,exclusive,reverse){return notYetImplemented("cumsum")},KernelBackend.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){return notYetImplemented("nonMaxSuppression")},KernelBackend.prototype.fft=function(x){return notYetImplemented("fft")},KernelBackend.prototype.ifft=function(x){return notYetImplemented("ifft")},KernelBackend.prototype.complex=function(real,imag){return notYetImplemented("complex")},KernelBackend.prototype.real=function(input){return notYetImplemented("real")},KernelBackend.prototype.imag=function(input){return notYetImplemented("imag")},KernelBackend.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){return notYetImplemented("cropAndResize")},KernelBackend.prototype.depthToSpace=function(x,blockSize,dataFormat){return notYetImplemented("depthToSpace")},KernelBackend.prototype.split=function(value,sizeSplits,axis){return notYetImplemented("split")},KernelBackend.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){return notYetImplemented("sparseToDense")},KernelBackend.prototype.diag=function(x){return notYetImplemented("diag")},KernelBackend.prototype.fill=function(shape,value,dtype){return notYetImplemented("fill")},KernelBackend.prototype.onesLike=function(x){return notYetImplemented("onesLike")},KernelBackend.prototype.zerosLike=function(x){return notYetImplemented("zerosLike")},KernelBackend.prototype.linspace=function(start,stop,num){return notYetImplemented("linspace")},KernelBackend.prototype.dispose=function(){return notYetImplemented("dispose")},KernelBackend}();function notYetImplemented(kernelName){throw new Error("'"+kernelName+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}exports.KernelBackend=KernelBackend},{}],3:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util");__export(require("../ops/axis_util")),__export(require("../ops/broadcast_util")),__export(require("../ops/concat_util")),__export(require("../ops/conv_util")),__export(require("../ops/reduce_util"));var types_1=require("../types");exports.upcastType=types_1.upcastType,exports.castTensor=function(x,dtype,backend){if("complex64"===dtype){if("complex64"===x.dtype)return x.clone();var zerosTensor=tensor_ops_1.zeros(x.shape),floatX=x.toFloat(),result=backend.complex(floatX,zerosTensor);return zerosTensor.dispose(),floatX.dispose(),result}if(!util_1.hasEncodingLoss(x.dtype,dtype))return engine_1.ENGINE.makeTensorFromDataId(x.dataId,x.shape,dtype);if("complex64"===x.dtype){var real=backend.real(x);result=real.cast(dtype);return real.dispose(),result}if("int32"===dtype)return backend.int(x);if("bool"===dtype){var zero=tensor_ops_1.scalar(0,x.dtype);result=backend.notEqual(x,zero);return zero.dispose(),result}throw new Error("Error in Cast: failed to cast "+x.dtype+" to "+dtype)},exports.reshapeTensor=function(x,shape){return engine_1.ENGINE.makeTensorFromDataId(x.dataId,shape,x.dtype)},exports.linspaceImpl=function(start,stop,num){var step=(stop-start)/(num-1),values=util_1.makeZerosTypedArray(num,"float32");values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor_ops_1.tensor1d(values,"float32")}},{"../engine":106,"../ops/axis_util":132,"../ops/broadcast_util":136,"../ops/concat_util":141,"../ops/conv_util":144,"../ops/reduce_util":167,"../ops/tensor_ops":186,"../types":213,"../util":214}],4:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeRealAndImagArrays=function(real,imag){if(real.length!==imag.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+real.length+", imag: "+imag.length+".");for(var result=new Float32Array(2*real.length),i=0;i<result.length;i+=2)result[i]=real[i/2],result[i+1]=imag[i/2];return result},exports.splitRealAndImagArrays=function(complex){for(var real=new Float32Array(complex.length/2),imag=new Float32Array(complex.length/2),i=0;i<complex.length;i+=2)real[i/2]=complex[i],imag[i/2]=complex[i+1];return{real:real,imag:imag}},exports.complexWithEvenIndex=function(complex){for(var len=Math.ceil(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=0;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.complexWithOddIndex=function(complex){for(var len=Math.floor(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=2;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.getComplexWithIndex=function(complex,index){return{real:complex[2*index],imag:complex[2*index+1]}},exports.assignToTypedArray=function(data,real,imag,index){data[2*index]=real,data[2*index+1]=imag},exports.exponents=function(n,inverse){for(var real=new Float32Array(n/2),imag=new Float32Array(n/2),i=0;i<Math.ceil(n/2);i++){var x=(inverse?2:-2)*Math.PI*(i/n);real[i]=Math.cos(x),imag[i]=Math.sin(x)}return{real:real,imag:imag}},exports.exponent=function(k,n,inverse){var x=(inverse?2:-2)*Math.PI*(k/n);return{real:Math.cos(x),imag:Math.sin(x)}}},{}],5:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),engine_1=require("../../engine"),environment_1=require("../../environment"),log_1=require("../../log"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),broadcast_util=require("../../ops/broadcast_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util=require("../../ops/concat_util"),erf_util=require("../../ops/erf_util"),gather_nd_util=require("../../ops/gather_nd_util"),ops=require("../../ops/ops"),ops_1=require("../../ops/ops"),scatter_nd_util=require("../../ops/scatter_nd_util"),selu_util=require("../../ops/selu_util"),slice_util_1=require("../../ops/slice_util"),tensor_1=require("../../tensor"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl"),cpu_util_1=require("./cpu_util");function mapActivation(backend,x,activation,preluActivationWeights){if("linear"===activation)return backend.linear(x);if("relu"===activation)return backend.relu(x);if("elu"===activation)return backend.elu(x);if("relu6"===activation)return backend.relu6(x);if("prelu"===activation)return backend.prelu(x,preluActivationWeights);throw new Error("Activation "+activation+" has not been implemented for the CPU backend.")}var MathBackendCPU=function(_super){function MathBackendCPU(){var _this=_super.call(this)||this;return _this.blockSize=48,_this.firstUse=!0,_this.data=new backend_1.DataStorage(_this,engine_1.ENGINE),_this}return __extends(MathBackendCPU,_super),MathBackendCPU.prototype.write=function(values,shape,dtype){this.firstUse&&(this.firstUse=!1,environment_1.env().get("IS_NODE")&&log_1.warn("\n============================\nHi there 👋. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var dataId={};return this.data.set(dataId,{values:values,dtype:dtype}),dataId},MathBackendCPU.prototype.move=function(dataId,values,shape,dtype){this.data.set(dataId,{values:values,dtype:dtype})},MathBackendCPU.prototype.numDataIds=function(){return this.data.numDataIds()},MathBackendCPU.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.readSync(dataId)]}))}))},MathBackendCPU.prototype.readSync=function(dataId){var _a=this.data.get(dataId),dtype=_a.dtype,complexTensors=_a.complexTensors;if("complex64"===dtype){var realValues=this.readSync(complexTensors.real.dataId),imagValues=this.readSync(complexTensors.imag.dataId);return complex_util.mergeRealAndImagArrays(realValues,imagValues)}return this.data.get(dataId).values},MathBackendCPU.prototype.bufferSync=function(t){var data=this.readSync(t.dataId),decodedData=data;if("string"===t.dtype)try{decodedData=data.map((function(d){return util.decodeString(d)}))}catch(_a){throw new Error("Failed to decode encoded string bytes into utf-8")}return ops_1.buffer(t.shape,t.dtype,decodedData)},MathBackendCPU.prototype.makeOutput=function(values,shape,dtype){var dataId=this.write(values,shape,dtype);return engine_1.ENGINE.makeTensorFromDataId(dataId,shape,dtype,this)},MathBackendCPU.prototype.disposeData=function(dataId){if(this.data.has(dataId)){var complexTensors=this.data.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.data.delete(dataId)}},MathBackendCPU.prototype.time=function(f){return __awaiter(this,void 0,void 0,(function(){var start;return __generator(this,(function(_a){return start=util_1.now(),f(),[2,{kernelMs:util_1.now()-start}]}))}))},MathBackendCPU.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},MathBackendCPU.prototype.complex=function(real,imag){var result=this.makeOutput(null,real.shape,"complex64");return this.data.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendCPU.prototype.real=function(input){return this.data.get(input.dataId).complexTensors.real.clone()},MathBackendCPU.prototype.imag=function(input){return this.data.get(input.dataId).complexTensors.imag.clone()},MathBackendCPU.prototype.slice=function(x,begin,size){if(cpu_util_1.assertNotComplex(x,"slice"),slice_util_1.isSliceContinous(x.shape,begin,size)){var flatOffset=slice_util_1.computeFlatOffset(begin,x.strides),length_1=util.sizeFromShape(size),vals=this.readSync(x.dataId);return ops_1.tensor(vals.subarray(flatOffset,flatOffset+length_1),size,x.dtype)}for(var buffer=ops.buffer(size,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;++i){var xLoc=buffer.indexToLoc(i).map((function(idx,j){return idx+begin[j]}));buffer.values[i]=xBuf.get.apply(xBuf,xLoc)}return buffer.toTensor()},MathBackendCPU.prototype.stridedSlice=function(x,begin,end,strides){cpu_util_1.assertNotComplex(x,"stridedSlice");var outShape=slice_util_1.computeOutShape(begin,end,strides);if(outShape.some((function(axis){return 0===axis})))return ops.tensor([],outShape);for(var buffer=ops.buffer(outShape,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;i++){for(var loc=buffer.indexToLoc(i),newLoc=new Array(loc.length),j=0;j<newLoc.length;j++)newLoc[j]=loc[j]*strides[j]+begin[j];buffer.set.apply(buffer,[xBuf.get.apply(xBuf,newLoc)].concat(loc))}return buffer.toTensor()},MathBackendCPU.prototype.diag=function(x){for(var xVals=this.readSync(x.dataId),buffer=ops.buffer([x.size,x.size],x.dtype),vals=buffer.values,i=0;i<xVals.length;i++)vals[i*x.size+i]=xVals[i];return buffer.toTensor()},MathBackendCPU.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)begin[axis]=i,res[i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendCPU.prototype.reverse=function(x,axis){cpu_util_1.assertNotComplex(x,"reverse");for(var buffer=ops.buffer(x.shape,x.dtype),xBuf=this.bufferSync(x),_loop_1=function(i){var outLoc=buffer.indexToLoc(i),inLoc=outLoc.slice();axis.forEach((function(ax){return inLoc[ax]=x.shape[ax]-1-inLoc[ax]})),buffer.set.apply(buffer,[xBuf.get.apply(xBuf,inLoc)].concat(outLoc))},i=0;i<buffer.size;i++)_loop_1(i);return buffer.toTensor()},MathBackendCPU.prototype.concat=function(tensors,axis){var _this=this;if("complex64"===tensors[0].dtype){var reals=tensors.map((function(t){return complex_ops_1.real(t)})),imags=tensors.map((function(t){return complex_ops_1.imag(t)}));return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}var tensors2D=tensors.map((function(t){var innerSize=util.sizeFromShape(t.shape.slice(axis));return t.as2D(-1,innerSize)})),outShape=concat_util.computeOutShape(tensors2D.map((function(t){return t.shape})),1),values=ops.buffer(outShape,tensors[0].dtype).values;if(1===tensors2D[0].shape[0]){var offset_1=0;tensors2D.forEach((function(t){values.set(_this.readSync(t.dataId),offset_1),offset_1+=t.size}))}else{var colOffset_1=0;tensors2D.forEach((function(t){for(var tVals=_this.readSync(t.dataId),tIdx=0,row=0;row<t.shape[0];++row)for(var resIdx=row*outShape[1]+colOffset_1,col=0;col<t.shape[1];++col)values[resIdx+col]=tVals[tIdx++];colOffset_1+=t.shape[1]}))}var finalOutShape=concat_util.computeOutShape(tensors.map((function(t){return t.shape})),axis);return ops_1.tensor(values,finalOutShape,tensors[0].dtype)},MathBackendCPU.prototype.neg=function(x){return cpu_util_1.assertNotComplex(x,"neg"),this.multiply(ops.scalar(-1),x)},MathBackendCPU.prototype.add=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),(function(aReal,aImag,bReal,bImag){return{real:aReal+bReal,imag:aImag+bImag}})):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),(function(aValue,bValue){return aValue+bValue}))},MathBackendCPU.prototype.addN=function(tensors){var _this=this;cpu_util_1.assertNotComplex(tensors,"addN");for(var vals=tensors.map((function(t){return _this.readSync(t.dataId)})),result=ops.buffer(tensors[0].shape,tensors[0].dtype),resultVals=result.values,i=0;i<tensors.length;i++)for(var currVals=vals[i],j=0;j<resultVals.length;j++)resultVals[j]+=currVals[j];return result.toTensor()},MathBackendCPU.prototype.softmax=function(logits,dim){var axes=util.parseAxisParam([dim],logits.shape),maxLogit=this.max(logits,axes),expandedShape=axis_util.expandShapeToKeepDim(maxLogit.shape,axes),a=this.subtract(logits,maxLogit.reshape(expandedShape)),b=this.exp(a),sumExp=this.sum(b,axes).reshape(expandedShape);return this.realDivide(b,sumExp)},MathBackendCPU.prototype.subtract=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),(function(aReal,aImag,bReal,bImag){return{real:aReal-bReal,imag:aImag-bImag}})):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),(function(aValue,bValue){return aValue-bValue}))},MathBackendCPU.prototype.pow=function(a,b){return cpu_util_1.assertNotComplex([a,b],"pow"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aValue,bValue){return Math.pow(aValue,bValue)}))},MathBackendCPU.prototype.batchMatMul=function(a,b,transposeA,transposeB){cpu_util_1.assertNotComplex([a,b],"matMul");for(var sharedDim=transposeA?a.shape[1]:a.shape[2],leftDim=transposeA?a.shape[2]:a.shape[1],rightDim=transposeB?b.shape[1]:b.shape[2],batchDim=a.shape[0],aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),_a=transposeA?[a.strides[0],1,a.strides[1]]:[a.strides[0],a.strides[1],1],aBatch=_a[0],aOuterStep=_a[1],aInnerStep=_a[2],_b=transposeB?[1,b.strides[1],b.strides[0]]:[b.strides[1],1,b.strides[0]],bInnerStep=_b[0],bOuterStep=_b[1],bBatch=_b[2],size=leftDim*rightDim,result=ops_1.buffer([batchDim,leftDim,rightDim],a.dtype),resVals=result.values,blockSize=this.blockSize,b_1=0;b_1<batchDim;b_1++)for(var i0=0;i0<leftDim;i0+=blockSize)for(var j0=0;j0<rightDim;j0+=blockSize)for(var k0=0;k0<sharedDim;k0+=blockSize)for(var iBlock=Math.min(i0+blockSize,leftDim),jBlock=Math.min(j0+blockSize,rightDim),kBlock=Math.min(k0+blockSize,sharedDim),i=i0;i<iBlock;i++)for(var j=j0;j<jBlock;j++){for(var sum=0,k=k0;k<kBlock;k++)sum+=aValues[b_1*aBatch+i*aOuterStep+k*aInnerStep]*bValues[k*bInnerStep+j*bOuterStep+b_1*bBatch];resVals[b_1*size+(i*rightDim+j)]+=sum}return result.toTensor()},MathBackendCPU.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,result=this.batchMatMul(a,b,transposeA,transposeB);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.multiply=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),(function(aReal,aImag,bReal,bImag){return{real:aReal*bReal-aImag*bImag,imag:aReal*bImag+aImag*bReal}})):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),(function(aValue,bValue){return aValue*bValue}))},MathBackendCPU.prototype.realDivide=function(a,b){cpu_util_1.assertNotComplex([a,b],"realDivide");return this.broadcastedBinaryOp(a,b,"float32",(function(a,b){return a/b}))},MathBackendCPU.prototype.floorDiv=function(a,b){cpu_util_1.assertNotComplex([a,b],"floorDiv");return this.broadcastedBinaryOp(a,b,"int32",(function(a,b){return Math.floor(a/b)}))},MathBackendCPU.prototype.sum=function(x,axes){cpu_util_1.assertNotComplex(x,"sum"),axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,sum=0,j=0;j<reduceSize;++j)sum+=aVals[offset+j];vals[i]=sum}return result},MathBackendCPU.prototype.prod=function(x,axes){cpu_util_1.assertNotComplex(x,"sum");for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,prod=1,j=0;j<reduceSize;++j)prod*=aVals[offset+j];vals[i]=prod}return result},MathBackendCPU.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){cpu_util_1.assertNotComplex(x,"unsortedSegmentSum");for(var res=[],numIters=x.rank-segmentIds.rank,i=0;i<numIters;++i)segmentIds=segmentIds.expandDims(i+1);for(i=0;i<numSegments;++i){var segmentId=ops.scalar(i,"int32"),sum=ops.equal(segmentId,segmentIds).asType("float32").mul(x).sum(0);res.push(sum)}return ops.stack(res)},MathBackendCPU.prototype.argMin=function(x,axis){cpu_util_1.assertNotComplex(x,"argMin");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMin",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],minIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value,minIndex=j)}vals[i]=minIndex}return result},MathBackendCPU.prototype.argMax=function(x,axis){cpu_util_1.assertNotComplex(x,"argMax");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMax",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],maxIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];value>max&&(max=value,maxIndex=j)}vals[i]=maxIndex}return result},MathBackendCPU.prototype.cumsum=function(x,axis,exclusive,reverse){if(cpu_util_1.assertNotComplex(x,"cumsum"),axis!==x.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);for(var resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(x.shape,resultDtype),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),finalDim=x.shape[x.rank-1],indexAdjuster=reverse?function(i,j){return i+finalDim-j-1}:function(i,j){return i+j},i=0;i<aVals.length;i+=finalDim)for(var j=0;j<finalDim;j++){var idx=indexAdjuster(i,j);if(0===j)vals[idx]=exclusive?0:aVals[idx];else{var prevIdx=indexAdjuster(i,j-1);vals[idx]=exclusive?aVals[prevIdx]+vals[prevIdx]:aVals[idx]+vals[prevIdx]}}return result},MathBackendCPU.prototype.equal=function(a,b){return cpu_util_1.assertNotComplex([a,b],"equal"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal===bVal?1:0}))},MathBackendCPU.prototype.notEqual=function(a,b){return cpu_util_1.assertNotComplex([a,b],"notEqual"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal!==bVal?1:0}))},MathBackendCPU.prototype.less=function(a,b){return cpu_util_1.assertNotComplex([a,b],"less"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal<bVal?1:0}))},MathBackendCPU.prototype.lessEqual=function(a,b){return cpu_util_1.assertNotComplex([a,b],"lessEqual"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal<=bVal?1:0}))},MathBackendCPU.prototype.greater=function(a,b){return cpu_util_1.assertNotComplex([a,b],"greater"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal>bVal?1:0}))},MathBackendCPU.prototype.greaterEqual=function(a,b){return cpu_util_1.assertNotComplex([a,b],"greaterEqual"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal>=bVal?1:0}))},MathBackendCPU.prototype.logicalNot=function(x){cpu_util_1.assertNotComplex(x,"logicalNot");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)newValues[i]=values[i]?0:1;return this.makeOutput(newValues,x.shape,"bool")},MathBackendCPU.prototype.logicalAnd=function(a,b){return cpu_util_1.assertNotComplex([a,b],"logicalAnd"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal&&bVal}))},MathBackendCPU.prototype.logicalOr=function(a,b){return cpu_util_1.assertNotComplex([a,b],"logicalOr"),this.broadcastedBinaryOp(a,b,"bool",(function(aVal,bVal){return aVal||bVal}))},MathBackendCPU.prototype.select=function(condition,a,b){cpu_util_1.assertNotComplex([condition,a,b],"select");for(var values=this.readSync(condition.dataId),aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),result=ops.zeros(a.shape,types_1.upcastType(a.dtype,b.dtype)),newValues=this.readSync(result.dataId),index=0,offset=0===condition.rank||condition.rank>1||1===a.rank?1:util.sizeFromShape(a.shape.slice(1)),i=0;i<values.length;i++)for(var j=0;j<offset;j++)1===values[i]?newValues[index++]=aValues[i]:newValues[index++]=bValues[i];return result},MathBackendCPU.prototype.where=function(condition){cpu_util_1.assertNotComplex([condition],"where");var condVals=this.readSync(condition.dataId);return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendCPU.prototype.topk=function(x,k,sorted){cpu_util_1.assertNotComplex(x,"topk");var xVals=this.readSync(x.dataId);return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendCPU.prototype.min=function(x,axes){cpu_util_1.assertNotComplex(x,"min"),axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value)}vals[i]=min}return result},MathBackendCPU.prototype.minimum=function(a,b){return cpu_util_1.assertNotComplex([a,b],"minimum"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aVal,bVal){return Math.min(aVal,bVal)}))},MathBackendCPU.prototype.mod=function(a,b){return cpu_util_1.assertNotComplex([a,b],"mod"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aVal,bVal){var rem=aVal%bVal;return aVal<0&&bVal<0||aVal>=0&&bVal>=0?rem:(rem+bVal)%bVal}))},MathBackendCPU.prototype.max=function(x,axes){cpu_util_1.assertNotComplex(x,"max"),axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];value>max&&(max=value)}vals[i]=max}return result},MathBackendCPU.prototype.maximum=function(a,b){return cpu_util_1.assertNotComplex([a,b],"maximum"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aVal,bVal){return Math.max(aVal,bVal)}))},MathBackendCPU.prototype.all=function(x,axes){cpu_util_1.assertNotComplex(x,"all"),axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,all=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];all=all&&value}vals[i]=all}return result},MathBackendCPU.prototype.any=function(x,axes){cpu_util_1.assertNotComplex(x,"any"),axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,anyVal=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];anyVal=anyVal||value}vals[i]=anyVal}return result},MathBackendCPU.prototype.squaredDifference=function(a,b){return cpu_util_1.assertNotComplex([a,b],"squaredDifference"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aVal,bVal){var diff=aVal-bVal;return diff*diff}))},MathBackendCPU.prototype.ceil=function(x){cpu_util_1.assertNotComplex(x,"ceil");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.ceil(values[i]);return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.floor=function(x){cpu_util_1.assertNotComplex(x,"floor");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.floor(values[i]);return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.sign=function(x){cpu_util_1.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)values[i]<0?newValues[i]=-1:values[i]>0?newValues[i]=1:newValues[i]=0;return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.isNaN=function(x){cpu_util_1.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isNaN(values[i])&&(newValues[i]=1);return this.makeOutput(newValues,x.shape,"bool")},MathBackendCPU.prototype.isInf=function(x){cpu_util_1.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Math.abs(values[i])===1/0&&(newValues[i]=1);return this.makeOutput(newValues,x.shape,"bool")},MathBackendCPU.prototype.isFinite=function(x){cpu_util_1.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isFinite(values[i])&&(newValues[i]=1);return this.makeOutput(newValues,x.shape,"bool")},MathBackendCPU.prototype.round=function(x){cpu_util_1.assertNotComplex(x,"round");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var base=Math.floor(values[i]);values[i]-base<.5?newValues[i]=Math.floor(values[i]):values[i]-base>.5?newValues[i]=Math.ceil(values[i]):newValues[i]=base%2==0?base:base+1}return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.exp=function(x){cpu_util_1.assertNotComplex(x,"exp");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.exp(values[i]);return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.expm1=function(x){cpu_util_1.assertNotComplex(x,"expm1");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.expm1(values[i]);return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.log=function(x){cpu_util_1.assertNotComplex(x,"log");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log(value)}return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.log1p=function(x){cpu_util_1.assertNotComplex(x,"log1p");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log1p(value)}return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.sqrt=function(x){cpu_util_1.assertNotComplex(x,"sqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.sqrt(value)}return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.rsqrt=function(x){cpu_util_1.assertNotComplex(x,"rsqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=1/Math.sqrt(value)}return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.reciprocal=function(x){cpu_util_1.assertNotComplex(x,"reciprocal");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=1/values[i];return this.makeOutput(newValues,x.shape,"float32")},MathBackendCPU.prototype.linear=function(x){return x},MathBackendCPU.prototype.relu=function(x){cpu_util_1.assertNotComplex(x,"relu");for(var res=ops.zeros(x.shape,x.dtype),resVals=this.readSync(res.dataId),inVals=this.readSync(x.dataId),i=0;i<inVals.length;++i)resVals[i]=Math.max(0,inVals[i]);return res},MathBackendCPU.prototype.relu6=function(x){cpu_util_1.assertNotComplex(x,"relu");for(var res=ops.zeros(x.shape,x.dtype),resVals=this.readSync(res.dataId),inVals=this.readSync(x.dataId),i=0;i<inVals.length;++i)resVals[i]=Math.min(Math.max(0,inVals[i]),6);return res},MathBackendCPU.prototype.prelu=function(x,a){return cpu_util_1.assertNotComplex([x,a],"prelu"),this.broadcastedBinaryOp(x,a,x.dtype,(function(xValue,aValue){return xValue<0?aValue*xValue:xValue}))},MathBackendCPU.prototype.elu=function(x){cpu_util_1.assertNotComplex(x,"elu");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=v>=0?v:Math.exp(v)-1}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.eluDer=function(dy,y){cpu_util_1.assertNotComplex([dy,y],"eluDer");for(var resultValues=new Float32Array(y.size),values=this.readSync(y.dataId),dyValues=this.readSync(dy.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=v>=1?dyValues[i]:dyValues[i]*(v+1)}return this.makeOutput(resultValues,y.shape,"float32")},MathBackendCPU.prototype.selu=function(x){cpu_util_1.assertNotComplex(x,"selu");for(var scaleAlpha=selu_util.SELU_SCALEALPHA,scale=selu_util.SELU_SCALE,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=v>=0?scale*v:scaleAlpha*(Math.exp(v)-1)}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.clip=function(x,min,max){cpu_util_1.assertNotComplex(x,"clip");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=v>max?max:v<min?min:v}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.abs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.abs(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.complexAbs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<x.size;++i){var real_1=values[2*i],imag_1=values[2*i+1];resultValues[i]=Math.hypot(real_1,imag_1)}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.int=function(x){cpu_util_1.assertNotComplex(x,"int");for(var resultValues=new Int32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=values[i];return this.makeOutput(resultValues,x.shape,"int32")},MathBackendCPU.prototype.sigmoid=function(x){cpu_util_1.assertNotComplex(x,"sigmoid");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=1/(1+Math.exp(-values[i]));return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.softplus=function(x){cpu_util_1.assertNotComplex(x,"softplus");for(var threshold=Math.log(1.1920928955078125e-7)+2,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var tooLarge=values[i]>-threshold,tooSmall=values[i]<threshold,expX=Math.exp(values[i]),result=void 0;result=tooSmall?expX:tooLarge?values[i]:Math.log(1+expX),resultValues[i]=result}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.sin=function(x){cpu_util_1.assertNotComplex(x,"sin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sin(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.cos=function(x){cpu_util_1.assertNotComplex(x,"cos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cos(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.tan=function(x){cpu_util_1.assertNotComplex(x,"tan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.tan(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.asin=function(x){cpu_util_1.assertNotComplex(x,"asin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asin(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.acos=function(x){cpu_util_1.assertNotComplex(x,"acos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acos(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.atan=function(x){cpu_util_1.assertNotComplex(x,"atan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atan(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.atan2=function(a,b){return cpu_util_1.assertNotComplex([a,b],"atan2"),this.broadcastedBinaryOp(a,b,a.dtype,(function(aValue,bValue){return Math.atan2(aValue,bValue)}))},MathBackendCPU.prototype.sinh=function(x){cpu_util_1.assertNotComplex(x,"sinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sinh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.cosh=function(x){cpu_util_1.assertNotComplex(x,"cosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cosh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.tanh=function(x){cpu_util_1.assertNotComplex(x,"tanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=util.tanh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.asinh=function(x){cpu_util_1.assertNotComplex(x,"asinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asinh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.acosh=function(x){cpu_util_1.assertNotComplex(x,"acosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acosh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.atanh=function(x){cpu_util_1.assertNotComplex(x,"atanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atanh(values[i]);return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.erf=function(x){cpu_util_1.assertNotComplex(x,"erf");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),p=erf_util.ERF_P,a1=erf_util.ERF_A1,a2=erf_util.ERF_A2,a3=erf_util.ERF_A3,a4=erf_util.ERF_A4,a5=erf_util.ERF_A5,i=0;i<values.length;++i){var sign=Math.sign(values[i]),v=Math.abs(values[i]),t=1/(1+p*v);resultValues[i]=sign*(1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-v*v))}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.step=function(x,alpha){void 0===alpha&&(alpha=0),cpu_util_1.assertNotComplex(x,"step");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var value=values[i];isNaN(value)?resultValues[i]=NaN:resultValues[i]=value>0?1:alpha}return this.makeOutput(resultValues,x.shape,"float32")},MathBackendCPU.prototype.fusedConv2d=function(_a){var input=_a.input,filter=_a.filter,convInfo=_a.convInfo,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,result=this.conv2d(input,filter,convInfo);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.conv2d=function(x,filter,convInfo){cpu_util_1.assertNotComplex([x,filter],"conv2d");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,isChannelsLast="channelsLast"===convInfo.dataFormat,y=ops.buffer(convInfo.outShape,x.dtype),xBatchStride=x.strides[0],xRowStride=isChannelsLast?x.strides[1]:x.strides[2],xColStride=isChannelsLast?x.strides[2]:1,xChannelStride=isChannelsLast?1:x.strides[1],yBatchStride=y.strides[0],yRowStride=isChannelsLast?y.strides[1]:y.strides[2],yColStride=isChannelsLast?y.strides[2]:1,yChannelStride=isChannelsLast?1:y.strides[1],xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xBatchStride,yOffset1=b*yBatchStride,yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*yRowStride,xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*xRowStride,yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*yColStride,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var xOffset3=xOffset2+xC*xColStride,wOffset3=wOffset1+wC*filter.strides[1],d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1*xChannelStride],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset3+d2*yChannelStride]+=xVal*wVals[wOffset3+d2];wOffset3+=convInfo.outChannels}}}return y.toTensor()},MathBackendCPU.prototype.conv3d=function(x,filter,convInfo){for(var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padFront=convInfo.padInfo.front,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yF=0;yF<convInfo.outDepth;++yF)for(var yOffset2=yOffset1+yF*y.strides[1],xFCorner=yF*convInfo.strideDepth-padFront,wF=0;wF<filterDepth;wF++){var xF=xFCorner+wF*dilationDepth;if(!(xF<0||xF>=convInfo.inDepth))for(var wOffset1=wF*filter.strides[0],xOffset2=xOffset1+xF*x.strides[1],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset3=yOffset2+yR*y.strides[2],xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset2=wOffset1+wR*filter.strides[1],xOffset3=xOffset2+xR*x.strides[2],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset4=yOffset3+yC*convInfo.outChannels,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset3=wOffset2+wC*filter.strides[2],xOffset4=xOffset3+xC*convInfo.inChannels,wOffset4=wOffset3,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset4+d1],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset4+d2]+=xVal*wVals[wOffset4+d2];wOffset4+=convInfo.outChannels}}}}return y.toTensor()},MathBackendCPU.prototype.conv2dDerInput=function(dy,filter,convInfo){cpu_util_1.assertNotComplex([dy,filter],"conv2dDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,dyValues=this.readSync(dy.dataId),fltValues=this.readSync(filter.dataId),_a=filter.strides,fltS0=_a[0],fltS1=_a[1],fltS2=_a[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dataFormat=convInfo.dataFormat,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,isChannelsLast="channelsLast"===dataFormat,xBatchStride=dx.strides[0],xRowStride=isChannelsLast?dx.strides[1]:dx.strides[2],xColStride=isChannelsLast?dx.strides[2]:1,xChannelStride=isChannelsLast?1:dx.strides[1],yBatchStride=dy.strides[0],yRowStride=isChannelsLast?dy.strides[1]:dy.strides[2],yColStride=isChannelsLast?dy.strides[2]:1,yChannelStride=isChannelsLast?1:dy.strides[1],b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=yBatchStride*b+yRowStride*yR+yColStride*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+yChannelStride*d2]*fltValues[fltOffset+d2]}dxValues[xBatchStride*b+xRowStride*xR+xColStride*xC+xChannelStride*d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv3dDerInput=function(dy,filter,convInfo){for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dxS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],fltS3=_c[3],batchSize=convInfo.batchSize,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inDepth=convInfo.inDepth,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outDepth=convInfo.outDepth,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,frontPad=filterDepth-1-convInfo.padInfo.front,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xF=0;xF<inDepth;++xF)for(var xFCorner=xF-frontPad,xFMin=Math.max(0,Math.ceil(xFCorner/strideDepth)),yFMax=Math.min(outDepth,(filterDepth+xFCorner)/strideDepth),xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yF=xFMin;yF<yFMax;++yF)for(var wF=yF*strideDepth-xFCorner,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yF+dyS2*yR+dyS3*yC,fltOffset=fltS0*(filterDepth-1-wF)+fltS1*(filterHeight-1-wR)+fltS2*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS3*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+d2]*fltValues[fltOffset+d2]}dxValues[dxS0*b+dxS1*xF+dxS2*xR+dxS3*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv2dDerFilter=function(x,dy,convInfo){cpu_util_1.assertNotComplex([x,dy],"conv2dDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d1=0;d1<convInfo.inChannels;++d1)for(var d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=isChannelsLast?xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2):xBuf.get(b,d1,xR,xC)*dyBuf.get(b,d2,yR,yC)}dW.set(dotProd,wR,wC,d1,d2)}return dW.toTensor()},MathBackendCPU.prototype.conv3dDerFilter=function(x,dy,convInfo){for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dw=ops.buffer(convInfo.filterShape,"float32"),dwValues=dw.values,_a=dw.strides,dwS0=_a[0],dwS1=_a[1],dwS2=_a[2],dwS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],xValues=this.readSync(x.dataId),_c=x.strides,xS0=_c[0],xS1=_c[1],xS2=_c[2],xS3=_c[3],frontPad=convInfo.padInfo.front,leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,wF=0;wF<filterDepth;++wF)for(var yFMin=Math.max(0,Math.ceil((frontPad-wF)/strideDepth)),yFMax=Math.min(convInfo.outDepth,(convInfo.inDepth+frontPad-wF)/strideDepth),wOffset1=wF*dwS0,wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wOffset2=wR*dwS1+wOffset1,wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),wOffset3=wC*dwS2+wOffset2,d1=0;d1<convInfo.inChannels;++d1)for(var wOffset4=d1*dwS3+wOffset3,d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xS0,yOffset1=b*dyS0,yF=yFMin;yF<yFMax;++yF)for(var xOffset2=(wF+yF*strideDepth-frontPad)*xS1+xOffset1,yOffset2=yF*dyS1+yOffset1,yR=yRMin;yR<yRMax;++yR)for(var xOffset3=(wR+yR*strideHeight-topPad)*xS2+xOffset2,yOffset3=yR*dyS2+yOffset2,yC=yCMin;yC<yCMax;++yC){var yOffset4=yC*dyS3+yOffset3;dotProd+=xValues[(wC+yC*strideWidth-leftPad)*xS3+xOffset3+d1]*dyValues[yOffset4+d2]}dwValues[wOffset4+d2]=dotProd}return dw.toTensor()},MathBackendCPU.prototype.fusedDepthwiseConv2D=function(_a){var input=_a.input,filter=_a.filter,convInfo=_a.convInfo,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,result=this.depthwiseConv2D(input,filter,convInfo);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.depthwiseConv2D=function(x,filter,convInfo){cpu_util_1.assertNotComplex([x,filter],"depthwiseConv2D");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*y.strides[1],xRCorner=yR*convInfo.strideHeight-padLeft,wR=0;wR<filterHeight;++wR){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*x.strides[1],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*y.strides[2],xCCorner=yC*convInfo.strideWidth-padTop,wC=0;wC<filterWidth;++wC){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset2=wOffset1+wC*filter.strides[1],xOffset3=xOffset2+xC*convInfo.inChannels,yOffset4=yOffset3,wOffset3=wOffset2,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1],q=0;q<chMul;++q)yVals[yOffset4+q]+=xVal*wVals[wOffset3+q];yOffset4+=chMul,wOffset3+=chMul}}}return y.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){cpu_util_1.assertNotComplex([dy,filter],"depthwiseConv2DDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,chMul=outChannels/inChannels,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yR+dyS2*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,dm=0;dm<chMul;++dm){dotProd+=dyValues[dyOffset+(d1*chMul+dm)]*fltValues[fltOffset+dm]}dxValues[dxS0*b+dxS1*xR+dxS2*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){cpu_util_1.assertNotComplex([x,dy],"depthwiseConv2DDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d2=0;d2<convInfo.outChannels;++d2){for(var d1=Math.trunc(d2/chMul),dm=d2%chMul,dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2)}dW.set(dotProd,wR,wC,d1,dm)}return dW.toTensor()},MathBackendCPU.prototype.tile=function(x,reps){return cpu_util_1.assertNotComplex(x,"tile"),tile_impl_1.tile(this.bufferSync(x),reps)},MathBackendCPU.prototype.pad=function(x,paddings,constantValue){cpu_util_1.assertNotComplex(x,"pad");var outShape=paddings.map((function(p,i){return p[0]+x.shape[i]+p[1]})),start=paddings.map((function(p){return p[0]})),xBuffer=this.bufferSync(x),buffer=ops.buffer(outShape,x.dtype);0!==constantValue&&buffer.values.fill(constantValue);for(var i=0;i<x.size;i++){var coords=xBuffer.indexToLoc(i),outCoords=coords.map((function(c,i){return c+start[i]}));buffer.set.apply(buffer,[xBuffer.get.apply(xBuffer,coords)].concat(outCoords))}return buffer.toTensor()},MathBackendCPU.prototype.transpose=function(x,perm){cpu_util_1.assertNotComplex(x,"transpose");for(var newShape=new Array(x.rank),i=0;i<newShape.length;i++)newShape[i]=x.shape[perm[i]];var values=this.readSync(x.dataId),result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x);for(i=0;i<x.size;++i){for(var loc=xBuf.indexToLoc(i),newLoc=new Array(loc.length),i_1=0;i_1<newLoc.length;i_1++)newLoc[i_1]=loc[perm[i_1]];var newIndex=result.locToIndex(newLoc);result.values[newIndex]=values[i]}return result.toTensor()},MathBackendCPU.prototype.gather=function(x,indices,axis){cpu_util_1.assertNotComplex([x,indices],"gather");var newShape=x.shape.slice(),indicesValues=this.readSync(indices.dataId);newShape[axis]=indicesValues.length;for(var result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x),i=0;i<result.size;++i){var newLoc=result.indexToLoc(i),originalLoc=newLoc.slice();originalLoc[axis]=indicesValues[newLoc[axis]];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()},MathBackendCPU.prototype.batchToSpaceND=function(x,blockShape,crops){cpu_util_1.assertNotComplex([x],"batchToSpaceND");var prod=blockShape.reduce((function(a,b){return a*b})),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendCPU.prototype.spaceToBatchND=function(x,blockShape,paddings){cpu_util_1.assertNotComplex([x],"spaceToBatchND");var prod=blockShape.reduce((function(a,b){return a*b})),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendCPU.prototype.pool=function(x,convInfo,poolType){cpu_util_1.assertNotComplex(x,"pool");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3],outputRowStrides=convInfo.outShape[2]*convInfo.outShape[3],outputColStrides=convInfo.outShape[3],b=0;b<convInfo.batchSize;++b)for(var outputBatchOffset=b*outputBatchStrides,inputBatchOffset=b*x.strides[0],d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR)for(var xRCorner=yR*strideHeight-padTop,xRMin=Math.max(0,xRCorner),xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),outputRowOffset=outputBatchOffset+yR*outputRowStrides,yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=Math.max(0,xCCorner),xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),minMaxValue=initialValue,avgValue=0,count=0,xR=xRMin;xR<xRMax;xR+=dilationHeight){for(var xROffset=inputBatchOffset+xR*x.strides[1],xC=xCMin;xC<xCMax;xC+=dilationWidth){var pixel=xValues[xROffset+xC*x.strides[2]+d];"max"===poolType&&pixel>minMaxValue?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++)}if(isNaN(minMaxValue))break}outputVals[outputRowOffset+yC*outputColStrides+d]="avg"===poolType?avgValue/count:minMaxValue}return output.toTensor()},MathBackendCPU.prototype.maxPool=function(x,convInfo){return this.pool(x,convInfo,"max")},MathBackendCPU.prototype.maxPoolPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR){for(var xRCorner=yR*strideHeight-padTop,xRMin=xRCorner;xRMin<0;)xRMin+=dilationHeight;for(var xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=xCCorner;xCMin<0;)xCMin+=dilationWidth;for(var xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xR=xRMin;xR<xRMax;xR+=dilationHeight)for(var wR=xR-xRCorner,xC=xCMin;xC<xCMax;xC+=dilationWidth){var wC=xC-xCCorner,pixel=xBuf.get(b,xR,xC,d);pixel>maxValue&&(maxValue=pixel,maxPosition=wR*effectiveFilterWidth+wC)}maxPositions.set(maxPosition,b,yR,yC,d)}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPoolBackprop=function(dy,x,y,convInfo){cpu_util_1.assertNotComplex([x,y],"maxPoolBackprop");for(var maxPositions=this.maxPoolPositions(x,convInfo),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC)){var mask=effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(b,dyR,dyC,d)===wR*effectiveFilterWidth+wC?1:0;if(0!==mask)dotProd+=dyBuf.get(b,dyR,dyC,d)*mask}}}dx.set(dotProd,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.avgPoolBackprop=function(dy,x,convInfo){cpu_util_1.assertNotComplex([dy,x],"avgPoolBackprop");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterHeight*filterWidth),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC))dotProd+=dyBuf.get(b,dyR,dyC,d)}}dx.set(dotProd*avgMultiplier,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.pool3d=function(x,convInfo,poolType){cpu_util_1.assertNotComplex(x,"pool3d");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputDepthStrides=convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputRowStrides=convInfo.outShape[3]*convInfo.outShape[4],outputColStrides=convInfo.outShape[4],batch=0;batch<convInfo.batchSize;++batch)for(var outputBatchOffset=batch*outputBatchStrides,inputBatchOffset=batch*x.strides[0],channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),outputDepthOffset=outputBatchOffset+yDepth*outputDepthStrides,yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),outputRowOffset=outputDepthOffset+yRow*outputRowStrides,yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),outputColOffset=outputRowOffset+yCol*outputColStrides,minMaxValue=initialValue,avgValue=0,count=0,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth){for(var xDepthOffset=inputBatchOffset+xDepth*x.strides[1],xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight){for(var xRowOffset=xDepthOffset+xRow*x.strides[2],xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var pixel=xValues[xRowOffset+xCol*x.strides[3]+channel];if("max"===poolType&&pixel>minMaxValue?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++),isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}outputVals[outputColOffset+channel]="avg"===poolType?avgValue/count:minMaxValue}}}return output.toTensor()},MathBackendCPU.prototype.avgPool3d=function(x,convInfo){return cpu_util_1.assertNotComplex(x,"avgPool3d"),this.pool3d(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.avgPool3dBackprop=function(dy,x,convInfo){cpu_util_1.assertNotComplex([dy,x],"avgPool3dBackprop");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterDepth*filterHeight*filterWidth),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol))dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)}}}dx.set(dotProd*avgMultiplier,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.maxPool3d=function(x,convInfo){return cpu_util_1.assertNotComplex(x,"maxPool3d"),this.pool3d(x,convInfo,"max").toFloat()},MathBackendCPU.prototype.maxPool3dPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth)for(var wDepth=xDepth-xDepthCorner,xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight)for(var wRow=xRow-xRowCorner,xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var wCol=xCol-xColCorner,pixel=xBuf.get(batch,xDepth,xRow,xCol,channel);pixel>=maxValue&&(maxValue=pixel,maxPosition=wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterHeight+wCol)}maxPositions.set(maxPosition,batch,yDepth,yRow,yCol,channel)}}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){cpu_util_1.assertNotComplex([x,y],"maxPool3dBackprop");for(var maxPositions=this.maxPool3dPositions(x,convInfo),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol)){var mask=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(batch,dyDepth,dyRow,dyCol,channel)===wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterWidth+wCol?1:0;if(0!==mask)dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)*mask}}}}dx.set(dotProd,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendCPU.prototype.reshape=function(x,shape){return backend_util.reshapeTensor(x,shape)},MathBackendCPU.prototype.avgPool=function(x,convInfo){return cpu_util_1.assertNotComplex(x,"avgPool"),this.pool(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){cpu_util_1.assertNotComplex(x,"resizeBilinear");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),result=new Float32Array(util.sizeFromShape([batch,newHeight,newWidth,numChannels])),effectiveInputSize=[alignCorners&&newHeight>1?oldHeight-1:oldHeight,alignCorners&&newWidth>1?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&newHeight>1?newHeight-1:newHeight,alignCorners&&newWidth>1?newWidth-1:newWidth],outputIdx=0,effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],b=0;b<batch;b++)for(var r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,sourceRowFloor=Math.floor(sourceFracRow),rowFrac=sourceFracRow-sourceRowFloor,sourceRowCeil=Math.min(oldHeight-1,Math.ceil(sourceFracRow)),topRowOffset=b*x.strides[0]+sourceRowFloor*x.strides[1],botRowOffset=b*x.strides[0]+sourceRowCeil*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,sourceColFloor=Math.floor(sourceFracCol),colFrac=sourceFracCol-sourceColFloor,sourceColCeil=Math.min(oldWidth-1,Math.ceil(sourceFracCol)),topLeftOffest=topRowOffset+sourceColFloor*x.strides[2],botLeftOffset=botRowOffset+sourceColFloor*x.strides[2],topRightOffset=topRowOffset+sourceColCeil*x.strides[2],botRightOffest=botRowOffset+sourceColCeil*x.strides[2],d=0;d<numChannels;d++){var topLeft=xValues[topLeftOffest+d],bottomLeft=xValues[botLeftOffset+d],top_1=topLeft+(xValues[topRightOffset+d]-topLeft)*colFrac,newValue=top_1+(bottomLeft+(xValues[botRightOffest+d]-bottomLeft)*colFrac-top_1)*rowFrac;result[outputIdx++]=newValue}return ops.tensor(result,[batch,newHeight,newWidth,numChannels])},MathBackendCPU.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){cpu_util_1.assertNotComplex([dy,x],"resizeBilinearBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),effectiveXSize=[alignCorners&&yHeight>1?xHeight-1:xHeight,alignCorners&&yWidth>1?xWidth-1:xWidth],effectiveYSize=[alignCorners&&yHeight>1?yHeight-1:yHeight,alignCorners&&yWidth>1?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],dyValues=this.readSync(dy.dataId),offset=0,b=0;b<batch;b++)for(var bOffset=b*x.strides[0],r=0;r<yHeight;r++)for(var dxR=r*heightScale,topDxRIndex=Math.floor(dxR),bottomDxRIndex=Math.min(Math.ceil(dxR),xHeight-1),topDxROffset=bOffset+topDxRIndex*x.strides[1],bottomDxROffset=bOffset+bottomDxRIndex*x.strides[1],dxRLerp=dxR-topDxRIndex,inverseDxRLerp=1-dxRLerp,c=0;c<yWidth;c++)for(var dxC=c*widthScale,leftDxCIndex=Math.floor(dxC),rightDxCIndex=Math.min(Math.ceil(dxC),xWidth-1),dxCLerp=dxC-leftDxCIndex,inverseDxCLerp=1-dxCLerp,topLeftRCOffset=topDxROffset+leftDxCIndex*x.strides[2],topRightRCOffset=topDxROffset+rightDxCIndex*x.strides[2],bottomLeftRCOffset=bottomDxROffset+leftDxCIndex*x.strides[2],bottomRightRCOffset=bottomDxROffset+rightDxCIndex*x.strides[2],inverseDxRLerpTimesInverseDxCLerp=inverseDxRLerp*inverseDxCLerp,inverseDxRLerpTimesDxCLerp=inverseDxRLerp*dxCLerp,dxRLerpTimesInverseDxCLerp=dxRLerp*inverseDxCLerp,dxRLerpTimesDxCLerp=dxRLerp*dxCLerp,d=0;d<depth;d++){var dyVal=dyValues[offset++];output[topLeftRCOffset+d]+=dyVal*inverseDxRLerpTimesInverseDxCLerp,output[topRightRCOffset+d]+=dyVal*inverseDxRLerpTimesDxCLerp,output[bottomLeftRCOffset+d]+=dyVal*dxRLerpTimesInverseDxCLerp,output[bottomRightRCOffset+d]+=dyVal*dxRLerpTimesDxCLerp}return ops.tensor4d(output,[batch,xWidth,xHeight,depth],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){cpu_util_1.assertNotComplex(x,"resizeNearestNeighbor");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),output=new Float32Array(batch*newHeight*newWidth*numChannels),effectiveInputSize=[alignCorners&&newHeight>1?oldHeight-1:oldHeight,alignCorners&&newWidth>1?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&newHeight>1?newHeight-1:newHeight,alignCorners&&newWidth>1?newWidth-1:newWidth],effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],outputOffset=0,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,rowOffset=batchOffset+Math.min(oldHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow))*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,colOffset=rowOffset+Math.min(oldWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))*x.strides[2],d=0;d<numChannels;d++){var newVal=xValues[colOffset+d];output[outputOffset++]=newVal}return ops.tensor(output,[batch,newHeight,newWidth,numChannels],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){cpu_util_1.assertNotComplex([dy,x],"resizeNearestNeighborBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),dyValues=this.readSync(dy.dataId),effectiveXSize=[alignCorners&&yHeight>1?xHeight-1:xHeight,alignCorners&&yWidth>1?xWidth-1:xWidth],effectiveYSize=[alignCorners&&yHeight>1?yHeight-1:yHeight,alignCorners&&yWidth>1?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<xHeight;r++)for(var rowOffset=batchOffset+r*x.strides[1],startRLerp=Math.floor(r*invHeightScale),startDyR=Math.floor(startRLerp-winHeight/2),c=0;c<xWidth;c++)for(var colOffset=rowOffset+c*x.strides[2],startCLerp=Math.floor(c*invWidthScale),startDyC=Math.floor(startCLerp-winWidth/2),d=0;d<depth;d++){for(var accum=0,dyRIndex=0;dyRIndex<winHeight;dyRIndex++){var dyR=dyRIndex+startDyR;if(!(dyR<0||dyR>=yHeight)){var dyROffset=batchOffset+dyR*dy.strides[1],sourceFracRow=dyR*heightScale;if(r===Math.min(xHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow)))for(var dyCIndex=0;dyCIndex<winWidth;dyCIndex++){var dyC=dyCIndex+startDyC;if(!(dyC<0||dyC>=yWidth)){var dyCOffset=dyROffset+dyC*dy.strides[2],sourceFracCol=dyC*widthScale;c===Math.min(xWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))&&(accum+=dyValues[dyCOffset+d])}}}}output[colOffset+d]=accum}return ops.tensor4d(output,x.shape,x.dtype)},MathBackendCPU.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){cpu_util_1.assertNotComplex([x,mean,variance,scale,offset],"batchNorm");for(var xVals=this.readSync(x.dataId),mVals=this.readSync(mean.dataId),varVals=this.readSync(variance.dataId),sVals=scale?this.readSync(scale.dataId):new Float32Array([1]),offVals=offset?this.readSync(offset.dataId):new Float32Array([0]),outVals=new Float32Array(xVals.length),offValsLength=offVals.length,sValsLength=sVals.length,varValsLength=varVals.length,mValsLength=mVals.length,offi=0,mi=0,si=0,vi=0,i=0;i<xVals.length;++i)outVals[i]=offVals[offi++]+(xVals[i]-mVals[mi++])*sVals[si++]/Math.sqrt(varVals[vi++]+varianceEpsilon),offi>=offValsLength&&(offi=0),mi>=mValsLength&&(mi=0),si>=sValsLength&&(si=0),vi>=varValsLength&&(vi=0);return ops_1.tensor4d(outVals,x.shape)},MathBackendCPU.prototype.localResponseNormalization4D=function(x,depthRadius,bias,alpha,beta){cpu_util_1.assertNotComplex(x,"localResponseNormalization4D");var channels=x.shape[3],maxD=channels-1,xValues=this.readSync(x.dataId),size=x.size,result=new Float32Array(size);function sumAcrossChannels(offset){for(var currentChannel=offset%channels,beginSumOffset=offset-currentChannel+Math.max(0,currentChannel-depthRadius),endSumOffset=offset-currentChannel+Math.min(currentChannel+depthRadius,maxD),sum=0;beginSumOffset<=endSumOffset;beginSumOffset++){var z=xValues[beginSumOffset];sum+=z*z}return sum}for(var offset=0;offset<size;offset++){var sum=sumAcrossChannels(offset),val=xValues[offset]*Math.pow(bias+alpha*sum,-beta);result[offset]=val}return ops.tensor4d(result,x.shape)},MathBackendCPU.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){cpu_util_1.assertNotComplex(dy,"LRNGrad");for(var channels=dy.shape[3],dyValues=this.readSync(dy.dataId),inputImageValues=this.readSync(inputImage.dataId),outputImageValues=this.readSync(outputImage.dataId),result=new Float32Array(dy.size),size=dy.size,offset=0;offset<size;offset++){for(var currentChannel=offset%channels,depthBegin=offset-currentChannel+Math.max(0,currentChannel-depthRadius),depthEnd=offset-currentChannel+Math.min(channels,currentChannel+depthRadius+1),norm=0,k=depthBegin;k<depthEnd;k++)norm+=Math.pow(inputImageValues[k],2);norm=alpha*norm+bias;for(k=depthBegin;k<depthEnd;k++){var dyi=-2*alpha*beta*inputImageValues[k]*outputImageValues[offset]/norm;offset===k&&(dyi+=Math.pow(norm,-beta)),dyi*=dyValues[offset],result[k]+=dyi}}return ops.tensor4d(result,dy.shape)},MathBackendCPU.prototype.multinomial=function(logits,normalized,numSamples,seed){cpu_util_1.assertNotComplex(logits,"multinomial");for(var probabilities=normalized?logits:ops.softmax(logits),batchSize=probabilities.shape[0],numEvents=probabilities.shape[1],res=ops.zeros([batchSize,numSamples],"int32"),resVals=this.readSync(res.dataId),probVals=this.readSync(probabilities.dataId),b=0;b<batchSize;++b){var offset=b*numEvents,cdf=new Float32Array(numEvents-1);cdf[0]=probVals[offset];for(var event_1=1;event_1<cdf.length;++event_1)cdf[event_1]=cdf[event_1-1]+probVals[offset+event_1];for(var random=seedrandom.alea(seed.toString()),outOffset=b*numSamples,sampleId=0;sampleId<numSamples;++sampleId){var r=random();resVals[outOffset+sampleId]=cdf.length;for(var event_2=0;event_2<cdf.length;event_2++)if(r<cdf[event_2]){resVals[outOffset+sampleId]=event_2;break}}}return res},MathBackendCPU.prototype.oneHot=function(indices,depth,onValue,offValue){cpu_util_1.assertNotComplex(indices,"oneHot");var res=new Float32Array(indices.size*depth);res.fill(offValue);for(var indicesVal=this.readSync(indices.dataId),event_3=0;event_3<indices.size;++event_3)indicesVal[event_3]>=0&&indicesVal[event_3]<depth&&(res[event_3*depth+indicesVal[event_3]]=onValue);return ops.tensor2d(res,[indices.size,depth],"int32")},MathBackendCPU.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){cpu_util_1.assertNotComplex(boxes,"nonMaxSuppression");var boxesVals=this.readSync(boxes.dataId),scoresVals=this.readSync(scores.dataId);return non_max_suppression_impl_1.nonMaxSuppressionV3(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendCPU.prototype.fft=function(x){return this.fftBatch(x,!1)},MathBackendCPU.prototype.ifft=function(x){return this.fftBatch(x,!0)},MathBackendCPU.prototype.fftBatch=function(x,inverse){for(var batch=x.shape[0],innerDim=x.shape[1],realResult=ops.buffer(x.shape,"float32"),imagResult=ops.buffer(x.shape,"float32"),real=ops.real(x).as2D(batch,innerDim),imag=ops.imag(x).as2D(batch,innerDim),b=0;b<batch;b++)for(var r=real.slice([b,0],[1,innerDim]),i=imag.slice([b,0],[1,innerDim]),input=ops.complex(r,i),res=this.readSync(this.fftImpl(input,inverse).dataId),d=0;d<innerDim;d++){var c=complex_util.getComplexWithIndex(res,d);realResult.values[b*innerDim+d]=c.real,imagResult.values[b*innerDim+d]=c.imag}return ops.complex(realResult.toTensor(),imagResult.toTensor()).as2D(batch,innerDim)},MathBackendCPU.prototype.fftImpl=function(x,inverse){var x1D=x.as1D(),n=x1D.size;if(this.isExponentOf2(n)){var result=this.fftRadix2(x1D,n,inverse).as2D(x.shape[0],x.shape[1]);return inverse&&(result=ops.complex(ops.real(result).div(ops_1.scalar(n)),ops.imag(result).div(ops_1.scalar(n)))),result}var data=this.readSync(x.dataId),rawOutput=this.fourierTransformByMatmul(data,n,inverse),output=complex_util.splitRealAndImagArrays(rawOutput);return ops.complex(output.real,output.imag).as2D(x.shape[0],x.shape[1])},MathBackendCPU.prototype.isExponentOf2=function(size){return 0==(size&size-1)},MathBackendCPU.prototype.fftRadix2=function(input,size,inverse){if(1===size)return input;var data=this.readSync(input.dataId),half=size/2,evenComplex=complex_util.complexWithEvenIndex(data),evenTensor=ops.complex(evenComplex.real,evenComplex.imag).as1D(),oddComplex=complex_util.complexWithOddIndex(data),oddTensor=ops.complex(oddComplex.real,oddComplex.imag).as1D();evenTensor=this.fftRadix2(evenTensor,half,inverse),oddTensor=this.fftRadix2(oddTensor,half,inverse);var e=complex_util.exponents(size,inverse),exponent=ops.complex(e.real,e.imag).mul(oddTensor),addPart=evenTensor.add(exponent),subPart=evenTensor.sub(exponent),realTensor=ops.real(addPart).concat(ops.real(subPart)),imagTensor=ops.imag(addPart).concat(ops.imag(subPart));return ops.complex(realTensor,imagTensor).as1D()},MathBackendCPU.prototype.fourierTransformByMatmul=function(data,size,inverse){for(var ret=new Float32Array(2*size),r=0;r<size;r++){for(var real_2=0,imag_2=0,c=0;c<size;c++){var e=complex_util.exponent(r*c,size,inverse),term=complex_util.getComplexWithIndex(data,c);real_2+=term.real*e.real-term.imag*e.imag,imag_2+=term.real*e.imag+term.imag*e.real}inverse&&(real_2/=size,imag_2/=size),complex_util.assignToTypedArray(ret,real_2,imag_2,r)}return ret},MathBackendCPU.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert("NHWC"===dataFormat,(function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+dataFormat})),util.assert(blockSize>1,(function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize}));for(var batchSize=x.shape[0],inputHeight=x.shape[1],inputWidth=x.shape[2],inputDepth=x.shape[3],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),xValues=this.readSync(x.dataId),result=new Float32Array(batchSize*outputHeight*outputWidth*outputDepth),outputIdx=0,b=0;b<batchSize;++b)for(var h=0;h<outputHeight;++h)for(var inH=Math.floor(h/blockSize),offsetH=h%blockSize,w=0;w<outputWidth;++w)for(var inW=Math.floor(w/blockSize),offsetD=(offsetH*blockSize+w%blockSize)*outputDepth,d=0;d<outputDepth;++d){var inputIdx=d+offsetD+inputDepth*(inW+inputWidth*(inH+inputHeight*b));result[outputIdx++]=xValues[inputIdx]}return ops.tensor4d(result,[batchSize,outputHeight,outputWidth,outputDepth])},MathBackendCPU.prototype.broadcastedBinaryOp=function(a,b,dtype,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),result=ops.buffer(newShape,dtype),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),resVals=result.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<resVals.length;++i)resVals[i]=op(aVals[i%aVals.length],bVals[i%bVals.length]);else{var aBuf=this.bufferSync(a),bBuf=this.bufferSync(b),_loop_2=function(i){var loc=result.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach((function(d){return aLoc[d]=0}));var aIndex=aBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach((function(d){return bLoc[d]=0}));var bIndex=bBuf.locToIndex(bLoc);resVals[i]=op(aVals[aIndex],bVals[bIndex])};for(i=0;i<resVals.length;++i)_loop_2(i)}return result.toTensor()},MathBackendCPU.prototype.broadcastedBinaryComplexOp=function(a,b,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),realResult=ops.buffer(newShape,"float32"),imagResult=ops.buffer(newShape,"float32"),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),realVals=realResult.values,imagVals=imagResult.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<realVals.length;i++){var aIdx=i%aVals.length,bIdx=i%bVals.length,result=op(aVals[2*aIdx],aVals[2*aIdx+1],bVals[2*bIdx],bVals[2*bIdx+1]);realVals[i]=result.real,imagVals[i]=result.imag}else{var aRealBuf=this.bufferSync(this.data.get(a.dataId).complexTensors.real),bRealBuf=this.bufferSync(this.data.get(b.dataId).complexTensors.real),_loop_3=function(i){var loc=realResult.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach((function(d){return aLoc[d]=0}));var aIndex=aRealBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach((function(d){return bLoc[d]=0}));var bIndex=bRealBuf.locToIndex(bLoc),opResult=op(aVals[2*aIndex],aVals[2*aIndex+1],bVals[2*bIndex],bVals[2*bIndex+1]);realVals[i]=opResult.real,imagVals[i]=opResult.imag};for(i=0;i<realVals.length;i++)_loop_3(i)}return this.complex(realResult.toTensor(),imagResult.toTensor())},MathBackendCPU.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendCPU.prototype.dispose=function(){},MathBackendCPU.prototype.floatPrecision=function(){return 32},MathBackendCPU.prototype.epsilon=function(){return backend_1.EPSILON_FLOAT32},MathBackendCPU.prototype.cropAndResize=function(images,boxes,boxIndex,cropSize,method,extrapolationValue){for(var _a=images.shape,batch=_a[0],imageHeight=_a[1],imageWidth=_a[2],numChannels=_a[3],numBoxes=boxes.shape[0],cropHeight=cropSize[0],cropWidth=cropSize[1],output=ops.buffer([numBoxes,cropHeight,cropWidth,numChannels],"float32"),boxVals=this.readSync(boxes.dataId),boxIndVals=this.readSync(boxIndex.dataId),imageVals=this.readSync(images.dataId),inStride=images.strides,outStride=output.strides,b=0;b<numBoxes;b++){var startInd=4*b,y1=boxVals[startInd],x1=boxVals[startInd+1],y2=boxVals[startInd+2],x2=boxVals[startInd+3],bInd=boxIndVals[b];if(!(bInd>=batch))for(var heightScale=cropHeight>1?(y2-y1)*(imageHeight-1)/(cropHeight-1):0,widthScale=cropWidth>1?(x2-x1)*(imageWidth-1)/(cropWidth-1):0,y=0;y<cropHeight;y++){var yInd=cropHeight>1?y1*(imageHeight-1)+y*heightScale:.5*(y1+y2)*(imageHeight-1);if(yInd<0||yInd>imageHeight-1)for(var x=0;x<cropWidth;x++)for(var c=0;c<numChannels;c++){var ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else if("bilinear"===method){var topInd=Math.floor(yInd),bottomInd=Math.ceil(yInd),yLerp=yInd-topInd;for(x=0;x<cropWidth;x++){if((xInd=cropWidth>1?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||xInd>imageWidth-1)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var leftInd=Math.floor(xInd),rightInd=Math.ceil(xInd),xLerp=xInd-leftInd;for(c=0;c<numChannels;c++){var topLeft=imageVals[ind=c+leftInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],topRight=imageVals[ind=c+rightInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],bottomLeft=imageVals[ind=c+leftInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]],top_2=topLeft+(topRight-topLeft)*xLerp,bottom=bottomLeft+(imageVals[ind=c+rightInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]]-bottomLeft)*xLerp;ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0],output.values[ind]=top_2+(bottom-top_2)*yLerp}}}}else for(x=0;x<cropWidth;++x){var xInd;if((xInd=cropWidth>1?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||xInd>imageWidth-1)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var closestX=Math.round(xInd),closestY=Math.round(yInd);for(c=0;c<numChannels;c++){var inInd=c+closestX*inStride[2]+closestY*inStride[1]+bInd*inStride[0],outInd=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[outInd]=imageVals[inInd]}}}}}return output.toTensor()},MathBackendCPU.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize;return this.scatter(sparseIndices,sparseValues,outputShape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!1)},MathBackendCPU.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3];if(0===numSlices)return ops_1.tensor([],resultShape,x.dtype);for(var buffer=new tensor_1.TensorBuffer([numSlices,sliceSize],x.dtype),indicesData=this.readSync(indices.dataId),xData=this.readSync(x.dataId),i=0;i<numSlices;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];flattenIndex+=dim*strides[j],index.push(dim)}if(flattenIndex<0||flattenIndex>=x.size/sliceSize)throw new Error("Invalid indices: "+index+" does not index into "+x.shape);for(var k=0;k<sliceSize;k++)buffer.values[i*sliceSize+k]=xData[flattenIndex*sliceSize+k]}return buffer.toTensor().reshape(resultShape)},MathBackendCPU.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,defaultValue=ops_1.scalar(0);return this.scatter(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!0)},MathBackendCPU.prototype.fill=function(shape,value,dtype){dtype=dtype||util_1.inferDtype(value);var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),engine_1.ENGINE.makeTensor(values,shape,dtype,this)},MathBackendCPU.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(x.shape,1,x.dtype)},MathBackendCPU.prototype.zerosLike=function(x){var values=util_1.getArrayFromDType(x.dtype,util_1.sizeFromShape(x.shape));return this.makeOutput(values,x.shape,x.dtype)},MathBackendCPU.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendCPU.prototype.scatter=function(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,sumDupeIndices){var flattenShape=[outputSize/sliceSize,sliceSize],indicesData=this.readSync(indices.dataId),updatesData=this.readSync(updates.dataId);if(0===outputSize)return ops_1.tensor([],shape,updates.dtype);var buffer=new tensor_1.TensorBuffer(flattenShape,updates.dtype);buffer.values.fill(this.readSync(defaultValue.dataId)[0]);for(var i=0;i<numUpdates;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];index.push(dim),flattenIndex+=dim*strides[j]}if(flattenIndex<0||flattenIndex>=outputSize/sliceSize)throw new Error("Invalid indices: "+index+" does not index into "+shape);for(var k=0;k<sliceSize;k++)sumDupeIndices?buffer.values[flattenIndex*sliceSize+k]+=updatesData[i*sliceSize+k]:buffer.values[flattenIndex*sliceSize+k]=0===updates.rank?updatesData[0]:updatesData[i*sliceSize+k]}return buffer.toTensor().reshape(shape)},MathBackendCPU}(backend_1.KernelBackend);exports.MathBackendCPU=MathBackendCPU,engine_1.ENGINE.registerBackend("cpu",(function(){return new MathBackendCPU}),1)},{"../../engine":106,"../../environment":107,"../../log":128,"../../ops/array_ops_util":131,"../../ops/axis_util":132,"../../ops/broadcast_util":136,"../../ops/complex_ops":139,"../../ops/concat_util":141,"../../ops/erf_util":148,"../../ops/gather_nd_util":152,"../../ops/ops":164,"../../ops/scatter_nd_util":172,"../../ops/selu_util":175,"../../ops/slice_util":178,"../../tensor":207,"../../types":213,"../../util":214,"../backend":2,"../backend_util":3,"../complex_util":4,"../non_max_suppression_impl":12,"../split_shared":14,"../tile_impl":15,"../topk_impl":16,"../where_impl":103,"./cpu_util":6,seedrandom:397}],6:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../../util");exports.assertNotComplex=function(tensor,opName){Array.isArray(tensor)||(tensor=[tensor]),tensor.forEach((function(t){null!=t&&util_1.assert("complex64"!==t.dtype,(function(){return opName+" does not support complex64 tensors."}))}))}},{"../../util":214}],7:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../../../kernel_names"),non_max_suppression_impl_1=require("../../non_max_suppression_impl"),cpu_util_1=require("../cpu_util");exports.nonMaxSuppressionV5Config={kernelName:kernel_names_1.NonMaxSuppressionV5,backendName:"cpu",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,attrs=_a.attrs,_b=inputs,boxes=_b.boxes,scores=_b.scores,_c=attrs,maxOutputSize=_c.maxOutputSize,iouThreshold=_c.iouThreshold,scoreThreshold=_c.scoreThreshold,softNmsSigma=_c.softNmsSigma,cpuBackend=backend;cpu_util_1.assertNotComplex(boxes,"NonMaxSuppressionWithScore");var boxesVals=cpuBackend.data.get(boxes.dataId).values,scoresVals=cpuBackend.data.get(scores.dataId).values,maxOutputSizeVal=maxOutputSize,iouThresholdVal=iouThreshold,scoreThresholdVal=scoreThreshold,softNmsSigmaVal=softNmsSigma,_d=non_max_suppression_impl_1.nonMaxSuppressionV5(boxesVals,scoresVals,maxOutputSizeVal,iouThresholdVal,scoreThresholdVal,softNmsSigmaVal);return[_d.selectedIndices,_d.selectedScores]}}},{"../../../kernel_names":126,"../../non_max_suppression_impl":12,"../cpu_util":6}],8:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../../../kernel_names"),cpu_util_1=require("../cpu_util");exports.squareConfig={kernelName:kernel_names_1.Square,backendName:"cpu",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,x=inputs.x,cpuBackend=backend;cpu_util_1.assertNotComplex(x,"square");for(var values=cpuBackend.data.get(x.dataId).values,newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=value*value}return{dataId:cpuBackend.write(newValues,x.shape,x.dtype),shape:x.shape,dtype:x.dtype}}}},{"../../../kernel_names":126,"../cpu_util":6}],9:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../../../kernel_names"),cpu_util_1=require("../cpu_util"),kernel_utils_1=require("../utils/kernel_utils");exports.squaredDifferenceConfig={kernelName:kernel_names_1.SquaredDifference,backendName:"cpu",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,_b=inputs,a=_b.a,b=_b.b,cpuBackend=backend;cpu_util_1.assertNotComplex([a,b],kernel_names_1.SquaredDifference);var aVals=cpuBackend.data.get(a.dataId).values,bVals=cpuBackend.data.get(b.dataId).values,_c=kernel_utils_1.broadcastedBinaryOp(a.shape,b.shape,aVals,bVals,a.dtype,(function(aVal,bVal){var diff=aVal-bVal;return diff*diff})),resultData=_c[0],resultShape=_c[1];return{dataId:cpuBackend.write(resultData,resultShape,a.dtype),shape:resultShape,dtype:a.dtype}}}},{"../../../kernel_names":126,"../cpu_util":6,"../utils/kernel_utils":11}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});for(
/**
 * @license
 * Copyright 2020 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var kernel_registry_1=require("../../kernel_registry"),NonMaxSuppressionV5_1=require("./kernels/NonMaxSuppressionV5"),Square_1=require("./kernels/Square"),SquaredDifference_1=require("./kernels/SquaredDifference"),_i=0,kernelConfigs_1=[NonMaxSuppressionV5_1.nonMaxSuppressionV5Config,Square_1.squareConfig,SquaredDifference_1.squaredDifferenceConfig];_i<kernelConfigs_1.length;_i++){var kernelConfig=kernelConfigs_1[_i];kernel_registry_1.registerKernel(kernelConfig)}},{"../../kernel_registry":127,"./kernels/NonMaxSuppressionV5":7,"./kernels/Square":8,"./kernels/SquaredDifference":9}],11:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var backend_util=require("../../../backends/backend_util"),util=require("../../../util");exports.broadcastedBinaryOp=function(aShape,bShape,aVals,bVals,dtype,op){var newShape=backend_util.assertAndGetBroadcastShape(aShape,bShape),resultRank=newShape.length,resultStrides=util.computeStrides(newShape),resultSize=util.sizeFromShape(newShape),result=util.getTypedArrayFromDType(dtype,resultSize),aRank=aShape.length,bRank=bShape.length,aStrides=util.computeStrides(aShape),bStrides=util.computeStrides(bShape),aBroadcastDims=backend_util.getBroadcastDims(aShape,newShape),bBroadcastDims=backend_util.getBroadcastDims(bShape,newShape);if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<result.length;++i)result[i]=op(aVals[i%aVals.length],bVals[i%bVals.length]);else{var _loop_1=function(i){var loc=util.indexToLoc(i,resultRank,resultStrides),aLoc=loc.slice(-aRank);aBroadcastDims.forEach((function(d){return aLoc[d]=0}));var aIndex=util.locToIndex(aLoc,aRank,aStrides),bLoc=loc.slice(-bRank);bBroadcastDims.forEach((function(d){return bLoc[d]=0}));var bIndex=util.locToIndex(bLoc,bRank,bStrides);result[i]=op(aVals[aIndex],bVals[bIndex])};for(i=0;i<result.length;++i)_loop_1(i)}return[result,newShape]}},{"../../../backends/backend_util":3,"../../../util":214}],12:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),array_util_1=require("./array_util");function nonMaxSuppressionImpl_(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma,returnScoresTensor,padToMaxOutputSize){void 0===returnScoresTensor&&(returnScoresTensor=!1),void 0===padToMaxOutputSize&&(padToMaxOutputSize=!1);for(var candidates=Array.from(scores).map((function(score,boxIndex){return{score:score,boxIndex:boxIndex,suppressBeginIndex:0}})).filter((function(c){return c.score>scoreThreshold})).sort(ascendingComparator),scale=softNmsSigma>0?-.5/softNmsSigma:0,selectedIndices=[],selectedScores=[];selectedIndices.length<maxOutputSize&&candidates.length>0;){var candidate=candidates.pop(),originalScore=candidate.score,boxIndex=candidate.boxIndex,suppressBeginIndex=candidate.suppressBeginIndex;if(originalScore<scoreThreshold)break;for(var ignoreCandidate=!1,j=selectedIndices.length-1;j>=suppressBeginIndex;--j){var iou=intersectionOverUnion(boxes,boxIndex,selectedIndices[j]);if(iou>=iouThreshold){ignoreCandidate=!0;break}if(candidate.score=candidate.score*suppressWeight(iouThreshold,scale,iou),candidate.score<=scoreThreshold)break}candidate.suppressBeginIndex=selectedIndices.length,ignoreCandidate||(candidate.score===originalScore?(selectedIndices.push(boxIndex),selectedScores.push(candidate.score)):candidate.score>scoreThreshold&&array_util_1.binaryInsert(candidates,candidate,ascendingComparator))}var numValidOutputs=selectedIndices.length;return padToMaxOutputSize&&(selectedIndices.fill(0,numValidOutputs),selectedScores.fill(0,numValidOutputs)),{selectedIndices:tensor_ops_1.tensor1d(selectedIndices,"int32"),selectedScores:tensor_ops_1.tensor1d(selectedScores,"float32"),numValidOutputs:tensor_ops_1.scalar(numValidOutputs,"int32")}}function intersectionOverUnion(boxes,i,j){var iCoord=boxes.subarray(4*i,4*i+4),jCoord=boxes.subarray(4*j,4*j+4),yminI=Math.min(iCoord[0],iCoord[2]),xminI=Math.min(iCoord[1],iCoord[3]),ymaxI=Math.max(iCoord[0],iCoord[2]),xmaxI=Math.max(iCoord[1],iCoord[3]),yminJ=Math.min(jCoord[0],jCoord[2]),xminJ=Math.min(jCoord[1],jCoord[3]),ymaxJ=Math.max(jCoord[0],jCoord[2]),xmaxJ=Math.max(jCoord[1],jCoord[3]),areaI=(ymaxI-yminI)*(xmaxI-xminI),areaJ=(ymaxJ-yminJ)*(xmaxJ-xminJ);if(areaI<=0||areaJ<=0)return 0;var intersectionYmin=Math.max(yminI,yminJ),intersectionXmin=Math.max(xminI,xminJ),intersectionYmax=Math.min(ymaxI,ymaxJ),intersectionXmax=Math.min(xmaxI,xmaxJ),intersectionArea=Math.max(intersectionYmax-intersectionYmin,0)*Math.max(intersectionXmax-intersectionXmin,0);return intersectionArea/(areaI+areaJ-intersectionArea)}function suppressWeight(iouThreshold,scale,iou){var weight=Math.exp(scale*iou*iou);return iou<=iouThreshold?weight:0}function ascendingComparator(c1,c2){return c1.score-c2.score||c1.score===c2.score&&c2.boxIndex-c1.boxIndex}exports.nonMaxSuppressionV3=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){return nonMaxSuppressionImpl_(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,0).selectedIndices},exports.nonMaxSuppressionV5=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma){var result=nonMaxSuppressionImpl_(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma,!0);return result.numValidOutputs.dispose(),{selectedIndices:result.selectedIndices,selectedScores:result.selectedScores}}},{"../ops/tensor_ops":186,"./array_util":1}],13:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */function getVecChannels(name,rank){return["x","y","z","w","u","v"].slice(0,rank).map((function(d){return name+"."+d}))}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVecChannels=getVecChannels,exports.getChannels=function(name,rank){return 1===rank?[name]:getVecChannels(name,rank)},exports.getSourceCoords=function(rank,dims){if(1===rank)return"rc";for(var coords="",i=0;i<rank;i++)coords+=dims[i],i<rank-1&&(coords+=",");return coords}},{}],14:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.split=function(x,sizeSplits,axis){var begin=new Array(x.rank).fill(0),size=x.shape.slice();return sizeSplits.map((function(s){size[axis]=s;var slice=x.slice(begin,size);return begin[axis]+=s,slice}))}},{}],15:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.tile=function(xBuf,reps){for(var newShape=new Array(xBuf.rank),i=0;i<newShape.length;i++)newShape[i]=xBuf.shape[i]*reps[i];var result=array_ops_1.buffer(newShape,xBuf.dtype);for(i=0;i<result.values.length;++i){for(var newLoc=result.indexToLoc(i),originalLoc=new Array(xBuf.rank),j=0;j<originalLoc.length;j++)originalLoc[j]=newLoc[j]%xBuf.shape[j];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()}},{"../ops/array_ops":130}],16:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util");exports.topkImpl=function(x,xShape,xDtype,k,sorted){for(var lastDim=xShape[xShape.length-1],_a=[x.length/lastDim,lastDim],batch=_a[0],size=_a[1],allTopKVals=util_1.getTypedArrayFromDType(xDtype,batch*k),allTopKIndices=util_1.getTypedArrayFromDType("int32",batch*k),b=0;b<batch;b++){for(var offset=b*size,vals=x.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});valAndInd.sort((function(a,b){return b.value-a.value}));var outOffset=b*k,topKVals=allTopKVals.subarray(outOffset,outOffset+k),topKIndices=allTopKIndices.subarray(outOffset,outOffset+k);for(i=0;i<k;i++)topKVals[i]=valAndInd[i].value,topKIndices[i]=valAndInd[i].index}var outputShape=xShape.slice();return outputShape[outputShape.length-1]=k,[tensor_ops_1.tensor(allTopKVals,outputShape,xDtype),tensor_ops_1.tensor(allTopKIndices,outputShape,"int32")]}},{"../ops/tensor_ops":186,"../util":214}],17:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var AddNProgram=function(outputShape,shapes){this.outputShape=[],this.outputShape=outputShape,this.variableNames=shapes.map((function(_,i){return"T"+i}));var snippets=[];this.variableNames.forEach((function(variable){snippets.push("float v"+variable+" = get"+variable+"AtOutCoords();")}));var operation=this.variableNames.map((function(variable){return"v"+variable})).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        float result = "+operation+";\n        setOutput(result);\n      }\n    "};exports.AddNProgram=AddNProgram},{}],18:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var AddNPackedProgram=function(outputShape,shapes){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=outputShape,this.variableNames=shapes.map((function(_,i){return"T"+i}));var snippets=[];this.variableNames.forEach((function(variable){snippets.push("vec4 v"+variable+" = get"+variable+"AtOutCoords();")}));var operation=this.variableNames.map((function(variable){return"v"+variable})).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        vec4 result = "+operation+";\n        setOutput(result);\n      }\n    "};exports.AddNPackedProgram=AddNPackedProgram},{}],19:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ArgMinMaxProgram=function(reduceInfo,op,firstPass){this.variableNames=["A"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);firstPass||this.variableNames.push("bestIndicesA"),this.outputShape=[batchSize,outSize];var compOp="max"===op?">":"<",indexSnippet=firstPass?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          int inIdx = "+indexSnippet+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+compOp+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};exports.ArgMinMaxProgram=ArgMinMaxProgram},{}],20:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),ArgMinMaxPackedProgram=function(shape,windowSize,op,firstPass){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,util_1.assert(shape.length>2,(function(){return"Packed arg"+(op.charAt(0).toUpperCase()+op.slice(1))+" supports only inputs with rank above 2."}));var inSize=shape[shape.length-1],outSize=Math.ceil(inSize/windowSize);this.outputShape=shape.slice(0,-1),outSize>1&&this.outputShape.push(outSize),firstPass||this.variableNames.push("bestIndicesA");var sourceLocSetup,sourceRank,outShape=this.outputShape,rank=outShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank);if(1===outSize){sourceRank=rank+1;var sourceLocDType=shader_compiler_1.getCoordsDataType(sourceRank);sourceLocSetup="\n        "+sourceLocDType+" sourceLocR = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocG = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-2]+";\n        "+sourceLocDType+" sourceLocA = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocB = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-2]+";"}else sourceRank=rank,sourceLocSetup="\n        "+dtype+" sourceLocR = coords;\n        ++"+coords[rank-1]+";\n        "+dtype+" sourceLocG = coords;\n        ++"+coords[rank-2]+";\n        "+dtype+" sourceLocA = coords;\n        --"+coords[rank-1]+";\n        "+dtype+" sourceLocB = coords;\n        --"+coords[rank-2]+";";var channels=["x","y","z","w","u","v"].slice(0,sourceRank),inChannel="."+channels[sourceRank-1],intChannels=channels.map((function(x){return"int "+x})),srcRCoords=packing_util_1.getChannels("sourceLocR",sourceRank-1).concat("inIdx.r"),srcGCoords=packing_util_1.getChannels("sourceLocG",sourceRank-1).concat("inIdx.g"),srcBCoords=packing_util_1.getChannels("sourceLocB",sourceRank-1).concat("inIdx.b"),srcACoords=packing_util_1.getChannels("sourceLocA",sourceRank-1).concat("inIdx.a"),compOp="max"===op?"greaterThan":"lessThan",fetchCandidateIdx=firstPass?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+srcRCoords.join()+"),\n                             getBestIndicesAChannel("+srcGCoords.join()+"),\n                             getBestIndicesAChannel("+srcBCoords.join()+"),\n                             getBestIndicesAChannel("+srcACoords.join()+")));",fetchValue="vec4(\n            getAChannel("+srcRCoords.join()+"),\n            hasNextCol ? getAChannel("+srcGCoords.join()+") : 0.,\n            hasNextRow ? getAChannel("+srcBCoords.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+srcACoords.join()+") : 0.)",getBestIndicesAChannelSnippet=firstPass?"":"\n      float getBestIndicesAChannel("+intChannels.join()+") {\n        return getChannel(getBestIndicesA("+channels.join()+"),\n                                          vec2("+channels.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+intChannels.join()+") {\n        return getChannel(getA("+channels.join()+"),\n                               vec2("+channels.slice(-2).join()+"));\n      }\n      "+getBestIndicesAChannelSnippet+"\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        bool hasNextCol = "+coords[rank-1]+" < "+(outShape[rank-1]-1)+";\n        bool hasNextRow = "+coords[rank-2]+" < "+(outShape[rank-2]-1)+";\n        "+sourceLocSetup+"\n        ivec4 srcIdx = ivec4(sourceLocR"+inChannel+", sourceLocG"+inChannel+",\n          sourceLocB"+inChannel+", sourceLocA"+inChannel+") * "+windowSize+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+fetchValue+";\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          inIdx = srcIdx;\n          "+fetchCandidateIdx+"\n          vec4 candidate = "+fetchValue+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+compOp+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "};exports.ArgMinMaxPackedProgram=ArgMinMaxPackedProgram},{"../../util":214,"../packing_util":13,"./shader_compiler":89}],21:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var AvgPool2DBackpropProgram=function(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterHeight*filterWidth);this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+";\n            wC+= "+dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.AvgPool2DBackpropProgram=AvgPool2DBackpropProgram;var AvgPool3DBackpropProgram=function(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterDepth*filterHeight*filterWidth);this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.AvgPool3DBackpropProgram=AvgPool3DBackpropProgram},{}],22:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0}),require("./flags_webgl");var device_util=require("../../device_util"),engine_1=require("../../engine"),environment_1=require("../../environment"),globals_1=require("../../globals"),log_1=require("../../log"),array_ops_1=require("../../ops/array_ops"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util_1=require("../../ops/concat_util"),gather_nd_util=require("../../ops/gather_nd_util"),reduce_util=require("../../ops/reduce_util"),scatter_nd_util=require("../../ops/scatter_nd_util"),segment_util=require("../../ops/segment_util"),slice_util=require("../../ops/slice_util"),softmax_1=require("../../ops/softmax"),tensor_ops_1=require("../../ops/tensor_ops"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util_1=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl"),addn_gpu_1=require("./addn_gpu"),addn_packed_gpu_1=require("./addn_packed_gpu"),argminmax_gpu_1=require("./argminmax_gpu"),argminmax_packed_gpu_1=require("./argminmax_packed_gpu"),avg_pool_backprop_gpu_1=require("./avg_pool_backprop_gpu"),batchnorm_gpu_1=require("./batchnorm_gpu"),batchnorm_packed_gpu_1=require("./batchnorm_packed_gpu"),binaryop_complex_gpu=require("./binaryop_complex_gpu"),binaryop_complex_gpu_1=require("./binaryop_complex_gpu"),binaryop_gpu=require("./binaryop_gpu"),binaryop_gpu_1=require("./binaryop_gpu"),binaryop_packed_gpu=require("./binaryop_packed_gpu"),binaryop_packed_gpu_1=require("./binaryop_packed_gpu"),canvas_util_1=require("./canvas_util"),clip_gpu_1=require("./clip_gpu"),clip_packed_gpu_1=require("./clip_packed_gpu"),complex_abs_gpu_1=require("./complex_abs_gpu"),concat_gpu_1=require("./concat_gpu"),concat_packed_gpu_1=require("./concat_packed_gpu"),conv_backprop_gpu_1=require("./conv_backprop_gpu"),conv_backprop_gpu_depthwise_1=require("./conv_backprop_gpu_depthwise"),conv_gpu_1=require("./conv_gpu"),conv_gpu_depthwise_1=require("./conv_gpu_depthwise"),conv_packed_gpu_depthwise_1=require("./conv_packed_gpu_depthwise"),crop_and_resize_gpu_1=require("./crop_and_resize_gpu"),cumsum_gpu_1=require("./cumsum_gpu"),decode_matrix_gpu_1=require("./decode_matrix_gpu"),decode_matrix_packed_gpu_1=require("./decode_matrix_packed_gpu"),depth_to_space_gpu_1=require("./depth_to_space_gpu"),diag_gpu_1=require("./diag_gpu"),encode_float_gpu_1=require("./encode_float_gpu"),encode_float_packed_gpu_1=require("./encode_float_packed_gpu"),encode_matrix_gpu_1=require("./encode_matrix_gpu"),encode_matrix_packed_gpu_1=require("./encode_matrix_packed_gpu"),fft_gpu=require("./fft_gpu"),fft_gpu_1=require("./fft_gpu"),fill_gpu_1=require("./fill_gpu"),gather_gpu_1=require("./gather_gpu"),gather_nd_gpu_1=require("./gather_nd_gpu"),gpgpu_context_1=require("./gpgpu_context"),gpgpu_math=require("./gpgpu_math"),im2col_packed_gpu_1=require("./im2col_packed_gpu"),lrn_gpu_1=require("./lrn_gpu"),lrn_grad_gpu_1=require("./lrn_grad_gpu"),lrn_packed_gpu_1=require("./lrn_packed_gpu"),max_pool_backprop_gpu_1=require("./max_pool_backprop_gpu"),mulmat_packed_gpu_1=require("./mulmat_packed_gpu"),multinomial_gpu_1=require("./multinomial_gpu"),onehot_gpu_1=require("./onehot_gpu"),pack_gpu_1=require("./pack_gpu"),pad_gpu_1=require("./pad_gpu"),pad_packed_gpu_1=require("./pad_packed_gpu"),pool_gpu_1=require("./pool_gpu"),reduce_gpu_1=require("./reduce_gpu"),reshape_packed_gpu_1=require("./reshape_packed_gpu"),resize_bilinear_backprop_gpu_1=require("./resize_bilinear_backprop_gpu"),resize_bilinear_gpu_1=require("./resize_bilinear_gpu"),resize_bilinear_packed_gpu_1=require("./resize_bilinear_packed_gpu"),resize_nearest_neighbor_backprop_gpu_1=require("./resize_nearest_neighbor_backprop_gpu"),resize_nearest_neighbor_gpu_1=require("./resize_nearest_neighbor_gpu"),reverse_gpu_1=require("./reverse_gpu"),reverse_packed_gpu_1=require("./reverse_packed_gpu"),scatter_gpu_1=require("./scatter_gpu"),segment_gpu_1=require("./segment_gpu"),select_gpu_1=require("./select_gpu"),slice_gpu_1=require("./slice_gpu"),slice_packed_gpu_1=require("./slice_packed_gpu"),strided_slice_gpu_1=require("./strided_slice_gpu"),tex_util=require("./tex_util"),tex_util_1=require("./tex_util"),texture_manager_1=require("./texture_manager"),tile_gpu_1=require("./tile_gpu"),transpose_gpu_1=require("./transpose_gpu"),transpose_packed_gpu_1=require("./transpose_packed_gpu"),unary_op=require("./unaryop_gpu"),unaryop_gpu_1=require("./unaryop_gpu"),unary_packed_op=require("./unaryop_packed_gpu"),unaryop_packed_gpu_1=require("./unaryop_packed_gpu"),unpack_gpu_1=require("./unpack_gpu"),webgl_util=require("./webgl_util"),binaryCaches={};function getBinaryCache(webGLVersion){return webGLVersion in binaryCaches||(binaryCaches[webGLVersion]={}),binaryCaches[webGLVersion]}function mapActivationToShaderProgram(activation,packed){if(void 0===packed&&(packed=!1),"linear"===activation)return packed?unary_packed_op.LINEAR:unary_op.LINEAR;if("relu"===activation)return packed?unary_packed_op.RELU:unary_op.RELU;if("elu"===activation)return packed?unary_packed_op.ELU:unary_op.ELU;if("relu6"===activation)return packed?unary_packed_op.RELU6:unary_op.RELU6;if("prelu"===activation)return packed?binaryop_packed_gpu.PRELU:binaryop_gpu.PRELU;throw new Error("Activation "+activation+" has not been implemented for the WebGL backend.")}exports.getBinaryCache=getBinaryCache;exports.MATMUL_SHARED_DIM_THRESHOLD=1e3;var MathBackendWebGL=function(_super){function MathBackendWebGL(gpgpu){var _this=_super.call(this)||this;if(_this.pendingRead=new WeakMap,_this.pendingDisposal=new WeakSet,_this.dataRefCount=new WeakMap,_this.numBytesInGPU=0,_this.uploadWaitMs=0,_this.downloadWaitMs=0,_this.warnedAboutMemory=!1,_this.pendingDeletes=0,_this.disposed=!1,!environment_1.env().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==gpgpu){var gl=canvas_util_1.getWebGLContext(environment_1.env().getNumber("WEBGL_VERSION"));_this.binaryCache=getBinaryCache(environment_1.env().getNumber("WEBGL_VERSION")),_this.gpgpu=new gpgpu_context_1.GPGPUContext(gl),_this.canvas=gl.canvas,_this.gpgpuCreatedLocally=!0}else _this.gpgpu=gpgpu,_this.binaryCache={},_this.gpgpuCreatedLocally=!1,_this.canvas=gpgpu.gl.canvas;return _this.textureManager=new texture_manager_1.TextureManager(_this.gpgpu),_this.numMBBeforeWarning=null==environment_1.env().global.screen?1024:environment_1.env().global.screen.height*environment_1.env().global.screen.width*window.devicePixelRatio*600/1024/1024,_this.texData=new backend_1.DataStorage(_this,engine_1.ENGINE),_this}return __extends(MathBackendWebGL,_super),MathBackendWebGL.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},MathBackendWebGL.prototype.write=function(values,shape,dtype){if(environment_1.env().getBool("DEBUG")&&this.checkNumericalProblems(values),"complex64"===dtype&&null!=values)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var dataId={};return this.texData.set(dataId,{shape:shape,dtype:dtype,values:values,usage:tex_util_1.TextureUsage.UPLOAD}),dataId},MathBackendWebGL.prototype.move=function(dataId,values,shape,dtype){if(environment_1.env().getBool("DEBUG")&&this.checkNumericalProblems(values),"complex64"===dtype)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(dataId,{shape:shape,dtype:dtype,values:values,usage:tex_util_1.TextureUsage.UPLOAD})},MathBackendWebGL.prototype.readSync=function(dataId){var texData=this.texData.get(dataId),values=texData.values,dtype=texData.dtype,complexTensors=texData.complexTensors,slice=texData.slice,shape=texData.shape,isPacked=texData.isPacked;if(null!=slice){var program=void 0;program=isPacked?new unaryop_packed_gpu_1.UnaryOpPackedProgram(shape,unary_op.CLONE):new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE);var res=this.runWebGLProgram(program,[{dataId:dataId,shape:shape,dtype:dtype}],dtype),data=this.readSync(res.dataId);return this.disposeData(res.dataId),data}if(null!=values)return this.convertAndCacheOnCPU(dataId);if("string"===dtype)return values;var start,result,shouldTimeProgram=null!=this.activeTimers;if(shouldTimeProgram&&(start=util.now()),"complex64"===dtype){var realValues=complexTensors.real.dataSync(),imagValues=complexTensors.imag.dataSync();result=complex_util_1.mergeRealAndImagArrays(realValues,imagValues)}else result=this.getValuesFromTexture(dataId);return shouldTimeProgram&&(this.downloadWaitMs+=util.now()-start),this.convertAndCacheOnCPU(dataId,result)},MathBackendWebGL.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,(function(){var subscribers_1,texData,values,shape,slice,dtype,complexTensors,isPacked,program,res,data,buffer,tmpDownloadTarget,tmpData,vals,ps,realValues,imagValues,size,dTypeVals,subscribers,_a;return __generator(this,(function(_b){switch(_b.label){case 0:if(this.pendingRead.has(dataId))return subscribers_1=this.pendingRead.get(dataId),[2,new Promise((function(resolve){return subscribers_1.push(resolve)}))];if(texData=this.texData.get(dataId),values=texData.values,shape=texData.shape,slice=texData.slice,dtype=texData.dtype,complexTensors=texData.complexTensors,isPacked=texData.isPacked,null!=slice)return program=void 0,program=isPacked?new unaryop_packed_gpu_1.UnaryOpPackedProgram(shape,unary_op.CLONE):new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE),res=this.runWebGLProgram(program,[{dataId:dataId,shape:shape,dtype:dtype}],dtype),data=this.read(res.dataId),this.disposeData(res.dataId),[2,data];if(null!=values)return[2,this.convertAndCacheOnCPU(dataId)];if(!environment_1.env().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===environment_1.env().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return buffer=null,"complex64"!==dtype&&environment_1.env().get("WEBGL_BUFFER_SUPPORTED")&&(tmpDownloadTarget=this.decode(dataId),tmpData=this.texData.get(tmpDownloadTarget.dataId),buffer=(_a=this.gpgpu).createBufferFromTexture.apply(_a,[tmpData.texture].concat(tex_util.getDenseTexShape(shape)))),this.pendingRead.set(dataId,[]),"complex64"===dtype?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:_b.sent(),_b.label=2;case 2:return"complex64"!==dtype?[3,4]:[4,Promise.all([complexTensors.real.data(),complexTensors.imag.data()])];case 3:return ps=_b.sent(),realValues=ps[0],imagValues=ps[1],vals=complex_util_1.mergeRealAndImagArrays(realValues,imagValues),[3,5];case 4:null==buffer?vals=this.getValuesFromTexture(dataId):(size=util.sizeFromShape(shape),vals=this.gpgpu.downloadFloat32MatrixFromBuffer(buffer,size)),_b.label=5;case 5:return null!=tmpDownloadTarget&&this.disposeData(tmpDownloadTarget.dataId),dTypeVals=this.convertAndCacheOnCPU(dataId,vals),subscribers=this.pendingRead.get(dataId),this.pendingRead.delete(dataId),subscribers.forEach((function(resolve){return resolve(dTypeVals)})),this.pendingDisposal.has(dataId)&&(this.pendingDisposal.delete(dataId),this.disposeData(dataId),this.pendingDeletes--),[2,dTypeVals]}}))}))},MathBackendWebGL.prototype.checkNumericalProblems=function(values){if(null!=values)for(var i=0;i<values.length;i++){var num=values[i];if(!webgl_util.canBeRepresented(num)){if(environment_1.env().getBool("WEBGL_RENDER_FLOAT32_CAPABLE"))throw Error("The value "+num+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'");throw Error("The value "+num+" cannot be represented on this device.")}}},MathBackendWebGL.prototype.getValuesFromTexture=function(dataId){var _a,_b=this.texData.get(dataId),shape=_b.shape,dtype=_b.dtype,isPacked=_b.isPacked,size=util.sizeFromShape(shape);if(environment_1.env().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var tmpTarget=this.decode(dataId),tmpData_1=this.texData.get(tmpTarget.dataId),vals_1=(_a=this.gpgpu).downloadMatrixFromPackedTexture.apply(_a,[tmpData_1.texture].concat(tex_util.getDenseTexShape(shape))).subarray(0,size);return this.disposeData(tmpTarget.dataId),vals_1}var shouldUsePackedProgram=environment_1.env().getBool("WEBGL_PACK")&&!0===isPacked,outputShape=shouldUsePackedProgram?webgl_util.getShapeAs3D(shape):shape,program=shouldUsePackedProgram?new encode_float_packed_gpu_1.EncodeFloatPackedProgram(outputShape):new encode_float_gpu_1.EncodeFloatProgram(outputShape),output=this.runWebGLProgram(program,[{shape:outputShape,dtype:dtype,dataId:dataId}],"float32"),tmpData=this.texData.get(output.dataId),vals=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(tmpData.texture,tmpData.texShape[0],tmpData.texShape[1]).subarray(0,size);return this.disposeData(output.dataId),vals},MathBackendWebGL.prototype.time=function(f){return __awaiter(this,void 0,void 0,(function(){var oldActiveTimers,newActiveTimers,outerMostTime,flattenedActiveTimerQueries,flattenedActiveTimerNames,res,kernelMs_1;return __generator(this,(function(_a){switch(_a.label){case 0:return oldActiveTimers=this.activeTimers,newActiveTimers=[],outerMostTime=!1,null==this.programTimersStack?(this.programTimersStack=newActiveTimers,outerMostTime=!0):this.activeTimers.push(newActiveTimers),this.activeTimers=newActiveTimers,f(),flattenedActiveTimerQueries=util.flatten(this.activeTimers.map((function(d){return d.query}))).filter((function(d){return null!=d})),flattenedActiveTimerNames=util.flatten(this.activeTimers.map((function(d){return d.name}))).filter((function(d){return null!=d})),this.activeTimers=oldActiveTimers,outerMostTime&&(this.programTimersStack=null),res={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[4,Promise.all(flattenedActiveTimerQueries)]:[3,2];case 1:return kernelMs_1=_a.sent(),res.kernelMs=util.sum(kernelMs_1),res.getExtraProfileInfo=function(){return kernelMs_1.map((function(d,i){return{name:flattenedActiveTimerNames[i],ms:d}})).map((function(d){return d.name+": "+d.ms})).join(", ")},[3,3];case 2:res.kernelMs={error:"WebGL query timers are not supported in this environment."},_a.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,res]}}))}))},MathBackendWebGL.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},MathBackendWebGL.prototype.startTimer=function(){return environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:util.now(),endMs:null}},MathBackendWebGL.prototype.endTimer=function(query){return environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),query):(query.endMs=util.now(),query)},MathBackendWebGL.prototype.getQueryTime=function(query){return __awaiter(this,void 0,void 0,(function(){var timerQuery;return __generator(this,(function(_a){return environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[2,this.gpgpu.waitForQueryAndGetTime(query)]:[2,(timerQuery=query).endMs-timerQuery.startMs]}))}))},MathBackendWebGL.prototype.disposeData=function(dataId){if(!this.pendingDisposal.has(dataId)){if(this.pendingRead.has(dataId))return this.pendingDisposal.add(dataId),void this.pendingDeletes++;if(this.texData.has(dataId)){this.releaseGPUData(dataId);var complexTensors=this.texData.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.texData.delete(dataId)}}},MathBackendWebGL.prototype.releaseGPUData=function(dataId){var _a=this.texData.get(dataId),texture=_a.texture,dtype=_a.dtype,texShape=_a.texShape,usage=_a.usage,isPacked=_a.isPacked,slice=_a.slice,key=slice&&slice.origDataId||dataId,refCount=this.dataRefCount.get(key);refCount>1?this.dataRefCount.set(key,refCount-1):(this.dataRefCount.delete(key),null!=texture&&(this.numBytesInGPU-=this.computeBytes(texShape,dtype),this.textureManager.releaseTexture(texture,texShape,usage,isPacked)));var texData=this.texData.get(dataId);texData.texture=null,texData.texShape=null,texData.isPacked=!1,texData.slice=null},MathBackendWebGL.prototype.getTexture=function(dataId){return this.uploadToGPU(dataId),this.texData.get(dataId).texture},MathBackendWebGL.prototype.getDataInfo=function(dataId){return this.texData.get(dataId)},MathBackendWebGL.prototype.getCPUBackend=function(){return environment_1.env().getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=engine_1.ENGINE.findBackend("cpu")),this.cpuBackend):null},MathBackendWebGL.prototype.shouldExecuteOnCPU=function(inputs,sizeThreshold){var _this=this;return void 0===sizeThreshold&&(sizeThreshold=128),null!=this.getCPUBackend()&&inputs.every((function(input){return null==_this.texData.get(input.dataId).texture&&input.size<sizeThreshold}))},MathBackendWebGL.prototype.getGPGPUContext=function(){return this.gpgpu},MathBackendWebGL.prototype.complex=function(real,imag){var result=this.makeOutput(real.shape,"complex64");return this.texData.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendWebGL.prototype.real=function(input){return this.texData.get(input.dataId).complexTensors.real.clone()},MathBackendWebGL.prototype.imag=function(input){return this.texData.get(input.dataId).complexTensors.imag.clone()},MathBackendWebGL.prototype.slice=function(x,begin,size){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.slice(x,begin,size);if(0===util.sizeFromShape(size))return tensor_ops_1.tensor([],size,x.dtype);var isPacked=this.texData.get(x.dataId).isPacked,isContinous=slice_util.isSliceContinous(x.shape,begin,size);if(isPacked||!isContinous){var program=environment_1.env().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new slice_packed_gpu_1.SlicePackedProgram(size):new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[x],null,customSetup)}return this.uploadToGPU(x.dataId),this.shallowSlice(x,begin,size)},MathBackendWebGL.prototype.shallowSlice=function(x,begin,size){var xTexData=this.texData.get(x.dataId),t=this.makeOutput(size,x.dtype),newTexData=this.texData.get(t.dataId);Object.assign(newTexData,xTexData),newTexData.shape=size,newTexData.dtype=x.dtype;var flatOffset=slice_util.computeFlatOffset(begin,x.strides);xTexData.slice&&(flatOffset+=xTexData.slice.flatOffset),newTexData.slice={flatOffset:flatOffset,origDataId:xTexData.slice&&xTexData.slice.origDataId||x.dataId};var refCount=this.dataRefCount.get(newTexData.slice.origDataId)||1;return this.dataRefCount.set(newTexData.slice.origDataId,refCount+1),t},MathBackendWebGL.prototype.stridedSlice=function(x,begin,end,strides){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.stridedSlice(x,begin,end,strides);var outShape=slice_util.computeOutShape(begin,end,strides);if(outShape.some((function(axis){return 0===axis})))return tensor_ops_1.tensor([],outShape);var program=new strided_slice_gpu_1.StridedSliceProgram(begin,strides,outShape);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reverse=function(x,axis){var program=environment_1.env().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new reverse_packed_gpu_1.ReversePackedProgram(x.shape,axis):new reverse_gpu_1.ReverseProgram(x.shape,axis);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.concat=function(tensors,axis){if("complex64"===tensors[0].dtype){var reals=tensors.map((function(t){return complex_ops_1.real(t)})),imags=tensors.map((function(t){return complex_ops_1.imag(t)}));return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}if(this.shouldExecuteOnCPU(tensors))return this.cpuBackend.concat(tensors,axis);if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.env().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.concat(tensors.slice(0,midIndex),axis),rightSide=this.concat(tensors.slice(midIndex),axis);return this.concat([leftSide,rightSide],axis)}if(environment_1.env().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&tensors[0].rank>1){var program_1=new concat_packed_gpu_1.ConcatPackedProgram(tensors.map((function(t){return t.shape})),axis);return this.compileAndRun(program_1,tensors)}var outShape=concat_util_1.computeOutShape(tensors.map((function(t){return t.shape})),axis),tensors2D=tensors.map((function(t){return t.as2D(-1,util_1.sizeFromShape(t.shape.slice(axis)))})),program=new concat_gpu_1.ConcatProgram(tensors2D.map((function(t){return t.shape})));return this.compileAndRun(program,tensors2D).reshape(outShape)},MathBackendWebGL.prototype.neg=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.neg(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.NEG,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.NEG);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.batchMatMul=function(a,b,transposeA,transposeB){var outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],sharedDim=transposeA?a.shape[1]:a.shape[2],batch=a.shape[0];if((1===outerShapeA||1===outerShapeB)&&sharedDim>exports.MATMUL_SHARED_DIM_THRESHOLD){transposeA&&(a=a.transpose([0,2,1])),transposeB&&(b=b.transpose([0,2,1]));var a3D=1===outerShapeB?a:a.as3D(batch,sharedDim,1),axis=1===outerShapeB?2:1,b3D=1===outerShapeB?b.as3D(batch,1,sharedDim):b;return this.multiply(a3D,b3D).sum(axis,!0)}var dtype=types_1.upcastType(a.dtype,b.dtype),program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB);return this.compileAndRun(program,[a,b],dtype)},MathBackendWebGL.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],batch=a.shape[0],dtype=types_1.upcastType(a.dtype,b.dtype),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[a,b];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs,dtype)},MathBackendWebGL.prototype.multiply=function(a,b){if("complex64"===a.dtype){var aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),realProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.REAL,a.shape,b.shape),imagProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.IMAG,a.shape,b.shape),inputs=[this.makeComplexComponentTensorInfo(a,aData.complexTensors.real),this.makeComplexComponentTensorInfo(a,aData.complexTensors.imag),this.makeComplexComponentTensorInfo(b,bData.complexTensors.real),this.makeComplexComponentTensorInfo(b,bData.complexTensors.imag)],real_1=this.compileAndRun(realProgram,inputs),imag_1=this.compileAndRun(imagProgram,inputs),complex_1=this.complex(real_1,imag_1);return real_1.dispose(),imag_1.dispose(),complex_1}if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.multiply(a,b);if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.MUL,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,a.shape,b.shape);return this.compileAndRun(program,[a,b],a.dtype)},MathBackendWebGL.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){var inputs=[x,mean,variance],offsetShape=null;null!=offset&&(offsetShape=offset.shape,inputs.push(offset));var scaleShape=null;if(null!=scale&&(scaleShape=scale.shape,inputs.push(scale)),environment_1.env().getBool("WEBGL_PACK_NORMALIZATION")){var batchNormPackedProgram=new batchnorm_packed_gpu_1.BatchNormPackedProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormPackedProgram,inputs)}var batchNormProgram=new batchnorm_gpu_1.BatchNormProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormProgram,inputs)},MathBackendWebGL.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){var program=environment_1.env().getBool("WEBGL_PACK_NORMALIZATION")?new lrn_packed_gpu_1.LRNPackedProgram(x.shape,radius,bias,alpha,beta):new lrn_gpu_1.LRNProgram(x.shape,radius,bias,alpha,beta);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){var program=new lrn_grad_gpu_1.LRNGradProgram(inputImage.shape,depthRadius,bias,alpha,beta);return this.compileAndRun(program,[inputImage,outputImage,dy])},MathBackendWebGL.prototype.tile=function(x,reps){if("string"===x.dtype){var decodedData=this.readSync(x.dataId).map((function(d){return util.decodeString(d)})),buf=array_ops_1.buffer(x.shape,x.dtype,decodedData);return tile_impl_1.tile(buf,reps)}var program=new tile_gpu_1.TileProgram(x.shape,reps);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.pad=function(x,paddings,constantValue){var program=environment_1.env().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new pad_packed_gpu_1.PadPackedProgram(x.shape,paddings,constantValue):new pad_gpu_1.PadProgram(x.shape,paddings,constantValue);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.transpose=function(x,perm){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.transpose(x,perm);var program=environment_1.env().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new transpose_packed_gpu_1.TransposePackedProgram(x.shape,perm):new transpose_gpu_1.TransposeProgram(x.shape,perm);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.gather=function(x,indices,axis){if(this.shouldExecuteOnCPU([x,indices]))return this.cpuBackend.gather(x,indices,axis);var program=new gather_gpu_1.GatherProgram(x.shape,indices.size,axis);return this.compileAndRun(program,[x,indices])},MathBackendWebGL.prototype.batchToSpaceND=function(x,blockShape,crops){util.assert(x.rank<=4,(function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"}));var prod=blockShape.reduce((function(a,b){return a*b})),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendWebGL.prototype.spaceToBatchND=function(x,blockShape,paddings){util.assert(x.rank<=4,(function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"}));var prod=blockShape.reduce((function(a,b){return a*b})),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendWebGL.prototype.reduce=function(x,reduceType,dtype){var batchSize=x.shape[0],inSize=x.shape[1],reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new reduce_gpu_1.ReduceProgram(reduceInfo,reduceType),output=this.compileAndRun(program,[x],dtype);return 1===output.shape[1]?output:this.reduce(output,reduceType,dtype)},MathBackendWebGL.prototype.argReduce=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var batchSize=x.shape[0],inSize=x.shape[1];null!=bestIndicesA&&(batchSize=bestIndicesA.shape[0],inSize=bestIndicesA.shape[1]);var reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new argminmax_gpu_1.ArgMinMaxProgram(reduceInfo,reduceType,null==bestIndicesA),inputs=[x];null!=bestIndicesA&&inputs.push(bestIndicesA);var output=this.compileAndRun(program,inputs,"int32");return 1===output.shape[1]?output:this.argReduce(x,reduceType,output)},MathBackendWebGL.prototype.argReducePacked=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var inShape=null!=bestIndicesA?bestIndicesA.shape:x.shape,inSize=inShape[inShape.length-1],windowSize=reduce_util.computeOptimalWindowSize(inSize),program=new argminmax_packed_gpu_1.ArgMinMaxPackedProgram(inShape,windowSize,reduceType,null==bestIndicesA),inputs=null==bestIndicesA?[x]:[x,bestIndicesA],output=this.compileAndRun(program,inputs,"int32");return output.rank===x.rank?this.argReducePacked(x,reduceType,output):output},MathBackendWebGL.prototype.sum=function(x,axes){axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"sum",outputDType).reshape(outShape)},MathBackendWebGL.prototype.prod=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.prod(x,axes);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"prod",outputDType).reshape(outShape)},MathBackendWebGL.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){var axis=0,permutation=axis_util.getAxesPermutation([axis],x.rank),permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),axis=axis_util.getInnerMostAxes(1,x.rank)[0]);var outShape=segment_util.computeOutShape(permutedX.shape,axis,numSegments),inSize=util.sizeFromShape([permutedX.shape[axis]]),a2D=permutedX.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype),result=this.segOpCompute(a2D,"unsortedSegmentSum",segmentIds,outputDType,numSegments).reshape(outShape);return null!=permutation&&(result=result.transpose(axis_util.getUndoAxesPermutation(permutation))),result},MathBackendWebGL.prototype.segOpCompute=function(x,segOpType,segmentIds,dtype,numSegments){var batchSize=x.shape[0],inSize=x.shape[1],windowSize=segment_util.segOpComputeOptimalWindowSize(inSize,numSegments),segOpInfo={windowSize:windowSize,inSize:inSize,batchSize:batchSize,numSegments:numSegments},program=new segment_gpu_1.SegmentOpProgram(segOpInfo,segOpType),output=this.compileAndRun(program,[x,segmentIds],dtype);return output.shape[1]===numSegments?output:(segmentIds=tensor_ops_1.range(0,numSegments).tile([inSize/windowSize]),this.segOpCompute(output,segOpType,segmentIds,dtype,numSegments))},MathBackendWebGL.prototype.argMinMaxReduce=function(x,axis,reduceType){var axes=[axis];if(axis_util.assertAxesAreInnerMostDims("arg"+reduceType.charAt(0).toUpperCase()+reduceType.slice(1),axes,x.rank),!environment_1.env().getBool("WEBGL_PACK_REDUCE")||x.rank<=2){var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.argReduce(a2D,reduceType).reshape(outShape)}return this.argReducePacked(x,reduceType)},MathBackendWebGL.prototype.argMin=function(x,axis){return this.argMinMaxReduce(x,axis,"min")},MathBackendWebGL.prototype.argMax=function(x,axis){return this.argMinMaxReduce(x,axis,"max")},MathBackendWebGL.prototype.cumsum=function(x,axis,exclusive,reverse){if(axis!==x.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);var program=new cumsum_gpu_1.CumSumProgram(x.shape,exclusive,reverse);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.equal=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.EQUAL,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.notEqual=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.NOT_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.NOT_EQUAL,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.less=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.less(a,b);if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.lessEqual=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS_EQUAL,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.greater=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.greater(a,b);if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.greaterEqual=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER_EQUAL,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.logicalNot=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOGICAL_NOT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.logicalAnd=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_AND,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_AND,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.logicalOr=function(a,b){if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_OR,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_OR,a.shape,b.shape);return this.compileAndRun(program,[a,b],"bool")},MathBackendWebGL.prototype.select=function(condition,a,b){var program=new select_gpu_1.SelectProgram(condition.rank,a.shape,a.rank);return this.compileAndRun(program,[condition,a,b],types_1.upcastType(a.dtype,b.dtype))},MathBackendWebGL.prototype.where=function(condition){log_1.warn("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var condVals=condition.dataSync();return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendWebGL.prototype.topk=function(x,k,sorted){var xVals=x.dataSync();return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendWebGL.prototype.min=function(x,axes){axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"min",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.minimum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.minimum(a,b);var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MIN,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MIN,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.mod=function(a,b){var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MOD,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MOD,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.max=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.max(x,axes);axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"max",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.maximum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.maximum(a,b);var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MAX,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MAX,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.all=function(x,axes){axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"all",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.any=function(x,axes){axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"any",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.realDivide=function(a,b){var op=binaryop_gpu.DIV;if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")){return this.packedBinaryOp(a,b,binaryop_packed_gpu.DIV,"float32",!0)}var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape);return this.compileAndRun(program,[a,b],"float32")},MathBackendWebGL.prototype.floorDiv=function(a,b){var op=binaryop_gpu.INT_DIV;if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.INT_DIV,"int32");var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape);return this.compileAndRun(program,[a,b],"int32")},MathBackendWebGL.prototype.add=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.ADD);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.add(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.ADD,dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,a.shape,b.shape);return this.compileAndRun(program,[a,b],dtype)},MathBackendWebGL.prototype.packedUnaryOp=function(x,op,dtype){var program=new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,op);return this.compileAndRun(program,[x],dtype)},MathBackendWebGL.prototype.packedBinaryOp=function(a,b,op,dtype,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1);var program=new binaryop_packed_gpu_1.BinaryOpPackedProgram(op,a.shape,b.shape,checkOutOfBounds);return this.compileAndRun(program,[a,b],dtype)},MathBackendWebGL.prototype.complexSeparableBinaryOp=function(a,b,op){var _this=this,aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),_a=[[aData.complexTensors.real,bData.complexTensors.real],[aData.complexTensors.imag,bData.complexTensors.imag]].map((function(complexParts){var aPart=complexParts[0],bPart=complexParts[1],aHandle=_this.makeComplexComponentTensorInfo(a,aPart),bHandle=_this.makeComplexComponentTensorInfo(b,bPart),program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape);return _this.compileAndRun(program,[aHandle,bHandle],types_1.upcastType(aPart.dtype,bPart.dtype))})),real=_a[0],imag=_a[1],complex=this.complex(real,imag);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.makeComplexComponentTensorInfo=function(complexTensor,complexPart){return{dataId:complexPart.dataId,dtype:complexPart.dtype,shape:complexTensor.shape}},MathBackendWebGL.prototype.addN=function(tensors){if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.env().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.addN(tensors.slice(0,midIndex)),rightSide=this.addN(tensors.slice(midIndex));return this.addN([leftSide,rightSide])}var dtype=tensors.map((function(t){return t.dtype})).reduce((function(d1,d2){return types_1.upcastType(d1,d2)})),shapes=tensors.map((function(t){return t.shape})),program=environment_1.env().getBool("WEBGL_PACK")?new addn_packed_gpu_1.AddNPackedProgram(tensors[0].shape,shapes):new addn_gpu_1.AddNProgram(tensors[0].shape,shapes);return this.compileAndRun(program,tensors,dtype)},MathBackendWebGL.prototype.subtract=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.SUB);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.subtract(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.SUB,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,a.shape,b.shape);return this.compileAndRun(program,[a,b],dtype)},MathBackendWebGL.prototype.pow=function(a,b){var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.POW,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.POW,a.shape,b.shape),dtype=types_1.upcastType(a.dtype,b.dtype);return this.compileAndRun(program,[a,b],dtype)},MathBackendWebGL.prototype.ceil=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.ceil(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.CEIL,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.CEIL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.floor=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.floor(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.FLOOR,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.FLOOR);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sign=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.isNaN=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_NAN);return this.compileAndRun(program,[x],"bool")},MathBackendWebGL.prototype.isInf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_INF);return this.compileAndRun(program,[x],"bool")},MathBackendWebGL.prototype.isFinite=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_FINITE);return this.compileAndRun(program,[x],"bool")},MathBackendWebGL.prototype.round=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ROUND);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.exp=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.exp(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.EXP,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXP);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.expm1=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.expm1(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.EXPM1,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXPM1);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.softmax=function(logits,dim){var axes=util.parseAxisParam([dim],logits.shape),maxLogit=this.max(logits,axes),expandedShape=axis_util.expandShapeToKeepDim(maxLogit.shape,axes),a=this.subtract(logits,maxLogit.reshape(expandedShape)),b=this.exp(a),sumExp=this.sum(b,axes).reshape(expandedShape);return this.realDivide(b,sumExp)},MathBackendWebGL.prototype.log=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.log(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_packed_op.LOG,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.log1p=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG1P);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sqrt=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.rsqrt=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.rsqrt(x);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RSQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reciprocal=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RECIPROCAL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.relu=function(x){var program;return program=environment_1.env().getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.RELU):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RELU),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.relu6=function(x){var program;return program=environment_1.env().getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.RELU6):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RELU6),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.prelu=function(x,alpha){var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.PRELU,x.shape,alpha.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU,x.shape,alpha.shape);return this.compileAndRun(program,[x,alpha])},MathBackendWebGL.prototype.elu=function(x){if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_packed_op.ELU,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.eluDer=function(dy,y){var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ELU_DER,dy.shape,y.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ELU_DER,dy.shape,y.shape);return this.compileAndRun(program,[dy,y])},MathBackendWebGL.prototype.selu=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.int=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TO_INT);return this.compileAndRun(program,[x],"int32")},MathBackendWebGL.prototype.clip=function(x,min,max){var program,customSetup=(program=environment_1.env().getBool("WEBGL_PACK_CLIP")?new clip_packed_gpu_1.ClipPackedProgram(x.shape):new clip_gpu_1.ClipProgram(x.shape)).getCustomSetupFunc(min,max);return this.compileAndRun(program,[x],null,customSetup)},MathBackendWebGL.prototype.abs=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.abs(x);if(environment_1.env().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(x,unary_op.ABS,x.dtype);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ABS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.complexAbs=function(x){var xData=this.texData.get(x.dataId),program=new complex_abs_gpu_1.ComplexAbsProgram(x.shape),inputs=[this.makeComplexComponentTensorInfo(x,xData.complexTensors.real),this.makeComplexComponentTensorInfo(x,xData.complexTensors.imag)];return this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.sigmoid=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGMOID);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.softplus=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SOFTPLUS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan2=function(a,b){var program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ATAN2,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ATAN2,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.sinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.erf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ERF);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.step=function(x,alpha){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.STEP(alpha));return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.conv2dByMatMul=function(x,filter,convInfo,bias,activation,preluActivationWeights){var xShape=x.shape,xTexData=this.texData.get(x.dataId),sharedMatMulDim=convInfo.inChannels,outerShapeX=xShape[0]*xShape[1]*xShape[2],outerShapeFilter=convInfo.outChannels,isChannelsLast="channelsLast"===convInfo.dataFormat,batchMatMulWillBeUnpacked=(1===outerShapeX||1===outerShapeFilter)&&sharedMatMulDim>exports.MATMUL_SHARED_DIM_THRESHOLD,reshapeWillBeExpensive=xShape[2]%2!=0&&!!xTexData.isPacked;if(batchMatMulWillBeUnpacked||!environment_1.env().getBool("WEBGL_LAZILY_UNPACK")||!environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!reshapeWillBeExpensive){var targetShape_1=isChannelsLast?xShape[0]*xShape[1]*xShape[2]:xShape[0]*xShape[2]*xShape[3],xReshaped_1=this.reshape(x,[1,targetShape_1,convInfo.inChannels]),filterReshaped_1=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]);return this.reshape(this.fusedBatchMatMul({a:xReshaped_1,b:filterReshaped_1,transposeA:false,transposeB:false,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),convInfo.outShape)}var targetShape=isChannelsLast?xShape[0]*xShape[1]*(xShape[2]+1):xShape[0]*xShape[2]*(xShape[3]+1),xReshaped={dataId:x.dataId,shape:[1,targetShape,convInfo.inChannels],dtype:x.dtype},originalXTexDataShape=xTexData.shape;xTexData.shape=xTexData.shape.slice(),xTexData.shape[xTexData.shape.length-2]++,util.assert(webgl_util.isReshapeFree(xTexData.shape,xReshaped.shape),(function(){return"packed reshape "+xTexData.shape+" to "+xReshaped.shape+" isn't free"}));var filterReshaped=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]),pointwiseConv=this.fusedBatchMatMul({a:xReshaped,b:filterReshaped,transposeA:false,transposeB:false,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),pointwiseConvTexData=this.texData.get(pointwiseConv.dataId);return util.assert(pointwiseConvTexData.isPacked,(function(){return"batchMatMul result is expected to be packed"})),xTexData.shape=originalXTexDataShape,pointwiseConvTexData.shape=convInfo.outShape,engine_1.ENGINE.makeTensorFromDataId(pointwiseConv.dataId,convInfo.outShape,pointwiseConv.dtype)},MathBackendWebGL.prototype.conv2dWithIm2Row=function(x,filter,convInfo,bias,activation,preluActivationWeights){var filterWidth=convInfo.filterWidth,filterHeight=convInfo.filterHeight,inChannels=convInfo.inChannels,outWidth=convInfo.outWidth,outHeight=convInfo.outHeight,isChannelsLast="channelsLast"===convInfo.dataFormat,sharedDim=filterWidth*filterHeight*inChannels,numCols=outHeight*outWidth,x2ColShape=[sharedDim,numCols],xSqueezed=x.squeeze([0]),w2Row=filter.reshape([1,sharedDim,-1]),im2ColProgram=new im2col_packed_gpu_1.Im2ColPackedProgram(x2ColShape,xSqueezed.shape,convInfo),im2Col=this.compileAndRun(im2ColProgram,[xSqueezed]).reshape([1,x2ColShape[0],x2ColShape[1]]),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,matmulProgram=new mulmat_packed_gpu_1.MatMulPackedProgram(im2Col.shape,[1,numCols,convInfo.outChannels],!0,!1,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[im2Col,w2Row];bias&&inputs.push(bias),hasPreluActivationWeights&&inputs.push(preluActivationWeights);var product=this.compileAndRun(matmulProgram,inputs);return isChannelsLast?product.reshape([1,outHeight,outWidth,convInfo.outChannels]):product.reshape([1,convInfo.outChannels,outHeight,outWidth])},MathBackendWebGL.prototype.fusedConv2d=function(_a){var input=_a.input,filter=_a.filter,convInfo=_a.convInfo,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights;if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(input,filter,convInfo,bias,activation,preluActivationWeights);if(environment_1.env().getBool("WEBGL_CONV_IM2COL")&&1===input.shape[0])return this.conv2dWithIm2Row(input,filter,convInfo,bias,activation,preluActivationWeights);var hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!1):null,program=new conv_gpu_1.Conv2DProgram(convInfo,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[input,filter];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.conv2d=function(x,filter,convInfo){if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(x,filter,convInfo);if(environment_1.env().getBool("WEBGL_CONV_IM2COL")&&1===x.shape[0])return this.conv2dWithIm2Row(x,filter,convInfo);var program=new conv_gpu_1.Conv2DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv2dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv2dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.fusedDepthwiseConv2D=function(_a){var program,input=_a.input,filter=_a.filter,convInfo=_a.convInfo,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,shouldPackDepthwiseConv=environment_1.env().getBool("WEBGL_PACK_DEPTHWISECONV")&&convInfo.strideWidth<=2&&convInfo.outChannels/convInfo.inChannels==1,fusedActivation=activation?mapActivationToShaderProgram(activation,shouldPackDepthwiseConv):null,inputs=[input,filter],hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights;return hasBias&&inputs.push(bias),hasPreluActivationWeights&&inputs.push(preluActivationWeights),shouldPackDepthwiseConv?(program=new conv_packed_gpu_depthwise_1.DepthwiseConvPacked2DProgram(convInfo,hasBias,fusedActivation,hasPreluActivationWeights),this.compileAndRun(program,inputs)):(program=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(convInfo,hasBias,fusedActivation,hasPreluActivationWeights),this.compileAndRun(program,inputs))},MathBackendWebGL.prototype.depthwiseConv2D=function(x,filter,convInfo){var program;return environment_1.env().getBool("WEBGL_PACK_DEPTHWISECONV")&&convInfo.strideWidth<=2&&convInfo.outChannels/convInfo.inChannels==1?(program=new conv_packed_gpu_depthwise_1.DepthwiseConvPacked2DProgram(convInfo),this.compileAndRun(program,[x,filter])):(program=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(convInfo),this.compileAndRun(program,[x,filter]))},MathBackendWebGL.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.conv3d=function(x,filter,convInfo){var program=new conv_gpu_1.Conv3DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv3dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv3dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.maxPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"max",!1);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.avgPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"avg",!1);return this.compileAndRun(program,[x],"float32")},MathBackendWebGL.prototype.maxPoolBackprop=function(dy,x,y,convInfo){var maxPoolPositionsProgram=new pool_gpu_1.Pool2DProgram(convInfo,"max",!0),maxPoolPositions=this.compileAndRun(maxPoolPositionsProgram,[x]),maxPoolBackPropProgram=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(convInfo),result=this.compileAndRun(maxPoolBackPropProgram,[dy,maxPoolPositions],x.dtype);return maxPoolPositions.dispose(),result},MathBackendWebGL.prototype.avgPoolBackprop=function(dy,x,convInfo){var avgPoolBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool2DBackpropProgram(convInfo);return this.compileAndRun(avgPoolBackpropProgram,[dy],x.dtype)},MathBackendWebGL.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendWebGL.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)begin[axis]=i,res[i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendWebGL.prototype.avgPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"avg",!1);return this.compileAndRun(program,[x],"float32")},MathBackendWebGL.prototype.avgPool3dBackprop=function(dy,x,convInfo){var avgPool3dBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool3DBackpropProgram(convInfo);return this.compileAndRun(avgPool3dBackpropProgram,[dy],x.dtype)},MathBackendWebGL.prototype.maxPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"max",!1);return this.compileAndRun(program,[x],"float32")},MathBackendWebGL.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){var maxPool3dPositionsProgram=new pool_gpu_1.Pool3DProgram(convInfo,"max",!0),maxPool3dPositions=this.compileAndRun(maxPool3dPositionsProgram,[x]),maxPool3dBackPropProgram=new max_pool_backprop_gpu_1.MaxPool3DBackpropProgram(convInfo),result=this.compileAndRun(maxPool3dBackPropProgram,[dy,maxPool3dPositions],x.dtype);return maxPool3dPositions.dispose(),result},MathBackendWebGL.prototype.reshape=function(x,shape){var texData=this.texData.get(x.dataId);if(texData.isPacked&&!webgl_util.isReshapeFree(x.shape,shape)&&(null===texData.texture||!webgl_util.isReshapeFree(texData.shape,shape))){var info=this.packedReshape(x,shape);return engine_1.ENGINE.makeTensorFromDataId(info.dataId,info.shape,info.dtype)}return backend_util.reshapeTensor(x,shape)},MathBackendWebGL.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){var program=environment_1.env().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new resize_bilinear_packed_gpu_1.ResizeBilinearPackedProgram(x.shape,newHeight,newWidth,alignCorners):new resize_bilinear_gpu_1.ResizeBilinearProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x],"float32")},MathBackendWebGL.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){var program=new resize_bilinear_backprop_gpu_1.ResizeBilinearBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){var program=new resize_nearest_neighbor_gpu_1.ResizeNearestNeighborProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){var program=new resize_nearest_neighbor_backprop_gpu_1.ResizeNearestNeigborBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.multinomial=function(logits,normalized,numSamples,seed){var probs=normalized?logits:softmax_1.softmax(logits),batchSize=probs.shape[0],numOutcomes=probs.shape[1],program=new multinomial_gpu_1.MultinomialProgram(batchSize,numOutcomes,numSamples),customSetup=program.getCustomSetupFunc(seed);return this.compileAndRun(program,[probs],"int32",customSetup)},MathBackendWebGL.prototype.oneHot=function(indices,depth,onValue,offValue){var program=new onehot_gpu_1.OneHotProgram(indices.size,depth,onValue,offValue);return this.compileAndRun(program,[indices])},MathBackendWebGL.prototype.diag=function(x){var program=new diag_gpu_1.DiagProgram(x.size);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){log_1.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var boxesVals=boxes.dataSync(),scoresVals=scores.dataSync();return non_max_suppression_impl_1.nonMaxSuppressionV3(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendWebGL.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){var program=new crop_and_resize_gpu_1.CropAndResizeProgram(image.shape,boxes.shape,cropSize,method,extrapolationValue);return this.compileAndRun(program,[image,boxes,boxIndex],"float32")},MathBackendWebGL.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert(blockSize>1,(function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize}));var batchSize=x.shape[0],inputHeight="NHWC"===dataFormat?x.shape[1]:x.shape[2],inputWidth="NHWC"===dataFormat?x.shape[2]:x.shape[3],inputDepth="NHWC"===dataFormat?x.shape[3]:x.shape[1],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),outputShape="NHWC"===dataFormat?[batchSize,outputHeight,outputWidth,outputDepth]:[batchSize,outputDepth,outputHeight,outputWidth],program=new depth_to_space_gpu_1.DepthToSpaceProgram(outputShape,blockSize,dataFormat);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendWebGL.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,flattenShape=[outputSize/sliceSize,sliceSize],flattenIndices=indices.reshape([numUpdates,sliceRank]),flattenX=updates.reshape([numUpdates,sliceSize]);if(0===outputSize)return backend_util.reshapeTensor(tensor_ops_1.tensor([]),shape);var defaultValue=tensor_ops_1.scalar(0),program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,flattenIndices.rank,flattenX.rank,strides,flattenShape);return this.compileAndRun(program,[flattenX,flattenIndices,defaultValue]).reshape(shape)},MathBackendWebGL.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,strides=_a.strides,outputSize=_a.outputSize,program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,sparseIndices.rank,sparseValues.rank,strides,[outputSize,1],!1);return this.compileAndRun(program,[sparseValues,sparseIndices,defaultValue]).reshape(outputShape)},MathBackendWebGL.prototype.fft=function(x){return this.fftImpl(x,!1)},MathBackendWebGL.prototype.ifft=function(x){return this.fftImpl(x,!0)},MathBackendWebGL.prototype.fftImpl=function(x,inverse){var xData=this.texData.get(x.dataId),realProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.REAL,x.shape,inverse),imagProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.IMAG,x.shape,inverse),inputs=[this.makeComplexComponentTensorInfo(x,xData.complexTensors.real),this.makeComplexComponentTensorInfo(x,xData.complexTensors.imag)],real=this.compileAndRun(realProgram,inputs),imag=this.compileAndRun(imagProgram,inputs),complex=this.complex(real,imag).as2D(x.shape[0],x.shape[1]);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3],flattenIndices=indices.reshape([numSlices,sliceRank]),flattenX=x.reshape([x.size/sliceSize,sliceSize]),program=new gather_nd_gpu_1.GatherNDProgram(sliceRank,strides,[numSlices,sliceSize]);return this.compileAndRun(program,[flattenX,flattenIndices]).reshape(resultShape)},MathBackendWebGL.prototype.fill=function(shape,value,dtype){if("string"===(dtype=dtype||util_1.inferDtype(value))){var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),engine_1.ENGINE.makeTensor(values,shape,dtype,this)}var program=new fill_gpu_1.FillProgram(shape,value),customSetup=program.getCustomSetupFunc(value);return this.compileAndRun(program,[],dtype,customSetup)},MathBackendWebGL.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(x.shape,1,x.dtype)},MathBackendWebGL.prototype.zerosLike=function(x){return this.fill(x.shape,"string"===x.dtype?"":0,x.dtype)},MathBackendWebGL.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendWebGL.prototype.makeTensorInfo=function(shape,dtype){var dataId=this.write(null,shape,dtype);return this.texData.get(dataId).usage=null,{dataId:dataId,shape:shape,dtype:dtype}},MathBackendWebGL.prototype.makeOutput=function(shape,dtype){var dataId=this.makeTensorInfo(shape,dtype).dataId;return engine_1.ENGINE.makeTensorFromDataId(dataId,shape,dtype,this)},MathBackendWebGL.prototype.unpackTensor=function(input){var program=new unpack_gpu_1.UnpackProgram(input.shape);return this.runWebGLProgram(program,[input],input.dtype)},MathBackendWebGL.prototype.packTensor=function(input){var program=new pack_gpu_1.PackProgram(input.shape);return this.runWebGLProgram(program,[input],input.dtype,null,!0)},MathBackendWebGL.prototype.packedReshape=function(input,afterShape){var input3DShape=[webgl_util.getBatchDim(input.shape)].concat(webgl_util.getRowsCols(input.shape)),input3D={dtype:input.dtype,shape:input3DShape,dataId:input.dataId},afterShapeAs3D=[webgl_util.getBatchDim(afterShape)].concat(webgl_util.getRowsCols(afterShape)),program=new reshape_packed_gpu_1.ReshapePackedProgram(afterShapeAs3D,input3DShape),output=this.runWebGLProgram(program,[input3D],input.dtype,null,!0);return{dataId:output.dataId,shape:afterShape,dtype:output.dtype}},MathBackendWebGL.prototype.decode=function(dataId){var program,texData=this.texData.get(dataId),isPacked=texData.isPacked,shape=texData.shape,dtype=texData.dtype,shapeAs3D=webgl_util.getShapeAs3D(shape);program=isPacked?new decode_matrix_packed_gpu_1.DecodeMatrixPackedProgram(shapeAs3D):new decode_matrix_gpu_1.DecodeMatrixProgram(shapeAs3D);return{dtype:dtype,shape:shape,dataId:this.runWebGLProgram(program,[{shape:shapeAs3D,dtype:dtype,dataId:dataId}],dtype,null,!0).dataId}},MathBackendWebGL.prototype.runWebGLProgram=function(program,inputs,outputDtype,customSetup,preventEagerUnpackingOfOutput){var _this=this;void 0===preventEagerUnpackingOfOutput&&(preventEagerUnpackingOfOutput=!1);var output=this.makeTensorInfo(program.outputShape,outputDtype),outData=this.texData.get(output.dataId);if(program.packedOutput&&(outData.isPacked=!0),program.outPackingScheme===tex_util.PackingScheme.DENSE){var texelShape=tex_util.getDenseTexShape(program.outputShape);outData.texShape=texelShape.map((function(d){return 2*d}))}if(null!=program.outTexUsage&&(outData.usage=program.outTexUsage),0===util_1.sizeFromShape(output.shape))return outData.values=util_1.getTypedArrayFromDType(output.dtype,0),output;var dataToDispose=[],inputsData=inputs.map((function(input){if("complex64"===input.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var texData=_this.texData.get(input.dataId);if(null==texData.texture){if(!program.packedInputs&&util.sizeFromShape(input.shape)<=environment_1.env().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:input.shape,texData:null,isUniform:!0,uniformValues:texData.values};program.packedInputs&&(texData.isPacked=!0,texData.shape=input.shape)}else if(!!texData.isPacked!=!!program.packedInputs)input=texData.isPacked?_this.unpackTensor(input):_this.packTensor(input),dataToDispose.push(input),texData=_this.texData.get(input.dataId);else if(texData.isPacked&&!webgl_util.isReshapeFree(texData.shape,input.shape)){var savedInput=input,targetShape=input.shape;input.shape=texData.shape,input=_this.packedReshape(input,targetShape),dataToDispose.push(input),texData=_this.texData.get(input.dataId),savedInput.shape=targetShape}return _this.uploadToGPU(input.dataId),{shape:input.shape,texData:texData,isUniform:!1}}));this.uploadToGPU(output.dataId);var query,outputData={shape:output.shape,texData:outData,isUniform:!1},key=gpgpu_math.makeShaderKey(program,inputsData,outputData),binary=this.getAndSaveBinary(key,(function(){return gpgpu_math.compileProgram(_this.gpgpu,program,inputsData,outputData)})),shouldTimeProgram=null!=this.activeTimers;if(shouldTimeProgram&&(query=this.startTimer()),gpgpu_math.runProgram(this.gpgpu,binary,inputsData,outputData,customSetup),dataToDispose.forEach((function(info){return _this.disposeData(info.dataId)})),shouldTimeProgram&&(query=this.endTimer(query),this.activeTimers.push({name:program.constructor.name,query:this.getQueryTime(query)})),!environment_1.env().getBool("WEBGL_LAZILY_UNPACK")&&outData.isPacked&&!1===preventEagerUnpackingOfOutput){var unpacked=this.unpackTensor(output);return this.disposeData(output.dataId),unpacked}return output},MathBackendWebGL.prototype.compileAndRun=function(program,inputs,outputDtype,customSetup,preventEagerUnpackingOfOutput){void 0===preventEagerUnpackingOfOutput&&(preventEagerUnpackingOfOutput=!1),outputDtype=outputDtype||inputs[0].dtype;var outInfo=this.runWebGLProgram(program,inputs,outputDtype,customSetup,preventEagerUnpackingOfOutput);return engine_1.ENGINE.makeTensorFromDataId(outInfo.dataId,outInfo.shape,outInfo.dtype)},MathBackendWebGL.prototype.getAndSaveBinary=function(key,getBinary){return key in this.binaryCache||(this.binaryCache[key]=getBinary()),this.binaryCache[key]},MathBackendWebGL.prototype.getTextureManager=function(){return this.textureManager},MathBackendWebGL.prototype.dispose=function(){var _this=this;if(!this.disposed){if(!environment_1.env().getBool("IS_TEST"))Object.keys(this.binaryCache).forEach((function(key){_this.gpgpu.deleteProgram(_this.binaryCache[key].webGLProgram),delete _this.binaryCache[key]}));this.textureManager.dispose(),null!=this.canvas&&"undefined"!=typeof HTMLCanvasElement&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0}},MathBackendWebGL.prototype.floatPrecision=function(){var _this=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=globals_1.tidy((function(){if(!environment_1.env().get("WEBGL_RENDER_FLOAT32_ENABLED")){var debugFlag=environment_1.env().getBool("DEBUG");environment_1.env().set("DEBUG",!1);var underflowCheckValue=_this.abs(tensor_ops_1.scalar(1e-8)).dataSync()[0];if(environment_1.env().set("DEBUG",debugFlag),underflowCheckValue>0)return 32}return 16}))),this.floatPrecisionValue},MathBackendWebGL.prototype.epsilon=function(){return 32===this.floatPrecision()?backend_1.EPSILON_FLOAT32:backend_1.EPSILON_FLOAT16},MathBackendWebGL.prototype.uploadToGPU=function(dataId){var _a,texData=this.texData.get(dataId),shape=texData.shape,dtype=texData.dtype,values=texData.values,texture=texData.texture,usage=texData.usage,isPacked=texData.isPacked;if(null==texture){var start,shouldTimeProgram=null!=this.activeTimers;shouldTimeProgram&&(start=util.now());var texShape=texData.texShape;if(null==texShape&&(texShape=webgl_util.getTextureShapeFromLogicalShape(shape,isPacked),texData.texShape=texShape),null!=values){var shapeAs3D=webgl_util.getShapeAs3D(shape),program=void 0,width=texShape[1],height=texShape[0],isByteArray=values instanceof Uint8Array;isPacked?(width=(_a=tex_util.getPackedMatrixTextureShapeWidthHeight(texShape[0],texShape[1]))[0],height=_a[1],program=new encode_matrix_packed_gpu_1.EncodeMatrixPackedProgram(shapeAs3D,[height,width],isByteArray)):program=new encode_matrix_gpu_1.EncodeMatrixProgram(shapeAs3D,[height,width],isByteArray);var tempDenseInputHandle=this.makeTensorInfo([height,width],dtype);this.texData.get(tempDenseInputHandle.dataId).usage=isByteArray?tex_util_1.TextureUsage.PIXELS:tex_util_1.TextureUsage.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(tempDenseInputHandle.dataId),width,height,values);var encodedOutputTarget=this.runWebGLProgram(program,[tempDenseInputHandle],dtype,null,!0),outputTexData=this.texData.get(encodedOutputTarget.dataId);texData.texture=outputTexData.texture,texData.texShape=outputTexData.texShape,texData.isPacked=outputTexData.isPacked,texData.usage=outputTexData.usage,this.disposeData(tempDenseInputHandle.dataId),this.texData.delete(encodedOutputTarget.dataId),texData.values=null,shouldTimeProgram&&(this.uploadWaitMs+=util.now()-start)}else{var newTexture=this.acquireTexture(texShape,usage,dtype,isPacked);texData.texture=newTexture}}},MathBackendWebGL.prototype.convertAndCacheOnCPU=function(dataId,float32Values){var texData=this.texData.get(dataId),dtype=texData.dtype;return this.releaseGPUData(dataId),null!=float32Values&&(texData.values=function(a,dtype){if("float32"===dtype||"complex64"===dtype)return a;if("int32"===dtype||"bool"===dtype){for(var result="int32"===dtype?new Int32Array(a.length):new Uint8Array(a.length),i=0;i<result.length;++i)result[i]=Math.round(a[i]);return result}throw new Error("Unknown dtype "+dtype)}(float32Values,dtype)),texData.values},MathBackendWebGL.prototype.acquireTexture=function(texShape,texType,dtype,isPacked){if(this.numBytesInGPU+=this.computeBytes(texShape,dtype),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var mb=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+mb+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(texShape,texType,isPacked)},MathBackendWebGL.prototype.computeBytes=function(shape,dtype){return shape[0]*shape[1]*util.bytesPerElement(dtype)},MathBackendWebGL}(backend_1.KernelBackend);exports.MathBackendWebGL=MathBackendWebGL,device_util.isBrowser()&&engine_1.ENGINE.registerBackend("webgl",(function(){return new MathBackendWebGL}),2)},{"../../device_util":105,"../../engine":106,"../../environment":107,"../../globals":109,"../../log":128,"../../ops/array_ops":130,"../../ops/array_ops_util":131,"../../ops/axis_util":132,"../../ops/complex_ops":139,"../../ops/concat_util":141,"../../ops/gather_nd_util":152,"../../ops/reduce_util":167,"../../ops/scatter_nd_util":172,"../../ops/segment_util":174,"../../ops/slice_util":178,"../../ops/softmax":179,"../../ops/tensor_ops":186,"../../types":213,"../../util":214,"../backend":2,"../backend_util":3,"../complex_util":4,"../non_max_suppression_impl":12,"../split_shared":14,"../tile_impl":15,"../topk_impl":16,"../where_impl":103,"./addn_gpu":17,"./addn_packed_gpu":18,"./argminmax_gpu":19,"./argminmax_packed_gpu":20,"./avg_pool_backprop_gpu":21,"./batchnorm_gpu":23,"./batchnorm_packed_gpu":24,"./binaryop_complex_gpu":25,"./binaryop_gpu":26,"./binaryop_packed_gpu":27,"./canvas_util":28,"./clip_gpu":29,"./clip_packed_gpu":30,"./complex_abs_gpu":31,"./concat_gpu":32,"./concat_packed_gpu":33,"./conv_backprop_gpu":34,"./conv_backprop_gpu_depthwise":35,"./conv_gpu":36,"./conv_gpu_depthwise":37,"./conv_packed_gpu_depthwise":38,"./crop_and_resize_gpu":39,"./cumsum_gpu":40,"./decode_matrix_gpu":41,"./decode_matrix_packed_gpu":42,"./depth_to_space_gpu":43,"./diag_gpu":44,"./encode_float_gpu":45,"./encode_float_packed_gpu":46,"./encode_matrix_gpu":47,"./encode_matrix_packed_gpu":48,"./fft_gpu":49,"./fill_gpu":50,"./flags_webgl":51,"./gather_gpu":52,"./gather_nd_gpu":53,"./gpgpu_context":55,"./gpgpu_math":56,"./im2col_packed_gpu":58,"./lrn_gpu":65,"./lrn_grad_gpu":66,"./lrn_packed_gpu":67,"./max_pool_backprop_gpu":68,"./mulmat_packed_gpu":69,"./multinomial_gpu":70,"./onehot_gpu":71,"./pack_gpu":72,"./pad_gpu":73,"./pad_packed_gpu":74,"./pool_gpu":75,"./reduce_gpu":76,"./reshape_packed_gpu":78,"./resize_bilinear_backprop_gpu":79,"./resize_bilinear_gpu":80,"./resize_bilinear_packed_gpu":81,"./resize_nearest_neighbor_backprop_gpu":82,"./resize_nearest_neighbor_gpu":83,"./reverse_gpu":84,"./reverse_packed_gpu":85,"./scatter_gpu":86,"./segment_gpu":87,"./select_gpu":88,"./slice_gpu":91,"./slice_packed_gpu":92,"./strided_slice_gpu":93,"./tex_util":94,"./texture_manager":95,"./tile_gpu":96,"./transpose_gpu":97,"./transpose_packed_gpu":98,"./unaryop_gpu":99,"./unaryop_packed_gpu":100,"./unpack_gpu":101,"./webgl_util":102}],23:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),BatchNormProgram=function(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.outputShape=[],this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="0.0";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="1.0";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+offsetSnippet+";\n        float scale = "+scaleSnippet+";\n        float inv = scale * inversesqrt(variance + float("+varianceEpsilon+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "};exports.BatchNormProgram=BatchNormProgram},{"../../ops/broadcast_util":136}],24:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),BatchNormPackedProgram=function(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="vec4(0.0)";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="vec4(1.0)";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        vec4 offset = "+offsetSnippet+";\n        vec4 scale = "+scaleSnippet+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+varianceEpsilon+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "};exports.BatchNormPackedProgram=BatchNormPackedProgram},{"../../ops/broadcast_util":136}],25:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util");exports.COMPLEX_MULTIPLY={REAL:"return areal * breal - aimag * bimag;",IMAG:"return areal * bimag + aimag * breal;"};var BinaryOpComplexProgram=function(op,aShape,bShape){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+op+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "};exports.BinaryOpComplexProgram=BinaryOpComplexProgram},{"../../ops/broadcast_util":136}],26:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),CHECK_NAN_SNIPPET="\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n";exports.ADD="return a + b;",exports.SUB="return a - b;",exports.MUL="return a * b;",exports.DIV="\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",exports.INT_DIV="\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",exports.POW="\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",exports.SQUARED_DIFFERENCE="return (a - b) * (a - b);",exports.EQUAL="return float(a == b);",exports.NOT_EQUAL="return float(a != b);",exports.LESS="return float(a < b);",exports.LESS_EQUAL="return float(a <= b);",exports.GREATER="return float(a > b);",exports.GREATER_EQUAL="return float(a >= b);",exports.LOGICAL_AND="return float(a >= 1.0 && b >= 1.0);",exports.LOGICAL_OR="return float(a >= 1.0 || b >= 1.0);",exports.MAX=CHECK_NAN_SNIPPET+"\n  return max(a, b);\n",exports.MIN=CHECK_NAN_SNIPPET+"\n  return min(a, b);\n",exports.MOD="if (b == 0.0) return NAN;\n  return mod(a, b);",exports.ATAN2=CHECK_NAN_SNIPPET+"\n  return atan(a, b);\n",exports.ELU_DER="return (b >= 1.0) ? a : a * (b + 1.0);",exports.PRELU="return (a < 0.) ? b * a : a;";var BinaryOpProgram=function(op,aShape,bShape){this.variableNames=["A","B"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+op+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "};exports.BinaryOpProgram=BinaryOpProgram},{"../../ops/broadcast_util":136}],27:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),CHECK_NAN_SNIPPET="\n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n";exports.DIV="\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n",exports.INT_DIV="\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n",exports.POW="\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.PRELU="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",exports.ELU_DER="\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",exports.ATAN2="\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.EQUAL="\n  return vec4(equal(a, b));\n",exports.NOT_EQUAL="\n  return vec4(notEqual(a, b));\n",exports.LESS="\n  return vec4(lessThan(a, b));\n",exports.LESS_EQUAL="\n  return vec4(lessThanEqual(a, b));\n",exports.GREATER="\n  return vec4(greaterThan(a, b));\n",exports.GREATER_EQUAL="\n  return vec4(greaterThanEqual(a, b));\n",exports.LOGICAL_AND="\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n",exports.LOGICAL_OR="\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n",exports.MAX="\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MIN="\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MOD="\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n";var BinaryOpPackedProgram=function(op,aShape,bShape,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape);var rank=this.outputShape.length,checkOutOfBoundsString="";if(checkOutOfBounds)if(0===rank||1===util_1.sizeFromShape(this.outputShape))checkOutOfBoundsString="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(checkOutOfBoundsString="\n          "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        ",1===rank)checkOutOfBoundsString+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var channels=packing_util_1.getChannels("coords",rank);checkOutOfBoundsString+="\n            bool nextRowOutOfBounds =\n              ("+channels[rank-2]+" + 1) >= "+this.outputShape[rank-2]+";\n            bool nextColOutOfBounds =\n              ("+channels[rank-1]+" + 1) >= "+this.outputShape[rank-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+op+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+checkOutOfBoundsString+"\n\n        setOutput(result);\n      }\n    "};exports.BinaryOpPackedProgram=BinaryOpPackedProgram},{"../../ops/broadcast_util":136,"../../util":214,"../packing_util":13,"./shader_compiler":89}],28:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var contexts={},WEBGL_ATTRIBUTES={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};exports.setWebGLContext=function(webGLVersion,gl){contexts[webGLVersion]=gl},exports.getWebGLContext=function getWebGLContext(webGLVersion){webGLVersion in contexts||(contexts[webGLVersion]=function(webGLVersion){if(1!==webGLVersion&&2!==webGLVersion)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var canvas=function(webGLVersion){if("undefined"!=typeof OffscreenCanvas&&2===webGLVersion)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}(webGLVersion);if(canvas.addEventListener("webglcontextlost",(function(ev){ev.preventDefault(),delete contexts[webGLVersion]}),!1),1===webGLVersion)return canvas.getContext("webgl",WEBGL_ATTRIBUTES)||canvas.getContext("experimental-webgl",WEBGL_ATTRIBUTES);return canvas.getContext("webgl2",WEBGL_ATTRIBUTES)}(webGLVersion));var gl=contexts[webGLVersion];return gl.isContextLost()?(delete contexts[webGLVersion],getWebGLContext(webGLVersion)):(gl.disable(gl.DEPTH_TEST),gl.disable(gl.STENCIL_TEST),gl.disable(gl.BLEND),gl.disable(gl.DITHER),gl.disable(gl.POLYGON_OFFSET_FILL),gl.disable(gl.SAMPLE_COVERAGE),gl.enable(gl.SCISSOR_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK),contexts[webGLVersion])}},{}],29:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ClipProgram=function(){function ClipProgram(aShape){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return ClipProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipProgram}();exports.ClipProgram=ClipProgram},{}],30:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ClipPackedProgram=function(){function ClipPackedProgram(aShape){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return ClipPackedProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipPackedProgram}();exports.ClipPackedProgram=ClipPackedProgram},{}],31:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ComplexAbsProgram=function(shape){this.variableNames=["real","imag"],this.outputShape=shape,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "};exports.ComplexAbsProgram=ComplexAbsProgram},{}],32:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var concat_util=require("../../ops/concat_util"),ConcatProgram=function(shapes){this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,1),this.variableNames=shapes.map((function(_,i){return"T"+i}));var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][1];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][1];var snippets=["if (yC < "+offsets[0]+") setOutput(getT0(yR, yC));"];for(i=1;i<offsets.length;i++){var shift=offsets[i-1];snippets.push("else if (yC < "+offsets[i]+") setOutput(getT"+i+"(yR, yC-"+shift+"));")}var lastIndex=offsets.length,lastShift=offsets[offsets.length-1];snippets.push("else setOutput(getT"+lastIndex+"(yR, yC-"+lastShift+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+snippets.join("\n        ")+"\n      }\n    "};exports.ConcatProgram=ConcatProgram},{"../../ops/concat_util":141}],33:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var concat_util=require("../../ops/concat_util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),ConcatPackedProgram=function(shapes,axis){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,axis);var shape=this.outputShape,rank=shape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank),channels=["x","y","z","w","u","v"].slice(0,rank);this.variableNames=shapes.map((function(_,i){return"T"+i}));var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][axis];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][axis];var channel=channels[axis],lastChannels=channels.slice(-2),allChannels=channels.join(),getValueSnippet="if ("+channel+" < "+offsets[0]+") {\n        return getChannel(\n            getT0("+allChannels+"), vec2("+lastChannels.join()+"));\n        }";for(i=1;i<offsets.length;i++){var shift_1=offsets[i-1];getValueSnippet+="\n        if ("+channel+" < "+offsets[i]+"  && "+channel+" >= "+offsets[i-1]+") {\n          return getChannel(\n            getT"+i+"("+shiftedChannels(channels,channel,shift_1)+"),\n            vec2("+shiftedChannels(lastChannels,channel,shift_1)+"));\n        }"}var lastIndex=offsets.length,shift=offsets[offsets.length-1];getValueSnippet+="\n        return getChannel(\n          getT"+lastIndex+"("+shiftedChannels(channels,channel,shift)+"),\n          vec2("+shiftedChannels(lastChannels,channel,shift)+"));",this.userCode="\n      float getValue("+channels.map((function(x){return"int "+x}))+") {\n        "+getValueSnippet+"\n      }\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+coords+"), 0., 0., 0.);\n\n        "+coords[rank-1]+" = "+coords[rank-1]+" + 1;\n        if ("+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.g = getValue("+coords+");\n        }\n\n        "+coords[rank-2]+" = "+coords[rank-2]+" + 1;\n        if ("+coords[rank-2]+" < "+shape[rank-2]+") {\n          result.a = getValue("+coords+");\n        }\n\n        "+coords[rank-1]+" = "+coords[rank-1]+" - 1;\n        if ("+coords[rank-2]+" < "+shape[rank-2]+" &&\n            "+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.b = getValue("+coords+");\n        }\n        setOutput(result);\n      }\n    "};function shiftedChannels(channels,channel,shift){var channelIdx=channels.indexOf(channel);return channels.map((function(c,idx){return idx===channelIdx?c+" - "+shift:c})).join()}exports.ConcatPackedProgram=ConcatPackedProgram},{"../../ops/concat_util":141,"../packing_util":13,"./shader_compiler":89}],34:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var Conv2DDerFilterProgram=function(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,isChannelsLast="channelsLast"===convInfo.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              if ("+isChannelsLast+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.Conv2DDerFilterProgram=Conv2DDerFilterProgram;var Conv2DDerInputProgram=function(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+channelDim+"];\n\n        ivec2 dyCorner = ivec2(coords["+rowDim+"], coords["+colDim+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n\n              if ("+isChannelsLast+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.Conv2DDerInputProgram=Conv2DDerInputProgram;var Conv3DDerFilterProgram=function(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yF = 0; yF < "+convInfo.outDepth+"; yF++) {\n            int xF = wF + yF * "+strideDepth+" - "+padFront+";\n\n            if (xF < 0 || xF >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n              int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n                int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.Conv3DDerFilterProgram=Conv3DDerFilterProgram;var Conv3DDerInputProgram=function(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=filterDepth-1-convInfo.padInfo.front,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+convInfo.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+filterDepth+" - 1 - wF;\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+filterHeight+" - 1 - wR;\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+filterWidth+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.Conv3DDerInputProgram=Conv3DDerInputProgram},{}],35:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var DepthwiseConv2DDerFilterProgram=function(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+channelMul+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.DepthwiseConv2DDerFilterProgram=DepthwiseConv2DDerFilterProgram;var DepthwiseConv2DDerInputProgram=function(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+channelMul+"; dm++) {\n              int d2 = d1 * "+channelMul+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.DepthwiseConv2DDerInputProgram=DepthwiseConv2DDerInputProgram},{}],36:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var Conv2DProgram=function(convInfo,addBias,activation,hasPreluActivationWeights){void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivationWeights&&(hasPreluActivationWeights=!1),this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4,isChannelsLast="channelsLast"===convInfo.dataFormat,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1,activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivationWeights?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"\n          float activation(float x) {\n            "+activation+"\n          }\n        ",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivationWeights&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+channelDim+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+rowDim+"], coords["+colDim+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+convInfo.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1===inputDepthVec4Remainder)+") {\n\n              if ("+isChannelsLast+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+inputDepthNearestVec4+") *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+inputDepthNearestVec4+", xR, xC) *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              }\n\n            } else if ("+(2===inputDepthVec4Remainder)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3===inputDepthVec4Remainder)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+addBiasSnippet+"\n        "+applyActivationSnippet+"\n        setOutput(result);\n      }\n    "};exports.Conv2DProgram=Conv2DProgram;var Conv3DProgram=function(convInfo){this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          int xF = xFCorner + wF * "+dilationDepth+";\n\n          if (xF < 0 || xF >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            int xR = xRCorner + wR * "+dilationHeight+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1===inputDepthVec4Remainder)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+") *\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2);\n              } else if ("+(2===inputDepthVec4Remainder)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3===inputDepthVec4Remainder)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.Conv3DProgram=Conv3DProgram},{}],37:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var DepthwiseConv2DProgram=function(convInfo,addBias,activation,hasPreluActivation){void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivation&&(hasPreluActivation=!1),this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,channelMul=convInfo.outChannels/convInfo.inChannels,activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivation?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"\n          float activation(float x) {\n            "+activation+"\n          }\n        ",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivation&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+channelMul+";\n        int q = d2 - d1 * "+channelMul+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+xNumCols+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+addBiasSnippet+"\n        "+applyActivationSnippet+"\n        setOutput(result);\n      }\n    "};exports.DepthwiseConv2DProgram=DepthwiseConv2DProgram},{}],38:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util"),DepthwiseConvPacked2DProgram=function(convInfo,addBias,activation,hasPreluActivation){void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivation&&(hasPreluActivation=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=convInfo.outShape;for(var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,texelsAcross=filterWidth,mainLoop="int xR; int xC; int xCOffset;",r=0;r<filterHeight;r++)for(var c=0;c<filterWidth;c++)mainLoop+="\n          vec4 xTexelR"+r+"C"+2*c+" = vec4(0.);\n          vec4 wR"+r+"C"+c+" = vec4(0.);\n          vec4 xR"+r+"C"+c+" = vec4(0.);";for(r=0;r<filterHeight;r++)for(var texelC=0;texelC<texelsAcross;texelC++){if(mainLoop+="\n          xR = xRCorner + "+r*dilationHeight+";\n          xC = xCCorner + "+(c=2*texelC)*dilationWidth+";\n        ",1===strideWidth){if(c<filterWidth&&(mainLoop+=padLeft%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+xNumCols+") {\n                    xTexelR"+r+"C"+c+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+xNumCols+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+r+"C"+c+" = vec4(previous.zw, xTexelR"+r+"C"+c+".xy);\n                } else {\n                  xR"+r+"C"+c+" = vec4(0, 0, xTexelR"+r+"C"+c+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+xNumRows+" && xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = xTexelR"+r+"C"+c+";\n              ",c+1<filterWidth)){var nextTexelOffset=padLeft%2==0?util.nearestLargerEven(dilationWidth):dilationWidth;dilationWidth%2==0&&padLeft%2==1||dilationWidth%2!=0&&padLeft%2!=1?(mainLoop+="\n                  xCOffset = xC + "+padLeft%2+" + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",dilationWidth>1&&(mainLoop+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+xNumRows+" &&\n                      xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                      xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+r+"C"+c+" = vec4(0.);\n                    }\n                  "),mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".xy);\n                "):mainLoop+="\n                  xCOffset = xC + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+r+"C"+(c+1)+" = xTexelR"+r+"C"+(c+2)+";\n                "}}else c<filterWidth&&(mainLoop+="\n              if(xR >= 0 && xR < "+xNumRows+") {\n            ",padLeft%2==1?(mainLoop+="\n                xCOffset = xC + 1 - "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n              ",c+1<filterWidth&&(mainLoop+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+strideWidth+";\n                  if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+r+"C"+(c+1)+" = vec4(xTexelR"+r+"C"+(c+2)+".xy, final.xy);\n                ")):(mainLoop+="\n                if(xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".xy, xTexelR"+r+"C"+(c+2)+".xy);\n              ",c+1<filterWidth&&(mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n                ")),mainLoop+="}");c<filterWidth&&(mainLoop+="\n            vec4 wTexelR"+r+"C"+c+" = getW("+r+", "+c+", d1, q);\n            wR"+r+"C"+c+" = vec4(wTexelR"+r+"C"+c+".xz, wTexelR"+r+"C"+c+".xz);\n          ",c+1<filterWidth&&(mainLoop+="\n              vec4 wTexelR"+r+"C"+(c+1)+" = getW("+r+", "+(c+1)+", d1, q);\n              wR"+r+"C"+(c+1)+" =\n                vec4(wTexelR"+r+"C"+(c+1)+".xz, wTexelR"+r+"C"+(c+1)+".xz);"))}for(r=0;r<filterHeight;r++)for(c=0;c<filterWidth;c++)mainLoop+="dotProd += xR"+r+"C"+c+" * wR"+r+"C"+c+";";var activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivation?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"vec4 activation(vec4 x) {\n          "+activation+"\n        }",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivation&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+mainLoop+"\n\n        vec4 result = dotProd;\n        "+addBiasSnippet+"\n        "+applyActivationSnippet+"\n        setOutput(result);\n      }\n    "};exports.DepthwiseConvPacked2DProgram=DepthwiseConvPacked2DProgram},{"../../util":214}],39:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var CropAndResizeProgram=function(imageShape,boxShape,cropSize,method,extrapolationValue){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var batch=imageShape[0],imageHeight=imageShape[1],imageWidth=imageShape[2],depth=imageShape[3],numBoxes=boxShape[0],cropHeight=cropSize[0],cropWidth=cropSize[1];this.outputShape=[numBoxes,cropHeight,cropWidth,depth];var methodId="bilinear"===method?1:0,_a=[imageHeight-1+".0",imageWidth-1+".0"],inputHeightFloat=_a[0],inputWidthFloat=_a[1],_b=cropHeight>1?[""+(imageHeight-1)/(cropHeight-1),"(y2-y1) * height_ratio","y1*"+inputHeightFloat+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+inputHeightFloat],heightRatio=_b[0],heightScale=_b[1],inY=_b[2],_c=cropWidth>1?[""+(imageWidth-1)/(cropWidth-1),"(x2-x1) * width_ratio","x1*"+inputWidthFloat+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+inputWidthFloat],widthRatio=_c[0],widthScale=_c[1],inX=_c[2];this.userCode="\n      const float height_ratio = float("+heightRatio+");\n      const float width_ratio = float("+widthRatio+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+batch+") {\n          return;\n        }\n\n        float height_scale = "+heightScale+";\n        float width_scale = "+widthScale+";\n\n        float in_y = "+inY+";\n        if( in_y < 0.0 || in_y > "+inputHeightFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n        float in_x = "+inX+";\n        if( in_x < 0.0 || in_x > "+inputWidthFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+methodId+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "};exports.CropAndResizeProgram=CropAndResizeProgram},{}],40:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),CumSumProgram=function(shape,exclusive,reverse){this.variableNames=["x"],this.outputShape=shape;var rank=shape.length,finalDim=shape[shape.length-1],comparator=reverse?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(reverse?"return "+finalDim+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        int end = "+getFinalCoord(rank,"coords")+";\n        float val = 0.0;\n        for (int i = "+finalDim+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+comparator+" end) {\n            continue;\n          }\n          if (idx == end && "+exclusive+") {\n            continue;\n          }\n          "+getFinalCoord(rank,"coords")+" = idx;\n          val += getX("+function(rank,name){if(1===rank)return""+name;if(2===rank)return name+".x, "+name+".y";if(3===rank)return name+".x, "+name+".y, "+name+".z";if(4===rank)return name+".x, "+name+".y, "+name+".z, "+name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}(rank,"coords")+");\n        }\n        setOutput(val);\n      }\n    "};function getFinalCoord(rank,name){if(1===rank)return""+name;if(2===rank)return name+".y";if(3===rank)return name+".z";if(4===rank)return name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}exports.CumSumProgram=CumSumProgram},{"./shader_compiler":89}],41:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util"),tex_util_1=require("./tex_util"),DecodeMatrixProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=tex_util_1.PackingScheme.DENSE;var texShape=tex_util_1.getDenseTexShape(outputShape),glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+glsl.output+" = result;\n      }\n    "};exports.DecodeMatrixProgram=DecodeMatrixProgram},{"./glsl_version":54,"./shader_compiler_util":90,"./tex_util":94}],42:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util"),tex_util_1=require("./tex_util"),DecodeMatrixPackedProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=tex_util_1.PackingScheme.DENSE;var texShape=tex_util_1.getDenseTexShape(outputShape),glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+glsl.output+" = result;\n      }\n    "};exports.DecodeMatrixPackedProgram=DecodeMatrixPackedProgram},{"./glsl_version":54,"./shader_compiler_util":90,"./tex_util":94}],43:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var DepthToSpaceProgram=function(){function DepthToSpaceProgram(outputShape,blockSize,dataFormat){this.variableNames=["x"],this.outputShape=[],this.outputShape=outputShape,this.blockSize=blockSize,this.dataFormat=dataFormat,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+blockSize+";\n      int offset_h = imod(h, "+blockSize+");\n      int in_w = w / "+blockSize+";\n      int offset_w = imod(w, "+blockSize+");\n      int offset_d = (offset_h * "+blockSize+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return DepthToSpaceProgram.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},DepthToSpaceProgram.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},DepthToSpaceProgram.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},DepthToSpaceProgram.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},DepthToSpaceProgram.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},DepthToSpaceProgram}();exports.DepthToSpaceProgram=DepthToSpaceProgram},{}],44:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var DiagProgram=function(size){this.variableNames=["X"],this.outputShape=[size,size],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "};exports.DiagProgram=DiagProgram},{}],45:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util"),tex_util_1=require("./tex_util"),EncodeFloatProgram=function(outputShape){this.variableNames=["A"],this.outTexUsage=tex_util_1.TextureUsage.DOWNLOAD;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+glsl.output+" = encode_float(x);\n      }\n    "};exports.EncodeFloatProgram=EncodeFloatProgram},{"./glsl_version":54,"./shader_compiler_util":90,"./tex_util":94}],46:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util"),tex_util_1=require("./tex_util"),EncodeFloatPackedProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=tex_util_1.TextureUsage.DOWNLOAD;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+glsl.output+" = encode_float(x);\n      }\n    "};exports.EncodeFloatPackedProgram=EncodeFloatPackedProgram},{"./glsl_version":54,"./shader_compiler_util":90,"./tex_util":94}],47:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util"),EncodeMatrixProgram=function(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)"),this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+width+";\n        int c = imod(flatIndex, "+width+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n        vec4 values = "+glsl.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+glsl.output+" = vec4("+output+", 0., 0., 0.);\n      }\n    "};exports.EncodeMatrixProgram=EncodeMatrixProgram},{"./glsl_version":54,"./shader_compiler_util":90}],48:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util"),EncodeMatrixPackedProgram=function(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var mainLoop="",output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)");for(var row=0;row<=1;row++)for(var col=0;col<=1;col++){var channel=2*row+col;mainLoop+="\n          localCoords = coords;\n          if(localCoords[2] + "+col+" < "+outputShape[2]+") {\n            localCoords[2] += "+col+";\n            if(localCoords[1] + "+row+" < "+outputShape[1]+") {\n              localCoords[1] += "+row+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+width+";\n              c = imod(flatIndex, "+width+");\n              uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n              values = "+glsl.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+channel+"] = values[0];\n              } else if(offset == 1) {\n                result["+channel+"] = values[1];\n              } else if(offset == 2) {\n                result["+channel+"] = values[2];\n              } else {\n                result["+channel+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+mainLoop+"\n\n        "+glsl.output+" = "+output+";\n      }\n    "};exports.EncodeMatrixPackedProgram=EncodeMatrixPackedProgram},{"./glsl_version":54,"./shader_compiler_util":90}],49:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.COMPLEX_FFT={REAL:"return real * expR - imag * expI;",IMAG:"return real * expI + imag * expR;"};var FFTProgram=function(op,inputShape,inverse){this.variableNames=["real","imag"];var innerDim=inputShape[1];this.outputShape=inputShape;var exponentMultiplierSnippet=inverse?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,resultDenominator=inverse?innerDim+".0":"1.0";this.userCode="\n      const float exponentMultiplier = "+exponentMultiplierSnippet+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+op+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+innerDim+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+innerDim+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+resultDenominator+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "};exports.FFTProgram=FFTProgram},{}],50:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var FillProgram=function(){function FillProgram(shape,value){this.outputShape=[],this.variableNames=["x"],this.outputShape=shape,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return FillProgram.prototype.getCustomSetupFunc=function(value){var _this=this;return function(gpgpu,webGLProgram){null==_this.valueLoc&&(_this.valueLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"value")),gpgpu.gl.uniform1f(_this.valueLoc,value)}},FillProgram}();exports.FillProgram=FillProgram},{}],51:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var device_util=require("../../device_util"),environment_1=require("../../environment"),webgl_util=require("./webgl_util"),ENV=environment_1.env();ENV.registerFlag("HAS_WEBGL",(function(){return ENV.getNumber("WEBGL_VERSION")>0})),ENV.registerFlag("WEBGL_VERSION",(function(){return webgl_util.isWebGLVersionEnabled(2)?2:webgl_util.isWebGLVersionEnabled(1)?1:0})),ENV.registerFlag("WEBGL_BUFFER_SUPPORTED",(function(){return 2===ENV.get("WEBGL_VERSION")})),ENV.registerFlag("WEBGL_CPU_FORWARD",(function(){return!0})),ENV.registerFlag("WEBGL_FORCE_F16_TEXTURES",(function(){return!1})),ENV.registerFlag("WEBGL_PACK",(function(){return ENV.getBool("HAS_WEBGL")})),ENV.registerFlag("WEBGL_PACK_NORMALIZATION",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_CLIP",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_DEPTHWISECONV",(function(){return!1})),ENV.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_PACK_REDUCE",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_LAZILY_UNPACK",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_CONV_IM2COL",(function(){return ENV.getBool("WEBGL_PACK")})),ENV.registerFlag("WEBGL_MAX_TEXTURE_SIZE",(function(){return webgl_util.getWebGLMaxTextureSize(ENV.getNumber("WEBGL_VERSION"))})),ENV.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",(function(){return webgl_util.getMaxTexturesInShader(ENV.getNumber("WEBGL_VERSION"))})),ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",(function(){var webGLVersion=ENV.getNumber("WEBGL_VERSION");return 0===webGLVersion?0:webgl_util.getWebGLDisjointQueryTimerVersion(webGLVersion)})),ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",(function(){return ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&!device_util.isMobile()})),ENV.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",(function(){return webgl_util.isCapableOfRenderingToFloatTexture(ENV.getNumber("WEBGL_VERSION"))})),ENV.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",(function(){return!ENV.getBool("WEBGL_FORCE_F16_TEXTURES")&&ENV.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")})),ENV.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",(function(){return webgl_util.isDownloadFloatTextureEnabled(ENV.getNumber("WEBGL_VERSION"))})),ENV.registerFlag("WEBGL_FENCE_API_ENABLED",(function(){return webgl_util.isWebGLFenceEnabled(ENV.getNumber("WEBGL_VERSION"))})),ENV.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",(function(){return ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}))},{"../../device_util":105,"../../environment":107,"./webgl_util":102}],52:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),GatherProgram=function(aShape,indicesLength,axis){this.variableNames=["A","indices"];var outputShape=aShape.slice();outputShape[axis]=indicesLength,this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape,axis){var rank=aShape.length;if(rank>4)throw Error("Gather for rank "+rank+" is not yet supported");if(1===rank)return"int(getIndices(resRC))";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],sourceCoords=[],i=0;i<aShape.length;i++)i===axis?sourceCoords.push("int(getIndices("+currentCoords[i]+"))"):sourceCoords.push(""+currentCoords[i]);return sourceCoords.join()}(aShape,axis);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "};exports.GatherProgram=GatherProgram},{"./shader_compiler":89}],53:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),GatherNDProgram=function(sliceDim,strides,shape){this.sliceDim=sliceDim,this.strides=strides,this.variableNames=["x","indices"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),strideString=this.sliceDim>1?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+this.strides+");\n         void main() {\n          "+dtype+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+strideString+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};exports.GatherNDProgram=GatherNDProgram},{"./shader_compiler":89}],54:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var environment_1=require("../../environment");exports.getGlslDifferences=function(){var version,attribute,varyingVs,varyingFs,texture2D,output,defineOutput,defineSpecialNaN,defineSpecialInf,defineRound;return 2===environment_1.env().getNumber("WEBGL_VERSION")?(version="#version 300 es",attribute="in",varyingVs="out",varyingFs="in",texture2D="texture",output="outputColor",defineOutput="out vec4 outputColor;",defineSpecialNaN="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",defineSpecialInf="",defineRound="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(version="",attribute="attribute",varyingVs="varying",varyingFs="varying",texture2D="texture2D",output="gl_FragColor",defineOutput="",defineSpecialNaN="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",defineSpecialInf="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",defineRound="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:version,attribute:attribute,varyingVs:varyingVs,varyingFs:varyingFs,texture2D:texture2D,output:output,defineOutput:defineOutput,defineSpecialNaN:defineSpecialNaN,defineSpecialInf:defineSpecialInf,defineRound:defineRound}}},{"../../environment":107}],55:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),gpgpu_util=require("./gpgpu_util"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util"),GPGPUContext=function(){function GPGPUContext(gl){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var glVersion=environment_1.env().getNumber("WEBGL_VERSION");null!=gl?(this.gl=gl,canvas_util_1.setWebGLContext(glVersion,gl)):this.gl=canvas_util_1.getWebGLContext(glVersion);var COLOR_BUFFER_FLOAT="WEBGL_color_buffer_float";if(1===environment_1.env().getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_float"),webgl_util.hasExtension(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_half_float");else if(environment_1.env().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(COLOR_BUFFER_FLOAT),webgl_util.hasExtension(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"EXT_color_buffer_half_float");else if(environment_1.env().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(COLOR_BUFFER_FLOAT="EXT_color_buffer_float",webgl_util.hasExtension(this.gl,COLOR_BUFFER_FLOAT))this.colorBufferFloatExtension=this.gl.getExtension(COLOR_BUFFER_FLOAT);else{if(!webgl_util.hasExtension(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=gpgpu_util.createVertexBuffer(this.gl,this.debug),this.indexBuffer=gpgpu_util.createIndexBuffer(this.gl,this.debug),this.framebuffer=webgl_util.createFramebuffer(this.gl,this.debug),this.textureConfig=tex_util.getTextureConfig(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(GPGPUContext.prototype,"debug",{get:function(){return environment_1.env().getBool("DEBUG")},enumerable:!0,configurable:!0}),GPGPUContext.prototype.dispose=function(){var _this=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var gl=this.gl;webgl_util.callAndCheck(gl,this.debug,(function(){return gl.finish()})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.deleteFramebuffer(_this.framebuffer)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.deleteBuffer(_this.indexBuffer)})),this.disposed=!0}},GPGPUContext.prototype.createFloat32MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat32MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createFloat16MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createUnsignedBytesMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createUnsignedBytesMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.uploadPixelDataToTexture=function(texture,pixels){this.throwIfDisposed(),gpgpu_util.uploadPixelDataToTexture(this.gl,this.debug,texture,pixels)},GPGPUContext.prototype.uploadDenseMatrixToTexture=function(texture,width,height,data){this.throwIfDisposed(),gpgpu_util.uploadDenseMatrixToTexture(this.gl,this.debug,texture,width,height,data,this.textureConfig)},GPGPUContext.prototype.createFloat16PackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16PackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createPackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createPackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.deleteMatrixTexture=function(texture){var _this=this;this.throwIfDisposed(),this.outputTexture===texture&&(webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer),this.outputTexture=null),webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.deleteTexture(texture)}))},GPGPUContext.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(texture,rows,columns){var _this=this;return this.downloadMatrixDriver(texture,(function(){return gpgpu_util.downloadByteEncodedFloatMatrixFromOutputTexture(_this.gl,_this.debug,rows,columns,_this.textureConfig)}))},GPGPUContext.prototype.downloadPackedMatrixFromBuffer=function(buffer,batch,rows,columns,physicalRows,physicalCols){return gpgpu_util.downloadPackedMatrixFromBuffer(this.gl,buffer,batch,rows,columns,physicalRows,physicalCols,this.textureConfig)},GPGPUContext.prototype.downloadFloat32MatrixFromBuffer=function(buffer,size){return gpgpu_util.downloadFloat32MatrixFromBuffer(this.gl,buffer,size)},GPGPUContext.prototype.createBufferFromTexture=function(texture,rows,columns){this.bindTextureToFrameBuffer(texture);var result=gpgpu_util.createBufferFromOutputTexture(this.gl,this.debug,rows,columns,this.textureConfig);return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.createAndWaitForFence=function(){var fenceContext=this.createFence(this.gl);return this.pollFence(fenceContext)},GPGPUContext.prototype.createFence=function(gl){var query,isFencePassed,_this=this;if(environment_1.env().getBool("WEBGL_FENCE_API_ENABLED")){var gl2_1=gl,sync_1=gl2_1.fenceSync(gl2_1.SYNC_GPU_COMMANDS_COMPLETE,0);gl.flush(),isFencePassed=function(){var status=gl2_1.clientWaitSync(sync_1,0,0);return status===gl2_1.ALREADY_SIGNALED||status===gl2_1.CONDITION_SATISFIED},query=sync_1}else environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(query=this.beginQuery(),this.endQuery(),isFencePassed=function(){return _this.isQueryAvailable(query,environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):isFencePassed=function(){return!0};return{query:query,isFencePassed:isFencePassed}},GPGPUContext.prototype.downloadMatrixFromPackedTexture=function(texture,physicalRows,physicalCols){var _this=this;return this.downloadMatrixDriver(texture,(function(){return gpgpu_util.downloadMatrixFromPackedOutputTexture(_this.gl,_this.debug,physicalRows,physicalCols)}))},GPGPUContext.prototype.createProgram=function(fragmentShaderSource){this.throwIfDisposed();var gl=this.gl,fragmentShader=webgl_util.createFragmentShader(gl,this.debug,fragmentShaderSource),vertexShader=gpgpu_util.createVertexShader(gl,this.debug),program=webgl_util.createProgram(gl,this.debug);return webgl_util.callAndCheck(gl,this.debug,(function(){return gl.attachShader(program,vertexShader)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.attachShader(program,fragmentShader)})),webgl_util.linkProgram(gl,this.debug,program),this.debug&&webgl_util.validateProgram(gl,this.debug,program),this.vertexAttrsAreBound||(this.setProgram(program),this.vertexAttrsAreBound=gpgpu_util.bindVertexProgramAttributeStreams(gl,this.debug,this.program,this.vertexBuffer)),program},GPGPUContext.prototype.deleteProgram=function(program){var _this=this;this.throwIfDisposed(),program===this.program&&(this.program=null),null!=program&&webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.deleteProgram(program)}))},GPGPUContext.prototype.setProgram=function(program){var _this=this;this.throwIfDisposed(),this.program=program,null!=this.program&&this.debug&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.useProgram(program)}))},GPGPUContext.prototype.getUniformLocation=function(program,uniformName,shouldThrow){return void 0===shouldThrow&&(shouldThrow=!0),this.throwIfDisposed(),shouldThrow?webgl_util.getProgramUniformLocationOrThrow(this.gl,this.debug,program,uniformName):webgl_util.getProgramUniformLocation(this.gl,program,uniformName)},GPGPUContext.prototype.getAttributeLocation=function(program,attribute){var _this=this;return this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.getAttribLocation(program,attribute)}))},GPGPUContext.prototype.getUniformLocationNoThrow=function(program,uniformName){return this.throwIfDisposed(),this.gl.getUniformLocation(program,uniformName)},GPGPUContext.prototype.setInputMatrixTexture=function(inputMatrixTexture,uniformLocation,textureUnit){this.throwIfDisposed(),this.throwIfNoProgram(),webgl_util.bindTextureToProgramUniformSampler(this.gl,this.debug,this.program,inputMatrixTexture,uniformLocation,textureUnit)},GPGPUContext.prototype.setOutputMatrixTexture=function(outputMatrixTexture,rows,columns){this.setOutputMatrixTextureDriver(outputMatrixTexture,columns,rows)},GPGPUContext.prototype.setOutputPackedMatrixTexture=function(outputPackedMatrixTexture,rows,columns){this.throwIfDisposed();var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),width=_a[0],height=_a[1];this.setOutputMatrixTextureDriver(outputPackedMatrixTexture,width,height)},GPGPUContext.prototype.setOutputMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){this.setOutputMatrixWriteRegionDriver(startColumn,startRow,numColumns,numRows)},GPGPUContext.prototype.setOutputPackedMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},GPGPUContext.prototype.debugValidate=function(){null!=this.program&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var gl=this.gl;this.debug&&this.debugValidate(),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}))},GPGPUContext.prototype.blockUntilAllProgramsCompleted=function(){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.finish()}))},GPGPUContext.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,2===environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},GPGPUContext.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.beginQuery=function(){if(2===environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var gl2=this.gl,ext_1=this.getQueryTimerExtensionWebGL2(),query_1=gl2.createQuery();return gl2.beginQuery(ext_1.TIME_ELAPSED_EXT,query_1),query_1}var ext=this.getQueryTimerExtensionWebGL1(),query=ext.createQueryEXT();return ext.beginQueryEXT(ext.TIME_ELAPSED_EXT,query),query},GPGPUContext.prototype.endQuery=function(){if(2!==environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var ext=this.getQueryTimerExtensionWebGL1();ext.endQueryEXT(ext.TIME_ELAPSED_EXT)}else{var gl2=this.gl,ext_2=this.getQueryTimerExtensionWebGL2();gl2.endQuery(ext_2.TIME_ELAPSED_EXT)}},GPGPUContext.prototype.waitForQueryAndGetTime=function(query){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,util.repeatedTry((function(){return _this.disposed||_this.isQueryAvailable(query,environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}))];case 1:return _a.sent(),[2,this.getQueryTime(query,environment_1.env().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}}))}))},GPGPUContext.prototype.getQueryTime=function(query,queryTimerVersion){if(0===queryTimerVersion)return null;if(2===queryTimerVersion){var gl2=this.gl;return gl2.getQueryParameter(query,gl2.QUERY_RESULT)/1e6}var ext=this.getQueryTimerExtensionWebGL1();return ext.getQueryObjectEXT(query,ext.QUERY_RESULT_EXT)/1e6},GPGPUContext.prototype.isQueryAvailable=function(query,queryTimerVersion){if(0===queryTimerVersion)return!0;if(2===queryTimerVersion){var gl2=this.gl,ext=this.getQueryTimerExtensionWebGL2(),available=gl2.getQueryParameter(query,gl2.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint}available=(ext=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(query,ext.QUERY_RESULT_AVAILABLE_EXT);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint},GPGPUContext.prototype.pollFence=function(fenceContext){var _this=this;return new Promise((function(resolve){_this.addItemToPoll((function(){return fenceContext.isFencePassed()}),(function(){return resolve()}))}))},GPGPUContext.prototype.pollItems=function(){for(var index=linearSearchLastTrue(this.itemsToPoll.map((function(x){return x.isDoneFn}))),i=0;i<=index;++i){(0,this.itemsToPoll[i].resolveFn)()}this.itemsToPoll=this.itemsToPoll.slice(index+1)},GPGPUContext.prototype.addItemToPoll=function(isDoneFn,resolveFn){var _this=this;this.itemsToPoll.push({isDoneFn:isDoneFn,resolveFn:resolveFn}),this.itemsToPoll.length>1||util.repeatedTry((function(){return _this.pollItems(),0===_this.itemsToPoll.length}))},GPGPUContext.prototype.bindTextureToFrameBuffer=function(texture){this.throwIfDisposed(),webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,texture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)):webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer)},GPGPUContext.prototype.downloadMatrixDriver=function(texture,downloadAndDecode){this.bindTextureToFrameBuffer(texture);var result=downloadAndDecode();return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.setOutputMatrixTextureDriver=function(outputMatrixTextureMaybePacked,width,height){this.throwIfDisposed();var gl=this.gl;webgl_util.bindColorTextureToFramebuffer(gl,this.debug,outputMatrixTextureMaybePacked,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(gl),this.outputTexture=outputMatrixTextureMaybePacked,webgl_util.callAndCheck(gl,this.debug,(function(){return gl.viewport(0,0,width,height)})),webgl_util.callAndCheck(gl,this.debug,(function(){return gl.scissor(0,0,width,height)}))},GPGPUContext.prototype.setOutputMatrixWriteRegionDriver=function(x,y,width,height){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,(function(){return _this.gl.scissor(x,y,width,height)}))},GPGPUContext.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},GPGPUContext.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},GPGPUContext}();function linearSearchLastTrue(arr){for(var i=0;i<arr.length;++i){if(!arr[i]())break}return i-1}exports.GPGPUContext=GPGPUContext,exports.linearSearchLastTrue=linearSearchLastTrue},{"../../environment":107,"../../util":214,"./canvas_util":28,"./gpgpu_util":57,"./tex_util":94,"./webgl_util":102}],56:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),shader_compiler=require("./shader_compiler");function validateBinaryAndProgram(shapeInfos,inputs){if(shapeInfos.length!==inputs.length)throw Error("Binary was compiled with "+shapeInfos.length+" inputs, but was executed with "+inputs.length+" inputs");shapeInfos.forEach((function(s,i){var shapeA=s.logicalShape,input=inputs[i],shapeB=input.shape;if(!util.arraysEqual(shapeA,shapeB))throw Error("Binary was compiled with different shapes than the current args. Shapes "+shapeA+" and "+shapeB+" must match");if(!s.isUniform||!input.isUniform){var texShapeA=s.texShape,texShapeB=input.isUniform?null:input.texData.texShape;if(!util.arraysEqual(texShapeA,texShapeB))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+texShapeA+" and "+texShapeB+" must match")}}))}exports.compileProgram=function(gpgpu,program,inputs,output){var userCode=program.userCode,inputInfos=inputs.map((function(input,i){var shapeInfo={logicalShape:input.shape,texShape:input.isUniform?null:input.texData.texShape,isUniform:input.isUniform,isPacked:!input.isUniform&&input.texData.isPacked,flatOffset:null};return null!=input.texData&&null!=input.texData.slice&&input.texData.slice.flatOffset>0&&(shapeInfo.flatOffset=input.texData.slice.flatOffset),{name:program.variableNames[i],shapeInfo:shapeInfo}})),inShapeInfos=inputInfos.map((function(x){return x.shapeInfo})),outShapeInfo={logicalShape:output.shape,texShape:output.texData.texShape,isUniform:!1,isPacked:output.texData.isPacked,flatOffset:null},source=shader_compiler.makeShader(inputInfos,outShapeInfo,userCode,program.packedInputs),webGLProgram=gpgpu.createProgram(source),infLoc=null,nanLoc=gpgpu.getUniformLocation(webGLProgram,"NAN",!1);1===environment_1.env().getNumber("WEBGL_VERSION")&&(infLoc=gpgpu.getUniformLocation(webGLProgram,"INFINITY",!1));for(var uniformLocations={},i=0;i<program.variableNames.length;i++){var varName=program.variableNames[i];uniformLocations[varName]=gpgpu.getUniformLocation(webGLProgram,varName,false),uniformLocations["offset"+varName]=gpgpu.getUniformLocation(webGLProgram,"offset"+varName,false)}return{program:program,source:source,webGLProgram:webGLProgram,uniformLocations:uniformLocations,inShapeInfos:inShapeInfos,outShapeInfo:outShapeInfo,infLoc:infLoc,nanLoc:nanLoc}},exports.runProgram=function(gpgpu,binary,inputs,output,customSetup){validateBinaryAndProgram(binary.inShapeInfos,inputs),validateBinaryAndProgram([binary.outShapeInfo],[output]);var outTex=output.texData.texture,outTexShape=output.texData.texShape;output.texData.isPacked?gpgpu.setOutputPackedMatrixTexture(outTex,outTexShape[0],outTexShape[1]):gpgpu.setOutputMatrixTexture(outTex,outTexShape[0],outTexShape[1]),gpgpu.setProgram(binary.webGLProgram),1===environment_1.env().getNumber("WEBGL_VERSION")&&null!==binary.infLoc&&gpgpu.gl.uniform1f(binary.infLoc,1/0),null!==binary.nanLoc&&gpgpu.gl.uniform1f(binary.nanLoc,NaN),inputs.forEach((function(input,i){var varName=binary.program.variableNames[i],varLoc=binary.uniformLocations[varName],varOffsetLoc=binary.uniformLocations["offset"+varName];if(null!=varLoc)if(input.isUniform)if(util.sizeFromShape(input.shape)<2)gpgpu.gl.uniform1f(varLoc,input.uniformValues[0]);else{var vals=input.uniformValues;vals instanceof Float32Array||(vals=new Float32Array(vals)),gpgpu.gl.uniform1fv(varLoc,vals)}else null!=input.texData.slice&&null!=varOffsetLoc&&gpgpu.gl.uniform1i(varOffsetLoc,input.texData.slice.flatOffset),gpgpu.setInputMatrixTexture(input.texData.texture,varLoc,i)})),null!=customSetup&&customSetup(gpgpu,binary.webGLProgram),gpgpu.executeProgram()},exports.makeShaderKey=function(program,inputs,output){var keyInputs="";inputs.concat(output).forEach((function(x){var hasOffset=null!=x.texData&&null!=x.texData.slice&&x.texData.slice.flatOffset>0,texShape=x.isUniform?"uniform":x.texData.texShape;keyInputs+=x.shape+"_"+texShape+"_"+hasOffset}));var keyUserCode=program.userCode,key=program.constructor.name;return key+="_"+keyInputs+"_"+keyUserCode}},{"../../environment":107,"../../util":214,"./shader_compiler":89}],57:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util");function createAndConfigureTexture(gl,debug,width,height,internalFormat,textureFormat,textureType){webgl_util.validateTextureSize(width,height);var texture=webgl_util.createTexture(gl,debug),tex2d=gl.TEXTURE_2D;return webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(tex2d,texture)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.texParameteri(tex2d,gl.TEXTURE_MIN_FILTER,gl.NEAREST)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.texParameteri(tex2d,gl.TEXTURE_MAG_FILTER,gl.NEAREST)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.texImage2D(tex2d,0,internalFormat,width,height,0,textureFormat,textureType,null)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,null)})),texture}exports.createVertexShader=function(gl,debug){var glsl=glsl_version_1.getGlslDifferences(),vertexShaderSource=glsl.version+"\n    precision highp float;\n    "+glsl.attribute+" vec3 clipSpacePos;\n    "+glsl.attribute+" vec2 uv;\n    "+glsl.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }";return webgl_util.createVertexShader(gl,debug,vertexShaderSource)},exports.createVertexBuffer=function(gl,debug){var vertexArray=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return webgl_util.createStaticVertexBuffer(gl,debug,vertexArray)},exports.createIndexBuffer=function(gl,debug){var triangleVertexIndices=new Uint16Array([0,1,2,2,1,3]);return webgl_util.createStaticIndexBuffer(gl,debug,triangleVertexIndices)},exports.createFloat32MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatFloat,textureConfig.textureFormatFloat,gl.FLOAT)},exports.createFloat16MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatHalfFloat,textureConfig.textureFormatFloat,textureConfig.textureTypeHalfFloat)},exports.createUnsignedBytesMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE)},exports.createPackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedFloat,gl.RGBA,gl.FLOAT)},exports.createFloat16PackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedHalfFloat,gl.RGBA,textureConfig.textureTypeHalfFloat)},exports.bindVertexProgramAttributeStreams=function(gl,debug,program,vertexBuffer){return webgl_util.callAndCheck(gl,debug,(function(){return gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer)})),webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"clipSpacePos",vertexBuffer,3,20,0)&&webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"uv",vertexBuffer,2,20,12)},exports.uploadDenseMatrixToTexture=function(gl,debug,texture,width,height,data,textureConfig){var dataForUpload,texelDataType,internalFormat;webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,texture)})),data instanceof Uint8Array?(dataForUpload=new Uint8Array(width*height*4),texelDataType=gl.UNSIGNED_BYTE,internalFormat=gl.RGBA):(dataForUpload=new Float32Array(width*height*4),texelDataType=gl.FLOAT,internalFormat=textureConfig.internalFormatPackedFloat),dataForUpload.set(data),webgl_util.callAndCheck(gl,debug,(function(){return gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,width,height,0,gl.RGBA,texelDataType,dataForUpload)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,null)}))},exports.uploadPixelDataToTexture=function(gl,debug,texture,pixels){webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,texture)})),pixels.data instanceof Uint8Array?webgl_util.callAndCheck(gl,debug,(function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,pixels.width,pixels.height,0,gl.RGBA,gl.UNSIGNED_BYTE,pixels.data)})):webgl_util.callAndCheck(gl,debug,(function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,pixels)})),webgl_util.callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,null)}))},exports.createBufferFromOutputTexture=function(gl2,debug,rows,columns,textureConfig){var buffer=gl2.createBuffer();webgl_util.callAndCheck(gl2,debug,(function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer)}));var bufferSizeBytes=16*rows*columns;return webgl_util.callAndCheck(gl2,debug,(function(){return gl2.bufferData(gl2.PIXEL_PACK_BUFFER,bufferSizeBytes,gl2.STREAM_READ)})),webgl_util.callAndCheck(gl2,debug,(function(){return gl2.readPixels(0,0,columns,rows,gl2.RGBA,gl2.FLOAT,0)})),webgl_util.callAndCheck(gl2,debug,(function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null)})),buffer},exports.downloadFloat32MatrixFromBuffer=function(gl,buffer,size){var gl2=gl,downloadTarget=new Float32Array(size);return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadByteEncodedFloatMatrixFromOutputTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],downloadTarget=new Uint8Array(tex_util.getUnpackedArraySizeFromMatrixSize(rows*columns,4));return webgl_util.callAndCheck(gl,debug,(function(){return gl.readPixels(0,0,w,h,textureConfig.downloadTextureFormat,gl.UNSIGNED_BYTE,downloadTarget)})),new Float32Array(downloadTarget.buffer)},exports.downloadPackedMatrixFromBuffer=function(gl,buffer,batch,rows,cols,physicalRows,physicalCols,textureConfig){var gl2=gl,downloadTarget=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(physicalRows,physicalCols));return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadMatrixFromPackedOutputTexture=function(gl,debug,physicalRows,physicalCols){var packedRGBA=new Float32Array(physicalRows*physicalCols*4);return webgl_util.callAndCheck(gl,debug,(function(){return gl.readPixels(0,0,physicalCols,physicalRows,gl.RGBA,gl.FLOAT,packedRGBA)})),packedRGBA}},{"./glsl_version":54,"./tex_util":94,"./webgl_util":102}],58:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),Im2ColPackedProgram=function(outputShape,inputShape,convInfo){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=outputShape;for(var filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,strideWidth=convInfo.strideWidth,strideHeight=convInfo.strideHeight,padInfo=convInfo.padInfo,outWidth=convInfo.outWidth,dilationWidth=convInfo.dilationWidth,dilationHeight=convInfo.dilationHeight,dataFormat=convInfo.dataFormat,left=padInfo.left,top=padInfo.top,itemsPerBlockRow=inChannels*filterWidth,glsl=glsl_version_1.getGlslDifferences(),isChannelsLast="channelsLast"===dataFormat,rowDim=isChannelsLast?0:1,colDim=isChannelsLast?1:2,unrolled="",row=0;row<=1;row++)for(var col=0;col<=1;col++)unrolled+="\n          blockIndex = rc.y + "+col+";\n          pos = rc.x + "+row+";\n\n          if(blockIndex < "+outputShape[1]+" && pos < "+outputShape[0]+") {\n            offsetY = int(blockIndex / ("+outWidth+")) * "+strideHeight+" - "+top+";\n            d0 = offsetY + "+dilationHeight+" * (pos / "+itemsPerBlockRow+");\n\n            if(d0 < "+inputShape[rowDim]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+outWidth+".) * "+strideWidth+". - "+left+".);\n              d1 = offsetX + "+dilationWidth+" * (int(mod(float(pos), "+itemsPerBlockRow+".) / "+inChannels+".));\n\n              if(d1 < "+inputShape[colDim]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+inChannels+".));\n\n                if ("+isChannelsLast+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+unrolled+"\n\n        "+glsl.output+" = result;\n      }\n    "};exports.Im2ColPackedProgram=Im2ColPackedProgram},{"./glsl_version":54}],59:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var fromPixels2DContext,environment_1=require("../../../environment"),kernel_names_1=require("../../../kernel_names"),tex_util_1=require("../tex_util"),from_pixels_gpu_1=require("./FromPixels_utils/from_pixels_gpu"),from_pixels_packed_gpu_1=require("./FromPixels_utils/from_pixels_packed_gpu");exports.fromPixelsConfig={kernelName:kernel_names_1.FromPixels,backendName:"webgl",kernelFunc:function(args){var inputs=args.inputs,backend=args.backend,attrs=args.attrs,pixels=inputs.pixels,numChannels=attrs.numChannels,isVideo="undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement,isImage="undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement,_a=isVideo?[pixels.videoWidth,pixels.videoHeight]:[pixels.width,pixels.height],width=_a[0],height=_a[1],texShape=[height,width],outShape=[height,width,numChannels];(isImage||isVideo)&&(null==fromPixels2DContext&&(fromPixels2DContext=document.createElement("canvas").getContext("2d")),fromPixels2DContext.canvas.width=width,fromPixels2DContext.canvas.height=height,fromPixels2DContext.drawImage(pixels,0,0,width,height),pixels=fromPixels2DContext.canvas);var tempPixelHandle=backend.makeTensorInfo(texShape,"int32");backend.texData.get(tempPixelHandle.dataId).usage=tex_util_1.TextureUsage.PIXELS,backend.gpgpu.uploadPixelDataToTexture(backend.getTexture(tempPixelHandle.dataId),pixels);var program=environment_1.env().getBool("WEBGL_PACK")?new from_pixels_packed_gpu_1.FromPixelsPackedProgram(outShape):new from_pixels_gpu_1.FromPixelsProgram(outShape),res=backend.runWebGLProgram(program,[tempPixelHandle],"int32");return backend.disposeData(tempPixelHandle.dataId),res}}},{"../../../environment":107,"../../../kernel_names":126,"../tex_util":94,"./FromPixels_utils/from_pixels_gpu":60,"./FromPixels_utils/from_pixels_packed_gpu":61}],60:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("../../glsl_version"),FromPixelsProgram=function(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+width+".0, "+height+".0);\n\n        vec4 values = "+glsl.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "};exports.FromPixelsProgram=FromPixelsProgram},{"../../glsl_version":54}],61:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("../../glsl_version"),FromPixelsPackedProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+width+".0, "+height+".0);\n            vec4 values = "+glsl.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+glsl.output+" = result;\n      }\n    "};exports.FromPixelsPackedProgram=FromPixelsPackedProgram},{"../../glsl_version":54}],62:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../../../kernel_names"),log_1=require("../../../log"),non_max_suppression_impl_1=require("../../non_max_suppression_impl");exports.nonMaxSuppressionV5Config={kernelName:kernel_names_1.NonMaxSuppressionV5,backendName:"webgl",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,attrs=_a.attrs;log_1.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var _b=inputs,boxes=_b.boxes,scores=_b.scores,_c=attrs,maxOutputSize=_c.maxOutputSize,iouThreshold=_c.iouThreshold,scoreThreshold=_c.scoreThreshold,softNmsSigma=_c.softNmsSigma,gpuBackend=backend,boxesVals=gpuBackend.readSync(boxes.dataId),scoresVals=gpuBackend.readSync(scores.dataId),maxOutputSizeVal=maxOutputSize,iouThresholdVal=iouThreshold,scoreThresholdVal=scoreThreshold,softNmsSigmaVal=softNmsSigma,_d=non_max_suppression_impl_1.nonMaxSuppressionV5(boxesVals,scoresVals,maxOutputSizeVal,iouThresholdVal,scoreThresholdVal,softNmsSigmaVal);return[_d.selectedIndices,_d.selectedScores]}}},{"../../../kernel_names":126,"../../../log":128,"../../non_max_suppression_impl":12}],63:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../../../kernel_names"),unaryop_gpu_1=require("../unaryop_gpu");exports.squareConfig={kernelName:kernel_names_1.Square,backendName:"webgl",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,x=inputs.x,webglBackend=backend,program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unaryop_gpu_1.SQUARE);return webglBackend.runWebGLProgram(program,[x],x.dtype)}}},{"../../../kernel_names":126,"../unaryop_gpu":99}],64:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../../environment"),kernel_names_1=require("../../../kernel_names"),binaryop_gpu_1=require("../binaryop_gpu"),binaryop_packed_gpu_1=require("../binaryop_packed_gpu");exports.squaredDifferenceConfig={kernelName:kernel_names_1.SquaredDifference,backendName:"webgl",kernelFunc:function(_a){var inputs=_a.inputs,backend=_a.backend,_b=inputs,a=_b.a,b=_b.b,webGLBackend=backend,program=environment_1.env().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram("return (a - b) * (a - b);",a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram("return (a - b) * (a - b);",a.shape,b.shape);return webGLBackend.compileAndRun(program,[a,b])}}},{"../../../environment":107,"../../../kernel_names":126,"../binaryop_gpu":26,"../binaryop_packed_gpu":27}],65:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var LRNProgram=function(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[];var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+rad+"; j <= "+rad+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+maxD+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+powOperator+";\n        setOutput(val);\n      }\n    "};exports.LRNProgram=LRNProgram},{}],66:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var LRNGradProgram=function(inputShape,depthRadius,bias,alpha,beta){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=inputShape,this.depth=inputShape[3],this.depthRadius=depthRadius,this.bias=bias,this.alpha=alpha,this.beta=beta,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+depthRadius+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+depthRadius+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+alpha+") * norm + float("+bias+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+alpha+")\n                * float("+beta+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+beta+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "};exports.LRNGradProgram=LRNGradProgram},{}],67:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var LRNPackedProgram=function(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+rad+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+rad+"; j <= "+rad+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+maxD+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+powOperator+";\n        setOutput(result);\n      }\n    "};exports.LRNPackedProgram=LRNPackedProgram},{}],68:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var MaxPool2DBackpropProgram=function(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n          wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+lastIndex+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+effectiveFilterWidth+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.MaxPool2DBackpropProgram=MaxPool2DBackpropProgram;var MaxPool3DBackpropProgram=function(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n           wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+lastIndex+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                  wR * "+effectiveFilterWidth+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "};exports.MaxPool3DBackpropProgram=MaxPool3DBackpropProgram},{}],69:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var MatMulPackedProgram=function(aShape,outputShape,transposeA,transposeB,addBias,activation,hasPreluActivation){void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivation&&(hasPreluActivation=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=outputShape;var sharedDim=transposeA?aShape[1]:aShape[2],sharedDimensionPacked=Math.ceil(sharedDim/2),aSample=transposeA?"i * 2, rc.y":"rc.y, i * 2",bSample=transposeB?"rc.z, i * 2":"i * 2, rc.z",aSwizzle=transposeA?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],bSwizzle=transposeB?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivation?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"vec4 activation(vec4 x) {\n          "+activation+"\n        }",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivation&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const float sharedDimension = "+sharedDimensionPacked+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+sharedDimensionPacked+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+aSample+");\n          vec4 b = getMatrixB(rc.x, "+bSample+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+aSwizzle[0]+" * "+bSwizzle[0]+");\n          result += ("+aSwizzle[1]+" * "+bSwizzle[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+addBiasSnippet+"\n\n        "+applyActivationSnippet+"\n\n        setOutput(result);\n      }\n    "};exports.MatMulPackedProgram=MatMulPackedProgram},{}],70:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var MultinomialProgram=function(){function MultinomialProgram(batchSize,numOutcomes,numSamples){this.variableNames=["probs"],this.outputShape=[batchSize,numSamples],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(numOutcomes-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(numOutcomes-1)+"));\n      }\n    "}return MultinomialProgram.prototype.getCustomSetupFunc=function(seed){var _this=this;return function(gpgpu,webGLProgram){null==_this.seedLoc&&(_this.seedLoc=gpgpu.getUniformLocation(webGLProgram,"seed")),gpgpu.gl.uniform1f(_this.seedLoc,seed)}},MultinomialProgram}();exports.MultinomialProgram=MultinomialProgram},{}],71:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var OneHotProgram=function(numIndices,depth,onValue,offValue){this.variableNames=["indices"],this.outputShape=[numIndices,depth],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+offValue+"), float("+onValue+"),\n                      float(index == coords.y)));\n      }\n    "};exports.OneHotProgram=OneHotProgram},{}],72:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),PackProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=outputShape;var rank=outputShape.length;if(0===rank)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),outOfBoundsCondition=function(rank,shape,dims){if(1===rank)return"rc > "+shape[0];for(var cond="",i=rank-2;i<rank;i++)cond+=dims[i]+" >= "+shape[i],i<rank-1&&(cond+="||");return cond}(rank,outputShape,channels),setup=function(rank,cols,rows,dims){if(1===rank)return"";var innerDims=dims.slice(-2);return"\n    int r = "+innerDims[0]+";\n    int c = "+innerDims[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+cols+";\n    bool rEdge = rp1 >= "+rows+";\n  "}(rank,outputShape[outputShape.length-1],outputShape[outputShape.length-2],channels),output=function(shape,dims){var rank=shape.length,sourceCoords=function(rank,dims){for(var coords=[],row=0;row<=1;row++)for(var col=0;col<=1;col++){for(var coord=(0===row?"r":"rp1")+", "+(0===col?"c":"cp1"),d=2;d<rank;d++)coord=dims[dims.length-1-d]+","+coord;coords.push(coord)}return coords}(rank,dims);return 1===rank?"getA(rc),\n            rc + 1 >= "+shape[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+sourceCoords[0]+"),\n          cEdge ? 0. : getA("+sourceCoords[1]+"),\n          rEdge ? 0. : getA("+sourceCoords[2]+"),\n          rEdge || cEdge ? 0. : getA("+sourceCoords[3]+")"}(outputShape,channels);this.userCode="\n        void main() {\n          "+dtype+" rc = getOutputCoords();\n\n          if("+outOfBoundsCondition+") {\n            setOutput(vec4(0));\n          } else {\n            "+setup+"\n\n            setOutput(vec4("+output+"));\n          }\n        }\n      "}};exports.PackProgram=PackProgram},{"../packing_util":13,"./shader_compiler":89}],73:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),PadProgram=function(xShape,paddings,constantValue){this.variableNames=["x"],this.outputShape=paddings.map((function(p,i){return p[0]+xShape[i]+p[1]}));var rank=xShape.length,type=shader_compiler_1.getCoordsDataType(rank),start=paddings.map((function(p){return p[0]})).join(","),end=paddings.map((function(p,i){return p[0]+xShape[i]})).join(","),unpackedCoords=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,rank);this.userCode=1!==rank?"\n      "+type+" start = "+type+"("+start+");\n      "+type+" end = "+type+"("+end+");\n\n      void main() {\n        "+type+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+constantValue+"));\n        } else {\n          "+type+" coords = outC - start;\n          setOutput(getX("+unpackedCoords+"));\n        }\n      }\n    ":"\n        int start = "+start+";\n        int end = "+end+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+constantValue+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "};exports.PadProgram=PadProgram},{"./shader_compiler":89}],74:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),PadPackedProgram=function(xShape,paddings,constantValue){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=paddings.map((function(p,i){return p[0]+xShape[i]+p[1]}));for(var rank=xShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),start=paddings.map((function(p){return p[0]})).join(","),end=paddings.map((function(p,i){return p[0]+xShape[i]})).join(","),coords=packing_util_1.getChannels("rc",rank),source=packing_util_1.getChannels("source",rank),cLimit=coords[rank-1]+" < "+this.outputShape[rank-1],innerDims=1===rank?"source":"vec2("+source.slice(-2).join()+")",componentSetup=[dtype+" rc = outputLoc;",coords[rank-1]+" += 1;\n       if("+cLimit+") {\n      ",1===rank?"":"}\n       rc = outputLoc;\n       "+coords[rank-2]+" += 1;\n       if("+coords[rank-2]+" < "+this.outputShape[rank-2]+") {",1===rank?"":"  "+coords[rank-1]+" += 1;\n         if("+cLimit+") {"],paddingArea=1===rank?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",mainLoop="",i=0,j=1===rank?2:4;i<j;i++)mainLoop+="\n        "+componentSetup[i]+"\n        if ("+paddingArea+") {\n          result["+i+"] = float("+constantValue+");\n        } else {\n          "+dtype+" source = rc - start;\n          result["+i+"] = getChannel(getX("+source.join()+"), "+innerDims+");\n        }\n      ";mainLoop+=1===rank?"} ":"}}",this.userCode="\n      const "+dtype+" start = "+dtype+"("+start+");\n      const "+dtype+" end = "+dtype+"("+end+");\n\n      void main() {\n        "+dtype+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+mainLoop+"\n        setOutput(result);\n      }\n    "};exports.PadPackedProgram=PadPackedProgram},{"../packing_util":13,"./shader_compiler":89}],75:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var Pool2DProgram=function(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n        const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+effectiveFilterWidth+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              getValue(batch, xR, xC + 3 * "+dilationWidth+", d)\n            );\n\n            "+updateSnippet+"\n          }\n\n          int xC = xCCorner + "+filterWidthNearestVec4+";\n          if ("+(1===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(2===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(3===filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          }\n        }\n        setOutput("+returnValue+");\n      }\n    "}};exports.Pool2DProgram=Pool2DProgram;var Pool3DProgram=function(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec3 strides =\n            ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n        const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+effectiveFilterDepth+";\n              wD += "+dilationDepth+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+effectiveFilterHeight+";\n                wR += "+dilationHeight+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+effectiveFilterWidth+";\n                  wC += "+dilationWidth+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                      wR * "+effectiveFilterWidth+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+dilationWidth+", ch)\n              );\n\n              "+updateSnippet+"\n            }\n\n            int xC = xCCorner + "+filterWidthNearestVec4+";\n            if ("+(1===filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(2===filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(3===filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            }\n          }\n          setOutput("+returnValue+");\n        }\n      }\n    "}};exports.Pool3DProgram=Pool3DProgram},{}],76:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ReduceProgram=function(reduceInfo,reduceType){this.variableNames=["x"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var initializationValue="0.0",compareOp="";"prod"===reduceType?initializationValue="1.0":"min"===reduceType?(initializationValue="1.0 / 1e-20",compareOp="min"):"max"===reduceType&&(initializationValue="-1.0 / 1e-20",compareOp="max");var returnValue=reduceType+"("+reduceType+"("+reduceType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===reduceType?returnValue="sumValue":"prod"===reduceType?returnValue="prodValue":"all"===reduceType?returnValue="allValue":"any"===reduceType&&(returnValue="anyValue");var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n      if ("+("sum"===reduceType)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===reduceType)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+compareOp+"(values, minMaxValue);\n      }\n    ",vecType="vec4";"all"===reduceType?(initializationValue="1.0",updateSnippet="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",vecType="bvec4"):"any"===reduceType&&(initializationValue="0.0",updateSnippet="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",vecType="bvec4");var checkOutOfBounds="";inSize%windowSize>0&&(checkOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+checkOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1===windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2===windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3===windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput("+returnValue+");\n      }\n    "};exports.ReduceProgram=ReduceProgram},{}],77:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});for(
/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var kernel_registry_1=require("../../kernel_registry"),FromPixels_1=require("./kernels/FromPixels"),NonMaxSuppressionV5_1=require("./kernels/NonMaxSuppressionV5"),Square_1=require("./kernels/Square"),SquaredDifference_1=require("./kernels/SquaredDifference"),_i=0,kernelConfigs_1=[FromPixels_1.fromPixelsConfig,NonMaxSuppressionV5_1.nonMaxSuppressionV5Config,Square_1.squareConfig,SquaredDifference_1.squaredDifferenceConfig];_i<kernelConfigs_1.length;_i++){var kernelConfig=kernelConfigs_1[_i];kernel_registry_1.registerKernel(kernelConfig)}},{"../../kernel_registry":127,"./kernels/FromPixels":59,"./kernels/NonMaxSuppressionV5":62,"./kernels/Square":63,"./kernels/SquaredDifference":64}],78:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_util=require("./shader_compiler_util"),ReshapePackedProgram=function(outputShape,inputShape){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=outputShape;for(var shape,mainLoop="",i=0;i<4;i++){var thisRC="thisRC = rc;";i%2==1&&(thisRC+="thisRC.z += 1;"),i>1&&(thisRC+="thisRC.y += 1;"),mainLoop+="\n        "+thisRC+"\n        "+(i>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+i+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(i>0?"}":"")+"\n      "}this.userCode="\n      "+(shape=inputShape,"\n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape)+"\n      return ivec3(r, c, d);\n    }\n  \n      ")+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+outputShape[1]+";\n        int cols = "+outputShape[2]+";\n\n        "+mainLoop+"\n\n        setOutput(result);\n      }\n    "};exports.ReshapePackedProgram=ReshapePackedProgram},{"./shader_compiler_util":90}],79:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ResizeBilinearBackpropProgram=function(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&yHeight>1?xHeight-1:xHeight,alignCorners&&yWidth>1?xWidth-1:xWidth],effectiveYSize=[alignCorners&&yHeight>1?yHeight-1:yHeight,alignCorners&&yWidth>1?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(xHeight-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(xWidth-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "};exports.ResizeBilinearBackpropProgram=ResizeBilinearBackpropProgram},{}],80:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ResizeBilinearProgram=function(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&newHeight>1?oldHeight-1:oldHeight,alignCorners&&newWidth>1?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&newHeight>1?newHeight-1:newHeight,alignCorners&&newWidth>1?newWidth-1:newWidth];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "};exports.ResizeBilinearProgram=ResizeBilinearProgram},{}],81:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ResizeBilinearPackedProgram=function(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&newHeight>1?oldHeight-1:oldHeight,alignCorners&&newWidth>1?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&newHeight>1?newHeight-1:newHeight,alignCorners&&newWidth>1?newWidth-1:newWidth];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec3 inputShapeRC = vec3("+oldHeight+".0, "+oldWidth+".0,\n                                     "+oldWidth+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(depth-1)+";\n        bool hasNextRow = coords.z < "+(newWidth-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "};exports.ResizeBilinearPackedProgram=ResizeBilinearPackedProgram},{}],82:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ResizeNearestNeigborBackpropProgram=function(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&yHeight>1?xHeight-1:xHeight,alignCorners&&yWidth>1?xWidth-1:xWidth],effectiveYSize=[alignCorners&&yHeight>1?yHeight-1:yHeight,alignCorners&&yWidth>1?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+effectiveXSize[0]+") *\n                (float(dyR) / float("+effectiveYSize[0]+"));\n\n            float sourceFracCol =\n                float("+effectiveXSize[1]+") *\n                  (float(dyC) / float("+effectiveYSize[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+xHeight+") - 1),\n                "+alignCorners+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+xWidth+") - 1),\n                "+alignCorners+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "};exports.ResizeNearestNeigborBackpropProgram=ResizeNearestNeigborBackpropProgram},{}],83:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var ResizeNearestNeighborProgram=function(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&newHeight>1?oldHeight-1:oldHeight,alignCorners&&newWidth>1?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&newHeight>1?newHeight-1:newHeight,alignCorners&&newWidth>1?newWidth-1:newWidth],roundBase=alignCorners?"0.5":"0.0";this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+roundBase+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "};exports.ResizeNearestNeighborProgram=ResizeNearestNeighborProgram},{}],84:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),ReverseProgram=function(xShape,axis){this.variableNames=["x"];var rank=xShape.length;if(rank>4)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");if(this.outputShape=xShape,1!==rank){var inCoords=xShape.map((function(_,i){return function(i){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - coords["+i+"] - 1":"coords["+i+"]"}(i)})).join(","),type=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+type+" coords = getOutputCoords();\n        setOutput(getX("+inCoords+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+xShape[0]+" - coord - 1));\n        }\n      "};exports.ReverseProgram=ReverseProgram},{"./shader_compiler":89}],85:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),ReversePackedProgram=function(xShape,axis){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var rank=xShape.length;if(rank>4)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");this.outputShape=xShape;var channels=packing_util_1.getChannels("rc",rank),nextColumn=channels[rank-1]+" + 1 < "+this.outputShape[rank-1],nextRow=channels[rank-2]+" + 1 < "+this.outputShape[rank-2],type=shader_compiler_1.getCoordsDataType(rank);function getChannel(channels){var inCoordsArray=xShape.map((function(_,i){return function(i,channels1){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - "+channels1[i]+" - 1":""+channels1[i]}(i,channels)}));return"getChannel(getX("+inCoordsArray.join(",")+"), vec2("+inCoordsArray.slice(-2).join(",")+"))"}this.userCode=1===rank?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+xShape[0]+" - rc - 1),\n            "+xShape[0]+" - rc - 1);\n          if("+nextColumn+"){\n              result.g = getChannel(getX("+xShape[0]+" - (rc  + 1) - 1),\n                "+xShape[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+type+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+function(channels){return getChannel(channels)}(channels.slice())+";\n          if("+nextColumn+"){\n            result.g = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",getChannel(channels)}(channels.slice())+";\n          }\n          if("+nextRow+") {\n            result.b = "+function(channels){return channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            if("+nextColumn+") {\n              result.a = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "};exports.ReversePackedProgram=ReversePackedProgram},{"../packing_util":13,"./shader_compiler":89}],86:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),ScatterProgram=function(updateSize,sliceDim,indicesRank,updatesRank,strides,shape,summingDupeIndex){void 0===summingDupeIndex&&(summingDupeIndex=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),indicesString="";1===indicesRank?indicesString="i":2===indicesRank&&(indicesString="i, j");var indicesSnippet="getIndices("+indicesString+")",updatesString="";1===updatesRank?updatesString="i":2===updatesRank&&(updatesString="i, coords[1]");var updatesSnippet="getUpdates("+updatesString+")",strideString=sliceDim>1?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+strides+");\n\n        void main() {\n          "+dtype+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+updateSize+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+sliceDim+"; j++) {\n              int index = round("+indicesSnippet+");\n              flattenedIndex += index * "+strideString+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+updatesSnippet+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "};exports.ScatterProgram=ScatterProgram},{"./shader_compiler":89}],87:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var SegmentOpProgram=function(segOpInfo,segOpType){this.variableNames=["x","segmentIds"];var windowSize=segOpInfo.windowSize,batchSize=segOpInfo.batchSize,inSize=segOpInfo.inSize,numSegments=segOpInfo.numSegments,outSize=numSegments*Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n        sumValue += dot(values, segFilter);\n    ",checkValueOutOfBounds="";inSize%windowSize>0&&(checkValueOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      ");var checkSegmentIdOutOfBounds="";inSize%windowSize>0&&(checkSegmentIdOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+checkValueOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+checkSegmentIdOutOfBounds+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+numSegments+")) * float("+windowSize+"));\n        int currentSeg = int(mod(float(outIdx), float("+numSegments+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1===windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2===windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3===windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput(sumValue);\n      }\n    "};exports.SegmentOpProgram=SegmentOpProgram},{}],88:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),SelectProgram=function(cRank,shape,rank){var cCoords,abCoords;if(this.variableNames=["c","a","b"],this.outputShape=shape,rank>4)throw Error("Where for rank "+rank+" is not yet supported");if(1===rank)abCoords="resRC",cCoords="resRC";else{for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],cCoordVars=[],abCoordVars=[],i=0;i<shape.length;i++)abCoordVars.push(""+currentCoords[i]),i<cRank&&cCoordVars.push(""+currentCoords[i]);cCoords=cCoordVars.join(),abCoords=abCoordVars.join()}var dtype=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        float cVal = getC("+cCoords+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+abCoords+"));\n        } else {\n          setOutput(getB("+abCoords+"));\n        }\n      }\n    "};exports.SelectProgram=SelectProgram},{"./shader_compiler":89}],89:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util_1=require("../../ops/broadcast_util"),util=require("../../util"),glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");function getSamplerFromInInfo(inInfo){var shape=inInfo.shapeInfo.logicalShape;switch(shape.length){case 0:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"float "+funcName+"() {return "+texName+";}";var _a=inputInfo.shapeInfo.texShape,texNumR=_a[0],texNumC=_a[1];if(1===texNumR&&1===texNumC)return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var _b=inputInfo.shapeInfo.texShape,tNumR=_b[0],tNumC=_b[1],offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"() {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int index) {\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,tNumR=texShape[0],tNumC=texShape[1];if(1===tNumC&&1===tNumR)return"\n      float "+funcName+"(int index) {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);if(1===tNumC)return"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+offset+") + 0.5) / "+tNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(1===tNumR)return"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2((float(index + "+offset+") + 0.5) / "+tNumC+".0, 0.5);\n        return sampleTexture("+texName+", uv);\n      }\n    ";return"\n    float "+funcName+"(int index) {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape;if(null!=texShape&&util.arraysEqual(shape,texShape)){var texNumR_1=texShape[0];return"\n    float "+funcName+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+texShape[1]+".0, "+texNumR_1+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  "}var _a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var params=["row","col"];return"\n      "+getSamplerFromInInfo(squeezeInputInfo(inputInfo,squeezedShape))+"\n      float "+funcName+"(int row, int col) {\n        return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+shape[1]+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texNumR=texShape[0],texNumC=texShape[1],offset=getFlatOffsetUniformName(texName);if(1===texNumC)return"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  ";if(1===texNumR)return"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+texNumC+".0, 0.5);\n      return sampleTexture("+texName+", uv);\n    }\n  ";return"\n  float "+funcName+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+shape[1]+" + col + "+offset+";\n    vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n    return sampleTexture("+texName+", uv);\n  }\n"}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride0=shape[1]*shape[2],stride1=shape[2],_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var params=["row","col","depth"];return"\n        "+getSamplerFromInInfo(squeezeInputInfo(inputInfo,squeezedShape))+"\n        float "+funcName+"(int row, int col, int depth) {\n          return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n        }\n      "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+stride0+", "+stride1+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],flatOffset=inputInfo.shapeInfo.flatOffset;if(texNumC===stride0&&null==flatOffset)return"\n        float "+funcName+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+stride1+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+texNumC+".0, "+texNumR+".0);\n          return sampleTexture("+texName+", uv);\n        }\n      ";if(texNumC===stride1&&null==flatOffset)return"\n    float "+funcName+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+shape[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  ";var offset=getFlatOffsetUniformName(texName);return"\n      float "+funcName+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+stride0+" + col * "+stride1+" + depth + "+offset+";\n        vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n        return sampleTexture("+texName+", uv);\n      }\n  "}(inInfo);case 4:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride2=shape[3],stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var params=["row","col","depth","depth2"];return"\n      "+getSamplerFromInInfo(squeezeInputInfo(inputInfo,newShape))+"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+stride0+", "+stride1+", "+stride2+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+stride1+", "+stride2+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride2&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+shape[1]*shape[2]+", "+shape[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" +\n          depth * "+stride2+" + depth2;\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 5:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride3=shape[4],stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var params=["row","col","depth","depth2","depth3"];return"\n      "+getSamplerFromInInfo(squeezeInputInfo(inputInfo,newShape))+"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          depth3;\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+stride1+", "+stride2+", "+stride3+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride3&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]+",\n               "+shape[2]*shape[3]+", "+shape[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 6:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var params=["row","col","depth","depth2","depth3","depth4"];return"\n      "+getSamplerFromInInfo(squeezeInputInfo(inputInfo,newShape))+"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n      }\n    "}var stride4=shape[5],stride3=shape[4]*stride4,stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1;if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+stride4+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+stride1+", "+stride2+", "+stride3+", "+stride4+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride4&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]*shape[4]+",\n               "+shape[2]*shape[3]*shape[4]+",\n               "+shape[3]*shape[4]+",\n               "+shape[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 * "+stride4+" + depth4 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);default:throw new Error(shape.length+"-D input sampling is not yet supported")}}function getPackedSamplerFromInInfo(inInfo){var texName,funcName,glsl;switch(inInfo.shapeInfo.logicalShape.length){case 0:return texName=inInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),glsl=glsl_version_1.getGlslDifferences(),"\n    vec4 "+funcName+"() {\n      return "+glsl.texture2D+"("+texName+", halfCR);\n    }\n  ";case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+packedTexShape[0]+", "+packedTexShape[1]+", index);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],glsl=glsl_version_1.getGlslDifferences();if(null!=texShape&&util.arraysEqual(shape,texShape))return"\n      vec4 "+funcName+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n\n        return "+glsl.texture2D+"("+texName+", uv);\n      }\n    ";var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],valuesPerRow=Math.ceil(shape[1]/2);return"\n    vec4 "+funcName+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+valuesPerRow+", "+packedTexShape[0]+", "+packedTexShape[1]+", row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(1===shape[0]){var keptDims=[1,2],params=["b","row","col"];return"\n        "+getPackedSamplerFromInInfo(squeezeInputInfo(inputInfo,shape.slice(1)))+"\n        vec4 "+funcName+"(int b, int row, int col) {\n          return "+funcName+"("+getSqueezedParams(params,keptDims)+");\n        }\n      "}var texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[2]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[1]/2),glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+texNumR+", "+texNumC+", "+texelsInBatch+", "+valuesPerRow+", b, row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);default:return function(inputInfo){for(var shape=inputInfo.shapeInfo.logicalShape,rank=shape.length,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[rank-1]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[rank-2]/2),params="int b, int row, int col",index="b * "+texelsInBatch+" + (row / 2) * "+valuesPerRow+" + (col / 2)",b=2;b<rank-1;b++)params="int b"+b+", "+params,index="b"+b+" * "+(texelsInBatch*=shape[rank-b-1])+" + "+index;var glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"("+params+") {\n      int index = "+index+";\n      int texR = index / "+texNumC+";\n      int texC = index - texR * "+texNumC+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+", "+texNumR+");\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo)}}exports.makeShader=function(inputsInfo,outputShape,userCode,usesPackedTextures){var prefixSnippets=[];inputsInfo.forEach((function(x){var size=util.sizeFromShape(x.shapeInfo.logicalShape);x.shapeInfo.isUniform?prefixSnippets.push("uniform float "+x.name+(size>1?"["+size+"]":"")+";"):(prefixSnippets.push("uniform sampler2D "+x.name+";"),prefixSnippets.push("uniform int offset"+x.name+";"))}));var outputSamplingSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet=prefixSnippets.join("\n"),inputSamplingSnippet=inputsInfo.map((function(x){return function(inInfo,outShapeInfo,usesPackedTextures){void 0===usesPackedTextures&&(usesPackedTextures=!1);var res="";res+=usesPackedTextures?getPackedSamplerFromInInfo(inInfo):getSamplerFromInInfo(inInfo);var inShape=inInfo.shapeInfo.logicalShape,outShape=outShapeInfo.logicalShape;inShape.length<=outShape.length&&(res+=usesPackedTextures?function(inputInfo,outShapeInfo){var coordsSnippet,texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length,broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),type=getCoordsDataType(outRank),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&broadcastDims.length>=1?"coords = 0;":broadcastDims.map((function(d){return"coords."+fields[d+rankDiff]+" = 0;"})).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&inRank>0?"coords":inputInfo.shapeInfo.logicalShape.map((function(s,i){return"coords."+fields[i+rankDiff]})).join(", ");var output="return outputValue;",isInputScalar=1===util.sizeFromShape(inputInfo.shapeInfo.logicalShape),isOutputScalar=1===util.sizeFromShape(outShapeInfo.logicalShape);if(1!==inRank||isInputScalar||isOutputScalar){if(isInputScalar&&!isOutputScalar)output=1===outRank?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(broadcastDims.length){var rows=inRank-2,cols=inRank-1;broadcastDims.indexOf(rows)>-1&&broadcastDims.indexOf(cols)>-1?output="return vec4(outputValue.x);":broadcastDims.indexOf(rows)>-1?output="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":broadcastDims.indexOf(cols)>-1&&(output="return vec4(outputValue.xx, outputValue.zz);")}}else output="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      vec4 outputValue = get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n      "+output+"\n    }\n  "}(inInfo,outShapeInfo):function(inputInfo,outShapeInfo){var texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",outTexShape=outShapeInfo.texShape,inTexShape=inputInfo.shapeInfo.texShape,inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length;if(!inputInfo.shapeInfo.isUniform&&inRank===outRank&&null==inputInfo.shapeInfo.flatOffset&&util.arraysEqual(inTexShape,outTexShape))return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", resultUV);\n      }\n    ";var coordsSnippet,type=getCoordsDataType(outRank),broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&broadcastDims.length>=1?"coords = 0;":broadcastDims.map((function(d){return"coords."+fields[d+rankDiff]+" = 0;"})).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&inRank>0?"coords":inputInfo.shapeInfo.logicalShape.map((function(s,i){return"coords."+fields[i+rankDiff]})).join(", ");return"\n    float "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      return get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n    }\n  "}(inInfo,outShapeInfo));return res}(x,outputShape,usesPackedTextures)})).join("\n"),outTexShape=outputShape.texShape,glsl=glsl_version_1.getGlslDifferences(),floatTextureSampleSnippet=function(glsl){return"\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+glsl.texture2D+"(textureSampler, uv).r;\n    }\n  "}(glsl),shaderPrefix=function(glsl){return glsl.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+glsl.varyingFs+" vec2 resultUV;\n    "+glsl.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+glsl.defineSpecialNaN+"\n    "+glsl.defineSpecialInf+"\n    "+glsl.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+SAMPLE_1D_SNIPPET+"\n    "+SAMPLE_2D_SNIPPET+"\n    "+SAMPLE_3D_SNIPPET+"\n  "}(glsl);return outputShape.isPacked?(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(1===packedTexShape[0])return"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+packedTexShape[1]+".0);\n      }\n    ";if(1===packedTexShape[1])return"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+packedTexShape[0]+".0);\n      }\n    ";return"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      return 2 * (resTexRC.x * "+packedTexShape[1]+" + resTexRC.y);\n    }\n  "}(0,outTexShape);case 2:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      }\n    ";var texelsInLogicalRow=Math.ceil(shape[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(outShape,outTexShape);case 3:return shape=outShape,texShape=outTexShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[2]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(shape,texShape){for(var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[shape.length-1]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[shape.length-2]/2),texelsInBatchN=texelsInBatch,batches="",coords="b, r, c",b=2;b<shape.length-1;b++)batches="\n      int b"+b+" = index / "+(texelsInBatchN*=shape[shape.length-b-1])+";\n      index -= b"+b+" * "+texelsInBatchN+";\n    "+batches,coords="b"+b+", "+coords;return"\n    ivec"+shape.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      "+batches+"\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec"+shape.length+"("+coords+");\n    }\n  "}(outShape,outTexShape)}var shape,texShape,packedTexShape,texelsInLogicalRow,texelsInBatch}(outputShape.logicalShape,outTexShape),floatTextureSetOutputSnippet=function(glsl){return"\n    void setOutput(vec4 val) {\n      "+glsl.output+" = val;\n    }\n  "}(glsl)):(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){if(1===texShape[0])return"\n      int getOutputCoords() {\n        return int(resultUV.x * "+texShape[1]+".0);\n      }\n    ";if(1===texShape[1])return"\n      int getOutputCoords() {\n        return int(resultUV.y * "+texShape[0]+".0);\n      }\n    ";return"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      return resTexRC.x * "+texShape[1]+" + resTexRC.y;\n    }\n  "}(0,outTexShape);case 2:return function(shape,texShape){if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+texShape[0]+", "+texShape[1]+"));\n      }\n    ";if(1===shape[1])return"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ";if(1===shape[0])return"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ";return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      int r = index / "+shape[1]+";\n      int c = index - r * "+shape[1]+";\n      return ivec2(r, c);\n    }\n  "}(outShape,outTexShape);case 3:return shape=outShape,texShape=outTexShape,coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2"],shape);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(outShape,outTexShape);case 5:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3"],shape);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+texShape[0]+",\n                             "+texShape[1]+"));\n\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(outShape,outTexShape);case 6:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3","d4"],shape);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(outShape,outTexShape);default:throw new Error(outShape.length+"-D output sampling is not yet supported")}var shape,texShape,coordsFromIndexSnippet}(outputShape.logicalShape,outTexShape),floatTextureSetOutputSnippet=function(glsl){return"\n    void setOutput(float val) {\n      "+glsl.output+" = vec4(val, 0, 0, 0);\n    }\n  "}(glsl)),usesPackedTextures&&(shaderPrefix+=SHADER_PACKED_PREFIX),[shaderPrefix,floatTextureSampleSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet,outputSamplingSnippet,inputSamplingSnippet,userCode].join("\n")};var SAMPLE_1D_SNIPPET="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_2D_SNIPPET="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_3D_SNIPPET="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SHADER_PACKED_PREFIX="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function getFlatOffsetUniformName(texName){return"offset"+texName}function getUniformSampler(inputInfo){var texName=inputInfo.name,inSize=util.sizeFromShape(inputInfo.shapeInfo.logicalShape);return inSize<2?"return "+texName+";":"\n    for (int i = 0; i < "+inSize+"; i++) {\n      if (i == index) {\n        return "+texName+"[i];\n      }\n    }\n  "}function getCoordsDataType(rank){if(rank<=1)return"int";if(2===rank)return"ivec2";if(3===rank)return"ivec3";if(4===rank)return"ivec4";if(5===rank)return"ivec5";if(6===rank)return"ivec6";throw Error("GPU for rank "+rank+" is not yet supported")}function squeezeInputInfo(inInfo,squeezedShape){var newInputInfo=JSON.parse(JSON.stringify(inInfo));return newInputInfo.shapeInfo.logicalShape=squeezedShape,newInputInfo}function getSqueezedParams(params,keptDims){return keptDims.map((function(d){return params[d]})).join(", ")}exports.getCoordsDataType=getCoordsDataType},{"../../ops/broadcast_util":136,"../../util":214,"./glsl_version":54,"./shader_compiler_util":90}],90:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util");function buildVec(x){return 1===x.length?""+x[0]:"vec"+x.length+"("+x.join(",")+")"}exports.getLogicalCoordinatesFromFlatIndex=function(coords,shape,index){void 0===index&&(index="index");var strides=util.computeStrides(shape);return strides.map((function(stride,i){return"int "+coords[i]+" = "+index+" / "+stride+"; "+(i===strides.length-1?"int "+coords[i+1]+" = "+index+" - "+coords[i]+" * "+stride:"index -= "+coords[i]+" * "+stride)+";"})).join("")},exports.dotify=function(x,y){if(x.length!==y.length)throw new Error("Vectors to be dotted must be of the same length -got "+x.length+" and "+y.length);for(var slices=[],nearestVec4=Math.floor(x.length/4),nearestVec4Remainder=x.length%4,i=0;i<nearestVec4;i++){var xSlice=x.slice(4*i,4*i+4),ySlice=y.slice(4*i,4*i+4);slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}if(0!==nearestVec4Remainder){xSlice=x.slice(4*nearestVec4),ySlice=y.slice(4*nearestVec4);1===xSlice.length&&(xSlice=xSlice.map((function(d){return"float("+d+")"})),ySlice=ySlice.map((function(d){return"float("+d+")"}))),slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}return slices.map((function(d,i){return"dot("+d+")"})).join("+")},exports.getFlatIndexFrom3D=function(shape){var strides=util.computeStrides(shape).map((function(d){return d.toString()}));return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+strides[0]+" + coords.y * "+strides[1]+" + coords.z;\n  }\n"},exports.ENCODE_FLOAT_SNIPPET="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n"},{"../../util":214}],91:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),SliceProgram=function(){function SliceProgram(destSize){this.variableNames=["source"],this.outputShape=destSize,this.rank=destSize.length;var body,dtype=shader_compiler_1.getCoordsDataType(this.rank),uniformPart="uniform int start["+this.rank+"];",sourceCoords=function(rank){if(1===rank)return"sourceLoc";if(rank<=6)return coords.slice(0,rank).map((function(x){return"sourceLoc."+x})).join(",");throw Error("Slicing for rank "+rank+" is not yet supported")}(this.rank);body="\n        "+dtype+" sourceLoc;\n        "+dtype+" coords = getOutputCoords();\n        "+destSize.map((function(_,i){return"sourceLoc."+coords[i]+" = start["+i+"] + coords."+coords[i]+";"})).join("\n")+"\n      ",this.userCode="\n      "+uniformPart+"\n      void main() {\n        "+body+"\n        setOutput(getSource("+sourceCoords+"));\n      }\n    "}return SliceProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SliceProgram}();exports.SliceProgram=SliceProgram;var coords=["x","y","z","w","u","v"]},{"./shader_compiler":89}],92:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),SlicePackedProgram=function(){function SlicePackedProgram(destSize){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=destSize,this.rank=destSize.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),coords=packing_util_1.getChannels("coords",this.rank),sourceLoc=packing_util_1.getChannels("sourceLoc",this.rank),innerDims=1===this.rank?"sourceLoc":"vec2("+sourceLoc.slice(-2).join()+")",getChannel="getChannel(getSource("+sourceLoc.join()+"), "+innerDims+")",upperRow="\n      result.x = "+getChannel+";\n      if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n        ++"+sourceLoc[this.rank-1]+";\n        result.y = "+getChannel+";\n        --"+sourceLoc[this.rank-1]+";\n      }\n    ",lowerRow=1===this.rank?"":"\n      --"+coords[this.rank-1]+";\n      if (++"+coords[this.rank-2]+" < "+destSize[this.rank-2]+") {\n        ++"+sourceLoc[this.rank-2]+";\n        result.z = "+getChannel+";\n        if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n          ++"+sourceLoc[this.rank-1]+";\n          result.w = "+getChannel+";\n        }\n      }\n    ",sourceLocSetup=this.rank<=4?"sourceLoc = coords +\n            "+dtype+"("+destSize.map((function(_,i){return"start["+i+"]"})).join()+");":destSize.map((function(_,i){return sourceLoc[i]+" = "+coords[i]+" + start["+i+"];"})).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        "+dtype+" sourceLoc;\n        "+sourceLocSetup+"\n        vec4 result = vec4(0.);\n        "+upperRow+"\n        "+lowerRow+"\n        setOutput(result);\n      }\n    "}return SlicePackedProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SlicePackedProgram}();exports.SlicePackedProgram=SlicePackedProgram},{"../packing_util":13,"./shader_compiler":89}],93:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),StridedSliceProgram=function(begin,strides,size){this.variableNames=["x"],this.outputShape=size;var rank=size.length,inputDtype=shader_compiler_1.getCoordsDataType(size.length),dtype=shader_compiler_1.getCoordsDataType(size.length),newCoords="";if(1===rank)newCoords="coords * strides + begin";else{var outputAxis_1=0;newCoords=size.map((function(_,i){return outputAxis_1++,1===size.length?"coords * strides["+i+"] + begin["+i+"]":"coords["+(outputAxis_1-1)+"] * strides["+i+"] + begin["+i+"]"})).join(",")}this.userCode="\n      "+inputDtype+" begin = "+inputDtype+"("+begin+");\n      "+inputDtype+" strides = "+inputDtype+"("+strides+");\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        setOutput(getX("+newCoords+"));\n      }\n    "};exports.StridedSliceProgram=StridedSliceProgram},{"./shader_compiler":89}],94:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util");function getPackedMatrixTextureShapeWidthHeight(rows,columns){return[Math.max(1,Math.ceil(columns/2)),Math.max(1,Math.ceil(rows/2))]}!function(PackingScheme){PackingScheme[PackingScheme.DENSE=0]="DENSE",PackingScheme[PackingScheme.SHARED_BATCH=1]="SHARED_BATCH"}(exports.PackingScheme||(exports.PackingScheme={})),function(TextureUsage){TextureUsage[TextureUsage.RENDER=0]="RENDER",TextureUsage[TextureUsage.UPLOAD=1]="UPLOAD",TextureUsage[TextureUsage.PIXELS=2]="PIXELS",TextureUsage[TextureUsage.DOWNLOAD=3]="DOWNLOAD"}(exports.TextureUsage||(exports.TextureUsage={})),function(PhysicalTextureType){PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(exports.PhysicalTextureType||(exports.PhysicalTextureType={})),exports.getUnpackedMatrixTextureShapeWidthHeight=function(rows,columns){return[columns,rows]},exports.getUnpackedArraySizeFromMatrixSize=function(matrixSize,channelsPerTexture){return matrixSize*channelsPerTexture},exports.getColorMatrixTextureShapeWidthHeight=function(rows,columns){return[4*columns,rows]},exports.getDenseTexShape=function(shape){var size=util.sizeFromShape(shape),texelsNeeded=Math.ceil(size/4);return util.sizeToSquarishShape(texelsNeeded)},exports.getMatrixSizeFromUnpackedArraySize=function(unpackedSize,channelsPerTexture){if(unpackedSize%channelsPerTexture!=0)throw new Error("unpackedSize ("+unpackedSize+") must be a multiple of "+channelsPerTexture);return unpackedSize/channelsPerTexture},exports.decodeMatrixFromUnpackedColorRGBAArray=function(unpackedArray,matrix,channels){var requiredSize=unpackedArray.length*channels/4;if(matrix.length<requiredSize)throw new Error("matrix length ("+matrix.length+") must be >= "+requiredSize);for(var dst=0,src=0;src<unpackedArray.length;src+=4)for(var c=0;c<channels;c++)matrix[dst++]=unpackedArray[src+c]},exports.getPackedMatrixTextureShapeWidthHeight=getPackedMatrixTextureShapeWidthHeight,exports.getPackedRGBAArraySizeFromMatrixShape=function(rows,columns){var _a=getPackedMatrixTextureShapeWidthHeight(rows,columns);return _a[0]*_a[1]*4},exports.getTextureConfig=function(gl,textureHalfFloatExtension){var internalFormatFloat,internalFormatHalfFloat,internalFormatPackedHalfFloat,internalFormatPackedFloat,textureFormatFloat,downloadUnpackNumChannels,defaultNumChannels,textureTypeHalfFloat,textureTypeFloat,glany=gl;return 2===environment_1.env().getNumber("WEBGL_VERSION")?(internalFormatFloat=glany.R32F,internalFormatHalfFloat=glany.R16F,internalFormatPackedHalfFloat=glany.RGBA16F,internalFormatPackedFloat=glany.RGBA32F,textureFormatFloat=glany.RED,downloadUnpackNumChannels=4,defaultNumChannels=1,textureTypeHalfFloat=glany.HALF_FLOAT,textureTypeFloat=glany.FLOAT):(internalFormatFloat=gl.RGBA,internalFormatHalfFloat=gl.RGBA,internalFormatPackedHalfFloat=gl.RGBA,internalFormatPackedFloat=glany.RGBA,textureFormatFloat=gl.RGBA,downloadUnpackNumChannels=4,defaultNumChannels=4,textureTypeHalfFloat=null!=textureHalfFloatExtension?textureHalfFloatExtension.HALF_FLOAT_OES:null,textureTypeFloat=gl.FLOAT),{internalFormatFloat:internalFormatFloat,internalFormatHalfFloat:internalFormatHalfFloat,internalFormatPackedHalfFloat:internalFormatPackedHalfFloat,internalFormatPackedFloat:internalFormatPackedFloat,textureFormatFloat:textureFormatFloat,downloadTextureFormat:gl.RGBA,downloadUnpackNumChannels:downloadUnpackNumChannels,defaultNumChannels:defaultNumChannels,textureTypeHalfFloat:textureTypeHalfFloat,textureTypeFloat:textureTypeFloat}}},{"../../environment":107,"../../util":214}],95:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),tex_util_1=require("./tex_util"),TextureManager=function(){function TextureManager(gpgpu){this.gpgpu=gpgpu,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return TextureManager.prototype.acquireTexture=function(shapeRC,usage,isPacked){var newTexture,physicalTexType=getPhysicalFromLogicalTextureType(usage,isPacked),shapeKey=getKeyFromTextureShape(shapeRC,physicalTexType,isPacked);if(shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),shapeKey in this.usedTextures||(this.usedTextures[shapeKey]=[]),this.freeTextures[shapeKey].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var newTexture_1=this.freeTextures[shapeKey].shift();return this.usedTextures[shapeKey].push(newTexture_1),newTexture_1}return this.numUsedTextures++,this.log(),physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32?newTexture=this.gpgpu.createPackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16?newTexture=this.gpgpu.createFloat16PackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32?newTexture=this.gpgpu.createFloat32MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16?newTexture=this.gpgpu.createFloat16MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE&&(newTexture=this.gpgpu.createUnsignedBytesMatrixTexture(shapeRC[0],shapeRC[1])),this.usedTextures[shapeKey].push(newTexture),newTexture},TextureManager.prototype.releaseTexture=function(texture,shape,logicalTexType,isPacked){if(null!=this.freeTextures){var shapeKey=getKeyFromTextureShape(shape,getPhysicalFromLogicalTextureType(logicalTexType,isPacked),isPacked);shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),this.freeTextures[shapeKey].push(texture),this.numFreeTextures++,this.numUsedTextures--;var texList=this.usedTextures[shapeKey],texIndex=texList.indexOf(texture);if(texIndex<0)throw new Error("Cannot release a texture that was never provided by this texture manager");texList.splice(texIndex,1),this.log()}},TextureManager.prototype.log=function(){if(this.logEnabled){var total=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+total+")")}},TextureManager.prototype.getNumUsedTextures=function(){return this.numUsedTextures},TextureManager.prototype.getNumFreeTextures=function(){return this.numFreeTextures},TextureManager.prototype.dispose=function(){var _this=this;if(null!=this.freeTextures){for(var texShape in this.freeTextures)this.freeTextures[texShape].forEach((function(tex){_this.gpgpu.deleteMatrixTexture(tex)}));for(var texShape in this.usedTextures)this.usedTextures[texShape].forEach((function(tex){_this.gpgpu.deleteMatrixTexture(tex)}));this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},TextureManager}();function getPhysicalFromLogicalTextureType(logicalTexType,isPacked){if(logicalTexType===tex_util_1.TextureUsage.UPLOAD)return tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32;if(logicalTexType===tex_util_1.TextureUsage.RENDER||null==logicalTexType)return function(isPacked){return environment_1.env().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?isPacked?tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32:tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32:isPacked?tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16:tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16}(isPacked);if(logicalTexType===tex_util_1.TextureUsage.DOWNLOAD||logicalTexType===tex_util_1.TextureUsage.PIXELS)return tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+logicalTexType)}function getKeyFromTextureShape(shapeRowsCol,physicalTexType,isPacked){return shapeRowsCol[0]+"_"+shapeRowsCol[1]+"_"+physicalTexType+"_"+isPacked}exports.TextureManager=TextureManager},{"../../environment":107,"./tex_util":94}],96:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),TileProgram=function(aShape,reps){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[i]*reps[i];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape){var rank=aShape.length;if(rank>5)throw Error("Tile for rank "+rank+" is not yet supported");if(1===rank)return"imod(resRC, "+aShape[0]+")";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],sourceCoords=[],i=0;i<aShape.length;i++)sourceCoords.push("imod("+currentCoords[i]+", "+aShape[i]+")");return sourceCoords.join()}(aShape);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "};exports.TileProgram=TileProgram},{"./shader_compiler":89}],97:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),TransposeProgram=function(aShape,newDim){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),switched=function(newDim){var rank=newDim.length;if(rank>6)throw Error("Transpose for rank "+rank+" is not yet supported");for(var originalOrder=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],switchedCoords=new Array(rank),i=0;i<newDim.length;i++)switchedCoords[newDim[i]]=originalOrder[i];return switchedCoords.join()}(newDim);this.userCode="\n    void main() {\n      "+dtype+" resRC = getOutputCoords();\n      setOutput(getA("+switched+"));\n    }\n    "};exports.TransposeProgram=TransposeProgram},{"./shader_compiler":89}],98:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),TransposePackedProgram=function(aShape,newDim){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];if(this.outputShape=outputShape,this.rank=outputShape.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var dtype=shader_compiler_1.getCoordsDataType(this.rank),outputOrder=packing_util_1.getVecChannels("rc",this.rank),switchedOrder=new Array(this.rank);for(i=0;i<newDim.length;i++)switchedOrder[newDim[i]]=outputOrder[i];var innerDims="vec2("+switchedOrder.slice(-2).join()+")",nextColumn="++"+outputOrder[this.rank-1]+" < "+outputShape[this.rank-1],getc="getChannel(getA("+switchedOrder.join()+"), "+innerDims+")";this.userCode="\n    void main() {\n      "+dtype+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+getc+";\n      if("+nextColumn+") {\n        result[1] = "+getc+";\n      }\n      --"+outputOrder[this.rank-1]+";\n      if(++"+outputOrder[this.rank-2]+" < "+outputShape[this.rank-2]+") {\n        result[2] = "+getc+";\n        if("+nextColumn+") {\n          result[3] = "+getc+";\n        }\n      }\n      setOutput(result);\n    }\n    "};exports.TransposePackedProgram=TransposePackedProgram},{"../packing_util":13,"./shader_compiler":89}],99:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var erf_util=require("../../ops/erf_util"),selu_util=require("../../ops/selu_util"),UnaryOpProgram=function(aShape,opSnippet){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      float unaryOperation(float x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "};exports.UnaryOpProgram=UnaryOpProgram;var CHECK_NAN_SNIPPET="if (isnan(x)) return x;";exports.LINEAR="return x;",exports.ABS="return abs(x);",exports.RELU=CHECK_NAN_SNIPPET+"\n  return (x < 0.0) ? 0.0 : x;\n",exports.RELU6=CHECK_NAN_SNIPPET+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",exports.ELU="return (x >= 0.0) ? x : (exp(x) - 1.0);",exports.SELU="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+selu_util.SELU_SCALEALPHA+";\n  float scale = "+selu_util.SELU_SCALE+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",exports.STEP=function(alpha){return void 0===alpha&&(alpha=0),CHECK_NAN_SNIPPET+"\n    return x > 0.0 ? 1.0 : float("+alpha+");\n  "},exports.NEG="return -x;",exports.CEIL="return ceil(x);",exports.FLOOR="return floor(x);",exports.SIGN="\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n",exports.IS_NAN="return float(isnan(x));",exports.IS_INF="return float(isinf(x));",exports.IS_FINITE="return float(!isnan(x) && !isinf(x));",exports.ROUND="\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n",exports.EXP="return exp(x);",exports.EXPM1="return exp(x) - 1.0;",exports.LOG="if (x < 0.0) return NAN;\n  return log(x);",exports.LOG1P="return log(1.0 + x);",exports.SQRT="return sqrt(x);",exports.RSQRT="return inversesqrt(x);",exports.SIGMOID="return 1.0 / (1.0 + exp(-1.0 * x));",exports.SOFTPLUS="\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n",exports.SIN=CHECK_NAN_SNIPPET+"\n  return sin(x);\n",exports.COS=CHECK_NAN_SNIPPET+"\n  return cos(x);\n",exports.TAN="return tan(x);",exports.ASIN=CHECK_NAN_SNIPPET+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n",exports.ACOS=CHECK_NAN_SNIPPET+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n",exports.ATAN=CHECK_NAN_SNIPPET+"\n  return atan(x);\n",exports.SINH="\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n",exports.COSH="\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n",exports.TANH="\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n",exports.ASINH=CHECK_NAN_SNIPPET+"return log(x + sqrt(x * x + 1.0));",exports.ACOSH=CHECK_NAN_SNIPPET+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",exports.ATANH=CHECK_NAN_SNIPPET+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",exports.ERF='\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = '+erf_util.ERF_P+";\n  float a1 = "+erf_util.ERF_A1+";\n  float a2 = "+erf_util.ERF_A2+";\n  float a3 = "+erf_util.ERF_A3+";\n  float a4 = "+erf_util.ERF_A4+";\n  float a5 = "+erf_util.ERF_A5+";\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n",exports.SQUARE="return x * x;",exports.RECIPROCAL="return 1.0 / x;",exports.LOGICAL_NOT="return float(!(x >= 1.0));",exports.TO_INT="return float(int(x));",exports.CLONE="return x;"},{"../../ops/erf_util":148,"../../ops/selu_util":175}],100:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.LINEAR="return x;",exports.LOG="\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",exports.RELU="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",exports.RELU6="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",exports.ELU="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n";var UnaryOpPackedProgram=function(aShape,opSnippet){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=aShape,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "};exports.UnaryOpPackedProgram=UnaryOpPackedProgram},{}],101:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),UnpackProgram=function(outputShape){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=outputShape;var rank=outputShape.length,channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),sourceCoords=packing_util_1.getSourceCoords(rank,channels),innerDims=channels.slice(-2),coords=rank<=1?"rc":"vec2("+innerDims.join(",")+")";this.userCode="\n      void main() {\n        "+dtype+" rc = getOutputCoords();\n        vec4 packedInput = getA("+sourceCoords+");\n\n        setOutput(getChannel(packedInput, "+coords+"));\n      }\n    "};exports.UnpackProgram=UnpackProgram},{"../packing_util":13,"./shader_compiler":89}],102:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),tex_util_1=require("./tex_util");function callAndCheck(gl,debugMode,func){var returnValue=func();return debugMode&&function(gl){var error=gl.getError();if(error!==gl.NO_ERROR)throw new Error("WebGL Error: "+getWebGLErrorMessage(gl,error))}(gl),returnValue}exports.callAndCheck=callAndCheck;function getWebGLErrorMessage(gl,status){switch(status){case gl.NO_ERROR:return"NO_ERROR";case gl.INVALID_ENUM:return"INVALID_ENUM";case gl.INVALID_VALUE:return"INVALID_VALUE";case gl.INVALID_OPERATION:return"INVALID_OPERATION";case gl.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case gl.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case gl.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+status}}exports.canBeRepresented=function(num){return!!(environment_1.env().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===num||5.96e-8<Math.abs(num)&&Math.abs(num)<65504)},exports.getWebGLErrorMessage=getWebGLErrorMessage,exports.getExtensionOrThrow=function(gl,debug,extensionName){return throwIfNull(gl,debug,(function(){return gl.getExtension(extensionName)}),'Extension "'+extensionName+'" not supported on this browser.')},exports.createVertexShader=function(gl,debug,vertexShaderSource){var vertexShader=throwIfNull(gl,debug,(function(){return gl.createShader(gl.VERTEX_SHADER)}),"Unable to create vertex WebGLShader.");if(callAndCheck(gl,debug,(function(){return gl.shaderSource(vertexShader,vertexShaderSource)})),callAndCheck(gl,debug,(function(){return gl.compileShader(vertexShader)})),!1===gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw console.log(gl.getShaderInfoLog(vertexShader)),new Error("Failed to compile vertex shader.");return vertexShader},exports.createFragmentShader=function(gl,debug,fragmentShaderSource){var fragmentShader=throwIfNull(gl,debug,(function(){return gl.createShader(gl.FRAGMENT_SHADER)}),"Unable to create fragment WebGLShader.");if(callAndCheck(gl,debug,(function(){return gl.shaderSource(fragmentShader,fragmentShaderSource)})),callAndCheck(gl,debug,(function(){return gl.compileShader(fragmentShader)})),!1===gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw function(shaderSource,shaderInfoLog){var lineNumberRegexResult=lineNumberRegex.exec(shaderInfoLog);if(null==lineNumberRegexResult)return console.log("Couldn't parse line number in error: "+shaderInfoLog),void console.log(shaderSource);for(var lineNumber=+lineNumberRegexResult[1],shaderLines=shaderSource.split("\n"),pad=shaderLines.length.toString().length+2,linesWithLineNumbers=shaderLines.map((function(line,lineNumber){return util.rightPad((lineNumber+1).toString(),pad)+line})),maxLineLength=0,i=0;i<linesWithLineNumbers.length;i++)maxLineLength=Math.max(linesWithLineNumbers[i].length,maxLineLength);var beforeErrorLines=linesWithLineNumbers.slice(0,lineNumber-1),errorLine=linesWithLineNumbers.slice(lineNumber-1,lineNumber),afterErrorLines=linesWithLineNumbers.slice(lineNumber);console.log(beforeErrorLines.join("\n")),console.log(shaderInfoLog.split("\n")[0]),console.log("%c "+util.rightPad(errorLine[0],maxLineLength),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(afterErrorLines.join("\n"))}(fragmentShaderSource,gl.getShaderInfoLog(fragmentShader)),new Error("Failed to compile fragment shader.");return fragmentShader};var MAX_TEXTURE_SIZE,MAX_TEXTURES_IN_SHADER,lineNumberRegex=/ERROR: [0-9]+:([0-9]+):/g;function bindTextureUnit(gl,debug,texture,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,(function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)})),callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}))}function getFramebufferErrorMessage(gl,status){switch(status){case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case gl.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+status}}function throwIfNull(gl,debug,returnTOrNull,failureMessage){var tOrNull=callAndCheck(gl,debug,(function(){return returnTOrNull()}));if(null==tOrNull)throw new Error(failureMessage);return tOrNull}function validateTextureUnit(gl,textureUnit){var maxTextureUnit=gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,glTextureUnit=textureUnit+gl.TEXTURE0;if(glTextureUnit<gl.TEXTURE0||glTextureUnit>maxTextureUnit)throw new Error("textureUnit must be in "+("[gl.TEXTURE0, gl.TEXTURE"+maxTextureUnit+"]")+".")}function getBatchDim(shape,dimsToSkip){return void 0===dimsToSkip&&(dimsToSkip=2),util.sizeFromShape(shape.slice(0,shape.length-dimsToSkip))}function getRowsCols(shape){if(0===shape.length)throw Error("Cannot get rows and columns of an empty shape array.");return[shape.length>1?shape[shape.length-2]:1,shape[shape.length-1]]}function isEven(n){return n%2==0}function hasExtension(gl,extensionName){return null!=gl.getExtension(extensionName)}function createFloatTextureAndBindToFramebuffer(gl){var texConfig=tex_util_1.getTextureConfig(gl),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatFloat,1,1,0,texConfig.textureFormatFloat,texConfig.textureTypeFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}exports.createProgram=function(gl,debug){return throwIfNull(gl,debug,(function(){return gl.createProgram()}),"Unable to create WebGLProgram.")},exports.linkProgram=function(gl,debug,program){if(callAndCheck(gl,debug,(function(){return gl.linkProgram(program)})),!1===gl.getProgramParameter(program,gl.LINK_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Failed to link vertex and fragment shaders.")},exports.validateProgram=function(gl,debug,program){if(callAndCheck(gl,debug,(function(){return gl.validateProgram(program)})),!1===gl.getProgramParameter(program,gl.VALIDATE_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Shader program validation failed.")},exports.createStaticVertexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,(function(){return gl.createBuffer()}),"Unable to create WebGLBuffer");return callAndCheck(gl,debug,(function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)})),callAndCheck(gl,debug,(function(){return gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW)})),buffer},exports.createStaticIndexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,(function(){return gl.createBuffer()}),"Unable to create WebGLBuffer");return callAndCheck(gl,debug,(function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer)})),callAndCheck(gl,debug,(function(){return gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,gl.STATIC_DRAW)})),buffer},exports.getNumChannels=function(){return 2===environment_1.env().getNumber("WEBGL_VERSION")?1:4},exports.createTexture=function(gl,debug){return throwIfNull(gl,debug,(function(){return gl.createTexture()}),"Unable to create WebGLTexture.")},exports.validateTextureSize=function(width,height){var maxTextureSize=environment_1.env().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(width<=0||height<=0){var requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" is invalid.")}if(width>maxTextureSize||height>maxTextureSize){requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" greater than WebGL maximum on this browser / GPU "+("["+maxTextureSize+"x"+maxTextureSize+"]")+".")}},exports.createFramebuffer=function(gl,debug){return throwIfNull(gl,debug,(function(){return gl.createFramebuffer()}),"Unable to create WebGLFramebuffer.")},exports.bindVertexBufferToProgramAttribute=function(gl,debug,program,attribute,buffer,arrayEntriesPerItem,itemStrideInBytes,itemOffsetInBytes){var loc=gl.getAttribLocation(program,attribute);return-1!==loc&&(callAndCheck(gl,debug,(function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)})),callAndCheck(gl,debug,(function(){return gl.vertexAttribPointer(loc,arrayEntriesPerItem,gl.FLOAT,!1,itemStrideInBytes,itemOffsetInBytes)})),callAndCheck(gl,debug,(function(){return gl.enableVertexAttribArray(loc)})),!0)},exports.bindTextureUnit=bindTextureUnit,exports.unbindTextureUnit=function(gl,debug,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,(function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)})),callAndCheck(gl,debug,(function(){return gl.bindTexture(gl.TEXTURE_2D,null)}))},exports.getProgramUniformLocationOrThrow=function(gl,debug,program,uniformName){return throwIfNull(gl,debug,(function(){return gl.getUniformLocation(program,uniformName)}),'uniform "'+uniformName+'" not present in program.')},exports.getProgramUniformLocation=function(gl,program,uniformName){return gl.getUniformLocation(program,uniformName)},exports.bindTextureToProgramUniformSampler=function(gl,debug,program,texture,uniformSamplerLocation,textureUnit){callAndCheck(gl,debug,(function(){return bindTextureUnit(gl,debug,texture,textureUnit)})),callAndCheck(gl,debug,(function(){return gl.uniform1i(uniformSamplerLocation,textureUnit)}))},exports.bindCanvasToFramebuffer=function(gl,debug){callAndCheck(gl,debug,(function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)})),callAndCheck(gl,debug,(function(){return gl.viewport(0,0,gl.canvas.width,gl.canvas.height)})),callAndCheck(gl,debug,(function(){return gl.scissor(0,0,gl.canvas.width,gl.canvas.height)}))},exports.bindColorTextureToFramebuffer=function(gl,debug,texture,framebuffer){callAndCheck(gl,debug,(function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)})),callAndCheck(gl,debug,(function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0)}))},exports.unbindColorTextureFromFramebuffer=function(gl,debug,framebuffer){callAndCheck(gl,debug,(function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)})),callAndCheck(gl,debug,(function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,null,0)}))},exports.validateFramebuffer=function(gl){var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+getFramebufferErrorMessage(gl,status))},exports.getFramebufferErrorMessage=getFramebufferErrorMessage,exports.getBatchDim=getBatchDim,exports.getRowsCols=getRowsCols,exports.getShapeAs3D=function(shape){var shapeAs3D=[1,1,1];return 0===shape.length||1===shape.length&&1===shape[0]||(shapeAs3D=[getBatchDim(shape)].concat(getRowsCols(shape))),shapeAs3D},exports.getTextureShapeFromLogicalShape=function(logShape,isPacked){var _a;void 0===isPacked&&(isPacked=!1);var maxTexSize=environment_1.env().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(isPacked&&(maxTexSize*=2,1===(logShape=logShape.map((function(d,i){return i>=logShape.length-2?util.nearestLargerEven(logShape[i]):logShape[i]}))).length&&(logShape=[2,logShape[0]])),2!==logShape.length){var squeezeResult=util.squeezeShape(logShape);logShape=squeezeResult.newShape}var size=util.sizeFromShape(logShape);if(logShape.length<=1&&size<=maxTexSize)return[1,size];if(2===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]<=maxTexSize)return logShape;if(3===logShape.length&&logShape[0]*logShape[1]<=maxTexSize&&logShape[2]<=maxTexSize)return[logShape[0]*logShape[1],logShape[2]];if(3===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]];if(4===logShape.length&&logShape[0]*logShape[1]*logShape[2]<=maxTexSize&&logShape[3]<=maxTexSize)return[logShape[0]*logShape[1]*logShape[2],logShape[3]];if(4===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]*logShape[3]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]*logShape[3]];if(isPacked){var batchDim=getBatchDim(logShape),rows=2,cols=2;return logShape.length&&(rows=(_a=getRowsCols(logShape))[0],cols=_a[1]),size=batchDim*(rows/2)*(cols/2),util.sizeToSquarishShape(size).map((function(d){return 2*d}))}return util.sizeToSquarishShape(size)},exports.isReshapeFree=function(shape1,shape2){if(shape1=shape1.slice(-2),shape2=shape2.slice(-2),util.arraysEqual(shape1,shape2))return!0;if(!shape1.length||!shape2.length)return!0;if(0===shape1[0]||0===shape1[1]||0===shape2[0]||0===shape2[1])return!0;if(shape1.length!==shape2.length){var shape1Cols=shape1.slice(-1)[0],shape2Cols=shape2.slice(-1)[0];if(shape1Cols===shape2Cols)return!0;if(isEven(shape1Cols)&&isEven(shape2Cols)&&(1===shape1[0]||1===shape2[0]))return!0}return shape1[1]===shape2[1]&&isEven(shape1[0])&&isEven(shape2[0])},exports.getWebGLMaxTextureSize=function(webGLVersion){if(null==MAX_TEXTURE_SIZE){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURE_SIZE=gl.getParameter(gl.MAX_TEXTURE_SIZE)}return MAX_TEXTURE_SIZE},exports.resetMaxTextureSize=function(){MAX_TEXTURE_SIZE=null},exports.resetMaxTexturesInShader=function(){MAX_TEXTURES_IN_SHADER=null},exports.getMaxTexturesInShader=function(webGLVersion){if(null==MAX_TEXTURES_IN_SHADER){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURES_IN_SHADER=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,MAX_TEXTURES_IN_SHADER)},exports.getWebGLDisjointQueryTimerVersion=function(webGLVersion){if(0===webGLVersion)return 0;var gl=canvas_util_1.getWebGLContext(webGLVersion);return hasExtension(gl,"EXT_disjoint_timer_query_webgl2")&&2===webGLVersion?2:hasExtension(gl,"EXT_disjoint_timer_query")?1:0},exports.hasExtension=hasExtension,exports.isWebGLVersionEnabled=function(webGLVersion){try{if(null!=canvas_util_1.getWebGLContext(webGLVersion))return!0}catch(e){return!1}return!1},exports.isCapableOfRenderingToFloatTexture=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1===webGLVersion){if(!hasExtension(gl,"OES_texture_float"))return!1}else if(!hasExtension(gl,"EXT_color_buffer_float"))return!1;return createFloatTextureAndBindToFramebuffer(gl)},exports.isDownloadFloatTextureEnabled=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1!==webGLVersion){if(hasExtension(gl,"EXT_color_buffer_float"))return createFloatTextureAndBindToFramebuffer(gl);if(hasExtension(gl,"EXT_color_buffer_half_float")){var textureHalfFloatExtension=gl.getExtension("EXT_color_buffer_half_float");return function(gl,textureHalfFloatExtension){var texConfig=tex_util_1.getTextureConfig(gl,textureHalfFloatExtension),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);var width=1,height=1;gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatHalfFloat,width,height,0,texConfig.textureFormatFloat,texConfig.textureTypeHalfFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}(gl,textureHalfFloatExtension)}return!1}return!!hasExtension(gl,"OES_texture_float")&&(!!hasExtension(gl,"WEBGL_color_buffer_float")&&createFloatTextureAndBindToFramebuffer(gl))},exports.isWebGLFenceEnabled=function(webGLVersion){return 2===webGLVersion&&null!=canvas_util_1.getWebGLContext(webGLVersion).fenceSync}},{"../../environment":107,"../../util":214,"./canvas_util":28,"./tex_util":94}],103:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.whereImpl=function(condShape,condVals){for(var indices=[],i=0;i<condVals.length;i++)condVals[i]&&indices.push(i);var inBuffer=array_ops_1.buffer(condShape,"int32"),out=array_ops_1.buffer([indices.length,condShape.length],"int32");for(i=0;i<indices.length;i++){var loc=inBuffer.indexToLoc(indices[i]),offset=i*condShape.length;out.values.set(loc,offset)}return out.toTensor()}},{"../ops/array_ops":130}],104:[function(require,module,exports){(function(setImmediate){(function(){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var delayCallback="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:void 0!==setImmediate?setImmediate:function(f){return f()};exports.nextFrame=function(){return new Promise((function(resolve){return delayCallback((function(){return resolve()}))}))}}).call(this)}).call(this,require("timers").setImmediate)},{timers:405}],105:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.isMobile=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))},exports.isBrowser=function(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}},{}],106:[function(require,module,exports){(function(process,global){(function(){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var GLOBAL,environment_1=require("./environment"),kernel_registry_1=require("./kernel_registry"),profiler_1=require("./profiler"),tape_1=require("./tape"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util"),util=require("./util"),util_1=require("./util"),EngineState=function(){function EngineState(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return EngineState.prototype.dispose=function(){for(var variableName in this.registeredVariables)this.registeredVariables[variableName].dispose()},EngineState}(),Engine=function(){function Engine(ENV){this.ENV=ENV,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new EngineState}return Engine.prototype.ready=function(){return __awaiter(this,void 0,void 0,(function(){var sortedBackends,i,backendName;return __generator(this,(function(_a){switch(_a.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then((function(){}))];if(null!=this.backendInstance)return[2];sortedBackends=this.getSortedBackends(),i=0,_a.label=1;case 1:return i<sortedBackends.length?(backendName=sortedBackends[i],[4,this.initializeBackend(backendName).success]):[3,5];case 2:return _a.sent()?[4,this.setBackend(backendName)]:[3,4];case 3:return _a.sent(),[2];case 4:return i++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}}))}))},Object.defineProperty(Engine.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var _a=this.initializeBackendsAndReturnBest(),name_1=_a.name;if(_a.asyncInit)throw new Error("The highest priority backend '"+name_1+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(name_1)}return this.backendInstance},enumerable:!0,configurable:!0}),Engine.prototype.backendNames=function(){return Object.keys(this.registryFactory)},Engine.prototype.findBackend=function(backendName){if(!(backendName in this.registry)){if(!(backendName in this.registryFactory))return null;if(this.initializeBackend(backendName).asyncInit)return null}return this.registry[backendName]},Engine.prototype.findBackendFactory=function(backendName){return backendName in this.registryFactory?this.registryFactory[backendName].factory:null},Engine.prototype.registerBackend=function(backendName,factory,priority){return void 0===priority&&(priority=1),backendName in this.registryFactory?(console.warn(backendName+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[backendName]={factory:factory,priority:priority},!0)},Engine.prototype.setBackend=function(backendName){return __awaiter(this,void 0,void 0,(function(){var _a,success,_b;return __generator(this,(function(_c){switch(_c.label){case 0:if(null==this.registryFactory[backendName])throw new Error("Backend name '"+backendName+"' not found in registry");return this.backendName=backendName,null!=this.registry[backendName]?[3,4]:(this.backendInstance=null,_a=this.initializeBackend(backendName),success=_a.success,_a.asyncInit?[4,success]:[3,2]);case 1:return _b=_c.sent(),[3,3];case 2:_b=success,_c.label=3;case 3:if(!_b)return[2,!1];_c.label=4;case 4:return this.backendInstance=this.registry[backendName],this.setupRegisteredKernels(),this.profiler=new profiler_1.Profiler(this.backendInstance),[2,!0]}}))}))},Engine.prototype.setupRegisteredKernels=function(){var _this=this;kernel_registry_1.getKernelsForBackend(this.backendName).forEach((function(kernel){null!=kernel.setupFunc&&kernel.setupFunc(_this.backendInstance)}))},Engine.prototype.disposeRegisteredKernels=function(backendName){var _this=this;kernel_registry_1.getKernelsForBackend(backendName).forEach((function(kernel){null!=kernel.disposeFunc&&kernel.disposeFunc(_this.registry[backendName])}))},Engine.prototype.initializeBackend=function(backendName){var _this=this,registryFactoryEntry=this.registryFactory[backendName];if(null==registryFactoryEntry)throw new Error("Cannot initialize backend "+backendName+", no registration found.");try{var backend=registryFactoryEntry.factory();if(Promise.resolve(backend)===backend){var promiseId_1=++this.pendingBackendInitId,success=backend.then((function(backendInstance){return!(promiseId_1<_this.pendingBackendInitId)&&(_this.registry[backendName]=backendInstance,_this.pendingBackendInit=null,!0)})).catch((function(err){return promiseId_1<_this.pendingBackendInitId||(_this.pendingBackendInit=null,console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message)),!1}));return this.pendingBackendInit=success,{success:success,asyncInit:!0}}return this.registry[backendName]=backend,{success:!0,asyncInit:!1}}catch(err){return console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message),{success:!1,asyncInit:!1}}},Engine.prototype.removeBackend=function(backendName){if(!(backendName in this.registryFactory))throw new Error(backendName+" backend not found in registry");this.backendName===backendName&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,backendName in this.registry&&(this.disposeRegisteredKernels(backendName),this.registry[backendName].dispose(),delete this.registry[backendName]),delete this.registryFactory[backendName],this.backendName===backendName&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},Engine.prototype.getSortedBackends=function(){var _this=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort((function(a,b){return _this.registryFactory[b].priority-_this.registryFactory[a].priority}))},Engine.prototype.initializeBackendsAndReturnBest=function(){for(var sortedBackends=this.getSortedBackends(),i=0;i<sortedBackends.length;i++){var backendName=sortedBackends[i],_a=this.initializeBackend(backendName),success=_a.success,asyncInit=_a.asyncInit;if(asyncInit||success)return{name:backendName,asyncInit:asyncInit}}throw new Error("Could not initialize any backends, all backend initializations failed.")},Engine.prototype.moveData=function(destBackend,dataId){var info=this.state.tensorInfo.get(dataId),srcBackend=info.backend,values=this.readSync(dataId);srcBackend.disposeData(dataId),info.backend=destBackend,destBackend.move(dataId,values,info.shape,info.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},Engine.prototype.tidy=function(nameOrFn,fn){var result,_this=this,name=null;if(null==fn){if("function"!=typeof nameOrFn)throw new Error("Please provide a function to tidy()");fn=nameOrFn}else{if("string"!=typeof nameOrFn&&!(nameOrFn instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof fn)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");name=nameOrFn}return this.scopedRun((function(){return _this.startScope(name)}),(function(){return _this.endScope(result)}),(function(){return(result=fn())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),result}))},Engine.prototype.scopedRun=function(start,end,f){start();try{var res=f();return end(),res}catch(ex){throw end(),ex}},Engine.prototype.nextTensorId=function(){return Engine.nextTensorId++},Engine.prototype.nextVariableId=function(){return Engine.nextVariableId++},Engine.prototype.clone=function(x){var y=this.makeTensorFromDataId(x.dataId,x.shape,x.dtype),inputs={x:x};return this.addTapeNode(this.state.activeScope.name,inputs,[y],(function(dy){return{x:function(){return dy.toFloat()}}}),[]),y},Engine.prototype.runKernel=function(kernelName,inputs,attrs,inputsToSave,outputsToSave){return this.runKernelFunc(null,inputs,null,kernelName,attrs,inputsToSave,outputsToSave)},Engine.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},Engine.prototype.checkKernelForMemLeak=function(kernelName,numDataIdsBefore,outInfos){var numDataIdsAfter=this.backend.numDataIds(),numOutputDataIds=0;outInfos.forEach((function(info){numOutputDataIds+="complex64"===info.dtype?3:1}));var numMoves=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],dataIdsLeaked=numDataIdsAfter-numDataIdsBefore-numOutputDataIds-numMoves;if(dataIdsLeaked>0)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+dataIdsLeaked+" data ids) after running '"+kernelName+"'")},Engine.prototype.runKernelFunc=function(forwardFunc,inputs,backwardsFunc,kernelName,attrs,inputsToSave,outputsToSave){var outputs,_this=this;void 0===inputsToSave&&(inputsToSave=[]),void 0===outputsToSave&&(outputsToSave=[]);var saved=[],isTapeOn=this.isTapeOn();null==kernelName&&(kernelName=null!=this.state.activeScope?this.state.activeScope.name:"");var kernelFunc,saveFunc=function(tensors){isTapeOn&&(saved=tensors.map((function(tensor){return _this.keep(_this.clone(tensor))})))},startingBytecount=this.state.numBytes,startingNumTensors=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var out,kernel=kernel_registry_1.getKernel(kernelName,this.backendName);return kernelFunc=null!=kernel?function(){var numDataIdsBefore=_this.backend.numDataIds();out=kernel.kernelFunc({inputs:inputs,attrs:attrs,backend:_this.backend});var outInfos=Array.isArray(out)?out:[out];_this.shouldCheckForMemLeaks()&&_this.checkKernelForMemLeak(kernelName,numDataIdsBefore,outInfos);var outTensors=outInfos.map((function(_a){var dataId=_a.dataId,shape=_a.shape,dtype=_a.dtype;return _this.makeTensorFromDataId(dataId,shape,dtype)})),outsToSave=outTensors.filter((function(_,i){return outputsToSave[i]}));return saveFunc((inputsToSave||[]).slice().concat(outsToSave)),outTensors}:function(){var numDataIdsBefore=_this.backend.numDataIds();out=_this.tidy((function(){return forwardFunc(_this.backend,saveFunc)}));var outs=Array.isArray(out)?out:[out];return _this.shouldCheckForMemLeaks()&&_this.checkKernelForMemLeak(kernelName,numDataIdsBefore,outs),outs},this.scopedRun((function(){return _this.state.kernelDepth++}),(function(){return _this.state.kernelDepth--}),(function(){outputs=_this.ENV.getBool("DEBUG")?_this.profiler.profileKernel(kernelName,inputs,(function(){return kernelFunc()})):kernelFunc()})),isTapeOn&&this.addTapeNode(kernelName,inputs,outputs,backwardsFunc,saved),this.state.profiling&&this.state.activeProfile.kernels.push({name:kernelName,bytesAdded:this.state.numBytes-startingBytecount,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-startingNumTensors,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(inputs).map((function(key){return inputs[key].shape})),outputShapes:outputs.map((function(item){return item.shape}))}),Array.isArray(out)?outputs:outputs[0]},Engine.prototype.makeTensor=function(values,shape,dtype,backend){if(null==values)throw new Error("Values passed to engine.makeTensor() are null");dtype=dtype||"float32",backend=backend||this.backend;var backendVals=values;"string"===dtype&&util.isString(values[0])&&(backendVals=values.map((function(d){return util.encodeString(d)})));var dataId=backend.write(backendVals,shape,dtype),t=new tensor_1.Tensor(shape,dtype,dataId,this.nextTensorId());if(this.incRef(t,backend),"string"===dtype){var info=this.state.tensorInfo.get(dataId),newBytes=util_1.bytesFromStringArray(backendVals);this.state.numBytes+=newBytes-info.bytes,info.bytes=newBytes}return t},Engine.prototype.makeTensorFromDataId=function(dataId,shape,dtype,backend){dtype=dtype||"float32";var t=new tensor_1.Tensor(shape,dtype,dataId,this.nextTensorId());return this.incRef(t,backend),t},Engine.prototype.makeVariable=function(initialValue,trainable,name,dtype){void 0===trainable&&(trainable=!0),name=name||this.nextVariableId().toString(),null!=dtype&&dtype!==initialValue.dtype&&(initialValue=initialValue.asType(dtype));var v=new tensor_1.Variable(initialValue,trainable,name,this.nextTensorId());if(null!=this.state.registeredVariables[v.name])throw new Error("Variable with name "+v.name+" was already registered");return this.state.registeredVariables[v.name]=v,this.incRef(v,this.backend),v},Engine.prototype.incRef=function(a,backend){var refCount=this.state.tensorInfo.has(a.dataId)?this.state.tensorInfo.get(a.dataId).refCount:0;if(this.state.numTensors++,"string"===a.dtype&&this.state.numStringTensors++,0===refCount){this.state.numDataBuffers++;var bytes=0;"complex64"!==a.dtype&&"string"!==a.dtype&&(bytes=a.size*util.bytesPerElement(a.dtype)),this.state.tensorInfo.set(a.dataId,{backend:backend||this.backend,dtype:a.dtype,shape:a.shape,bytes:bytes,refCount:0}),this.state.numBytes+=bytes}this.state.tensorInfo.get(a.dataId).refCount++,a instanceof tensor_1.Variable||this.track(a)},Engine.prototype.disposeTensor=function(a){if(this.state.tensorInfo.has(a.dataId)){this.state.numTensors--,"string"===a.dtype&&this.state.numStringTensors--;var info=this.state.tensorInfo.get(a.dataId);info.refCount<=1?("complex64"!==a.dtype&&(this.state.numBytes-=info.bytes),this.state.numDataBuffers--,info.backend.disposeData(a.dataId),this.state.tensorInfo.delete(a.dataId)):this.state.tensorInfo.get(a.dataId).refCount--}},Engine.prototype.disposeVariables=function(){for(var varName in this.state.registeredVariables){var v=this.state.registeredVariables[varName];this.disposeVariable(v)}},Engine.prototype.disposeVariable=function(v){this.disposeTensor(v),null!=this.state.registeredVariables[v.name]&&delete this.state.registeredVariables[v.name]},Engine.prototype.memory=function(){var info=this.backend.memory();return info.numTensors=this.state.numTensors,info.numDataBuffers=this.state.numDataBuffers,info.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(info.unreliable=!0,null==info.reasons&&(info.reasons=[]),info.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),info},Engine.prototype.profile=function(query){return __awaiter(this,void 0,void 0,(function(){var startBytes,startNumTensors;return __generator(this,(function(_a){return this.state.profiling=!0,startBytes=this.state.numBytes,startNumTensors=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=query(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map((function(d){return d.totalBytesSnapshot}))),this.state.activeProfile.newBytes=this.state.numBytes-startBytes,this.state.activeProfile.newTensors=this.state.numTensors-startNumTensors,[2,this.state.activeProfile]}))}))},Engine.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&0===this.state.kernelDepth},Engine.prototype.addTapeNode=function(kernelName,inputs,outputs,gradientsFunc,saved){var _this=this,tapeNode={id:this.state.nextTapeNodeId++,kernelName:kernelName,inputs:inputs,outputs:outputs,saved:saved},gradConfig=kernel_registry_1.getGradient(kernelName);null!=gradConfig&&(gradientsFunc=gradConfig.gradFunc),null!=gradientsFunc&&(tapeNode.gradient=function(dys){return dys=dys.map((function(dy,i){if(null==dy){var output=outputs[i],vals=util.makeZerosTypedArray(output.size,output.dtype);return _this.makeTensor(vals,output.shape,output.dtype)}return dy})),gradientsFunc(dys.length>1?dys:dys[0],saved)}),this.state.activeTape.push(tapeNode)},Engine.prototype.keep=function(result){return result.kept=!0,result},Engine.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},Engine.prototype.endTape=function(){this.state.gradientDepth--},Engine.prototype.startScope=function(name){var scopeInfo={track:[],name:"unnamed scope",id:this.state.nextScopeId++};name&&(scopeInfo.name=name),this.state.scopeStack.push(scopeInfo),this.state.activeScope=scopeInfo},Engine.prototype.endScope=function(result){for(var _this=this,tensorsToTrackInParent=tensor_util_1.getTensorsInContainer(result),tensorsToTrackInParentSet=new Set(tensorsToTrackInParent.map((function(t){return t.id}))),i=0;i<this.state.activeScope.track.length;i++){var tensor=this.state.activeScope.track[i];tensor.kept||tensorsToTrackInParentSet.has(tensor.id)||tensor.dispose()}var oldScope=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],tensorsToTrackInParent.forEach((function(tensor){tensor.kept||tensor.scopeId!==oldScope.id||_this.track(tensor)}))},Engine.prototype.gradients=function(f,xs,dy,allowNoGradients){var _this=this;if(void 0===allowNoGradients&&(allowNoGradients=!1),util.assert(xs.length>0,(function(){return"gradients() received an empty list of xs."})),null!=dy&&"float32"!==dy.dtype)throw new Error("dy must have 'float32' dtype, but has '"+dy.dtype+"'");var y=this.scopedRun((function(){return _this.startTape()}),(function(){return _this.endTape()}),(function(){return _this.tidy("forward",f)}));util.assert(y instanceof tensor_1.Tensor,(function(){return"The result y returned by f() must be a tensor."}));var filteredTape=tape_1.getFilteredNodesXToY(this.state.activeTape,xs,y);if(!allowNoGradients&&0===filteredTape.length&&xs.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",(function(){var shape,values,accumulatedGradientMap={};accumulatedGradientMap[y.id]=null==dy?(shape=y.shape,values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),"float32"),exports.ENGINE.makeTensor(values,shape,"float32")):dy,tape_1.backpropagateGradients(accumulatedGradientMap,filteredTape,(function(f){return _this.tidy(f)}));var grads=xs.map((function(x){return accumulatedGradientMap[x.id]}));return 0===_this.state.gradientDepth&&(_this.state.activeTape.forEach((function(node){for(var _i=0,_a=node.saved;_i<_a.length;_i++){_a[_i].dispose()}})),_this.state.activeTape=null),{value:y,grads:grads}}))},Engine.prototype.customGrad=function(f){var _this=this;return util.assert(util.isFunction(f),(function(){return"The f passed in customGrad(f) must be a function."})),function(){for(var res,inputs=[],_i=0;_i<arguments.length;_i++)inputs[_i]=arguments[_i];util.assert(inputs.every((function(t){return t instanceof tensor_1.Tensor})),(function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"}));var inputMap={};return inputs.forEach((function(input,i){inputMap[i]=input})),_this.runKernelFunc((function(_,save){return res=f.apply(void 0,inputs.concat([save])),util.assert(res.value instanceof tensor_1.Tensor,(function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"})),util.assert(util.isFunction(res.gradFunc),(function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."})),res.value}),inputMap,(function(dy,saved){var gradRes=res.gradFunc(dy,saved),grads=Array.isArray(gradRes)?gradRes:[gradRes];util.assert(grads.length===inputs.length,(function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."})),util.assert(grads.every((function(t){return t instanceof tensor_1.Tensor})),(function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."}));var gradMap={};return grads.forEach((function(grad,i){gradMap[i]=function(){return grad}})),gradMap}))}},Engine.prototype.readSync=function(dataId){return this.state.tensorInfo.get(dataId).backend.readSync(dataId)},Engine.prototype.read=function(dataId){return this.state.tensorInfo.get(dataId).backend.read(dataId)},Engine.prototype.time=function(query){return __awaiter(this,void 0,void 0,(function(){var start,timingInfo;return __generator(this,(function(_a){switch(_a.label){case 0:return start=util_1.now(),[4,this.backend.time(query)];case 1:return(timingInfo=_a.sent()).wallMs=util_1.now()-start,[2,timingInfo]}}))}))},Engine.prototype.track=function(result){return null!=this.state.activeScope&&(result.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(result)),result},Object.defineProperty(Engine.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),Engine.prototype.reset=function(){for(var backendName in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new EngineState,this.registry)this.disposeRegisteredKernels(backendName),this.registry[backendName].dispose(),delete this.registry[backendName];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},Engine.nextTensorId=0,Engine.nextVariableId=0,Engine}();exports.Engine=Engine,exports.ENGINE=function(){var ns=function(){if(null==GLOBAL){var ns=void 0;if("undefined"!=typeof window)ns=window;else if(void 0!==global)ns=global;else if(void 0!==process)ns=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");ns=self}GLOBAL=ns}return GLOBAL}();if(null==ns._tfengine){var environment=new environment_1.Environment(ns);ns._tfengine=new Engine(environment)}return environment_1.setEnvironmentGlobal(ns._tfengine.ENV),tensor_1.setTensorTracker((function(){return ns._tfengine})),ns._tfengine}()}).call(this)}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./environment":107,"./kernel_registry":127,"./profiler":201,"./tape":206,"./tensor":207,"./tensor_util":209,"./util":214,_process:396}],107:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var Environment=function(){function Environment(global){this.global=global,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return Environment.prototype.setPlatform=function(platformName,platform){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+platform+"."),this.platformName=platformName,this.platform=platform},Environment.prototype.registerFlag=function(flagName,evaluationFn,setHook){if(this.flagRegistry[flagName]={evaluationFn:evaluationFn,setHook:setHook},null!=this.urlFlags[flagName]){var flagValue=this.urlFlags[flagName];console.warn("Setting feature override from URL "+flagName+": "+flagValue+"."),this.set(flagName,flagValue)}},Environment.prototype.get=function(flagName){return flagName in this.flags||(this.flags[flagName]=this.evaluateFlag(flagName)),this.flags[flagName]},Environment.prototype.getNumber=function(flagName){return this.get(flagName)},Environment.prototype.getBool=function(flagName){return this.get(flagName)},Environment.prototype.getFlags=function(){return this.flags},Object.defineProperty(Environment.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),Environment.prototype.set=function(flagName,value){if(null==this.flagRegistry[flagName])throw new Error("Cannot set flag "+flagName+" as it has not been registered.");this.flags[flagName]=value,null!=this.flagRegistry[flagName].setHook&&this.flagRegistry[flagName].setHook(value)},Environment.prototype.evaluateFlag=function(flagName){if(null==this.flagRegistry[flagName])throw new Error("Cannot evaluate flag '"+flagName+"': no evaluation function found.");return this.flagRegistry[flagName].evaluationFn()},Environment.prototype.setFlags=function(flags){this.flags=Object.assign({},flags)},Environment.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},Environment.prototype.populateURLFlags=function(){var _this=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var urlParams=getQueryParams(this.global.location.search);if("tfjsflags"in urlParams)urlParams.tfjsflags.split(",").forEach((function(keyValue){var _a=keyValue.split(":"),key=_a[0],value=_a[1];_this.urlFlags[key]=function(flagName,value){if("true"===(value=value.toLowerCase())||"false"===value)return"true"===value;if(""+ +value===value)return+value;throw new Error("Could not parse value flag value "+value+" for flag "+flagName+".")}(key,value)}))}},Environment}();function getQueryParams(queryString){var params={};return queryString.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,(function(s){for(var t=[],_i=1;_i<arguments.length;_i++)t[_i-1]=arguments[_i];return decodeParam(params,t[0],t[1]),t.join("=")})),params}function decodeParam(params,name,value){params[decodeURIComponent(name)]=decodeURIComponent(value||"")}exports.Environment=Environment,exports.getQueryParams=getQueryParams,exports.env=function(){return exports.ENV},exports.ENV=null,exports.setEnvironmentGlobal=function(environment){exports.ENV=environment}},{}],108:[function(require,module,exports){(function(process){(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var device_util=require("./device_util"),ENV=require("./environment").env();ENV.registerFlag("DEBUG",(function(){return!1}),(function(debugValue){debugValue&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")})),ENV.registerFlag("IS_BROWSER",(function(){return device_util.isBrowser()})),ENV.registerFlag("IS_NODE",(function(){return void 0!==process&&void 0!==process.versions&&void 0!==process.versions.node})),ENV.registerFlag("IS_CHROME",(function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)})),ENV.registerFlag("PROD",(function(){return!1})),ENV.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",(function(){return ENV.getBool("DEBUG")})),ENV.registerFlag("DEPRECATION_WARNINGS_ENABLED",(function(){return!0})),ENV.registerFlag("IS_TEST",(function(){return!1}))}).call(this)}).call(this,require("_process"))},{"./device_util":105,"./environment":107,_process:396}],109:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),environment_1=require("./environment"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util");function deprecationWarn(msg){environment_1.env().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(msg+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}exports.enableProdMode=function(){environment_1.env().set("PROD",!0)},exports.enableDebugMode=function(){environment_1.env().set("DEBUG",!0)},exports.disableDeprecationWarnings=function(){environment_1.env().set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},exports.deprecationWarn=deprecationWarn,tensor_1.setDeprecationWarningFn(deprecationWarn),exports.disposeVariables=function(){engine_1.ENGINE.disposeVariables()},exports.engine=function(){return engine_1.ENGINE},exports.memory=function(){return engine_1.ENGINE.memory()},exports.profile=function(f){return engine_1.ENGINE.profile(f)},exports.tidy=function(nameOrFn,fn){return engine_1.ENGINE.tidy(nameOrFn,fn)},exports.dispose=function(container){tensor_util_1.getTensorsInContainer(container).forEach((function(tensor){return tensor.dispose()}))},exports.keep=function(result){return engine_1.ENGINE.keep(result)},exports.time=function(f){return engine_1.ENGINE.time(f)},exports.setBackend=function(backendName){return engine_1.ENGINE.setBackend(backendName)},exports.ready=function(){return engine_1.ENGINE.ready()},exports.getBackend=function(){return engine_1.ENGINE.backendName},exports.removeBackend=function(name){engine_1.ENGINE.removeBackend(name)},exports.findBackend=function(name){return engine_1.ENGINE.findBackend(name)},exports.findBackendFactory=function(name){return engine_1.ENGINE.findBackendFactory(name)},exports.registerBackend=function(name,factory,priority){return void 0===priority&&(priority=1),engine_1.ENGINE.registerBackend(name,factory,priority)},exports.backend=function(){return engine_1.ENGINE.backend},exports.setPlatform=function(platformName,platform){environment_1.env().setPlatform(platformName,platform)}},{"./engine":106,"./environment":107,"./tensor":207,"./tensor_util":209}],110:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_1=require("./tensor"),tensor_util_env_1=require("./tensor_util_env"),util=require("./util");function checkGrads(grads){if(grads.filter((function(g){return null==g})).length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}exports.grad=function(f){return util.assert(util.isFunction(f),(function(){return"The f passed in grad(f) must be a function"})),function(x,dy){var $x=tensor_util_env_1.convertToTensor(x,"x","tf.grad",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grad"):null;return engine_1.ENGINE.tidy((function(){var _a=engine_1.ENGINE.gradients((function(){return f($x)}),[$x],$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),checkGrads(grads),grads[0]}))}},exports.grads=function(f){return util.assert(util.isFunction(f),(function(){return"The f passed in grads(f) must be a function"})),function(args,dy){util.assert(Array.isArray(args),(function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"}));var $args=tensor_util_env_1.convertToTensorArray(args,"args","tf.grads",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grads"):null;return engine_1.ENGINE.tidy((function(){var _a=engine_1.ENGINE.gradients((function(){return f.apply(void 0,$args)}),$args,$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(grads),grads}))}},exports.valueAndGrad=function(f){return util.assert(util.isFunction(f),(function(){return"The f passed in valueAndGrad(f) must be a function"})),function(x,dy){util.assert(x instanceof tensor_1.Tensor,(function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"})),util.assert(null==dy||dy instanceof tensor_1.Tensor,(function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"}));var _a=engine_1.ENGINE.gradients((function(){return f(x)}),[x],dy),grads=_a.grads,value=_a.value;return checkGrads(grads),{grad:grads[0],value:value}}},exports.valueAndGrads=function(f){return util.assert(util.isFunction(f),(function(){return"The f passed in valueAndGrads(f) must be a function"})),function(args,dy){util.assert(Array.isArray(args)&&args.every((function(arg){return arg instanceof tensor_1.Tensor})),(function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"})),util.assert(null==dy||dy instanceof tensor_1.Tensor,(function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"}));var res=engine_1.ENGINE.gradients((function(){return f.apply(void 0,args)}),args,dy);return null!=dy&&util.assertShapesMatch(res.value.shape,dy.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(res.grads),res}},exports.variableGrads=function(f,varList){util.assert(util.isFunction(f),(function(){return"The f passed in variableGrads(f) must be a function"})),util.assert(null==varList||Array.isArray(varList)&&varList.every((function(v){return v instanceof tensor_1.Variable})),(function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"}));var specifiedVarList=null!=varList;if(!specifiedVarList)for(var varName in varList=[],engine_1.ENGINE.registeredVariables)varList.push(engine_1.ENGINE.registeredVariables[varName]);var specifiedNonTrainable=specifiedVarList?varList.filter((function(variable){return!variable.trainable})):null,originalVarCount=varList.length;varList=varList.filter((function(variable){return variable.trainable})),util.assert(varList.length>0,(function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+originalVarCount+" variables is trainable."}));var _a=engine_1.ENGINE.gradients(f,varList,null,!0),value=_a.value,grads=_a.grads;util.assert(grads.some((function(g){return null!=g})),(function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."})),util.assert(0===value.rank,(function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+value.rank+" tensor"}));var namedGrads={};return varList.forEach((function(v,i){null!=grads[i]&&(namedGrads[v.name]=grads[i])})),null!=specifiedNonTrainable&&specifiedNonTrainable.forEach((function(v){return namedGrads[v.name]=null})),{value:value,grads:namedGrads}},exports.customGrad=function(f){return engine_1.ENGINE.customGrad(f)}},{"./engine":106,"./tensor":207,"./tensor_util_env":210,"./util":214}],111:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../kernel_names");exports.squareGradConfig={kernelName:kernel_names_1.Square,gradFunc:function(dy,saved){var x=saved[0];return{x:function(){return dy.mul(x.toFloat().mul(2))}}}}},{"../kernel_names":126}],112:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernel_names_1=require("../kernel_names"),binary_ops_1=require("../ops/binary_ops"),tensor_ops_1=require("../ops/tensor_ops");exports.squaredDifferenceGradConfig={kernelName:kernel_names_1.SquaredDifference,gradFunc:function(dy,saved){var a=saved[0],b=saved[1],two=tensor_ops_1.scalar(2);return{a:function(){return binary_ops_1.mul(dy,binary_ops_1.mul(two,binary_ops_1.sub(a,b)))},b:function(){return binary_ops_1.mul(dy,binary_ops_1.mul(two,binary_ops_1.sub(b,a)))}}}}},{"../kernel_names":126,"../ops/binary_ops":134,"../ops/tensor_ops":186}],113:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),require("./engine"),require("./flags"),require("./backends/webgl/backend_webgl"),require("./backends/cpu/backend_cpu"),require("./backends/cpu/register_all_kernels"),require("./backends/webgl/register_all_kernels"),require("./register_all_gradients"),require("./platforms/platform_browser"),require("./platforms/platform_node");var backend_util=require("./backends/backend_util");exports.backend_util=backend_util;var io=require("./io/io");exports.io=io;var math=require("./math");exports.math=math;var browser=require("./ops/browser");exports.browser=browser;var gather_util=require("./ops/gather_nd_util");exports.gather_util=gather_util;var scatter_util=require("./ops/scatter_nd_util");exports.scatter_util=scatter_util;var slice_util=require("./ops/slice_util");exports.slice_util=slice_util;var serialization=require("./serialization");exports.serialization=serialization;var tensor_1=require("./tensor"),tensor_util=require("./tensor_util");exports.tensor_util=tensor_util;var test_util=require("./test_util");exports.test_util=test_util;var util=require("./util");exports.util=util;var version_1=require("./version");exports.version_core=version_1.version;var webgl=require("./webgl");exports.webgl=webgl;var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer");exports.AdadeltaOptimizer=adadelta_optimizer_1.AdadeltaOptimizer;var adagrad_optimizer_1=require("./optimizers/adagrad_optimizer");exports.AdagradOptimizer=adagrad_optimizer_1.AdagradOptimizer;var adam_optimizer_1=require("./optimizers/adam_optimizer");exports.AdamOptimizer=adam_optimizer_1.AdamOptimizer;var adamax_optimizer_1=require("./optimizers/adamax_optimizer");exports.AdamaxOptimizer=adamax_optimizer_1.AdamaxOptimizer;var momentum_optimizer_1=require("./optimizers/momentum_optimizer");exports.MomentumOptimizer=momentum_optimizer_1.MomentumOptimizer;var optimizer_1=require("./optimizers/optimizer");exports.Optimizer=optimizer_1.Optimizer;var rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer");exports.RMSPropOptimizer=rmsprop_optimizer_1.RMSPropOptimizer;var sgd_optimizer_1=require("./optimizers/sgd_optimizer");exports.SGDOptimizer=sgd_optimizer_1.SGDOptimizer;var tensor_2=require("./tensor");exports.Tensor=tensor_2.Tensor,exports.TensorBuffer=tensor_2.TensorBuffer,exports.Variable=tensor_2.Variable;var types_1=require("./types");exports.Rank=types_1.Rank,exports.sumOutType=types_1.sumOutType,__export(require("./ops/ops"));var loss_ops_1=require("./ops/loss_ops");exports.Reduction=loss_ops_1.Reduction,__export(require("./train")),__export(require("./globals")),__export(require("./kernel_registry"));var gradients_1=require("./gradients");exports.customGrad=gradients_1.customGrad,exports.grad=gradients_1.grad,exports.grads=gradients_1.grads,exports.valueAndGrad=gradients_1.valueAndGrad,exports.valueAndGrads=gradients_1.valueAndGrads,exports.variableGrads=gradients_1.variableGrads;var environment_1=require("./environment");exports.Environment=environment_1.Environment,exports.env=environment_1.env,exports.ENV=environment_1.ENV;var browser_util_1=require("./browser_util");exports.nextFrame=browser_util_1.nextFrame;var backend_1=require("./backends/backend");exports.KernelBackend=backend_1.KernelBackend,exports.DataStorage=backend_1.DataStorage;var ops=require("./ops/ops");tensor_1.setOpHandler(ops),require("./public/chained_ops/register_all_chained_ops")},{"./backends/backend":2,"./backends/backend_util":3,"./backends/cpu/backend_cpu":5,"./backends/cpu/register_all_kernels":10,"./backends/webgl/backend_webgl":22,"./backends/webgl/register_all_kernels":77,"./browser_util":104,"./engine":106,"./environment":107,"./flags":108,"./globals":109,"./gradients":110,"./io/io":117,"./kernel_registry":127,"./math":129,"./ops/browser":137,"./ops/gather_nd_util":152,"./ops/loss_ops":157,"./ops/ops":164,"./ops/scatter_nd_util":172,"./ops/slice_util":178,"./optimizers/adadelta_optimizer":190,"./optimizers/adagrad_optimizer":191,"./optimizers/adam_optimizer":192,"./optimizers/adamax_optimizer":193,"./optimizers/momentum_optimizer":194,"./optimizers/optimizer":195,"./optimizers/rmsprop_optimizer":197,"./optimizers/sgd_optimizer":198,"./platforms/platform_browser":199,"./platforms/platform_node":200,"./public/chained_ops/register_all_chained_ops":202,"./register_all_gradients":204,"./serialization":205,"./tensor":207,"./tensor_util":209,"./test_util":211,"./train":212,"./types":213,"./util":214,"./version":215,"./webgl":216}],114:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry");function defer(f){return new Promise((function(resolve){return setTimeout(resolve)})).then(f)}var BrowserDownloads=function(){function BrowserDownloads(fileNamePrefix){if(!environment_1.env().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");fileNamePrefix.startsWith(BrowserDownloads.URL_SCHEME)&&(fileNamePrefix=fileNamePrefix.slice(BrowserDownloads.URL_SCHEME.length)),null!=fileNamePrefix&&0!==fileNamePrefix.length||(fileNamePrefix="model"),this.modelTopologyFileName=fileNamePrefix+".json",this.weightDataFileName=fileNamePrefix+".weights.bin"}return BrowserDownloads.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,(function(){var weightsURL,weightsManifest,modelTopologyAndWeightManifest,modelTopologyAndWeightManifestURL,jsonAnchor_1,weightDataAnchor_1;return __generator(this,(function(_a){switch(_a.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(weightsURL=window.URL.createObjectURL(new Blob([modelArtifacts.weightData],{type:"application/octet-stream"})),!(modelArtifacts.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return weightsManifest=[{paths:["./"+this.weightDataFileName],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,weightsManifest:weightsManifest},modelTopologyAndWeightManifestURL=window.URL.createObjectURL(new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"})),(jsonAnchor_1=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,jsonAnchor_1.href=modelTopologyAndWeightManifestURL,[4,defer((function(){return jsonAnchor_1.dispatchEvent(new MouseEvent("click"))}))];case 2:return _a.sent(),null==modelArtifacts.weightData?[3,4]:((weightDataAnchor_1=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,weightDataAnchor_1.href=weightsURL,[4,defer((function(){return weightDataAnchor_1.dispatchEvent(new MouseEvent("click"))}))]);case 3:_a.sent(),_a.label=4;case 4:return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts)}]}}))}))},BrowserDownloads.URL_SCHEME="downloads://",BrowserDownloads}();exports.BrowserDownloads=BrowserDownloads;var BrowserFiles=function(){function BrowserFiles(files){if(null==files||files.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+files);this.files=files}return BrowserFiles.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){var jsonFile,weightFiles,_this=this;return __generator(this,(function(_a){return jsonFile=this.files[0],weightFiles=this.files.slice(1),[2,new Promise((function(resolve,reject){var jsonReader=new FileReader;jsonReader.onload=function(event){var modelJSON=JSON.parse(event.target.result),modelTopology=modelJSON.modelTopology;if(null!=modelTopology){0===weightFiles.length&&resolve({modelTopology:modelTopology});var weightsManifest=modelJSON.weightsManifest;if(null!=weightsManifest){var pathToFile;try{pathToFile=_this.checkManifestAndWeightFiles(weightsManifest,weightFiles)}catch(err){return void reject(err)}var weightSpecs=[],paths=[],perFileBuffers=[];weightsManifest.forEach((function(weightsGroup){weightsGroup.paths.forEach((function(path){paths.push(path),perFileBuffers.push(null)})),weightSpecs.push.apply(weightSpecs,weightsGroup.weights)})),weightsManifest.forEach((function(weightsGroup){weightsGroup.paths.forEach((function(path){var weightFileReader=new FileReader;weightFileReader.onload=function(event){var weightData=event.target.result,index=paths.indexOf(path);perFileBuffers[index]=weightData,-1===perFileBuffers.indexOf(null)&&resolve({modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:io_utils_1.concatenateArrayBuffers(perFileBuffers),format:modelJSON.format,generatedBy:modelJSON.generatedBy,convertedBy:modelJSON.convertedBy,userDefinedMetadata:modelJSON.userDefinedMetadata})},weightFileReader.onerror=function(error){return reject("Failed to weights data from file of path '"+path+"'.")},weightFileReader.readAsArrayBuffer(pathToFile[path])}))}))}else reject(new Error("weightManifest field is missing from file "+jsonFile.name))}else reject(new Error("modelTopology field is missing from file "+jsonFile.name))},jsonReader.onerror=function(error){return reject("Failed to read model topology and weights manifest JSON from file '"+jsonFile.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},jsonReader.readAsText(jsonFile)}))]}))}))},BrowserFiles.prototype.checkManifestAndWeightFiles=function(manifest,files){for(var basenames=[],fileNames=files.map((function(file){return io_utils_1.basename(file.name)})),pathToFile={},_i=0,manifest_1=manifest;_i<manifest_1.length;_i++){manifest_1[_i].paths.forEach((function(path){var pathBasename=io_utils_1.basename(path);if(-1!==basenames.indexOf(pathBasename))throw new Error("Duplicate file basename found in weights manifest: '"+pathBasename+"'");if(basenames.push(pathBasename),-1===fileNames.indexOf(pathBasename))throw new Error("Weight file with basename '"+pathBasename+"' is not provided.");pathToFile[path]=files[fileNames.indexOf(pathBasename)]}))}if(basenames.length!==files.length)throw new Error("Mismatch in the number of files in weights manifest ("+basenames.length+") and the number of weight files provided ("+files.length+").");return pathToFile},BrowserFiles}();function browserDownloads(fileNamePrefix){return void 0===fileNamePrefix&&(fileNamePrefix="model"),new BrowserDownloads(fileNamePrefix)}exports.browserDownloadsRouter=function(url){return environment_1.env().getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserDownloads.URL_SCHEME)?browserDownloads(url.slice(BrowserDownloads.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.browserDownloadsRouter),exports.browserDownloads=browserDownloads,exports.browserFiles=function(files){return new BrowserFiles(files)}},{"../environment":107,"./io_utils":118,"./router_registry":123}],115:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry"),weights_loader_1=require("./weights_loader"),HTTPRequest=function(){function HTTPRequest(path,loadOptions){if(this.DEFAULT_METHOD="POST",null==loadOptions&&(loadOptions={}),this.weightPathPrefix=loadOptions.weightPathPrefix,this.onProgress=loadOptions.onProgress,null!=loadOptions.fetchFunc?(util_1.assert("function"==typeof loadOptions.fetchFunc,(function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"})),this.fetch=loadOptions.fetchFunc):this.fetch=environment_1.env().platform.fetch,util_1.assert(null!=path&&path.length>0,(function(){return"URL path for http must not be null, undefined or empty."})),Array.isArray(path)&&util_1.assert(2===path.length,(function(){return"URL paths for http must have a length of 2, (actual length is "+path.length+")."})),this.path=path,null!=loadOptions.requestInit&&null!=loadOptions.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=loadOptions.requestInit||{}}return HTTPRequest.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,(function(){var init,weightsManifest,modelTopologyAndWeightManifest,response;return __generator(this,(function(_a){switch(_a.label){case 0:if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(init=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,weightsManifest=[{paths:["./model.weights.bin"],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,userDefinedMetadata:modelArtifacts.userDefinedMetadata,weightsManifest:weightsManifest},init.body.append("model.json",new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"}),"model.json"),null!=modelArtifacts.weightData&&init.body.append("model.weights.bin",new Blob([modelArtifacts.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,init)];case 1:if((response=_a.sent()).ok)return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),responses:[response]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+response.status+".")}}))}))},HTTPRequest.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){var modelConfigRequest,modelConfig,message,modelTopology,weightsManifest,generatedBy,convertedBy,format,userDefinedMetadata,weightSpecs,weightData,results;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(modelConfigRequest=_a.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+modelConfigRequest.status+". Please verify this URL points to the model JSON of the model to load.");_a.label=2;case 2:return _a.trys.push([2,4,,5]),[4,modelConfigRequest.json()];case 3:return modelConfig=_a.sent(),[3,5];case 4:throw _a.sent(),message="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?message+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":message+=" Please make sure the server is serving valid JSON for this request.",new Error(message);case 5:if(modelTopology=modelConfig.modelTopology,weightsManifest=modelConfig.weightsManifest,generatedBy=modelConfig.generatedBy,convertedBy=modelConfig.convertedBy,format=modelConfig.format,userDefinedMetadata=modelConfig.userDefinedMetadata,null==modelTopology&&null==weightsManifest)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==weightsManifest?[3,7]:[4,this.loadWeights(weightsManifest)];case 6:results=_a.sent(),weightSpecs=results[0],weightData=results[1],_a.label=7;case 7:return[2,{modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:weightData,userDefinedMetadata:userDefinedMetadata,generatedBy:generatedBy,convertedBy:convertedBy,format:format}]}}))}))},HTTPRequest.prototype.loadWeights=function(weightsManifest){return __awaiter(this,void 0,void 0,(function(){var weightPath,_a,prefix,suffix,pathPrefix,weightSpecs,_i,weightsManifest_1,entry,fetchURLs,buffers;return __generator(this,(function(_b){switch(_b.label){case 0:for(weightPath=Array.isArray(this.path)?this.path[1]:this.path,_a=parseUrl(weightPath),prefix=_a[0],suffix=_a[1],pathPrefix=this.weightPathPrefix||prefix,weightSpecs=[],_i=0,weightsManifest_1=weightsManifest;_i<weightsManifest_1.length;_i++)entry=weightsManifest_1[_i],weightSpecs.push.apply(weightSpecs,entry.weights);return fetchURLs=[],weightsManifest.forEach((function(weightsGroup){weightsGroup.paths.forEach((function(path){fetchURLs.push(pathPrefix+path+suffix)}))})),[4,weights_loader_1.loadWeightsAsArrayBuffer(fetchURLs,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return buffers=_b.sent(),[2,[weightSpecs,io_utils_1.concatenateArrayBuffers(buffers)]]}}))}))},HTTPRequest.URL_SCHEME_REGEX=/^https?:\/\//,HTTPRequest}();function parseUrl(url){var lastSlash=url.lastIndexOf("/"),lastSearchParam=url.lastIndexOf("?");return[url.substring(0,lastSlash)+"/",lastSearchParam>lastSlash?url.substring(lastSearchParam):""]}function isHTTPScheme(url){return null!=url.match(HTTPRequest.URL_SCHEME_REGEX)}function http(path,loadOptions){return new HTTPRequest(path,loadOptions)}exports.HTTPRequest=HTTPRequest,exports.parseUrl=parseUrl,exports.isHTTPScheme=isHTTPScheme,exports.httpRouter=function(url,onProgress){if("undefined"==typeof fetch)return null;return(Array.isArray(url)?url.every((function(urlItem){return isHTTPScheme(urlItem)})):isHTTPScheme(url))?http(url,{onProgress:onProgress}):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.httpRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.httpRouter),exports.http=http,exports.browserHTTPRequest=function(path,loadOptions){return http(path,loadOptions)}},{"../environment":107,"../util":214,"./io_utils":118,"./router_registry":123,"./weights_loader":125}],116:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry");function getIndexedDBFactory(){if(!environment_1.env().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var theWindow=window||self,factory=theWindow.indexedDB||theWindow.mozIndexedDB||theWindow.webkitIndexedDB||theWindow.msIndexedDB||theWindow.shimIndexedDB;if(null==factory)throw new Error("The current browser does not appear to support IndexedDB.");return factory}function setUpDatabase(openRequest){var db=openRequest.result;db.createObjectStore("models_store",{keyPath:"modelPath"}),db.createObjectStore("model_info_store",{keyPath:"modelPath"})}exports.deleteDatabase=function(){return __awaiter(this,void 0,void 0,(function(){var idbFactory;return __generator(this,(function(_a){return idbFactory=getIndexedDBFactory(),[2,new Promise((function(resolve,reject){var deleteRequest=idbFactory.deleteDatabase("tensorflowjs");deleteRequest.onsuccess=function(){return resolve()},deleteRequest.onerror=function(error){return reject(error)}}))]}))}))};var BrowserIndexedDB=function(){function BrowserIndexedDB(modelPath){if(this.indexedDB=getIndexedDBFactory(),null==modelPath||!modelPath)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=modelPath}return BrowserIndexedDB.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,modelArtifacts)]}))}))},BrowserIndexedDB.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.databaseAction(this.modelPath)]}))}))},BrowserIndexedDB.prototype.databaseAction=function(modelPath,modelArtifacts){var _this=this;return new Promise((function(resolve,reject){var openRequest=_this.indexedDB.open("tensorflowjs",1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result;if(null==modelArtifacts){var modelTx=db.transaction("models_store","readonly"),getRequest_1=modelTx.objectStore("models_store").get(_this.modelPath);getRequest_1.onsuccess=function(){if(null==getRequest_1.result)return db.close(),reject(new Error("Cannot find model with path '"+_this.modelPath+"' in IndexedDB."));resolve(getRequest_1.result.modelArtifacts)},getRequest_1.onerror=function(error){return db.close(),reject(getRequest_1.error)},modelTx.oncomplete=function(){return db.close()}}else{var modelTx_1,modelArtifactsInfo_1=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),infoTx_1=db.transaction("model_info_store","readwrite"),infoStore_1=infoTx_1.objectStore("model_info_store"),putInfoRequest_1=infoStore_1.put({modelPath:_this.modelPath,modelArtifactsInfo:modelArtifactsInfo_1});putInfoRequest_1.onsuccess=function(){var putModelRequest=(modelTx_1=db.transaction("models_store","readwrite")).objectStore("models_store").put({modelPath:_this.modelPath,modelArtifacts:modelArtifacts,modelArtifactsInfo:modelArtifactsInfo_1});putModelRequest.onsuccess=function(){return resolve({modelArtifactsInfo:modelArtifactsInfo_1})},putModelRequest.onerror=function(error){var deleteInfoRequest=(infoStore_1=infoTx_1.objectStore("model_info_store")).delete(_this.modelPath);deleteInfoRequest.onsuccess=function(){return db.close(),reject(putModelRequest.error)},deleteInfoRequest.onerror=function(error){return db.close(),reject(putModelRequest.error)}}},putInfoRequest_1.onerror=function(error){return db.close(),reject(putInfoRequest_1.error)},infoTx_1.oncomplete=function(){null==modelTx_1?db.close():modelTx_1.oncomplete=function(){return db.close()}}}},openRequest.onerror=function(error){return reject(openRequest.error)}}))},BrowserIndexedDB.URL_SCHEME="indexeddb://",BrowserIndexedDB}();function browserIndexedDB(modelPath){return new BrowserIndexedDB(modelPath)}exports.BrowserIndexedDB=BrowserIndexedDB,exports.indexedDBRouter=function(url){return environment_1.env().getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserIndexedDB.URL_SCHEME)?browserIndexedDB(url.slice(BrowserIndexedDB.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.indexedDBRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.indexedDBRouter),exports.browserIndexedDB=browserIndexedDB;var BrowserIndexedDBManager=function(){function BrowserIndexedDBManager(){this.indexedDB=getIndexedDBFactory()}return BrowserIndexedDBManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return[2,new Promise((function(resolve,reject){var openRequest=_this.indexedDB.open("tensorflowjs",1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result,tx=db.transaction("model_info_store","readonly"),getAllInfoRequest=tx.objectStore("model_info_store").getAll();getAllInfoRequest.onsuccess=function(){for(var out={},_i=0,_a=getAllInfoRequest.result;_i<_a.length;_i++){var item=_a[_i];out[item.modelPath]=item.modelArtifactsInfo}resolve(out)},getAllInfoRequest.onerror=function(error){return db.close(),reject(getAllInfoRequest.error)},tx.oncomplete=function(){return db.close()}},openRequest.onerror=function(error){return reject(openRequest.error)}}))]}))}))},BrowserIndexedDBManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){var key;return path=(key=path).startsWith(BrowserIndexedDB.URL_SCHEME)?key.slice(BrowserIndexedDB.URL_SCHEME.length):key,[2,new Promise((function(resolve,reject){var openRequest=_this.indexedDB.open("tensorflowjs",1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var modelTx,db=openRequest.result,infoTx=db.transaction("model_info_store","readwrite"),infoStore=infoTx.objectStore("model_info_store"),getInfoRequest=infoStore.get(path);getInfoRequest.onsuccess=function(){if(null==getInfoRequest.result)return db.close(),reject(new Error("Cannot find model with path '"+path+"' in IndexedDB."));var deleteInfoRequest=infoStore.delete(path),deleteModelData_1=function(){var deleteModelRequest=(modelTx=db.transaction("models_store","readwrite")).objectStore("models_store").delete(path);deleteModelRequest.onsuccess=function(){return resolve(getInfoRequest.result.modelArtifactsInfo)},deleteModelRequest.onerror=function(error){return reject(getInfoRequest.error)}};deleteInfoRequest.onsuccess=deleteModelData_1,deleteInfoRequest.onerror=function(error){return deleteModelData_1(),db.close(),reject(getInfoRequest.error)}},getInfoRequest.onerror=function(error){return db.close(),reject(getInfoRequest.error)},infoTx.oncomplete=function(){null==modelTx?db.close():modelTx.oncomplete=function(){return db.close()}}},openRequest.onerror=function(error){return reject(openRequest.error)}}))]}))}))},BrowserIndexedDBManager}();if(exports.BrowserIndexedDBManager=BrowserIndexedDBManager,environment_1.env().getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserIndexedDB.URL_SCHEME,new BrowserIndexedDBManager)}catch(err){}},{"../environment":107,"./io_utils":118,"./model_management":120,"./router_registry":123}],117:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),require("./indexed_db"),require("./local_storage");var browser_files_1=require("./browser_files");exports.browserFiles=browser_files_1.browserFiles;var http_1=require("./http");exports.browserHTTPRequest=http_1.browserHTTPRequest,exports.http=http_1.http,exports.isHTTPScheme=http_1.isHTTPScheme;var io_utils_1=require("./io_utils");exports.concatenateArrayBuffers=io_utils_1.concatenateArrayBuffers,exports.decodeWeights=io_utils_1.decodeWeights,exports.encodeWeights=io_utils_1.encodeWeights,exports.getModelArtifactsInfoForJSON=io_utils_1.getModelArtifactsInfoForJSON;var passthrough_1=require("./passthrough");exports.fromMemory=passthrough_1.fromMemory,exports.withSaveHandler=passthrough_1.withSaveHandler;var router_registry_1=require("./router_registry");exports.getLoadHandlers=router_registry_1.getLoadHandlers,exports.getSaveHandlers=router_registry_1.getSaveHandlers,exports.registerLoadRouter=router_registry_1.registerLoadRouter,exports.registerSaveRouter=router_registry_1.registerSaveRouter;var weights_loader_1=require("./weights_loader");exports.loadWeights=weights_loader_1.loadWeights,exports.weightsLoaderFactory=weights_loader_1.weightsLoaderFactory;var model_management_1=require("./model_management");exports.copyModel=model_management_1.copyModel,exports.listModels=model_management_1.listModels,exports.moveModel=model_management_1.moveModel,exports.removeModel=model_management_1.removeModel},{"./browser_files":114,"./http":115,"./indexed_db":116,"./io_utils":118,"./local_storage":119,"./model_management":120,"./passthrough":121,"./router_registry":123,"./weights_loader":125}],118:[function(require,module,exports){(function(Buffer){(function(){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util"),types_1=require("./types");function concatenateTypedArrays(xs){if(null===xs)throw new Error("Invalid input value: "+JSON.stringify(xs));var totalByteLength=0,normalizedXs=[];xs.forEach((function(x){if(totalByteLength+=x.byteLength,normalizedXs.push(x.byteLength===x.buffer.byteLength?x:new x.constructor(x)),!(x instanceof Float32Array||x instanceof Int32Array||x instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+x.constructor.name)}));var y=new Uint8Array(totalByteLength),offset=0;return normalizedXs.forEach((function(x){y.set(new Uint8Array(x.buffer),offset),offset+=x.byteLength})),y.buffer}exports.encodeWeights=function(tensors,group){return __awaiter(this,void 0,void 0,(function(){var specs,dataPromises,names,_loop_1,i,_this=this;return __generator(this,(function(_a){switch(_a.label){case 0:for(specs=[],dataPromises=[],names=Array.isArray(tensors)?tensors.map((function(tensor){return tensor.name})):Object.keys(tensors),_loop_1=function(i){var name_1=names[i],t=Array.isArray(tensors)?tensors[i].tensor:tensors[name_1];if("float32"!==t.dtype&&"int32"!==t.dtype&&"bool"!==t.dtype&&"string"!==t.dtype)throw new Error("Unsupported dtype in weight '"+name_1+"': "+t.dtype);var spec={name:name_1,shape:t.shape,dtype:t.dtype};if("string"===t.dtype){var utf8bytes=new Promise((function(resolve){return __awaiter(_this,void 0,void 0,(function(){var vals,totalNumBytes,bytes,offset,i_1,val,bytesOfLength;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,t.bytes()];case 1:for(vals=_a.sent(),totalNumBytes=vals.reduce((function(p,c){return p+c.length}),0)+4*vals.length,bytes=new Uint8Array(totalNumBytes),offset=0,i_1=0;i_1<vals.length;i_1++)val=vals[i_1],bytesOfLength=new Uint8Array(new Uint32Array([val.length]).buffer),bytes.set(bytesOfLength,offset),offset+=4,bytes.set(val,offset),offset+=val.length;return resolve(bytes),[2]}}))}))}));dataPromises.push(utf8bytes)}else dataPromises.push(t.data());null!=group&&(spec.group=group),specs.push(spec)},i=0;i<names.length;++i)_loop_1(i);return[4,Promise.all(dataPromises)];case 1:return[2,{data:concatenateTypedArrays(_a.sent()),specs:specs}]}}))}))},exports.decodeWeights=function(buffer,specs){for(var out={},offset=0,_loop_2=function(spec){var name_2=spec.name,dtype=spec.dtype,shape=spec.shape,size=util_1.sizeFromShape(shape),values=void 0;if("quantization"in spec){var quantization_1=spec.quantization;if("uint8"!==quantization_1.dtype&&"uint16"!==quantization_1.dtype)throw new Error("Weight "+spec.name+" has unknown quantization dtype "+quantization_1.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var quantizationSizeFactor=types_1.DTYPE_VALUE_SIZE_MAP[quantization_1.dtype],byteBuffer=buffer.slice(offset,offset+size*quantizationSizeFactor),quantizedArray="uint8"===quantization_1.dtype?new Uint8Array(byteBuffer):new Uint16Array(byteBuffer);if("float32"===dtype)values=Float32Array.from(quantizedArray,(function(v){return v*quantization_1.scale+quantization_1.min}));else{if("int32"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=Int32Array.from(quantizedArray,(function(v){return Math.round(v*quantization_1.scale+quantization_1.min)}))}offset+=size*quantizationSizeFactor}else if("string"===dtype){var size_1=util_1.sizeFromShape(spec.shape);values=[];for(var i=0;i<size_1;i++){var byteLength=new Uint32Array(buffer.slice(offset,offset+4))[0];offset+=4;var bytes=new Uint8Array(buffer.slice(offset,offset+byteLength));values.push(bytes),offset+=byteLength}}else{var dtypeFactor=types_1.DTYPE_VALUE_SIZE_MAP[dtype];byteBuffer=buffer.slice(offset,offset+size*dtypeFactor);if("float32"===dtype)values=new Float32Array(byteBuffer);else if("int32"===dtype)values=new Int32Array(byteBuffer);else{if("bool"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=new Uint8Array(byteBuffer)}offset+=size*dtypeFactor}out[name_2]=tensor_ops_1.tensor(values,shape,dtype)},_i=0,specs_1=specs;_i<specs_1.length;_i++){_loop_2(specs_1[_i])}return out},exports.concatenateTypedArrays=concatenateTypedArrays;var useNodeBuffer=void 0!==Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function stringByteLength(str){return useNodeBuffer?Buffer.byteLength(str):new Blob([str]).size}exports.stringByteLength=stringByteLength,exports.arrayBufferToBase64String=function(buffer){if(useNodeBuffer)return Buffer.from(buffer).toString("base64");for(var buf=new Uint8Array(buffer),s="",i=0,l=buf.length;i<l;i++)s+=String.fromCharCode(buf[i]);return btoa(s)},exports.base64StringToArrayBuffer=function(str){if(useNodeBuffer){var buf=Buffer.from(str,"base64");return buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.byteLength)}for(var s=atob(str),buffer=new Uint8Array(s.length),i=0;i<s.length;++i)buffer.set([s.charCodeAt(i)],i);return buffer.buffer},exports.concatenateArrayBuffers=function(buffers){var totalByteLength=0;buffers.forEach((function(buffer){totalByteLength+=buffer.byteLength}));var temp=new Uint8Array(totalByteLength),offset=0;return buffers.forEach((function(buffer){temp.set(new Uint8Array(buffer),offset),offset+=buffer.byteLength})),temp.buffer},exports.basename=function(path){for(path=path.trim();path.endsWith("/");)path=path.slice(0,path.length-1);var items=path.split("/");return items[items.length-1]},exports.getModelArtifactsInfoForJSON=function(modelArtifacts){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==modelArtifacts.modelTopology?0:stringByteLength(JSON.stringify(modelArtifacts.modelTopology)),weightSpecsBytes:null==modelArtifacts.weightSpecs?0:stringByteLength(JSON.stringify(modelArtifacts.weightSpecs)),weightDataBytes:null==modelArtifacts.weightData?0:modelArtifacts.weightData.byteLength}}}).call(this)}).call(this,require("buffer").Buffer)},{"../ops/tensor_ops":186,"../util":214,"./types":124,buffer:220}],119:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry"),PATH_PREFIX="tensorflowjs_models",INFO_SUFFIX="info",MODEL_TOPOLOGY_SUFFIX="model_topology",WEIGHT_SPECS_SUFFIX="weight_specs",WEIGHT_DATA_SUFFIX="weight_data",MODEL_METADATA_SUFFIX="model_metadata";function getModelKeys(path){return{info:[PATH_PREFIX,path,INFO_SUFFIX].join("/"),topology:[PATH_PREFIX,path,MODEL_TOPOLOGY_SUFFIX].join("/"),weightSpecs:[PATH_PREFIX,path,WEIGHT_SPECS_SUFFIX].join("/"),weightData:[PATH_PREFIX,path,WEIGHT_DATA_SUFFIX].join("/"),modelMetadata:[PATH_PREFIX,path,MODEL_METADATA_SUFFIX].join("/")}}function getModelPathFromKey(key){var items=key.split("/");if(items.length<3)throw new Error("Invalid key format: "+key);return items.slice(1,items.length-1).join("/")}exports.purgeLocalStorageArtifacts=function(){if(!environment_1.env().getBool("IS_BROWSER")||"undefined"==typeof window||void 0===window.localStorage)throw new Error("purgeLocalStorageModels() cannot proceed because local storage is unavailable in the current environment.");for(var LS=window.localStorage,purgedModelPaths=[],i=0;i<LS.length;++i){var key=LS.key(i),prefix=PATH_PREFIX+"/";if(key.startsWith(prefix)&&key.length>prefix.length){LS.removeItem(key);var modelName=getModelPathFromKey(key);-1===purgedModelPaths.indexOf(modelName)&&purgedModelPaths.push(modelName)}}return purgedModelPaths};var BrowserLocalStorage=function(){function BrowserLocalStorage(modelPath){if(!environment_1.env().getBool("IS_BROWSER")||"undefined"==typeof window||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==modelPath||!modelPath)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=modelPath,this.keys=getModelKeys(this.modelPath)}return BrowserLocalStorage.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,(function(){var topology,weightSpecs,modelArtifactsInfo;return __generator(this,(function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");topology=JSON.stringify(modelArtifacts.modelTopology),weightSpecs=JSON.stringify(modelArtifacts.weightSpecs),modelArtifactsInfo=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts);try{return this.LS.setItem(this.keys.info,JSON.stringify(modelArtifactsInfo)),this.LS.setItem(this.keys.topology,topology),this.LS.setItem(this.keys.weightSpecs,weightSpecs),this.LS.setItem(this.keys.weightData,io_utils_1.arrayBufferToBase64String(modelArtifacts.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,userDefinedMetadata:modelArtifacts.userDefinedMetadata})),[2,{modelArtifactsInfo:modelArtifactsInfo}]}catch(err){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+modelArtifactsInfo.modelTopologyBytes+", weightSpecsBytes="+modelArtifactsInfo.weightSpecsBytes+", weightDataBytes="+modelArtifactsInfo.weightDataBytes+".")}return[2]}))}))},BrowserLocalStorage.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){var info,out,topology,weightSpecs,metadataString,metadata,weightDataBase64;return __generator(this,(function(_a){if(null==(info=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==info.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(out={},null==(topology=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(out.modelTopology=topology,null==(weightSpecs=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(out.weightSpecs=weightSpecs,null!=(metadataString=this.LS.getItem(this.keys.modelMetadata))&&(metadata=JSON.parse(metadataString),out.format=metadata.format,out.generatedBy=metadata.generatedBy,out.convertedBy=metadata.convertedBy,out.userDefinedMetadata=metadata.userDefinedMetadata),null==(weightDataBase64=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return out.weightData=io_utils_1.base64StringToArrayBuffer(weightDataBase64),[2,out]}))}))},BrowserLocalStorage.URL_SCHEME="localstorage://",BrowserLocalStorage}();function browserLocalStorage(modelPath){return new BrowserLocalStorage(modelPath)}exports.BrowserLocalStorage=BrowserLocalStorage,exports.localStorageRouter=function(url){return environment_1.env().getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserLocalStorage.URL_SCHEME)?browserLocalStorage(url.slice(BrowserLocalStorage.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.localStorageRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.localStorageRouter),exports.browserLocalStorage=browserLocalStorage;var BrowserLocalStorageManager=function(){function BrowserLocalStorageManager(){util_1.assert(environment_1.env().getBool("IS_BROWSER"),(function(){return"Current environment is not a web browser"})),util_1.assert("undefined"==typeof window||void 0!==window.localStorage,(function(){return"Current browser does not appear to support localStorage"})),this.LS=window.localStorage}return BrowserLocalStorageManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,(function(){var out,prefix,suffix,i,key,modelPath;return __generator(this,(function(_a){for(out={},prefix=PATH_PREFIX+"/",suffix="/"+INFO_SUFFIX,i=0;i<this.LS.length;++i)(key=this.LS.key(i)).startsWith(prefix)&&key.endsWith(suffix)&&(modelPath=getModelPathFromKey(key),out[modelPath]=JSON.parse(this.LS.getItem(key)));return[2,out]}))}))},BrowserLocalStorageManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,(function(){var keys,info;return __generator(this,(function(_a){var key;if(path=(key=path).startsWith(BrowserLocalStorage.URL_SCHEME)?key.slice(BrowserLocalStorage.URL_SCHEME.length):key,keys=getModelKeys(path),null==this.LS.getItem(keys.info))throw new Error("Cannot find model at path '"+path+"'");return info=JSON.parse(this.LS.getItem(keys.info)),this.LS.removeItem(keys.info),this.LS.removeItem(keys.topology),this.LS.removeItem(keys.weightSpecs),this.LS.removeItem(keys.weightData),[2,info]}))}))},BrowserLocalStorageManager}();if(exports.BrowserLocalStorageManager=BrowserLocalStorageManager,environment_1.env().getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserLocalStorage.URL_SCHEME,new BrowserLocalStorageManager)}catch(err){}},{"../environment":107,"../util":214,"./io_utils":118,"./model_management":120,"./router_registry":123}],120:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),router_registry_1=require("./router_registry"),ModelStoreManagerRegistry=function(){function ModelStoreManagerRegistry(){this.managers={}}return ModelStoreManagerRegistry.getInstance=function(){return null==ModelStoreManagerRegistry.instance&&(ModelStoreManagerRegistry.instance=new ModelStoreManagerRegistry),ModelStoreManagerRegistry.instance},ModelStoreManagerRegistry.registerManager=function(scheme,manager){util_1.assert(null!=scheme,(function(){return"scheme must not be undefined or null."})),scheme.endsWith("://")&&(scheme=scheme.slice(0,scheme.indexOf("://"))),util_1.assert(scheme.length>0,(function(){return"scheme must not be an empty string."}));var registry=ModelStoreManagerRegistry.getInstance();util_1.assert(null==registry.managers[scheme],(function(){return"A model store manager is already registered for scheme '"+scheme+"'."})),registry.managers[scheme]=manager},ModelStoreManagerRegistry.getManager=function(scheme){var manager=this.getInstance().managers[scheme];if(null==manager)throw new Error("Cannot find model manager for scheme '"+scheme+"'");return manager},ModelStoreManagerRegistry.getSchemes=function(){return Object.keys(this.getInstance().managers)},ModelStoreManagerRegistry}();function parseURL(url){if(-1===url.indexOf("://"))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+ModelStoreManagerRegistry.getSchemes().join(","));return{scheme:url.split("://")[0],path:url.split("://")[1]}}function cloneModelInternal(sourceURL,destURL,deleteSource){return void 0===deleteSource&&(deleteSource=!1),__awaiter(this,void 0,void 0,(function(){var loadHandlers,loadHandler,saveHandlers,saveHandler,sourceScheme,sourcePath,sameMedium,modelArtifacts,saveResult;return __generator(this,(function(_a){switch(_a.label){case 0:return util_1.assert(sourceURL!==destURL,(function(){return"Old path and new path are the same: '"+sourceURL+"'"})),loadHandlers=router_registry_1.IORouterRegistry.getLoadHandlers(sourceURL),util_1.assert(loadHandlers.length>0,(function(){return"Copying failed because no load handler is found for source URL "+sourceURL+"."})),util_1.assert(loadHandlers.length<2,(function(){return"Copying failed because more than one ("+loadHandlers.length+") load handlers for source URL "+sourceURL+"."})),loadHandler=loadHandlers[0],saveHandlers=router_registry_1.IORouterRegistry.getSaveHandlers(destURL),util_1.assert(saveHandlers.length>0,(function(){return"Copying failed because no save handler is found for destination URL "+destURL+"."})),util_1.assert(saveHandlers.length<2,(function(){return"Copying failed because more than one ("+loadHandlers.length+") save handlers for destination URL "+destURL+"."})),saveHandler=saveHandlers[0],sourceScheme=parseURL(sourceURL).scheme,sourcePath=parseURL(sourceURL).path,sameMedium=sourceScheme===parseURL(sourceURL).scheme,[4,loadHandler.load()];case 1:return modelArtifacts=_a.sent(),deleteSource&&sameMedium?[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[4,saveHandler.save(modelArtifacts)];case 4:return saveResult=_a.sent(),!deleteSource||sameMedium?[3,6]:[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)];case 5:_a.sent(),_a.label=6;case 6:return[2,saveResult.modelArtifactsInfo]}}))}))}exports.ModelStoreManagerRegistry=ModelStoreManagerRegistry,exports.listModels=function(){return __awaiter(this,void 0,void 0,(function(){var schemes,out,_i,schemes_1,scheme,schemeOut,path;return __generator(this,(function(_a){switch(_a.label){case 0:schemes=ModelStoreManagerRegistry.getSchemes(),out={},_i=0,schemes_1=schemes,_a.label=1;case 1:return _i<schemes_1.length?(scheme=schemes_1[_i],[4,ModelStoreManagerRegistry.getManager(scheme).listModels()]):[3,4];case 2:for(path in schemeOut=_a.sent())out[scheme+"://"+path]=schemeOut[path];_a.label=3;case 3:return _i++,[3,1];case 4:return[2,out]}}))}))},exports.removeModel=function(url){return __awaiter(this,void 0,void 0,(function(){var schemeAndPath;return __generator(this,(function(_a){return schemeAndPath=parseURL(url),[2,ModelStoreManagerRegistry.getManager(schemeAndPath.scheme).removeModel(schemeAndPath.path)]}))}))},exports.copyModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return!1,[2,cloneModelInternal(sourceURL,destURL,false)]}))}))},exports.moveModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return!0,[2,cloneModelInternal(sourceURL,destURL,true)]}))}))}},{"../util":214,"./router_registry":123}],121:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PassthroughLoader=function(){function PassthroughLoader(modelArtifacts){this.modelArtifacts=modelArtifacts}return PassthroughLoader.prototype.load=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.modelArtifacts]}))}))},PassthroughLoader}(),PassthroughSaver=function(){function PassthroughSaver(saveHandler){this.saveHandler=saveHandler}return PassthroughSaver.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.saveHandler(modelArtifacts)]}))}))},PassthroughSaver}();exports.fromMemory=function(modelArtifacts,weightSpecs,weightData,trainingConfig){if(1===arguments.length){var isModelArtifacts=null!=modelArtifacts.modelTopology||null!=modelArtifacts.weightSpecs;return isModelArtifacts?new PassthroughLoader(modelArtifacts):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts}))}return console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts,weightSpecs:weightSpecs,weightData:weightData,trainingConfig:trainingConfig})},exports.withSaveHandler=function(saveHandler){return new PassthroughSaver(saveHandler)}},{}],122:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.monitorPromisesProgress=function(promises,onProgress,startFraction,endFraction){!function(promises){util_1.assert(null!=promises&&Array.isArray(promises)&&promises.length>0,(function(){return"promises must be a none empty array"}))}(promises),function(startFraction,endFraction){util_1.assert(startFraction>=0&&startFraction<=1,(function(){return"Progress fraction must be in range [0, 1], but got startFraction "+startFraction})),util_1.assert(endFraction>=0&&endFraction<=1,(function(){return"Progress fraction must be in range [0, 1], but got endFraction "+endFraction})),util_1.assert(endFraction>=startFraction,(function(){return"startFraction must be no more than endFraction, but got startFraction "+startFraction+" and endFraction "+endFraction}))}(startFraction=null==startFraction?0:startFraction,endFraction=null==endFraction?1:endFraction);var resolvedPromise=0;return Promise.all(promises.map((function(promise){return promise.then((function(value){var fraction=startFraction+ ++resolvedPromise/promises.length*(endFraction-startFraction);return onProgress(fraction),value})),promise})))}},{"../util":214}],123:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var IORouterRegistry=function(){function IORouterRegistry(){this.saveRouters=[],this.loadRouters=[]}return IORouterRegistry.getInstance=function(){return null==IORouterRegistry.instance&&(IORouterRegistry.instance=new IORouterRegistry),IORouterRegistry.instance},IORouterRegistry.registerSaveRouter=function(saveRouter){IORouterRegistry.getInstance().saveRouters.push(saveRouter)},IORouterRegistry.registerLoadRouter=function(loadRouter){IORouterRegistry.getInstance().loadRouters.push(loadRouter)},IORouterRegistry.getSaveHandlers=function(url){return IORouterRegistry.getHandlers(url,"save")},IORouterRegistry.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getHandlers(url,"load",onProgress)},IORouterRegistry.getHandlers=function(url,handlerType,onProgress){var validHandlers=[];return("load"===handlerType?IORouterRegistry.getInstance().loadRouters:IORouterRegistry.getInstance().saveRouters).forEach((function(router){var handler=router(url,onProgress);null!==handler&&validHandlers.push(handler)})),validHandlers},IORouterRegistry}();exports.IORouterRegistry=IORouterRegistry,exports.registerSaveRouter=function(loudRouter){return IORouterRegistry.registerSaveRouter(loudRouter)},exports.registerLoadRouter=function(loudRouter){return IORouterRegistry.registerLoadRouter(loudRouter)},exports.getSaveHandlers=function(url){return IORouterRegistry.getSaveHandlers(url)},exports.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getLoadHandlers(url,onProgress)}},{}],124:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.DTYPE_VALUE_SIZE_MAP={float32:4,int32:4,uint16:2,uint8:1,bool:1}},{}],125:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util=require("../util"),io_utils_1=require("./io_utils"),progress_1=require("./progress"),types_1=require("./types");function loadWeightsAsArrayBuffer(fetchURLs,loadOptions){return __awaiter(this,void 0,void 0,(function(){var fetchFunc,requests,fetchStartFraction,fetchEndFraction,_a,bufferPromises,bufferStartFraction,bufferEndFraction,_b;return __generator(this,(function(_c){switch(_c.label){case 0:return null==loadOptions&&(loadOptions={}),fetchFunc=null==loadOptions.fetchFunc?environment_1.env().platform.fetch:loadOptions.fetchFunc,requests=fetchURLs.map((function(fetchURL){return fetchFunc(fetchURL,loadOptions.requestInit,{isBinary:!0})})),fetchStartFraction=0,fetchEndFraction=.5,null!=loadOptions.onProgress?[3,2]:[4,Promise.all(requests)];case 1:return _a=_c.sent(),[3,4];case 2:return[4,progress_1.monitorPromisesProgress(requests,loadOptions.onProgress,fetchStartFraction,fetchEndFraction)];case 3:_a=_c.sent(),_c.label=4;case 4:return bufferPromises=_a.map((function(response){return response.arrayBuffer()})),bufferStartFraction=.5,bufferEndFraction=1,null!=loadOptions.onProgress?[3,6]:[4,Promise.all(bufferPromises)];case 5:return _b=_c.sent(),[3,8];case 6:return[4,progress_1.monitorPromisesProgress(bufferPromises,loadOptions.onProgress,bufferStartFraction,bufferEndFraction)];case 7:_b=_c.sent(),_c.label=8;case 8:return[2,_b]}}))}))}function weightsLoaderFactory(fetchWeightsFunction){var _this=this;return function(manifest,filePathPrefix,weightNames){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(_this,void 0,void 0,(function(){var groupIndicesToFetchMap,groupWeightsToFetch,weightsFound,allManifestWeightNames,weightsNotFound,groupIndicesToFetch,fetchUrls,buffers,weightsTensorMap,bufferIndexOffset;return __generator(this,(function(_a){switch(_a.label){case 0:if(groupIndicesToFetchMap=manifest.map((function(){return!1})),groupWeightsToFetch={},weightsFound=null!=weightNames?weightNames.map((function(){return!1})):[],allManifestWeightNames=[],manifest.forEach((function(manifestGroupConfig,groupIndex){var groupOffset=0;manifestGroupConfig.weights.forEach((function(weightsEntry){var rawDtype="quantization"in weightsEntry?weightsEntry.quantization.dtype:weightsEntry.dtype,weightsBytes=types_1.DTYPE_VALUE_SIZE_MAP[rawDtype]*util.sizeFromShape(weightsEntry.shape),enqueueWeightsForFetchingFn=function(){groupIndicesToFetchMap[groupIndex]=!0,null==groupWeightsToFetch[groupIndex]&&(groupWeightsToFetch[groupIndex]=[]),groupWeightsToFetch[groupIndex].push({manifestEntry:weightsEntry,groupOffset:groupOffset,sizeBytes:weightsBytes})};null!=weightNames?weightNames.forEach((function(weightName,weightIndex){weightName===weightsEntry.name&&(enqueueWeightsForFetchingFn(),weightsFound[weightIndex]=!0)})):enqueueWeightsForFetchingFn(),allManifestWeightNames.push(weightsEntry.name),groupOffset+=weightsBytes}))})),!weightsFound.every((function(found){return found})))throw weightsNotFound=weightNames.filter((function(_,i){return!weightsFound[i]})),new Error("Could not find weights in manifest with names: "+weightsNotFound.join(", ")+". \nManifest JSON has weights with names: "+allManifestWeightNames.join(", ")+".");return groupIndicesToFetch=groupIndicesToFetchMap.reduce((function(accumulator,shouldFetch,i){return shouldFetch&&accumulator.push(i),accumulator}),[]),fetchUrls=[],groupIndicesToFetch.forEach((function(i){manifest[i].paths.forEach((function(filepath){var fetchUrl=filePathPrefix+(filePathPrefix.endsWith("/")?"":"/")+filepath;fetchUrls.push(fetchUrl)}))})),[4,fetchWeightsFunction(fetchUrls)];case 1:return buffers=_a.sent(),weightsTensorMap={},bufferIndexOffset=0,groupIndicesToFetch.forEach((function(i){for(var numBuffers=manifest[i].paths.length,groupBytes=0,i_1=0;i_1<numBuffers;i_1++)groupBytes+=buffers[bufferIndexOffset+i_1].byteLength;for(var groupBuffer=new ArrayBuffer(groupBytes),groupByteBuffer=new Uint8Array(groupBuffer),groupBufferOffset=0,i_2=0;i_2<numBuffers;i_2++){var buffer=new Uint8Array(buffers[bufferIndexOffset+i_2]);groupByteBuffer.set(buffer,groupBufferOffset),groupBufferOffset+=buffer.byteLength}groupWeightsToFetch[i].forEach((function(weightsEntry){var byteBuffer=groupBuffer.slice(weightsEntry.groupOffset,weightsEntry.groupOffset+weightsEntry.sizeBytes),nameToTensorMap=io_utils_1.decodeWeights(byteBuffer,[weightsEntry.manifestEntry]);for(var name_1 in nameToTensorMap)weightsTensorMap[name_1]=nameToTensorMap[name_1]})),bufferIndexOffset+=numBuffers})),[2,weightsTensorMap]}}))}))}}exports.loadWeightsAsArrayBuffer=loadWeightsAsArrayBuffer,exports.loadWeights=function(manifest,filePathPrefix,weightNames,requestInit){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,weightsLoaderFactory((function(fetchUrls){return loadWeightsAsArrayBuffer(fetchUrls,{requestInit:requestInit})}))(manifest,filePathPrefix,weightNames)]}))}))},exports.weightsLoaderFactory=weightsLoaderFactory},{"../environment":107,"../util":214,"./io_utils":118,"./progress":122,"./types":124}],126:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SquaredDifference="SquaredDifference",exports.Square="Square",exports.NonMaxSuppressionV5="NonMaxSuppressionV5",exports.FromPixels="FromPixels"},{}],127:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var kernelRegistry=new Map,gradRegistry=new Map;function makeKey(kernelName,backendName){return backendName+"_"+kernelName}exports.getKernel=function(kernelName,backendName){var key=makeKey(kernelName,backendName);return kernelRegistry.get(key)},exports.getGradient=function(kernelName){return gradRegistry.get(kernelName)},exports.getKernelsForBackend=function(backendName){for(var it=kernelRegistry.entries(),result=[];;){var _a=it.next(),done=_a.done,value=_a.value;if(done)break;var key=value[0],config=value[1];key.split("_")[0]===backendName&&result.push(config)}return result},exports.registerKernel=function(config){var kernelName=config.kernelName,backendName=config.backendName,key=makeKey(kernelName,backendName);if(kernelRegistry.has(key))throw new Error("The kernel '"+kernelName+"' for backend '"+backendName+"' is already registered");kernelRegistry.set(key,config)},exports.registerGradient=function(config){var kernelName=config.kernelName;gradRegistry.has(kernelName)&&console.warn("Overriding the gradient for '"+kernelName+"'"),gradRegistry.set(kernelName,config)},exports.unregisterKernel=function(kernelName,backendName){var key=makeKey(kernelName,backendName);if(!kernelRegistry.has(key))throw new Error("The kernel '"+kernelName+"' for backend '"+backendName+"' is not registered");kernelRegistry.delete(key)},exports.unregisterGradient=function(kernelName){if(!gradRegistry.has(kernelName))throw new Error("The gradient '"+kernelName+"' for backend is not registered");gradRegistry.delete(kernelName)}},{}],128:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");exports.warn=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.env().getBool("IS_TEST")||console.warn.apply(console,msg)},exports.log=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.env().getBool("IS_TEST")||console.log.apply(console,msg)}},{"./environment":107}],129:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var confusion_matrix_1=require("./ops/confusion_matrix");exports.confusionMatrix=confusion_matrix_1.confusionMatrix},{"./ops/confusion_matrix":142}],130:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util_1=require("./axis_util"),concat_split_1=require("./concat_split"),operation_1=require("./operation"),rand_1=require("./rand"),tensor_ops_1=require("./tensor_ops");function buffer(shape,dtype,values){return void 0===dtype&&(dtype="float32"),dtype=dtype||"float32",util.assertNonNegativeIntegerDimensions(shape),new tensor_1.TensorBuffer(shape,dtype,values)}exports.buffer=buffer,exports.print=function(x,verbose){void 0===verbose&&(verbose=!1),console.log(x.toString(verbose))},exports.batchToSpaceND=operation_1.op({batchToSpaceND_:function(x,blockShape,crops){var $x=tensor_util_env_1.convertToTensor(x,"x","batchToSpaceND"),prod=blockShape.reduce((function(a,b){return a*b}));return util.assert($x.rank>=1+blockShape.length,(function(){return"input rank is "+$x.rank+" but should be > than blockShape.length "+blockShape.length})),util.assert(crops.length===blockShape.length,(function(){return"crops.length is "+crops.length+" but should be equal to blockShape.length  "+blockShape.length})),util.assert($x.shape[0]%prod==0,(function(){return"input tensor batch is "+$x.shape[0]+" but is not divisible by the product of the elements of blockShape "+blockShape.join(" * ")+" === "+prod})),engine_1.ENGINE.runKernelFunc((function(backend){return backend.batchToSpaceND($x,blockShape,crops)}),{$x:$x},(function(dy){return{$x:function(){return dy.spaceToBatchND(blockShape,crops)}}}))}}),exports.broadcastTo=operation_1.op({broadcastTo_:function(x,shape){var input=tensor_util_env_1.convertToTensor(x,"broadcastTo","x"),xShape=input.shape;if(shape.some((function(d){return!(d>0)||d%1!=0})))throw new Error("broadcastTo(): Invalid broadcast shape ["+shape+"].");if(shape.length<input.rank)throw new Error("broadcastTo(): shape.length="+shape.length+" < input.rank="+input.rank+".");if(shape.length>input.rank){for(var newShape=input.shape.slice();newShape.length<shape.length;)newShape.unshift(1);input=input.reshape(newShape)}for(var reps=Array.from(shape),i=shape.length-1;i>=0;i--)if(input.shape[i]===shape[i])reps[i]=1;else if(1!==input.shape[i])throw new Error("broadcastTo(): ["+xShape+"] cannot be broadcast to ["+shape+"].");var axes=reps.map((function(n,i){return n>1?i:-1})).filter((function(i){return i>=0}));return 0===axes.length?input.clone():engine_1.ENGINE.runKernelFunc((function(backend){return backend.tile(input,reps)}),{input:input},(function(dy){return{input:function(){return dy.sum(axes,!0)}}}))}}),exports.cast=operation_1.op({cast_:function(x,dtype){var $x=tensor_util_env_1.convertToTensor(x,"x","cast");if(!util.isValidDtype(dtype))throw new Error("Failed to cast to unknown dtype "+dtype);if("string"===dtype&&"string"!==$x.dtype||"string"!==dtype&&"string"===$x.dtype)throw new Error("Only strings can be casted to strings");var attrs={dtype:dtype};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.cast($x,dtype)}),{x:$x},(function(dy){return{x:function(){return dy.clone()}}}),"Cast",attrs)}}),exports.clone=operation_1.op({clone_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","clone",null);return engine_1.ENGINE.runKernelFunc((function(){return engine_1.ENGINE.makeTensorFromDataId($x.dataId,$x.shape,$x.dtype)}),{$x:$x},(function(dy){return{$x:function(){return dy.toFloat()}}}))}}),exports.cumsum=operation_1.op({cumsum_:function(x,axis,exclusive,reverse){void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","cumsum");axis|=0;var permutation=axis_util_1.getAxesPermutation([axis],$x.rank),permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation));var permutedAxis=axis_util_1.getInnerMostAxes(1,$x.rank)[0],value=engine_1.ENGINE.runKernelFunc((function(backend){return backend.cumsum(permutedX,permutedAxis,exclusive,reverse)}),{permutedX:permutedX},(function(dy){return{permutedX:function(){return dy.cumsum(axis,exclusive,!reverse)}}}));return null!=permutation&&(value=value.transpose(permutation)),value}}),exports.depthToSpace=operation_1.op({depthToSpace_:function(x,blockSize,dataFormat){void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","depthToSpace"),inputHeight="NHWC"===dataFormat?$x.shape[1]:$x.shape[2],inputWidth="NHWC"===dataFormat?$x.shape[2]:$x.shape[3],inputDepth="NHWC"===dataFormat?$x.shape[3]:$x.shape[1];return util.assert(inputHeight*blockSize>=0,(function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputHeight+" and "+blockSize+"  for depthToSpace with input shape\n      "+$x.shape})),util.assert(inputWidth*blockSize>=0,(function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputWidth+" and "+blockSize+" for depthToSpace with input shape\n          "+$x.shape})),util.assert(inputDepth%(blockSize*blockSize)==0,(function(){return"Dimension size must be evenly divisible by "+blockSize*blockSize+" but is "+inputDepth+" for depthToSpace with input shape "+$x.shape})),engine_1.ENGINE.runKernelFunc((function(backend){return backend.depthToSpace($x,blockSize,dataFormat)}),{$x:$x})}}),exports.expandDims=operation_1.op({expandDims_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","expandDims",null);util.assert(axis<=$x.rank,(function(){return"Axis must be <= rank of the tensor"}));var newShape=$x.shape.slice();return axis<0&&(util.assert(-($x.rank+1)<=axis,(function(){return"Axis must be in the interval ["+-($x.rank+1)+", "+$x.rank+"]"})),axis=$x.rank+axis+1),newShape.splice(axis,0,1),exports.reshape($x,newShape)}}),exports.eye=operation_1.op({eye_:function(numRows,numColumns,batchShape,dtype){void 0===dtype&&(dtype="float32"),null==numColumns&&(numColumns=numRows);for(var buff=buffer([numRows,numColumns],dtype),n=numRows<=numColumns?numRows:numColumns,i=0;i<n;++i)buff.set(1,i,i);var out=buff.toTensor().as2D(numRows,numColumns);if(null==batchShape)return out;if(1===batchShape.length)return exports.tile(exports.expandDims(out,0),[batchShape[0],1,1]);if(2===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(out,0),0),[batchShape[0],batchShape[1],1,1]);if(3===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(exports.expandDims(out,0),0),0),[batchShape[0],batchShape[1],batchShape[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+batchShape.length+"D.")}}),exports.multinomial=operation_1.op({multinomial_:function(logits,numSamples,seed,normalized){void 0===normalized&&(normalized=!1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","multinomial"),numOutcomes=$logits.size,origRank=$logits.rank;if(numOutcomes<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+numOutcomes+".");if(origRank>2)throw new Error("Rank of probabilities must be 1 or 2, but is "+origRank);seed=seed||Math.random();var logits2D=1===origRank?$logits.as2D(1,-1):$logits,res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.multinomial(logits2D,normalized,numSamples,seed)}),{logits2D:logits2D});return 1===origRank?res.as1D():res}}),exports.oneHot=operation_1.op({oneHot_:function(indices,depth,onValue,offValue){if(void 0===onValue&&(onValue=1),void 0===offValue&&(offValue=0),depth<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+depth);var $indices=tensor_util_env_1.convertToTensor(indices,"indices","oneHot","int32"),outShape=$indices.shape.concat([depth]);return $indices=$indices.flatten(),engine_1.ENGINE.runKernelFunc((function(backend){return backend.oneHot($indices,depth,onValue,offValue)}),{$indices:$indices},(function(dy){return{$indices:function(){return tensor_ops_1.zeros($indices.shape,"float32")}}})).reshape(outShape)}}),exports.pad=operation_1.op({pad_:function(x,paddings,constantValue){void 0===constantValue&&(constantValue=0);var $x=tensor_util_env_1.convertToTensor(x,"x","pad");if(0===$x.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");var attrs={paddings:paddings,constantValue:constantValue};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.pad($x,paddings,constantValue)}),{x:$x},(function(dy){var begin=paddings.map((function(p){return p[0]}));return{x:function(){return dy.slice(begin,$x.shape)}}}),"PadV2",attrs)}}),exports.pad1d=operation_1.op({pad1d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length,(function(){return"Invalid number of paddings. Must be length of 2."})),exports.pad(x,[paddings],constantValue)}}),exports.pad2d=operation_1.op({pad2d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length&&2===paddings[0].length&&2===paddings[1].length,(function(){return"Invalid number of paddings. Must be length of 2 each."})),exports.pad(x,paddings,constantValue)}}),exports.pad3d=operation_1.op({pad3d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(3===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length,(function(){return"Invalid number of paddings. Must be length of 2 each."})),exports.pad(x,paddings,constantValue)}}),exports.pad4d=operation_1.op({pad4d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(4===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length&&2===paddings[3].length,(function(){return"Invalid number of paddings. Must be length of 2 each."})),exports.pad(x,paddings,constantValue)}}),exports.rand=operation_1.op({rand_:function(shape,randFunction,dtype){var size=util.sizeFromShape(shape),values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}for(var i=0;i<size;i++)values[i]=randFunction();return engine_1.ENGINE.makeTensor(values,shape,dtype)}}),exports.randomNormal=operation_1.op({randomNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!1,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.randomGamma=operation_1.op({randomGamma_:function(shape,alpha,beta,dtype,seed){if(void 0===beta&&(beta=1),void 0===dtype&&(dtype="float32"),null==beta&&(beta=1),null==dtype&&(dtype="float32"),"float32"!==dtype&&"int32"!==dtype)throw new Error("Unsupported data type "+dtype);for(var rgamma=new rand_1.RandGamma(alpha,beta,dtype,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=rgamma.nextValue();return res.toTensor()}}),exports.randomUniform=operation_1.op({randomUniform_:function(shape,minval,maxval,dtype,seed){void 0===minval&&(minval=0),void 0===maxval&&(maxval=1),void 0===dtype&&(dtype="float32");for(var res=buffer(shape,dtype),random=new rand_1.UniformRandom(minval,maxval,null,seed),i=0;i<res.values.length;i++)res.values[i]=random.nextValue();return res.toTensor()}}),exports.reshape=operation_1.op({reshape_:function(x,shape){var $x=tensor_util_env_1.convertToTensor(x,"x","reshape",null);shape=util.inferFromImplicitShape(shape,$x.size),util.assert($x.size===util.sizeFromShape(shape),(function(){return"new shape and old shape must have the same number of elements."}));var attrs={shape:shape};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.reshape($x,shape)}),{x:$x},(function(dy){return{x:function(){return dy.reshape($x.shape)}}}),"Reshape",attrs)}}),exports.spaceToBatchND=operation_1.op({spaceToBatchND_:function(x,blockShape,paddings){var $x=tensor_util_env_1.convertToTensor(x,"x","spaceToBatchND");return util.assert($x.rank>=1+blockShape.length,(function(){return"input rank "+$x.rank+" should be > than [blockShape] "+blockShape.length})),util.assert(paddings.length===blockShape.length,(function(){return"paddings.shape[0] "+paddings.length+" must be equal to [blockShape] "+blockShape.length})),util.assert($x.shape.reduce((function(a,b,i){return i>0&&i<=blockShape.length?a&&(b+paddings[i-1][0]+paddings[i-1][1])%blockShape[i-1]==0:a}),!0),(function(){return"input spatial dimensions "+$x.shape.slice(1)+" with paddings "+paddings.toString()+" must be divisible by blockShapes "+blockShape.toString()})),engine_1.ENGINE.runKernelFunc((function(backend){return backend.spaceToBatchND($x,blockShape,paddings)}),{$x:$x},(function(dy){return{$x:function(){return dy.batchToSpaceND(blockShape,paddings)}}}))}}),exports.squeeze=operation_1.op({squeeze_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","squeeze");return exports.reshape($x,util.squeezeShape($x.shape,axis).newShape)}}),exports.stack=operation_1.op({stack_:function(tensors,axis){void 0===axis&&(axis=0);var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","stack");if(util.assert($tensors.length>=1,(function(){return"Pass at least one tensor to tf.stack"})),1===$tensors.length)return $tensors[0].expandDims(axis);var rank=$tensors[0].rank,shape=$tensors[0].shape,dtype=$tensors[0].dtype;util.assert(axis<=rank,(function(){return"Axis must be <= rank of the tensor"})),$tensors.forEach((function(t){util.assertShapesMatch(shape,t.shape,"All tensors passed to stack must have matching shapes")})),$tensors.forEach((function(t){util.assert(dtype===t.dtype,(function(){return"All tensors passed to stack must have matching dtypes"}))}));var expandedTensors=$tensors.map((function(t){return t.expandDims(axis)}));return concat_split_1.concat(expandedTensors,axis)}}),exports.tile=operation_1.op({tile_:function(x,reps){var $x=tensor_util_env_1.convertToTensor(x,"x","tile",null);util.assert($x.rank===reps.length,(function(){return"Error in transpose: rank of input "+$x.rank+" must match length of reps "+reps+"."}));var inputsToSave=[$x],attrs={reps:reps};return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.tile($x,reps);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){var xGrad=tensor_ops_1.zerosLike($x);if(1===$x.rank)for(var i=0;i<reps[0];++i)xGrad=xGrad.add(dy.slice([i*$x.shape[0]],[$x.shape[0]]));else if(2===$x.rank)for(i=0;i<reps[0];++i)for(var j=0;j<reps[1];++j)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1]],[$x.shape[0],$x.shape[1]]));else if(3===$x.rank)for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(var k=0;k<reps[2];++k)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2]],[$x.shape[0],$x.shape[1],$x.shape[2]]));else{if(4!==$x.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+$x.rank+" tensors yet.");for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(k=0;k<reps[2];++k)for(var l=0;l<reps[3];++l)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2],l*$x.shape[3]],[$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3]]))}return xGrad}}}),"Tile",attrs,inputsToSave)}}),exports.truncatedNormal=operation_1.op({truncatedNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!0,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.unstack=operation_1.op({unstack_:function(x,axis){void 0===axis&&(axis=0),axis=axis||0;var $x=tensor_util_env_1.convertToTensor(x,"x","unstack");util.assert(axis>=-$x.shape.length&&axis<$x.shape.length,(function(){return"Axis = "+axis+" is not in [-"+$x.shape.length+", "+$x.shape.length+")"})),axis<0&&(axis+=$x.shape.length);var attrs={axis:axis};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.unstack($x,axis)}),{x:$x},(function(dy){return{x:function(){return exports.stack(dy,axis)}}}),"Unpack",attrs)}}),exports.setdiff1dAsync=function(x,y){return __awaiter(this,void 0,void 0,(function(){var $x,$y,xVals,yVals,ySet,outputSize,buffer,indices,i,p;return __generator(this,(function(_a){switch(_a.label){case 0:return $x=tensor_util_env_1.convertToTensor(x,"x","setdiff1d"),$y=tensor_util_env_1.convertToTensor(y,"y","setdiff1d"),util.assert($x.dtype===$y.dtype,(function(){return"x and y should have the same dtype, but got x ("+$x.dtype+") and y ("+$y.dtype+")."})),util.assert(1===$x.rank,(function(){return"x should be 1D tensor, but got x ("+$x.shape+")."})),util.assert(1===$y.rank,(function(){return"y should be 1D tensor, but got y ("+$y.shape+")."})),[4,$x.data()];case 1:return xVals=_a.sent(),[4,$y.data()];case 2:for(yVals=_a.sent(),ySet=new Set(yVals),outputSize=0,i=0;i<xVals.length;i++)ySet.has(xVals[i])||outputSize++;for(buffer=new tensor_1.TensorBuffer([outputSize],$x.dtype),indices=new tensor_1.TensorBuffer([outputSize],"int32"),i=0,p=0;i<xVals.length;i++)ySet.has(xVals[i])||(buffer.values[p]=xVals[i],indices.values[p]=i,p++);return[2,[buffer.toTensor(),indices.toTensor()]]}}))}))}},{"../engine":106,"../tensor":207,"../tensor_util_env":210,"../util":214,"./axis_util":132,"./concat_split":140,"./operation":163,"./rand":166,"./tensor_ops":186}],131:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.getReshaped=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshaped=[];if(batchToSpace)(reshaped=reshaped.concat(blockShape.slice(0))).push(inputShape[0]/prod),reshaped=reshaped.concat(inputShape.slice(1));else{reshaped=reshaped.concat(inputShape[0]);for(var spatialLength=blockShape.length,i=0;i<spatialLength;++i)reshaped=reshaped.concat([inputShape[i+1]/blockShape[i],blockShape[i]]);reshaped=reshaped.concat(inputShape.slice(spatialLength+1))}return reshaped},exports.getPermuted=function(reshapedRank,blockShapeRank,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var permuted=[];if(batchToSpace){permuted.push(blockShapeRank);for(var i=blockShapeRank+1;i<reshapedRank;++i)i<=2*blockShapeRank?(permuted.push(i),permuted.push(i-(blockShapeRank+1))):permuted.push(i)}else{var permutedBeforeBatch=[],permutedAfterBatch=[];for(i=1;i<reshapedRank;++i)i>=2*blockShapeRank+1||i%2==1?permutedAfterBatch.push(i):permutedBeforeBatch.push(i);permuted.push.apply(permuted,permutedBeforeBatch),permuted.push(0),permuted.push.apply(permuted,permutedAfterBatch)}return permuted},exports.getReshapedPermuted=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshapedPermuted=[];batchToSpace?reshapedPermuted.push(inputShape[0]/prod):reshapedPermuted.push(inputShape[0]*prod);for(var i=1;i<inputShape.length;++i)i<=blockShape.length?batchToSpace?reshapedPermuted.push(blockShape[i-1]*inputShape[i]):reshapedPermuted.push(inputShape[i]/blockShape[i-1]):reshapedPermuted.push(inputShape[i]);return reshapedPermuted},exports.getSliceBeginCoords=function(crops,blockShape){for(var sliceBeginCoords=[0],i=0;i<blockShape;++i)sliceBeginCoords.push(crops[i][0]);return sliceBeginCoords},exports.getSliceSize=function(uncroppedShape,crops,blockShape){for(var sliceSize=uncroppedShape.slice(0,1),i=0;i<blockShape;++i)sliceSize.push(uncroppedShape[i+1]-crops[i][0]-crops[i][1]);return sliceSize}},{}],132:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function axesAreInnerMostDims(axes,rank){for(var i=0;i<axes.length;++i)if(axes[axes.length-i-1]!==rank-1-i)return!1;return!0}function combineLocations(outputLoc,reduceLoc,axes){for(var rank=outputLoc.length+reduceLoc.length,loc=[],outIdx=0,reduceIdx=0,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)?loc.push(outputLoc[outIdx++]):loc.push(reduceLoc[reduceIdx++]);return loc}exports.axesAreInnerMostDims=axesAreInnerMostDims,exports.combineLocations=combineLocations,exports.computeOutAndReduceShapes=function(aShape,axes){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)&&outShape.push(aShape[dim]);var reduceShape=axes.map((function(dim){return aShape[dim]}));return[outShape,reduceShape]},exports.expandShapeToKeepDim=function(shape,axes){return combineLocations(shape,axes.map((function(x){return 1})),axes)},exports.assertAxesAreInnerMostDims=function(msg,axes,rank){util.assert(axesAreInnerMostDims(axes,rank),(function(){return msg+" supports only inner-most axes for now. Got axes "+axes+" and rank-"+rank+" input."}))},exports.getAxesPermutation=function(axes,rank){if(axesAreInnerMostDims(axes,rank))return null;for(var result=[],i=0;i<rank;++i)-1===axes.indexOf(i)&&result.push(i);return axes.forEach((function(axis){return result.push(axis)})),result},exports.getUndoAxesPermutation=function(axes){return axes.map((function(axis,i){return[i,axis]})).sort((function(a,b){return a[1]-b[1]})).map((function(x){return x[0]}))},exports.getInnerMostAxes=function(numAxes,rank){for(var res=[],i=rank-numAxes;i<rank;++i)res.push(i);return res}},{"../util":214}],133:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");function batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(2===$x.rank,(function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."})),util.assert(2===$mean.rank||1===$mean.rank,(function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+$mean.rank+"."})),util.assert(2===$variance.rank||1===$variance.rank,(function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+$variance.rank+"."})),null!=$scale&&util.assert(2===$scale.rank||1===$scale.rank,(function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+$scale.rank+"."})),null!=$offset&&util.assert(2===$offset.rank||1===$offset.rank,(function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+$offset.rank+"."})),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(3===$x.rank,(function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."})),util.assert(3===$mean.rank||1===$mean.rank,(function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+$mean.rank+"."})),util.assert(3===$variance.rank||1===$variance.rank,(function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+$variance.rank+"."})),null!=$scale&&util.assert(3===$scale.rank||1===$scale.rank,(function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+$scale.rank+"."})),null!=$offset&&util.assert(3===$offset.rank||1===$offset.rank,(function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+$offset.rank+"."})),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(4===$x.rank,(function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+$x.rank+"."})),util.assert(4===$mean.rank||1===$mean.rank,(function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+$mean.rank+"."})),util.assert(4===$variance.rank||1===$variance.rank,(function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+$variance.rank+"."})),null!=$scale&&util.assert(4===$scale.rank||1===$scale.rank,(function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+$scale.rank+"."})),null!=$offset&&util.assert(4===$offset.rank||1===$offset.rank,(function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+$offset.rank+"."})),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm_(x,mean,variance,offset,scale,varianceEpsilon){null==varianceEpsilon&&(varianceEpsilon=.001);var $scale,$offset,x4D,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert($mean.rank===$variance.rank,(function(){return"Batch normalization gradient requires mean and variance to have equal ranks."})),util.assert(null==$offset||$mean.rank===$offset.rank,(function(){return"Batch normalization gradient requires mean and offset to have equal ranks."})),util.assert(null==$scale||$mean.rank===$scale.rank,(function(){return"Batch normalization gradient requires mean and scale to have equal ranks."})),x4D=0===$x.rank||1===$x.rank?$x.as4D(1,1,1,$x.size):2===$x.rank?$x.as4D(1,1,$x.shape[0],$x.shape[1]):3===$x.rank?$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]):$x;var inputsToSave=[$x,$mean,$variance,$scale],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.batchNormalization(x4D,batchnormReshape4D($mean),batchnormReshape4D($variance),varianceEpsilon,batchnormReshape4D($scale),batchnormReshape4D($offset));return save([$x,$mean,$variance,$scale]),res}),{x:$x,mean:$mean,variance:$variance,scale:$scale,offset:$offset},(function(dy,saved){var _a=saved,$x=_a[0],$mean=_a[1],$variance=_a[2],$scale=_a[3],scaleValue=null==$scale?tensor_ops_1.scalar(1):$scale,reductionAxes=broadcast_util_1.getReductionAxes($mean.shape,x4D.shape),tileShape=[];if(1===$mean.rank){for(var i=0;i<x4D.shape.length-1;++i)tileShape.push(x4D.shape[i]);tileShape.push(1)}var xMinusMean=$x.sub($mean),dyTimesScaleValue=dy.mul(scaleValue),oneOverSqrtVariance=unary_ops_1.rsqrt($variance.add(tensor_ops_1.scalar(varianceEpsilon))),minusHalfRCube=oneOverSqrtVariance.mul(oneOverSqrtVariance).mul(oneOverSqrtVariance).mul(tensor_ops_1.scalar(-.5));return{x:function(){return 1===$mean.rank?dy.mul(array_ops_1.tile(oneOverSqrtVariance.as4D(1,1,1,$mean.shape[0]),tileShape)).mul(scaleValue).reshape($x.shape):dy.mul(oneOverSqrtVariance).mul(scaleValue).reshape($x.shape)},mean:function(){var meanDer=oneOverSqrtVariance.mul(tensor_ops_1.scalar(-1)).mul(dyTimesScaleValue);return 1===$mean.rank&&(meanDer=meanDer.sum(reductionAxes)),meanDer.reshape($mean.shape)},variance:function(){var varianceDer=minusHalfRCube.mul(xMinusMean).mul(dyTimesScaleValue);return 1===$mean.rank&&(varianceDer=varianceDer.sum(reductionAxes)),varianceDer.reshape($mean.shape)},scale:function(){var xMinusMean2TimesRsqrt=xMinusMean.mul(oneOverSqrtVariance),scaleDer=dy.mul(xMinusMean2TimesRsqrt);return 1===$mean.rank&&(scaleDer=scaleDer.sum(reductionAxes)),scaleDer.reshape($mean.shape)},offset:function(){var offsetDer=dy;return 1===$mean.rank&&(offsetDer=offsetDer.sum(reductionAxes)),offsetDer.reshape($mean.shape)}}}),"BatchNormalization",{varianceEpsilon:varianceEpsilon},inputsToSave);return res.reshape($x.shape)}function batchnormReshape4D(x){return null==x?null:0===x.rank?x.as1D():1===x.rank?x:2===x.rank?x.as4D(1,1,x.shape[0],x.shape[1]):3===x.rank?x.as4D(1,x.shape[0],x.shape[1],x.shape[2]):x}function warnDeprecation(){globals_1.deprecationWarn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}exports.batchNormalization2d=operation_1.op({batchNormalization2d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization3d=operation_1.op({batchNormalization3d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization4d=operation_1.op({batchNormalization4d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization=operation_1.op({batchNormalization_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNorm=operation_1.op({batchNorm_:batchNorm_}),exports.batchNorm2d=operation_1.op({batchNorm2d_:batchNorm2d_}),exports.batchNorm3d=operation_1.op({batchNorm3d_:batchNorm3d_}),exports.batchNorm4d=operation_1.op({batchNorm4d_:batchNorm4d_})},{"../engine":106,"../globals":109,"../tensor_util_env":210,"../util":214,"./array_ops":130,"./broadcast_util":136,"./operation":163,"./tensor_ops":186,"./unary_ops":189}],134:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),broadcast_util=require("./broadcast_util"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");exports.add=operation_1.op({add_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","add"),$b=tensor_util_env_1.convertToTensor(b,"b","add");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.add($a,$b)}),{a:$a,b:$b},(function(dy){return{a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}}),"Add")}}),exports.addN=operation_1.op({addN_:function(tensors){util.assert(Array.isArray(tensors),(function(){return"The argument passed to tf.addN() must be a list of tensors"})),util.assert(tensors.length>=1,(function(){return"Must pass at least one tensor to tf.addN(), but got "+tensors.length}));var $tensors=tensors.map((function(t,i){return tensor_util_env_1.convertToTensor(t,"tensors"+i,"addN")})),firstTensor=$tensors[0];$tensors.forEach((function(t){if(t.dtype!==firstTensor.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")})),$tensors.forEach((function(t){if(!util.arraysEqual(t.shape,firstTensor.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")}));var inputs=$tensors;return engine_1.ENGINE.runKernelFunc((function(backend){return backend.addN($tensors)}),inputs,(function(dy){var ders={};return $tensors.forEach((function(t,i){ders[i]=function(){return dy.clone()}})),ders}),"AddN")}}),exports.addStrict=operation_1.op({addStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","addStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","addStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in addStrict: "),$a.add($b)}}),exports.atan2=operation_1.op({atan2_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","atan2"),$b=tensor_util_env_1.convertToTensor(b,"b","atan2");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.atan2($a,$b);return save([$a,$b]),res}),{$a:$a,$b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var d=exports.add($a.square(),$b.square()),res=dy.mul($b.div(d)),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var d=exports.add($a.square(),$b.square()),res=unary_ops_1.neg(dy.mul($a.div(d))),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}}))}}),exports.div=operation_1.op({div_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");if(_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"int32"===$a.dtype&&"int32"===$b.dtype)return exports.floorDiv($a,$b);var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.realDivide($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0?res.sum(reduceAxes).reshape($a.shape):res},b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);reduceAxes.length>0&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}}),"Div")}}),exports.divNoNan=operation_1.op({divNoNan_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");$a=(_a=tensor_util_1.makeTypesMatch($a,$b))[0],$b=_a[1];var divResult=exports.div($a,$b),zeros=tensor_ops_1.zerosLike(divResult),bEqualsZero=$b.equal(zeros);return logical_ops_1.where(bEqualsZero,zeros,divResult)}}),exports.divStrict=operation_1.op({divStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");return util.assertShapesMatch($a.shape,$b.shape,"Error in divideStrict: "),$a.div($b)}}),exports.floorDiv=operation_1.op({floorDiv_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","floorDiv"),$b=tensor_util_env_1.convertToTensor(b,"b","floorDiv");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.floorDiv($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0?res.sum(reduceAxes).reshape($a.shape):res},b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);reduceAxes.length>0&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}}),"FloorDiv")}}),exports.maximum=operation_1.op({maximum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","maximum"),$b=tensor_util_env_1.convertToTensor(b,"b","maximum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.maximum($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){return dy.mul($a.greaterEqual($b).toFloat())},b:function(){return dy.mul($a.less($b).toFloat())}}}),"Maximum")}}),exports.maximumStrict=operation_1.op({maximumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","maximumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","maximumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in maximumStrict: "),$a.maximum($b)}}),exports.minimum=operation_1.op({minimum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","minimum"),$b=tensor_util_env_1.convertToTensor(b,"b","minimum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.minimum($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){return dy.mul($a.lessEqual($b).toFloat())},b:function(){return dy.mul($a.greater($b).toFloat())}}}),"Minimum")}}),exports.minimumStrict=operation_1.op({minimumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","minimumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","minimumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in minimumStrict: "),$a.minimum($b)}}),exports.mod=operation_1.op({mod_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mod"),$b=tensor_util_env_1.convertToTensor(b,"b","mod");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.mod($a,$b);return save([$a,$b]),res}),{$a:$a,$b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0?dy.sum(reduceAxes).reshape($a.shape):dy},$b:function(){var res=dy.mul($a.div($b).floor().neg()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return reduceAxes.length>0?res.sum(reduceAxes).reshape($b.shape):res}}}))}}),exports.modStrict=operation_1.op({modStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","modStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","modStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in modStrict: "),$a.mod($b)}}),exports.mul=operation_1.op({mul_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.multiply($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){var res=dy.mul($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0?res.sum(reduceAxes).reshape($a.shape):res},b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return reduceAxes.length>0?res.sum(reduceAxes).reshape($b.shape):res}}}),"Mul")}}),exports.mulStrict=operation_1.op({mulStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");return util.assertShapesMatch($a.shape,$b.shape,"Error in multiplyStrict: "),$a.mul($b)}}),exports.pow=operation_1.op({pow_:function(base,exp){var _a,$base=tensor_util_env_1.convertToTensor(base,"base","pow"),$exp=tensor_util_env_1.convertToTensor(exp,"exp","pow");_a=tensor_util_1.makeTypesMatch($base,$exp),$base=_a[0],$exp=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($base.shape,$exp.shape),inputsToSave=[$base,$exp];return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.pow($base,$exp);return save([$base,$exp,y]),y}),{a:$base,b:$exp},(function(dy,saved){var $base=saved[0],$exp=saved[1],y=saved[2];return{a:function(){var expFloat=$exp.toFloat(),res=dy.mul(expFloat.mul($base.pow(expFloat.sub(tensor_ops_1.scalar(1))))),reduceAxes=broadcast_util.getReductionAxes($base.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($base.shape)},b:function(){var condition=$base.greater(0),logBase=$base.log().where(condition,tensor_ops_1.zerosLike($base)),res=dy.mul(y.mul(logBase)),reduceAxes=broadcast_util.getReductionAxes($exp.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($exp.shape)}}}),"Pow",{},inputsToSave,[!0])}}),exports.powStrict=operation_1.op({powStrict_:function(base,exp){return util.assertShapesMatch(base.shape,exp.shape,"Error in powStrict: "),base.pow(exp)}}),exports.squaredDifferenceStrict=operation_1.op({squaredDifferenceStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","squaredDifferenceStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifferenceStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in squaredDifferenceStrict: "),$a.squaredDifference($b)}}),exports.sub=operation_1.op({sub_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","sub"),$b=tensor_util_env_1.convertToTensor(b,"b","sub");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.subtract($a,$b)}),{a:$a,b:$b},(function(dy){return{a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.neg().reshape($b.shape)}}}),"Sub")}}),exports.subStrict=operation_1.op({subStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","subStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","subStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in subStrict: "),$a.sub($b)}})},{"../engine":106,"../tensor_util":209,"../tensor_util_env":210,"../util":214,"./broadcast_util":136,"./logical_ops":156,"./operation":163,"./tensor_ops":186,"./unary_ops":189}],135:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),logical_ops_1=require("./logical_ops"),segment_ops_1=require("./segment_ops");exports.booleanMaskAsync=function(tensor,mask,axis){return __awaiter(this,void 0,void 0,(function(){var $tensor,$mask,axisFrom,maskDim,tensorShape,leadingSize,i,targetTensorShape,reshapedTensor,reshapedMask,positivePositions,indices,res;return __generator(this,(function(_a){switch(_a.label){case 0:for($tensor=tensor_util_env_1.convertToTensor(tensor,"tensor","boolMask"),$mask=tensor_util_env_1.convertToTensor(mask,"mask","boolMask","bool"),axisFrom=null==axis?0:axis,maskDim=$mask.rank,tensorShape=$tensor.shape,util.assert(maskDim>0,(function(){return"mask cannot be scalar"})),util.assertShapesMatch(tensorShape.slice(axisFrom,axisFrom+maskDim),$mask.shape,"mask's shape must match the first K dimensions of tensor's shape,"),leadingSize=1,i=axisFrom;i<axisFrom+maskDim;i++)leadingSize*=tensorShape[i];return targetTensorShape=tensorShape.slice(0,axisFrom).concat([leadingSize],tensorShape.slice(axisFrom+maskDim)),reshapedTensor=$tensor.reshape(targetTensorShape),reshapedMask=$mask.reshape([-1]),[4,logical_ops_1.whereAsync(reshapedMask)];case 1:return positivePositions=_a.sent(),indices=positivePositions.squeeze([1]),res=segment_ops_1.gather(reshapedTensor,indices,axisFrom),tensor!==$tensor&&$tensor.dispose(),mask!==$mask&&$mask.dispose(),indices.dispose(),reshapedTensor.dispose(),reshapedMask.dispose(),positivePositions.dispose(),[2,res]}}))}))}},{"../tensor_util_env":210,"../util":214,"./logical_ops":156,"./segment_ops":173}],136:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.getBroadcastDims=function(inShape,outShape){for(var inRank=inShape.length,dims=[],i=0;i<inRank;i++){var dim=inRank-1-i,a=inShape[dim]||1;(outShape[outShape.length-1-i]||1)>1&&1===a&&dims.unshift(dim)}return dims},exports.getReductionAxes=function(inShape,outShape){for(var result=[],i=0;i<outShape.length;i++){var inDim=inShape[inShape.length-i-1],outAxis=outShape.length-i-1,outDim=outShape[outAxis];(null==inDim||1===inDim&&outDim>1)&&result.unshift(outAxis)}return result},exports.assertAndGetBroadcastShape=function(shapeA,shapeB){for(var result=[],l=Math.max(shapeA.length,shapeB.length),i=0;i<l;i++){var a=shapeA[shapeA.length-i-1];null==a&&(a=1);var b=shapeB[shapeB.length-i-1];if(null==b&&(b=1),1===a)result.unshift(b);else if(1===b)result.unshift(a);else{if(a!==b)throw Error("Operands could not be broadcast together with shapes "+shapeA+" and "+shapeB+".");result.unshift(a)}}return result}},{}],137:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var fromPixels2DContext,engine_1=require("../engine"),kernel_registry_1=require("../kernel_registry"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.toPixels=function(img,canvas){return __awaiter(this,void 0,void 0,(function(){var $img,_a,height,width,depth,data,minTensor,maxTensor,vals,minVals,maxVals,min,max,multiplier,bytes,i,r,g,b,a,j,ctx,imageData;return __generator(this,(function(_b){switch(_b.label){case 0:if($img=tensor_util_env_1.convertToTensor(img,"img","toPixels"),img instanceof tensor_1.Tensor||($img=$img.toInt()),2!==$img.rank&&3!==$img.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+$img.rank+".");if(_a=$img.shape.slice(0,2),height=_a[0],width=_a[1],(depth=2===$img.rank?1:$img.shape[2])>4||2===depth)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+depth);return[4,$img.data()];case 1:return data=_b.sent(),minTensor=$img.min(),maxTensor=$img.max(),[4,Promise.all([minTensor.data(),maxTensor.data()])];case 2:if(vals=_b.sent(),minVals=vals[0],maxVals=vals[1],min=minVals[0],max=maxVals[0],minTensor.dispose(),maxTensor.dispose(),"float32"===$img.dtype){if(min<0||max>1)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+min+" - "+max+"].")}else{if("int32"!==$img.dtype)throw new Error("Unsupported type for toPixels: "+$img.dtype+". Please use float32 or int32 tensors.");if(min<0||max>255)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+min+" - "+max+"].")}for(multiplier="float32"===$img.dtype?255:1,bytes=new Uint8ClampedArray(width*height*4),i=0;i<height*width;++i)r=void 0,g=void 0,b=void 0,a=void 0,1===depth?(r=data[i]*multiplier,g=data[i]*multiplier,b=data[i]*multiplier,a=255):3===depth?(r=data[3*i]*multiplier,g=data[3*i+1]*multiplier,b=data[3*i+2]*multiplier,a=255):4===depth&&(r=data[4*i]*multiplier,g=data[4*i+1]*multiplier,b=data[4*i+2]*multiplier,a=data[4*i+3]*multiplier),bytes[(j=4*i)+0]=Math.round(r),bytes[j+1]=Math.round(g),bytes[j+2]=Math.round(b),bytes[j+3]=Math.round(a);return null!=canvas&&(canvas.width=width,canvas.height=height,ctx=canvas.getContext("2d"),imageData=new ImageData(bytes,width,height),ctx.putImageData(imageData,0,0)),$img!==img&&$img.dispose(),[2,bytes]}}))}))},exports.fromPixels=operation_1.op({fromPixels_:function(pixels,numChannels){if(void 0===numChannels&&(numChannels=3),numChannels>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==pixels)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var isPixelData=!1,isImageData=!1,isVideo=!1,isImage=!1,isCanvasLike=!1;if(pixels.data instanceof Uint8Array)isPixelData=!0;else if("undefined"!=typeof ImageData&&pixels instanceof ImageData)isImageData=!0;else if("undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement)isVideo=!0;else if("undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement)isImage=!0;else{if(null==pixels.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+pixels.constructor.name);isCanvasLike=!0}if(isVideo){if(isVideo&&pixels.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.")}if(null!=kernel_registry_1.getKernel("FromPixels",engine_1.ENGINE.backendName))return engine_1.ENGINE.runKernel("FromPixels",{pixels:pixels},{numChannels:numChannels});var vals,values,_a=isVideo?[pixels.videoWidth,pixels.videoHeight]:[pixels.width,pixels.height],width=_a[0],height=_a[1];if(isCanvasLike?vals=pixels.getContext("2d").getImageData(0,0,width,height).data:isImageData||isPixelData?vals=pixels.data:(isImage||isVideo)&&(null==fromPixels2DContext&&(fromPixels2DContext=document.createElement("canvas").getContext("2d")),fromPixels2DContext.canvas.width=width,fromPixels2DContext.canvas.height=height,fromPixels2DContext.drawImage(pixels,0,0,width,height),vals=fromPixels2DContext.getImageData(0,0,width,height).data),4===numChannels)values=new Int32Array(vals);else{var numPixels=width*height;values=new Int32Array(numPixels*numChannels);for(var i=0;i<numPixels;i++)for(var channel=0;channel<numChannels;++channel)values[i*numChannels+channel]=vals[4*i+channel]}var outShape=[height,width,numChannels];return tensor_ops_1.tensor3d(values,outShape,"int32")}})},{"../engine":106,"../kernel_registry":127,"../tensor":207,"../tensor_util_env":210,"./operation":163,"./tensor_ops":186}],138:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.equal=operation_1.op({equal_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","equal"),$b=tensor_util_env_1.convertToTensor(b,"b","equal");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.equal($a,$b)}),{$a:$a,$b:$b})}}),exports.equalStrict=operation_1.op({equalStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","equalStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","equalStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in equalStrict: "),$a.equal($b)}}),exports.greater=operation_1.op({greater_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greater"),$b=tensor_util_env_1.convertToTensor(b,"b","greater");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.greater($a,$b)}),{a:$a,b:$b},null,"Greater")}}),exports.greaterEqual=operation_1.op({greaterEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greaterEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.greaterEqual($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},(function(dy,saved){var $a=saved[0],$b=saved[1];return{a:function(){return tensor_ops_1.zerosLike($a)},b:function(){return tensor_ops_1.zerosLike($b)}}}),"GreaterEqual")}}),exports.greaterEqualStrict=operation_1.op({greaterEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterEqualStrict: "),$a.greaterEqual($b)}}),exports.greaterStrict=operation_1.op({greaterStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterStrict: "),$a.greater($b)}}),exports.less=operation_1.op({less_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","less"),$b=tensor_util_env_1.convertToTensor(b,"b","less");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.less($a,$b)}),{a:$a,b:$b},null,"Less")}}),exports.lessEqual=operation_1.op({lessEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","lessEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.lessEqual($a,$b);return save([$a,$b]),res}),{a:$a,b:$b},null,"LessEqual")}}),exports.lessEqualStrict=operation_1.op({lessEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessEqualStrict: "),$a.lessEqual($b)}}),exports.lessStrict=operation_1.op({lessStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessStrict: "),$a.less($b)}}),exports.notEqual=operation_1.op({notEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","notEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.notEqual($a,$b)}),{a:$a,b:$b},null,"NotEqual")}}),exports.notEqualStrict=operation_1.op({notEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","notEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in notEqualStrict: "),$a.notEqual($b)}})},{"../engine":106,"../tensor_util":209,"../tensor_util_env":210,"../util":214,"./broadcast_util":136,"./operation":163,"./tensor_ops":186}],139:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.complex=operation_1.op({complex_:function(real,imag){var $real=tensor_util_env_1.convertToTensor(real,"real","complex"),$imag=tensor_util_env_1.convertToTensor(imag,"imag","complex");return util.assertShapesMatch($real.shape,$imag.shape,"real and imag shapes, "+$real.shape+" and "+$imag.shape+", must match in call to tf.complex()."),engine_1.ENGINE.runKernelFunc((function(backend){return backend.complex($real,$imag)}),{$real:$real,$imag:$imag})}}),exports.real=operation_1.op({real_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","real");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.real($input)}),{$input:$input})}}),exports.imag=operation_1.op({imag_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","imag");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.imag($input)}),{$input:$input})}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163}],140:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),util_2=require("../util"),concat_util_1=require("./concat_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.concat=operation_1.op({concat_:function(tensors,axis){void 0===axis&&(axis=0),util_1.assert(tensors.length>=1,(function(){return"Pass at least one tensor to concat"}));var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","concat");"complex64"===$tensors[0].dtype&&$tensors.forEach((function(tensor){if("complex64"!==tensor.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+tensor.dtype+". ")})),axis=util_2.parseAxisParam(axis,$tensors[0].shape)[0];var outShape=concat_util_1.computeOutShape($tensors.map((function(t){return t.shape})),axis);if(0===util_1.sizeFromShape(outShape))return tensor_ops_1.tensor([],outShape);if(1===($tensors=$tensors.filter((function(t){return t.size>0}))).length)return $tensors[0];var shapes=$tensors.map((function(t){return t.shape}));concat_util_1.assertParamsConsistent(shapes,axis);var inputs=$tensors,attr={axis:axis};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.concat($tensors,axis)}),inputs,(function(dy){var sizeSplits=shapes.map((function(s){return s[axis]}));return exports.split(dy,sizeSplits,axis).map((function(t){return function(){return t}}))}),"Concat",attr)}}),exports.concat1d=operation_1.op({concat1d_:function(tensors){return exports.concat(tensors,0)}}),exports.concat2d=operation_1.op({concat2d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat3d=operation_1.op({concat3d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat4d=operation_1.op({concat4d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.split=operation_1.op({split_:function(x,numOrSizeSplits,axis){void 0===axis&&(axis=0);var splitSizes,$x=tensor_util_env_1.convertToTensor(x,"x","split");return axis=util_2.parseAxisParam(axis,$x.shape)[0],"number"==typeof numOrSizeSplits?(util_1.assert($x.shape[axis]%numOrSizeSplits==0,(function(){return"Number of splits must evenly divide the axis."})),splitSizes=new Array(numOrSizeSplits).fill($x.shape[axis]/numOrSizeSplits)):(util_1.assert($x.shape[axis]===numOrSizeSplits.reduce((function(a,b){return a+b})),(function(){return"The sum of sizes must match the size of the axis dimension."})),splitSizes=numOrSizeSplits),engine_1.ENGINE.runKernelFunc((function(backend){return backend.split($x,splitSizes,axis)}),{$x:$x},(function(dy){return{$x:function(){return exports.concat(dy,axis)}}}))}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./concat_util":141,"./operation":163,"./tensor_ops":186}],141:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParamsConsistent=function(shapes,axis){var rank=shapes[0].length;shapes.forEach((function(shape,i){util.assert(shape.length===rank,(function(){return"Error in concat"+rank+"D: rank of tensors["+i+"] must be the same as the rank of the rest ("+rank+")"}))})),util.assert(axis>=0&&axis<rank,(function(){return"Error in concat"+rank+"D: axis must be between 0 and "+(rank-1)+"."}));var firstShape=shapes[0];shapes.forEach((function(shape,i){for(var r=0;r<rank;r++)util.assert(r===axis||shape[r]===firstShape[r],(function(){return"Error in concat"+rank+"D: Shape of tensors["+i+"] ("+shape+") does not match the shape of the rest ("+firstShape+") along the non-concatenated axis "+i+"."}))}))},exports.computeOutShape=function(shapes,axis){for(var outputShape=shapes[0].slice(),i=1;i<shapes.length;i++)outputShape[axis]+=shapes[i][axis];return outputShape}},{"../util":214}],142:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),operation_1=require("./operation");function confusionMatrix_(labels,predictions,numClasses){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","confusionMatrix"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","confusionMatrix");util.assert(null==numClasses||numClasses>0&&Number.isInteger(numClasses),(function(){return"If provided, numClasses must be a positive integer, but got "+numClasses})),util.assert(1===$labels.rank,(function(){return"Expected the rank of labels to be 1, but got "+$labels.rank})),util.assert(1===$predictions.rank,(function(){return"Expected the rank of predictions to be 1, but got "+$predictions.rank})),util.assert($labels.shape[0]===$predictions.shape[0],(function(){return"Mismatch in the number of examples: "+$labels.shape[0]+" vs. "+$predictions.shape[0]+". Labels and predictions should have the same number of elements."})),util.assert(numClasses>0&&Number.isInteger(numClasses),(function(){return"numClasses is required to be a positive integer, but got "+numClasses}));var oneHotLabels=array_ops_1.oneHot($labels.asType("int32"),numClasses),oneHotPredictions=array_ops_1.oneHot($predictions.asType("int32"),numClasses);return oneHotLabels.transpose().matMul(oneHotPredictions).asType("int32")}exports.confusionMatrix_=confusionMatrix_,exports.confusionMatrix=operation_1.op({confusionMatrix_:confusionMatrix_})},{"../tensor_util_env":210,"../util":214,"./array_ops":130,"./operation":163}],143:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation");function conv2dDerInput_(xShape,dy,filter,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),util.assert(xShape.length===dy.rank,(function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"}));var xShape4D=xShape,dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]),xShape4D=[1,xShape[0],xShape[1],xShape[2]]),util.assert(4===xShape4D.length,(function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+xShape4D.length+"."})),util.assert(4===dy4D.rank,(function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+dy4D.rank})),util.assert(4===filter.rank,(function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+filter.rank}));var inDepth="NHWC"===dataFormat?xShape4D[3]:xShape4D[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filter.shape[2],(function(){return"Error in conv2dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[2]+"."})),util.assert(outDepth===filter.shape[3],(function(){return"Error in conv2dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[3]+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(xShape4D,filter.shape,strides,1,pad,dimRoundingMode,!1,$dataFormat),res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.conv2dDerInput(dy4D,filter,convInfo);return save([filter,dy4D]),res}),{dy4D:dy4D,filter:filter},(function(ddx,saved){var filter=saved[0],dy4D=saved[1];return{dy4D:function(){return exports.conv2d(ddx,filter,strides,pad,dataFormat,1,dimRoundingMode)},filter:function(){return exports.conv2dDerFilter(ddx,dy4D,filter.shape,strides,pad,dataFormat,dimRoundingMode)}}}));return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function tupleValuesAreOne(param){var _a=function(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}function conv3dDerInput_(xShape,dy,filter,strides,pad){util.assert(xShape.length===dy.rank,(function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"}));var xShape5D=xShape,dy5D=dy,reshapedTo5D=!1;4===dy.rank&&(reshapedTo5D=!0,dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]),xShape5D=[1,xShape[0],xShape[1],xShape[2],xShape[3]]);var inDepth=xShape5D[4],outDepth=dy5D.shape[4];util.assert(5===xShape5D.length,(function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+xShape5D.length+"."})),util.assert(5===dy5D.rank,(function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+dy5D.rank})),util.assert(5===filter.rank,(function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+filter.rank})),util.assert(inDepth===filter.shape[3],(function(){return"Error in conv3dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[3]+"."})),util.assert(outDepth===filter.shape[4],(function(){return"Error in conv3dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[4]+"."}));var convInfo=conv_util.computeConv3DInfo(xShape5D,filter.shape,strides,1,pad),res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.conv3dDerInput(dy5D,filter,convInfo)}),{dy5D:dy5D});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}exports.conv1d=operation_1.op({conv1d_:function(x,filter,stride,pad,dataFormat,dilation,dimRoundingMode){void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1);var $x=tensor_util_env_1.convertToTensor(x,"x","conv1d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv1d"),x3D=$x,reshapedTo3D=!1;2===$x.rank&&(reshapedTo3D=!0,x3D=$x.as3D(1,$x.shape[0],$x.shape[1])),util.assert(3===x3D.rank,(function(){return"Error in conv1d: input must be rank 3, but got rank "+x3D.rank+"."})),util.assert(3===$filter.rank,(function(){return"Error in conv1d: filter must be rank 3, but got rank "+$filter.rank+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."})),util.assert(x3D.shape[2]===$filter.shape[1],(function(){return"Error in conv1d: depth of input ("+x3D.shape[2]+") must match input depth for filter "+$filter.shape[1]+"."})),util.assert(conv_util.eitherStridesOrDilationsAreOne(stride,dilation),(function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+stride+" and dilation '"+dilation+"'"})),util.assert("NWC"===dataFormat,(function(){return"Error in conv1d: got dataFormat of "+dataFormat+" but only NWC is currently supported."}));var filter4D=$filter.as4D(1,$filter.shape[0],$filter.shape[1],$filter.shape[2]),input4D=x3D.as4D(x3D.shape[0],1,x3D.shape[1],x3D.shape[2]),strides=[1,stride],dilations=[1,dilation],res=exports.conv2d(input4D,filter4D,strides,pad,"NHWC",dilations,dimRoundingMode);return reshapedTo3D?res.as2D(res.shape[2],res.shape[3]):res.as3D(res.shape[0],res.shape[2],res.shape[3])}}),exports.conv2d=operation_1.op({conv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in conv2d: input must be rank 4, but got rank "+x4D.rank+"."})),util.assert(4===$filter.rank,(function(){return"Error in conv2d: filter must be rank 4, but got rank "+$filter.rank+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1];util.assert(inDepth===$filter.shape[2],(function(){return"Error in conv2d: depth of input ("+inDepth+") must match input depth for filter "+$filter.shape[2]+"."})),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}));var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!1,$dataFormat),inputsToSave=[$filter,x4D],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.conv2d(x4D,$filter,convInfo);return save([$filter,x4D]),res}),{x:x4D,filter:$filter},(function(dy,saved){var _a=saved,$filter=_a[0],x4D=_a[1];return util.assert(conv_util.tupleValuesAreOne(dilations),(function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"})),{x:function(){return exports.conv2dDerInput(x4D.shape,dy,$filter,strides,pad,dataFormat)},filter:function(){return exports.conv2dDerFilter(x4D,dy,$filter.shape,strides,pad,dataFormat)}}}),"Conv2D",convInfo,inputsToSave);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv3d=operation_1.op({conv3d_:function(x,filter,strides,pad,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC"),void 0===dilations&&(dilations=[1,1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv3d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),util.assert(5===x5D.rank,(function(){return"Error in conv3d: input must be rank 5, but got rank "+x5D.rank+"."})),util.assert(5===$filter.rank,(function(){return"Error in conv3d: filter must be rank 5, but got rank "+$filter.rank+"."})),util.assert(x5D.shape[4]===$filter.shape[3],(function(){return"Error in conv3d: depth of input ("+x5D.shape[4]+") must match input depth for filter "+$filter.shape[3]+"."})),util.assert(function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)}(strides,dilations),(function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),util.assert("NDHWC"===dataFormat,(function(){return"Error in conv3d: got dataFormat of "+dataFormat+" but only NDHWC is currently supported."}));var convInfo=conv_util.computeConv3DInfo(x5D.shape,$filter.shape,strides,dilations,pad),res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.conv3d(x5D,$filter,convInfo);return save([x5D,$filter]),res}),{x:x5D,$filter:$filter},(function(dy,saved){util.assert(tupleValuesAreOne(dilations),(function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"}));var x5D=saved[0],$filter=saved[1];return{x:function(){return conv3dDerInput_(x5D.shape,dy,$filter,strides,pad)},$filter:function(){return function(x,dy,filterShape,strides,pad){var x5D=x;4===x.rank&&(x5D=x.as5D(1,x.shape[0],x.shape[1],x.shape[2],x.shape[3]));var dy5D=dy;4===dy5D.rank&&(dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]));util.assert(5===x5D.rank,(function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+x5D.shape+"."})),util.assert(5===dy5D.rank,(function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+dy5D.shape+"."})),util.assert(5===filterShape.length,(function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+filterShape+"."})),util.assert(x5D.shape[4]===filterShape[3],(function(){return"Error in conv3dDerFilter: depth of input "+x5D.shape[4]+") must match input depth in filter ("+filterShape[3]+"."})),util.assert(dy5D.shape[4]===filterShape[4],(function(){return"Error in conv3dDerFilter: depth of dy ("+dy5D.shape[4]+") must match output depth for filter ("+filterShape[4]+")."}));var dilations=1,convInfo=conv_util.computeConv3DInfo(x5D.shape,filterShape,strides,dilations,pad);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.conv3dDerFilter(x5D,dy5D,convInfo)}),{x5D:x5D,dy5D:dy5D})}(x5D,dy,$filter.shape,strides,pad)}}}));return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.conv2dDerFilter=operation_1.op({conv2dDerFilter_:function(x,dy,filterShape,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC");var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+x4D.shape+"."})),util.assert(4===dy4D.rank,(function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+dy4D.shape+"."})),util.assert(4===filterShape.length,(function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+filterShape+"."}));var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filterShape[2],(function(){return"Error in conv2dDerFilter: depth of input "+inDepth+") must match input depth in filter ("+filterShape[2]+"."})),util.assert(outDepth===filterShape[3],(function(){return"Error in conv2dDerFilter: depth of dy ("+outDepth+") must match output depth for filter ("+filterShape[3]+")."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,filterShape,strides,1,pad,dimRoundingMode,!1,$dataFormat);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.conv2dDerFilter(x4D,dy4D,convInfo)}),{x4D:x4D,dy4D:dy4D})}}),exports.conv2dDerInput=operation_1.op({conv2dDerInput_:conv2dDerInput_}),exports.depthwiseConv2d=operation_1.op({depthwiseConv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","depthwiseConv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","depthwiseConv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+x4D.rank+"."})),util.assert(4===$filter.rank,(function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+$filter.rank+"."})),util.assert(x4D.shape[3]===$filter.shape[2],(function(){return"Error in depthwiseConv2d: number of input channels ("+x4D.shape[3]+") must match the inChannels dimension in filter "+$filter.shape[2]+"."})),null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!0),inputsToSave=[x4D,$filter],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.depthwiseConv2D(x4D,$filter,convInfo);return save([x4D,$filter]),res}),{x:x4D,filter:$filter},(function(dy,saved){util.assert(conv_util.tupleValuesAreOne(dilations),(function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+dilations+"'"}));var x4D=saved[0],$filter=saved[1];return{x:function(){return exports.depthwiseConv2dDerInput(x4D.shape,dy,$filter,convInfo)},filter:function(){return exports.depthwiseConv2dDerFilter(x4D,dy,$filter.shape,convInfo)}}}),"DepthwiseConv2dNative",convInfo,inputsToSave);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.depthwiseConv2dDerInput=operation_1.op({depthwiseConv2dDerInput_:function(xShape,dy,filter,convInfo){var dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]));var res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.depthwiseConv2DDerInput(dy4D,filter,convInfo)}),{dy4D:dy4D});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.depthwiseConv2dDerFilter=operation_1.op({depthwiseConv2dDerFilter_:function(x,dy,filterShape,convInfo){var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;return 3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2])),engine_1.ENGINE.runKernelFunc((function(backend){return backend.depthwiseConv2DDerFilter(x4D,dy4D,convInfo)}),{x4D:x4D,dy4D:dy4D})}}),exports.separableConv2d=operation_1.op({separableConv2d_:function(x,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","separableConv2d"),$depthwiseFilter=tensor_util_env_1.convertToTensor(depthwiseFilter,"depthwiseFilter","separableConv2d"),$pointwiseFilter=tensor_util_env_1.convertToTensor(pointwiseFilter,"pointwiseFilter","separableConv2d"),x4D=$x,reshapedTo4D=!1;if(3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),"NCHW"===dataFormat)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");util.assert(4===x4D.rank,(function(){return"Error in separableConv2d: input must be rank 4, but got rank "+x4D.rank+"."})),util.assert(4===$depthwiseFilter.rank,(function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."})),util.assert(4===$pointwiseFilter.rank,(function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."})),util.assert(1===$pointwiseFilter.shape[0],(function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+$pointwiseFilter.shape[0]+"."})),util.assert(1===$pointwiseFilter.shape[1],(function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+$pointwiseFilter.shape[1]+"."}));var inChannels=$depthwiseFilter.shape[2],channelMultiplier=$depthwiseFilter.shape[3];util.assert($pointwiseFilter.shape[2]===inChannels*channelMultiplier,(function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+inChannels*channelMultiplier+", but got "+$pointwiseFilter.shape[2]+"."}));var depthwise=exports.depthwiseConv2d(x4D,$depthwiseFilter,strides,pad,dataFormat,dilation),res=exports.conv2d(depthwise,$pointwiseFilter,1,"valid",dataFormat);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv2dTranspose=operation_1.op({conv2dTranspose_:function(x,filter,outputShape,strides,pad,dimRoundingMode){return conv2dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv2dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv2dTranspose"),strides,pad,"NHWC",dimRoundingMode)}}),exports.conv3dTranspose=operation_1.op({conv3dTranspose_:function(x,filter,outputShape,strides,pad){return conv3dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv3dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv3dTranspose"),strides,pad)}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./conv_util":144,"./operation":163}],144:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,depthwise,dataFormat){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1],batchSize=_a[0],inHeight=_a[1],inWidth=_a[2],inChannels=_a[3];if("channelsLast"===dataFormat)batchSize=inShape[0],inHeight=inShape[1],inWidth=inShape[2],inChannels=inShape[3];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inHeight=inShape[2],inWidth=inShape[3]}var outShape,filterHeight=filterShape[0],filterWidth=filterShape[1],filterChannels=filterShape[3],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],_c=parseTupleParam(dilations),dilationHeight=_c[0],dilationWidth=_c[1],effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inHeight,inWidth,strideHeight,strideWidth,filterHeight,filterWidth,roundingMode){var padInfo,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputRows=inShape[0],inputCols=inShape[1],outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),(function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"}));var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),(function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"})),[outputRows,outputCols]}([inHeight,inWidth],filterHeight,strideHeight,pad,roundingMode);outHeight=outShape[0],outWidth=outShape[1]}else if("same"===pad){outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth);var padAlongHeight=Math.max(0,(outHeight-1)*strideHeight+filterHeight-inHeight),padAlongWidth=Math.max(0,(outWidth-1)*strideWidth+filterWidth-inWidth),top_1=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_1,left=Math.floor(padAlongWidth/2);padInfo={top:top_1,bottom:bottom,left:left,right:padAlongWidth-left,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,type:"VALID"},outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outHeight:outHeight,outWidth:outWidth}}(pad,inHeight,inWidth,strideHeight,strideWidth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideHeight:strideHeight,strideWidth:strideWidth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeConv3DInfo(inShape,filterShape,strides,dilations,pad,depthwise,dataFormat,roundingMode){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1,-1],batchSize=_a[0],inDepth=_a[1],inHeight=_a[2],inWidth=_a[3],inChannels=_a[4];if("channelsLast"===dataFormat)batchSize=inShape[0],inDepth=inShape[1],inHeight=inShape[2],inWidth=inShape[3],inChannels=inShape[4];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inDepth=inShape[2],inHeight=inShape[3],inWidth=inShape[4]}var outShape,filterDepth=filterShape[0],filterHeight=filterShape[1],filterWidth=filterShape[2],filterChannels=filterShape[4],_b=parse3TupleParam(strides),strideDepth=_b[0],strideHeight=_b[1],strideWidth=_b[2],_c=parse3TupleParam(dilations),dilationDepth=_c[0],dilationHeight=_c[1],dilationWidth=_c[2],effectiveFilterDepth=getEffectiveFilterSize(filterDepth,dilationDepth),effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,filterDepth,filterHeight,filterWidth,roundingMode){var padInfo,outDepth,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,front:pad,back:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,outChannels,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputDepth=inShape[0],inputRows=inShape[1],inputCols=inShape[2],outputDepths=conditionalRound((inputDepth-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputDepths),(function(){return"The output # of depths ("+outputDepths+") must be an integer. Change the stride and/or zero pad parameters"}));var outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),(function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"}));var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),(function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"})),[outputDepths,outputRows,outputCols,outChannels]}([inDepth,inHeight,inWidth,1],filterDepth,1,strideDepth,pad,roundingMode);outDepth=outShape[0],outHeight=outShape[1],outWidth=outShape[2]}else if("same"===pad){var padAlongDepth=((outDepth=Math.ceil(inDepth/strideDepth))-1)*strideDepth+filterDepth-inDepth,padAlongHeight=((outHeight=Math.ceil(inHeight/strideHeight))-1)*strideHeight+filterHeight-inHeight,padAlongWidth=((outWidth=Math.ceil(inWidth/strideWidth))-1)*strideWidth+filterWidth-inWidth,front=Math.floor(padAlongDepth/2),back=padAlongDepth-front,top_2=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_2,left=Math.floor(padAlongWidth/2);padInfo={top:top_2,bottom:bottom,left:left,right:padAlongWidth-left,front:front,back:back,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},outDepth=Math.ceil((inDepth-filterDepth+1)/strideDepth),outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth}}(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,effectiveFilterDepth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outDepth=_d.outDepth,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outDepth,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outDepth,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inDepth:inDepth,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideDepth:strideDepth,strideHeight:strideHeight,strideWidth:strideWidth,filterDepth:filterDepth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterDepth:effectiveFilterDepth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationDepth:dilationDepth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeDefaultPad(inputShape,fieldSize,stride,dilation){void 0===dilation&&(dilation=1);var effectiveFieldSize=getEffectiveFilterSize(fieldSize,dilation);return Math.floor((inputShape[0]*(stride-1)-stride+effectiveFieldSize)/2)}function parseTupleParam(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}function parse3TupleParam(param){return"number"==typeof param?[param,param,param]:param}function getEffectiveFilterSize(filterSize,dilation){return dilation<=1?filterSize:filterSize+(filterSize-1)*(dilation-1)}function conditionalRound(value,roundingMode){if(!roundingMode)return value;switch(roundingMode){case"round":return Math.round(value);case"ceil":return Math.ceil(value);case"floor":return Math.floor(value);default:throw new Error("Unknown roundingMode "+roundingMode)}}function tupleValuesAreOne(param){var _a=parseTupleParam(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}exports.computePool2DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="channelsLast");var filterShape,_a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1];if("channelsLast"===dataFormat)filterShape=[filterHeight,filterWidth,inShape[3],inShape[3]];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);filterShape=[filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,!1,dataFormat)},exports.computePool3DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="NDHWC");var filterShape,$dataFormat,_a=parse3TupleParam(filterSize),filterDepth=_a[0],filterHeight=_a[1],filterWidth=_a[2];if("NDHWC"===dataFormat)$dataFormat="channelsLast",filterShape=[filterDepth,filterHeight,filterWidth,inShape[4],inShape[4]];else{if("NCDHW"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);$dataFormat="channelsFirst",filterShape=[filterDepth,filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv3DInfo(inShape,filterShape,strides,dilations,pad,!1,$dataFormat,roundingMode)},exports.computeConv2DInfo=computeConv2DInfo,exports.computeConv3DInfo=computeConv3DInfo,exports.computeDefaultPad=computeDefaultPad,exports.tupleValuesAreOne=tupleValuesAreOne,exports.eitherStridesOrDilationsAreOne=function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)},exports.convertConv2DDataFormat=function(dataFormat){if("NHWC"===dataFormat)return"channelsLast";if("NCHW"===dataFormat)return"channelsFirst";throw new Error("Unknown dataFormat "+dataFormat)}},{"../util":214}],145:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.diag=operation_1.op({diag_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","diag").flatten(),outShape=x.shape.concat(x.shape);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.diag($x)}),{$x:$x}).reshape(outShape)}})},{"../engine":106,"../tensor_util_env":210,"./operation":163}],146:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),dropout_util_1=require("./dropout_util"),operation_1=require("./operation");exports.dropout=operation_1.op({dropout_:function(x,rate,noiseShape,seed){var $x=tensor_util_env_1.convertToTensor(x,"x","dropout");if(util.assert("float32"===$x.dtype,(function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+$x.dtype+" tensor instead."})),util.assert(rate>=0&&rate<1,(function(){return"rate must be a float in the range [0, 1), but got "+rate+"."})),0===rate)return x instanceof tensor_1.Tensor?$x.clone():$x;var $noiseShape=dropout_util_1.getNoiseShape($x,noiseShape),keepProb=1-rate,multiplier=array_ops_1.randomUniform($noiseShape,0,1,"float32",seed).add(keepProb).floor().div(keepProb);return $x.mul(multiplier)}})},{"../tensor":207,"../tensor_util_env":210,"../util":214,"./array_ops":130,"./dropout_util":147,"./operation":163}],147:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.getNoiseShape=function(x,noiseShape){if(null==noiseShape)return x.shape.slice();if(util.arraysEqual(x.shape,noiseShape))return noiseShape;if(x.shape.length===noiseShape.length){for(var newDimension=[],i=0;i<x.shape.length;i++)null==noiseShape[i]&&null!=x.shape[i]?newDimension.push(x.shape[i]):newDimension.push(noiseShape[i]);return newDimension}return noiseShape}},{"../util":214}],148:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.ERF_P=.3275911,exports.ERF_A1=.254829592,exports.ERF_A2=-.284496736,exports.ERF_A3=1.421413741,exports.ERF_A4=-1.453152027,exports.ERF_A5=1.061405429},{}],149:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),conv_1=require("../ops/conv"),conv_util=require("../ops/conv_util"),operation_1=require("../ops/operation"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),binary_ops_1=require("./binary_ops"),broadcast_util=require("./broadcast_util"),conv_2=require("./conv"),fused_util_1=require("./fused_util"),matmul_1=require("./matmul"),relu_ops_1=require("./relu_ops"),getFusedDyActivation=function(dy,y,activation){if(null==activation||"linear"===activation)return dy;if("relu"===activation)return dy.mul(y.step());throw new Error("Gradient for activation "+activation+" has not been implemented yet.")},getFusedBiasGradient=function(bias,dyActivation){var res=dyActivation,reduceAxes=broadcast_util.getReductionAxes(bias.shape,dyActivation.shape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape(bias.shape)},applyActivation=function(x,activation,preluActivationWeights){if("linear"===activation)return x;if("relu"===activation)return relu_ops_1.relu(x);if("elu"===activation)return relu_ops_1.elu(x);if("relu6"===activation)return relu_ops_1.relu6(x);if("prelu"===activation)return relu_ops_1.prelu(x,preluActivationWeights);throw new Error("Unknown fused activation "+activation+".")};exports.matMul=operation_1.op({fusedMatMul_:function(_a){var _b,a=_a.a,b=_a.b,_c=_a.transposeA,transposeA=void 0!==_c&&_c,_d=_a.transposeB,transposeB=void 0!==_d&&_d,bias=_a.bias,_e=_a.activation,activation=void 0===_e?"linear":_e,preluActivationWeights=_a.preluActivationWeights;if(!1===fused_util_1.shouldFuse(engine_1.ENGINE.state.gradientDepth,activation)){var result=matmul_1.matMul(a,b,transposeA,transposeB);return null!=bias&&(result=binary_ops_1.add(result,bias)),applyActivation(result,activation,preluActivationWeights)}var $a=tensor_util_env_1.convertToTensor(a,"a","fused matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","fused matMul");_b=tensor_util_1.makeTypesMatch($a,$b),$a=_b[0],$b=_b[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert($a.rank>=2&&$b.rank>=2&&$a.rank===$b.rank,(function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."})),util.assert(util.arraysEqual(outerDimsA,outerDimsB),(function(){return"Error in fused matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."})),util.assert(innerShapeA===innerShapeB,(function(){return"Error in fused matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."}));var $bias,$preluActivationWeights,outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused matMul"),$bias=tensor_util_1.makeTypesMatch($bias,$a)[0],broadcast_util.assertAndGetBroadcastShape(outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused matMul"));var inputs={a:a3D,b:b3D};null!=bias&&(inputs.bias=$bias),null!=preluActivationWeights&&(inputs.preluActivationWeights=$preluActivationWeights);var inputsToSave=[a3D,b3D],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.fusedBatchMatMul({a:a3D,b:b3D,transposeA:transposeA,transposeB:transposeB,bias:$bias,activation:activation,preluActivationWeights:$preluActivationWeights});return save([a3D,b3D,y]),y}),inputs,(function(dy,saved){var a3D=saved[0],b3D=saved[1],y=saved[2],dyActivation=getFusedDyActivation(dy,y,activation),biasGradient={};return null!=bias&&(biasGradient={bias:function(){return getFusedBiasGradient($bias,dyActivation)}}),transposeA||transposeB?!transposeA&&transposeB?Object.assign({a:function(){return dyActivation.matMul(b3D,!1,!1)},b:function(){return dyActivation.matMul(a3D,!0,!1)}},biasGradient):transposeA&&!transposeB?Object.assign({a:function(){return b3D.matMul(dyActivation,!1,!0)},b:function(){return a3D.matMul(dyActivation,!1,!1)}},biasGradient):Object.assign({a:function(){return b3D.matMul(dyActivation,!0,!0)},b:function(){return dyActivation.matMul(a3D,!0,!0)}},biasGradient):Object.assign({a:function(){return dyActivation.matMul(b3D,!1,!0)},b:function(){return a3D.matMul(dyActivation,!0,!1)}},biasGradient)}),"_FusedMatMul",{transposeA:transposeA,transposeB:transposeB,activation:activation},inputsToSave,[!0]);return res.reshape(outShape)}}),exports.conv2d=operation_1.op({fusedConv2d_:function(_a){var x=_a.x,filter=_a.filter,strides=_a.strides,pad=_a.pad,_b=_a.dataFormat,dataFormat=void 0===_b?"NHWC":_b,_c=_a.dilations,dilations=void 0===_c?[1,1]:_c,dimRoundingMode=_a.dimRoundingMode,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights;if(activation=activation||"linear",!1===fused_util_1.shouldFuse(engine_1.ENGINE.state.gradientDepth,activation)){var result=conv_2.conv2d(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode);return null!=bias&&(result=binary_ops_1.add(result,bias)),applyActivation(result,activation,preluActivationWeights)}var $x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in fused conv2d: input must be rank 4, but got rank "+x4D.rank+"."})),util.assert(4===$filter.rank,(function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+$filter.rank+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."})),util.assert(x4D.shape[3]===$filter.shape[2],(function(){return"Error in conv2d: depth of input ("+x4D.shape[3]+") must match input depth for filter "+$filter.shape[2]+"."})),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),util.assert("NHWC"===dataFormat,(function(){return"Error in conv2d: got dataFormat of "+dataFormat+" but only NHWC is currently supported."}));var $bias,$preluActivationWeights,convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused conv2d"),$bias=tensor_util_1.makeTypesMatch($bias,$x)[0],broadcast_util.assertAndGetBroadcastShape(convInfo.outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused conv2d"));var inputs={x:x4D,filter:$filter};null!=bias&&(inputs.bias=$bias),null!=preluActivationWeights&&(inputs.preluActivationWeights=$preluActivationWeights);var inputsToSave=[$filter,x4D],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.fusedConv2d({input:x4D,filter:$filter,convInfo:convInfo,bias:$bias,activation:activation,preluActivationWeights:$preluActivationWeights});return save([$filter,x4D,res]),res}),inputs,(function(dy,saved){var _a=saved,$filter=_a[0],x4D=_a[1],y=_a[2],dyActivation=getFusedDyActivation(dy,y,activation);util.assert(conv_util.tupleValuesAreOne(dilations),(function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"}));var biasGradient={};return null!=bias&&(biasGradient={bias:function(){return getFusedBiasGradient($bias,dyActivation)}}),Object.assign({x:function(){return conv_1.conv2dDerInput(x4D.shape,dyActivation,$filter,strides,pad)},filter:function(){return conv_1.conv2dDerFilter(x4D,dyActivation,$filter.shape,strides,pad)}},biasGradient)}),"FusedConv2D",{convInfo:convInfo,activation:activation},inputsToSave,[!0]);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.depthwiseConv2d=operation_1.op({fusedDepthwiseConv2d_:function(_a){var x=_a.x,filter=_a.filter,strides=_a.strides,pad=_a.pad,_b=_a.dataFormat,dataFormat=void 0===_b?"NHWC":_b,_c=_a.dilations,dilations=void 0===_c?[1,1]:_c,dimRoundingMode=_a.dimRoundingMode,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights;if(!1===fused_util_1.shouldFuse(engine_1.ENGINE.state.gradientDepth,activation)){var result=conv_2.depthwiseConv2d(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode);return null!=bias&&(result=binary_ops_1.add(result,bias)),applyActivation(result,activation,preluActivationWeights)}var $x=tensor_util_env_1.convertToTensor(x,"x","depthwiseConv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","depthwiseConv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+x4D.rank+"."})),util.assert(4===$filter.rank,(function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+$filter.rank+"."})),util.assert(x4D.shape[3]===$filter.shape[2],(function(){return"Error in fused depthwiseConv2d: number of input channels ("+x4D.shape[3]+") must match the inChannels dimension in filter "+$filter.shape[2]+"."})),null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var $bias,$preluActivationWeights,convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!0);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused conv2d"),$bias=tensor_util_1.makeTypesMatch($bias,$x)[0],broadcast_util.assertAndGetBroadcastShape(convInfo.outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused depthwiseConv2d"));var inputs={x:x4D,filter:$filter};null!=bias&&(inputs.bias=$bias),null!=preluActivationWeights&&(inputs.preluActivationWeights=$preluActivationWeights);var inputsToSave=[$filter,x4D],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.fusedDepthwiseConv2D({input:x4D,filter:$filter,convInfo:convInfo,bias:$bias,activation:activation,preluActivationWeights:$preluActivationWeights});return save([$filter,x4D,res]),res}),inputs,(function(dy,saved){util.assert(conv_util.tupleValuesAreOne(dilations),(function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+dilations+"'"}));var $filter=saved[0],x4D=saved[1],y=saved[2],dyActivation=getFusedDyActivation(dy,y,activation),biasGradient={};return null!=bias&&(biasGradient={bias:function(){return getFusedBiasGradient($bias,dyActivation)}}),Object.assign({x:function(){return conv_1.depthwiseConv2dDerInput(x4D.shape,dyActivation,$filter,convInfo)},filter:function(){return conv_1.depthwiseConv2dDerFilter(x4D,dyActivation,$filter.shape,convInfo)}},biasGradient)}),"FusedDepthwiseConv2D",{convInfo:convInfo,activation:activation},inputsToSave,[!0]);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":106,"../ops/conv":143,"../ops/conv_util":144,"../ops/operation":163,"../tensor_util":209,"../tensor_util_env":210,"../util":214,"./binary_ops":134,"./broadcast_util":136,"./conv":143,"./fused_util":150,"./matmul":160,"./relu_ops":169}],150:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.shouldFuse=function(gradientDepth,activation){return!(gradientDepth>0)||"linear"===activation}},{}],151:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.gatherND=operation_1.op({gatherND_:function(x,indices){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","gatherND","int32"),$x=tensor_util_env_1.convertToTensor(x,"x","gatherND");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.gatherND($x,$indices)}),{x:$x,indices:$indices},null,"GatherNd")}})},{"../engine":106,"../tensor_util_env":210,"./operation":163}],152:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.prepareAndValidate=function(tensor,indices){if(tensor.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+tensor.rank+".");if(indices.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if("int32"!==indices.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+indices.dtype+".");if(indices.shape[indices.rank-1]>tensor.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+indices.shape[indices.rank-1]+" vs. "+tensor.rank);if(0===tensor.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+tensor.shape+".");for(var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],nResult=1,i=0;i<indicesShape.length-1;++i)nResult*=indicesShape[i];var inputShape=tensor.shape,resultShape=indicesShape.slice();resultShape.pop();var sliceSize=1;for(i=sliceRank;i<tensor.rank;++i)sliceSize*=inputShape[i],resultShape.push(inputShape[i]);var strides=util_1.computeStrides(tensor.shape).map((function(stride){return stride/sliceSize})).concat([1]).slice(0,sliceRank);return[resultShape,nResult,sliceSize,strides]}},{"../util":214}],153:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var non_max_suppression_impl_1=require("../backends/non_max_suppression_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");function nonMaxSuppSanityCheck(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma){null==iouThreshold&&(iouThreshold=.5),null==scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),null==softNmsSigma&&(softNmsSigma=0);var numBoxes=boxes.shape[0];return maxOutputSize=Math.min(maxOutputSize,numBoxes),util.assert(0<=iouThreshold&&iouThreshold<=1,(function(){return"iouThreshold must be in [0, 1], but was '"+iouThreshold+"'"})),util.assert(2===boxes.rank,(function(){return"boxes must be a 2D tensor, but was of rank '"+boxes.rank+"'"})),util.assert(4===boxes.shape[1],(function(){return"boxes must have 4 columns, but 2nd dimension was "+boxes.shape[1]})),util.assert(1===scores.rank,(function(){return"scores must be a 1D tensor"})),util.assert(scores.shape[0]===numBoxes,(function(){return"scores has incompatible shape with boxes. Expected "+numBoxes+", but was "+scores.shape[0]})),util.assert(0<=softNmsSigma&&softNmsSigma<=1,(function(){return"softNmsSigma must be in [0, 1], but was '"+softNmsSigma+"'"})),{maxOutputSize:maxOutputSize,iouThreshold:iouThreshold,scoreThreshold:scoreThreshold,softNmsSigma:softNmsSigma}}exports.resizeBilinear=operation_1.op({resizeBilinear_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeBilinear");util.assert(3===$images.rank||4===$images.rank,(function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+$images.rank+"."})),util.assert(2===size.length,(function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+size+"."}));var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernelFunc((function(backend,save){return save([batchImages]),backend.resizeBilinear(batchImages,newHeight,newWidth,alignCorners)}),{x:batchImages},(function(dy,saved){return{x:function(){return engine_1.ENGINE.runKernelFunc((function(backend){return backend.resizeBilinearBackprop(dy,saved[0],alignCorners)}),{})}}}),"ResizeBilinear",{alignCorners:alignCorners,newHeight:newHeight,newWidth:newWidth});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.resizeNearestNeighbor=operation_1.op({resizeNearestNeighbor_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeNearestNeighbor");util.assert(3===$images.rank||4===$images.rank,(function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+$images.rank+"."})),util.assert(2===size.length,(function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+size+"."})),util.assert("float32"===$images.dtype||"int32"===$images.dtype,(function(){return"`images` must have `int32` or `float32` as dtype"}));var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernelFunc((function(backend,save){return save([batchImages]),backend.resizeNearestNeighbor(batchImages,newHeight,newWidth,alignCorners)}),{batchImages:batchImages},(function(dy,saved){return{batchImages:function(){return engine_1.ENGINE.runKernelFunc((function(backend){return backend.resizeNearestNeighborBackprop(dy,saved[0],alignCorners)}),{})}}}));return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.nonMaxSuppression=operation_1.op({nonMaxSuppression_:function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY);var $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppression"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppression"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold);maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold;var attrs={maxOutputSize:maxOutputSize,iouThreshold:iouThreshold,scoreThreshold:scoreThreshold};return engine_1.ENGINE.runKernelFunc((function(b){return b.nonMaxSuppression($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold)}),{boxes:$boxes,scores:$scores},null,"NonMaxSuppressionV3",attrs)}}),exports.nonMaxSuppressionAsync=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){return void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),__awaiter(this,void 0,void 0,(function(){var $boxes,$scores,inputs,boxesAndScores,boxesVals,scoresVals,res;return __generator(this,(function(_a){switch(_a.label){case 0:return $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppressionAsync"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppressionAsync"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold),maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,[4,Promise.all([$boxes.data(),$scores.data()])];case 1:return boxesAndScores=_a.sent(),boxesVals=boxesAndScores[0],scoresVals=boxesAndScores[1],res=non_max_suppression_impl_1.nonMaxSuppressionV3(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold),$boxes!==boxes&&$boxes.dispose(),$scores!==scores&&$scores.dispose(),[2,res]}}))}))},exports.nonMaxSuppressionWithScore=operation_1.op({nonMaxSuppressionWithScore_:function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma){void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),void 0===softNmsSigma&&(softNmsSigma=0);var $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppression"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppression"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma),attrs={maxOutputSize:maxOutputSize=inputs.maxOutputSize,iouThreshold:iouThreshold=inputs.iouThreshold,scoreThreshold:scoreThreshold=inputs.scoreThreshold,softNmsSigma:softNmsSigma=inputs.softNmsSigma},result=engine_1.ENGINE.runKernel("NonMaxSuppressionV5",{boxes:$boxes,scores:$scores},attrs);return{selectedIndices:result[0],selectedScores:result[1]}}}),exports.nonMaxSuppressionWithScoreAsync=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma){return void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),void 0===softNmsSigma&&(softNmsSigma=0),__awaiter(this,void 0,void 0,(function(){var $boxes,$scores,inputs,boxesAndScores,boxesVals,scoresVals,res;return __generator(this,(function(_a){switch(_a.label){case 0:return $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppressionAsync"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppressionAsync"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma),maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,softNmsSigma=inputs.softNmsSigma,[4,Promise.all([$boxes.data(),$scores.data()])];case 1:return boxesAndScores=_a.sent(),boxesVals=boxesAndScores[0],scoresVals=boxesAndScores[1],res=non_max_suppression_impl_1.nonMaxSuppressionV5(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold,softNmsSigma),$boxes!==boxes&&$boxes.dispose(),$scores!==scores&&$scores.dispose(),[2,res]}}))}))},exports.cropAndResize=operation_1.op({cropAndResize_:function(image,boxes,boxInd,cropSize,method,extrapolationValue){var $image=tensor_util_env_1.convertToTensor(image,"image","cropAndResize"),$boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","cropAndResize","float32"),$boxInd=tensor_util_env_1.convertToTensor(boxInd,"boxInd","cropAndResize","int32");method=method||"bilinear",extrapolationValue=extrapolationValue||0;var numBoxes=$boxes.shape[0];return util.assert(4===$image.rank,(function(){return"Error in cropAndResize: image must be rank 4,but got rank "+$image.rank+"."})),util.assert(2===$boxes.rank&&4===$boxes.shape[1],(function(){return"Error in cropAndResize: boxes must be have size ["+numBoxes+",4] but had shape "+$boxes.shape+"."})),util.assert(1===$boxInd.rank&&$boxInd.shape[0]===numBoxes,(function(){return"Error in cropAndResize: boxInd must be have size ["+numBoxes+"] but had shape "+$boxes.shape+"."})),util.assert(2===cropSize.length,(function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+cropSize.length+"."})),util.assert(cropSize[0]>=1&&cropSize[1]>=1,(function(){return"cropSize must be atleast [1,1], but was "+cropSize})),util.assert("bilinear"===method||"nearest"===method,(function(){return"method must be bilinear or nearest, but was "+method})),engine_1.ENGINE.runKernelFunc((function(backend,save){return backend.cropAndResize($image,$boxes,$boxInd,cropSize,method,extrapolationValue)}),{images:$image,boxes:$boxes,boxInd:$boxInd},null,"CropAndResize",{method:method,extrapolationValue:extrapolationValue,cropSize:cropSize})}})},{"../backends/non_max_suppression_impl":12,"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163}],154:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.inTopKAsync=function(predictions,targets,k){return void 0===k&&(k=1),__awaiter(this,void 0,void 0,(function(){var $predictions,$targets,lastDim,predictionsVals,targetsVals,_a,batch,size,precision,b,offset,vals,valAndInd,i;return __generator(this,(function(_b){switch(_b.label){case 0:return $predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","inTopK"),$targets=tensor_util_env_1.convertToTensor(targets,"targets","inTopK"),util_1.assert($predictions.rank>1,(function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+$predictions.rank})),util_1.assert($predictions.rank-1===$targets.rank,(function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+$predictions.rank+" and targets rank "+$targets.rank})),util_1.assertShapesMatch($predictions.shape.slice(0,$predictions.shape.length-1),$targets.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),lastDim=$predictions.shape[$predictions.shape.length-1],util_1.assert(k>0&&k<=lastDim,(function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+lastDim+"), but got "+k})),[4,$predictions.data()];case 1:return predictionsVals=_b.sent(),[4,$targets.data()];case 2:for(targetsVals=_b.sent(),_a=[predictionsVals.length/lastDim,lastDim],batch=_a[0],size=_a[1],precision=util_1.getTypedArrayFromDType("bool",batch),b=0;b<batch;b++){for(offset=b*size,vals=predictionsVals.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});for(valAndInd.sort((function(a,b){return b.value-a.value})),precision[b]=0,i=0;i<k;i++)if(valAndInd[i].index===targetsVals[b]){precision[b]=1;break}}return predictions!==$predictions&&$predictions.dispose(),targets!==$targets&&$targets.dispose(),[2,tensor_ops_1.tensor(precision,$targets.shape,"bool")]}}))}))}},{"../tensor_util_env":210,"../util":214,"./tensor_ops":186}],155:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),array_ops_1=require("./array_ops"),binary_ops_1=require("./binary_ops"),concat_split_1=require("./concat_split"),logical_ops_1=require("./logical_ops"),norm_1=require("./norm"),operation_1=require("./operation"),reduction_ops_1=require("./reduction_ops"),tensor_ops_1=require("./tensor_ops");function qr2d(x,fullMatrices){return void 0===fullMatrices&&(fullMatrices=!1),engine_1.ENGINE.tidy((function(){if(2!==x.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+x.shape.length+"D Tensor.");for(var m=x.shape[0],n=x.shape[1],q=array_ops_1.eye(m),r=x.clone(),one2D=tensor_ops_1.tensor2d([[1]],[1,1]),w=one2D.clone(),iters=m>=n?n:m,_loop_3=function(j){var _a,rTemp=r,wTemp=w,qTemp=q;_a=engine_1.ENGINE.tidy((function(){var rjEnd1=r.slice([j,j],[m-j,1]),normX=rjEnd1.norm(),rjj=r.slice([j,j],[1,1]),s=tensor_ops_1.tensor2d([[-1]]).where(rjj.greater(0),tensor_ops_1.tensor2d([[1]])),u1=rjj.sub(s.mul(normX)),wPre=rjEnd1.div(u1);w=1===wPre.shape[0]?one2D.clone():one2D.concat(wPre.slice([1,0],[wPre.shape[0]-1,wPre.shape[1]]),0);var tau=s.matMul(u1).div(normX).neg(),rjEndAll=r.slice([j,0],[m-j,n]),tauTimesW=tau.mul(w);if(0===j)r=rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll)));else{var rTimesTau=rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll)));r=r.slice([0,0],[j,n]).concat(rTimesTau,0)}var qAllJEnd=q.slice([0,j],[m,q.shape[1]-j]);if(0===j)q=qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose()));else{var qTimesTau=qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose()));q=q.slice([0,0],[m,j]).concat(qTimesTau,1)}return[w,r,q]})),w=_a[0],r=_a[1],q=_a[2],globals_1.dispose([rTemp,wTemp,qTemp])},j=0;j<iters;++j)_loop_3(j);return!fullMatrices&&m>n&&(q=q.slice([0,0],[m,n]),r=r.slice([0,0],[n,n])),[q,r]}))}exports.bandPart=operation_1.op({bandPart_:function(a,numLower,numUpper){if(numLower%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+numLower+".");if(numUpper%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+numUpper+".");var $a=tensor_util_env_1.convertToTensor(a,"a","bandPart");if($a.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+$a.rank+".");var shape=$a.shape,_a=$a.shape.slice(-2),M=_a[0],N=_a[1];if(!(numLower<=M))throw new Error("bandPart(): numLower ("+numLower+") must not be greater than the number of rows ("+M+").");if(!(numUpper<=N))throw new Error("bandPart(): numUpper ("+numUpper+") must not be greater than the number of columns ("+N+").");numLower<0&&(numLower=M),numUpper<0&&(numUpper=N);var i=tensor_ops_1.range(0,M,1,"int32").reshape([-1,1]),j=tensor_ops_1.range(0,N,1,"int32"),ij=binary_ops_1.sub(i,j),inBand=logical_ops_1.logicalAnd(ij.lessEqual(tensor_ops_1.scalar(+numLower,"int32")),ij.greaterEqual(tensor_ops_1.scalar(-numUpper,"int32"))),zero=tensor_ops_1.zeros([M,N],$a.dtype);return array_ops_1.stack(array_ops_1.unstack($a.reshape([-1,M,N])).map((function(mat){return logical_ops_1.where(inBand,mat,zero)}))).reshape(shape)}}),exports.gramSchmidt=operation_1.op({gramSchmidt_:function(xs){var inputIsTensor2D;if(Array.isArray(xs)){inputIsTensor2D=!1,util_1.assert(null!=xs&&xs.length>0,(function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"}));for(var dim_1=xs[0].shape[0],_loop_1=function(i){util_1.assert(xs[i].shape[0]===dim_1,(function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+xs[i].shape[0]+" vs. "+dim_1+")"}))},i=1;i<xs.length;++i)_loop_1(i)}else inputIsTensor2D=!0,xs=concat_split_1.split(xs,xs.shape[0],0).map((function(x){return array_ops_1.squeeze(x,[0])}));util_1.assert(xs.length<=xs[0].shape[0],(function(){return"Gram-Schmidt: Number of vectors ("+xs.length+") exceeds number of dimensions ("+xs[0].shape[0]+")."}));var ys=[],xs1d=xs,_loop_2=function(i){ys.push(engine_1.ENGINE.tidy((function(){var x=xs1d[i];if(i>0)for(var j=0;j<i;++j){var proj=reduction_ops_1.sum(ys[j].mulStrict(x)).mul(ys[j]);x=x.sub(proj)}return x.div(norm_1.norm(x,"euclidean"))})))};for(i=0;i<xs.length;++i)_loop_2(i);return inputIsTensor2D?array_ops_1.stack(ys,0):ys}}),exports.qr=operation_1.op({qr_:function(x,fullMatrices){if(void 0===fullMatrices&&(fullMatrices=!1),x.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+x.rank);if(2===x.rank)return qr2d(x,fullMatrices);var outerDimsProd=x.shape.slice(0,x.shape.length-2).reduce((function(value,prev){return value*prev})),x2ds=array_ops_1.unstack(x.reshape([outerDimsProd,x.shape[x.shape.length-2],x.shape[x.shape.length-1]]),0),q2ds_1=[],r2ds_1=[];return x2ds.forEach((function(x2d){var _a=qr2d(x2d,fullMatrices),q2d=_a[0],r2d=_a[1];q2ds_1.push(q2d),r2ds_1.push(r2d)})),[array_ops_1.stack(q2ds_1,0).reshape(x.shape),array_ops_1.stack(r2ds_1,0).reshape(x.shape)]}})},{"../engine":106,"../globals":109,"../tensor_util_env":210,"../util":214,"./array_ops":130,"./binary_ops":134,"./concat_split":140,"./logical_ops":156,"./norm":162,"./operation":163,"./reduction_ops":168,"./tensor_ops":186}],156:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var where_impl_1=require("../backends/where_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.logicalAnd=operation_1.op({logicalAnd_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalAnd","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalAnd","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.logicalAnd($a,$b)}),{a:$a,b:$b},null,"LogicalAnd")}}),exports.logicalNot=operation_1.op({logicalNot_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logicalNot","bool");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.logicalNot($x)}),{$x:$x})}}),exports.logicalOr=operation_1.op({logicalOr_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalOr","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalOr","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.logicalOr($a,$b)}),{$a:$a,$b:$b})}}),exports.logicalXor=operation_1.op({logicalXor_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalXor","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalXor","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),exports.logicalOr(a,b).logicalAnd(exports.logicalAnd(a,b).logicalNot())}}),exports.where=operation_1.op({where_:function(condition,a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","where"),$b=tensor_util_env_1.convertToTensor(b,"b","where"),$condition=tensor_util_env_1.convertToTensor(condition,"condition","where","bool");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in where: "),1===$condition.rank?util_1.assert($condition.shape[0]===$a.shape[0],(function(){return"The first dimension of `a` must match the size of `condition`."})):util_1.assertShapesMatch($condition.shape,$b.shape,"Error in where: "),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.select($condition,$a,$b);return save([$condition]),res}),{$condition:$condition,$a:$a,$b:$b},(function(dy,saved){var $condition=saved[0];return{$condition:function(){return tensor_ops_1.zerosLike($condition).toFloat()},$a:function(){return dy.mul($condition.cast(dy.dtype))},$b:function(){return dy.mul($condition.logicalNot().cast(dy.dtype))}}}))}}),exports.whereAsync=function(condition){return __awaiter(this,void 0,void 0,(function(){var $condition,vals,res;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,($condition=tensor_util_env_1.convertToTensor(condition,"condition","whereAsync","bool")).data()];case 1:return vals=_a.sent(),res=where_impl_1.whereImpl($condition.shape,vals),condition!==$condition&&$condition.dispose(),[2,res]}}))}))}},{"../backends/where_impl":103,"../engine":106,"../tensor_util_env":210,"../util":214,"./broadcast_util":136,"./operation":163,"./tensor_ops":186}],157:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var Reduction,gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");!function(Reduction){Reduction[Reduction.NONE=0]="NONE",Reduction[Reduction.MEAN=1]="MEAN",Reduction[Reduction.SUM=2]="SUM",Reduction[Reduction.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(Reduction=exports.Reduction||(exports.Reduction={})),exports.absoluteDifference=operation_1.op({absoluteDifference_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","absoluteDifference"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","absoluteDifference"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","absoluteDifference")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in absoluteDifference: ");var losses=$labels.sub($predictions).abs();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.computeWeightedLoss=operation_1.op({computeWeightedLoss_:function(losses,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $losses=tensor_util_env_1.convertToTensor(losses,"losses","computeWeightedLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","computeWeightedLoss"));var weightedLoss=null==$weights?$losses:$losses.mul($weights);if(reduction===Reduction.NONE)return weightedLoss;if(reduction===Reduction.SUM)return weightedLoss.sum();if(reduction===Reduction.MEAN){if(null==$weights)return weightedLoss.mean();var broadcastFactor=$losses.size/$weights.size,result=weightedLoss.sum().div($weights.sum());return broadcastFactor>1?result.div(tensor_ops_1.scalar(broadcastFactor)):result}if(reduction===Reduction.SUM_BY_NONZERO_WEIGHTS){if(null==$weights)return weightedLoss.sum().div(tensor_ops_1.scalar($losses.size));var numNonZeros=$weights.mul(tensor_ops_1.ones($losses.shape)).notEqual(tensor_ops_1.scalar(0)).sum().toFloat();return weightedLoss.sum().div(numNonZeros)}throw Error("Unknown reduction: "+reduction)}}),exports.cosineDistance=operation_1.op({cosineDistance_:function(labels,predictions,axis,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","cosineDistance"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","cosineDistance"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","cosineDistance")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in cosineDistance: ");var losses=tensor_ops_1.scalar(1).sub($labels.mul($predictions).sum(axis,!0));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.hingeLoss=operation_1.op({hingeLoss_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","hingeLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","hingeLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","hingeLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in hingeLoss: ");var one=tensor_ops_1.scalar(1);$labels=tensor_ops_1.scalar(2).mul($labels).sub(one);var losses=one.sub($labels.mul($predictions)).relu();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.huberLoss=operation_1.op({huberLoss_:function(labels,predictions,weights,delta,reduction){void 0===delta&&(delta=1),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","huberLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","huberLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","huberLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in huberLoss: ");var deltaScalar=tensor_ops_1.scalar(delta),error=$predictions.sub($labels).abs(),quadratic=binary_ops_1.minimum(error,deltaScalar),linear=error.sub(quadratic),losses=tensor_ops_1.scalar(.5).mul(quadratic.square()).add(deltaScalar.mul(linear));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.logLoss=operation_1.op({logLoss_:function(labels,predictions,weights,epsilon,reduction){void 0===epsilon&&(epsilon=1e-7),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","logLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","logLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","logLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in logLoss: ");var one=tensor_ops_1.scalar(1),epsilonScalar=tensor_ops_1.scalar(epsilon),losses=$labels.mul($predictions.add(epsilonScalar).log()).neg().sub(one.sub($labels).mul(one.sub($predictions).add(epsilonScalar).log()));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.meanSquaredError=operation_1.op({meanSquaredError_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","meanSquaredError"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","meanSquaredError"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","meanSquaredError")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in meanSquaredError: ");var losses=$labels.squaredDifference($predictions);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.sigmoidCrossEntropy=operation_1.op({sigmoidCrossEntropy_:function(multiClassLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $multiClassLabels=tensor_util_env_1.convertToTensor(multiClassLabels,"multiClassLabels","sigmoidCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","sigmoidCrossEntropy")),util_1.assertShapesMatch($multiClassLabels.shape,$logits.shape,"Error in sigmoidCrossEntropy: "),labelSmoothing>0){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),half=tensor_ops_1.scalar(.5);$multiClassLabels=$multiClassLabels.mul(one.sub(labelSmoothingScalar)).add(half.mul(labelSmoothingScalar))}var losses=function(labels,logits){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","sigmoidCrossEntropyWithLogits"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropyWithLogits");util_1.assertShapesMatch($labels.shape,$logits.shape,"Error in sigmoidCrossEntropyWithLogits: ");var maxOutput=$logits.relu(),outputXTarget=$logits.mul($labels),sigmoidOutput=$logits.abs().neg().exp().log1p();return maxOutput.sub(outputXTarget).add(sigmoidOutput)}($multiClassLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.softmaxCrossEntropy=operation_1.op({softmaxCrossEntropy_:function(onehotLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $onehotLabels=tensor_util_env_1.convertToTensor(onehotLabels,"onehotLabels","softmaxCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","softmaxCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","softmaxCrossEntropy")),util_1.assertShapesMatch($onehotLabels.shape,$logits.shape,"Error in softmaxCrossEntropy: "),labelSmoothing>0){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),numClasses=tensor_ops_1.scalar($onehotLabels.shape[1]);$onehotLabels=$onehotLabels.mul(one.sub(labelSmoothingScalar)).add(labelSmoothingScalar.div(numClasses))}var losses=function(labels,logits,dim){if(void 0===dim&&(dim=-1),-1===dim&&(dim=logits.rank-1),dim!==logits.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+logits.rank+" and dim was "+dim);var customOp=gradients_1.customGrad((function(labels,logits,save){var lse=logits.logSumExp([dim],!0),logResult=logits.toFloat().sub(lse);return save([labels,logResult]),{value:logResult.mul(labels).neg().sum([dim]),gradFunc:function(dy,saved){var labels=saved[0],logResult=saved[1],dyShape=axis_util_1.expandShapeToKeepDim(dy.shape,[dim]);return[dy.reshape(dyShape).mul(labels.toFloat().sub(logResult.exp())),dy.reshape(dyShape).mul(logResult.exp().sub(labels.toFloat()))]}}}));return customOp(labels,logits)}($onehotLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}})},{"../gradients":110,"../tensor_util_env":210,"../util":214,"./axis_util":132,"./binary_ops":134,"./operation":163,"./tensor_ops":186}],158:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.localResponseNormalization=operation_1.op({localResponseNormalization_:function(x,depthRadius,bias,alpha,beta){void 0===depthRadius&&(depthRadius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5);var $x=tensor_util_env_1.convertToTensor(x,"x","localResponseNormalization");util.assert(4===$x.rank||3===$x.rank,(function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+$x.rank+"."})),util.assert(util.isInt(depthRadius),(function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+depthRadius+"."}));var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]));var res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.localResponseNormalization4D(x4D,depthRadius,bias,alpha,beta);return save([x4D,y]),y}),{x4D:x4D},(function(dy,saved){var x4D=saved[0],y=saved[1];return{x4D:function(){return engine_1.ENGINE.runKernelFunc((function(backend){return backend.LRNGrad(dy,x4D,y,depthRadius,bias,alpha,beta)}),{})}}}));return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163}],159:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.basicLSTMCell=operation_1.op({basicLSTMCell_:function(forgetBias,lstmKernel,lstmBias,data,c,h){var $forgetBias=tensor_util_env_1.convertToTensor(forgetBias,"forgetBias","basicLSTMCell"),$lstmKernel=tensor_util_env_1.convertToTensor(lstmKernel,"lstmKernel","basicLSTMCell"),$lstmBias=tensor_util_env_1.convertToTensor(lstmBias,"lstmBias","basicLSTMCell"),$data=tensor_util_env_1.convertToTensor(data,"data","basicLSTMCell"),$c=tensor_util_env_1.convertToTensor(c,"c","basicLSTMCell"),$h=tensor_util_env_1.convertToTensor(h,"h","basicLSTMCell"),res=$data.concat($h,1).matMul($lstmKernel).add($lstmBias),batchSize=res.shape[0],sliceCols=res.shape[1]/4,sliceSize=[batchSize,sliceCols],i=res.slice([0,0],sliceSize),j=res.slice([0,sliceCols],sliceSize),f=res.slice([0,2*sliceCols],sliceSize),o=res.slice([0,3*sliceCols],sliceSize),newC=i.sigmoid().mulStrict(j.tanh()).addStrict($c.mulStrict($forgetBias.add(f).sigmoid())),newH=newC.tanh().mulStrict(o.sigmoid());return[newC,newH]}}),exports.multiRNNCell=operation_1.op({multiRNNCell_:function(lstmCells,data,c,h){for(var $data=tensor_util_env_1.convertToTensor(data,"data","multiRNNCell"),$c=tensor_util_env_1.convertToTensorArray(c,"c","multiRNNCell"),$h=tensor_util_env_1.convertToTensorArray(h,"h","multiRNNCell"),input=$data,newStates=[],i=0;i<lstmCells.length;i++){var output=lstmCells[i](input,$c[i],$h[i]);newStates.push(output[0]),newStates.push(output[1]),input=output[1]}var newC=[],newH=[];for(i=0;i<newStates.length;i+=2)newC.push(newStates[i]),newH.push(newStates[i+1]);return[newC,newH]}})},{"../tensor_util_env":210,"./operation":163}],160:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.matMul=operation_1.op({matMul_:function(a,b,transposeA,transposeB){var _a;void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1);var $a=tensor_util_env_1.convertToTensor(a,"a","matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","matMul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert($a.rank>=2&&$b.rank>=2&&$a.rank===$b.rank,(function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."})),util.assert(util.arraysEqual(outerDimsA,outerDimsB),(function(){return"Error in matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."})),util.assert(innerShapeA===innerShapeB,(function(){return"Error in matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."}));var outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB),attrs={transposeA:transposeA,transposeB:transposeB},res=engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.batchMatMul(a3D,b3D,transposeA,transposeB);return save([a3D,b3D]),res}),{a:a3D,b:b3D},(function(dy,saved){var _a=saved,a3D=_a[0],b3D=_a[1];return transposeA||transposeB?!transposeA&&transposeB?{a:function(){return dy.matMul(b3D,!1,!1)},b:function(){return dy.matMul(a3D,!0,!1)}}:transposeA&&!transposeB?{a:function(){return b3D.matMul(dy,!1,!0)},b:function(){return a3D.matMul(dy,!1,!1)}}:{a:function(){return b3D.matMul(dy,!0,!0)},b:function(){return dy.matMul(a3D,!0,!0)}}:{a:function(){return dy.matMul(b3D,!1,!0)},b:function(){return a3D.matMul(dy,!0,!1)}}}),"BatchMatMul",attrs);return res.reshape(outShape)}}),exports.dot=operation_1.op({dot_:function(t1,t2){var $t1=tensor_util_env_1.convertToTensor(t1,"t1","dot"),$t2=tensor_util_env_1.convertToTensor(t2,"t2","dot");util.assert(!(1!==$t1.rank&&2!==$t1.rank||1!==$t2.rank&&2!==$t2.rank),(function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+$t1.rank+" and "+$t2.rank+"."}));var t1Inner=1===$t1.rank?$t1.size:$t1.shape[1],t2Inner=1===$t2.rank?$t2.size:$t2.shape[0];return util.assert(t1Inner===t2Inner,(function(){return"Error in dot: inner dimensions of inputs must match, but got "+t1Inner+" and "+t2Inner+"."})),1===$t1.rank&&1===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D(-1,1)).asScalar():1===$t1.rank&&2===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D($t2.shape[0],$t2.shape[1])).as1D():2===$t1.rank&&1===$t2.rank?$t1.matMul($t2.as2D(-1,1)).as1D():$t1.matMul($t2.as2D($t2.shape[0],$t2.shape[1]))}}),exports.outerProduct=operation_1.op({outerProduct_:function(v1,v2){var $v1=tensor_util_env_1.convertToTensor(v1,"v1","outerProduct"),$v2=tensor_util_env_1.convertToTensor(v2,"v2","outerProduct");return util.assert(1===$v1.rank&&1===$v2.rank,(function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+$v1.rank+" and "+$v2.rank+"."})),$v1.as2D(-1,1).matMul($v2.as2D(1,-1))}})},{"../engine":106,"../tensor_util":209,"../tensor_util_env":210,"../util":214,"./operation":163}],161:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.movingAverage=operation_1.op({movingAverage_:function(v,x,decay,step,zeroDebias){void 0===zeroDebias&&(zeroDebias=!0);var $v=tensor_util_env_1.convertToTensor(v,"v","movingAverage"),$x=tensor_util_env_1.convertToTensor(x,"x","movingAverage"),$decay=tensor_util_env_1.convertToTensor(decay,"decay","movingAverage");tensor_util_1.assertTypesMatch($v,$x),util.assert(util.arraysEqual($v.shape,$x.shape),(function(){return"Shape mismatch in v and x"}));var one=tensor_ops_1.scalar(1),oneMinusDecay=one.sub($decay),update=$x.sub($v).mul(oneMinusDecay);if(zeroDebias){util.assert(null!=step,(function(){return"When using zeroDebias: true, step is required."}));var $step=tensor_util_env_1.convertToTensor(step,"step","movingAverage");update=update.div(one.sub(binary_ops_1.pow($decay,$step)))}return $v.add(update)}})},{"../tensor_util":209,"../tensor_util_env":210,"../util":214,"./binary_ops":134,"./operation":163,"./tensor_ops":186}],162:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");function normImpl(x,p,axis){if(void 0===axis&&(axis=null),0===x.rank)return x.abs();if(1!==x.rank&&null===axis)return normImpl(x.reshape([-1]),p,axis);if(1===x.rank||"number"==typeof axis||Array.isArray(axis)&&1===axis.length){if(1===p)return x.abs().sum(axis);if(p===1/0)return x.abs().max(axis);if(p===-1/0)return x.abs().min(axis);if("euclidean"===p||2===p)return x.abs().pow(tensor_ops_1.scalar(2,"int32")).sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}if(Array.isArray(axis)&&2===axis.length){if(1===p)return x.abs().sum(axis[0]).max(axis[1]-1);if(p===1/0)return x.abs().sum(axis[1]).max(axis[0]);if(p===-1/0)return x.abs().sum(axis[1]).min(axis[0]);if("fro"===p||"euclidean"===p)return x.square().sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}throw new Error("Error in norm: invalid axis: "+axis)}exports.norm=operation_1.op({norm_:function(x,ord,axis,keepDims){void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var norm=normImpl(x=tensor_util_env_1.convertToTensor(x,"x","norm"),ord,axis),keepDimsShape=norm.shape;if(keepDims){var axes=util_1.parseAxisParam(axis,x.shape);keepDimsShape=axis_util.expandShapeToKeepDim(norm.shape,axes)}return norm.reshape(keepDimsShape)}})},{"../tensor_util_env":210,"../util":214,"./axis_util":132,"./operation":163,"./tensor_ops":186}],163:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var engine_1=require("../engine");exports.op=function(f){var keys=Object.keys(f);if(1!==keys.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+keys.length+" keys.");var opName=keys[0],fn=f[opName];opName.endsWith("_")&&(opName=opName.substring(0,opName.length-1));var f2=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];engine_1.ENGINE.startScope(opName);try{var result=fn.apply(void 0,args);return result instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),engine_1.ENGINE.endScope(result),result}catch(ex){throw engine_1.ENGINE.endScope(null),ex}};return Object.defineProperty(f2,"name",{value:opName,configurable:!0}),f2}},{"../engine":106}],164:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0});var square_1=require("./square");exports.square=square_1.square;var squared_difference_1=require("./squared_difference");exports.squaredDifference=squared_difference_1.squaredDifference,__export(require("./batchnorm")),__export(require("./boolean_mask")),__export(require("./complex_ops")),__export(require("./concat_split"));var conv_1=require("./conv");exports.conv1d=conv_1.conv1d,exports.conv2d=conv_1.conv2d,exports.conv3d=conv_1.conv3d,exports.depthwiseConv2d=conv_1.depthwiseConv2d,exports.separableConv2d=conv_1.separableConv2d,exports.conv2dTranspose=conv_1.conv2dTranspose,exports.conv3dTranspose=conv_1.conv3dTranspose,__export(require("./matmul")),__export(require("./reverse")),__export(require("./pool")),__export(require("./slice")),__export(require("./unary_ops")),__export(require("./reduction_ops")),__export(require("./compare")),__export(require("./binary_ops")),__export(require("./relu_ops")),__export(require("./logical_ops")),__export(require("./array_ops")),__export(require("./tensor_ops")),__export(require("./transpose")),__export(require("./softmax")),__export(require("./lrn")),__export(require("./norm")),__export(require("./segment_ops")),__export(require("./lstm")),__export(require("./moving_average")),__export(require("./strided_slice")),__export(require("./topk")),__export(require("./scatter_nd")),__export(require("./spectral_ops")),__export(require("./sparse_to_dense")),__export(require("./gather_nd")),__export(require("./diag")),__export(require("./dropout")),__export(require("./signal_ops")),__export(require("./in_top_k"));var operation_1=require("./operation");exports.op=operation_1.op;var losses=require("./loss_ops");exports.losses=losses;var linalg=require("./linalg_ops");exports.linalg=linalg;var image=require("./image_ops");exports.image=image;var spectral=require("./spectral_ops");exports.spectral=spectral;var fused=require("./fused_ops");exports.fused=fused;var signal=require("./signal_ops");exports.signal=signal},{"./array_ops":130,"./batchnorm":133,"./binary_ops":134,"./boolean_mask":135,"./compare":138,"./complex_ops":139,"./concat_split":140,"./conv":143,"./diag":145,"./dropout":146,"./fused_ops":149,"./gather_nd":151,"./image_ops":153,"./in_top_k":154,"./linalg_ops":155,"./logical_ops":156,"./loss_ops":157,"./lrn":158,"./lstm":159,"./matmul":160,"./moving_average":161,"./norm":162,"./operation":163,"./pool":165,"./reduction_ops":168,"./relu_ops":169,"./reverse":170,"./scatter_nd":171,"./segment_ops":173,"./signal_ops":176,"./slice":177,"./softmax":179,"./sparse_to_dense":180,"./spectral_ops":182,"./square":183,"./squared_difference":184,"./strided_slice":185,"./tensor_ops":186,"./topk":187,"./transpose":188,"./unary_ops":189}],165:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),conv_util=require("./conv_util"),operation_1=require("./operation");function maxPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),null==dilations&&(dilations=[1,1]),util.assert(4===x4D.rank,(function(){return"Error in maxPool: input must be rank 4 but got rank "+x4D.rank+"."})),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode);if(1===convInfo.filterWidth&&1===convInfo.filterHeight&&util.arraysEqual(convInfo.inShape,convInfo.outShape))return $x.clone();var inputsToSave=[x4D],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.maxPool(x4D,convInfo);return save([x4D,y]),y}),{x:x4D},(function(dy,saved){var x4D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPoolBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPoolBackprop");util.assert($input.rank===$dy.rank,(function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"})),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),util.assert(4===$dy.rank,(function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+$dy.rank+"."})),util.assert(4===$input.rank,(function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+$input.rank+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool2DInfo($input.shape,filterSize,strides,dilations,pad,dimRoundingMode);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.maxPoolBackprop($dy,$input,$output,convInfo)}),{$dy:$dy,$input:$input})}(dy,x4D,y,filterSize,strides,dilations,pad)}}}),"MaxPool",convInfo,inputsToSave);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function avgPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool","float32");null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}));var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,(function(){return"Error in avgPool: x must be rank 4 but got rank "+x4D.rank+"."})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode);if(1===convInfo.filterWidth&&1===convInfo.filterHeight&&util.arraysEqual(convInfo.inShape,convInfo.outShape))return $x.clone();var res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.avgPool(x4D,convInfo)}),{x:x4D},(function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPoolBackprop");util.assert($input.rank===$dy.rank,(function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"})),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}));var input4D=$input,dy4D=$dy,reshapedTo4D=!1;3===$input.rank&&(reshapedTo4D=!0,input4D=$input.as4D(1,$input.shape[0],$input.shape[1],$input.shape[2]),dy4D=$dy.as4D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2]));util.assert(4===dy4D.rank,(function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+dy4D.rank+"."})),util.assert(4===input4D.rank,(function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+input4D.rank+"."}));var convInfo=conv_util.computePool2DInfo(input4D.shape,filterSize,strides,dilations,pad),res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.avgPoolBackprop(dy4D,input4D,convInfo)}),{dy4D:dy4D,input4D:input4D});if(reshapedTo4D)return res.as3D(res.shape[1],res.shape[2],res.shape[3]);return res}(dy,x4D,filterSize,strides,dilations,pad)}}}),"AvgPool",convInfo);return res=res.cast($x.dtype),reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}exports.maxPool=operation_1.op({maxPool_:function(x,filterSize,strides,pad,dimRoundingMode){return maxPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.avgPool=operation_1.op({avgPool_:function(x,filterSize,strides,pad,dimRoundingMode){return avgPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.pool=operation_1.op({pool_:function(input,windowShape,poolingType,pad,dilations,strides){null==dilations&&(dilations=[1,1]),null==strides&&(strides=1),0===pad&&(pad="valid");var $x=tensor_util_env_1.convertToTensor(input,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}));var basePadding,convInfo=conv_util.computePool2DInfo(x4D.shape,windowShape,strides,dilations,pad),dilation=[convInfo.dilationHeight,convInfo.dilationWidth];basePadding="same"===pad?function(filterShape,dilation){var padExtraShape=filterShape.map((function(s,i){return s+(s-1)*(dilation[i]-1)})).map((function(s){return s-1})),padExtraStart=padExtraShape.map((function(s){return Math.floor(s/2)})),padExtraEnd=padExtraShape.map((function(s,i){return s-padExtraStart[i]}));return padExtraShape.map((function(_,i){return[padExtraStart[i],padExtraEnd[i]]}))}([convInfo.filterHeight,convInfo.filterWidth],dilation):[[0,0],[0,0]];var isDilationOne=1===dilation[0]&&1===dilation[1],_a=function(inputShape,blockShape,basePadding){var padStart=basePadding.map((function(b){return b[0]})),origPadEnd=basePadding.map((function(b){return b[1]})),fullInputShape=inputShape.concat(padStart,origPadEnd),padEndExtra=blockShape.map((function(b,i){return(b-fullInputShape[i]%b)%b})),padEnd=origPadEnd.map((function(s,i){return s+padEndExtra[i]})),paddings=blockShape.map((function(_,i){return[padStart[i],padEnd[i]]})),crops=blockShape.map((function(_,i){return[0,padEndExtra[i]]}));return[paddings,crops]}([convInfo.inHeight,convInfo.inWidth],dilation,basePadding),adjustedPadding=_a[0],adjustedCrops=_a[1],convertedPad=isDilationOne?pad:"valid",convertedX=isDilationOne?x4D:array_ops_1.spaceToBatchND(x4D,dilation,adjustedPadding),y=("avg"===poolingType?function(){return avgPoolImpl_(convertedX,windowShape,strides,1,convertedPad)}:function(){return maxPoolImpl_(convertedX,windowShape,strides,1,convertedPad)})(),res=isDilationOne?y:array_ops_1.batchToSpaceND(y,dilation,adjustedCrops);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.maxPool3d=operation_1.op({maxPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,(function(){return"Error in maxPool3d: x must be rank 5 but got rank "+x5D.rank+"."})),util.assert("NDHWC"===dataFormat,(function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat})),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.maxPool3d(x5D,convInfo);return save([x5D,y]),y}),{x:x5D},(function(dy,saved){var x5D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPool3dBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPool3dBackprop"),dy5D=$dy,input5D=$input,output5D=$output,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]),output5D=$output.as5D(1,$output.shape[0],$output.shape[1],$output.shape[2],$output.shape[3]));util.assert(5===dy5D.rank,(function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."})),util.assert(5===input5D.rank,(function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."})),util.assert(5===output5D.rank,(function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+output5D.rank+"."})),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.maxPool3dBackprop(dy5D,input5D,output5D,convInfo)}),{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,y,filterSize,strides,dilations,pad,dimRoundingMode)}}}));return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.avgPool3d=operation_1.op({avgPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool3d","float32"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,(function(){return"Error in avgPool3d: x must be rank 5 but got rank "+x5D.rank+"."})),util.assert("NDHWC"===dataFormat,(function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat})),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.avgPool3d(x5D,convInfo)}),{x:x5D},(function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPool3dBackprop"),dy5D=$dy,input5D=$input,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]));util.assert(5===dy5D.rank,(function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."})),util.assert(5===input5D.rank,(function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."})),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),(function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"})),null!=dimRoundingMode&&util.assert(util.isInt(pad),(function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}));var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.avgPool3dBackprop(dy5D,input5D,convInfo)}),{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,filterSize,strides,dilations,pad,dimRoundingMode)}}}));return res=res.cast(x5D.dtype),reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./array_ops":130,"./conv_util":144,"./operation":163}],166:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),MPRandGauss=function(){function MPRandGauss(mean,stdDeviation,dtype,truncated,seed){this.mean=mean,this.stdDev=stdDeviation,this.dtype=dtype,this.nextVal=NaN,this.truncated=truncated,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var seedValue=seed||Math.random();this.random=seedrandom.alea(seedValue.toString())}return MPRandGauss.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var value=this.nextVal;return this.nextVal=NaN,value}for(var resultX,resultY,isValid=!1;!isValid;){var v1=void 0,v2=void 0,s=void 0;do{s=(v1=2*this.random()-1)*v1+(v2=2*this.random()-1)*v2}while(s>=1||0===s);var mul=Math.sqrt(-2*Math.log(s)/s);resultX=this.mean+this.stdDev*v1*mul,resultY=this.mean+this.stdDev*v2*mul,this.truncated&&!this.isValidTruncated(resultX)||(isValid=!0)}return this.truncated&&!this.isValidTruncated(resultY)||(this.nextVal=this.convertValue(resultY)),this.convertValue(resultX)},MPRandGauss.prototype.convertValue=function(value){return null==this.dtype||"float32"===this.dtype?value:Math.round(value)},MPRandGauss.prototype.isValidTruncated=function(value){return value<=this.upper&&value>=this.lower},MPRandGauss}();exports.MPRandGauss=MPRandGauss;var RandGamma=function(){function RandGamma(alpha,beta,dtype,seed){this.alpha=alpha,this.beta=1/beta,this.dtype=dtype;var seedValue=seed||Math.random();this.randu=seedrandom.alea(seedValue.toString()),this.randn=new MPRandGauss(0,1,dtype,!1,this.randu()),this.d=alpha<1?alpha+2/3:alpha-1/3,this.c=1/Math.sqrt(9*this.d)}return RandGamma.prototype.nextValue=function(){for(var x2,v0,v1,x,u,v;;){do{x=this.randn.nextValue(),v=1+this.c*x}while(v<=0);if(v*=v*v,v0=1-.331*(x2=x*x)*x2,v1=.5*x2+this.d*(1-v+Math.log(v)),(u=this.randu())<v0||Math.log(u)<v1)break}return v=1/this.beta*this.d*v,this.alpha<1&&(v*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(v)},RandGamma.prototype.convertValue=function(value){return"float32"===this.dtype?value:Math.round(value)},RandGamma}();exports.RandGamma=RandGamma;var UniformRandom=function(){function UniformRandom(min,max,dtype,seed){var _this=this;if(void 0===min&&(min=0),void 0===max&&(max=1),this.canReturnFloat=function(){return null==_this.dtype||"float32"===_this.dtype},this.min=min,this.range=max-min,this.dtype=dtype,null==seed&&(seed=Math.random()),"number"==typeof seed&&(seed=seed.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+min+" - "+max+" <= 1 and dtype is not float");this.random=seedrandom.alea(seed)}return UniformRandom.prototype.convertValue=function(value){return this.canReturnFloat()?value:Math.round(value)},UniformRandom.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},UniformRandom}();exports.UniformRandom=UniformRandom},{seedrandom:397}],167:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.PARALLELIZE_THRESHOLD=30,exports.computeOptimalWindowSize=function(inSize){return inSize<=exports.PARALLELIZE_THRESHOLD?inSize:util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)))}},{"../util":214}],168:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");function gradForMinAndMax(dy,y,xOrig,origAxes,permutedAxes){return y.rank<xOrig.rank&&(y=y.reshape(axis_util.expandShapeToKeepDim(y.shape,origAxes))),dy.rank<xOrig.rank&&(dy=dy.reshape(axis_util.expandShapeToKeepDim(dy.shape,origAxes))),{x:function(){var dx=dy.mul(xOrig.equal(y).cast(dy.dtype));return null==permutedAxes?dx:dx.transpose(permutedAxes)}}}exports.all=operation_1.op({all_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","all","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.all($x,axes)}),{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.any=operation_1.op({any_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","any","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernelFunc((function(backend){return backend.any($x,axes)}),{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.argMax=operation_1.op({argMax_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMax");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var attrs={axis:axes[0]},inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.argMax($x,axes[0]);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return tensor_ops_1.zerosLike($x)}}}),"ArgMax",attrs,inputsToSave)}}),exports.argMin=operation_1.op({argMin_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMin");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);return null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank)),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.argMin($x,axes[0]);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return tensor_ops_1.zerosLike($x)}}}))}}),exports.logSumExp=operation_1.op({logSumExp_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","logSumExp"),axes=util.parseAxisParam(axis,$x.shape),xMax=$x.max(axes,!0),d=$x.sub(xMax).exp().sum(axes).log(),res=xMax.reshape(d.shape).add(d);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,axes);return res.reshape(newShape)}return res}}),exports.max=operation_1.op({max_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","max"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var inputsToSave=[$x],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.max($x,axes);return save([xOrig,y]),y}),{x:$x},(function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)}),"Max",{axes:axes},inputsToSave,[!0]);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.mean=operation_1.op({mean_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","mean"),axes=util.parseAxisParam(axis,$x.shape),reduceShape=axis_util.computeOutAndReduceShapes($x.shape,axes)[1],reduceSize=util.sizeFromShape(reduceShape),customOp=gradients_1.customGrad((function(x){var reduceSizeScalar=tensor_ops_1.scalar(reduceSize);return{value:(reduceSizeScalar.dtype===x.dtype?x:x.cast(reduceSizeScalar.dtype)).div(reduceSizeScalar).sum(axis,keepDims),gradFunc:function(dy){var expandedDyShape=x.shape.slice();return axes.forEach((function(axis){expandedDyShape[axis]=1})),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32")).div(reduceSize)}}}));return customOp($x)}}),exports.min=operation_1.op({min_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","min"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var inputsToSave=[$x],res=engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.min($x,axes);return save([xOrig,y]),y}),{x:$x},(function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)}),"Min",{axes:axes},inputsToSave,[!0]);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.moments=operation_1.op({moments_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),x=tensor_util_env_1.convertToTensor(x,"x","moments");var axes=util.parseAxisParam(axis,x.shape),mean=x.mean(axes,keepDims),keepDimsShape=mean.shape;keepDims||(keepDimsShape=axis_util.expandShapeToKeepDim(mean.shape,axes));var devSquared=x.toFloat().sub(mean.reshape(keepDimsShape)).square();return{mean:mean,variance:devSquared.mean(axes,keepDims)}}}),exports.sum=operation_1.op({sum_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","sum");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape),customOp=gradients_1.customGrad((function(x){var permutation=axis_util.getAxesPermutation(axes,x.rank),reductionAxes=axes,permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,x.rank));var gradFunc=function(dy){var expandedDyShape=x.shape.slice();return axes.forEach((function(axis){expandedDyShape[axis]=1})),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32"))},attrs={axes:reductionAxes},value=engine_1.ENGINE.runKernelFunc((function(backend){return backend.sum(permutedX,reductionAxes)}),{x:permutedX},(function(dy){return{x:function(){return gradFunc(dy)}}}),"Sum",attrs);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return{value:value,gradFunc:gradFunc}}));return customOp($x)}}),exports.prod=operation_1.op({prod_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","prod");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape),permutation=axis_util.getAxesPermutation(axes,$x.rank),reductionAxes=axes,permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,$x.rank));var value=engine_1.ENGINE.runKernelFunc((function(backend){return backend.prod(permutedX,reductionAxes)}),{permutedX:permutedX});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return value}})},{"../engine":106,"../gradients":110,"../tensor_util_env":210,"../util":214,"./axis_util":132,"./operation":163,"./tensor_ops":186}],169:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),binary_ops_1=require("./binary_ops"),broadcast_util_1=require("./broadcast_util"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),selu_util_1=require("./selu_util"),tensor_ops_1=require("./tensor_ops");exports.elu=operation_1.op({elu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","elu");return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.elu($x);return save([y]),y}),{$x:$x},(function(dy,saved){var y=saved[0];return{$x:function(){return engine_1.ENGINE.runKernelFunc((function(backend){return backend.eluDer(dy,y)}),{dy:dy,y:y})}}}))}}),exports.leakyRelu=operation_1.op({leakyRelu_:function(x,alpha){void 0===alpha&&(alpha=.2);var $x=tensor_util_env_1.convertToTensor(x,"x","leakyRelu");return binary_ops_1.maximum(tensor_ops_1.scalar(alpha).mul($x),$x)}}),exports.prelu=operation_1.op({prelu_:function(x,alpha){var $x=tensor_util_env_1.convertToTensor(x,"x","prelu"),$alpha=tensor_util_env_1.convertToTensor(alpha,"alpha","prelu");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.prelu($x,$alpha);return save([$x,$alpha]),res}),{x:$x,alpha:$alpha},(function(dy,saved){var $x=saved[0],$alpha=saved[1],mask=$x.greater(0);return{x:function(){return logical_ops_1.where(mask,dy,dy.mul($alpha))},alpha:function(){var res=logical_ops_1.where(mask,tensor_ops_1.zerosLike(dy),dy.mul($x)),reduceAxes=broadcast_util_1.getReductionAxes($alpha.shape,dy.shape);return reduceAxes.length>0&&(res=res.sum(reduceAxes)),res.reshape($alpha.shape)}}}),"Prelu")}}),exports.relu=operation_1.op({relu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","relu");return"bool"===$x.dtype?$x.toInt():engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.relu($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return dy.mulStrict($x.step().toFloat())}}}),"Relu")}}),exports.relu6=operation_1.op({relu6_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","relu6");return"bool"===$x.dtype?$x.toInt():engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.relu6($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0],mask=$x.lessEqual(6).mul($x.step());return{x:function(){return dy.mulStrict(mask.toFloat())}}}),"Relu6")}}),exports.selu=operation_1.op({selu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","selu");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.selu($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){var mask=$x.greater(tensor_ops_1.scalar(0)),scaleAlpha=tensor_ops_1.scalar(selu_util_1.SELU_SCALEALPHA),scale=tensor_ops_1.scalar(selu_util_1.SELU_SCALE),greaterThanZeroDer=dy.mul(scale),lessEqualZeroDer=dy.mul(scaleAlpha).mul($x.toFloat().exp());return logical_ops_1.where(mask,greaterThanZeroDer,lessEqualZeroDer)}}}))}})},{"../engine":106,"../tensor_util_env":210,"./binary_ops":134,"./broadcast_util":136,"./logical_ops":156,"./operation":163,"./selu_util":175,"./tensor_ops":186}],170:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.reverse=operation_1.op({reverse_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");if(0===$x.rank)return $x.clone();var axes=util.parseAxisParam(axis,$x.shape);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.reverse($x,axes)}),{$x:$x},(function(dy){return{$x:function(){return dy.reverse(axes)}}})).reshapeAs($x)}}),exports.reverse1d=operation_1.op({reverse1d_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(1===$x.rank,(function(){return"Error in reverse1D: x must be rank 1 but got rank "+$x.rank+"."})),exports.reverse($x,0)}}),exports.reverse2d=operation_1.op({reverse2d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(2===$x.rank,(function(){return"Error in reverse2D: x must be rank 2 but got rank "+$x.rank+"."})),exports.reverse($x,axis)}}),exports.reverse3d=operation_1.op({reverse3d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(3===$x.rank,(function(){return"Error in reverse3D: x must be rank 3 but got rank "+$x.rank+"."})),exports.reverse($x,axis)}}),exports.reverse4d=operation_1.op({reverse4d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(4===$x.rank,(function(){return"Error in reverse4D: x must be rank 4 but got rank "+$x.rank+"."})),exports.reverse($x,axis)}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163}],171:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),scatter_nd_util=require("./scatter_nd_util");exports.scatterND=operation_1.op({scatterND_:function(indices,updates,shape){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","scatterND","int32"),$updates=tensor_util_env_1.convertToTensor(updates,"updates","scatterND");return scatter_nd_util.validateInput($updates,$indices,shape),engine_1.ENGINE.runKernelFunc((function(backend){return backend.scatterND($indices,$updates,shape)}),{indices:$indices,updates:$updates},null,"ScatterNd",{shape:shape})}})},{"../engine":106,"../tensor_util_env":210,"./operation":163,"./scatter_nd_util":172}],172:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");function validateUpdateShape(shape,indices,updates){var sliceDim=indices.rank>1?indices.shape[indices.rank-1]:1,batchDim=indices.rank>1?indices.rank-1:1,shapeError="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+updates.shape+", indices.shape: "+indices.shape+", shape: "+shape+", sliceDim: "+sliceDim+", and batchDim: "+batchDim+".";if(updates.rank<batchDim)throw new Error(shapeError+" update.rank < "+batchDim+". ");if(shape.length<sliceDim+(updates.rank-batchDim))throw new Error(shapeError+" Output shape length < "+(sliceDim+(updates.rank-batchDim)));if(updates.rank!==batchDim+shape.length-sliceDim)throw new Error(shapeError+" update.rank != "+(batchDim+shape.length-sliceDim));for(var d=0;d<batchDim;++d)if(updates.shape[d]!==indices.shape[d])throw new Error(shapeError+" updates.shape["+d+"] ("+updates.shape[d]+") != indices.shape["+d+"] ("+indices.shape[d]+").");for(d=0;d<updates.rank-batchDim;++d)if(updates.shape[d+batchDim]!==shape[d+sliceDim])throw new Error(shapeError+" updates.shape["+(d+batchDim)+"] ("+updates.shape[d+batchDim]+") != shape["+(d+batchDim)+"] ("+shape[d+batchDim]+")")}exports.validateUpdateShape=validateUpdateShape,exports.validateInput=function(updates,indices,shape){if(indices.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if(updates.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+updates.rank+".");if("int32"!==indices.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+indices.dtype);if(shape.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+shape);if(0===shape.length){if(0===indices.size)throw new Error("Indices specified for empty output. indices shape: "+indices.shape);if(0===updates.size)throw new Error("Updates specified for empty output. updates shape: "+updates.shape)}validateUpdateShape(shape,indices,updates)},exports.calculateShapes=function(updates,indices,shape){for(var indicesRank=indices.shape.length,sliceRank=indicesRank>1?indices.shape[indicesRank-1]:1,totalNd=shape.length,sliceSize=1,i=sliceRank;i<totalNd;++i)sliceSize*=shape[i];var safeSliceDim=sliceRank<1?1:sliceRank;return{sliceRank:sliceRank,numUpdates:util_1.sizeFromShape(indices.shape)/safeSliceDim,sliceSize:sliceSize,strides:util_1.computeStrides(shape.slice(0,sliceRank)).concat([1]),outputSize:util_1.sizeFromShape(shape)}}},{"../util":214}],173:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),array_ops_1=require("./array_ops"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),compare_1=require("./compare"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),segment_util_1=require("./segment_util"),tensor_ops_1=require("./tensor_ops");function arrayRange(start,stop){for(var result=[],i=start;i<stop;++i)result.push(i);return result}function arrayConcat(arrays){for(var result=[],i=0;i<arrays.length;++i)for(var j=0;j<arrays[i].length;++j)result.push(arrays[i][j]);return result}exports.gather=operation_1.op({gather_:function(x,indices,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","gather"),$indices=tensor_util_env_1.convertToTensor(indices,"indices","gather","int32");axis=util_1.parseAxisParam(axis,$x.shape)[0];var shapeInfo=segment_util_1.collectGatherOpShapeInfo($x,$indices,axis);return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.gather($x,$indices.flatten(),axis);return save([$indices]),res}),{x:$x,indices:$indices},(function(dy,saved){var $indices=saved[0];return{x:function(){var paramsShape=$x.shape,indicesSize=$indices.size,outerShape=paramsShape.slice(0,axis),outerDims=outerShape.length,innerShape=paramsShape.slice(axis,paramsShape.length).slice(1),innerDims=innerShape.length,outerAxesIndices=arrayRange(0,outerDims),innerAxesIndices=arrayRange(outerDims+1,outerDims+1+innerDims),valuesShape=arrayConcat([outerShape,[indicesSize],innerShape]),values=dy.reshape(valuesShape),reshapedIndices=$indices.reshape([indicesSize]),transposeDims=arrayConcat([[outerDims],outerAxesIndices,innerAxesIndices]),valuesTranspose=values.transpose(transposeDims),paramsGrad=exports.unsortedSegmentSum(valuesTranspose,reshapedIndices,$x.shape[axis]),invertTransposeDims=axis_util_1.getUndoAxesPermutation(transposeDims);return paramsGrad=paramsGrad.transpose(invertTransposeDims)},indices:function(){return $indices}}}),"Gather",{axis:axis}).reshape(shapeInfo.outputShape)}}),exports.unsortedSegmentSum=operation_1.op({unsortedSegmentSum_:function(x,segmentIds,numSegments){var $x=tensor_util_env_1.convertToTensor(x,"x","unsortedSegmentSum"),$segmentIds=tensor_util_env_1.convertToTensor(segmentIds,"segmentIds","unsortedSegmentSum","int32");return util_1.assert(util_1.isInt(numSegments),(function(){return"numSegments must be of dtype int"})),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.unsortedSegmentSum($x,$segmentIds,numSegments);return save([$segmentIds]),res}),{$x:$x},(function(dy,saved){var $segmentIds=saved[0];return{$x:function(){return function(x,indices){for(var zeroClippedIndices=binary_ops_1.maximum(indices,tensor_ops_1.zerosLike(indices)),gathered=exports.gather(x,zeroClippedIndices),isPositive=compare_1.greaterEqual(indices,tensor_ops_1.scalar(0,"int32")),numIters=gathered.rank-isPositive.rank,i=0;i<numIters;++i)isPositive=array_ops_1.expandDims(isPositive,i+1);isPositive=logical_ops_1.logicalAnd(isPositive,tensor_ops_1.ones(gathered.shape,"bool"));var zeroSlice=tensor_ops_1.zerosLike(gathered);return logical_ops_1.where(isPositive,gathered,zeroSlice)}(dy,$segmentIds)}}}))}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./array_ops":130,"./axis_util":132,"./binary_ops":134,"./compare":138,"./logical_ops":156,"./operation":163,"./segment_util":174,"./tensor_ops":186}],174:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),reduce_util_1=require("./reduce_util");exports.segOpComputeOptimalWindowSize=function(inSize,numSegments){var res,done=!1;for(inSize<=reduce_util_1.PARALLELIZE_THRESHOLD?(res=inSize,done=!0):res=util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)));!done;)res>numSegments||res===inSize?done=!0:res=util_1.nearestDivisor(inSize,res+1);return res},exports.computeOutShape=function(aShape,axis,numSegments){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)dim!==axis?outShape.push(aShape[dim]):outShape.push(numSegments);return outShape},exports.collectGatherOpShapeInfo=function(x,indices,axis){for(var dimSize=x.shape[axis],outputShape=[],batchSize=1,sliceSize=1,i=0;i<axis;i++)outputShape.push(x.shape[i]),batchSize*=x.shape[i];for(i=0;i<indices.rank;i++)outputShape.push(indices.shape[i]);for(i=axis+1;i<x.rank;i++)outputShape.push(x.shape[i]),sliceSize*=x.shape[i];return{batchSize:batchSize,sliceSize:sliceSize,dimSize:dimSize,outputShape:outputShape}}},{"../util":214,"./reduce_util":167}],175:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),exports.SELU_SCALEALPHA=1.7580993408473768,exports.SELU_SCALE=1.0507009873554805},{}],176:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var operation_1=require("../ops/operation"),binary_ops_1=require("./binary_ops"),concat_split_1=require("./concat_split"),slice_1=require("./slice"),spectral_ops_1=require("./spectral_ops"),tensor_ops_1=require("./tensor_ops");function cosineWindow(windowLength,a,b){for(var even=1-windowLength%2,newValues=new Float32Array(windowLength),i=0;i<windowLength;++i){var cosArg=2*Math.PI*i/(windowLength+even-1);newValues[i]=a-b*Math.cos(cosArg)}return tensor_ops_1.tensor1d(newValues,"float32")}exports.hannWindow=operation_1.op({hannWindow_:function(windowLength){return cosineWindow(windowLength,.5,.5)}}),exports.hammingWindow=operation_1.op({hammingWindow_:function(windowLength){return cosineWindow(windowLength,.54,.46)}}),exports.frame=operation_1.op({frame_:function(signal,frameLength,frameStep,padEnd,padValue){void 0===padEnd&&(padEnd=!1),void 0===padValue&&(padValue=0);for(var start=0,output=[];start+frameLength<=signal.size;)output.push(slice_1.slice(signal,start,frameLength)),start+=frameStep;if(padEnd)for(;start<signal.size;){var padLen=start+frameLength-signal.size,pad=concat_split_1.concat([slice_1.slice(signal,start,frameLength-padLen),tensor_ops_1.fill([padLen],padValue)]);output.push(pad),start+=frameStep}return 0===output.length?tensor_ops_1.tensor2d([],[0,frameLength]):concat_split_1.concat(output).as2D(output.length,frameLength)}}),exports.stft=operation_1.op({stft_:function(signal,frameLength,frameStep,fftLength,windowFn){var value;void 0===windowFn&&(windowFn=exports.hannWindow),null==fftLength&&(value=frameLength,fftLength=Math.floor(Math.pow(2,Math.ceil(Math.log(value)/Math.log(2)))));for(var framedSignal=exports.frame(signal,frameLength,frameStep),windowedSignal=binary_ops_1.mul(framedSignal,windowFn(frameLength)),output=[],i=0;i<framedSignal.shape[0];i++)output.push(spectral_ops_1.rfft(windowedSignal.slice([i,0],[1,frameLength]),fftLength));return concat_split_1.concat(output)}})},{"../ops/operation":163,"./binary_ops":134,"./concat_split":140,"./slice":177,"./spectral_ops":182,"./tensor_ops":186}],177:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),slice_util=require("./slice_util");exports.slice=operation_1.op({slice_:function(x,begin,size){var begin_,size_,$x=tensor_util_env_1.convertToTensor(x,"x","slice");if(0===$x.rank)throw new Error("Slicing scalar is not possible");(begin_="number"==typeof begin?[begin].concat(new Array($x.rank-1).fill(0)):begin.length<$x.rank?begin.concat(new Array($x.rank-begin.length).fill(0)):begin.slice()).forEach((function(d){util.assert(-1!==d,(function(){return"slice() does not support negative begin indexing."}))})),size_=(size_=null==size?new Array($x.rank).fill(-1):"number"==typeof size?[size].concat(new Array($x.rank-1).fill(-1)):size.length<$x.rank?size.concat(new Array($x.rank-size.length).fill(-1)):size).map((function(d,i){return d>=0?d:(util.assert(-1===d,(function(){return"Negative size values should be exactly -1 but got "+d+" for the slice() size at index "+i+"."})),$x.shape[i]-begin_[i])})),slice_util.assertParamsValid($x,begin_,size_);var inputShape=$x.shape,attrs={begin:begin_,size:size_};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.slice($x,begin_,size_)}),{x:$x},(function(dy){for(var paddings=[],i=0;i<dy.rank;i++)paddings.push([begin_[i],inputShape[i]-begin_[i]-size_[i]]);return{x:function(){return dy.pad(paddings)}}}),"Slice",attrs)}}),exports.slice1d=operation_1.op({slice1d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice1d");return util.assert(1===$x.rank,(function(){return"slice1d expects a rank-1 tensor, but got a rank-"+$x.rank+" tensor"})),exports.slice($x,[begin],[size])}}),exports.slice2d=operation_1.op({slice2d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice2d");return util.assert(2===$x.rank,(function(){return"slice2d expects a rank-2 tensor, but got a rank-"+$x.rank+" tensor"})),exports.slice($x,begin,size)}}),exports.slice3d=operation_1.op({slice3d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice3d");return util.assert(3===$x.rank,(function(){return"slice3d expects a rank-3 tensor, but got a rank-"+$x.rank+" tensor"})),exports.slice($x,begin,size)}}),exports.slice4d=operation_1.op({slice4d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice4d");return util.assert(4===$x.rank,(function(){return"slice4d expects a rank-4 tensor, but got a rank-"+$x.rank+" tensor"})),exports.slice($x,begin,size)}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163,"./slice_util":178}],178:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParamsValid=function(input,begin,size){util.assert(input.rank===begin.length,(function(){return"Error in slice"+input.rank+"D: Length of begin "+begin+" must match the rank of the array ("+input.rank+")."})),util.assert(input.rank===size.length,(function(){return"Error in slice"+input.rank+"D: Length of size "+size+" must match the rank of the array ("+input.rank+")."}));for(var _loop_1=function(i){util.assert(begin[i]+size[i]<=input.shape[i],(function(){return"Error in slice"+input.rank+"D: begin["+i+"] + size["+i+"] ("+(begin[i]+size[i])+") would overflow input.shape["+i+"] ("+input.shape[i]+")"}))},i=0;i<input.rank;++i)_loop_1(i)},exports.maskToAxes=function(mask){for(var axes=[],axis=0;mask>0;)1&mask&&axes.push(axis),mask/=2,axis++;return axes},exports.computeOutShape=function(begin,end,strides){for(var size=[],axis=0;axis<begin.length;axis++)size[axis]=Math.ceil((end[axis]-begin[axis])/strides[axis]);return size},exports.startForAxis=function(beginMask,startIndices,strides,inputShape,axis){var start=startIndices[axis],stride=strides[axis]||1;(beginMask&1<<axis||null==start)&&(start=stride>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var axisSize=inputShape[axis];return start<0&&(start+=axisSize),start=util.clamp(0,start,axisSize-1)},exports.stopForAxis=function(endMask,stopIndices,strides,inputShape,axis){var stop=stopIndices[axis],stride=strides[axis]||1;(endMask&1<<axis||null==stop)&&(stop=stride>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var axisSize=inputShape[axis];return stop<0&&(stop+=axisSize),stop=stride>0?util.clamp(0,stop,axisSize):util.clamp(-1,stop,axisSize-1)},exports.isSliceContinous=function(shape,begin,size){for(var firstNonOneAxis=size.length,i=0;i<size.length;i++)if(size[i]>1){firstNonOneAxis=i;break}for(i=firstNonOneAxis+1;i<size.length;i++)if(begin[i]>0||size[i]!==shape[i])return!1;return!0},exports.computeFlatOffset=function(begin,strides){for(var flatOffset=begin.length>0?begin[begin.length-1]:1,i=0;i<begin.length-1;i++)flatOffset+=begin[i]*strides[i];return flatOffset}},{"../util":214}],179:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.softmax=operation_1.op({softmax_:function(logits,dim){void 0===dim&&(dim=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","softmax","float32");if(-1===dim&&(dim=$logits.rank-1),dim!==$logits.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and dim was "+dim);return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.softmax($logits,dim);return save([y]),y}),{logits:$logits},(function(dy,saved){var y=saved[0],dyTimesY=dy.mul(y);return{logits:function(){return dyTimesY.sub(dyTimesY.sum([dim],true).mul(y))}}}),"Softmax",{dim:dim},[],[!0])}}),exports.logSoftmax=operation_1.op({logSoftmax_:function(logits,axis){void 0===axis&&(axis=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","logSoftmax");if(-1===axis&&(axis=$logits.rank-1),axis!==$logits.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and axis was "+axis);var customOp=gradients_1.customGrad((function(logits,save){var xMax=logits.max(axis,!0),shifted=logits.sub(xMax),value=shifted.toFloat().sub(shifted.exp().sum(axis,true).log());save([value]);return{value:value,gradFunc:function(dy,saved){var softmax=saved[0].exp();return dy.sub(dy.sum(axis,true).mul(softmax))}}}));return customOp($logits)}})},{"../engine":106,"../gradients":110,"../tensor_util_env":210,"./operation":163}],180:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),sparse_to_dense=require("../ops/sparse_to_dense_util"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.sparseToDense=operation_1.op({sparseToDense_:function(sparseIndices,sparseValues,outputShape,defaultValue){void 0===defaultValue&&(defaultValue=0);var $sparseIndices=tensor_util_env_1.convertToTensor(sparseIndices,"sparseIndices","sparseToDense","int32"),$sparseValues=tensor_util_env_1.convertToTensor(sparseValues,"sparseValues","sparseToDense"),$defaultValue=tensor_util_env_1.convertToTensor(defaultValue,"defaultValue","sparseToDense",$sparseValues.dtype);return sparse_to_dense.validateInput($sparseIndices,$sparseValues,outputShape,$defaultValue),engine_1.ENGINE.runKernelFunc((function(backend){return backend.sparseToDense($sparseIndices,$sparseValues,outputShape,$defaultValue)}),{$sparseIndices:$sparseIndices,$sparseValues:$sparseValues,$defaultValue:$defaultValue})}})},{"../engine":106,"../ops/sparse_to_dense_util":181,"../tensor_util_env":210,"./operation":163}],181:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateInput=function(sparseIndices,sparseValues,outputShape,defaultValues){if("int32"!==sparseIndices.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+sparseIndices.dtype+".");if(sparseIndices.rank>2)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+sparseIndices.shape+".");var numElems=sparseIndices.rank>0?sparseIndices.shape[0]:1,numDims=sparseIndices.rank>1?sparseIndices.shape[1]:1;if(outputShape.length!==numDims)throw new Error("outputShape has incorrect number of elements:, "+outputShape.length+", should be: "+numDims+".");var numValues=sparseValues.size;if(0!==sparseValues.rank&&(1!==sparseValues.rank||numValues!==numElems))throw new Error("sparseValues has incorrect shape "+sparseValues.shape+", should be [] or ["+numElems+"]");if(sparseValues.dtype!==defaultValues.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}},{}],182:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),complex_ops_1=require("../ops/complex_ops"),operation_1=require("../ops/operation"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.fft=operation_1.op({fft_:function(input){util_1.assert("complex64"===input.dtype,(function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+input.dtype+"."}));var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.fft(input2D)}),{input:input}).reshape(input.shape)}}),exports.ifft=operation_1.op({ifft_:function(input){util_1.assert("complex64"===input.dtype,(function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+input.dtype+"."}));var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernelFunc((function(backend){return backend.ifft(input2D)}),{input:input}).reshape(input.shape)}}),exports.rfft=operation_1.op({rfft_:function(input,fftLength){util_1.assert("float32"===input.dtype,(function(){return"The dtype for rfft() must be real value but got "+input.dtype}));var adjustedInput,innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(null!=fftLength&&fftLength<innerDimensionSize){var begin=input.shape.map((function(v){return 0})),size=input.shape.map((function(v){return v}));size[input.shape.length-1]=fftLength,adjustedInput=input.slice(begin,size),innerDimensionSize=fftLength}else if(null!=fftLength&&fftLength>innerDimensionSize){var zerosShape=input.shape.map((function(v){return v}));zerosShape[input.shape.length-1]=fftLength-innerDimensionSize,adjustedInput=input.concat(tensor_ops_1.zeros(zerosShape),input.shape.length-1),innerDimensionSize=fftLength}else adjustedInput=input;var zerosInput=adjustedInput.zerosLike(),complexInput=complex_ops_1.complex(adjustedInput,zerosInput).as2D(batch,innerDimensionSize),ret=exports.fft(complexInput),half=Math.floor(innerDimensionSize/2)+1,realValues=complex_ops_1.real(ret),imagValues=complex_ops_1.imag(ret),realComplexConjugate=realValues.split([half,innerDimensionSize-half],realValues.shape.length-1),imagComplexConjugate=imagValues.split([half,innerDimensionSize-half],imagValues.shape.length-1),outputShape=adjustedInput.shape.slice();return outputShape[adjustedInput.shape.length-1]=half,complex_ops_1.complex(realComplexConjugate[0],imagComplexConjugate[0]).reshape(outputShape)}}),exports.irfft=operation_1.op({irfft_:function(input){var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(innerDimensionSize<=2){var complexInput=input.as2D(batch,innerDimensionSize),ret=exports.ifft(complexInput);return complex_ops_1.real(ret)}var outputShape=[batch,2*(innerDimensionSize-1)],realInput=complex_ops_1.real(input).as2D(batch,innerDimensionSize),imagInput=complex_ops_1.imag(input).as2D(batch,innerDimensionSize),realConjugate=realInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1),imagConjugate=imagInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1).mul(tensor_ops_1.scalar(-1)),r=realInput.concat(realConjugate,1),i=imagInput.concat(imagConjugate,1);return complexInput=complex_ops_1.complex(r,i).as2D(outputShape[0],outputShape[1]),ret=exports.ifft(complexInput),complex_ops_1.real(ret)}})},{"../engine":106,"../ops/complex_ops":139,"../ops/operation":163,"../util":214,"./tensor_ops":186}],183:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.square=operation_1.op({square_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","square"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){return save([$x]),backend.square($x)}),{x:$x},null,"Square",{},inputsToSave,[])}})},{"../engine":106,"../tensor_util_env":210,"./operation":163}],184:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),kernel_names_1=require("../kernel_names"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.squaredDifference=operation_1.op({squaredDifference_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","squaredDifference"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifference");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape);var inputs={a:$a,b:$b},inputsToSave=[$a,$b];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.squaredDifference($a,$b);return save([$a,$b]),res}),inputs,(function(dy,saved){var $a=saved[0],$b=saved[1],two=tensor_ops_1.scalar(2);return{a:function(){return dy.mul($a.sub($b).mul(two))},b:function(){return dy.mul($b.sub($a).mul(two))}}}),kernel_names_1.SquaredDifference,{},inputsToSave,[])}})},{"../engine":106,"../kernel_names":126,"../tensor_util":209,"../tensor_util_env":210,"./broadcast_util":136,"./operation":163,"./tensor_ops":186}],185:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),slice_1=require("./slice"),slice_util_1=require("./slice_util");exports.stridedSlice=operation_1.op({stridedSlice_:function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),null==strides&&(strides=new Array(begin.length)),0!==ellipsisMask)throw new Error("ellipsis mask is not yet supported");var $x=tensor_util_env_1.convertToTensor(x,"x","stridedSlice"),expandAxes=slice_util_1.maskToAxes(newAxisMask),newShape=$x.shape.slice();expandAxes.forEach((function(axis){begin[axis]=0,end[axis]=1,newShape.splice(axis,0,1)})),$x=$x.reshape(newShape);for(var axis=0;axis<$x.rank;axis++)begin[axis]=slice_util_1.startForAxis(beginMask,begin,strides,$x.shape,axis),end[axis]=slice_util_1.stopForAxis(endMask,end,strides,$x.shape,axis),strides[axis]=strides[axis]||1;var shrinkAxes=slice_util_1.maskToAxes(shrinkAxisMask);shrinkAxes.forEach((function(axis){end[axis]=begin[axis]+1,strides[axis]=1}));var size=slice_util_1.computeOutShape(begin,end,strides),outShape=size.filter((function(_,axis){return-1===shrinkAxes.indexOf(axis)}));return strides.every((function(v){return 1===v}))?slice_1.slice($x,begin,size).reshape(outShape):engine_1.ENGINE.runKernelFunc((function(backend){return backend.stridedSlice($x,begin,end,strides)}),{$x:$x}).reshape(outShape)}})},{"../engine":106,"../tensor_util_env":210,"./operation":163,"./slice":177,"./slice_util":178}],186:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),environment_1=require("../environment"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),complex_ops_1=require("./complex_ops"),operation_1=require("./operation");function makeTensor(values,shape,inferredShape,dtype){if(null==dtype&&(dtype=util_1.inferDtype(values)),"complex64"===dtype)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!util_1.isTypedArray(values)&&!Array.isArray(values)&&"number"!=typeof values&&"boolean"!=typeof values&&"string"!=typeof values)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=shape){util_1.assertNonNegativeIntegerDimensions(shape);var providedSize_1=util_1.sizeFromShape(shape),inferredSize_1=util_1.sizeFromShape(inferredShape);util_1.assert(providedSize_1===inferredSize_1,(function(){return"Based on the provided shape, ["+shape+"], the tensor should have "+providedSize_1+" values but has "+inferredSize_1}));for(var i=0;i<inferredShape.length;++i){var inferred=inferredShape[i],flatDimsDontMatch=i!==inferredShape.length-1||inferred!==util_1.sizeFromShape(shape.slice(i));util_1.assert(inferredShape[i]===shape[i]||!flatDimsDontMatch,(function(){return"Error creating a new Tensor. Inferred shape ("+inferredShape+") does not match the provided shape ("+shape+"). "}))}}return util_1.isTypedArray(values)||Array.isArray(values)||(values=[values]),shape=shape||inferredShape,values="string"!==dtype?util_1.toTypedArray(values,dtype,environment_1.env().getBool("DEBUG")):util_1.flatten(values,[],!0),engine_1.ENGINE.makeTensor(values,shape,dtype)}function tensor1d(values,dtype){util_1.assertNonNull(values);var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(1!==inferredShape.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return makeTensor(values,null,inferredShape,dtype)}function zeros(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_2=zeros(shape,"float32"),imag_2=zeros(shape,"float32");return complex_ops_1.complex(real_2,imag_2)}var values=util_1.makeZerosTypedArray(util_1.sizeFromShape(shape),dtype);return engine_1.ENGINE.makeTensor(values,shape,dtype)}exports.tensor=function(values,shape,dtype){return makeTensor(values,shape,tensor_util_env_1.inferShape(values,dtype),dtype)},exports.scalar=function(value,dtype){if((util_1.isTypedArray(value)&&"string"!==dtype||Array.isArray(value))&&"complex64"!==dtype)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===dtype&&util_1.isTypedArray(value)&&!(value instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return makeTensor(value,[],[],dtype)},exports.tensor1d=tensor1d,exports.tensor2d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&2!==shape.length)throw new Error("tensor2d() requires shape to have two numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(2!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor3d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&3!==shape.length)throw new Error("tensor3d() requires shape to have three numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(3!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor4d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&4!==shape.length)throw new Error("tensor4d() requires shape to have four numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(4!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor5d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&5!==shape.length)throw new Error("tensor5d() requires shape to have five numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(5!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor6d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&6!==shape.length)throw new Error("tensor6d() requires shape to have six numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(6!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape=shape||inferredShape,inferredShape,dtype)},exports.variable=function(initialValue,trainable,name,dtype){return void 0===trainable&&(trainable=!0),engine_1.ENGINE.makeVariable(initialValue,trainable,name,dtype)},exports.ones=function ones(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_1=ones(shape,"float32"),imag_1=zeros(shape,"float32");return complex_ops_1.complex(real_1,imag_1)}var values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),dtype);return engine_1.ENGINE.makeTensor(values,shape,dtype)},exports.zeros=zeros,exports.fill=function(shape,value,dtype){return engine_1.ENGINE.runKernelFunc((function(backend){return backend.fill(shape,value,dtype)}),{})},exports.linspace=function(start,stop,num){if(num<=0)throw new Error("The number of values should be positive.");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.linspace(start,stop,num)}),{})},exports.range=function(start,stop,step,dtype){if(void 0===step&&(step=1),void 0===dtype&&(dtype="float32"),0===step)throw new Error("Cannot have a step of zero");if(start===stop||start<stop&&step<0||stop<start&&step>1)return zeros([0],dtype);var numElements=Math.abs(Math.ceil((stop-start)/step)),values=util_1.makeZerosTypedArray(numElements,dtype);stop<start&&1===step&&(step=-1),values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor1d(values,dtype)},exports.onesLike=operation_1.op({onesLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","onesLike");if("complex64"===$x.dtype){var r=exports.onesLike(complex_ops_1.real($x)),i=exports.zerosLike(complex_ops_1.imag($x));return complex_ops_1.complex(r,i)}return engine_1.ENGINE.runKernelFunc((function(backend){return backend.onesLike($x)}),{$x:$x},(function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}}))}}),exports.zerosLike=operation_1.op({zerosLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","zerosLike");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.zerosLike($x)}),{$x:$x},(function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}}))}})},{"../engine":106,"../environment":107,"../tensor_util_env":210,"../util":214,"./complex_ops":139,"./operation":163}],187:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.topk=operation_1.op({topk_:function(x,k,sorted){void 0===k&&(k=1),void 0===sorted&&(sorted=!0);var $x=tensor_util_env_1.convertToTensor(x,"x","topk");if(0===$x.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var lastDim=$x.shape[$x.shape.length-1];if(k>lastDim)throw new Error("'k' passed to topk() must be <= the last dimension ("+lastDim+") but got "+k);var _a=engine_1.ENGINE.runKernelFunc((function(b){return b.topk($x,k,sorted)}),{$x:$x});return{values:_a[0],indices:_a[1]}}})},{"../engine":106,"../tensor_util_env":210,"./operation":163}],188:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation");exports.transpose=operation_1.op({transpose_:function(x,perm){var $x=tensor_util_env_1.convertToTensor(x,"x","transpose");if(null==perm&&(perm=$x.shape.map((function(s,i){return i})).reverse()),util.assert($x.rank===perm.length,(function(){return"Error in transpose: rank of input "+$x.rank+" must match length of perm "+perm+"."})),perm.forEach((function(axis){util.assert(axis>=0&&axis<$x.rank,(function(){return"All entries in 'perm' must be between 0 and "+($x.rank-1)+" but got "+perm}))})),$x.rank<=1)return $x.clone();var attrs={perm:perm};return engine_1.ENGINE.runKernelFunc((function(backend){return backend.transpose($x,perm)}),{x:$x},(function(dy){var undoPerm=axis_util.getUndoAxesPermutation(perm);return{x:function(){return dy.transpose(undoPerm)}}}),"Transpose",attrs)}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./axis_util":132,"./operation":163}],189:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.abs=operation_1.op({abs_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","abs");return"complex64"===$x.dtype?engine_1.ENGINE.runKernelFunc((function(backend){return backend.complexAbs($x)}),{$x:$x}):engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.abs($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return dy.mul($x.toFloat().step(-1))}}}),"Abs")}}),exports.acos=operation_1.op({acos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acos");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.acos($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt()).neg()}}}))}}),exports.acosh=operation_1.op({acosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acosh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.acosh($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict($x.toFloat().square().sub(1).sqrt())}}}))}}),exports.asin=operation_1.op({asin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asin");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.asin($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt())}}}))}}),exports.asinh=operation_1.op({asinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asinh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.asinh($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).add($x.toFloat().square()).sqrt())}}}))}}),exports.atan=operation_1.op({atan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atan");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.atan($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().square().add(1))}}}))}}),exports.atanh=operation_1.op({atanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atanh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.atanh($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div(tensor_ops_1.scalar(1).sub($x.toFloat().square()))}}}))}}),exports.ceil=operation_1.op({ceil_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","ceil");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.ceil($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.clipByValue=operation_1.op({clipByValue_:function(x,clipValueMin,clipValueMax){var $x=tensor_util_env_1.convertToTensor(x,"x","clipByValue");util.assert(clipValueMin<=clipValueMax,(function(){return"Error in clip: min ("+clipValueMin+") must be less than or equal to max ("+clipValueMax+")."}));var inputsToSave=[$x],attr={min:clipValueMin,max:clipValueMax};return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.clip($x,clipValueMin,clipValueMax);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return dy.where($x.greaterEqual(clipValueMin).logicalAnd($x.lessEqual(clipValueMax)),tensor_ops_1.zerosLike(dy))}}}),"ClipByValue",attr,inputsToSave)}}),exports.cos=operation_1.op({cos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cos"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.cos($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return $x.toFloat().sin().neg().mul(dy)}}}),"Cos",{},inputsToSave)}}),exports.cosh=operation_1.op({cosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cosh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.cosh($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().sinh().mulStrict(dy)}}}))}}),exports.erf=operation_1.op({erf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","erf");return util.assert("int32"===$x.dtype||"float32"===$x.dtype,(function(){return"Input dtype must be `int32` or `float32`."})),"int32"===$x.dtype&&($x=$x.toFloat()),engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.erf($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}}))}}),exports.exp=operation_1.op({exp_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","exp");return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.exp($x);return save([y]),y}),{x:$x},(function(dy,saved){return{x:function(){return dy.mulStrict(saved[0])}}}),"Exp",{},[],[!0])}}),exports.expm1=operation_1.op({expm1_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","expm1");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.expm1($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.exp())}}}))}}),exports.floor=operation_1.op({floor_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","floor");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.floor($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.log=operation_1.op({log_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.log($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return dy.div($x.toFloat())}}}),"Log",{},inputsToSave)}}),exports.log1p=operation_1.op({log1p_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log1p");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.log1p($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.add(1))}}}))}}),exports.logSigmoid=operation_1.op({logSigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logSigmoid");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.softplus($x.neg()).neg();return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.neg().sigmoid())}}}))}}),exports.neg=operation_1.op({neg_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","neg"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend){return backend.neg($x)}),{x:$x},(function(dy){return{x:function(){return dy.neg()}}}),"Neg",{},inputsToSave)}}),exports.reciprocal=operation_1.op({reciprocal_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reciprocal");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.reciprocal($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.square().neg())}}}))}}),exports.round=operation_1.op({round_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","round");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.round($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.rsqrt=operation_1.op({rsqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","rsqrt"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.rsqrt($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return dy.div($x.pow(1.5).mul(2)).neg()}}}),"Rsqrt",{},inputsToSave)}}),exports.sigmoid=operation_1.op({sigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sigmoid");return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.sigmoid($x);return save([y]),y}),{x:$x},(function(dy,saved){var y=saved[0];return{x:function(){return dy.mul(y.mul(tensor_ops_1.scalar(1).sub(y)))}}}),"Sigmoid")}}),exports.sign=operation_1.op({sign_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sign");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.sign($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.isNaN=operation_1.op({isNaN_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isNaN");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.isNaN($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.isInf=operation_1.op({isInf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isInf");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.isInf($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.isFinite=operation_1.op({isFinite_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isFinite");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.isFinite($x)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.sin=operation_1.op({sin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sin"),inputsToSave=[$x];return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.sin($x);return save([$x]),res}),{x:$x},(function(dy,saved){var $x=saved[0];return{x:function(){return $x.toFloat().cos().mul(dy)}}}),"Sin",{},inputsToSave)}}),exports.sinh=operation_1.op({sinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sinh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.sinh($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().cosh().mulStrict(dy)}}}))}}),exports.softplus=operation_1.op({softplus_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","softplus");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.softplus($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.sigmoid())}}}))}}),exports.sqrt=operation_1.op({sqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sqrt");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.sqrt($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().sqrt().mul(2))}}}))}}),exports.step=operation_1.op({step_:function(x,alpha){void 0===alpha&&(alpha=0);var $x=tensor_util_env_1.convertToTensor(x,"x","step");return engine_1.ENGINE.runKernelFunc((function(backend){return backend.step($x,alpha)}),{$x:$x},(function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}}))}}),exports.tan=operation_1.op({tan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tan");return engine_1.ENGINE.runKernelFunc((function(backend,save){var res=backend.tan($x);return save([$x]),res}),{$x:$x},(function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.cos().square())}}}))}}),exports.tanh=operation_1.op({tanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tanh");return engine_1.ENGINE.runKernelFunc((function(backend,save){var y=backend.tanh($x);return save([y]),y}),{x:$x},(function(dy,saved){var y=saved[0];return{x:function(){return tensor_ops_1.scalar(1).sub(y.square()).mulStrict(dy)}}}),"Tanh",{},null,[!0])}})},{"../engine":106,"../tensor_util_env":210,"../util":214,"./operation":163,"./tensor_ops":186}],190:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdadeltaOptimizer=function(_super){function AdadeltaOptimizer(learningRate,rho,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.rho=rho,_this.epsilon=epsilon,_this.accumulatedGrads=[],_this.accumulatedUpdates=[],null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdadeltaOptimizer,_super),AdadeltaOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map((function(item){return item.name})):Object.keys(variableGradients)).forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedGrads[i]&&(_this.accumulatedGrads[i]={originalName:name+"/accum_grad",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))}),null==_this.accumulatedUpdates[i]&&(_this.accumulatedUpdates[i]={originalName:name+"/accum_var",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable,accumulatedUpdate=_this.accumulatedUpdates[i].variable;globals_1.tidy((function(){var newAccumulatedGrad=accumulatedGrad.mul(_this.rho).add(gradient.square().mul(1-_this.rho)),updates=accumulatedUpdate.add(_this.epsilon).sqrt().div(accumulatedGrad.add(_this.epsilon).sqrt()).mul(gradient),newAccumulatedUpdate=accumulatedUpdate.mul(_this.rho).add(updates.square().mul(1-_this.rho));accumulatedGrad.assign(newAccumulatedGrad),accumulatedUpdate.assign(newAccumulatedUpdate);var newValue=updates.mul(-_this.learningRate).add(value);value.assign(newValue)}))}})),this.incrementIterations()},AdadeltaOptimizer.prototype.dispose=function(){null!=this.accumulatedUpdates&&(globals_1.dispose(this.accumulatedGrads.map((function(v){return v.variable}))),globals_1.dispose(this.accumulatedUpdates.map((function(v){return v.variable}))))},AdadeltaOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){var variables;return __generator(this,(function(_a){switch(_a.label){case 0:return variables=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map((function(v){return{name:v.originalName,tensor:v.variable}})))]}}))}))},AdadeltaOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){var variableCount;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=weightValues.length/2,!1,this.accumulatedGrads=weightValues.slice(0,variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),this.accumulatedUpdates=weightValues.slice(variableCount,2*variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),[2]}}))}))},AdadeltaOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},AdadeltaOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.rho,config.epsilon)},AdadeltaOptimizer.className="Adadelta",AdadeltaOptimizer}(require("./optimizer").Optimizer);exports.AdadeltaOptimizer=AdadeltaOptimizer,serialization_1.registerClass(AdadeltaOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],191:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdagradOptimizer=function(_super){function AdagradOptimizer(learningRate,initialAccumulatorValue){void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.initialAccumulatorValue=initialAccumulatorValue,_this.accumulatedGrads=[],_this}return __extends(AdagradOptimizer,_super),AdagradOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map((function(item){return item.name})):Object.keys(variableGradients)).forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulatedGrads[i]){_this.accumulatedGrads[i]={originalName:name+"/accumulator",variable:globals_1.tidy((function(){return ops_1.fill(value.shape,_this.initialAccumulatorValue).variable(false)}))}}var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable;globals_1.tidy((function(){var newAccumulatedGrad=accumulatedGrad.add(gradient.square());accumulatedGrad.assign(newAccumulatedGrad);var newValue=gradient.div(newAccumulatedGrad.add(engine_1.ENGINE.backend.epsilon()).sqrt()).mul(-_this.learningRate).add(value);value.assign(newValue)}))}})),this.incrementIterations()},AdagradOptimizer.prototype.dispose=function(){null!=this.accumulatedGrads&&globals_1.dispose(this.accumulatedGrads.map((function(v){return v.variable})))},AdagradOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulatedGrads.map((function(v){return{name:v.originalName,tensor:v.variable}})))]}}))}))},AdagradOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulatedGrads=weightValues.map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),[2]}}))}))},AdagradOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},AdagradOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.initialAccumulatorValue)},AdagradOptimizer.className="Adagrad",AdagradOptimizer}(require("./optimizer").Optimizer);exports.AdagradOptimizer=AdagradOptimizer,serialization_1.registerClass(AdagradOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],192:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamOptimizer=function(_super){function AdamOptimizer(learningRate,beta1,beta2,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.accumulatedFirstMoment=[],_this.accumulatedSecondMoment=[],globals_1.tidy((function(){_this.accBeta1=ops_1.scalar(beta1).variable(),_this.accBeta2=ops_1.scalar(beta2).variable()})),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamOptimizer,_super),AdamOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,varNames=Array.isArray(variableGradients)?variableGradients.map((function(v){return v.name})):Object.keys(variableGradients);globals_1.tidy((function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),oneMinusAccBeta2=ops_1.sub(1,_this.accBeta2);varNames.forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))}),null==_this.accumulatedSecondMoment[i]&&(_this.accumulatedSecondMoment[i]={originalName:name+"/v",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,secondMoment=_this.accumulatedSecondMoment[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),newSecondMoment=secondMoment.mul(_this.beta2).add(gradient.square().mul(1-_this.beta2)),biasCorrectedFirstMoment=newFirstMoment.div(oneMinusAccBeta1),biasCorrectedSecondMoment=newSecondMoment.div(oneMinusAccBeta2);firstMoment.assign(newFirstMoment),secondMoment.assign(newSecondMoment);var newValue=biasCorrectedFirstMoment.div(biasCorrectedSecondMoment.sqrt().add(_this.epsilon)).mul(-_this.learningRate).add(value);value.assign(newValue)}})),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1)),_this.accBeta2.assign(_this.accBeta2.mul(_this.beta2))})),this.incrementIterations()},AdamOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map((function(v){return v.variable}))),null!=this.accumulatedSecondMoment&&globals_1.dispose(this.accumulatedSecondMoment.map((function(v){return v.variable})))},AdamOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){var variables;return __generator(this,(function(_a){switch(_a.label){case 0:return variables=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map((function(v){return{name:v.originalName,tensor:v.variable}})))]}}))}))},AdamOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){var variableCount,_this=this;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),globals_1.tidy((function(){_this.accBeta1.assign(ops_1.pow(_this.beta1,_this.iterations_+1)),_this.accBeta2.assign(ops_1.pow(_this.beta2,_this.iterations_+1))})),variableCount=weightValues.length/2,!1,this.accumulatedFirstMoment=weightValues.slice(0,variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),this.accumulatedSecondMoment=weightValues.slice(variableCount,2*variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),[2]}}))}))},AdamOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},AdamOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon)},AdamOptimizer.className="Adam",AdamOptimizer}(require("./optimizer").Optimizer);exports.AdamOptimizer=AdamOptimizer,serialization_1.registerClass(AdamOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],193:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamaxOptimizer=function(_super){function AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay){void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.decay=decay,_this.accumulatedFirstMoment=[],_this.accumulatedWeightedInfNorm=[],globals_1.tidy((function(){_this.iteration=ops_1.scalar(0).variable(),_this.accBeta1=ops_1.scalar(beta1).variable()})),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamaxOptimizer,_super),AdamaxOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,variableNames=Array.isArray(variableGradients)?variableGradients.map((function(item){return item.name})):Object.keys(variableGradients);globals_1.tidy((function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),lr=ops_1.div(-_this.learningRate,_this.iteration.mul(_this.decay).add(1));variableNames.forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:ops_1.zerosLike(value).variable(false)}),null==_this.accumulatedWeightedInfNorm[i]&&(_this.accumulatedWeightedInfNorm[i]={originalName:name+"/v",variable:ops_1.zerosLike(value).variable(false)});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,weightedInfNorm=_this.accumulatedWeightedInfNorm[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),ut0=weightedInfNorm.mul(_this.beta2),ut1=gradient.abs(),newWeightedInfNorm=ut0.maximum(ut1);firstMoment.assign(newFirstMoment),weightedInfNorm.assign(newWeightedInfNorm);var newValue=lr.div(oneMinusAccBeta1).mul(newFirstMoment.div(newWeightedInfNorm.add(_this.epsilon))).add(value);value.assign(newValue)}})),_this.iteration.assign(_this.iteration.add(1)),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1))})),this.incrementIterations()},AdamaxOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map((function(v){return v.variable}))),null!=this.accumulatedWeightedInfNorm&&globals_1.dispose(this.accumulatedWeightedInfNorm.map((function(v){return v.variable})))},AdamaxOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("getWeights() is not implemented for Adamax yet.")}))}))},AdamaxOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("setWeights() is not implemented for Adamax yet.")}))}))},AdamaxOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},AdamaxOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon,config.decay)},AdamaxOptimizer.className="Adamax",AdamaxOptimizer}(require("./optimizer").Optimizer);exports.AdamaxOptimizer=AdamaxOptimizer,serialization_1.registerClass(AdamaxOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],194:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),MomentumOptimizer=function(_super){function MomentumOptimizer(learningRate,momentum,useNesterov){void 0===useNesterov&&(useNesterov=!1);var _this=_super.call(this,learningRate)||this;return _this.learningRate=learningRate,_this.momentum=momentum,_this.useNesterov=useNesterov,_this.accumulations=[],_this.m=ops_1.scalar(_this.momentum),_this}return __extends(MomentumOptimizer,_super),MomentumOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map((function(item){return item.name})):Object.keys(variableGradients)).forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulations[i]){_this.accumulations[i]={originalName:name+"/momentum",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))}}var accumulation=_this.accumulations[i].variable,gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];null!=gradient&&globals_1.tidy((function(){var newValue,newAccumulation=_this.m.mul(accumulation).add(gradient);newValue=_this.useNesterov?_this.c.mul(gradient.add(newAccumulation.mul(_this.m))).add(value):_this.c.mul(newAccumulation).add(value),accumulation.assign(newAccumulation),value.assign(newValue)}))})),this.incrementIterations()},MomentumOptimizer.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&globals_1.dispose(this.accumulations.map((function(v){return v.variable})))},MomentumOptimizer.prototype.setMomentum=function(momentum){this.momentum=momentum},MomentumOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulations.map((function(v){return{name:v.originalName,tensor:v.variable}})))]}}))}))},MomentumOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulations=weightValues.map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),[2]}}))}))},MomentumOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},MomentumOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.momentum,config.useNesterov)},MomentumOptimizer.className="Momentum",MomentumOptimizer}(require("./sgd_optimizer").SGDOptimizer);exports.MomentumOptimizer=MomentumOptimizer,serialization_1.registerClass(MomentumOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./sgd_optimizer":198}],195:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var globals_1=require("../globals"),gradients_1=require("../gradients"),ops_1=require("../ops/ops"),Optimizer=function(_super){function Optimizer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Optimizer,_super),Optimizer.prototype.minimize=function(f,returnCost,varList){void 0===returnCost&&(returnCost=!1);var _a=this.computeGradients(f,varList),value=_a.value,grads=_a.grads;if(null!=varList){var gradArray=varList.map((function(v){return{name:v.name,tensor:grads[v.name]}}));this.applyGradients(gradArray)}else this.applyGradients(grads);return globals_1.dispose(grads),returnCost?value:(value.dispose(),null)},Object.defineProperty(Optimizer.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),Optimizer.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},Optimizer.prototype.computeGradients=function(f,varList){return gradients_1.variableGrads(f,varList)},Optimizer.prototype.dispose=function(){null!=this.iterations_&&globals_1.dispose(this.iterations_)},Optimizer.prototype.saveIterations=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:ops_1.scalar(this.iterations_,"int32")}]}))}))},Optimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("getWeights() is not implemented for this optimizer yet.")}))}))},Optimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())}))}))},Optimizer.prototype.extractIterations=function(weightValues){return __awaiter(this,void 0,void 0,(function(){var _a;return __generator(this,(function(_b){switch(_b.label){case 0:return _a=this,[4,weightValues[0].tensor.data()];case 1:return _a.iterations_=_b.sent()[0],[2,weightValues.slice(1)]}}))}))},Optimizer}(require("../serialization").Serializable);exports.Optimizer=Optimizer,Object.defineProperty(Optimizer,Symbol.hasInstance,{value:function(instance){return null!=instance.minimize&&null!=instance.computeGradients&&null!=instance.applyGradients}})},{"../globals":109,"../gradients":110,"../ops/ops":164,"../serialization":205}],196:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./adadelta_optimizer"),adagrad_optimizer_1=require("./adagrad_optimizer"),adam_optimizer_1=require("./adam_optimizer"),adamax_optimizer_1=require("./adamax_optimizer"),momentum_optimizer_1=require("./momentum_optimizer"),rmsprop_optimizer_1=require("./rmsprop_optimizer"),sgd_optimizer_1=require("./sgd_optimizer"),OptimizerConstructors=function(){function OptimizerConstructors(){}return OptimizerConstructors.sgd=function(learningRate){return new sgd_optimizer_1.SGDOptimizer(learningRate)},OptimizerConstructors.momentum=function(learningRate,momentum,useNesterov){return void 0===useNesterov&&(useNesterov=!1),new momentum_optimizer_1.MomentumOptimizer(learningRate,momentum,useNesterov)},OptimizerConstructors.rmsprop=function(learningRate,decay,momentum,epsilon,centered){return void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1),new rmsprop_optimizer_1.RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered)},OptimizerConstructors.adam=function(learningRate,beta1,beta2,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),new adam_optimizer_1.AdamOptimizer(learningRate,beta1,beta2,epsilon)},OptimizerConstructors.adadelta=function(learningRate,rho,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===rho&&(rho=.95),void 0===epsilon&&(epsilon=null),new adadelta_optimizer_1.AdadeltaOptimizer(learningRate,rho,epsilon)},OptimizerConstructors.adamax=function(learningRate,beta1,beta2,epsilon,decay){return void 0===learningRate&&(learningRate=.002),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0),new adamax_optimizer_1.AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay)},OptimizerConstructors.adagrad=function(learningRate,initialAccumulatorValue){return void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1),new adagrad_optimizer_1.AdagradOptimizer(learningRate,initialAccumulatorValue)},OptimizerConstructors}();exports.OptimizerConstructors=OptimizerConstructors},{"./adadelta_optimizer":190,"./adagrad_optimizer":191,"./adam_optimizer":192,"./adamax_optimizer":193,"./momentum_optimizer":194,"./rmsprop_optimizer":197,"./sgd_optimizer":198}],197:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),RMSPropOptimizer=function(_super){function RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered){void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1);var _this=_super.call(this)||this;if(_this.learningRate=learningRate,_this.decay=decay,_this.momentum=momentum,_this.epsilon=epsilon,_this.accumulatedMeanSquares=[],_this.accumulatedMoments=[],_this.accumulatedMeanGrads=[],_this.centered=centered,null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),null==learningRate)throw new Error("learningRate for RMSPropOptimizer must be defined.");return _this}return __extends(RMSPropOptimizer,_super),RMSPropOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map((function(item){return item.name})):Object.keys(variableGradients)).forEach((function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedMeanSquares[i]&&(_this.accumulatedMeanSquares[i]={originalName:name+"/rms",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))}),null==_this.accumulatedMoments[i]&&(_this.accumulatedMoments[i]={originalName:name+"/momentum",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))}),null==_this.accumulatedMeanGrads[i]&&_this.centered&&(_this.accumulatedMeanGrads[i]={originalName:name+"/mg",variable:globals_1.tidy((function(){return ops_1.zerosLike(value).variable(false)}))});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedMeanSquare=_this.accumulatedMeanSquares[i].variable,accumulatedMoments=_this.accumulatedMoments[i].variable;globals_1.tidy((function(){var newAccumulatedMeanSquare=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));if(_this.centered){var accumulatedMeanGrad=_this.accumulatedMeanGrads[i].variable,newAccumulatedMeanGrad=accumulatedMeanGrad.mul(_this.decay).add(gradient.mul(1-_this.decay)),newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare.sub(newAccumulatedMeanGrad.square().add(_this.epsilon)).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare),accumulatedMeanGrad.assign(newAccumulatedMeanGrad),accumulatedMoments.assign(newAccumulatedMoments);var newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}else{var newAccumulatedMeanSquare_1=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare_1.add(_this.epsilon).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare_1),accumulatedMoments.assign(newAccumulatedMoments);newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}}))}})),this.incrementIterations()},RMSPropOptimizer.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&globals_1.dispose(this.accumulatedMeanSquares.map((function(v){return v.variable}))),null!=this.accumulatedMeanGrads&&this.centered&&globals_1.dispose(this.accumulatedMeanGrads.map((function(v){return v.variable}))),null!=this.accumulatedMoments&&globals_1.dispose(this.accumulatedMoments.map((function(v){return v.variable})))},RMSPropOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){var variables;return __generator(this,(function(_a){switch(_a.label){case 0:return variables=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&variables.push.apply(variables,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map((function(v){return{name:v.originalName,tensor:v.variable}})))]}}))}))},RMSPropOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){var variableCount;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=this.centered?weightValues.length/3:weightValues.length/2,!1,this.accumulatedMeanSquares=weightValues.slice(0,variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),this.accumulatedMoments=weightValues.slice(variableCount,2*variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}})),this.centered&&(this.accumulatedMeanGrads=weightValues.slice(2*variableCount,3*variableCount).map((function(v){return{originalName:v.name,variable:v.tensor.variable(false)}}))),[2]}}))}))},RMSPropOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},RMSPropOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.decay,config.momentum,config.epsilon,config.centered)},RMSPropOptimizer.className="RMSProp",RMSPropOptimizer}(require("./optimizer").Optimizer);exports.RMSPropOptimizer=RMSPropOptimizer,serialization_1.registerClass(RMSPropOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],198:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),SGDOptimizer=function(_super){function SGDOptimizer(learningRate){var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.setLearningRate(learningRate),_this}return __extends(SGDOptimizer,_super),SGDOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map((function(v){return v.name})):Object.keys(variableGradients)).forEach((function(name,i){var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var value=engine_1.ENGINE.registeredVariables[name];globals_1.tidy((function(){var newValue=_this.c.mul(gradient).add(value);value.assign(newValue)}))}})),this.incrementIterations()},SGDOptimizer.prototype.setLearningRate=function(learningRate){this.learningRate=learningRate,null!=this.c&&this.c.dispose(),this.c=globals_1.keep(ops_1.scalar(-learningRate))},SGDOptimizer.prototype.dispose=function(){this.c.dispose()},SGDOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()]]}}))}))},SGDOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:if(0!==(weightValues=_a.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}}))}))},SGDOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate}},SGDOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate)},SGDOptimizer.className="SGD",SGDOptimizer}(require("./optimizer").Optimizer);exports.SGDOptimizer=SGDOptimizer,serialization_1.registerClass(SGDOptimizer)},{"../engine":106,"../globals":109,"../ops/ops":164,"../serialization":205,"./optimizer":195}],199:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),PlatformBrowser=function(){function PlatformBrowser(){}return PlatformBrowser.prototype.fetch=function(path,init){return fetch(path,init)},PlatformBrowser.prototype.now=function(){return performance.now()},PlatformBrowser.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Browser's encoder only supports utf-8, but got "+encoding);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(text)},PlatformBrowser.prototype.decode=function(bytes,encoding){return new TextDecoder(encoding).decode(bytes)},PlatformBrowser}();exports.PlatformBrowser=PlatformBrowser,environment_1.env().get("IS_BROWSER")&&environment_1.env().setPlatform("browser",new PlatformBrowser)},{"../environment":107}],200:[function(require,module,exports){(function(process){(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var systemFetch,environment_1=require("../environment");exports.getNodeFetch={importFetch:function(){return require("node-fetch")}},exports.resetSystemFetch=function(){systemFetch=null},exports.setSystemFetch=function(fetchFn){systemFetch=fetchFn},exports.getSystemFetch=function(){return systemFetch};var PlatformNode=function(){function PlatformNode(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}return PlatformNode.prototype.fetch=function(path,requestInits){return null!=environment_1.env().global.fetch?environment_1.env().global.fetch(path,requestInits):(null==systemFetch&&(systemFetch=exports.getNodeFetch.importFetch()),systemFetch(path,requestInits))},PlatformNode.prototype.now=function(){var time=process.hrtime();return 1e3*time[0]+time[1]/1e6},PlatformNode.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Node built-in encoder only supports utf-8, but got "+encoding);return this.textEncoder.encode(text)},PlatformNode.prototype.decode=function(bytes,encoding){return 0===bytes.length?"":new this.util.TextDecoder(encoding).decode(bytes)},PlatformNode}();exports.PlatformNode=PlatformNode,environment_1.env().get("IS_NODE")&&environment_1.env().setPlatform("node",new PlatformNode)}).call(this)}).call(this,require("_process"))},{"../environment":107,_process:396,"node-fetch":218,util:218}],201:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("./util"),Profiler=function(){function Profiler(backendTimer,logger){this.backendTimer=backendTimer,this.logger=logger,null==logger&&(this.logger=new Logger)}return Profiler.prototype.profileKernel=function(kernelName,inputs,f){var outputs,_this=this,timer=this.backendTimer.time((function(){outputs=f()}));return outputs.forEach((function(r){r.data().then((function(vals){checkComputationForErrors(vals,r.dtype,kernelName),timer.then((function(timing){var extraInfo="";null!=timing.getExtraProfileInfo&&(extraInfo=timing.getExtraProfileInfo()),_this.logger.logKernelProfile(kernelName,r,vals,timing.kernelMs,inputs,extraInfo)}))}))})),outputs},Profiler}();function checkComputationForErrors(vals,dtype,kernelName){if("float32"!==dtype)return!1;for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))return console.warn("Found "+num+" in the result of '"+kernelName+"'"),!0}return!1}exports.Profiler=Profiler,exports.checkComputationForErrors=checkComputationForErrors;var Logger=function(){function Logger(){}return Logger.prototype.logKernelProfile=function(name,result,vals,timeMs,inputs,extraInfo){var time="number"==typeof timeMs?util.rightPad(timeMs+"ms",9):timeMs.error,paddedName=util.rightPad(name,25),rank=result.rank,size=result.size,shape=util.rightPad(result.shape.toString(),14),inputShapesDescription="";for(var name_1 in inputs){var inputShape=inputs[name_1].shape||result.shape,inputRank=inputShape.length;inputShapesDescription+=name_1+": "+inputRank+"D "+(inputRank>0?inputShape:"")+" "}console.log("%c"+paddedName+"\t%c"+time+"\t%c"+rank+"D "+shape+"\t%c"+size+"\t%c"+inputShapesDescription+"\t%c"+extraInfo,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},Logger}();exports.Logger=Logger},{"./util":214}],202:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0}),require("./squared_difference")},{"./squared_difference":203}],203:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var squared_difference_1=require("../../ops/squared_difference");require("../../tensor").Tensor.prototype.squaredDifference=function(b){return squared_difference_1.squaredDifference(this,b)}},{"../../ops/squared_difference":184,"../../tensor":207}],204:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});for(
/**
 * @license
 * Copyright 2020 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
var Square_grad_1=require("./gradients/Square_grad"),SquaredDifference_grad_1=require("./gradients/SquaredDifference_grad"),kernel_registry_1=require("./kernel_registry"),_i=0,gradConfigs_1=[Square_grad_1.squareGradConfig,SquaredDifference_grad_1.squaredDifferenceGradConfig];_i<gradConfigs_1.length;_i++){var gradientConfig=gradConfigs_1[_i];kernel_registry_1.registerGradient(gradientConfig)}},{"./gradients/Square_grad":111,"./gradients/SquaredDifference_grad":112,"./kernel_registry":127}],205:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util"),Serializable=function(){function Serializable(){}return Serializable.prototype.getClassName=function(){return this.constructor.className},Serializable.fromConfig=function(cls,config){return new cls(config)},Serializable}();exports.Serializable=Serializable;var SerializationMap=function(){function SerializationMap(){this.classNameMap={}}return SerializationMap.getMap=function(){return null==SerializationMap.instance&&(SerializationMap.instance=new SerializationMap),SerializationMap.instance},SerializationMap.register=function(cls){SerializationMap.getMap().classNameMap[cls.className]=[cls,cls.fromConfig]},SerializationMap}();exports.SerializationMap=SerializationMap,exports.registerClass=function(cls){util_1.assert(null!=cls.className,(function(){return"Class being registered does not have the static className property defined."})),util_1.assert("string"==typeof cls.className,(function(){return"className is required to be a string, but got type "+typeof cls.className})),util_1.assert(cls.className.length>0,(function(){return"Class being registered has an empty-string as its className, which is disallowed."})),SerializationMap.register(cls)}},{"./util":214}],206:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util=require("./util");exports.getFilteredNodesXToY=function(tape,xs,y){for(var tensorsFromX={},nodesFromX={},i=0;i<xs.length;i++)tensorsFromX[xs[i].id]=!0;for(i=0;i<tape.length;i++){var nodeInputs=(node=tape[i]).inputs;for(var inputName in nodeInputs){for(var input=nodeInputs[inputName],anyInputFromX=!1,j=0;j<xs.length;j++)if(tensorsFromX[input.id]){node.outputs.forEach((function(output){return tensorsFromX[output.id]=!0})),anyInputFromX=!0,nodesFromX[node.id]=!0;break}if(anyInputFromX)break}}var tensorsLeadToY={};tensorsLeadToY[y.id]=!0;var nodesToY={};for(i=tape.length-1;i>=0;i--)for(nodeInputs=(node=tape[i]).inputs,j=0;j<node.outputs.length;j++)if(tensorsLeadToY[node.outputs[j].id]){for(var inputName in nodeInputs)tensorsLeadToY[nodeInputs[inputName].id]=!0,nodesToY[node.id]=!0;break}var filteredTape=[];for(i=0;i<tape.length;i++){var node;if(nodesFromX[(node=tape[i]).id]&&nodesToY[node.id]){var prunedInputs={};for(var inputName in node.inputs){var nodeInput=node.inputs[inputName];tensorsFromX[nodeInput.id]&&(prunedInputs[inputName]=nodeInput)}var prunedNode=Object.assign({},node);prunedNode.inputs=prunedInputs,prunedNode.outputs=node.outputs,filteredTape.push(prunedNode)}}return filteredTape},exports.backpropagateGradients=function(tensorAccumulatedGradientMap,filteredTape,tidy){for(var _loop_1=function(i){var node=filteredTape[i],dys=[];if(node.outputs.forEach((function(o){var gradTensor=tensorAccumulatedGradientMap[o.id];null!=gradTensor?dys.push(gradTensor):dys.push(null)})),null==node.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+node.kernelName+".");var inputGradients=node.gradient(dys),_loop_2=function(inputName){if(!(inputName in inputGradients))throw new Error("Cannot backprop through input "+inputName+". Available gradients found: "+Object.keys(inputGradients)+".");var dx=tidy((function(){return inputGradients[inputName]()}));if("float32"!==dx.dtype)throw new Error("Error in gradient for op "+node.kernelName+". The gradient of input "+inputName+" must have 'float32' dtype, but has '"+dx.dtype+"'");var x=node.inputs[inputName];if(!util.arraysEqual(dx.shape,x.shape))throw new Error("Error in gradient for op "+node.kernelName+". The gradient of input '"+inputName+"' has shape '"+dx.shape+"', which does not match the shape of the input '"+x.shape+"'");if(null==tensorAccumulatedGradientMap[x.id])tensorAccumulatedGradientMap[x.id]=dx;else{var curGradient=tensorAccumulatedGradientMap[x.id];tensorAccumulatedGradientMap[x.id]=curGradient.add(dx),curGradient.dispose()}};for(var inputName in node.inputs)_loop_2(inputName)},i=filteredTape.length-1;i>=0;i--)_loop_1(i)}},{"./util":214}],207:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_format_1=require("./tensor_format"),util=require("./util"),util_1=require("./util"),TensorBuffer=function(){function TensorBuffer(shape,dtype,values){var _this=this;if(this.dtype=dtype,this.shape=shape.slice(),this.size=util.sizeFromShape(shape),null!=values){var n_1=values.length;util.assert(n_1===this.size,(function(){return"Length of values '"+n_1+"' does not match the size inferred by the shape '"+_this.size+"'."}))}if("complex64"===dtype)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=values||util.getArrayFromDType(dtype,this.size),this.strides=util_1.computeStrides(shape)}return TensorBuffer.prototype.set=function(value){for(var _this=this,locs=[],_i=1;_i<arguments.length;_i++)locs[_i-1]=arguments[_i];0===locs.length&&(locs=[0]),util.assert(locs.length===this.rank,(function(){return"The number of provided coordinates ("+locs.length+") must match the rank ("+_this.rank+")"}));var index=this.locToIndex(locs);this.values[index]=value},TensorBuffer.prototype.get=function(){for(var locs=[],_i=0;_i<arguments.length;_i++)locs[_i]=arguments[_i];0===locs.length&&(locs=[0]);for(var i=0,_a=0,locs_1=locs;_a<locs_1.length;_a++){var loc=locs_1[_a];if(loc<0||loc>=this.shape[i]){var msg="Requested out of range element at "+locs+".   Buffer shape="+this.shape;throw new Error(msg)}i++}for(var index=locs[locs.length-1],i_1=0;i_1<locs.length-1;++i_1)index+=this.strides[i_1]*locs[i_1];return this.values[index]},TensorBuffer.prototype.locToIndex=function(locs){if(0===this.rank)return 0;if(1===this.rank)return locs[0];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];return index},TensorBuffer.prototype.indexToLoc=function(index){if(0===this.rank)return[];if(1===this.rank)return[index];for(var locs=new Array(this.shape.length),i=0;i<locs.length-1;++i)locs[i]=Math.floor(index/this.strides[i]),index-=locs[i]*this.strides[i];return locs[locs.length-1]=index,locs},Object.defineProperty(TensorBuffer.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),TensorBuffer.prototype.toTensor=function(){return trackerFn().makeTensor(this.values,this.shape,this.dtype)},TensorBuffer}();exports.TensorBuffer=TensorBuffer;var trackerFn=null,opHandler=null,deprecationWarningFn=null;exports.setTensorTracker=function(fn){trackerFn=fn},exports.setOpHandler=function(handler){opHandler=handler},exports.setDeprecationWarningFn=function(fn){deprecationWarningFn=fn};var Tensor=function(){function Tensor(shape,dtype,dataId,id){this.kept=!1,this.isDisposedInternal=!1,this.shape=shape.slice(),this.dtype=dtype||"float32",this.size=util.sizeFromShape(shape),this.strides=util_1.computeStrides(shape),this.dataId=dataId,this.id=id,this.rankType=this.rank<5?this.rank.toString():"higher"}return Tensor.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},Tensor.prototype.asScalar=function(){return this.throwIfDisposed(),util.assert(1===this.size,(function(){return"The array must have only 1 element."})),this.reshape([])},Tensor.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},Tensor.prototype.as2D=function(rows,columns){return this.throwIfDisposed(),this.reshape([rows,columns])},Tensor.prototype.as3D=function(rows,columns,depth){return this.throwIfDisposed(),this.reshape([rows,columns,depth])},Tensor.prototype.as4D=function(rows,columns,depth,depth2){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2])},Tensor.prototype.as5D=function(rows,columns,depth,depth2,depth3){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2,depth3])},Tensor.prototype.asType=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Object.defineProperty(Tensor.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),Tensor.prototype.buffer=function(){return __awaiter(this,void 0,void 0,(function(){var vals;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,opHandler.buffer(this.shape,this.dtype,vals)]}}))}))},Tensor.prototype.bufferSync=function(){return opHandler.buffer(this.shape,this.dtype,this.dataSync())},Tensor.prototype.array=function(){return __awaiter(this,void 0,void 0,(function(){var vals;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,util_1.toNestedArray(this.shape,vals)]}}))}))},Tensor.prototype.arraySync=function(){return util_1.toNestedArray(this.shape,this.dataSync())},Tensor.prototype.data=function(){return __awaiter(this,void 0,void 0,(function(){var data,bytes;return __generator(this,(function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),data=trackerFn().read(this.dataId),"string"!==this.dtype?[3,2]:[4,data];case 1:bytes=_a.sent();try{return[2,bytes.map((function(b){return util.decodeString(b)}))]}catch(_b){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}_a.label=2;case 2:return[2,data]}}))}))},Tensor.prototype.dataSync=function(){this.throwIfDisposed();var data=trackerFn().readSync(this.dataId);if("string"===this.dtype)try{return data.map((function(b){return util.decodeString(b)}))}catch(_a){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return data},Tensor.prototype.bytes=function(){return __awaiter(this,void 0,void 0,(function(){var data;return __generator(this,(function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),[4,trackerFn().read(this.dataId)];case 1:return data=_a.sent(),"string"===this.dtype?[2,data]:[2,new Uint8Array(data.buffer)]}}))}))},Tensor.prototype.dispose=function(){this.isDisposed||(trackerFn().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(Tensor.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),Tensor.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},Tensor.prototype.toFloat=function(){return this.asType("float32")},Tensor.prototype.toInt=function(){return this.asType("int32")},Tensor.prototype.toBool=function(){return this.asType("bool")},Tensor.prototype.print=function(verbose){return void 0===verbose&&(verbose=!1),opHandler.print(this,verbose)},Tensor.prototype.reshape=function(newShape){return this.throwIfDisposed(),opHandler.reshape(this,newShape)},Tensor.prototype.reshapeAs=function(x){return this.throwIfDisposed(),this.reshape(x.shape)},Tensor.prototype.expandDims=function(axis){return void 0===axis&&(axis=0),opHandler.expandDims(this,axis)},Tensor.prototype.cumsum=function(axis,exclusive,reverse){return void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1),opHandler.cumsum(this,axis,exclusive,reverse)},Tensor.prototype.squeeze=function(axis){return this.throwIfDisposed(),opHandler.squeeze(this,axis)},Tensor.prototype.clone=function(){return this.throwIfDisposed(),opHandler.clone(this)},Tensor.prototype.oneHot=function(depth,onValue,offValue){return this.throwIfDisposed(),opHandler.oneHot(this,depth,onValue,offValue)},Tensor.prototype.toString=function(verbose){void 0===verbose&&(verbose=!1);var vals=this.dataSync();return tensor_format_1.tensorToString(vals,this.shape,this.dtype,verbose)},Tensor.prototype.tile=function(reps){return this.throwIfDisposed(),opHandler.tile(this,reps)},Tensor.prototype.gather=function(indices,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.gather(this,indices,axis)},Tensor.prototype.matMul=function(b,transposeA,transposeB){return void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),this.throwIfDisposed(),opHandler.matMul(this,b,transposeA,transposeB)},Tensor.prototype.dot=function(b){return this.throwIfDisposed(),opHandler.dot(this,b)},Tensor.prototype.norm=function(ord,axis,keepDims){return void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.norm(this,ord,axis,keepDims)},Tensor.prototype.slice=function(begin,size){return this.throwIfDisposed(),opHandler.slice(this,begin,size)},Tensor.prototype.reverse=function(axis){return this.throwIfDisposed(),opHandler.reverse(this,axis)},Tensor.prototype.concat=function(x,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),x instanceof Tensor&&(x=[x]),opHandler.concat([this].concat(x),axis)},Tensor.prototype.split=function(numOrSizeSplits,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.split(this,numOrSizeSplits,axis)},Tensor.prototype.stack=function(x,axis){return void 0===axis&&(axis=0),opHandler.stack([this,x],axis)},Tensor.prototype.unstack=function(axis){return void 0===axis&&(axis=0),opHandler.unstack(this,axis)},Tensor.prototype.pad=function(paddings,constantValue){return void 0===constantValue&&(constantValue=0),opHandler.pad(this,paddings,constantValue)},Tensor.prototype.batchNormalization=function(mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),deprecationWarningFn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.batchNorm=function(mean,variance,offset,scale,varianceEpsilon){return void 0===varianceEpsilon&&(varianceEpsilon=.001),this.throwIfDisposed(),opHandler.batchNorm(this,mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.all=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.all(this,axis,keepDims)},Tensor.prototype.any=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.any(this,axis,keepDims)},Tensor.prototype.logSumExp=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.logSumExp(this,axis,keepDims)},Tensor.prototype.sum=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.sum(this,axis,keepDims)},Tensor.prototype.prod=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.prod(this,axis,keepDims)},Tensor.prototype.mean=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.mean(this,axis,keepDims)},Tensor.prototype.min=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.min(this,axis,keepDims)},Tensor.prototype.max=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.max(this,axis,keepDims)},Tensor.prototype.argMin=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMin(this,axis)},Tensor.prototype.argMax=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMax(this,axis)},Tensor.prototype.cast=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Tensor.prototype.add=function(x){return this.throwIfDisposed(),opHandler.add(this,x)},Tensor.prototype.addStrict=function(x){return this.throwIfDisposed(),opHandler.addStrict(this,x)},Tensor.prototype.atan2=function(x){return this.throwIfDisposed(),opHandler.atan2(this,x)},Tensor.prototype.sub=function(x){return this.throwIfDisposed(),opHandler.sub(this,x)},Tensor.prototype.subStrict=function(x){return this.throwIfDisposed(),opHandler.subStrict(this,x)},Tensor.prototype.pow=function(exp){return this.throwIfDisposed(),opHandler.pow(this,exp)},Tensor.prototype.powStrict=function(exp){return this.throwIfDisposed(),opHandler.powStrict(this,exp)},Tensor.prototype.mul=function(x){return this.throwIfDisposed(),opHandler.mul(this,x)},Tensor.prototype.mulStrict=function(x){return this.throwIfDisposed(),opHandler.mulStrict(this,x)},Tensor.prototype.div=function(x){return this.throwIfDisposed(),opHandler.div(this,x)},Tensor.prototype.divNoNan=function(x){return this.throwIfDisposed(),opHandler.divNoNan(this,x)},Tensor.prototype.floorDiv=function(x){return this.throwIfDisposed(),opHandler.floorDiv(this,x)},Tensor.prototype.divStrict=function(x){return this.throwIfDisposed(),opHandler.divStrict(this,x)},Tensor.prototype.minimum=function(x){return this.throwIfDisposed(),opHandler.minimum(this,x)},Tensor.prototype.minimumStrict=function(x){return this.throwIfDisposed(),opHandler.minimumStrict(this,x)},Tensor.prototype.maximum=function(x){return this.throwIfDisposed(),opHandler.maximum(this,x)},Tensor.prototype.maximumStrict=function(x){return this.throwIfDisposed(),opHandler.maximumStrict(this,x)},Tensor.prototype.mod=function(x){return this.throwIfDisposed(),opHandler.mod(this,x)},Tensor.prototype.modStrict=function(x){return this.throwIfDisposed(),opHandler.modStrict(this,x)},Tensor.prototype.squaredDifferenceStrict=function(x){return this.throwIfDisposed(),opHandler.squaredDifferenceStrict(this,x)},Tensor.prototype.transpose=function(perm){return this.throwIfDisposed(),opHandler.transpose(this,perm)},Tensor.prototype.notEqual=function(x){return this.throwIfDisposed(),opHandler.notEqual(this,x)},Tensor.prototype.notEqualStrict=function(x){return this.throwIfDisposed(),opHandler.notEqualStrict(this,x)},Tensor.prototype.less=function(x){return this.throwIfDisposed(),opHandler.less(this,x)},Tensor.prototype.lessStrict=function(x){return this.throwIfDisposed(),opHandler.lessStrict(this,x)},Tensor.prototype.equal=function(x){return this.throwIfDisposed(),opHandler.equal(this,x)},Tensor.prototype.equalStrict=function(x){return this.throwIfDisposed(),opHandler.equalStrict(this,x)},Tensor.prototype.lessEqual=function(x){return this.throwIfDisposed(),opHandler.lessEqual(this,x)},Tensor.prototype.lessEqualStrict=function(x){return this.throwIfDisposed(),opHandler.lessEqualStrict(this,x)},Tensor.prototype.greater=function(x){return this.throwIfDisposed(),opHandler.greater(this,x)},Tensor.prototype.greaterStrict=function(x){return this.throwIfDisposed(),opHandler.greaterStrict(this,x)},Tensor.prototype.greaterEqual=function(x){return this.throwIfDisposed(),opHandler.greaterEqual(this,x)},Tensor.prototype.greaterEqualStrict=function(x){return this.throwIfDisposed(),opHandler.greaterEqualStrict(this,x)},Tensor.prototype.logicalAnd=function(x){return this.throwIfDisposed(),opHandler.logicalAnd(this,x)},Tensor.prototype.logicalOr=function(x){return this.throwIfDisposed(),opHandler.logicalOr(this,x)},Tensor.prototype.logicalNot=function(){return this.throwIfDisposed(),opHandler.logicalNot(this)},Tensor.prototype.logicalXor=function(x){return this.throwIfDisposed(),opHandler.logicalXor(this,x)},Tensor.prototype.where=function(condition,x){return this.throwIfDisposed(),opHandler.where(condition,this,x)},Tensor.prototype.neg=function(){return this.throwIfDisposed(),opHandler.neg(this)},Tensor.prototype.ceil=function(){return this.throwIfDisposed(),opHandler.ceil(this)},Tensor.prototype.floor=function(){return this.throwIfDisposed(),opHandler.floor(this)},Tensor.prototype.sign=function(){return this.throwIfDisposed(),opHandler.sign(this)},Tensor.prototype.isNaN=function(){return this.throwIfDisposed(),opHandler.isNaN(this)},Tensor.prototype.isInf=function(){return this.throwIfDisposed(),opHandler.isInf(this)},Tensor.prototype.isFinite=function(){return this.throwIfDisposed(),opHandler.isFinite(this)},Tensor.prototype.exp=function(){return this.throwIfDisposed(),opHandler.exp(this)},Tensor.prototype.expm1=function(){return this.throwIfDisposed(),opHandler.expm1(this)},Tensor.prototype.log=function(){return this.throwIfDisposed(),opHandler.log(this)},Tensor.prototype.log1p=function(){return this.throwIfDisposed(),opHandler.log1p(this)},Tensor.prototype.sqrt=function(){return this.throwIfDisposed(),opHandler.sqrt(this)},Tensor.prototype.rsqrt=function(){return this.throwIfDisposed(),opHandler.rsqrt(this)},Tensor.prototype.square=function(){return this.throwIfDisposed(),opHandler.square(this)},Tensor.prototype.reciprocal=function(){return this.throwIfDisposed(),opHandler.reciprocal(this)},Tensor.prototype.abs=function(){return this.throwIfDisposed(),opHandler.abs(this)},Tensor.prototype.clipByValue=function(min,max){return this.throwIfDisposed(),opHandler.clipByValue(this,min,max)},Tensor.prototype.relu=function(){return this.throwIfDisposed(),opHandler.relu(this)},Tensor.prototype.relu6=function(){return this.throwIfDisposed(),opHandler.relu6(this)},Tensor.prototype.elu=function(){return this.throwIfDisposed(),opHandler.elu(this)},Tensor.prototype.selu=function(){return this.throwIfDisposed(),opHandler.selu(this)},Tensor.prototype.leakyRelu=function(alpha){return void 0===alpha&&(alpha=.2),this.throwIfDisposed(),opHandler.leakyRelu(this,alpha)},Tensor.prototype.prelu=function(alpha){return this.throwIfDisposed(),opHandler.prelu(this,alpha)},Tensor.prototype.sigmoid=function(){return this.throwIfDisposed(),opHandler.sigmoid(this)},Tensor.prototype.logSigmoid=function(){return this.throwIfDisposed(),opHandler.logSigmoid(this)},Tensor.prototype.softplus=function(){return this.throwIfDisposed(),opHandler.softplus(this)},Tensor.prototype.zerosLike=function(){return this.throwIfDisposed(),opHandler.zerosLike(this)},Tensor.prototype.onesLike=function(){return this.throwIfDisposed(),opHandler.onesLike(this)},Tensor.prototype.sin=function(){return this.throwIfDisposed(),opHandler.sin(this)},Tensor.prototype.cos=function(){return this.throwIfDisposed(),opHandler.cos(this)},Tensor.prototype.tan=function(){return this.throwIfDisposed(),opHandler.tan(this)},Tensor.prototype.asin=function(){return this.throwIfDisposed(),opHandler.asin(this)},Tensor.prototype.acos=function(){return this.throwIfDisposed(),opHandler.acos(this)},Tensor.prototype.atan=function(){return this.throwIfDisposed(),opHandler.atan(this)},Tensor.prototype.sinh=function(){return this.throwIfDisposed(),opHandler.sinh(this)},Tensor.prototype.cosh=function(){return this.throwIfDisposed(),opHandler.cosh(this)},Tensor.prototype.tanh=function(){return this.throwIfDisposed(),opHandler.tanh(this)},Tensor.prototype.asinh=function(){return this.throwIfDisposed(),opHandler.asinh(this)},Tensor.prototype.acosh=function(){return this.throwIfDisposed(),opHandler.acosh(this)},Tensor.prototype.atanh=function(){return this.throwIfDisposed(),opHandler.atanh(this)},Tensor.prototype.erf=function(){return this.throwIfDisposed(),opHandler.erf(this)},Tensor.prototype.round=function(){return this.throwIfDisposed(),opHandler.round(this)},Tensor.prototype.step=function(alpha){return void 0===alpha&&(alpha=0),this.throwIfDisposed(),opHandler.step(this,alpha)},Tensor.prototype.softmax=function(dim){return void 0===dim&&(dim=-1),this.throwIfDisposed(),opHandler.softmax(this,dim)},Tensor.prototype.logSoftmax=function(axis){return void 0===axis&&(axis=-1),this.throwIfDisposed(),opHandler.logSoftmax(this,axis)},Tensor.prototype.resizeBilinear=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeBilinear(this,newShape2D,alignCorners)},Tensor.prototype.resizeNearestNeighbor=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeNearestNeighbor(this,newShape2D,alignCorners)},Tensor.prototype.conv1d=function(filter,stride,pad,dataFormat,dilation,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1),this.throwIfDisposed(),opHandler.conv1d(this,filter,stride,pad,dataFormat,dilation,dimRoundingMode)},Tensor.prototype.conv2d=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.conv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.conv2dTranspose=function(filter,outputShape,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.conv2dTranspose(this,filter,outputShape,strides,pad,dimRoundingMode)},Tensor.prototype.depthwiseConv2D=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.depthwiseConv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.separableConv2d=function(depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){return void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC"),this.throwIfDisposed(),opHandler.separableConv2d(this,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat)},Tensor.prototype.avgPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.avgPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.maxPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.maxPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.localResponseNormalization=function(radius,bias,alpha,beta){return void 0===radius&&(radius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5),opHandler.localResponseNormalization(this,radius,bias,alpha,beta)},Tensor.prototype.pool=function(windowShape,poolingType,padding,dilationRate,strides){return this.throwIfDisposed(),opHandler.pool(this,windowShape,poolingType,padding,dilationRate,strides)},Tensor.prototype.variable=function(trainable,name,dtype){return void 0===trainable&&(trainable=!0),this.throwIfDisposed(),trackerFn().makeVariable(this,trainable,name,dtype)},Tensor.prototype.unsortedSegmentSum=function(segmentIds,numSegments){return this.throwIfDisposed(),opHandler.unsortedSegmentSum(this,segmentIds,numSegments)},Tensor.prototype.batchToSpaceND=function(blockShape,crops){return this.throwIfDisposed(),opHandler.batchToSpaceND(this,blockShape,crops)},Tensor.prototype.spaceToBatchND=function(blockShape,paddings){return this.throwIfDisposed(),opHandler.spaceToBatchND(this,blockShape,paddings)},Tensor.prototype.topk=function(k,sorted){return void 0===k&&(k=1),void 0===sorted&&(sorted=!0),this.throwIfDisposed(),opHandler.topk(this,k,sorted)},Tensor.prototype.stridedSlice=function(begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){return void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),this.throwIfDisposed(),opHandler.stridedSlice(this,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)},Tensor.prototype.depthToSpace=function(blockSize,dataFormat){return this.throwIfDisposed(),opHandler.depthToSpace(this,blockSize,dataFormat)},Tensor.prototype.fft=function(){return this.throwIfDisposed(),opHandler.spectral.fft(this)},Tensor.prototype.ifft=function(){return this.throwIfDisposed(),opHandler.spectral.ifft(this)},Tensor.prototype.rfft=function(){return this.throwIfDisposed(),opHandler.spectral.rfft(this)},Tensor.prototype.irfft=function(){return this.throwIfDisposed(),opHandler.spectral.irfft(this)},Tensor}();exports.Tensor=Tensor,Object.defineProperty(Tensor,Symbol.hasInstance,{value:function(instance){return!!instance&&null!=instance.dataId&&null!=instance.shape&&null!=instance.dtype}});var Variable=function(_super){function Variable(initialValue,trainable,name,tensorId){var _this=_super.call(this,initialValue.shape,initialValue.dtype,initialValue.dataId,tensorId)||this;return _this.trainable=trainable,_this.name=name,_this}return __extends(Variable,_super),Variable.prototype.assign=function(newValue){if(newValue.dtype!==this.dtype)throw new Error("dtype of the new value ("+newValue.dtype+") and previous value ("+this.dtype+") must match");if(!util.arraysEqual(newValue.shape,this.shape))throw new Error("shape of the new value ("+newValue.shape+") and previous value ("+this.shape+") must match");trackerFn().disposeTensor(this),this.dataId=newValue.dataId,trackerFn().incRef(this,null)},Variable.prototype.dispose=function(){trackerFn().disposeVariable(this),this.isDisposedInternal=!0},Variable}(Tensor);exports.Variable=Variable,Object.defineProperty(Variable,Symbol.hasInstance,{value:function(instance){return instance instanceof Tensor&&null!=instance.assign&&instance.assign instanceof Function}})},{"./tensor_format":208,"./util":214}],208:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util");function valToString(val,pad,dtype){var valStr;return valStr=Array.isArray(val)?parseFloat(val[0].toFixed(7))+" + "+parseFloat(val[1].toFixed(7))+"j":util_1.isString(val)?"'"+val+"'":"bool"===dtype?boolNumToString(val):parseFloat(val.toFixed(7)).toString(),util_1.rightPad(valStr,pad)}function boolNumToString(v){return 0===v?"false":"true"}function subTensorToString(vals,shape,dtype,strides,padPerCol,isLast){void 0===isLast&&(isLast=!0);var storagePerElement="complex64"===dtype?2:1,size=shape[0],rank=shape.length;if(0===rank)return"complex64"===dtype?[valToString(createComplexTuples(vals)[0],0,dtype)]:"bool"===dtype?[boolNumToString(vals[0])]:[vals[0].toString()];if(1===rank){if(size>20){var firstValsSize=3*storagePerElement,firstVals=Array.from(vals.slice(0,firstValsSize)),lastVals=Array.from(vals.slice((size-3)*storagePerElement,size*storagePerElement));return"complex64"===dtype&&(firstVals=createComplexTuples(firstVals),lastVals=createComplexTuples(lastVals)),["["+firstVals.map((function(x,i){return valToString(x,padPerCol[i],dtype)})).join(", ")+", ..., "+lastVals.map((function(x,i){return valToString(x,padPerCol[size-3+i],dtype)})).join(", ")+"]"]}return["["+("complex64"===dtype?createComplexTuples(vals):Array.from(vals)).map((function(x,i){return valToString(x,padPerCol[i],dtype)})).join(", ")+"]"]}var subshape=shape.slice(1),substrides=strides.slice(1),stride=strides[0]*storagePerElement,lines=[];if(size>20){for(var i=0;i<3;i++){var end=(start=i*stride)+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,!1))}lines.push("...");for(i=size-3;i<size;i++){end=(start=i*stride)+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}}else for(i=0;i<size;i++){var start;end=(start=i*stride)+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}var sep=2===rank?",":"";lines[0]="["+lines[0]+sep;for(i=1;i<lines.length-1;i++)lines[i]=" "+lines[i]+sep;var newLineSep=",\n";for(i=2;i<rank;i++)newLineSep+="\n";return lines[lines.length-1]=" "+lines[lines.length-1]+"]"+(isLast?"":newLineSep),lines}function createComplexTuples(vals){for(var complexTuples=[],i=0;i<vals.length;i+=2)complexTuples.push([vals[i],vals[i+1]]);return complexTuples}exports.tensorToString=function(vals,shape,dtype,verbose){var strides=util_1.computeStrides(shape),padPerCol=function(vals,shape,dtype,strides){var n=util_1.sizeFromShape(shape),numCols=strides[strides.length-1],padPerCol=new Array(numCols).fill(0),rank=shape.length,valuesOrTuples="complex64"===dtype?createComplexTuples(vals):vals;if(rank>1)for(var row=0;row<n/numCols;row++)for(var offset=row*numCols,j=0;j<numCols;j++)padPerCol[j]=Math.max(padPerCol[j],valToString(valuesOrTuples[offset+j],0,dtype).length);return padPerCol}(vals,shape,dtype,strides),rank=shape.length,valsLines=subTensorToString(vals,shape,dtype,strides,padPerCol),lines=["Tensor"];return verbose&&(lines.push("  dtype: "+dtype),lines.push("  rank: "+rank),lines.push("  shape: ["+shape+"]"),lines.push("  values:")),lines.push(valsLines.map((function(l){return"    "+l})).join("\n")),lines.join("\n")}},{"./util":214}],209:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("./tensor"),types_1=require("./types"),util_1=require("./util");function walkTensorContainer(container,list,seen){if(null!=container)if(container instanceof tensor_1.Tensor)list.push(container);else if(obj=container,Array.isArray(obj)||"object"==typeof obj){var obj,iterable=container;for(var k in iterable){var val=iterable[k];seen.has(val)||(seen.add(val),walkTensorContainer(val,list,seen))}}}exports.makeTypesMatch=function(a,b){if(a.dtype===b.dtype)return[a,b];var dtype=types_1.upcastType(a.dtype,b.dtype);return[a.cast(dtype),b.cast(dtype)]},exports.assertTypesMatch=function(a,b){util_1.assert(a.dtype===b.dtype,(function(){return"The dtypes of the first("+a.dtype+") and second("+b.dtype+") input must match"}))},exports.isTensorInList=function(tensor,tensorList){return tensorList.some((function(x){return x.id===tensor.id}))},exports.getTensorsInContainer=function(result){var list=[];return walkTensorContainer(result,list,new Set),list}},{"./tensor":207,"./types":213,"./util":214}],210:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),environment_1=require("./environment"),tensor_1=require("./tensor"),util_1=require("./util");function inferShape(val,dtype){var firstElem=val;if(util_1.isTypedArray(val))return"string"===dtype?[]:[val.length];if(!Array.isArray(val))return[];for(var shape=[];Array.isArray(firstElem)||util_1.isTypedArray(firstElem)&&"string"!==dtype;)shape.push(firstElem.length),firstElem=firstElem[0];return Array.isArray(val)&&environment_1.env().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&deepAssertShapeConsistency(val,shape,[]),shape}function deepAssertShapeConsistency(val,shape,indices){if(indices=indices||[],Array.isArray(val)||util_1.isTypedArray(val)){util_1.assert(shape.length>0,(function(){return"Element arr["+indices.join("][")+"] should be a primitive, but is an array of "+val.length+" elements"})),util_1.assert(val.length===shape[0],(function(){return"Element arr["+indices.join("][")+"] should have "+shape[0]+" elements, but has "+val.length+" elements"}));for(var subShape=shape.slice(1),i=0;i<val.length;++i)deepAssertShapeConsistency(val[i],subShape,indices.concat(i))}else util_1.assert(0===shape.length,(function(){return"Element arr["+indices.join("][")+"] is a primitive, but should be an array/TypedArray of "+shape[0]+" elements"}))}function assertDtype(expectedDtype,actualDType,argName,functionName){if(null!=expectedDtype&&("numeric"!==expectedDtype&&expectedDtype!==actualDType||"numeric"===expectedDtype&&"string"===actualDType))throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be "+expectedDtype+" tensor, but got "+actualDType+" tensor")}function convertToTensor(x,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),x instanceof tensor_1.Tensor)return assertDtype(parseAsDtype,x.dtype,argName,functionName),x;var inferredDtype=util_1.inferDtype(x);if("string"!==inferredDtype&&["bool","int32","float32"].indexOf(parseAsDtype)>=0&&(inferredDtype=parseAsDtype),assertDtype(parseAsDtype,inferredDtype,argName,functionName),null==x||!util_1.isTypedArray(x)&&!Array.isArray(x)&&"number"!=typeof x&&"boolean"!=typeof x&&"string"!=typeof x){var type=null==x?"null":x.constructor.name;throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be a Tensor or TensorLike, but got '"+type+"'")}var inferredShape=inferShape(x,inferredDtype);util_1.isTypedArray(x)||Array.isArray(x)||(x=[x]);var values="string"!==inferredDtype?util_1.toTypedArray(x,inferredDtype,environment_1.env().getBool("DEBUG")):util_1.flatten(x,[],!0);return engine_1.ENGINE.makeTensor(values,inferredShape,inferredDtype)}exports.inferShape=inferShape,exports.convertToTensor=convertToTensor,exports.convertToTensorArray=function(arg,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),!Array.isArray(arg))throw new Error("Argument "+argName+" passed to "+functionName+" must be a `Tensor[]` or `TensorLike[]`");return arg.map((function(t,i){return convertToTensor(t,argName+"["+i+"]",functionName)}),parseAsDtype)}},{"./engine":106,"./environment":107,"./tensor":207,"./util":214}],211:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_util_env_1=require("./tensor_util_env"),util_1=require("./util");function testEpsilon(){return 32===engine_1.ENGINE.backend.floatPrecision()?.001:exports.TEST_EPSILON_FLOAT16}function expectArraysPredicate(actual,expected,predicate){var checkClassType=!0;if((util_1.isTypedArray(actual)||util_1.isTypedArray(expected))&&(checkClassType=!1),util_1.isTypedArray(actual)&&util_1.isTypedArray(expected)&&(checkClassType=!0),checkClassType){var aType=actual.constructor.name,bType=expected.constructor.name;if(aType!==bType)throw new Error("Arrays are of different type. Actual: "+aType+". Expected: "+bType)}if(Array.isArray(actual)&&Array.isArray(expected)){var actualShape=tensor_util_env_1.inferShape(actual),expectedShape=tensor_util_env_1.inferShape(expected);if(!util_1.arraysEqual(actualShape,expectedShape))throw new Error("Arrays have different shapes. Actual: ["+actualShape+"]. Expected: ["+expectedShape+"]")}var actualFlat=util_1.isTypedArray(actual)?actual:util_1.flatten(actual),expectedFlat=util_1.isTypedArray(expected)?expected:util_1.flatten(expected);if(actualFlat.length!==expectedFlat.length)throw new Error("Arrays have different lengths actual: "+actualFlat.length+" vs expected: "+expectedFlat.length+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".");for(var i=0;i<expectedFlat.length;++i){var a=actualFlat[i],e=expectedFlat[i];if(!predicate(a,e))throw new Error("Arrays differ: actual["+i+"] = "+a+", expected["+i+"] = "+e+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".")}}function areClose(a,e,epsilon){return!isFinite(a)&&!isFinite(e)||!(isNaN(a)||isNaN(e)||Math.abs(a-e)>epsilon)}exports.TEST_EPSILON_FLOAT16=.1,exports.expectArraysClose=function(actual,expected,epsilon){return null==epsilon&&(epsilon=testEpsilon()),expectArraysPredicate(actual,expected,(function(a,b){return areClose(a,b,epsilon)}))},exports.testEpsilon=testEpsilon,exports.expectPromiseToFail=function(fn,done){fn().then((function(){return done.fail()}),(function(){return done()}))},exports.expectArraysEqual=function(actual,expected){var exp="string"==typeof expected||"number"==typeof expected||"boolean"==typeof expected?[expected]:expected;return util_1.isString(actual)||util_1.isString(actual[0])||util_1.isString(expected)||util_1.isString(expected[0])?expectArraysPredicate(actual,exp,(function(a,b){return a==b})):expectArraysPredicate(actual,expected,(function(a,b){return areClose(a,b,0)}))},exports.expectNumbersClose=function(a,e,epsilon){if(null==epsilon&&(epsilon=testEpsilon()),!areClose(a,e,epsilon))throw new Error("Numbers differ: actual === "+a+", expected === "+e)},exports.expectValuesInRange=function(actual,low,high){for(var i=0;i<actual.length;i++)if(actual[i]<low||actual[i]>high)throw new Error("Value out of range:"+actual[i]+" low: "+low+", high: "+high)},exports.expectArrayBuffersEqual=function(actual,expected){expect(new Float32Array(actual)).toEqual(new Float32Array(expected))}},{"./engine":106,"./tensor_util_env":210,"./util":214}],212:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer"),adagrad_optimizer_1=require("./optimizers/adagrad_optimizer"),adam_optimizer_1=require("./optimizers/adam_optimizer"),adamax_optimizer_1=require("./optimizers/adamax_optimizer"),momentum_optimizer_1=require("./optimizers/momentum_optimizer"),optimizer_constructors_1=require("./optimizers/optimizer_constructors"),rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer"),sgd_optimizer_1=require("./optimizers/sgd_optimizer");momentum_optimizer_1.MomentumOptimizer,sgd_optimizer_1.SGDOptimizer,adadelta_optimizer_1.AdadeltaOptimizer,adagrad_optimizer_1.AdagradOptimizer,rmsprop_optimizer_1.RMSPropOptimizer,adamax_optimizer_1.AdamaxOptimizer,adam_optimizer_1.AdamOptimizer,exports.train={sgd:optimizer_constructors_1.OptimizerConstructors.sgd,momentum:optimizer_constructors_1.OptimizerConstructors.momentum,adadelta:optimizer_constructors_1.OptimizerConstructors.adadelta,adagrad:optimizer_constructors_1.OptimizerConstructors.adagrad,rmsprop:optimizer_constructors_1.OptimizerConstructors.rmsprop,adamax:optimizer_constructors_1.OptimizerConstructors.adamax,adam:optimizer_constructors_1.OptimizerConstructors.adam}},{"./optimizers/adadelta_optimizer":190,"./optimizers/adagrad_optimizer":191,"./optimizers/adam_optimizer":192,"./optimizers/adamax_optimizer":193,"./optimizers/momentum_optimizer":194,"./optimizers/optimizer_constructors":196,"./optimizers/rmsprop_optimizer":197,"./optimizers/sgd_optimizer":198}],213:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var UpcastInt32AndMap,UpcastBoolAndMap,UpcastFloat32AndMap,UpcastComplex64AndMap;Object.defineProperty(exports,"__esModule",{value:!0}),function(Rank){Rank.R0="R0",Rank.R1="R1",Rank.R2="R2",Rank.R3="R3",Rank.R4="R4",Rank.R5="R5",Rank.R6="R6"}(exports.Rank||(exports.Rank={})),function(UpcastInt32AndMap){UpcastInt32AndMap.float32="float32",UpcastInt32AndMap.int32="int32",UpcastInt32AndMap.bool="int32",UpcastInt32AndMap.complex64="complex64"}(UpcastInt32AndMap||(UpcastInt32AndMap={})),function(UpcastBoolAndMap){UpcastBoolAndMap.float32="float32",UpcastBoolAndMap.int32="int32",UpcastBoolAndMap.bool="bool",UpcastBoolAndMap.complex64="complex64"}(UpcastBoolAndMap||(UpcastBoolAndMap={})),function(UpcastFloat32AndMap){UpcastFloat32AndMap.float32="float32",UpcastFloat32AndMap.int32="float32",UpcastFloat32AndMap.bool="float32",UpcastFloat32AndMap.complex64="complex64"}(UpcastFloat32AndMap||(UpcastFloat32AndMap={})),function(UpcastComplex64AndMap){UpcastComplex64AndMap.float32="complex64",UpcastComplex64AndMap.int32="complex64",UpcastComplex64AndMap.bool="complex64",UpcastComplex64AndMap.complex64="complex64"}(UpcastComplex64AndMap||(UpcastComplex64AndMap={}));var upcastTypeMap={float32:UpcastFloat32AndMap,int32:UpcastInt32AndMap,bool:UpcastBoolAndMap,complex64:UpcastComplex64AndMap};function upcastType(typeA,typeB){if("string"===typeA||"string"===typeB){if("string"===typeA&&"string"===typeB)return"string";throw new Error("Can not upcast "+typeA+" with "+typeB)}return upcastTypeMap[typeA][typeB]}exports.upcastType=upcastType,exports.sumOutType=function(type){return upcastType(type,"int32")}},{}],214:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2017 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");function shuffle(array){for(var counter=array.length,temp=0,index=0;counter>0;)index=Math.random()*counter|0,temp=array[--counter],array[counter]=array[index],array[index]=temp}function assert(expr,msg){if(!expr)throw new Error("string"==typeof msg?msg:msg())}function flatten(arr,result,skipTypedArray){if(void 0===result&&(result=[]),void 0===skipTypedArray&&(skipTypedArray=!1),null==result&&(result=[]),Array.isArray(arr)||isTypedArray(arr)&&!skipTypedArray)for(var i=0;i<arr.length;++i)flatten(arr[i],result,skipTypedArray);else result.push(arr);return result}function arraysEqual(n1,n2){if(n1===n2)return!0;if(null==n1||null==n2)return!1;if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(n1[i]!==n2[i])return!1;return!0}function isInt(a){return a%1==0}function parseAxisParam(axis,shape){var rank=shape.length;return assert((axis=null==axis?shape.map((function(s,i){return i})):[].concat(axis)).every((function(ax){return ax>=-rank&&ax<rank})),(function(){return"All values in axis param must be in range [-"+rank+", "+rank+") but got axis "+axis})),assert(axis.every((function(ax){return isInt(ax)})),(function(){return"All values in axis param must be integers but got axis "+axis})),axis.map((function(a){return a<0?rank+a:a}))}function checkConversionForErrors(vals,dtype){for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))throw Error("A tensor of type "+dtype+" being uploaded contains "+num+".")}}function isTypedArray(a){return a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array}function isString(value){return"string"==typeof value||value instanceof String}function isBoolean(value){return"boolean"==typeof value}function isNumber(value){return"number"==typeof value}function createNestedArray(offset,shape,a){var ret=new Array;if(1===shape.length)for(var d=shape[0],i=0;i<d;i++)ret[i]=a[offset+i];else{d=shape[0];var rest=shape.slice(1),len=rest.reduce((function(acc,c){return acc*c}));for(i=0;i<d;i++)ret[i]=createNestedArray(offset+i*len,rest,a)}return ret}function makeZerosTypedArray(size,dtype){if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(size);if("int32"===dtype)return new Int32Array(size);if("bool"===dtype)return new Uint8Array(size);throw new Error("Unknown data type "+dtype)}exports.shuffle=shuffle,exports.clamp=function(min,x,max){return Math.max(min,Math.min(x,max))},exports.nearestLargerEven=function(val){return val%2==0?val:val+1},exports.sum=function(arr){for(var sum=0,i=0;i<arr.length;i++)sum+=arr[i];return sum},exports.randUniform=function(a,b){var r=Math.random();return b*r+(1-r)*a},exports.distSquared=function(a,b){for(var result=0,i=0;i<a.length;i++){var diff=Number(a[i])-Number(b[i]);result+=diff*diff}return result},exports.assert=assert,exports.assertShapesMatch=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),assert(arraysEqual(shapeA,shapeB),(function(){return errorMessagePrefix+" Shapes "+shapeA+" and "+shapeB+" must match"}))},exports.assertNonNull=function(a){assert(null!=a,(function(){return"The input to the tensor constructor must be a non-null value."}))},exports.flatten=flatten,exports.sizeFromShape=function(shape){if(0===shape.length)return 1;for(var size=shape[0],i=1;i<shape.length;i++)size*=shape[i];return size},exports.isScalarShape=function(shape){return 0===shape.length},exports.arraysEqual=arraysEqual,exports.isInt=isInt,exports.tanh=function(x){if(null!=Math.tanh)return Math.tanh(x);if(x===1/0)return 1;if(x===-1/0)return-1;var e2x=Math.exp(2*x);return(e2x-1)/(e2x+1)},exports.sizeToSquarishShape=function(size){var width=Math.ceil(Math.sqrt(size));return[width,Math.ceil(size/width)]},exports.createShuffledIndices=function(n){for(var shuffledIndices=new Uint32Array(n),i=0;i<n;++i)shuffledIndices[i]=i;return shuffle(shuffledIndices),shuffledIndices},exports.rightPad=function(a,size){return size<=a.length?a:a+" ".repeat(size-a.length)},exports.repeatedTry=function(checkFn,delayFn,maxCounter){return void 0===delayFn&&(delayFn=function(counter){return 0}),new Promise((function(resolve,reject){var tryCount=0,tryFn=function(){if(checkFn())resolve();else{tryCount++;var nextBackoff=delayFn(tryCount);null!=maxCounter&&tryCount>=maxCounter?reject():setTimeout(tryFn,nextBackoff)}};tryFn()}))},exports.inferFromImplicitShape=function(shape,size){for(var shapeProd=1,implicitIdx=-1,i=0;i<shape.length;++i)if(shape[i]>=0)shapeProd*=shape[i];else if(-1===shape[i]){if(-1!==implicitIdx)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+implicitIdx+" and dim "+i);implicitIdx=i}else if(shape[i]<0)throw Error("Shapes can not be < 0. Found "+shape[i]+" at dim "+i);if(-1===implicitIdx){if(size>0&&size!==shapeProd)throw Error("Size("+size+") must match the product of shape "+shape);return shape}if(0===shapeProd)throw Error("Cannot infer the missing size in ["+shape+"] when there are 0 elements");if(size%shapeProd!=0)throw Error("The implicit shape can't be a fractional number. Got "+size+" / "+shapeProd);var newShape=shape.slice();return newShape[implicitIdx]=size/shapeProd,newShape},exports.parseAxisParam=parseAxisParam,exports.squeezeShape=function(shape,axis){for(var newShape=[],keptDims=[],isEmptyArray=null!=axis&&Array.isArray(axis)&&0===axis.length,axes=null==axis||isEmptyArray?null:parseAxisParam(axis,shape).sort(),j=0,i=0;i<shape.length;++i){if(null!=axes){if(axes[j]===i&&1!==shape[i])throw new Error("Can't squeeze axis "+i+" since its dim '"+shape[i]+"' is not 1");(null==axes[j]||axes[j]>i)&&1===shape[i]&&(newShape.push(shape[i]),keptDims.push(i)),axes[j]<=i&&j++}1!==shape[i]&&(newShape.push(shape[i]),keptDims.push(i))}return{newShape:newShape,keptDims:keptDims}},exports.getTypedArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}return values},exports.getArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else if("bool"===dtype)values=new Uint8Array(size);else{if("string"!==dtype)throw new Error("Unknown data type "+dtype);values=new Array(size)}return values},exports.checkConversionForErrors=checkConversionForErrors,exports.isValidDtype=function(dtype){return"bool"===dtype||"complex64"===dtype||"float32"===dtype||"int32"===dtype||"string"===dtype},exports.hasEncodingLoss=function(oldType,newType){return"complex64"!==newType&&(("float32"!==newType||"complex64"===oldType)&&(("int32"!==newType||"float32"===oldType||"complex64"===oldType)&&("bool"!==newType||"bool"!==oldType)))},exports.isTypedArray=isTypedArray,exports.bytesPerElement=function(dtype){if("float32"===dtype||"int32"===dtype)return 4;if("complex64"===dtype)return 8;if("bool"===dtype)return 1;throw new Error("Unknown dtype "+dtype)},exports.bytesFromStringArray=function(arr){if(null==arr)return 0;var bytes=0;return arr.forEach((function(x){return bytes+=x.length})),bytes},exports.isString=isString,exports.isBoolean=isBoolean,exports.isNumber=isNumber,exports.inferDtype=function inferDtype(values){return Array.isArray(values)?inferDtype(values[0]):values instanceof Float32Array?"float32":values instanceof Int32Array||values instanceof Uint8Array?"int32":isNumber(values)?"float32":isString(values)?"string":isBoolean(values)?"bool":"float32"},exports.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)},exports.nearestDivisor=function(size,start){for(var i=start;i<size;++i)if(size%i==0)return i;return size},exports.computeStrides=function(shape){var rank=shape.length;if(rank<2)return[];var strides=new Array(rank-1);strides[rank-2]=shape[rank-1];for(var i=rank-3;i>=0;--i)strides[i]=strides[i+1]*shape[i+1];return strides},exports.toTypedArray=function(a,dtype,debugMode){if("string"===dtype)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(a)&&(a=flatten(a)),debugMode&&checkConversionForErrors(a,dtype),function(a,dtype){return a instanceof Float32Array&&"float32"===dtype||a instanceof Int32Array&&"int32"===dtype||a instanceof Uint8Array&&"bool"===dtype}(a,dtype))return a;if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(a);if("int32"===dtype)return new Int32Array(a);if("bool"===dtype){for(var bool=new Uint8Array(a.length),i=0;i<bool.length;++i)0!==Math.round(a[i])&&(bool[i]=1);return bool}throw new Error("Unknown data type "+dtype)},exports.toNestedArray=function(shape,a){if(0===shape.length)return a[0];var size=shape.reduce((function(acc,c){return acc*c}));if(0===size)return[];if(size!==a.length)throw new Error("["+shape+"] does not match the input size.");return createNestedArray(0,shape,a)},exports.makeOnesTypedArray=function(size,dtype){for(var array=makeZerosTypedArray(size,dtype),i=0;i<array.length;i++)array[i]=1;return array},exports.makeZerosTypedArray=makeZerosTypedArray,exports.now=function(){return environment_1.env().platform.now()},exports.assertNonNegativeIntegerDimensions=function(shape){shape.forEach((function(dimSize){assert(Number.isInteger(dimSize)&&dimSize>=0,(function(){return"Tensor must have a shape comprised of positive integers but got shape ["+shape+"]."}))}))},exports.fetch=function(path,requestInits){return environment_1.env().platform.fetch(path,requestInits)},exports.encodeString=function(s,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.env().platform.encode(s,encoding)},exports.decodeString=function(bytes,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.env().platform.decode(bytes,encoding)},exports.locToIndex=function(locs,rank,strides){if(0===rank)return 0;if(1===rank)return locs[0];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=strides[i]*locs[i];return index},exports.indexToLoc=function(index,rank,strides){if(0===rank)return[];if(1===rank)return[index];for(var locs=new Array(rank),i=0;i<locs.length-1;++i)locs[i]=Math.floor(index/strides[i]),index-=locs[i]*strides[i];return locs[locs.length-1]=index,locs}},{"./environment":107}],215:[function(require,module,exports){"use strict";
/** @license See the LICENSE file. */Object.defineProperty(exports,"__esModule",{value:!0});exports.version="1.7.0"},{}],216:[function(require,module,exports){"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */Object.defineProperty(exports,"__esModule",{value:!0});var gpgpu_util=require("./backends/webgl/gpgpu_util");exports.gpgpu_util=gpgpu_util;var webgl_util=require("./backends/webgl/webgl_util");exports.webgl_util=webgl_util;var environment_1=require("./environment"),backend_webgl_1=require("./backends/webgl/backend_webgl");exports.MathBackendWebGL=backend_webgl_1.MathBackendWebGL;var canvas_util_1=require("./backends/webgl/canvas_util");exports.setWebGLContext=canvas_util_1.setWebGLContext;var gpgpu_context_1=require("./backends/webgl/gpgpu_context");exports.GPGPUContext=gpgpu_context_1.GPGPUContext,exports.forceHalfFloat=function(){environment_1.env().set("WEBGL_FORCE_F16_TEXTURES",!0)}},{"./backends/webgl/backend_webgl":22,"./backends/webgl/canvas_util":28,"./backends/webgl/gpgpu_context":55,"./backends/webgl/gpgpu_util":57,"./backends/webgl/webgl_util":102,"./environment":107}],217:[function(require,module,exports){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){var tmp,i,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=placeHoldersLen>0?validLen-4:validLen;for(i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,i+16383>len2?len2:i+16383));1===extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},{}],218:[function(require,module,exports){},{}],219:[function(require,module,exports){arguments[4][218][0].apply(exports,arguments)},{dup:218}],220:[function(require,module,exports){(function(Buffer){(function(){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
"use strict";var base64=require("base64-js"),ieee754=require("ieee754");exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50;function createBuffer(length){if(length>2147483647)throw new RangeError('The value "'+length+'" is invalid for option "size"');var buf=new Uint8Array(length);return buf.__proto__=Buffer.prototype,buf}function Buffer(arg,encodingOrOffset,length){if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new TypeError('The "string" argument must be of type string. Received type number');return allocUnsafe(arg)}return from(arg,encodingOrOffset,length)}function from(value,encodingOrOffset,length){if("string"==typeof value)return function(string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);var length=0|byteLength(string,encoding),buf=createBuffer(length),actual=buf.write(string,encoding);actual!==length&&(buf=buf.slice(0,actual));return buf}(value,encodingOrOffset);if(ArrayBuffer.isView(value))return fromArrayLike(value);if(null==value)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value);if(isInstance(value,ArrayBuffer)||value&&isInstance(value.buffer,ArrayBuffer))return function(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset)throw new RangeError('"offset" is outside of buffer bounds');if(array.byteLength<byteOffset+(length||0))throw new RangeError('"length" is outside of buffer bounds');var buf;buf=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);return buf.__proto__=Buffer.prototype,buf}(value,encodingOrOffset,length);if("number"==typeof value)throw new TypeError('The "value" argument must not be of type number. Received type number');var valueOf=value.valueOf&&value.valueOf();if(null!=valueOf&&valueOf!==value)return Buffer.from(valueOf,encodingOrOffset,length);var b=function(obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length),buf=createBuffer(len);return 0===buf.length||obj.copy(buf,0,0,len),buf}if(void 0!==obj.length)return"number"!=typeof obj.length||numberIsNaN(obj.length)?createBuffer(0):fromArrayLike(obj);if("Buffer"===obj.type&&Array.isArray(obj.data))return fromArrayLike(obj.data)}(value);if(b)return b;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof value[Symbol.toPrimitive])return Buffer.from(value[Symbol.toPrimitive]("string"),encodingOrOffset,length);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be of type number');if(size<0)throw new RangeError('The value "'+size+'" is invalid for option "size"')}function allocUnsafe(size){return assertSize(size),createBuffer(size<0?0:0|checked(size))}function fromArrayLike(array){for(var length=array.length<0?0:0|checked(array.length),buf=createBuffer(length),i=0;i<length;i+=1)buf[i]=255&array[i];return buf}function checked(length){if(length>=2147483647)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+2147483647..toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if(ArrayBuffer.isView(string)||isInstance(string,ArrayBuffer))return string.byteLength;if("string"!=typeof string)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof string);var len=string.length,mustMatch=arguments.length>2&&!0===arguments[2];if(!mustMatch&&0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return mustMatch?-1:utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),numberIsNaN(byteOffset=+byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length))>remaining&&(length=remaining):length=remaining;var strLen=string.length;length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)hi=(c=str.charCodeAt(i))>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&(tempCodePoint=(31&firstByte)<<6|63&secondByte)>127&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=4096)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=4096));return res}(res)}exports.kMaxLength=2147483647,Buffer.TYPED_ARRAY_SUPPORT=function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()}catch(e){return!1}}(),Buffer.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(Buffer.prototype,"parent",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.buffer}}),Object.defineProperty(Buffer.prototype,"offset",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),Buffer.poolSize=8192,Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)},Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,Buffer.alloc=function(size,fill,encoding){return function(size,fill,encoding){return assertSize(size),size<=0?createBuffer(size):void 0!==fill?"string"==typeof encoding?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill):createBuffer(size)}(size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)},Buffer.isBuffer=function(b){return null!=b&&!0===b._isBuffer&&b!==Buffer.prototype},Buffer.compare=function(a,b){if(isInstance(a,Uint8Array)&&(a=Buffer.from(a,a.offset,a.byteLength)),isInstance(b,Uint8Array)&&(b=Buffer.from(b,b.offset,b.byteLength)),!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!Array.isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(isInstance(buf,Uint8Array)&&(buf=Buffer.from(buf)),!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.toLocaleString=Buffer.prototype.toString,Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return str=this.toString("hex",0,max).replace(/(.{2})/g,"$1 ").trim(),this.length>max&&(str+=" ... "),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(isInstance(target,Uint8Array)&&(target=Buffer.from(target,target.offset,target.byteLength)),!Buffer.isBuffer(target))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof target);if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset>>>=0,isFinite(length)?(length>>>=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var len=this.length;(start=~~start)<0?(start+=len)<0&&(start=0):start>len&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):end>len&&(end=len),end<start&&(end=start);var newBuf=this.subarray(start,end);return newBuf.__proto__=Buffer.prototype,newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){(value=+value,offset>>>=0,byteLength>>>=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){(value=+value,offset>>>=0,byteLength>>>=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value,offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24,offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var len=end-start;if(this===target&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(targetStart,start,end);else if(this===target&&start<targetStart&&targetStart<end)for(var i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);if(1===val.length){var code=val.charCodeAt(0);("utf8"===encoding&&code<128||"latin1"===encoding)&&(val=code)}}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0),"number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:Buffer.from(val,encoding),len=bytes.length;if(0===len)throw new TypeError('The value "'+val+'" is invalid for argument "value"');for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if((codePoint=string.charCodeAt(i))>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=(str=str.split("=")[0]).trim().replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}function isInstance(obj,type){return obj instanceof type||null!=obj&&null!=obj.constructor&&null!=obj.constructor.name&&obj.constructor.name===type.name}function numberIsNaN(obj){return obj!=obj}}).call(this)}).call(this,require("buffer").Buffer)},{"base64-js":217,buffer:220,ieee754:395}],221:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),getModelUris_1=require("./common/getModelUris"),dom_1=require("./dom"),env_1=require("./env"),NeuralNetwork=function(){function NeuralNetwork(_name){this._name=_name,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(NeuralNetwork.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(NeuralNetwork.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(NeuralNetwork.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),NeuralNetwork.prototype.getParamFromPath=function(paramPath){var _a=this.traversePropertyPath(paramPath);return _a.obj[_a.objProp]},NeuralNetwork.prototype.reassignParamFromPath=function(paramPath,tensor){var _a=this.traversePropertyPath(paramPath),obj=_a.obj,objProp=_a.objProp;obj[objProp].dispose(),obj[objProp]=tensor},NeuralNetwork.prototype.getParamList=function(){var _this=this;return this._paramMappings.map((function(_a){var paramPath=_a.paramPath;return{path:paramPath,tensor:_this.getParamFromPath(paramPath)}}))},NeuralNetwork.prototype.getTrainableParams=function(){return this.getParamList().filter((function(param){return param.tensor instanceof tf.Variable}))},NeuralNetwork.prototype.getFrozenParams=function(){return this.getParamList().filter((function(param){return!(param.tensor instanceof tf.Variable)}))},NeuralNetwork.prototype.variable=function(){var _this=this;this.getFrozenParams().forEach((function(_a){var path=_a.path,tensor=_a.tensor;_this.reassignParamFromPath(path,tensor.variable())}))},NeuralNetwork.prototype.freeze=function(){var _this=this;this.getTrainableParams().forEach((function(_a){var path=_a.path,variable=_a.tensor,tensor=tf.tensor(variable.dataSync());variable.dispose(),_this.reassignParamFromPath(path,tensor)}))},NeuralNetwork.prototype.dispose=function(throwOnRedispose){void 0===throwOnRedispose&&(throwOnRedispose=!0),this.getParamList().forEach((function(param){if(throwOnRedispose&&param.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+param.path);param.tensor.dispose()})),this._params=void 0},NeuralNetwork.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map((function(_a){var tensor=_a.tensor;return Array.from(tensor.dataSync())})).reduce((function(flat,arr){return flat.concat(arr)})))},NeuralNetwork.prototype.load=function(weightsOrUrl){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return weightsOrUrl instanceof Float32Array?(this.extractWeights(weightsOrUrl),[2]):[4,this.loadFromUri(weightsOrUrl)];case 1:return _a.sent(),[2]}}))}))},NeuralNetwork.prototype.loadFromUri=function(uri){return tslib_1.__awaiter(this,void 0,void 0,(function(){var weightMap;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:if(uri&&"string"!=typeof uri)throw new Error(this._name+".loadFromUri - expected model uri");return[4,dom_1.loadWeightMap(uri,this.getDefaultModelName())];case 1:return weightMap=_a.sent(),this.loadFromWeightMap(weightMap),[2]}}))}))},NeuralNetwork.prototype.loadFromDisk=function(filePath){return tslib_1.__awaiter(this,void 0,void 0,(function(){var readFile,_a,manifestUri,modelBaseUri,fetchWeightsFromDisk,loadWeights,manifest,_b,_c,weightMap;return tslib_1.__generator(this,(function(_d){switch(_d.label){case 0:if(filePath&&"string"!=typeof filePath)throw new Error(this._name+".loadFromDisk - expected model file path");return readFile=env_1.env.getEnv().readFile,_a=getModelUris_1.getModelUris(filePath,this.getDefaultModelName()),manifestUri=_a.manifestUri,modelBaseUri=_a.modelBaseUri,fetchWeightsFromDisk=function(filePaths){return Promise.all(filePaths.map((function(filePath){return readFile(filePath).then((function(buf){return buf.buffer}))})))},loadWeights=tf.io.weightsLoaderFactory(fetchWeightsFromDisk),_c=(_b=JSON).parse,[4,readFile(manifestUri)];case 1:return manifest=_c.apply(_b,[_d.sent().toString()]),[4,loadWeights(manifest,modelBaseUri)];case 2:return weightMap=_d.sent(),this.loadFromWeightMap(weightMap),[2]}}))}))},NeuralNetwork.prototype.loadFromWeightMap=function(weightMap){var _a=this.extractParamsFromWeigthMap(weightMap),paramMappings=_a.paramMappings,params=_a.params;this._paramMappings=paramMappings,this._params=params},NeuralNetwork.prototype.extractWeights=function(weights){var _a=this.extractParams(weights),paramMappings=_a.paramMappings,params=_a.params;this._paramMappings=paramMappings,this._params=params},NeuralNetwork.prototype.traversePropertyPath=function(paramPath){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var result=paramPath.split("/").reduce((function(res,objProp){if(!res.nextObj.hasOwnProperty(objProp))throw new Error("traversePropertyPath - object does not have property "+objProp+", for path "+paramPath);return{obj:res.nextObj,objProp:objProp,nextObj:res.nextObj[objProp]}}),{nextObj:this.params}),obj=result.obj,objProp=result.objProp;if(!(obj&&objProp&&obj[objProp]instanceof tf.Tensor))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+paramPath);return{obj:obj,objProp:objProp}},NeuralNetwork}();exports.NeuralNetwork=NeuralNetwork},{"./common/getModelUris":251,"./dom":269,"./env":286,"@tensorflow/tfjs-core":113,tslib:406}],222:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),fullyConnectedLayer_1=require("../common/fullyConnectedLayer"),util_1=require("../faceProcessor/util"),TinyXception_1=require("../xception/TinyXception"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),types_1=require("./types"),NeuralNetwork_1=require("../NeuralNetwork"),dom_1=require("../dom"),AgeGenderNet=function(_super){function AgeGenderNet(faceFeatureExtractor){void 0===faceFeatureExtractor&&(faceFeatureExtractor=new TinyXception_1.TinyXception(2));var _this=_super.call(this,"AgeGenderNet")||this;return _this._faceFeatureExtractor=faceFeatureExtractor,_this}return tslib_1.__extends(AgeGenderNet,_super),Object.defineProperty(AgeGenderNet.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),AgeGenderNet.prototype.runNet=function(input){var _this=this,params=this.params;if(!params)throw new Error(this._name+" - load model before inference");return tf.tidy((function(){var bottleneckFeatures=input instanceof dom_1.NetInput?_this.faceFeatureExtractor.forwardInput(input):input,pooled=tf.avgPool(bottleneckFeatures,[7,7],[2,2],"valid").as2D(bottleneckFeatures.shape[0],-1);return{age:fullyConnectedLayer_1.fullyConnectedLayer(pooled,params.fc.age).as1D(),gender:fullyConnectedLayer_1.fullyConnectedLayer(pooled,params.fc.gender)}}))},AgeGenderNet.prototype.forwardInput=function(input){var _this=this;return tf.tidy((function(){var _a=_this.runNet(input),age=_a.age,gender=_a.gender;return{age:age,gender:tf.softmax(gender)}}))},AgeGenderNet.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},AgeGenderNet.prototype.predictAgeAndGender=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var netInput,out,ages,genders,ageAndGenderTensors,predictionsByBatch,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,dom_1.toNetInput(input)];case 1:return netInput=_a.sent(),[4,this.forwardInput(netInput)];case 2:return out=_a.sent(),ages=tf.unstack(out.age),genders=tf.unstack(out.gender),ageAndGenderTensors=ages.map((function(ageTensor,i){return{ageTensor:ageTensor,genderTensor:genders[i]}})),[4,Promise.all(ageAndGenderTensors.map((function(_a){var ageTensor=_a.ageTensor,genderTensor=_a.genderTensor;return tslib_1.__awaiter(_this,void 0,void 0,(function(){var age,probMale,isMale,gender,genderProbability;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return[4,ageTensor.data()];case 1:return age=_b.sent()[0],[4,genderTensor.data()];case 2:return probMale=_b.sent()[0],gender=(isMale=probMale>.5)?types_1.Gender.MALE:types_1.Gender.FEMALE,genderProbability=isMale?probMale:1-probMale,ageTensor.dispose(),genderTensor.dispose(),[2,{age:age,gender:gender,genderProbability:genderProbability}]}}))}))})))];case 3:return predictionsByBatch=_a.sent(),out.age.dispose(),out.gender.dispose(),[2,netInput.isBatchInput?predictionsByBatch:predictionsByBatch[0]]}}))}))},AgeGenderNet.prototype.getDefaultModelName=function(){return"age_gender_model"},AgeGenderNet.prototype.dispose=function(throwOnRedispose){void 0===throwOnRedispose&&(throwOnRedispose=!0),this.faceFeatureExtractor.dispose(throwOnRedispose),_super.prototype.dispose.call(this,throwOnRedispose)},AgeGenderNet.prototype.loadClassifierParams=function(weights){var _a=this.extractClassifierParams(weights),params=_a.params,paramMappings=_a.paramMappings;this._params=params,this._paramMappings=paramMappings},AgeGenderNet.prototype.extractClassifierParams=function(weights){return extractParams_1.extractParams(weights)},AgeGenderNet.prototype.extractParamsFromWeigthMap=function(weightMap){var _a=util_1.seperateWeightMaps(weightMap),featureExtractorMap=_a.featureExtractorMap,classifierMap=_a.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(featureExtractorMap),extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(classifierMap)},AgeGenderNet.prototype.extractParams=function(weights){var featureExtractorWeights=weights.slice(0,weights.length-1539),classifierWeights=weights.slice(weights.length-1539);return this.faceFeatureExtractor.extractWeights(featureExtractorWeights),this.extractClassifierParams(classifierWeights)},AgeGenderNet}(NeuralNetwork_1.NeuralNetwork);exports.AgeGenderNet=AgeGenderNet},{"../NeuralNetwork":221,"../common/fullyConnectedLayer":250,"../dom":269,"../faceProcessor/util":309,"../xception/TinyXception":392,"./extractParams":223,"./extractParamsFromWeigthMap":224,"./types":226,"@tensorflow/tfjs-core":113,tslib:406}],223:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common");exports.extractParams=function(weights){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,extractFCParams=common_1.extractFCParamsFactory(extractWeights,paramMappings),age=extractFCParams(512,1,"fc/age"),gender=extractFCParams(512,2,"fc/gender");if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{paramMappings:paramMappings,params:{fc:{age:age,gender:gender}}}}},{"../common":252}],224:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common");exports.extractParamsFromWeigthMap=function(weightMap){var paramMappings=[],extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings);function extractFcParams(prefix){return{weights:extractWeightEntry(prefix+"/weights",2),bias:extractWeightEntry(prefix+"/bias",1)}}var params={fc:{age:extractFcParams("fc/age"),gender:extractFcParams("fc/gender")}};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252}],225:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./AgeGenderNet"),exports),tslib_1.__exportStar(require("./types"),exports)},{"./AgeGenderNet":222,"./types":226,tslib:406}],226:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(Gender){Gender.FEMALE="female",Gender.MALE="male"}(exports.Gender||(exports.Gender={}))},{}],227:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),BoundingBox=function(_super){function BoundingBox(left,top,right,bottom,allowNegativeDimensions){return void 0===allowNegativeDimensions&&(allowNegativeDimensions=!1),_super.call(this,{left:left,top:top,right:right,bottom:bottom},allowNegativeDimensions)||this}return tslib_1.__extends(BoundingBox,_super),BoundingBox}(require("./Box").Box);exports.BoundingBox=BoundingBox},{"./Box":228,tslib:406}],228:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),Point_1=require("./Point"),Box=function(){function Box(_box,allowNegativeDimensions){void 0===allowNegativeDimensions&&(allowNegativeDimensions=!0);var box=_box||{},isBbox=[box.left,box.top,box.right,box.bottom].every(utils_1.isValidNumber),isRect=[box.x,box.y,box.width,box.height].every(utils_1.isValidNumber);if(!isRect&&!isBbox)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(box));var _a=isRect?[box.x,box.y,box.width,box.height]:[box.left,box.top,box.right-box.left,box.bottom-box.top],x=_a[0],y=_a[1],width=_a[2],height=_a[3];Box.assertIsValidBox({x:x,y:y,width:width,height:height},"Box.constructor",allowNegativeDimensions),this._x=x,this._y=y,this._width=width,this._height=height}return Box.isRect=function(rect){return!!rect&&[rect.x,rect.y,rect.width,rect.height].every(utils_1.isValidNumber)},Box.assertIsValidBox=function(box,callee,allowNegativeDimensions){if(void 0===allowNegativeDimensions&&(allowNegativeDimensions=!1),!Box.isRect(box))throw new Error(callee+" - invalid box: "+JSON.stringify(box)+", expected object with properties x, y, width, height");if(!allowNegativeDimensions&&(box.width<0||box.height<0))throw new Error(callee+" - width ("+box.width+") and height ("+box.height+") must be positive numbers")},Object.defineProperty(Box.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"topLeft",{get:function(){return new Point_1.Point(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"topRight",{get:function(){return new Point_1.Point(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"bottomLeft",{get:function(){return new Point_1.Point(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(Box.prototype,"bottomRight",{get:function(){return new Point_1.Point(this.right,this.bottom)},enumerable:!0,configurable:!0}),Box.prototype.round=function(){var _a=[this.x,this.y,this.width,this.height].map((function(val){return Math.round(val)}));return new Box({x:_a[0],y:_a[1],width:_a[2],height:_a[3]})},Box.prototype.floor=function(){var _a=[this.x,this.y,this.width,this.height].map((function(val){return Math.floor(val)}));return new Box({x:_a[0],y:_a[1],width:_a[2],height:_a[3]})},Box.prototype.toSquare=function(){var x=this.x,y=this.y,width=this.width,height=this.height,diff=Math.abs(width-height);return width<height&&(x-=diff/2,width+=diff),height<width&&(y-=diff/2,height+=diff),new Box({x:x,y:y,width:width,height:height})},Box.prototype.rescale=function(s){var scaleX=utils_1.isDimensions(s)?s.width:s,scaleY=utils_1.isDimensions(s)?s.height:s;return new Box({x:this.x*scaleX,y:this.y*scaleY,width:this.width*scaleX,height:this.height*scaleY})},Box.prototype.pad=function(padX,padY){var _a=[this.x-padX/2,this.y-padY/2,this.width+padX,this.height+padY];return new Box({x:_a[0],y:_a[1],width:_a[2],height:_a[3]})},Box.prototype.clipAtImageBorders=function(imgWidth,imgHeight){var x=this.x,y=this.y,right=this.right,bottom=this.bottom,clippedX=Math.max(x,0),clippedY=Math.max(y,0),newWidth=right-clippedX,newHeight=bottom-clippedY;return new Box({x:clippedX,y:clippedY,width:Math.min(newWidth,imgWidth-clippedX),height:Math.min(newHeight,imgHeight-clippedY)}).floor()},Box.prototype.shift=function(sx,sy){var width=this.width,height=this.height;return new Box({x:this.x+sx,y:this.y+sy,width:width,height:height})},Box.prototype.padAtBorders=function(imageHeight,imageWidth){var w=this.width+1,h=this.height+1,edx=w,edy=h,x=this.left,y=this.top,ex=this.right,ey=this.bottom;return ex>imageWidth&&(edx=-ex+imageWidth+w,ex=imageWidth),ey>imageHeight&&(edy=-ey+imageHeight+h,ey=imageHeight),x<1&&(edy=2-x,x=1),y<1&&(edy=2-y,y=1),{dy:1,edy:edy,dx:1,edx:edx,y:y,ey:ey,x:x,ex:ex,w:w,h:h}},Box.prototype.calibrate=function(region){return new Box({left:this.left+region.left*this.width,top:this.top+region.top*this.height,right:this.right+region.right*this.width,bottom:this.bottom+region.bottom*this.height}).toSquare().round()},Box}();exports.Box=Box},{"../utils":391,"./Point":238}],229:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),Dimensions=function(){function Dimensions(width,height){if(!utils_1.isValidNumber(width)||!utils_1.isValidNumber(height))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:width,height:height}));this._width=width,this._height=height}return Object.defineProperty(Dimensions.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(Dimensions.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Dimensions.prototype.reverse=function(){return new Dimensions(1/this.width,1/this.height)},Dimensions}();exports.Dimensions=Dimensions},{"../utils":391}],230:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),FaceDetection=function(_super){function FaceDetection(score,relativeBox,imageDims){return _super.call(this,score,score,"",relativeBox,imageDims)||this}return tslib_1.__extends(FaceDetection,_super),FaceDetection.prototype.forSize=function(width,height){var _a=_super.prototype.forSize.call(this,width,height);return new FaceDetection(_a.score,_a.relativeBox,_a.imageDims)},FaceDetection}(require("./ObjectDetection").ObjectDetection);exports.FaceDetection=FaceDetection},{"./ObjectDetection":237,tslib:406}],231:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ops_1=require("../ops"),utils_1=require("../utils"),Box_1=require("./Box"),Dimensions_1=require("./Dimensions"),FaceDetection_1=require("./FaceDetection"),Point_1=require("./Point"),Rect_1=require("./Rect"),FaceLandmarks=function(){function FaceLandmarks(relativeFaceLandmarkPositions,imgDims,shift){void 0===shift&&(shift=new Point_1.Point(0,0));var width=imgDims.width,height=imgDims.height;this._imgDims=new Dimensions_1.Dimensions(width,height),this._shift=shift,this._positions=relativeFaceLandmarkPositions.map((function(pt){return pt.mul(new Point_1.Point(width,height)).add(shift)}))}return Object.defineProperty(FaceLandmarks.prototype,"shift",{get:function(){return new Point_1.Point(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(FaceLandmarks.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(FaceLandmarks.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(FaceLandmarks.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(FaceLandmarks.prototype,"relativePositions",{get:function(){var _this=this;return this._positions.map((function(pt){return pt.sub(_this._shift).div(new Point_1.Point(_this.imageWidth,_this.imageHeight))}))},enumerable:!0,configurable:!0}),FaceLandmarks.prototype.forSize=function(width,height){return new this.constructor(this.relativePositions,{width:width,height:height})},FaceLandmarks.prototype.shiftBy=function(x,y){return new this.constructor(this.relativePositions,this._imgDims,new Point_1.Point(x,y))},FaceLandmarks.prototype.shiftByPoint=function(pt){return this.shiftBy(pt.x,pt.y)},FaceLandmarks.prototype.align=function(detection,options){if(void 0===options&&(options={}),detection){var box=detection instanceof FaceDetection_1.FaceDetection?detection.box.floor():new Box_1.Box(detection);return this.shiftBy(box.x,box.y).align(null,options)}var _a=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},options),useDlibAlignment=_a.useDlibAlignment,minBoxPadding=_a.minBoxPadding;return useDlibAlignment?this.alignDlib():this.alignMinBbox(minBoxPadding)},FaceLandmarks.prototype.alignDlib=function(){var centers=this.getRefPointsForAlignment(),leftEyeCenter=centers[0],rightEyeCenter=centers[1],mouthCenter=centers[2],distToMouth=function(pt){return mouthCenter.sub(pt).magnitude()},eyeToMouthDist=(distToMouth(leftEyeCenter)+distToMouth(rightEyeCenter))/2,size=Math.floor(eyeToMouthDist/.45),refPoint=utils_1.getCenterPoint(centers),x=Math.floor(Math.max(0,refPoint.x-.5*size)),y=Math.floor(Math.max(0,refPoint.y-.43*size));return new Rect_1.Rect(x,y,Math.min(size,this.imageWidth+x),Math.min(size,this.imageHeight+y))},FaceLandmarks.prototype.alignMinBbox=function(padding){var box=ops_1.minBbox(this.positions);return box.pad(box.width*padding,box.height*padding)},FaceLandmarks.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},FaceLandmarks}();exports.FaceLandmarks=FaceLandmarks},{"../ops":357,"../utils":391,"./Box":228,"./Dimensions":229,"./FaceDetection":230,"./Point":238,"./Rect":240}],232:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),utils_1=require("../utils"),FaceLandmarks5=function(_super){function FaceLandmarks5(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(FaceLandmarks5,_super),FaceLandmarks5.prototype.getRefPointsForAlignment=function(){var pts=this.positions;return[pts[0],pts[1],utils_1.getCenterPoint([pts[3],pts[4]])]},FaceLandmarks5}(require("./FaceLandmarks").FaceLandmarks);exports.FaceLandmarks5=FaceLandmarks5},{"../utils":391,"./FaceLandmarks":231,tslib:406}],233:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),utils_1=require("../utils"),FaceLandmarks68=function(_super){function FaceLandmarks68(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(FaceLandmarks68,_super),FaceLandmarks68.prototype.getJawOutline=function(){return this.positions.slice(0,17)},FaceLandmarks68.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},FaceLandmarks68.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},FaceLandmarks68.prototype.getNose=function(){return this.positions.slice(27,36)},FaceLandmarks68.prototype.getLeftEye=function(){return this.positions.slice(36,42)},FaceLandmarks68.prototype.getRightEye=function(){return this.positions.slice(42,48)},FaceLandmarks68.prototype.getMouth=function(){return this.positions.slice(48,68)},FaceLandmarks68.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(utils_1.getCenterPoint)},FaceLandmarks68}(require("./FaceLandmarks").FaceLandmarks);exports.FaceLandmarks68=FaceLandmarks68},{"../utils":391,"./FaceLandmarks":231,tslib:406}],234:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),FaceMatch=function(){function FaceMatch(label,distance){this._label=label,this._distance=distance}return Object.defineProperty(FaceMatch.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(FaceMatch.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),FaceMatch.prototype.toString=function(withDistance){return void 0===withDistance&&(withDistance=!0),this.label+(withDistance?" ("+utils_1.round(this.distance)+")":"")},FaceMatch}();exports.FaceMatch=FaceMatch},{"../utils":391}],235:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),utils_1=require("../utils"),Box_1=require("./Box"),LabeledBox=function(_super){function LabeledBox(box,label){var _this=_super.call(this,box)||this;return _this._label=label,_this}return tslib_1.__extends(LabeledBox,_super),LabeledBox.assertIsValidLabeledBox=function(box,callee){if(Box_1.Box.assertIsValidBox(box,callee),!utils_1.isValidNumber(box.label))throw new Error(callee+" - expected property label ("+box.label+") to be a number")},Object.defineProperty(LabeledBox.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),LabeledBox}(Box_1.Box);exports.LabeledBox=LabeledBox},{"../utils":391,"./Box":228,tslib:406}],236:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LabeledFaceDescriptors=function(){function LabeledFaceDescriptors(label,descriptors){if("string"!=typeof label)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(descriptors)||descriptors.some((function(desc){return!(desc instanceof Float32Array)})))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=label,this._descriptors=descriptors}return Object.defineProperty(LabeledFaceDescriptors.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(LabeledFaceDescriptors.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),LabeledFaceDescriptors.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map((function(d){return Array.from(d)}))}},LabeledFaceDescriptors.fromJSON=function(json){var descriptors=json.descriptors.map((function(d){return new Float32Array(d)}));return new LabeledFaceDescriptors(json.label,descriptors)},LabeledFaceDescriptors}();exports.LabeledFaceDescriptors=LabeledFaceDescriptors},{}],237:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Box_1=require("./Box"),Dimensions_1=require("./Dimensions"),ObjectDetection=function(){function ObjectDetection(score,classScore,className,relativeBox,imageDims){this._imageDims=new Dimensions_1.Dimensions(imageDims.width,imageDims.height),this._score=score,this._classScore=classScore,this._className=className,this._box=new Box_1.Box(relativeBox).rescale(this._imageDims)}return Object.defineProperty(ObjectDetection.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(ObjectDetection.prototype,"relativeBox",{get:function(){return new Box_1.Box(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),ObjectDetection.prototype.forSize=function(width,height){return new ObjectDetection(this.score,this.classScore,this.className,this.relativeBox,{width:width,height:height})},ObjectDetection}();exports.ObjectDetection=ObjectDetection},{"./Box":228,"./Dimensions":229}],238:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Point=function(){function Point(x,y){this._x=x,this._y=y}return Object.defineProperty(Point.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(Point.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Point.prototype.add=function(pt){return new Point(this.x+pt.x,this.y+pt.y)},Point.prototype.sub=function(pt){return new Point(this.x-pt.x,this.y-pt.y)},Point.prototype.mul=function(pt){return new Point(this.x*pt.x,this.y*pt.y)},Point.prototype.div=function(pt){return new Point(this.x/pt.x,this.y/pt.y)},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},Point.prototype.floor=function(){return new Point(Math.floor(this.x),Math.floor(this.y))},Point}();exports.Point=Point},{}],239:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),utils_1=require("../utils"),LabeledBox_1=require("./LabeledBox"),PredictedBox=function(_super){function PredictedBox(box,label,score,classScore){var _this=_super.call(this,box,label)||this;return _this._score=score,_this._classScore=classScore,_this}return tslib_1.__extends(PredictedBox,_super),PredictedBox.assertIsValidPredictedBox=function(box,callee){if(LabeledBox_1.LabeledBox.assertIsValidLabeledBox(box,callee),!utils_1.isValidProbablitiy(box.score)||!utils_1.isValidProbablitiy(box.classScore))throw new Error(callee+" - expected properties score ("+box.score+") and ("+box.classScore+") to be a number between [0, 1]")},Object.defineProperty(PredictedBox.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(PredictedBox.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),PredictedBox}(LabeledBox_1.LabeledBox);exports.PredictedBox=PredictedBox},{"../utils":391,"./LabeledBox":235,tslib:406}],240:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),Rect=function(_super){function Rect(x,y,width,height,allowNegativeDimensions){return void 0===allowNegativeDimensions&&(allowNegativeDimensions=!1),_super.call(this,{x:x,y:y,width:width,height:height},allowNegativeDimensions)||this}return tslib_1.__extends(Rect,_super),Rect}(require("./Box").Box);exports.Rect=Rect},{"./Box":228,tslib:406}],241:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./BoundingBox"),exports),tslib_1.__exportStar(require("./Box"),exports),tslib_1.__exportStar(require("./Dimensions"),exports),tslib_1.__exportStar(require("./FaceDetection"),exports),tslib_1.__exportStar(require("./FaceLandmarks"),exports),tslib_1.__exportStar(require("./FaceLandmarks5"),exports),tslib_1.__exportStar(require("./FaceLandmarks68"),exports),tslib_1.__exportStar(require("./FaceMatch"),exports),tslib_1.__exportStar(require("./LabeledBox"),exports),tslib_1.__exportStar(require("./LabeledFaceDescriptors"),exports),tslib_1.__exportStar(require("./ObjectDetection"),exports),tslib_1.__exportStar(require("./Point"),exports),tslib_1.__exportStar(require("./PredictedBox"),exports),tslib_1.__exportStar(require("./Rect"),exports)},{"./BoundingBox":227,"./Box":228,"./Dimensions":229,"./FaceDetection":230,"./FaceLandmarks":231,"./FaceLandmarks5":232,"./FaceLandmarks68":233,"./FaceMatch":234,"./LabeledBox":235,"./LabeledFaceDescriptors":236,"./ObjectDetection":237,"./Point":238,"./PredictedBox":239,"./Rect":240,tslib:406}],242:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.convLayer=function(x,params,padding,withRelu){return void 0===padding&&(padding="same"),void 0===withRelu&&(withRelu=!1),tf.tidy((function(){var out=tf.add(tf.conv2d(x,params.filters,[1,1],padding),params.bias);return withRelu?tf.relu(out):out}))}},{"@tensorflow/tfjs-core":113}],243:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.depthwiseSeparableConv=function(x,params,stride){return tf.tidy((function(){var out=tf.separableConv2d(x,params.depthwise_filter,params.pointwise_filter,stride,"same");return out=tf.add(out,params.bias)}))}},{"@tensorflow/tfjs-core":113}],244:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.disposeUnusedWeightTensors=function(weightMap,paramMappings){Object.keys(weightMap).forEach((function(path){paramMappings.some((function(pm){return pm.originalPath===path}))||weightMap[path].dispose()}))}},{}],245:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.extractConvParamsFactory=function(extractWeights,paramMappings){return function(channelsIn,channelsOut,filterSize,mappedPrefix){var filters=tf.tensor4d(extractWeights(channelsIn*channelsOut*filterSize*filterSize),[filterSize,filterSize,channelsIn,channelsOut]),bias=tf.tensor1d(extractWeights(channelsOut));return paramMappings.push({paramPath:mappedPrefix+"/filters"},{paramPath:mappedPrefix+"/bias"}),{filters:filters,bias:bias}}}},{"@tensorflow/tfjs-core":113}],246:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.extractFCParamsFactory=function(extractWeights,paramMappings){return function(channelsIn,channelsOut,mappedPrefix){var fc_weights=tf.tensor2d(extractWeights(channelsIn*channelsOut),[channelsIn,channelsOut]),fc_bias=tf.tensor1d(extractWeights(channelsOut));return paramMappings.push({paramPath:mappedPrefix+"/weights"},{paramPath:mappedPrefix+"/bias"}),{weights:fc_weights,bias:fc_bias}}}},{"@tensorflow/tfjs-core":113}],247:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),types_1=require("./types");exports.extractSeparableConvParamsFactory=function(extractWeights,paramMappings){return function(channelsIn,channelsOut,mappedPrefix){var depthwise_filter=tf.tensor4d(extractWeights(9*channelsIn),[3,3,channelsIn,1]),pointwise_filter=tf.tensor4d(extractWeights(channelsIn*channelsOut),[1,1,channelsIn,channelsOut]),bias=tf.tensor1d(extractWeights(channelsOut));return paramMappings.push({paramPath:mappedPrefix+"/depthwise_filter"},{paramPath:mappedPrefix+"/pointwise_filter"},{paramPath:mappedPrefix+"/bias"}),new types_1.SeparableConvParams(depthwise_filter,pointwise_filter,bias)}},exports.loadSeparableConvParamsFactory=function(extractWeightEntry){return function(prefix){var depthwise_filter=extractWeightEntry(prefix+"/depthwise_filter",4),pointwise_filter=extractWeightEntry(prefix+"/pointwise_filter",4),bias=extractWeightEntry(prefix+"/bias",1);return new types_1.SeparableConvParams(depthwise_filter,pointwise_filter,bias)}}},{"./types":254,"@tensorflow/tfjs-core":113}],248:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils");exports.extractWeightEntryFactory=function(weightMap,paramMappings){return function(originalPath,paramRank,mappedPath){var tensor=weightMap[originalPath];if(!utils_1.isTensor(tensor,paramRank))throw new Error("expected weightMap["+originalPath+"] to be a Tensor"+paramRank+"D, instead have "+tensor);return paramMappings.push({originalPath:originalPath,paramPath:mappedPath||originalPath}),tensor}}},{"../utils":391}],249:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractWeightsFactory=function(weights){var remainingWeights=weights;return{extractWeights:function(numWeights){var ret=remainingWeights.slice(0,numWeights);return remainingWeights=remainingWeights.slice(numWeights),ret},getRemainingWeights:function(){return remainingWeights}}}},{}],250:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.fullyConnectedLayer=function(x,params){return tf.tidy((function(){return tf.add(tf.matMul(x,params.weights),params.bias)}))}},{"@tensorflow/tfjs-core":113}],251:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getModelUris=function(uri,defaultModelName){var defaultManifestFilename=defaultModelName+"-weights_manifest.json";if(!uri)return{modelBaseUri:"",manifestUri:defaultManifestFilename};if("/"===uri)return{modelBaseUri:"/",manifestUri:"/"+defaultManifestFilename};var protocol=uri.startsWith("http://")?"http://":uri.startsWith("https://")?"https://":"",parts=(uri=uri.replace(protocol,"")).split("/").filter((function(s){return s})),manifestFile=uri.endsWith(".json")?parts[parts.length-1]:defaultManifestFilename,modelBaseUri=protocol+(uri.endsWith(".json")?parts.slice(0,parts.length-1):parts).join("/");return{modelBaseUri:modelBaseUri=uri.startsWith("/")?"/"+modelBaseUri:modelBaseUri,manifestUri:"/"===modelBaseUri?"/"+manifestFile:modelBaseUri+"/"+manifestFile}}},{}],252:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./convLayer"),exports),tslib_1.__exportStar(require("./depthwiseSeparableConv"),exports),tslib_1.__exportStar(require("./disposeUnusedWeightTensors"),exports),tslib_1.__exportStar(require("./extractConvParamsFactory"),exports),tslib_1.__exportStar(require("./extractFCParamsFactory"),exports),tslib_1.__exportStar(require("./extractSeparableConvParamsFactory"),exports),tslib_1.__exportStar(require("./extractWeightEntryFactory"),exports),tslib_1.__exportStar(require("./extractWeightsFactory"),exports),tslib_1.__exportStar(require("./getModelUris"),exports),tslib_1.__exportStar(require("./types"),exports)},{"./convLayer":242,"./depthwiseSeparableConv":243,"./disposeUnusedWeightTensors":244,"./extractConvParamsFactory":245,"./extractFCParamsFactory":246,"./extractSeparableConvParamsFactory":247,"./extractWeightEntryFactory":248,"./extractWeightsFactory":249,"./getModelUris":251,"./types":254,tslib:406}],253:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadConvParamsFactory=function(extractWeightEntry){return function(prefix){return{filters:extractWeightEntry(prefix+"/filters",4),bias:extractWeightEntry(prefix+"/bias",1)}}}},{}],254:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var SeparableConvParams=function(depthwise_filter,pointwise_filter,bias){this.depthwise_filter=depthwise_filter,this.pointwise_filter=pointwise_filter,this.bias=bias};exports.SeparableConvParams=SeparableConvParams},{}],255:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),env_1=require("../env"),padToSquare_1=require("../ops/padToSquare"),utils_1=require("../utils"),createCanvas_1=require("./createCanvas"),imageToSquare_1=require("./imageToSquare"),NetInput=function(){function NetInput(inputs,treatAsBatchInput){var _this=this;if(void 0===treatAsBatchInput&&(treatAsBatchInput=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(inputs))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+inputs);this._treatAsBatchInput=treatAsBatchInput,this._batchSize=inputs.length,inputs.forEach((function(input,idx){if(utils_1.isTensor3D(input))return _this._imageTensors[idx]=input,void(_this._inputDimensions[idx]=input.shape);if(utils_1.isTensor4D(input)){var batchSize=input.shape[0];if(1!==batchSize)throw new Error("NetInput - tf.Tensor4D with batchSize "+batchSize+" passed, but not supported in input array");return _this._imageTensors[idx]=input,void(_this._inputDimensions[idx]=input.shape.slice(1))}var canvas=input instanceof env_1.env.getEnv().Canvas?input:createCanvas_1.createCanvasFromMedia(input);_this._canvases[idx]=canvas,_this._inputDimensions[idx]=[canvas.height,canvas.width,3]}))}return Object.defineProperty(NetInput.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(NetInput.prototype,"reshapedInputDimensions",{get:function(){var _this=this;return utils_1.range(this.batchSize,0,1).map((function(_,batchIdx){return _this.getReshapedInputDimensions(batchIdx)}))},enumerable:!0,configurable:!0}),NetInput.prototype.getInput=function(batchIdx){return this.canvases[batchIdx]||this.imageTensors[batchIdx]},NetInput.prototype.getInputDimensions=function(batchIdx){return this._inputDimensions[batchIdx]},NetInput.prototype.getInputHeight=function(batchIdx){return this._inputDimensions[batchIdx][0]},NetInput.prototype.getInputWidth=function(batchIdx){return this._inputDimensions[batchIdx][1]},NetInput.prototype.getReshapedInputDimensions=function(batchIdx){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");var width=this.getInputWidth(batchIdx),height=this.getInputHeight(batchIdx);return utils_1.computeReshapedDimensions({width:width,height:height},this.inputSize)},NetInput.prototype.toBatchTensor=function(inputSize,isCenterInputs){var _this=this;return void 0===isCenterInputs&&(isCenterInputs=!0),this._inputSize=inputSize,tf.tidy((function(){var inputTensors=utils_1.range(_this.batchSize,0,1).map((function(batchIdx){var input=_this.getInput(batchIdx);if(input instanceof tf.Tensor){var imgTensor=utils_1.isTensor4D(input)?input:input.expandDims();return(imgTensor=padToSquare_1.padToSquare(imgTensor,isCenterInputs)).shape[1]===inputSize&&imgTensor.shape[2]===inputSize||(imgTensor=tf.image.resizeBilinear(imgTensor,[inputSize,inputSize])),imgTensor.as3D(inputSize,inputSize,3)}if(input instanceof env_1.env.getEnv().Canvas)return tf.browser.fromPixels(imageToSquare_1.imageToSquare(input,inputSize,isCenterInputs));throw new Error("toBatchTensor - at batchIdx "+batchIdx+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+input)}));return tf.stack(inputTensors.map((function(t){return t.toFloat()}))).as4D(_this.batchSize,inputSize,inputSize,3)}))},NetInput}();exports.NetInput=NetInput},{"../env":286,"../ops/padToSquare":362,"../utils":391,"./createCanvas":258,"./imageToSquare":268,"@tensorflow/tfjs-core":113}],256:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env"),isMediaLoaded_1=require("./isMediaLoaded");exports.awaitMediaLoaded=function(media){return new Promise((function(resolve,reject){if(media instanceof env_1.env.getEnv().Canvas||isMediaLoaded_1.isMediaLoaded(media))return resolve();function onLoad(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",onLoad),e.currentTarget.removeEventListener("error",onError),resolve(e))}function onError(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",onLoad),e.currentTarget.removeEventListener("error",onError),reject(e))}media.addEventListener("load",onLoad),media.addEventListener("error",onError)}))}},{"../env":286,"./isMediaLoaded":271}],257:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env");exports.bufferToImage=function(buf){return new Promise((function(resolve,reject){if(!(buf instanceof Blob))return reject("bufferToImage - expected buf to be of type: Blob");var reader=new FileReader;reader.onload=function(){if("string"!=typeof reader.result)return reject("bufferToImage - expected reader.result to be a string, in onload");var img=env_1.env.getEnv().createImageElement();img.onload=function(){return resolve(img)},img.onerror=reject,img.src=reader.result},reader.onerror=reject,reader.readAsDataURL(buf)}))}},{"../env":286}],258:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env"),getContext2dOrThrow_1=require("./getContext2dOrThrow"),getMediaDimensions_1=require("./getMediaDimensions"),isMediaLoaded_1=require("./isMediaLoaded");function createCanvas(_a){var width=_a.width,height=_a.height,canvas=(0,env_1.env.getEnv().createCanvasElement)();return canvas.width=width,canvas.height=height,canvas}exports.createCanvas=createCanvas,exports.createCanvasFromMedia=function(media,dims){var ImageData=env_1.env.getEnv().ImageData;if(!(media instanceof ImageData||isMediaLoaded_1.isMediaLoaded(media)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var _a=dims||getMediaDimensions_1.getMediaDimensions(media),width=_a.width,height=_a.height,canvas=createCanvas({width:width,height:height});return media instanceof ImageData?getContext2dOrThrow_1.getContext2dOrThrow(canvas).putImageData(media,0,0):getContext2dOrThrow_1.getContext2dOrThrow(canvas).drawImage(media,0,0,width,height),canvas}},{"../env":286,"./getContext2dOrThrow":265,"./getMediaDimensions":266,"./isMediaLoaded":271}],259:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),FaceDetection_1=require("../classes/FaceDetection"),utils_1=require("../utils");exports.extractFaceTensors=function(imageTensor,detections){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){if(!utils_1.isTensor3D(imageTensor)&&!utils_1.isTensor4D(imageTensor))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(utils_1.isTensor4D(imageTensor)&&imageTensor.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,tf.tidy((function(){var _a=imageTensor.shape.slice(utils_1.isTensor4D(imageTensor)?1:0),imgHeight=_a[0],imgWidth=_a[1],numChannels=_a[2],faceTensors=detections.map((function(det){return det instanceof FaceDetection_1.FaceDetection?det.forSize(imgWidth,imgHeight).box:det})).map((function(box){return box.clipAtImageBorders(imgWidth,imgHeight)})).map((function(_a){var x=_a.x,y=_a.y,width=_a.width,height=_a.height;return tf.slice3d(imageTensor.as3D(imgHeight,imgWidth,numChannels),[y,x,0],[height,width,numChannels])}));return faceTensors}))]}))}))}},{"../classes/FaceDetection":230,"../utils":391,"@tensorflow/tfjs-core":113,tslib:406}],260:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),FaceDetection_1=require("../classes/FaceDetection"),env_1=require("../env"),createCanvas_1=require("./createCanvas"),getContext2dOrThrow_1=require("./getContext2dOrThrow"),imageTensorToCanvas_1=require("./imageTensorToCanvas"),toNetInput_1=require("./toNetInput");exports.extractFaces=function(input,detections){return tslib_1.__awaiter(this,void 0,void 0,(function(){var Canvas,canvas,netInput,tensorOrCanvas,_a,ctx;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return Canvas=env_1.env.getEnv().Canvas,canvas=input,input instanceof Canvas?[3,5]:[4,toNetInput_1.toNetInput(input)];case 1:if((netInput=_b.sent()).batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");return(tensorOrCanvas=netInput.getInput(0))instanceof Canvas?(_a=tensorOrCanvas,[3,4]):[3,2];case 2:return[4,imageTensorToCanvas_1.imageTensorToCanvas(tensorOrCanvas)];case 3:_a=_b.sent(),_b.label=4;case 4:canvas=_a,_b.label=5;case 5:return ctx=getContext2dOrThrow_1.getContext2dOrThrow(canvas),[2,detections.map((function(det){return det instanceof FaceDetection_1.FaceDetection?det.forSize(canvas.width,canvas.height).box.floor():det})).map((function(box){return box.clipAtImageBorders(canvas.width,canvas.height)})).map((function(_a){var x=_a.x,y=_a.y,width=_a.width,height=_a.height,faceImg=createCanvas_1.createCanvas({width:width,height:height});return getContext2dOrThrow_1.getContext2dOrThrow(faceImg).putImageData(ctx.getImageData(x,y,width,height),0,0),faceImg}))]}}))}))}},{"../classes/FaceDetection":230,"../env":286,"./createCanvas":258,"./getContext2dOrThrow":265,"./imageTensorToCanvas":267,"./toNetInput":275,tslib:406}],261:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),bufferToImage_1=require("./bufferToImage"),fetchOrThrow_1=require("./fetchOrThrow");exports.fetchImage=function(uri){return tslib_1.__awaiter(this,void 0,void 0,(function(){var res,blob;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,fetchOrThrow_1.fetchOrThrow(uri)];case 1:return[4,(res=_a.sent()).blob()];case 2:if(!(blob=_a.sent()).type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+blob.type+", for url: "+res.url);return[2,bufferToImage_1.bufferToImage(blob)]}}))}))}},{"./bufferToImage":257,"./fetchOrThrow":264,tslib:406}],262:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),fetchOrThrow_1=require("./fetchOrThrow");exports.fetchJson=function(uri){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,fetchOrThrow_1.fetchOrThrow(uri)];case 1:return[2,_a.sent().json()]}}))}))}},{"./fetchOrThrow":264,tslib:406}],263:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),fetchOrThrow_1=require("./fetchOrThrow");exports.fetchNetWeights=function(uri){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=Float32Array.bind,[4,fetchOrThrow_1.fetchOrThrow(uri)];case 1:return[4,_b.sent().arrayBuffer()];case 2:return[2,new(_a.apply(Float32Array,[void 0,_b.sent()]))]}}))}))}},{"./fetchOrThrow":264,tslib:406}],264:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),env_1=require("../env");exports.fetchOrThrow=function(url,init){return tslib_1.__awaiter(this,void 0,void 0,(function(){var res;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,(0,env_1.env.getEnv().fetch)(url,init)];case 1:if(!((res=_a.sent()).status<400))throw new Error("failed to fetch: ("+res.status+") "+res.statusText+", from url: "+res.url);return[2,res]}}))}))}},{"../env":286,tslib:406}],265:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env"),resolveInput_1=require("./resolveInput");exports.getContext2dOrThrow=function(canvasArg){var _a=env_1.env.getEnv(),Canvas=_a.Canvas;if(canvasArg instanceof _a.CanvasRenderingContext2D)return canvasArg;var canvas=resolveInput_1.resolveInput(canvasArg);if(!(canvas instanceof Canvas))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var ctx=canvas.getContext("2d");if(!ctx)throw new Error("resolveContext2d - canvas 2d context is null");return ctx}},{"../env":286,"./resolveInput":274}],266:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Dimensions_1=require("../classes/Dimensions"),env_1=require("../env");exports.getMediaDimensions=function(input){var _a=env_1.env.getEnv(),Image=_a.Image,Video=_a.Video;return input instanceof Image?new Dimensions_1.Dimensions(input.naturalWidth,input.naturalHeight):input instanceof Video?new Dimensions_1.Dimensions(input.videoWidth,input.videoHeight):new Dimensions_1.Dimensions(input.width,input.height)}},{"../classes/Dimensions":229,"../env":286}],267:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),env_1=require("../env"),utils_1=require("../utils");exports.imageTensorToCanvas=function(imgTensor,canvas){return tslib_1.__awaiter(this,void 0,void 0,(function(){var targetCanvas,_a,height,width,numChannels,imgTensor3D;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return targetCanvas=canvas||env_1.env.getEnv().createCanvasElement(),_a=imgTensor.shape.slice(utils_1.isTensor4D(imgTensor)?1:0),height=_a[0],width=_a[1],numChannels=_a[2],imgTensor3D=tf.tidy((function(){return imgTensor.as3D(height,width,numChannels).toInt()})),[4,tf.browser.toPixels(imgTensor3D,targetCanvas)];case 1:return _b.sent(),imgTensor3D.dispose(),[2,targetCanvas]}}))}))}},{"../env":286,"../utils":391,"@tensorflow/tfjs-core":113,tslib:406}],268:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env"),createCanvas_1=require("./createCanvas"),getContext2dOrThrow_1=require("./getContext2dOrThrow"),getMediaDimensions_1=require("./getMediaDimensions");exports.imageToSquare=function(input,inputSize,centerImage){void 0===centerImage&&(centerImage=!1);var _a=env_1.env.getEnv(),Image=_a.Image,Canvas=_a.Canvas;if(!(input instanceof Image||input instanceof Canvas))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var dims=getMediaDimensions_1.getMediaDimensions(input),scale=inputSize/Math.max(dims.height,dims.width),width=scale*dims.width,height=scale*dims.height,targetCanvas=createCanvas_1.createCanvas({width:inputSize,height:inputSize}),inputCanvas=input instanceof Canvas?input:createCanvas_1.createCanvasFromMedia(input),offset=Math.abs(width-height)/2,dx=centerImage&&width<height?offset:0,dy=centerImage&&height<width?offset:0;return getContext2dOrThrow_1.getContext2dOrThrow(targetCanvas).drawImage(inputCanvas,dx,dy,width,height),targetCanvas}},{"../env":286,"./createCanvas":258,"./getContext2dOrThrow":265,"./getMediaDimensions":266}],269:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./awaitMediaLoaded"),exports),tslib_1.__exportStar(require("./bufferToImage"),exports),tslib_1.__exportStar(require("./createCanvas"),exports),tslib_1.__exportStar(require("./extractFaces"),exports),tslib_1.__exportStar(require("./extractFaceTensors"),exports),tslib_1.__exportStar(require("./fetchImage"),exports),tslib_1.__exportStar(require("./fetchJson"),exports),tslib_1.__exportStar(require("./fetchNetWeights"),exports),tslib_1.__exportStar(require("./fetchOrThrow"),exports),tslib_1.__exportStar(require("./getContext2dOrThrow"),exports),tslib_1.__exportStar(require("./getMediaDimensions"),exports),tslib_1.__exportStar(require("./imageTensorToCanvas"),exports),tslib_1.__exportStar(require("./imageToSquare"),exports),tslib_1.__exportStar(require("./isMediaElement"),exports),tslib_1.__exportStar(require("./isMediaLoaded"),exports),tslib_1.__exportStar(require("./loadWeightMap"),exports),tslib_1.__exportStar(require("./matchDimensions"),exports),tslib_1.__exportStar(require("./NetInput"),exports),tslib_1.__exportStar(require("./resolveInput"),exports),tslib_1.__exportStar(require("./toNetInput"),exports)},{"./NetInput":255,"./awaitMediaLoaded":256,"./bufferToImage":257,"./createCanvas":258,"./extractFaceTensors":259,"./extractFaces":260,"./fetchImage":261,"./fetchJson":262,"./fetchNetWeights":263,"./fetchOrThrow":264,"./getContext2dOrThrow":265,"./getMediaDimensions":266,"./imageTensorToCanvas":267,"./imageToSquare":268,"./isMediaElement":270,"./isMediaLoaded":271,"./loadWeightMap":272,"./matchDimensions":273,"./resolveInput":274,"./toNetInput":275,tslib:406}],270:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env");exports.isMediaElement=function(input){var _a=env_1.env.getEnv(),Image=_a.Image,Canvas=_a.Canvas,Video=_a.Video;return input instanceof Image||input instanceof Canvas||input instanceof Video}},{"../env":286}],271:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env");exports.isMediaLoaded=function(media){var _a=env_1.env.getEnv(),Image=_a.Image,Video=_a.Video;return media instanceof Image&&media.complete||media instanceof Video&&media.readyState>=3}},{"../env":286}],272:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),getModelUris_1=require("../common/getModelUris"),fetchJson_1=require("./fetchJson");exports.loadWeightMap=function(uri,defaultModelName){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a,manifestUri,modelBaseUri,manifest;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=getModelUris_1.getModelUris(uri,defaultModelName),manifestUri=_a.manifestUri,modelBaseUri=_a.modelBaseUri,[4,fetchJson_1.fetchJson(manifestUri)];case 1:return manifest=_b.sent(),[2,tf.io.loadWeights(manifest,modelBaseUri)]}}))}))}},{"../common/getModelUris":251,"./fetchJson":262,"@tensorflow/tfjs-core":113,tslib:406}],273:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var getMediaDimensions_1=require("./getMediaDimensions");exports.matchDimensions=function(input,reference,useMediaDimensions){void 0===useMediaDimensions&&(useMediaDimensions=!1);var _a=useMediaDimensions?getMediaDimensions_1.getMediaDimensions(reference):reference,width=_a.width,height=_a.height;return input.width=width,input.height=height,{width:width,height:height}}},{"./getMediaDimensions":266}],274:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var env_1=require("../env");exports.resolveInput=function(arg){return env_1.env.isNodejs()||"string"!=typeof arg?arg:document.getElementById(arg)}},{"../env":286}],275:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),utils_1=require("../utils"),awaitMediaLoaded_1=require("./awaitMediaLoaded"),isMediaElement_1=require("./isMediaElement"),NetInput_1=require("./NetInput"),resolveInput_1=require("./resolveInput");exports.toNetInput=function(inputs){return tslib_1.__awaiter(this,void 0,void 0,(function(){var inputArgArray,getIdxHint,inputArray;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:if(inputs instanceof NetInput_1.NetInput)return[2,inputs];if(!(inputArgArray=Array.isArray(inputs)?inputs:[inputs]).length)throw new Error("toNetInput - empty array passed as input");return getIdxHint=function(idx){return Array.isArray(inputs)?" at input index "+idx+":":""},(inputArray=inputArgArray.map(resolveInput_1.resolveInput)).forEach((function(input,i){if(!isMediaElement_1.isMediaElement(input)&&!utils_1.isTensor3D(input)&&!utils_1.isTensor4D(input)){if("string"==typeof inputArgArray[i])throw new Error("toNetInput -"+getIdxHint(i)+" string passed, but could not resolve HTMLElement for element id "+inputArgArray[i]);throw new Error("toNetInput -"+getIdxHint(i)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(utils_1.isTensor4D(input)){var batchSize=input.shape[0];if(1!==batchSize)throw new Error("toNetInput -"+getIdxHint(i)+" tf.Tensor4D with batchSize "+batchSize+" passed, but not supported in input array")}})),[4,Promise.all(inputArray.map((function(input){return isMediaElement_1.isMediaElement(input)&&awaitMediaLoaded_1.awaitMediaLoaded(input)})))];case 1:return _a.sent(),[2,new NetInput_1.NetInput(inputArray,Array.isArray(inputs))]}}))}))}},{"../utils":391,"./NetInput":255,"./awaitMediaLoaded":256,"./isMediaElement":270,"./resolveInput":274,tslib:406}],276:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes"),getContext2dOrThrow_1=require("../dom/getContext2dOrThrow"),DrawTextField_1=require("./DrawTextField"),DrawBoxOptions=function(options){void 0===options&&(options={});var boxColor=options.boxColor,lineWidth=options.lineWidth,label=options.label,drawLabelOptions=options.drawLabelOptions;this.boxColor=boxColor||"rgba(0, 0, 255, 1)",this.lineWidth=lineWidth||2,this.label=label;var defaultDrawLabelOptions={anchorPosition:DrawTextField_1.AnchorPosition.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new DrawTextField_1.DrawTextFieldOptions(Object.assign({},defaultDrawLabelOptions,drawLabelOptions))};exports.DrawBoxOptions=DrawBoxOptions;var DrawBox=function(){function DrawBox(box,options){void 0===options&&(options={}),this.box=new classes_1.Box(box),this.options=new DrawBoxOptions(options)}return DrawBox.prototype.draw=function(canvasArg){var ctx=getContext2dOrThrow_1.getContext2dOrThrow(canvasArg),_a=this.options,boxColor=_a.boxColor,lineWidth=_a.lineWidth,_b=this.box,x=_b.x,y=_b.y,width=_b.width,height=_b.height;ctx.strokeStyle=boxColor,ctx.lineWidth=lineWidth,ctx.strokeRect(x,y,width,height);var label=this.options.label;label&&new DrawTextField_1.DrawTextField([label],{x:x-lineWidth/2,y:y},this.options.drawLabelOptions).draw(canvasArg)},DrawBox}();exports.DrawBox=DrawBox},{"../classes":241,"../dom/getContext2dOrThrow":265,"./DrawTextField":278}],277:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FaceLandmarks_1=require("../classes/FaceLandmarks"),FaceLandmarks68_1=require("../classes/FaceLandmarks68"),getContext2dOrThrow_1=require("../dom/getContext2dOrThrow"),WithFaceLandmarks_1=require("../factories/WithFaceLandmarks"),drawContour_1=require("./drawContour"),DrawFaceLandmarksOptions=function(options){void 0===options&&(options={});var _a=options.drawLines,drawLines=void 0===_a||_a,_b=options.drawPoints,drawPoints=void 0===_b||_b,lineWidth=options.lineWidth,lineColor=options.lineColor,pointSize=options.pointSize,pointColor=options.pointColor;this.drawLines=drawLines,this.drawPoints=drawPoints,this.lineWidth=lineWidth||1,this.pointSize=pointSize||2,this.lineColor=lineColor||"rgba(0, 255, 255, 1)",this.pointColor=pointColor||"rgba(255, 0, 255, 1)"};exports.DrawFaceLandmarksOptions=DrawFaceLandmarksOptions;var DrawFaceLandmarks=function(){function DrawFaceLandmarks(faceLandmarks,options){void 0===options&&(options={}),this.faceLandmarks=faceLandmarks,this.options=new DrawFaceLandmarksOptions(options)}return DrawFaceLandmarks.prototype.draw=function(canvasArg){var ctx=getContext2dOrThrow_1.getContext2dOrThrow(canvasArg),_a=this.options,drawLines=_a.drawLines,drawPoints=_a.drawPoints,lineWidth=_a.lineWidth,lineColor=_a.lineColor,pointSize=_a.pointSize,pointColor=_a.pointColor;if(drawLines&&this.faceLandmarks instanceof FaceLandmarks68_1.FaceLandmarks68&&(ctx.strokeStyle=lineColor,ctx.lineWidth=lineWidth,drawContour_1.drawContour(ctx,this.faceLandmarks.getJawOutline()),drawContour_1.drawContour(ctx,this.faceLandmarks.getLeftEyeBrow()),drawContour_1.drawContour(ctx,this.faceLandmarks.getRightEyeBrow()),drawContour_1.drawContour(ctx,this.faceLandmarks.getNose()),drawContour_1.drawContour(ctx,this.faceLandmarks.getLeftEye(),!0),drawContour_1.drawContour(ctx,this.faceLandmarks.getRightEye(),!0),drawContour_1.drawContour(ctx,this.faceLandmarks.getMouth(),!0)),drawPoints){ctx.strokeStyle=pointColor,ctx.fillStyle=pointColor;this.faceLandmarks.positions.forEach((function(pt){ctx.beginPath(),ctx.arc(pt.x,pt.y,pointSize,0,2*Math.PI),ctx.fill()}))}},DrawFaceLandmarks}();exports.DrawFaceLandmarks=DrawFaceLandmarks,exports.drawFaceLandmarks=function(canvasArg,faceLandmarks){(Array.isArray(faceLandmarks)?faceLandmarks:[faceLandmarks]).forEach((function(f){var landmarks=f instanceof FaceLandmarks_1.FaceLandmarks?f:WithFaceLandmarks_1.isWithFaceLandmarks(f)?f.landmarks:void 0;if(!landmarks)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new DrawFaceLandmarks(landmarks).draw(canvasArg)}))}},{"../classes/FaceLandmarks":231,"../classes/FaceLandmarks68":233,"../dom/getContext2dOrThrow":265,"../factories/WithFaceLandmarks":321,"./drawContour":279}],278:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var AnchorPosition,getContext2dOrThrow_1=require("../dom/getContext2dOrThrow"),resolveInput_1=require("../dom/resolveInput");!function(AnchorPosition){AnchorPosition.TOP_LEFT="TOP_LEFT",AnchorPosition.TOP_RIGHT="TOP_RIGHT",AnchorPosition.BOTTOM_LEFT="BOTTOM_LEFT",AnchorPosition.BOTTOM_RIGHT="BOTTOM_RIGHT"}(AnchorPosition=exports.AnchorPosition||(exports.AnchorPosition={}));var DrawTextFieldOptions=function(options){void 0===options&&(options={});var anchorPosition=options.anchorPosition,backgroundColor=options.backgroundColor,fontColor=options.fontColor,fontSize=options.fontSize,fontStyle=options.fontStyle,padding=options.padding;this.anchorPosition=anchorPosition||AnchorPosition.TOP_LEFT,this.backgroundColor=backgroundColor||"rgba(0, 0, 0, 0.5)",this.fontColor=fontColor||"rgba(255, 255, 255, 1)",this.fontSize=fontSize||14,this.fontStyle=fontStyle||"Georgia",this.padding=padding||4};exports.DrawTextFieldOptions=DrawTextFieldOptions;var DrawTextField=function(){function DrawTextField(text,anchor,options){void 0===options&&(options={}),this.text="string"==typeof text?[text]:text instanceof DrawTextField?text.text:text,this.anchor=anchor,this.options=new DrawTextFieldOptions(options)}return DrawTextField.prototype.measureWidth=function(ctx){var padding=this.options.padding;return this.text.map((function(l){return ctx.measureText(l).width})).reduce((function(w0,w1){return w0<w1?w1:w0}),0)+2*padding},DrawTextField.prototype.measureHeight=function(){var _a=this.options,fontSize=_a.fontSize,padding=_a.padding;return this.text.length*fontSize+2*padding},DrawTextField.prototype.getUpperLeft=function(ctx,canvasDims){var anchorPosition=this.options.anchorPosition,isShiftLeft=anchorPosition===AnchorPosition.BOTTOM_RIGHT||anchorPosition===AnchorPosition.TOP_RIGHT,isShiftTop=anchorPosition===AnchorPosition.BOTTOM_LEFT||anchorPosition===AnchorPosition.BOTTOM_RIGHT,textFieldWidth=this.measureWidth(ctx),textFieldHeight=this.measureHeight(),x=isShiftLeft?this.anchor.x-textFieldWidth:this.anchor.x,y=isShiftTop?this.anchor.y-textFieldHeight:this.anchor.y;if(canvasDims){var width=canvasDims.width,height=canvasDims.height;return{x:Math.max(Math.min(x,width-textFieldWidth),0),y:Math.max(Math.min(y,height-textFieldHeight),0)}}return{x:x,y:y}},DrawTextField.prototype.draw=function(canvasArg){var canvas=resolveInput_1.resolveInput(canvasArg),ctx=getContext2dOrThrow_1.getContext2dOrThrow(canvas),_a=this.options,backgroundColor=_a.backgroundColor,fontColor=_a.fontColor,fontSize=_a.fontSize,fontStyle=_a.fontStyle,padding=_a.padding;ctx.font=fontSize+"px "+fontStyle;var maxTextWidth=this.measureWidth(ctx),textHeight=this.measureHeight();ctx.fillStyle=backgroundColor;var upperLeft=this.getUpperLeft(ctx,canvas);ctx.fillRect(upperLeft.x,upperLeft.y,maxTextWidth,textHeight),ctx.fillStyle=fontColor,this.text.forEach((function(textLine,i){var x=padding+upperLeft.x,y=padding+upperLeft.y+(i+1)*fontSize;ctx.fillText(textLine,x,y)}))},DrawTextField}();exports.DrawTextField=DrawTextField},{"../dom/getContext2dOrThrow":265,"../dom/resolveInput":274}],279:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.drawContour=function(ctx,points,isClosed){if(void 0===isClosed&&(isClosed=!1),ctx.beginPath(),points.slice(1).forEach((function(_a,prevIdx){var x=_a.x,y=_a.y,from=points[prevIdx];ctx.moveTo(from.x,from.y),ctx.lineTo(x,y)})),isClosed){var from=points[points.length-1],to=points[0];if(!from||!to)return;ctx.moveTo(from.x,from.y),ctx.lineTo(to.x,to.y)}ctx.stroke()}},{}],280:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes"),FaceDetection_1=require("../classes/FaceDetection"),WithFaceDetection_1=require("../factories/WithFaceDetection"),utils_1=require("../utils"),DrawBox_1=require("./DrawBox");exports.drawDetections=function(canvasArg,detections){(Array.isArray(detections)?detections:[detections]).forEach((function(det){var score=det instanceof FaceDetection_1.FaceDetection?det.score:WithFaceDetection_1.isWithFaceDetection(det)?det.detection.score:void 0,box=det instanceof FaceDetection_1.FaceDetection?det.box:WithFaceDetection_1.isWithFaceDetection(det)?det.detection.box:new classes_1.Box(det),label=score?""+utils_1.round(score):void 0;new DrawBox_1.DrawBox(box,{label:label}).draw(canvasArg)}))}},{"../classes":241,"../classes/FaceDetection":230,"../factories/WithFaceDetection":319,"../utils":391,"./DrawBox":276}],281:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes"),faceExpressionNet_1=require("../faceExpressionNet"),WithFaceDetection_1=require("../factories/WithFaceDetection"),WithFaceExpressions_1=require("../factories/WithFaceExpressions"),utils_1=require("../utils"),DrawTextField_1=require("./DrawTextField");exports.drawFaceExpressions=function(canvasArg,faceExpressions,minConfidence,textFieldAnchor){void 0===minConfidence&&(minConfidence=.1),(Array.isArray(faceExpressions)?faceExpressions:[faceExpressions]).forEach((function(e){var expr=e instanceof faceExpressionNet_1.FaceExpressions?e:WithFaceExpressions_1.isWithFaceExpressions(e)?e.expressions:void 0;if(!expr)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var resultsToDisplay=expr.asSortedArray().filter((function(expr){return expr.probability>minConfidence})),anchor=WithFaceDetection_1.isWithFaceDetection(e)?e.detection.box.bottomLeft:textFieldAnchor||new classes_1.Point(0,0),drawTextField=new DrawTextField_1.DrawTextField(resultsToDisplay.map((function(expr){return expr.expression+" ("+utils_1.round(expr.probability)+")"})),anchor);drawTextField.draw(canvasArg)}))}},{"../classes":241,"../faceExpressionNet":292,"../factories/WithFaceDetection":319,"../factories/WithFaceExpressions":320,"../utils":391,"./DrawTextField":278}],282:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./drawContour"),exports),tslib_1.__exportStar(require("./drawDetections"),exports),tslib_1.__exportStar(require("./drawFaceExpressions"),exports),tslib_1.__exportStar(require("./DrawBox"),exports),tslib_1.__exportStar(require("./DrawFaceLandmarks"),exports),tslib_1.__exportStar(require("./DrawTextField"),exports)},{"./DrawBox":276,"./DrawFaceLandmarks":277,"./DrawTextField":278,"./drawContour":279,"./drawDetections":280,"./drawFaceExpressions":281,tslib:406}],283:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createBrowserEnv=function(){var fetch=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D:CanvasRenderingContext2D,Image:HTMLImageElement,ImageData:ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:fetch,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}},{}],284:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFileSystem=function(fs){var requireFsError="";if(!fs)try{fs=require("fs")}catch(err){requireFsError=err.toString()}return{readFile:fs?function(filePath){return new Promise((function(res,rej){fs.readFile(filePath,(function(err,buffer){return err?rej(err):res(buffer)}))}))}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+requireFsError)}}}},{fs:219}],285:[function(require,module,exports){(function(global){(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),createFileSystem_1=require("./createFileSystem");exports.createNodejsEnv=function(){var Canvas=global.Canvas||global.HTMLCanvasElement,Image=global.Image||global.HTMLImageElement,fetch=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},fileSystem=createFileSystem_1.createFileSystem();return tslib_1.__assign({Canvas:Canvas||function(){},CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){},Image:Image||function(){},ImageData:global.ImageData||function(){},Video:global.HTMLVideoElement||function(){},createCanvasElement:function(){if(Canvas)return new Canvas;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(Image)return new Image;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:fetch},fileSystem)}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./createFileSystem":284,tslib:406}],286:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment,createBrowserEnv_1=require("./createBrowserEnv"),createFileSystem_1=require("./createFileSystem"),createNodejsEnv_1=require("./createNodejsEnv"),isBrowser_1=require("./isBrowser"),isNodejs_1=require("./isNodejs");function setEnv(env){environment=env}function initialize(){isBrowser_1.isBrowser()&&setEnv(createBrowserEnv_1.createBrowserEnv()),isNodejs_1.isNodejs()&&setEnv(createNodejsEnv_1.createNodejsEnv())}exports.env={getEnv:function(){if(!environment)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return environment},setEnv:setEnv,initialize:initialize,createBrowserEnv:createBrowserEnv_1.createBrowserEnv,createFileSystem:createFileSystem_1.createFileSystem,createNodejsEnv:createNodejsEnv_1.createNodejsEnv,monkeyPatch:function(env){if(environment||initialize(),!environment)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var _a=env.Canvas,Canvas=void 0===_a?environment.Canvas:_a,_b=env.Image,Image=void 0===_b?environment.Image:_b;environment.Canvas=Canvas,environment.Image=Image,environment.createCanvasElement=env.createCanvasElement||function(){return new Canvas},environment.createImageElement=env.createImageElement||function(){return new Image},environment.ImageData=env.ImageData||environment.ImageData,environment.Video=env.Video||environment.Video,environment.fetch=env.fetch||environment.fetch,environment.readFile=env.readFile||environment.readFile},isBrowser:isBrowser_1.isBrowser,isNodejs:isNodejs_1.isNodejs},initialize()},{"./createBrowserEnv":283,"./createFileSystem":284,"./createNodejsEnv":285,"./isBrowser":287,"./isNodejs":288}],287:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isBrowser=function(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}},{}],288:[function(require,module,exports){(function(process,global){(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isNodejs=function(){return"object"==typeof global&&"function"==typeof require&&void 0!==module&&void 0!==process&&!!process.version}}).call(this)}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:396}],289:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.euclideanDistance=function(arr1,arr2){if(arr1.length!==arr2.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var desc1=Array.from(arr1),desc2=Array.from(arr2);return Math.sqrt(desc1.map((function(val,i){return val-desc2[i]})).reduce((function(res,diff){return res+Math.pow(diff,2)}),0))}},{}],290:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),FaceFeatureExtractor_1=require("../faceFeatureExtractor/FaceFeatureExtractor"),FaceProcessor_1=require("../faceProcessor/FaceProcessor"),FaceExpressions_1=require("./FaceExpressions"),FaceExpressionNet=function(_super){function FaceExpressionNet(faceFeatureExtractor){return void 0===faceFeatureExtractor&&(faceFeatureExtractor=new FaceFeatureExtractor_1.FaceFeatureExtractor),_super.call(this,"FaceExpressionNet",faceFeatureExtractor)||this}return tslib_1.__extends(FaceExpressionNet,_super),FaceExpressionNet.prototype.forwardInput=function(input){var _this=this;return tf.tidy((function(){return tf.softmax(_this.runNet(input))}))},FaceExpressionNet.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},FaceExpressionNet.prototype.predictExpressions=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var netInput,out,probabilitesByBatch,predictionsByBatch,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,dom_1.toNetInput(input)];case 1:return netInput=_a.sent(),[4,this.forwardInput(netInput)];case 2:return out=_a.sent(),[4,Promise.all(tf.unstack(out).map((function(t){return tslib_1.__awaiter(_this,void 0,void 0,(function(){var data;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,t.data()];case 1:return data=_a.sent(),t.dispose(),[2,data]}}))}))})))];case 3:return probabilitesByBatch=_a.sent(),out.dispose(),predictionsByBatch=probabilitesByBatch.map((function(probabilites){return new FaceExpressions_1.FaceExpressions(probabilites)})),[2,netInput.isBatchInput?predictionsByBatch:predictionsByBatch[0]]}}))}))},FaceExpressionNet.prototype.getDefaultModelName=function(){return"face_expression_model"},FaceExpressionNet.prototype.getClassifierChannelsIn=function(){return 256},FaceExpressionNet.prototype.getClassifierChannelsOut=function(){return 7},FaceExpressionNet}(FaceProcessor_1.FaceProcessor);exports.FaceExpressionNet=FaceExpressionNet},{"../dom":269,"../faceFeatureExtractor/FaceFeatureExtractor":293,"../faceProcessor/FaceProcessor":306,"./FaceExpressions":291,"@tensorflow/tfjs-core":113,tslib:406}],291:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FACE_EXPRESSION_LABELS=["neutral","happy","sad","angry","fearful","disgusted","surprised"];var FaceExpressions=function(){function FaceExpressions(probabilities){var _this=this;if(7!==probabilities.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+probabilities.length);exports.FACE_EXPRESSION_LABELS.forEach((function(expression,idx){_this[expression]=probabilities[idx]}))}return FaceExpressions.prototype.asSortedArray=function(){var _this=this;return exports.FACE_EXPRESSION_LABELS.map((function(expression){return{expression:expression,probability:_this[expression]}})).sort((function(e0,e1){return e1.probability-e0.probability}))},FaceExpressions}();exports.FaceExpressions=FaceExpressions},{}],292:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./FaceExpressionNet"),exports),tslib_1.__exportStar(require("./FaceExpressions"),exports)},{"./FaceExpressionNet":290,"./FaceExpressions":291,tslib:406}],293:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),ops_1=require("../ops"),denseBlock_1=require("./denseBlock"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),FaceFeatureExtractor=function(_super){function FaceFeatureExtractor(){return _super.call(this,"FaceFeatureExtractor")||this}return tslib_1.__extends(FaceFeatureExtractor,_super),FaceFeatureExtractor.prototype.forwardInput=function(input){var params=this.params;if(!params)throw new Error("FaceFeatureExtractor - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(112,!0),normalized=ops_1.normalize(batchTensor,[122.782,117.001,104.298]).div(tf.scalar(255)),out=denseBlock_1.denseBlock4(normalized,params.dense0,!0);return out=denseBlock_1.denseBlock4(out,params.dense1),out=denseBlock_1.denseBlock4(out,params.dense2),out=denseBlock_1.denseBlock4(out,params.dense3),out=tf.avgPool(out,[7,7],[2,2],"valid")}))},FaceFeatureExtractor.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},FaceFeatureExtractor.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},FaceFeatureExtractor.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap)},FaceFeatureExtractor.prototype.extractParams=function(weights){return extractParams_1.extractParams(weights)},FaceFeatureExtractor}(NeuralNetwork_1.NeuralNetwork);exports.FaceFeatureExtractor=FaceFeatureExtractor},{"../NeuralNetwork":221,"../dom":269,"../ops":357,"./denseBlock":295,"./extractParams":296,"./extractParamsFromWeigthMap":297,"@tensorflow/tfjs-core":113,tslib:406}],294:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),ops_1=require("../ops"),denseBlock_1=require("./denseBlock"),extractParamsFromWeigthMapTiny_1=require("./extractParamsFromWeigthMapTiny"),extractParamsTiny_1=require("./extractParamsTiny"),TinyFaceFeatureExtractor=function(_super){function TinyFaceFeatureExtractor(){return _super.call(this,"TinyFaceFeatureExtractor")||this}return tslib_1.__extends(TinyFaceFeatureExtractor,_super),TinyFaceFeatureExtractor.prototype.forwardInput=function(input){var params=this.params;if(!params)throw new Error("TinyFaceFeatureExtractor - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(112,!0),normalized=ops_1.normalize(batchTensor,[122.782,117.001,104.298]).div(tf.scalar(255)),out=denseBlock_1.denseBlock3(normalized,params.dense0,!0);return out=denseBlock_1.denseBlock3(out,params.dense1),out=denseBlock_1.denseBlock3(out,params.dense2),out=tf.avgPool(out,[14,14],[2,2],"valid")}))},TinyFaceFeatureExtractor.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},TinyFaceFeatureExtractor.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},TinyFaceFeatureExtractor.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMapTiny_1.extractParamsFromWeigthMapTiny(weightMap)},TinyFaceFeatureExtractor.prototype.extractParams=function(weights){return extractParamsTiny_1.extractParamsTiny(weights)},TinyFaceFeatureExtractor}(NeuralNetwork_1.NeuralNetwork);exports.TinyFaceFeatureExtractor=TinyFaceFeatureExtractor},{"../NeuralNetwork":221,"../dom":269,"../ops":357,"./denseBlock":295,"./extractParamsFromWeigthMapTiny":298,"./extractParamsTiny":299,"@tensorflow/tfjs-core":113,tslib:406}],295:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),depthwiseSeparableConv_1=require("../common/depthwiseSeparableConv");exports.denseBlock3=function(x,denseBlockParams,isFirstLayer){return void 0===isFirstLayer&&(isFirstLayer=!1),tf.tidy((function(){var out1=tf.relu(isFirstLayer?tf.add(tf.conv2d(x,denseBlockParams.conv0.filters,[2,2],"same"),denseBlockParams.conv0.bias):depthwiseSeparableConv_1.depthwiseSeparableConv(x,denseBlockParams.conv0,[2,2])),out2=depthwiseSeparableConv_1.depthwiseSeparableConv(out1,denseBlockParams.conv1,[1,1]),in3=tf.relu(tf.add(out1,out2)),out3=depthwiseSeparableConv_1.depthwiseSeparableConv(in3,denseBlockParams.conv2,[1,1]);return tf.relu(tf.add(out1,tf.add(out2,out3)))}))},exports.denseBlock4=function(x,denseBlockParams,isFirstLayer,isScaleDown){return void 0===isFirstLayer&&(isFirstLayer=!1),void 0===isScaleDown&&(isScaleDown=!0),tf.tidy((function(){var out1=tf.relu(isFirstLayer?tf.add(tf.conv2d(x,denseBlockParams.conv0.filters,isScaleDown?[2,2]:[1,1],"same"),denseBlockParams.conv0.bias):depthwiseSeparableConv_1.depthwiseSeparableConv(x,denseBlockParams.conv0,isScaleDown?[2,2]:[1,1])),out2=depthwiseSeparableConv_1.depthwiseSeparableConv(out1,denseBlockParams.conv1,[1,1]),in3=tf.relu(tf.add(out1,out2)),out3=depthwiseSeparableConv_1.depthwiseSeparableConv(in3,denseBlockParams.conv2,[1,1]),in4=tf.relu(tf.add(out1,tf.add(out2,out3))),out4=depthwiseSeparableConv_1.depthwiseSeparableConv(in4,denseBlockParams.conv3,[1,1]);return tf.relu(tf.add(out1,tf.add(out2,tf.add(out3,out4))))}))}},{"../common/depthwiseSeparableConv":243,"@tensorflow/tfjs-core":113}],296:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),extractorsFactory_1=require("./extractorsFactory");exports.extractParams=function(weights){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,extractDenseBlock4Params=extractorsFactory_1.extractorsFactory(extractWeights,paramMappings).extractDenseBlock4Params,dense0=extractDenseBlock4Params(3,32,"dense0",!0),dense1=extractDenseBlock4Params(32,64,"dense1"),dense2=extractDenseBlock4Params(64,128,"dense2"),dense3=extractDenseBlock4Params(128,256,"dense3");if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{paramMappings:paramMappings,params:{dense0:dense0,dense1:dense1,dense2:dense2,dense3:dense3}}}},{"../common":252,"./extractorsFactory":300}],297:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),loadParamsFactory_1=require("./loadParamsFactory");exports.extractParamsFromWeigthMap=function(weightMap){var paramMappings=[],extractDenseBlock4Params=loadParamsFactory_1.loadParamsFactory(weightMap,paramMappings).extractDenseBlock4Params,params={dense0:extractDenseBlock4Params("dense0",!0),dense1:extractDenseBlock4Params("dense1"),dense2:extractDenseBlock4Params("dense2"),dense3:extractDenseBlock4Params("dense3")};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252,"./loadParamsFactory":301}],298:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),loadParamsFactory_1=require("./loadParamsFactory");exports.extractParamsFromWeigthMapTiny=function(weightMap){var paramMappings=[],extractDenseBlock3Params=loadParamsFactory_1.loadParamsFactory(weightMap,paramMappings).extractDenseBlock3Params,params={dense0:extractDenseBlock3Params("dense0",!0),dense1:extractDenseBlock3Params("dense1"),dense2:extractDenseBlock3Params("dense2")};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252,"./loadParamsFactory":301}],299:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),extractorsFactory_1=require("./extractorsFactory");exports.extractParamsTiny=function(weights){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,extractDenseBlock3Params=extractorsFactory_1.extractorsFactory(extractWeights,paramMappings).extractDenseBlock3Params,dense0=extractDenseBlock3Params(3,32,"dense0",!0),dense1=extractDenseBlock3Params(32,64,"dense1"),dense2=extractDenseBlock3Params(64,128,"dense2");if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{paramMappings:paramMappings,params:{dense0:dense0,dense1:dense1,dense2:dense2}}}},{"../common":252,"./extractorsFactory":300}],300:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common");exports.extractorsFactory=function(extractWeights,paramMappings){var extractConvParams=common_1.extractConvParamsFactory(extractWeights,paramMappings),extractSeparableConvParams=common_1.extractSeparableConvParamsFactory(extractWeights,paramMappings);function extractDenseBlock3Params(channelsIn,channelsOut,mappedPrefix,isFirstLayer){return void 0===isFirstLayer&&(isFirstLayer=!1),{conv0:isFirstLayer?extractConvParams(channelsIn,channelsOut,3,mappedPrefix+"/conv0"):extractSeparableConvParams(channelsIn,channelsOut,mappedPrefix+"/conv0"),conv1:extractSeparableConvParams(channelsOut,channelsOut,mappedPrefix+"/conv1"),conv2:extractSeparableConvParams(channelsOut,channelsOut,mappedPrefix+"/conv2")}}return{extractDenseBlock3Params:extractDenseBlock3Params,extractDenseBlock4Params:function(channelsIn,channelsOut,mappedPrefix,isFirstLayer){void 0===isFirstLayer&&(isFirstLayer=!1);var _a=extractDenseBlock3Params(channelsIn,channelsOut,mappedPrefix,isFirstLayer);return{conv0:_a.conv0,conv1:_a.conv1,conv2:_a.conv2,conv3:extractSeparableConvParams(channelsOut,channelsOut,mappedPrefix+"/conv3")}}}}},{"../common":252}],301:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),loadConvParamsFactory_1=require("../common/loadConvParamsFactory");exports.loadParamsFactory=function(weightMap,paramMappings){var extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings),extractConvParams=loadConvParamsFactory_1.loadConvParamsFactory(extractWeightEntry),extractSeparableConvParams=common_1.loadSeparableConvParamsFactory(extractWeightEntry);return{extractDenseBlock3Params:function(prefix,isFirstLayer){return void 0===isFirstLayer&&(isFirstLayer=!1),{conv0:isFirstLayer?extractConvParams(prefix+"/conv0"):extractSeparableConvParams(prefix+"/conv0"),conv1:extractSeparableConvParams(prefix+"/conv1"),conv2:extractSeparableConvParams(prefix+"/conv2")}},extractDenseBlock4Params:function(prefix,isFirstLayer){return void 0===isFirstLayer&&(isFirstLayer=!1),{conv0:isFirstLayer?extractConvParams(prefix+"/conv0"):extractSeparableConvParams(prefix+"/conv0"),conv1:extractSeparableConvParams(prefix+"/conv1"),conv2:extractSeparableConvParams(prefix+"/conv2"),conv3:extractSeparableConvParams(prefix+"/conv3")}}}}},{"../common":252,"../common/loadConvParamsFactory":253}],302:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),FaceFeatureExtractor_1=require("../faceFeatureExtractor/FaceFeatureExtractor"),FaceLandmark68Net=function(_super){function FaceLandmark68Net(faceFeatureExtractor){return void 0===faceFeatureExtractor&&(faceFeatureExtractor=new FaceFeatureExtractor_1.FaceFeatureExtractor),_super.call(this,"FaceLandmark68Net",faceFeatureExtractor)||this}return tslib_1.__extends(FaceLandmark68Net,_super),FaceLandmark68Net.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},FaceLandmark68Net.prototype.getClassifierChannelsIn=function(){return 256},FaceLandmark68Net}(require("./FaceLandmark68NetBase").FaceLandmark68NetBase);exports.FaceLandmark68Net=FaceLandmark68Net},{"../faceFeatureExtractor/FaceFeatureExtractor":293,"./FaceLandmark68NetBase":303,tslib:406}],303:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),FaceLandmarks68_1=require("../classes/FaceLandmarks68"),dom_1=require("../dom"),FaceProcessor_1=require("../faceProcessor/FaceProcessor"),utils_1=require("../utils"),FaceLandmark68NetBase=function(_super){function FaceLandmark68NetBase(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(FaceLandmark68NetBase,_super),FaceLandmark68NetBase.prototype.postProcess=function(output,inputSize,originalDimensions){var inputDimensions=originalDimensions.map((function(_a){var width=_a.width,height=_a.height,scale=inputSize/Math.max(height,width);return{width:width*scale,height:height*scale}})),batchSize=inputDimensions.length;return tf.tidy((function(){var createInterleavedTensor=function(fillX,fillY){return tf.stack([tf.fill([68],fillX),tf.fill([68],fillY)],1).as2D(1,136).as1D()},getPadding=function(batchIdx,cond){var _a=inputDimensions[batchIdx],width=_a.width,height=_a.height;return cond(width,height)?Math.abs(width-height)/2:0};return output.mul(tf.fill([batchSize,136],inputSize)).sub(tf.stack(Array.from(Array(batchSize),(function(_,batchIdx){return createInterleavedTensor(function(batchIdx){return getPadding(batchIdx,(function(w,h){return w<h}))}(batchIdx),function(batchIdx){return getPadding(batchIdx,(function(w,h){return h<w}))}(batchIdx))})))).div(tf.stack(Array.from(Array(batchSize),(function(_,batchIdx){return createInterleavedTensor(inputDimensions[batchIdx].width,inputDimensions[batchIdx].height)}))))}))},FaceLandmark68NetBase.prototype.forwardInput=function(input){var _this=this;return tf.tidy((function(){var out=_this.runNet(input);return _this.postProcess(out,input.inputSize,input.inputDimensions.map((function(_a){return{height:_a[0],width:_a[1]}})))}))},FaceLandmark68NetBase.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},FaceLandmark68NetBase.prototype.detectLandmarks=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var netInput,landmarkTensors,landmarksForBatch,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,dom_1.toNetInput(input)];case 1:return netInput=_a.sent(),landmarkTensors=tf.tidy((function(){return tf.unstack(_this.forwardInput(netInput))})),[4,Promise.all(landmarkTensors.map((function(landmarkTensor,batchIdx){return tslib_1.__awaiter(_this,void 0,void 0,(function(){var landmarksArray,_a,_b,xCoords,yCoords;return tslib_1.__generator(this,(function(_c){switch(_c.label){case 0:return _b=(_a=Array).from,[4,landmarkTensor.data()];case 1:return landmarksArray=_b.apply(_a,[_c.sent()]),xCoords=landmarksArray.filter((function(_,i){return utils_1.isEven(i)})),yCoords=landmarksArray.filter((function(_,i){return!utils_1.isEven(i)})),[2,new FaceLandmarks68_1.FaceLandmarks68(Array(68).fill(0).map((function(_,i){return new classes_1.Point(xCoords[i],yCoords[i])})),{height:netInput.getInputHeight(batchIdx),width:netInput.getInputWidth(batchIdx)})]}}))}))})))];case 2:return landmarksForBatch=_a.sent(),landmarkTensors.forEach((function(t){return t.dispose()})),[2,netInput.isBatchInput?landmarksForBatch:landmarksForBatch[0]]}}))}))},FaceLandmark68NetBase.prototype.getClassifierChannelsOut=function(){return 136},FaceLandmark68NetBase}(FaceProcessor_1.FaceProcessor);exports.FaceLandmark68NetBase=FaceLandmark68NetBase},{"../classes":241,"../classes/FaceLandmarks68":233,"../dom":269,"../faceProcessor/FaceProcessor":306,"../utils":391,"@tensorflow/tfjs-core":113,tslib:406}],304:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),TinyFaceFeatureExtractor_1=require("../faceFeatureExtractor/TinyFaceFeatureExtractor"),FaceLandmark68TinyNet=function(_super){function FaceLandmark68TinyNet(faceFeatureExtractor){return void 0===faceFeatureExtractor&&(faceFeatureExtractor=new TinyFaceFeatureExtractor_1.TinyFaceFeatureExtractor),_super.call(this,"FaceLandmark68TinyNet",faceFeatureExtractor)||this}return tslib_1.__extends(FaceLandmark68TinyNet,_super),FaceLandmark68TinyNet.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},FaceLandmark68TinyNet.prototype.getClassifierChannelsIn=function(){return 128},FaceLandmark68TinyNet}(require("./FaceLandmark68NetBase").FaceLandmark68NetBase);exports.FaceLandmark68TinyNet=FaceLandmark68TinyNet},{"../faceFeatureExtractor/TinyFaceFeatureExtractor":294,"./FaceLandmark68NetBase":303,tslib:406}],305:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),FaceLandmark68Net_1=require("./FaceLandmark68Net");tslib_1.__exportStar(require("./FaceLandmark68Net"),exports),tslib_1.__exportStar(require("./FaceLandmark68TinyNet"),exports);var FaceLandmarkNet=function(_super){function FaceLandmarkNet(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(FaceLandmarkNet,_super),FaceLandmarkNet}(FaceLandmark68Net_1.FaceLandmark68Net);exports.FaceLandmarkNet=FaceLandmarkNet},{"./FaceLandmark68Net":302,"./FaceLandmark68TinyNet":304,tslib:406}],306:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),fullyConnectedLayer_1=require("../common/fullyConnectedLayer"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),util_1=require("./util"),FaceProcessor=function(_super){function FaceProcessor(_name,faceFeatureExtractor){var _this=_super.call(this,_name)||this;return _this._faceFeatureExtractor=faceFeatureExtractor,_this}return tslib_1.__extends(FaceProcessor,_super),Object.defineProperty(FaceProcessor.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),FaceProcessor.prototype.runNet=function(input){var _this=this,params=this.params;if(!params)throw new Error(this._name+" - load model before inference");return tf.tidy((function(){var bottleneckFeatures=input instanceof dom_1.NetInput?_this.faceFeatureExtractor.forwardInput(input):input;return fullyConnectedLayer_1.fullyConnectedLayer(bottleneckFeatures.as2D(bottleneckFeatures.shape[0],-1),params.fc)}))},FaceProcessor.prototype.dispose=function(throwOnRedispose){void 0===throwOnRedispose&&(throwOnRedispose=!0),this.faceFeatureExtractor.dispose(throwOnRedispose),_super.prototype.dispose.call(this,throwOnRedispose)},FaceProcessor.prototype.loadClassifierParams=function(weights){var _a=this.extractClassifierParams(weights),params=_a.params,paramMappings=_a.paramMappings;this._params=params,this._paramMappings=paramMappings},FaceProcessor.prototype.extractClassifierParams=function(weights){return extractParams_1.extractParams(weights,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},FaceProcessor.prototype.extractParamsFromWeigthMap=function(weightMap){var _a=util_1.seperateWeightMaps(weightMap),featureExtractorMap=_a.featureExtractorMap,classifierMap=_a.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(featureExtractorMap),extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(classifierMap)},FaceProcessor.prototype.extractParams=function(weights){var cIn=this.getClassifierChannelsIn(),cOut=this.getClassifierChannelsOut(),classifierWeightSize=cOut*cIn+cOut,featureExtractorWeights=weights.slice(0,weights.length-classifierWeightSize),classifierWeights=weights.slice(weights.length-classifierWeightSize);return this.faceFeatureExtractor.extractWeights(featureExtractorWeights),this.extractClassifierParams(classifierWeights)},FaceProcessor}(NeuralNetwork_1.NeuralNetwork);exports.FaceProcessor=FaceProcessor},{"../NeuralNetwork":221,"../common/fullyConnectedLayer":250,"../dom":269,"./extractParams":307,"./extractParamsFromWeigthMap":308,"./util":309,"@tensorflow/tfjs-core":113,tslib:406}],307:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common");exports.extractParams=function(weights,channelsIn,channelsOut){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,fc=common_1.extractFCParamsFactory(extractWeights,paramMappings)(channelsIn,channelsOut,"fc");if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{paramMappings:paramMappings,params:{fc:fc}}}},{"../common":252}],308:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common");exports.extractParamsFromWeigthMap=function(weightMap){var prefix,paramMappings=[],extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings),params={fc:(prefix="fc",{weights:extractWeightEntry(prefix+"/weights",2),bias:extractWeightEntry(prefix+"/bias",1)})};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252}],309:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.seperateWeightMaps=function(weightMap){var featureExtractorMap={},classifierMap={};return Object.keys(weightMap).forEach((function(key){(key.startsWith("fc")?classifierMap:featureExtractorMap)[key]=weightMap[key]})),{featureExtractorMap:featureExtractorMap,classifierMap:classifierMap}}},{}],310:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),ops_1=require("../ops"),convLayer_1=require("./convLayer"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),residualLayer_1=require("./residualLayer"),FaceRecognitionNet=function(_super){function FaceRecognitionNet(){return _super.call(this,"FaceRecognitionNet")||this}return tslib_1.__extends(FaceRecognitionNet,_super),FaceRecognitionNet.prototype.forwardInput=function(input){var params=this.params;if(!params)throw new Error("FaceRecognitionNet - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(150,!0).toFloat(),normalized=ops_1.normalize(batchTensor,[122.782,117.001,104.298]).div(tf.scalar(256)),out=convLayer_1.convDown(normalized,params.conv32_down);out=tf.maxPool(out,3,2,"valid"),out=residualLayer_1.residual(out,params.conv32_1),out=residualLayer_1.residual(out,params.conv32_2),out=residualLayer_1.residual(out,params.conv32_3),out=residualLayer_1.residualDown(out,params.conv64_down),out=residualLayer_1.residual(out,params.conv64_1),out=residualLayer_1.residual(out,params.conv64_2),out=residualLayer_1.residual(out,params.conv64_3),out=residualLayer_1.residualDown(out,params.conv128_down),out=residualLayer_1.residual(out,params.conv128_1),out=residualLayer_1.residual(out,params.conv128_2),out=residualLayer_1.residualDown(out,params.conv256_down),out=residualLayer_1.residual(out,params.conv256_1),out=residualLayer_1.residual(out,params.conv256_2);var globalAvg=(out=residualLayer_1.residualDown(out,params.conv256_down_out)).mean([1,2]);return tf.matMul(globalAvg,params.fc)}))},FaceRecognitionNet.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},FaceRecognitionNet.prototype.computeFaceDescriptor=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var netInput,faceDescriptorTensors,faceDescriptorsForBatch,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,dom_1.toNetInput(input)];case 1:return netInput=_a.sent(),faceDescriptorTensors=tf.tidy((function(){return tf.unstack(_this.forwardInput(netInput))})),[4,Promise.all(faceDescriptorTensors.map((function(t){return t.data()})))];case 2:return faceDescriptorsForBatch=_a.sent(),faceDescriptorTensors.forEach((function(t){return t.dispose()})),[2,netInput.isBatchInput?faceDescriptorsForBatch:faceDescriptorsForBatch[0]]}}))}))},FaceRecognitionNet.prototype.getDefaultModelName=function(){return"face_recognition_model"},FaceRecognitionNet.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap)},FaceRecognitionNet.prototype.extractParams=function(weights){return extractParams_1.extractParams(weights)},FaceRecognitionNet}(NeuralNetwork_1.NeuralNetwork);exports.FaceRecognitionNet=FaceRecognitionNet},{"../NeuralNetwork":221,"../dom":269,"../ops":357,"./convLayer":311,"./extractParams":312,"./extractParamsFromWeigthMap":313,"./residualLayer":315,"@tensorflow/tfjs-core":113,tslib:406}],311:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),scaleLayer_1=require("./scaleLayer");function convLayer(x,params,strides,withRelu,padding){void 0===padding&&(padding="same");var _a=params.conv,filters=_a.filters,bias=_a.bias,out=tf.conv2d(x,filters,strides,padding);return out=tf.add(out,bias),out=scaleLayer_1.scale(out,params.scale),withRelu?tf.relu(out):out}exports.conv=function(x,params){return convLayer(x,params,[1,1],!0)},exports.convNoRelu=function(x,params){return convLayer(x,params,[1,1],!1)},exports.convDown=function(x,params){return convLayer(x,params,[2,2],!0,"valid")}},{"./scaleLayer":316,"@tensorflow/tfjs-core":113}],312:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),utils_1=require("../utils");function extractorsFactory(extractWeights,paramMappings){function extractConvParams(numFilterValues,numFilters,filterSize,mappedPrefix){var filters=function(numFilterValues,numFilters,filterSize){var weights=extractWeights(numFilterValues),depth=weights.length/(numFilters*filterSize*filterSize);if(utils_1.isFloat(depth))throw new Error("depth has to be an integer: "+depth+", weights.length: "+weights.length+", numFilters: "+numFilters+", filterSize: "+filterSize);return tf.tidy((function(){return tf.transpose(tf.tensor4d(weights,[numFilters,depth,filterSize,filterSize]),[2,3,1,0])}))}(numFilterValues,numFilters,filterSize),bias=tf.tensor1d(extractWeights(numFilters));return paramMappings.push({paramPath:mappedPrefix+"/filters"},{paramPath:mappedPrefix+"/bias"}),{filters:filters,bias:bias}}function extractConvLayerParams(numFilterValues,numFilters,filterSize,mappedPrefix){var conv=extractConvParams(numFilterValues,numFilters,filterSize,mappedPrefix+"/conv"),scale=function(numWeights,mappedPrefix){var weights=tf.tensor1d(extractWeights(numWeights)),biases=tf.tensor1d(extractWeights(numWeights));return paramMappings.push({paramPath:mappedPrefix+"/weights"},{paramPath:mappedPrefix+"/biases"}),{weights:weights,biases:biases}}(numFilters,mappedPrefix+"/scale");return{conv:conv,scale:scale}}return{extractConvLayerParams:extractConvLayerParams,extractResidualLayerParams:function(numFilterValues,numFilters,filterSize,mappedPrefix,isDown){return void 0===isDown&&(isDown=!1),{conv1:extractConvLayerParams((isDown?.5:1)*numFilterValues,numFilters,filterSize,mappedPrefix+"/conv1"),conv2:extractConvLayerParams(numFilterValues,numFilters,filterSize,mappedPrefix+"/conv2")}}}}exports.extractParams=function(weights){var _a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,paramMappings=[],_b=extractorsFactory(extractWeights,paramMappings),extractConvLayerParams=_b.extractConvLayerParams,extractResidualLayerParams=_b.extractResidualLayerParams,conv32_down=extractConvLayerParams(4704,32,7,"conv32_down"),conv32_1=extractResidualLayerParams(9216,32,3,"conv32_1"),conv32_2=extractResidualLayerParams(9216,32,3,"conv32_2"),conv32_3=extractResidualLayerParams(9216,32,3,"conv32_3"),conv64_down=extractResidualLayerParams(36864,64,3,"conv64_down",!0),conv64_1=extractResidualLayerParams(36864,64,3,"conv64_1"),conv64_2=extractResidualLayerParams(36864,64,3,"conv64_2"),conv64_3=extractResidualLayerParams(36864,64,3,"conv64_3"),conv128_down=extractResidualLayerParams(147456,128,3,"conv128_down",!0),conv128_1=extractResidualLayerParams(147456,128,3,"conv128_1"),conv128_2=extractResidualLayerParams(147456,128,3,"conv128_2"),conv256_down=extractResidualLayerParams(589824,256,3,"conv256_down",!0),conv256_1=extractResidualLayerParams(589824,256,3,"conv256_1"),conv256_2=extractResidualLayerParams(589824,256,3,"conv256_2"),conv256_down_out=extractResidualLayerParams(589824,256,3,"conv256_down_out"),fc=tf.tidy((function(){return tf.transpose(tf.tensor2d(extractWeights(32768),[128,256]),[1,0])}));if(paramMappings.push({paramPath:"fc"}),0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{params:{conv32_down:conv32_down,conv32_1:conv32_1,conv32_2:conv32_2,conv32_3:conv32_3,conv64_down:conv64_down,conv64_1:conv64_1,conv64_2:conv64_2,conv64_3:conv64_3,conv128_down:conv128_down,conv128_1:conv128_1,conv128_2:conv128_2,conv256_down:conv256_down,conv256_1:conv256_1,conv256_2:conv256_2,conv256_down_out:conv256_down_out,fc:fc},paramMappings:paramMappings}}},{"../common":252,"../utils":391,"@tensorflow/tfjs-core":113}],313:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),utils_1=require("../utils");function extractorsFactory(weightMap,paramMappings){var extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings);function extractConvLayerParams(prefix){var filters=extractWeightEntry(prefix+"/conv/filters",4),bias=extractWeightEntry(prefix+"/conv/bias",1),scale=function(prefix){return{weights:extractWeightEntry(prefix+"/scale/weights",1),biases:extractWeightEntry(prefix+"/scale/biases",1)}}(prefix);return{conv:{filters:filters,bias:bias},scale:scale}}return{extractConvLayerParams:extractConvLayerParams,extractResidualLayerParams:function(prefix){return{conv1:extractConvLayerParams(prefix+"/conv1"),conv2:extractConvLayerParams(prefix+"/conv2")}}}}exports.extractParamsFromWeigthMap=function(weightMap){var paramMappings=[],_a=extractorsFactory(weightMap,paramMappings),extractConvLayerParams=_a.extractConvLayerParams,extractResidualLayerParams=_a.extractResidualLayerParams,conv32_down=extractConvLayerParams("conv32_down"),conv32_1=extractResidualLayerParams("conv32_1"),conv32_2=extractResidualLayerParams("conv32_2"),conv32_3=extractResidualLayerParams("conv32_3"),conv64_down=extractResidualLayerParams("conv64_down"),conv64_1=extractResidualLayerParams("conv64_1"),conv64_2=extractResidualLayerParams("conv64_2"),conv64_3=extractResidualLayerParams("conv64_3"),conv128_down=extractResidualLayerParams("conv128_down"),conv128_1=extractResidualLayerParams("conv128_1"),conv128_2=extractResidualLayerParams("conv128_2"),conv256_down=extractResidualLayerParams("conv256_down"),conv256_1=extractResidualLayerParams("conv256_1"),conv256_2=extractResidualLayerParams("conv256_2"),conv256_down_out=extractResidualLayerParams("conv256_down_out"),fc=weightMap.fc;if(paramMappings.push({originalPath:"fc",paramPath:"fc"}),!utils_1.isTensor2D(fc))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+fc);var params={conv32_down:conv32_down,conv32_1:conv32_1,conv32_2:conv32_2,conv32_3:conv32_3,conv64_down:conv64_down,conv64_1:conv64_1,conv64_2:conv64_2,conv64_3:conv64_3,conv128_down:conv128_down,conv128_1:conv128_1,conv128_2:conv128_2,conv256_down:conv256_down,conv256_1:conv256_1,conv256_2:conv256_2,conv256_down_out:conv256_down_out,fc:fc};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252,"../utils":391}],314:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),FaceRecognitionNet_1=require("./FaceRecognitionNet");tslib_1.__exportStar(require("./FaceRecognitionNet"),exports),exports.createFaceRecognitionNet=function(weights){var net=new FaceRecognitionNet_1.FaceRecognitionNet;return net.extractWeights(weights),net}},{"./FaceRecognitionNet":310,tslib:406}],315:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),convLayer_1=require("./convLayer");exports.residual=function(x,params){var out=convLayer_1.conv(x,params.conv1);return out=convLayer_1.convNoRelu(out,params.conv2),out=tf.add(out,x),out=tf.relu(out)},exports.residualDown=function(x,params){var out=convLayer_1.convDown(x,params.conv1);out=convLayer_1.convNoRelu(out,params.conv2);var pooled=tf.avgPool(x,2,2,"valid"),zeros=tf.zeros(pooled.shape),isPad=pooled.shape[3]!==out.shape[3];if(pooled.shape[1]!==out.shape[1]||pooled.shape[2]!==out.shape[2]){var padShapeX=tslib_1.__spreadArrays(out.shape);padShapeX[1]=1;var zerosW=tf.zeros(padShapeX);out=tf.concat([out,zerosW],1);var padShapeY=tslib_1.__spreadArrays(out.shape);padShapeY[2]=1;var zerosH=tf.zeros(padShapeY);out=tf.concat([out,zerosH],2)}return pooled=isPad?tf.concat([pooled,zeros],3):pooled,out=tf.add(pooled,out),out=tf.relu(out)}},{"./convLayer":311,"@tensorflow/tfjs-core":113,tslib:406}],316:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.scale=function(x,params){return tf.add(tf.mul(x,params.weights),params.biases)}},{"@tensorflow/tfjs-core":113}],317:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isWithAge=function(obj){return"number"==typeof obj.age},exports.extendWithAge=function(sourceObj,age){var extension={age:age};return Object.assign({},sourceObj,extension)}},{}],318:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extendWithFaceDescriptor=function(sourceObj,descriptor){var extension={descriptor:descriptor};return Object.assign({},sourceObj,extension)}},{}],319:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FaceDetection_1=require("../classes/FaceDetection");exports.isWithFaceDetection=function(obj){return obj.detection instanceof FaceDetection_1.FaceDetection},exports.extendWithFaceDetection=function(sourceObj,detection){var extension={detection:detection};return Object.assign({},sourceObj,extension)}},{"../classes/FaceDetection":230}],320:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FaceExpressions_1=require("../faceExpressionNet/FaceExpressions");exports.isWithFaceExpressions=function(obj){return obj.expressions instanceof FaceExpressions_1.FaceExpressions},exports.extendWithFaceExpressions=function(sourceObj,expressions){var extension={expressions:expressions};return Object.assign({},sourceObj,extension)}},{"../faceExpressionNet/FaceExpressions":291}],321:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FaceDetection_1=require("../classes/FaceDetection"),FaceLandmarks_1=require("../classes/FaceLandmarks"),WithFaceDetection_1=require("./WithFaceDetection");exports.isWithFaceLandmarks=function(obj){return WithFaceDetection_1.isWithFaceDetection(obj)&&obj.landmarks instanceof FaceLandmarks_1.FaceLandmarks&&obj.unshiftedLandmarks instanceof FaceLandmarks_1.FaceLandmarks&&obj.alignedRect instanceof FaceDetection_1.FaceDetection},exports.extendWithFaceLandmarks=function(sourceObj,unshiftedLandmarks){var shift=sourceObj.detection.box,landmarks=unshiftedLandmarks.shiftBy(shift.x,shift.y),rect=landmarks.align(),imageDims=sourceObj.detection.imageDims,extension={landmarks:landmarks,unshiftedLandmarks:unshiftedLandmarks,alignedRect:new FaceDetection_1.FaceDetection(sourceObj.detection.score,rect.rescale(imageDims.reverse()),imageDims)};return Object.assign({},sourceObj,extension)}},{"../classes/FaceDetection":230,"../classes/FaceLandmarks":231,"./WithFaceDetection":319}],322:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var types_1=require("../ageGenderNet/types"),utils_1=require("../utils");exports.isWithGender=function(obj){return(obj.gender===types_1.Gender.MALE||obj.gender===types_1.Gender.FEMALE)&&utils_1.isValidProbablitiy(obj.genderProbability)},exports.extendWithGender=function(sourceObj,gender,genderProbability){var extension={gender:gender,genderProbability:genderProbability};return Object.assign({},sourceObj,extension)}},{"../ageGenderNet/types":226,"../utils":391}],323:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./WithFaceDescriptor"),exports),tslib_1.__exportStar(require("./WithFaceDetection"),exports),tslib_1.__exportStar(require("./WithFaceExpressions"),exports),tslib_1.__exportStar(require("./WithFaceLandmarks"),exports),tslib_1.__exportStar(require("./WithAge"),exports),tslib_1.__exportStar(require("./WithGender"),exports)},{"./WithAge":317,"./WithFaceDescriptor":318,"./WithFaceDetection":319,"./WithFaceExpressions":320,"./WithFaceLandmarks":321,"./WithGender":322,tslib:406}],324:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),ComposableTask=function(){function ComposableTask(){}return ComposableTask.prototype.then=function(onfulfilled){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=onfulfilled,[4,this.run()];case 1:return[2,_a.apply(void 0,[_b.sent()])]}}))}))},ComposableTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){throw new Error("ComposableTask - run is not implemented")}))}))},ComposableTask}();exports.ComposableTask=ComposableTask},{tslib:406}],325:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),WithFaceDescriptor_1=require("../factories/WithFaceDescriptor"),ComposableTask_1=require("./ComposableTask"),extractFacesAndComputeResults_1=require("./extractFacesAndComputeResults"),nets_1=require("./nets"),PredictAgeAndGenderTask_1=require("./PredictAgeAndGenderTask"),PredictFaceExpressionsTask_1=require("./PredictFaceExpressionsTask"),ComputeFaceDescriptorsTaskBase=function(_super){function ComputeFaceDescriptorsTaskBase(parentTask,input){var _this=_super.call(this)||this;return _this.parentTask=parentTask,_this.input=input,_this}return tslib_1.__extends(ComputeFaceDescriptorsTaskBase,_super),ComputeFaceDescriptorsTaskBase}(ComposableTask_1.ComposableTask);exports.ComputeFaceDescriptorsTaskBase=ComputeFaceDescriptorsTaskBase;var ComputeAllFaceDescriptorsTask=function(_super){function ComputeAllFaceDescriptorsTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(ComputeAllFaceDescriptorsTask,_super),ComputeAllFaceDescriptorsTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResults;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.parentTask];case 1:return parentResults=_a.sent(),[4,extractFacesAndComputeResults_1.extractAllFacesAndComputeResults(parentResults,this.input,(function(faces){return Promise.all(faces.map((function(face){return nets_1.nets.faceRecognitionNet.computeFaceDescriptor(face)})))}),null,(function(parentResult){return parentResult.landmarks.align(null,{useDlibAlignment:!0})}))];case 2:return[2,_a.sent().map((function(descriptor,i){return WithFaceDescriptor_1.extendWithFaceDescriptor(parentResults[i],descriptor)}))]}}))}))},ComputeAllFaceDescriptorsTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},ComputeAllFaceDescriptorsTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},ComputeAllFaceDescriptorsTask}(ComputeFaceDescriptorsTaskBase);exports.ComputeAllFaceDescriptorsTask=ComputeAllFaceDescriptorsTask;var ComputeSingleFaceDescriptorTask=function(_super){function ComputeSingleFaceDescriptorTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(ComputeSingleFaceDescriptorTask,_super),ComputeSingleFaceDescriptorTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResult,descriptor;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.parentTask];case 1:return(parentResult=_a.sent())?[4,extractFacesAndComputeResults_1.extractSingleFaceAndComputeResult(parentResult,this.input,(function(face){return nets_1.nets.faceRecognitionNet.computeFaceDescriptor(face)}),null,(function(parentResult){return parentResult.landmarks.align(null,{useDlibAlignment:!0})}))]:[2];case 2:return descriptor=_a.sent(),[2,WithFaceDescriptor_1.extendWithFaceDescriptor(parentResult,descriptor)]}}))}))},ComputeSingleFaceDescriptorTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},ComputeSingleFaceDescriptorTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},ComputeSingleFaceDescriptorTask}(ComputeFaceDescriptorsTaskBase);exports.ComputeSingleFaceDescriptorTask=ComputeSingleFaceDescriptorTask},{"../factories/WithFaceDescriptor":318,"./ComposableTask":324,"./PredictAgeAndGenderTask":329,"./PredictFaceExpressionsTask":330,"./extractFacesAndComputeResults":333,"./nets":335,tslib:406}],326:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),WithFaceLandmarks_1=require("../factories/WithFaceLandmarks"),ComposableTask_1=require("./ComposableTask"),ComputeFaceDescriptorsTasks_1=require("./ComputeFaceDescriptorsTasks"),nets_1=require("./nets"),PredictAgeAndGenderTask_1=require("./PredictAgeAndGenderTask"),PredictFaceExpressionsTask_1=require("./PredictFaceExpressionsTask"),DetectFaceLandmarksTaskBase=function(_super){function DetectFaceLandmarksTaskBase(parentTask,input,useTinyLandmarkNet){var _this=_super.call(this)||this;return _this.parentTask=parentTask,_this.input=input,_this.useTinyLandmarkNet=useTinyLandmarkNet,_this}return tslib_1.__extends(DetectFaceLandmarksTaskBase,_super),Object.defineProperty(DetectFaceLandmarksTaskBase.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?nets_1.nets.faceLandmark68TinyNet:nets_1.nets.faceLandmark68Net},enumerable:!0,configurable:!0}),DetectFaceLandmarksTaskBase}(ComposableTask_1.ComposableTask);exports.DetectFaceLandmarksTaskBase=DetectFaceLandmarksTaskBase;var DetectAllFaceLandmarksTask=function(_super){function DetectAllFaceLandmarksTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(DetectAllFaceLandmarksTask,_super),DetectAllFaceLandmarksTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResults,detections,faces,_a,faceLandmarksByFace,_this=this;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return[4,this.parentTask];case 1:return parentResults=_b.sent(),detections=parentResults.map((function(res){return res.detection})),this.input instanceof tf.Tensor?[4,dom_1.extractFaceTensors(this.input,detections)]:[3,3];case 2:return _a=_b.sent(),[3,5];case 3:return[4,dom_1.extractFaces(this.input,detections)];case 4:_a=_b.sent(),_b.label=5;case 5:return faces=_a,[4,Promise.all(faces.map((function(face){return _this.landmarkNet.detectLandmarks(face)})))];case 6:return faceLandmarksByFace=_b.sent(),faces.forEach((function(f){return f instanceof tf.Tensor&&f.dispose()})),[2,parentResults.map((function(parentResult,i){return WithFaceLandmarks_1.extendWithFaceLandmarks(parentResult,faceLandmarksByFace[i])}))]}}))}))},DetectAllFaceLandmarksTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},DetectAllFaceLandmarksTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},DetectAllFaceLandmarksTask.prototype.withFaceDescriptors=function(){return new ComputeFaceDescriptorsTasks_1.ComputeAllFaceDescriptorsTask(this,this.input)},DetectAllFaceLandmarksTask}(DetectFaceLandmarksTaskBase);exports.DetectAllFaceLandmarksTask=DetectAllFaceLandmarksTask;var DetectSingleFaceLandmarksTask=function(_super){function DetectSingleFaceLandmarksTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(DetectSingleFaceLandmarksTask,_super),DetectSingleFaceLandmarksTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResult,detection,faces,_a,landmarks;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return[4,this.parentTask];case 1:return(parentResult=_b.sent())?(detection=parentResult.detection,this.input instanceof tf.Tensor?[4,dom_1.extractFaceTensors(this.input,[detection])]:[3,3]):[2];case 2:return _a=_b.sent(),[3,5];case 3:return[4,dom_1.extractFaces(this.input,[detection])];case 4:_a=_b.sent(),_b.label=5;case 5:return faces=_a,[4,this.landmarkNet.detectLandmarks(faces[0])];case 6:return landmarks=_b.sent(),faces.forEach((function(f){return f instanceof tf.Tensor&&f.dispose()})),[2,WithFaceLandmarks_1.extendWithFaceLandmarks(parentResult,landmarks)]}}))}))},DetectSingleFaceLandmarksTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},DetectSingleFaceLandmarksTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},DetectSingleFaceLandmarksTask.prototype.withFaceDescriptor=function(){return new ComputeFaceDescriptorsTasks_1.ComputeSingleFaceDescriptorTask(this,this.input)},DetectSingleFaceLandmarksTask}(DetectFaceLandmarksTaskBase);exports.DetectSingleFaceLandmarksTask=DetectSingleFaceLandmarksTask},{"../dom":269,"../factories/WithFaceLandmarks":321,"./ComposableTask":324,"./ComputeFaceDescriptorsTasks":325,"./PredictAgeAndGenderTask":329,"./PredictFaceExpressionsTask":330,"./nets":335,"@tensorflow/tfjs-core":113,tslib:406}],327:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),WithFaceDetection_1=require("../factories/WithFaceDetection"),MtcnnOptions_1=require("../mtcnn/MtcnnOptions"),SsdMobilenetv1Options_1=require("../ssdMobilenetv1/SsdMobilenetv1Options"),TinyFaceDetectorOptions_1=require("../tinyFaceDetector/TinyFaceDetectorOptions"),tinyYolov2_1=require("../tinyYolov2"),ComposableTask_1=require("./ComposableTask"),DetectFaceLandmarksTasks_1=require("./DetectFaceLandmarksTasks"),nets_1=require("./nets"),PredictAgeAndGenderTask_1=require("./PredictAgeAndGenderTask"),PredictFaceExpressionsTask_1=require("./PredictFaceExpressionsTask"),DetectFacesTaskBase=function(_super){function DetectFacesTaskBase(input,options){void 0===options&&(options=new SsdMobilenetv1Options_1.SsdMobilenetv1Options);var _this=_super.call(this)||this;return _this.input=input,_this.options=options,_this}return tslib_1.__extends(DetectFacesTaskBase,_super),DetectFacesTaskBase}(ComposableTask_1.ComposableTask);exports.DetectFacesTaskBase=DetectFacesTaskBase;var DetectAllFacesTask=function(_super){function DetectAllFacesTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(DetectAllFacesTask,_super),DetectAllFacesTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a,input,options,faceDetectionFunction;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return input=(_a=this).input,(options=_a.options)instanceof MtcnnOptions_1.MtcnnOptions?[4,nets_1.nets.mtcnn.forward(input,options)]:[3,2];case 1:return[2,_b.sent().map((function(result){return result.detection}))];case 2:if(faceDetectionFunction=options instanceof TinyFaceDetectorOptions_1.TinyFaceDetectorOptions?function(input){return nets_1.nets.tinyFaceDetector.locateFaces(input,options)}:options instanceof SsdMobilenetv1Options_1.SsdMobilenetv1Options?function(input){return nets_1.nets.ssdMobilenetv1.locateFaces(input,options)}:options instanceof tinyYolov2_1.TinyYolov2Options?function(input){return nets_1.nets.tinyYolov2.locateFaces(input,options)}:null,!faceDetectionFunction)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,faceDetectionFunction(input)]}}))}))},DetectAllFacesTask.prototype.runAndExtendWithFaceDetections=function(){var _this=this;return new Promise((function(res){return tslib_1.__awaiter(_this,void 0,void 0,(function(){var detections;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.run()];case 1:return detections=_a.sent(),[2,res(detections.map((function(detection){return WithFaceDetection_1.extendWithFaceDetection({},detection)})))]}}))}))}))},DetectAllFacesTask.prototype.withFaceLandmarks=function(useTinyLandmarkNet){return void 0===useTinyLandmarkNet&&(useTinyLandmarkNet=!1),new DetectFaceLandmarksTasks_1.DetectAllFaceLandmarksTask(this.runAndExtendWithFaceDetections(),this.input,useTinyLandmarkNet)},DetectAllFacesTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictAllFaceExpressionsTask(this.runAndExtendWithFaceDetections(),this.input)},DetectAllFacesTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictAllAgeAndGenderTask(this.runAndExtendWithFaceDetections(),this.input)},DetectAllFacesTask}(DetectFacesTaskBase);exports.DetectAllFacesTask=DetectAllFacesTask;var DetectSingleFaceTask=function(_super){function DetectSingleFaceTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(DetectSingleFaceTask,_super),DetectSingleFaceTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var faceDetections,faceDetectionWithHighestScore;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,new DetectAllFacesTask(this.input,this.options)];case 1:return faceDetections=_a.sent(),faceDetectionWithHighestScore=faceDetections[0],faceDetections.forEach((function(faceDetection){faceDetection.score>faceDetectionWithHighestScore.score&&(faceDetectionWithHighestScore=faceDetection)})),[2,faceDetectionWithHighestScore]}}))}))},DetectSingleFaceTask.prototype.runAndExtendWithFaceDetection=function(){var _this=this;return new Promise((function(res){return tslib_1.__awaiter(_this,void 0,void 0,(function(){var detection;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.run()];case 1:return detection=_a.sent(),[2,res(detection?WithFaceDetection_1.extendWithFaceDetection({},detection):void 0)]}}))}))}))},DetectSingleFaceTask.prototype.withFaceLandmarks=function(useTinyLandmarkNet){return void 0===useTinyLandmarkNet&&(useTinyLandmarkNet=!1),new DetectFaceLandmarksTasks_1.DetectSingleFaceLandmarksTask(this.runAndExtendWithFaceDetection(),this.input,useTinyLandmarkNet)},DetectSingleFaceTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictSingleFaceExpressionsTask(this.runAndExtendWithFaceDetection(),this.input)},DetectSingleFaceTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictSingleAgeAndGenderTask(this.runAndExtendWithFaceDetection(),this.input)},DetectSingleFaceTask}(DetectFacesTaskBase);exports.DetectSingleFaceTask=DetectSingleFaceTask},{"../factories/WithFaceDetection":319,"../mtcnn/MtcnnOptions":339,"../ssdMobilenetv1/SsdMobilenetv1Options":366,"../tinyFaceDetector/TinyFaceDetectorOptions":377,"../tinyYolov2":389,"./ComposableTask":324,"./DetectFaceLandmarksTasks":326,"./PredictAgeAndGenderTask":329,"./PredictFaceExpressionsTask":330,"./nets":335,tslib:406}],328:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FaceMatch_1=require("../classes/FaceMatch"),LabeledFaceDescriptors_1=require("../classes/LabeledFaceDescriptors"),euclideanDistance_1=require("../euclideanDistance"),FaceMatcher=function(){function FaceMatcher(inputs,distanceThreshold){void 0===distanceThreshold&&(distanceThreshold=.6),this._distanceThreshold=distanceThreshold;var inputArray=Array.isArray(inputs)?inputs:[inputs];if(!inputArray.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var count=1,createUniqueLabel=function(){return"person "+count++};this._labeledDescriptors=inputArray.map((function(desc){if(desc instanceof LabeledFaceDescriptors_1.LabeledFaceDescriptors)return desc;if(desc instanceof Float32Array)return new LabeledFaceDescriptors_1.LabeledFaceDescriptors(createUniqueLabel(),[desc]);if(desc.descriptor&&desc.descriptor instanceof Float32Array)return new LabeledFaceDescriptors_1.LabeledFaceDescriptors(createUniqueLabel(),[desc.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")}))}return Object.defineProperty(FaceMatcher.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(FaceMatcher.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),FaceMatcher.prototype.computeMeanDistance=function(queryDescriptor,descriptors){return descriptors.map((function(d){return euclideanDistance_1.euclideanDistance(d,queryDescriptor)})).reduce((function(d1,d2){return d1+d2}),0)/(descriptors.length||1)},FaceMatcher.prototype.matchDescriptor=function(queryDescriptor){var _this=this;return this.labeledDescriptors.map((function(_a){var descriptors=_a.descriptors,label=_a.label;return new FaceMatch_1.FaceMatch(label,_this.computeMeanDistance(queryDescriptor,descriptors))})).reduce((function(best,curr){return best.distance<curr.distance?best:curr}))},FaceMatcher.prototype.findBestMatch=function(queryDescriptor){var bestMatch=this.matchDescriptor(queryDescriptor);return bestMatch.distance<this.distanceThreshold?bestMatch:new FaceMatch_1.FaceMatch("unknown",bestMatch.distance)},FaceMatcher.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map((function(ld){return ld.toJSON()}))}},FaceMatcher.fromJSON=function(json){return new FaceMatcher(json.labeledDescriptors.map((function(ld){return LabeledFaceDescriptors_1.LabeledFaceDescriptors.fromJSON(ld)})),json.distanceThreshold)},FaceMatcher}();exports.FaceMatcher=FaceMatcher},{"../classes/FaceMatch":234,"../classes/LabeledFaceDescriptors":236,"../euclideanDistance":289}],329:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),WithAge_1=require("../factories/WithAge"),WithGender_1=require("../factories/WithGender"),ComposableTask_1=require("./ComposableTask"),ComputeFaceDescriptorsTasks_1=require("./ComputeFaceDescriptorsTasks"),extractFacesAndComputeResults_1=require("./extractFacesAndComputeResults"),nets_1=require("./nets"),PredictFaceExpressionsTask_1=require("./PredictFaceExpressionsTask"),PredictAgeAndGenderTaskBase=function(_super){function PredictAgeAndGenderTaskBase(parentTask,input,extractedFaces){var _this=_super.call(this)||this;return _this.parentTask=parentTask,_this.input=input,_this.extractedFaces=extractedFaces,_this}return tslib_1.__extends(PredictAgeAndGenderTaskBase,_super),PredictAgeAndGenderTaskBase}(ComposableTask_1.ComposableTask);exports.PredictAgeAndGenderTaskBase=PredictAgeAndGenderTaskBase;var PredictAllAgeAndGenderTask=function(_super){function PredictAllAgeAndGenderTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictAllAgeAndGenderTask,_super),PredictAllAgeAndGenderTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResults,ageAndGenderByFace,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.parentTask];case 1:return parentResults=_a.sent(),[4,extractFacesAndComputeResults_1.extractAllFacesAndComputeResults(parentResults,this.input,(function(faces){return tslib_1.__awaiter(_this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,Promise.all(faces.map((function(face){return nets_1.nets.ageGenderNet.predictAgeAndGender(face)})))];case 1:return[2,_a.sent()]}}))}))}),this.extractedFaces)];case 2:return ageAndGenderByFace=_a.sent(),[2,parentResults.map((function(parentResult,i){var _a=ageAndGenderByFace[i],age=_a.age,gender=_a.gender,genderProbability=_a.genderProbability;return WithAge_1.extendWithAge(WithGender_1.extendWithGender(parentResult,gender,genderProbability),age)}))]}}))}))},PredictAllAgeAndGenderTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictAllFaceExpressionsTask(this,this.input)},PredictAllAgeAndGenderTask}(PredictAgeAndGenderTaskBase);exports.PredictAllAgeAndGenderTask=PredictAllAgeAndGenderTask;var PredictSingleAgeAndGenderTask=function(_super){function PredictSingleAgeAndGenderTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictSingleAgeAndGenderTask,_super),PredictSingleAgeAndGenderTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResult,_a,age,gender,genderProbability;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return[4,this.parentTask];case 1:return(parentResult=_b.sent())?[4,extractFacesAndComputeResults_1.extractSingleFaceAndComputeResult(parentResult,this.input,(function(face){return nets_1.nets.ageGenderNet.predictAgeAndGender(face)}),this.extractedFaces)]:[2];case 2:return _a=_b.sent(),age=_a.age,gender=_a.gender,genderProbability=_a.genderProbability,[2,WithAge_1.extendWithAge(WithGender_1.extendWithGender(parentResult,gender,genderProbability),age)]}}))}))},PredictSingleAgeAndGenderTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictSingleFaceExpressionsTask(this,this.input)},PredictSingleAgeAndGenderTask}(PredictAgeAndGenderTaskBase);exports.PredictSingleAgeAndGenderTask=PredictSingleAgeAndGenderTask;var PredictAllAgeAndGenderWithFaceAlignmentTask=function(_super){function PredictAllAgeAndGenderWithFaceAlignmentTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictAllAgeAndGenderWithFaceAlignmentTask,_super),PredictAllAgeAndGenderWithFaceAlignmentTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},PredictAllAgeAndGenderWithFaceAlignmentTask.prototype.withFaceDescriptors=function(){return new ComputeFaceDescriptorsTasks_1.ComputeAllFaceDescriptorsTask(this,this.input)},PredictAllAgeAndGenderWithFaceAlignmentTask}(PredictAllAgeAndGenderTask);exports.PredictAllAgeAndGenderWithFaceAlignmentTask=PredictAllAgeAndGenderWithFaceAlignmentTask;var PredictSingleAgeAndGenderWithFaceAlignmentTask=function(_super){function PredictSingleAgeAndGenderWithFaceAlignmentTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictSingleAgeAndGenderWithFaceAlignmentTask,_super),PredictSingleAgeAndGenderWithFaceAlignmentTask.prototype.withFaceExpressions=function(){return new PredictFaceExpressionsTask_1.PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},PredictSingleAgeAndGenderWithFaceAlignmentTask.prototype.withFaceDescriptor=function(){return new ComputeFaceDescriptorsTasks_1.ComputeSingleFaceDescriptorTask(this,this.input)},PredictSingleAgeAndGenderWithFaceAlignmentTask}(PredictSingleAgeAndGenderTask);exports.PredictSingleAgeAndGenderWithFaceAlignmentTask=PredictSingleAgeAndGenderWithFaceAlignmentTask},{"../factories/WithAge":317,"../factories/WithGender":322,"./ComposableTask":324,"./ComputeFaceDescriptorsTasks":325,"./PredictFaceExpressionsTask":330,"./extractFacesAndComputeResults":333,"./nets":335,tslib:406}],330:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),WithFaceExpressions_1=require("../factories/WithFaceExpressions"),ComposableTask_1=require("./ComposableTask"),ComputeFaceDescriptorsTasks_1=require("./ComputeFaceDescriptorsTasks"),extractFacesAndComputeResults_1=require("./extractFacesAndComputeResults"),nets_1=require("./nets"),PredictAgeAndGenderTask_1=require("./PredictAgeAndGenderTask"),PredictFaceExpressionsTaskBase=function(_super){function PredictFaceExpressionsTaskBase(parentTask,input,extractedFaces){var _this=_super.call(this)||this;return _this.parentTask=parentTask,_this.input=input,_this.extractedFaces=extractedFaces,_this}return tslib_1.__extends(PredictFaceExpressionsTaskBase,_super),PredictFaceExpressionsTaskBase}(ComposableTask_1.ComposableTask);exports.PredictFaceExpressionsTaskBase=PredictFaceExpressionsTaskBase;var PredictAllFaceExpressionsTask=function(_super){function PredictAllFaceExpressionsTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictAllFaceExpressionsTask,_super),PredictAllFaceExpressionsTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResults,faceExpressionsByFace,_this=this;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.parentTask];case 1:return parentResults=_a.sent(),[4,extractFacesAndComputeResults_1.extractAllFacesAndComputeResults(parentResults,this.input,(function(faces){return tslib_1.__awaiter(_this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,Promise.all(faces.map((function(face){return nets_1.nets.faceExpressionNet.predictExpressions(face)})))];case 1:return[2,_a.sent()]}}))}))}),this.extractedFaces)];case 2:return faceExpressionsByFace=_a.sent(),[2,parentResults.map((function(parentResult,i){return WithFaceExpressions_1.extendWithFaceExpressions(parentResult,faceExpressionsByFace[i])}))]}}))}))},PredictAllFaceExpressionsTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictAllAgeAndGenderTask(this,this.input)},PredictAllFaceExpressionsTask}(PredictFaceExpressionsTaskBase);exports.PredictAllFaceExpressionsTask=PredictAllFaceExpressionsTask;var PredictSingleFaceExpressionsTask=function(_super){function PredictSingleFaceExpressionsTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictSingleFaceExpressionsTask,_super),PredictSingleFaceExpressionsTask.prototype.run=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var parentResult,faceExpressions;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.parentTask];case 1:return(parentResult=_a.sent())?[4,extractFacesAndComputeResults_1.extractSingleFaceAndComputeResult(parentResult,this.input,(function(face){return nets_1.nets.faceExpressionNet.predictExpressions(face)}),this.extractedFaces)]:[2];case 2:return faceExpressions=_a.sent(),[2,WithFaceExpressions_1.extendWithFaceExpressions(parentResult,faceExpressions)]}}))}))},PredictSingleFaceExpressionsTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictSingleAgeAndGenderTask(this,this.input)},PredictSingleFaceExpressionsTask}(PredictFaceExpressionsTaskBase);exports.PredictSingleFaceExpressionsTask=PredictSingleFaceExpressionsTask;var PredictAllFaceExpressionsWithFaceAlignmentTask=function(_super){function PredictAllFaceExpressionsWithFaceAlignmentTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictAllFaceExpressionsWithFaceAlignmentTask,_super),PredictAllFaceExpressionsWithFaceAlignmentTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},PredictAllFaceExpressionsWithFaceAlignmentTask.prototype.withFaceDescriptors=function(){return new ComputeFaceDescriptorsTasks_1.ComputeAllFaceDescriptorsTask(this,this.input)},PredictAllFaceExpressionsWithFaceAlignmentTask}(PredictAllFaceExpressionsTask);exports.PredictAllFaceExpressionsWithFaceAlignmentTask=PredictAllFaceExpressionsWithFaceAlignmentTask;var PredictSingleFaceExpressionsWithFaceAlignmentTask=function(_super){function PredictSingleFaceExpressionsWithFaceAlignmentTask(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(PredictSingleFaceExpressionsWithFaceAlignmentTask,_super),PredictSingleFaceExpressionsWithFaceAlignmentTask.prototype.withAgeAndGender=function(){return new PredictAgeAndGenderTask_1.PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},PredictSingleFaceExpressionsWithFaceAlignmentTask.prototype.withFaceDescriptor=function(){return new ComputeFaceDescriptorsTasks_1.ComputeSingleFaceDescriptorTask(this,this.input)},PredictSingleFaceExpressionsWithFaceAlignmentTask}(PredictSingleFaceExpressionsTask);exports.PredictSingleFaceExpressionsWithFaceAlignmentTask=PredictSingleFaceExpressionsWithFaceAlignmentTask},{"../factories/WithFaceExpressions":320,"./ComposableTask":324,"./ComputeFaceDescriptorsTasks":325,"./PredictAgeAndGenderTask":329,"./extractFacesAndComputeResults":333,"./nets":335,tslib:406}],331:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),MtcnnOptions_1=require("../mtcnn/MtcnnOptions"),ssdMobilenetv1_1=require("../ssdMobilenetv1"),tinyYolov2_1=require("../tinyYolov2"),detectFaces_1=require("./detectFaces");function allFacesSsdMobilenetv1(input,minConfidence){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return console.warn("allFacesSsdMobilenetv1 is deprecated and will be removed soon, use the high level api instead"),[4,detectFaces_1.detectAllFaces(input,new ssdMobilenetv1_1.SsdMobilenetv1Options(minConfidence?{minConfidence:minConfidence}:{})).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,_a.sent()]}}))}))}exports.allFacesSsdMobilenetv1=allFacesSsdMobilenetv1,exports.allFacesTinyYolov2=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return console.warn("allFacesTinyYolov2 is deprecated and will be removed soon, use the high level api instead"),[4,detectFaces_1.detectAllFaces(input,new tinyYolov2_1.TinyYolov2Options(forwardParams)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,_a.sent()]}}))}))},exports.allFacesMtcnn=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return console.warn("allFacesMtcnn is deprecated and will be removed soon, use the high level api instead"),[4,detectFaces_1.detectAllFaces(input,new MtcnnOptions_1.MtcnnOptions(forwardParams)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,_a.sent()]}}))}))},exports.allFaces=allFacesSsdMobilenetv1},{"../mtcnn/MtcnnOptions":339,"../ssdMobilenetv1":370,"../tinyYolov2":389,"./detectFaces":332,tslib:406}],332:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var SsdMobilenetv1Options_1=require("../ssdMobilenetv1/SsdMobilenetv1Options"),DetectFacesTasks_1=require("./DetectFacesTasks");exports.detectSingleFace=function(input,options){return void 0===options&&(options=new SsdMobilenetv1Options_1.SsdMobilenetv1Options),new DetectFacesTasks_1.DetectSingleFaceTask(input,options)},exports.detectAllFaces=function(input,options){return void 0===options&&(options=new SsdMobilenetv1Options_1.SsdMobilenetv1Options),new DetectFacesTasks_1.DetectAllFacesTask(input,options)}},{"../ssdMobilenetv1/SsdMobilenetv1Options":366,"./DetectFacesTasks":327}],333:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),WithFaceLandmarks_1=require("../factories/WithFaceLandmarks");function extractAllFacesAndComputeResults(parentResults,input,computeResults,extractedFaces,getRectForAlignment){return void 0===getRectForAlignment&&(getRectForAlignment=function(_a){return _a.alignedRect}),tslib_1.__awaiter(this,void 0,void 0,(function(){var faceBoxes,faces,_a,_b,results;return tslib_1.__generator(this,(function(_c){switch(_c.label){case 0:return faceBoxes=parentResults.map((function(parentResult){return WithFaceLandmarks_1.isWithFaceLandmarks(parentResult)?getRectForAlignment(parentResult):parentResult.detection})),(_a=extractedFaces)?[3,5]:input instanceof tf.Tensor?[4,dom_1.extractFaceTensors(input,faceBoxes)]:[3,2];case 1:return _b=_c.sent(),[3,4];case 2:return[4,dom_1.extractFaces(input,faceBoxes)];case 3:_b=_c.sent(),_c.label=4;case 4:_a=_b,_c.label=5;case 5:return[4,computeResults(faces=_a)];case 6:return results=_c.sent(),faces.forEach((function(f){return f instanceof tf.Tensor&&f.dispose()})),[2,results]}}))}))}exports.extractAllFacesAndComputeResults=extractAllFacesAndComputeResults,exports.extractSingleFaceAndComputeResult=function(parentResult,input,computeResult,extractedFaces,getRectForAlignment){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _this=this;return tslib_1.__generator(this,(function(_a){return[2,extractAllFacesAndComputeResults([parentResult],input,(function(faces){return tslib_1.__awaiter(_this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){return[2,computeResult(faces[0])]}))}))}),extractedFaces,getRectForAlignment)]}))}))}},{"../dom":269,"../factories/WithFaceLandmarks":321,"@tensorflow/tfjs-core":113,tslib:406}],334:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./allFaces"),exports),tslib_1.__exportStar(require("./ComposableTask"),exports),tslib_1.__exportStar(require("./ComputeFaceDescriptorsTasks"),exports),tslib_1.__exportStar(require("./detectFaces"),exports),tslib_1.__exportStar(require("./DetectFacesTasks"),exports),tslib_1.__exportStar(require("./DetectFaceLandmarksTasks"),exports),tslib_1.__exportStar(require("./FaceMatcher"),exports),tslib_1.__exportStar(require("./nets"),exports)},{"./ComposableTask":324,"./ComputeFaceDescriptorsTasks":325,"./DetectFaceLandmarksTasks":326,"./DetectFacesTasks":327,"./FaceMatcher":328,"./allFaces":331,"./detectFaces":332,"./nets":335,tslib:406}],335:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var AgeGenderNet_1=require("../ageGenderNet/AgeGenderNet"),FaceExpressionNet_1=require("../faceExpressionNet/FaceExpressionNet"),FaceLandmark68Net_1=require("../faceLandmarkNet/FaceLandmark68Net"),FaceLandmark68TinyNet_1=require("../faceLandmarkNet/FaceLandmark68TinyNet"),FaceRecognitionNet_1=require("../faceRecognitionNet/FaceRecognitionNet"),Mtcnn_1=require("../mtcnn/Mtcnn"),SsdMobilenetv1_1=require("../ssdMobilenetv1/SsdMobilenetv1"),TinyFaceDetector_1=require("../tinyFaceDetector/TinyFaceDetector"),tinyYolov2_1=require("../tinyYolov2");exports.nets={ssdMobilenetv1:new SsdMobilenetv1_1.SsdMobilenetv1,tinyFaceDetector:new TinyFaceDetector_1.TinyFaceDetector,tinyYolov2:new tinyYolov2_1.TinyYolov2,mtcnn:new Mtcnn_1.Mtcnn,faceLandmark68Net:new FaceLandmark68Net_1.FaceLandmark68Net,faceLandmark68TinyNet:new FaceLandmark68TinyNet_1.FaceLandmark68TinyNet,faceRecognitionNet:new FaceRecognitionNet_1.FaceRecognitionNet,faceExpressionNet:new FaceExpressionNet_1.FaceExpressionNet,ageGenderNet:new AgeGenderNet_1.AgeGenderNet},exports.ssdMobilenetv1=function(input,options){return exports.nets.ssdMobilenetv1.locateFaces(input,options)},exports.tinyFaceDetector=function(input,options){return exports.nets.tinyFaceDetector.locateFaces(input,options)},exports.tinyYolov2=function(input,options){return exports.nets.tinyYolov2.locateFaces(input,options)},exports.mtcnn=function(input,options){return exports.nets.mtcnn.forward(input,options)},exports.detectFaceLandmarks=function(input){return exports.nets.faceLandmark68Net.detectLandmarks(input)},exports.detectFaceLandmarksTiny=function(input){return exports.nets.faceLandmark68TinyNet.detectLandmarks(input)},exports.computeFaceDescriptor=function(input){return exports.nets.faceRecognitionNet.computeFaceDescriptor(input)},exports.recognizeFaceExpressions=function(input){return exports.nets.faceExpressionNet.predictExpressions(input)},exports.predictAgeAndGender=function(input){return exports.nets.ageGenderNet.predictAgeAndGender(input)},exports.loadSsdMobilenetv1Model=function(url){return exports.nets.ssdMobilenetv1.load(url)},exports.loadTinyFaceDetectorModel=function(url){return exports.nets.tinyFaceDetector.load(url)},exports.loadMtcnnModel=function(url){return exports.nets.mtcnn.load(url)},exports.loadTinyYolov2Model=function(url){return exports.nets.tinyYolov2.load(url)},exports.loadFaceLandmarkModel=function(url){return exports.nets.faceLandmark68Net.load(url)},exports.loadFaceLandmarkTinyModel=function(url){return exports.nets.faceLandmark68TinyNet.load(url)},exports.loadFaceRecognitionModel=function(url){return exports.nets.faceRecognitionNet.load(url)},exports.loadFaceExpressionModel=function(url){return exports.nets.faceExpressionNet.load(url)},exports.loadAgeGenderModel=function(url){return exports.nets.ageGenderNet.load(url)},exports.loadFaceDetectionModel=exports.loadSsdMobilenetv1Model,exports.locateFaces=exports.ssdMobilenetv1,exports.detectLandmarks=exports.detectFaceLandmarks},{"../ageGenderNet/AgeGenderNet":222,"../faceExpressionNet/FaceExpressionNet":290,"../faceLandmarkNet/FaceLandmark68Net":302,"../faceLandmarkNet/FaceLandmark68TinyNet":304,"../faceRecognitionNet/FaceRecognitionNet":310,"../mtcnn/Mtcnn":337,"../ssdMobilenetv1/SsdMobilenetv1":365,"../tinyFaceDetector/TinyFaceDetector":376,"../tinyYolov2":389}],336:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core");exports.tf=tf;var draw=require("./draw");exports.draw=draw;var utils=require("./utils");exports.utils=utils,tslib_1.__exportStar(require("./ageGenderNet/index"),exports),tslib_1.__exportStar(require("./classes/index"),exports),tslib_1.__exportStar(require("./dom/index"),exports),tslib_1.__exportStar(require("./env/index"),exports),tslib_1.__exportStar(require("./faceExpressionNet/index"),exports),tslib_1.__exportStar(require("./faceLandmarkNet/index"),exports),tslib_1.__exportStar(require("./faceRecognitionNet/index"),exports),tslib_1.__exportStar(require("./factories/index"),exports),tslib_1.__exportStar(require("./globalApi/index"),exports),tslib_1.__exportStar(require("./mtcnn/index"),exports),tslib_1.__exportStar(require("./ops/index"),exports),tslib_1.__exportStar(require("./ssdMobilenetv1/index"),exports),tslib_1.__exportStar(require("./tinyFaceDetector/index"),exports),tslib_1.__exportStar(require("./tinyYolov2/index"),exports),tslib_1.__exportStar(require("./euclideanDistance"),exports),tslib_1.__exportStar(require("./NeuralNetwork"),exports),tslib_1.__exportStar(require("./resizeResults"),exports)},{"./NeuralNetwork":221,"./ageGenderNet/index":225,"./classes/index":241,"./dom/index":269,"./draw":282,"./env/index":286,"./euclideanDistance":289,"./faceExpressionNet/index":292,"./faceLandmarkNet/index":305,"./faceRecognitionNet/index":314,"./factories/index":323,"./globalApi/index":334,"./mtcnn/index":349,"./ops/index":357,"./resizeResults":364,"./ssdMobilenetv1/index":370,"./tinyFaceDetector/index":379,"./tinyYolov2/index":389,"./utils":391,"@tensorflow/tfjs-core":113,tslib:406}],337:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),FaceDetection_1=require("../classes/FaceDetection"),FaceLandmarks5_1=require("../classes/FaceLandmarks5"),dom_1=require("../dom"),factories_1=require("../factories"),NeuralNetwork_1=require("../NeuralNetwork"),bgrToRgbTensor_1=require("./bgrToRgbTensor"),config_1=require("./config"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),getSizesForScale_1=require("./getSizesForScale"),MtcnnOptions_1=require("./MtcnnOptions"),pyramidDown_1=require("./pyramidDown"),stage1_1=require("./stage1"),stage2_1=require("./stage2"),stage3_1=require("./stage3"),Mtcnn=function(_super){function Mtcnn(){return _super.call(this,"Mtcnn")||this}return tslib_1.__extends(Mtcnn,_super),Mtcnn.prototype.load=function(weightsOrUrl){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){return console.warn("mtcnn is deprecated and will be removed soon"),[2,_super.prototype.load.call(this,weightsOrUrl)]}))}))},Mtcnn.prototype.loadFromDisk=function(filePath){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){return console.warn("mtcnn is deprecated and will be removed soon"),[2,_super.prototype.loadFromDisk.call(this,filePath)]}))}))},Mtcnn.prototype.forwardInput=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){var params,inputCanvas,stats,tsTotal,imgTensor,onReturn,_a,height,width,_b,minFaceSize,scaleFactor,maxNumScales,scoreThresholds,scaleSteps,scales,ts,out1,out2,out3,results;return tslib_1.__generator(this,(function(_c){switch(_c.label){case 0:if(!(params=this.params))throw new Error("Mtcnn - load model before inference");if(!(inputCanvas=input.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return stats={},tsTotal=Date.now(),imgTensor=tf.tidy((function(){return bgrToRgbTensor_1.bgrToRgbTensor(tf.expandDims(tf.browser.fromPixels(inputCanvas)).toFloat())})),onReturn=function(results){return imgTensor.dispose(),stats.total=Date.now()-tsTotal,results},_a=imgTensor.shape.slice(1),height=_a[0],width=_a[1],_b=new MtcnnOptions_1.MtcnnOptions(forwardParams),minFaceSize=_b.minFaceSize,scaleFactor=_b.scaleFactor,maxNumScales=_b.maxNumScales,scoreThresholds=_b.scoreThresholds,scaleSteps=_b.scaleSteps,scales=(scaleSteps||pyramidDown_1.pyramidDown(minFaceSize,scaleFactor,[height,width])).filter((function(scale){var sizes=getSizesForScale_1.getSizesForScale(scale,[height,width]);return Math.min(sizes.width,sizes.height)>config_1.CELL_SIZE})).slice(0,maxNumScales),stats.scales=scales,stats.pyramid=scales.map((function(scale){return getSizesForScale_1.getSizesForScale(scale,[height,width])})),ts=Date.now(),[4,stage1_1.stage1(imgTensor,scales,scoreThresholds[0],params.pnet,stats)];case 1:return out1=_c.sent(),stats.total_stage1=Date.now()-ts,out1.boxes.length?(stats.stage2_numInputBoxes=out1.boxes.length,ts=Date.now(),[4,stage2_1.stage2(inputCanvas,out1.boxes,scoreThresholds[1],params.rnet,stats)]):[2,onReturn({results:[],stats:stats})];case 2:return out2=_c.sent(),stats.total_stage2=Date.now()-ts,out2.boxes.length?(stats.stage3_numInputBoxes=out2.boxes.length,ts=Date.now(),[4,stage3_1.stage3(inputCanvas,out2.boxes,scoreThresholds[2],params.onet,stats)]):[2,onReturn({results:[],stats:stats})];case 3:return out3=_c.sent(),stats.total_stage3=Date.now()-ts,results=out3.boxes.map((function(box,idx){return factories_1.extendWithFaceLandmarks(factories_1.extendWithFaceDetection({},new FaceDetection_1.FaceDetection(out3.scores[idx],new classes_1.Rect(box.left/width,box.top/height,box.width/width,box.height/height),{height:height,width:width})),new FaceLandmarks5_1.FaceLandmarks5(out3.points[idx].map((function(pt){return pt.sub(new classes_1.Point(box.left,box.top)).div(new classes_1.Point(box.width,box.height))})),{width:box.width,height:box.height}))})),[2,onReturn({results:results,stats:stats})]}}))}))},Mtcnn.prototype.forward=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[4,_a.apply(this,[_b.sent(),forwardParams])];case 2:return[2,_b.sent().results]}}))}))},Mtcnn.prototype.forwardWithStats=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent(),forwardParams])]}}))}))},Mtcnn.prototype.getDefaultModelName=function(){return"mtcnn_model"},Mtcnn.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap)},Mtcnn.prototype.extractParams=function(weights){return extractParams_1.extractParams(weights)},Mtcnn}(NeuralNetwork_1.NeuralNetwork);exports.Mtcnn=Mtcnn},{"../NeuralNetwork":221,"../classes":241,"../classes/FaceDetection":230,"../classes/FaceLandmarks5":232,"../dom":269,"../factories":323,"./MtcnnOptions":339,"./bgrToRgbTensor":343,"./config":344,"./extractParams":346,"./extractParamsFromWeigthMap":347,"./getSizesForScale":348,"./pyramidDown":352,"./stage1":354,"./stage2":355,"./stage3":356,"@tensorflow/tfjs-core":113,tslib:406}],338:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),MtcnnBox=function(_super){function MtcnnBox(left,top,right,bottom){return _super.call(this,{left:left,top:top,right:right,bottom:bottom},!0)||this}return tslib_1.__extends(MtcnnBox,_super),MtcnnBox}(require("../classes").Box);exports.MtcnnBox=MtcnnBox},{"../classes":241,tslib:406}],339:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MtcnnOptions=function(){function MtcnnOptions(_a){var _b=void 0===_a?{}:_a,minFaceSize=_b.minFaceSize,scaleFactor=_b.scaleFactor,maxNumScales=_b.maxNumScales,scoreThresholds=_b.scoreThresholds,scaleSteps=_b.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=minFaceSize||20,this._scaleFactor=scaleFactor||.709,this._maxNumScales=maxNumScales||10,this._scoreThresholds=scoreThresholds||[.6,.7,.7],this._scaleSteps=scaleSteps,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some((function(th){return"number"!=typeof th})))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some((function(th){return"number"!=typeof th}))))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(MtcnnOptions.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(MtcnnOptions.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(MtcnnOptions.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(MtcnnOptions.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(MtcnnOptions.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),MtcnnOptions}();exports.MtcnnOptions=MtcnnOptions},{}],340:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),fullyConnectedLayer_1=require("../common/fullyConnectedLayer"),prelu_1=require("./prelu"),sharedLayers_1=require("./sharedLayers");exports.ONet=function(x,params){return tf.tidy((function(){var out=sharedLayers_1.sharedLayer(x,params);out=tf.maxPool(out,[2,2],[2,2],"same"),out=common_1.convLayer(out,params.conv4,"valid"),out=prelu_1.prelu(out,params.prelu4_alpha);var vectorized=tf.reshape(out,[out.shape[0],params.fc1.weights.shape[0]]),fc1=fullyConnectedLayer_1.fullyConnectedLayer(vectorized,params.fc1),prelu5=prelu_1.prelu(fc1,params.prelu5_alpha),fc2_1=fullyConnectedLayer_1.fullyConnectedLayer(prelu5,params.fc2_1),max=tf.expandDims(tf.max(fc2_1,1),1),prob=tf.softmax(tf.sub(fc2_1,max),1),regions=fullyConnectedLayer_1.fullyConnectedLayer(prelu5,params.fc2_2),points=fullyConnectedLayer_1.fullyConnectedLayer(prelu5,params.fc2_3);return{scores:tf.unstack(prob,1)[1],regions:regions,points:points}}))}},{"../common":252,"../common/fullyConnectedLayer":250,"./prelu":351,"./sharedLayers":353,"@tensorflow/tfjs-core":113}],341:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),sharedLayers_1=require("./sharedLayers");exports.PNet=function(x,params){return tf.tidy((function(){var out=sharedLayers_1.sharedLayer(x,params,!0),conv=common_1.convLayer(out,params.conv4_1,"valid"),max=tf.expandDims(tf.max(conv,3),3);return{prob:tf.softmax(tf.sub(conv,max),3),regions:common_1.convLayer(out,params.conv4_2,"valid")}}))}},{"../common":252,"./sharedLayers":353,"@tensorflow/tfjs-core":113}],342:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),fullyConnectedLayer_1=require("../common/fullyConnectedLayer"),prelu_1=require("./prelu"),sharedLayers_1=require("./sharedLayers");exports.RNet=function(x,params){return tf.tidy((function(){var convOut=sharedLayers_1.sharedLayer(x,params),vectorized=tf.reshape(convOut,[convOut.shape[0],params.fc1.weights.shape[0]]),fc1=fullyConnectedLayer_1.fullyConnectedLayer(vectorized,params.fc1),prelu4=prelu_1.prelu(fc1,params.prelu4_alpha),fc2_1=fullyConnectedLayer_1.fullyConnectedLayer(prelu4,params.fc2_1),max=tf.expandDims(tf.max(fc2_1,1),1),prob=tf.softmax(tf.sub(fc2_1,max),1),regions=fullyConnectedLayer_1.fullyConnectedLayer(prelu4,params.fc2_2);return{scores:tf.unstack(prob,1)[1],regions:regions}}))}},{"../common/fullyConnectedLayer":250,"./prelu":351,"./sharedLayers":353,"@tensorflow/tfjs-core":113}],343:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.bgrToRgbTensor=function(tensor){return tf.tidy((function(){return tf.stack(tf.unstack(tensor,3).reverse(),3)}))}},{"@tensorflow/tfjs-core":113}],344:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CELL_STRIDE=2,exports.CELL_SIZE=12},{}],345:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),dom_1=require("../dom"),env_1=require("../env"),normalize_1=require("./normalize");exports.extractImagePatches=function(img,boxes,_a){var width=_a.width,height=_a.height;return tslib_1.__awaiter(this,void 0,void 0,(function(){var imgCtx,bitmaps,imagePatchesDatas,_this=this;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return imgCtx=dom_1.getContext2dOrThrow(img),[4,Promise.all(boxes.map((function(box){return tslib_1.__awaiter(_this,void 0,void 0,(function(){var _a,y,ey,x,ex,fromX,fromY,imgData;return tslib_1.__generator(this,(function(_b){return _a=box.padAtBorders(img.height,img.width),y=_a.y,ey=_a.ey,x=_a.x,ex=_a.ex,fromX=x-1,fromY=y-1,imgData=imgCtx.getImageData(fromX,fromY,ex-fromX,ey-fromY),[2,env_1.env.isNodejs()?dom_1.createCanvasFromMedia(imgData):createImageBitmap(imgData)]}))}))})))];case 1:return bitmaps=_b.sent(),imagePatchesDatas=[],bitmaps.forEach((function(bmp){var patch=dom_1.createCanvas({width:width,height:height}),patchCtx=dom_1.getContext2dOrThrow(patch);patchCtx.drawImage(bmp,0,0,width,height);for(var data=patchCtx.getImageData(0,0,width,height).data,currData=[],i=0;i<data.length;i+=4)currData.push(data[i+2]),currData.push(data[i+1]),currData.push(data[i]);imagePatchesDatas.push(currData)})),[2,imagePatchesDatas.map((function(data){return tf.tidy((function(){var imagePatchTensor=tf.transpose(tf.tensor4d(data,[1,width,height,3]),[0,2,1,3]).toFloat();return normalize_1.normalize(imagePatchTensor)}))}))]}}))}))}},{"../dom":269,"../env":286,"./normalize":350,"@tensorflow/tfjs-core":113,tslib:406}],346:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),common_1=require("../common");exports.extractParams=function(weights){var _a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,paramMappings=[],_b=function(extractWeights,paramMappings){var extractConvParams=common_1.extractConvParamsFactory(extractWeights,paramMappings),extractFCParams=common_1.extractFCParamsFactory(extractWeights,paramMappings);function extractPReluParams(size,paramPath){var alpha=tf.tensor1d(extractWeights(size));return paramMappings.push({paramPath:paramPath}),alpha}function extractSharedParams(numFilters,mappedPrefix,isRnet){return void 0===isRnet&&(isRnet=!1),{conv1:extractConvParams(numFilters[0],numFilters[1],3,mappedPrefix+"/conv1"),prelu1_alpha:extractPReluParams(numFilters[1],mappedPrefix+"/prelu1_alpha"),conv2:extractConvParams(numFilters[1],numFilters[2],3,mappedPrefix+"/conv2"),prelu2_alpha:extractPReluParams(numFilters[2],mappedPrefix+"/prelu2_alpha"),conv3:extractConvParams(numFilters[2],numFilters[3],isRnet?2:3,mappedPrefix+"/conv3"),prelu3_alpha:extractPReluParams(numFilters[3],mappedPrefix+"/prelu3_alpha")}}return{extractPNetParams:function(){var sharedParams=extractSharedParams([3,10,16,32],"pnet"),conv4_1=extractConvParams(32,2,1,"pnet/conv4_1"),conv4_2=extractConvParams(32,4,1,"pnet/conv4_2");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{conv4_1:conv4_1,conv4_2:conv4_2})},extractRNetParams:function(){var sharedParams=extractSharedParams([3,28,48,64],"rnet",!0),fc1=extractFCParams(576,128,"rnet/fc1"),prelu4_alpha=extractPReluParams(128,"rnet/prelu4_alpha"),fc2_1=extractFCParams(128,2,"rnet/fc2_1"),fc2_2=extractFCParams(128,4,"rnet/fc2_2");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{fc1:fc1,prelu4_alpha:prelu4_alpha,fc2_1:fc2_1,fc2_2:fc2_2})},extractONetParams:function(){var sharedParams=extractSharedParams([3,32,64,64],"onet"),conv4=extractConvParams(64,128,2,"onet/conv4"),prelu4_alpha=extractPReluParams(128,"onet/prelu4_alpha"),fc1=extractFCParams(1152,256,"onet/fc1"),prelu5_alpha=extractPReluParams(256,"onet/prelu5_alpha"),fc2_1=extractFCParams(256,2,"onet/fc2_1"),fc2_2=extractFCParams(256,4,"onet/fc2_2"),fc2_3=extractFCParams(256,10,"onet/fc2_3");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{conv4:conv4,prelu4_alpha:prelu4_alpha,fc1:fc1,prelu5_alpha:prelu5_alpha,fc2_1:fc2_1,fc2_2:fc2_2,fc2_3:fc2_3})}}}(extractWeights,paramMappings),extractPNetParams=_b.extractPNetParams,extractRNetParams=_b.extractRNetParams,extractONetParams=_b.extractONetParams,pnet=extractPNetParams(),rnet=extractRNetParams(),onet=extractONetParams();if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{params:{pnet:pnet,rnet:rnet,onet:onet},paramMappings:paramMappings}}},{"../common":252,"@tensorflow/tfjs-core":113,tslib:406}],347:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),common_1=require("../common");exports.extractParamsFromWeigthMap=function(weightMap){var paramMappings=[],_a=function(weightMap,paramMappings){var extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings);function extractConvParams(prefix){return{filters:extractWeightEntry(prefix+"/weights",4,prefix+"/filters"),bias:extractWeightEntry(prefix+"/bias",1)}}function extractFCParams(prefix){return{weights:extractWeightEntry(prefix+"/weights",2),bias:extractWeightEntry(prefix+"/bias",1)}}function extractPReluParams(paramPath){return extractWeightEntry(paramPath,1)}function extractSharedParams(prefix){return{conv1:extractConvParams(prefix+"/conv1"),prelu1_alpha:extractPReluParams(prefix+"/prelu1_alpha"),conv2:extractConvParams(prefix+"/conv2"),prelu2_alpha:extractPReluParams(prefix+"/prelu2_alpha"),conv3:extractConvParams(prefix+"/conv3"),prelu3_alpha:extractPReluParams(prefix+"/prelu3_alpha")}}return{extractPNetParams:function(){var sharedParams=extractSharedParams("pnet"),conv4_1=extractConvParams("pnet/conv4_1"),conv4_2=extractConvParams("pnet/conv4_2");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{conv4_1:conv4_1,conv4_2:conv4_2})},extractRNetParams:function(){var sharedParams=extractSharedParams("rnet"),fc1=extractFCParams("rnet/fc1"),prelu4_alpha=extractPReluParams("rnet/prelu4_alpha"),fc2_1=extractFCParams("rnet/fc2_1"),fc2_2=extractFCParams("rnet/fc2_2");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{fc1:fc1,prelu4_alpha:prelu4_alpha,fc2_1:fc2_1,fc2_2:fc2_2})},extractONetParams:function(){var sharedParams=extractSharedParams("onet"),conv4=extractConvParams("onet/conv4"),prelu4_alpha=extractPReluParams("onet/prelu4_alpha"),fc1=extractFCParams("onet/fc1"),prelu5_alpha=extractPReluParams("onet/prelu5_alpha"),fc2_1=extractFCParams("onet/fc2_1"),fc2_2=extractFCParams("onet/fc2_2"),fc2_3=extractFCParams("onet/fc2_3");return tslib_1.__assign(tslib_1.__assign({},sharedParams),{conv4:conv4,prelu4_alpha:prelu4_alpha,fc1:fc1,prelu5_alpha:prelu5_alpha,fc2_1:fc2_1,fc2_2:fc2_2,fc2_3:fc2_3})}}}(weightMap,paramMappings),extractPNetParams=_a.extractPNetParams,extractRNetParams=_a.extractRNetParams,extractONetParams=_a.extractONetParams,pnet=extractPNetParams(),rnet=extractRNetParams(),onet=extractONetParams();return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:{pnet:pnet,rnet:rnet,onet:onet},paramMappings:paramMappings}}},{"../common":252,tslib:406}],348:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSizesForScale=function(scale,_a){var height=_a[0],width=_a[1];return{height:Math.floor(height*scale),width:Math.floor(width*scale)}}},{}],349:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),Mtcnn_1=require("./Mtcnn");tslib_1.__exportStar(require("./Mtcnn"),exports),tslib_1.__exportStar(require("./MtcnnOptions"),exports),exports.createMtcnn=function(weights){var net=new Mtcnn_1.Mtcnn;return net.extractWeights(weights),net}},{"./Mtcnn":337,"./MtcnnOptions":339,tslib:406}],350:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.normalize=function(x){return tf.tidy((function(){return tf.mul(tf.sub(x,tf.scalar(127.5)),tf.scalar(.0078125))}))}},{"@tensorflow/tfjs-core":113}],351:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.prelu=function(x,alpha){return tf.tidy((function(){return tf.add(tf.relu(x),tf.mul(alpha,tf.neg(tf.relu(tf.neg(x)))))}))}},{"@tensorflow/tfjs-core":113}],352:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var config_1=require("./config");exports.pyramidDown=function(minFaceSize,scaleFactor,dims){for(var height=dims[0],width=dims[1],m=config_1.CELL_SIZE/minFaceSize,scales=[],minLayer=Math.min(height,width)*m,exp=0;minLayer>=12;)scales.push(m*Math.pow(scaleFactor,exp)),minLayer*=scaleFactor,exp+=1;return scales}},{"./config":344}],353:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),prelu_1=require("./prelu");exports.sharedLayer=function(x,params,isPnet){return void 0===isPnet&&(isPnet=!1),tf.tidy((function(){var out=common_1.convLayer(x,params.conv1,"valid");return out=prelu_1.prelu(out,params.prelu1_alpha),out=tf.maxPool(out,isPnet?[2,2]:[3,3],[2,2],"same"),out=common_1.convLayer(out,params.conv2,"valid"),out=prelu_1.prelu(out,params.prelu2_alpha),out=isPnet?out:tf.maxPool(out,[3,3],[2,2],"valid"),out=common_1.convLayer(out,params.conv3,"valid"),out=prelu_1.prelu(out,params.prelu3_alpha)}))}},{"../common":252,"./prelu":351,"@tensorflow/tfjs-core":113}],354:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),ops_1=require("../ops"),config_1=require("./config"),getSizesForScale_1=require("./getSizesForScale"),MtcnnBox_1=require("./MtcnnBox"),normalize_1=require("./normalize"),PNet_1=require("./PNet");exports.stage1=function(imgTensor,scales,scoreThreshold,params,stats){stats.stage1=[];var pnetOutputs=scales.map((function(scale){return tf.tidy((function(){var statsForScale={scale:scale},resized=function(x,scale){return tf.tidy((function(){var _a=getSizesForScale_1.getSizesForScale(scale,x.shape.slice(1)),height=_a.height,width=_a.width,resized=tf.image.resizeBilinear(x,[height,width]),normalized=normalize_1.normalize(resized);return tf.transpose(normalized,[0,2,1,3])}))}(imgTensor,scale),ts=Date.now(),_a=PNet_1.PNet(resized,params),prob=_a.prob,regions=_a.regions;return statsForScale.pnet=Date.now()-ts,{scoresTensor:tf.unstack(tf.unstack(prob,3)[1])[0],regionsTensor:tf.unstack(regions)[0],scale:scale,statsForScale:statsForScale}}))})),boxesForScale=pnetOutputs.map((function(_a){var scoresTensor=_a.scoresTensor,regionsTensor=_a.regionsTensor,scale=_a.scale,statsForScale=_a.statsForScale,boundingBoxes=function(scoresTensor,regionsTensor,scale,scoreThreshold){for(var indices=[],scoresData=scoresTensor.arraySync(),y=0;y<scoresTensor.shape[0];y++)for(var x=0;x<scoresTensor.shape[1];x++)scoresData[y][x]>=scoreThreshold&&indices.push(new classes_1.Point(x,y));return indices.map((function(idx){var cell=new classes_1.BoundingBox(Math.round((idx.y*config_1.CELL_STRIDE+1)/scale),Math.round((idx.x*config_1.CELL_STRIDE+1)/scale),Math.round((idx.y*config_1.CELL_STRIDE+config_1.CELL_SIZE)/scale),Math.round((idx.x*config_1.CELL_STRIDE+config_1.CELL_SIZE)/scale)),score=scoresData[idx.y][idx.x],regionsData=regionsTensor.arraySync();return{cell:cell,score:score,region:new MtcnnBox_1.MtcnnBox(regionsData[idx.y][idx.x][0],regionsData[idx.y][idx.x][1],regionsData[idx.y][idx.x][2],regionsData[idx.y][idx.x][3])}}))}(scoresTensor,regionsTensor,scale,scoreThreshold);if(scoresTensor.dispose(),regionsTensor.dispose(),!boundingBoxes.length)return stats.stage1.push(statsForScale),[];var ts=Date.now(),indices=ops_1.nonMaxSuppression(boundingBoxes.map((function(bbox){return bbox.cell})),boundingBoxes.map((function(bbox){return bbox.score})),.5);return statsForScale.nms=Date.now()-ts,statsForScale.numBoxes=indices.length,stats.stage1.push(statsForScale),indices.map((function(boxIdx){return boundingBoxes[boxIdx]}))})),allBoxes=boxesForScale.reduce((function(all,boxes){return all.concat(boxes)}),[]),finalBoxes=[],finalScores=[];if(allBoxes.length>0){var ts=Date.now(),indices=ops_1.nonMaxSuppression(allBoxes.map((function(bbox){return bbox.cell})),allBoxes.map((function(bbox){return bbox.score})),.7);stats.stage1_nms=Date.now()-ts,finalScores=indices.map((function(idx){return allBoxes[idx].score})),finalBoxes=indices.map((function(idx){return allBoxes[idx]})).map((function(_a){var cell=_a.cell,region=_a.region;return new classes_1.BoundingBox(cell.left+region.left*cell.width,cell.top+region.top*cell.height,cell.right+region.right*cell.width,cell.bottom+region.bottom*cell.height).toSquare().round()}))}return{boxes:finalBoxes,scores:finalScores}}},{"../classes":241,"../ops":357,"./MtcnnBox":338,"./PNet":341,"./config":344,"./getSizesForScale":348,"./normalize":350,"@tensorflow/tfjs-core":113}],355:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),ops_1=require("../ops"),extractImagePatches_1=require("./extractImagePatches"),MtcnnBox_1=require("./MtcnnBox"),RNet_1=require("./RNet");exports.stage2=function(img,inputBoxes,scoreThreshold,params,stats){return tslib_1.__awaiter(this,void 0,void 0,(function(){var ts,rnetInputs,rnetOuts,scoresTensor,scores,_a,_b,indices,filteredBoxes,filteredScores,finalBoxes,finalScores,indicesNms,regions_1;return tslib_1.__generator(this,(function(_c){switch(_c.label){case 0:return ts=Date.now(),[4,extractImagePatches_1.extractImagePatches(img,inputBoxes,{width:24,height:24})];case 1:return rnetInputs=_c.sent(),stats.stage2_extractImagePatches=Date.now()-ts,ts=Date.now(),rnetOuts=rnetInputs.map((function(rnetInput){var out=RNet_1.RNet(rnetInput,params);return rnetInput.dispose(),out})),stats.stage2_rnet=Date.now()-ts,scoresTensor=rnetOuts.length>1?tf.concat(rnetOuts.map((function(out){return out.scores}))):rnetOuts[0].scores,_b=(_a=Array).from,[4,scoresTensor.data()];case 2:return scores=_b.apply(_a,[_c.sent()]),scoresTensor.dispose(),indices=scores.map((function(score,idx){return{score:score,idx:idx}})).filter((function(c){return c.score>scoreThreshold})).map((function(_a){return _a.idx})),filteredBoxes=indices.map((function(idx){return inputBoxes[idx]})),filteredScores=indices.map((function(idx){return scores[idx]})),finalBoxes=[],finalScores=[],filteredBoxes.length>0&&(ts=Date.now(),indicesNms=ops_1.nonMaxSuppression(filteredBoxes,filteredScores,.7),stats.stage2_nms=Date.now()-ts,regions_1=indicesNms.map((function(idx){var regionsData=rnetOuts[indices[idx]].regions.arraySync();return new MtcnnBox_1.MtcnnBox(regionsData[0][0],regionsData[0][1],regionsData[0][2],regionsData[0][3])})),finalScores=indicesNms.map((function(idx){return filteredScores[idx]})),finalBoxes=indicesNms.map((function(idx,i){return filteredBoxes[idx].calibrate(regions_1[i])}))),rnetOuts.forEach((function(t){t.regions.dispose(),t.scores.dispose()})),[2,{boxes:finalBoxes,scores:finalScores}]}}))}))}},{"../ops":357,"./MtcnnBox":338,"./RNet":342,"./extractImagePatches":345,"@tensorflow/tfjs-core":113,tslib:406}],356:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),ops_1=require("../ops"),extractImagePatches_1=require("./extractImagePatches"),MtcnnBox_1=require("./MtcnnBox"),ONet_1=require("./ONet");exports.stage3=function(img,inputBoxes,scoreThreshold,params,stats){return tslib_1.__awaiter(this,void 0,void 0,(function(){var ts,onetInputs,onetOuts,scoresTensor,scores,_a,_b,indices,filteredRegions,filteredBoxes,filteredScores,finalBoxes,finalScores,points,indicesNms;return tslib_1.__generator(this,(function(_c){switch(_c.label){case 0:return ts=Date.now(),[4,extractImagePatches_1.extractImagePatches(img,inputBoxes,{width:48,height:48})];case 1:return onetInputs=_c.sent(),stats.stage3_extractImagePatches=Date.now()-ts,ts=Date.now(),onetOuts=onetInputs.map((function(onetInput){var out=ONet_1.ONet(onetInput,params);return onetInput.dispose(),out})),stats.stage3_onet=Date.now()-ts,scoresTensor=onetOuts.length>1?tf.concat(onetOuts.map((function(out){return out.scores}))):onetOuts[0].scores,_b=(_a=Array).from,[4,scoresTensor.data()];case 2:return scores=_b.apply(_a,[_c.sent()]),scoresTensor.dispose(),indices=scores.map((function(score,idx){return{score:score,idx:idx}})).filter((function(c){return c.score>scoreThreshold})).map((function(_a){return _a.idx})),filteredRegions=indices.map((function(idx){var regionsData=onetOuts[idx].regions.arraySync();return new MtcnnBox_1.MtcnnBox(regionsData[0][0],regionsData[0][1],regionsData[0][2],regionsData[0][3])})),filteredBoxes=indices.map((function(idx,i){return inputBoxes[idx].calibrate(filteredRegions[i])})),filteredScores=indices.map((function(idx){return scores[idx]})),finalBoxes=[],finalScores=[],points=[],filteredBoxes.length>0&&(ts=Date.now(),indicesNms=ops_1.nonMaxSuppression(filteredBoxes,filteredScores,.7,!1),stats.stage3_nms=Date.now()-ts,finalBoxes=indicesNms.map((function(idx){return filteredBoxes[idx]})),finalScores=indicesNms.map((function(idx){return filteredScores[idx]})),points=indicesNms.map((function(idx,i){return Array(5).fill(0).map((function(_,ptIdx){var pointsData=onetOuts[idx].points.arraySync();return new classes_1.Point(pointsData[0][ptIdx]*(finalBoxes[i].width+1)+finalBoxes[i].left,pointsData[0][ptIdx+5]*(finalBoxes[i].height+1)+finalBoxes[i].top)}))}))),onetOuts.forEach((function(t){t.regions.dispose(),t.scores.dispose(),t.points.dispose()})),[2,{boxes:finalBoxes,scores:finalScores,points:points}]}}))}))}},{"../classes":241,"../ops":357,"./MtcnnBox":338,"./ONet":340,"./extractImagePatches":345,"@tensorflow/tfjs-core":113,tslib:406}],357:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./iou"),exports),tslib_1.__exportStar(require("./minBbox"),exports),tslib_1.__exportStar(require("./nonMaxSuppression"),exports),tslib_1.__exportStar(require("./normalize"),exports),tslib_1.__exportStar(require("./padToSquare"),exports),tslib_1.__exportStar(require("./shuffleArray"),exports),exports.sigmoid=function(x){return 1/(1+Math.exp(-x))},exports.inverseSigmoid=function(x){return Math.log(x/(1-x))}},{"./iou":358,"./minBbox":359,"./nonMaxSuppression":360,"./normalize":361,"./padToSquare":362,"./shuffleArray":363,tslib:406}],358:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.iou=function(box1,box2,isIOU){void 0===isIOU&&(isIOU=!0);var interSection=Math.max(0,Math.min(box1.right,box2.right)-Math.max(box1.left,box2.left))*Math.max(0,Math.min(box1.bottom,box2.bottom)-Math.max(box1.top,box2.top));return isIOU?interSection/(box1.area+box2.area-interSection):interSection/Math.min(box1.area,box2.area)}},{}],359:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes");exports.minBbox=function(pts){var xs=pts.map((function(pt){return pt.x})),ys=pts.map((function(pt){return pt.y})),minX=xs.reduce((function(min,x){return x<min?x:min}),1/0),minY=ys.reduce((function(min,y){return y<min?y:min}),1/0),maxX=xs.reduce((function(max,x){return max<x?x:max}),0),maxY=ys.reduce((function(max,y){return max<y?y:max}),0);return new classes_1.BoundingBox(minX,minY,maxX,maxY)}},{"../classes":241}],360:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var iou_1=require("./iou");exports.nonMaxSuppression=function(boxes,scores,iouThreshold,isIOU){void 0===isIOU&&(isIOU=!0);for(var indicesSortedByScore=scores.map((function(score,boxIndex){return{score:score,boxIndex:boxIndex}})).sort((function(c1,c2){return c1.score-c2.score})).map((function(c){return c.boxIndex})),pick=[],_loop_1=function(){var curr=indicesSortedByScore.pop();pick.push(curr);for(var indices=indicesSortedByScore,outputs=[],i=0;i<indices.length;i++){var idx=indices[i],currBox=boxes[curr],idxBox=boxes[idx];outputs.push(iou_1.iou(currBox,idxBox,isIOU))}indicesSortedByScore=indicesSortedByScore.filter((function(_,j){return outputs[j]<=iouThreshold}))};indicesSortedByScore.length>0;)_loop_1();return pick}},{"./iou":358}],361:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core");exports.normalize=function(x,meanRgb){return tf.tidy((function(){var r=meanRgb[0],g=meanRgb[1],b=meanRgb[2],avg_r=tf.fill(tslib_1.__spreadArrays(x.shape.slice(0,3),[1]),r),avg_g=tf.fill(tslib_1.__spreadArrays(x.shape.slice(0,3),[1]),g),avg_b=tf.fill(tslib_1.__spreadArrays(x.shape.slice(0,3),[1]),b),avg_rgb=tf.concat([avg_r,avg_g,avg_b],3);return tf.sub(x,avg_rgb)}))}},{"@tensorflow/tfjs-core":113,tslib:406}],362:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.padToSquare=function(imgTensor,isCenterImage){return void 0===isCenterImage&&(isCenterImage=!1),tf.tidy((function(){var _a=imgTensor.shape.slice(1),height=_a[0],width=_a[1];if(height===width)return imgTensor;var dimDiff=Math.abs(height-width),paddingAmount=Math.round(dimDiff*(isCenterImage?.5:1)),paddingAxis=height>width?2:1,createPaddingTensor=function(paddingAmount){var paddingTensorShape=imgTensor.shape.slice();return paddingTensorShape[paddingAxis]=paddingAmount,tf.fill(paddingTensorShape,0)},paddingTensorAppend=createPaddingTensor(paddingAmount),remainingPaddingAmount=dimDiff-paddingTensorAppend.shape[paddingAxis],tensorsToStack=[isCenterImage&&remainingPaddingAmount?createPaddingTensor(remainingPaddingAmount):null,imgTensor,paddingTensorAppend].filter((function(t){return!!t})).map((function(t){return t.toFloat()}));return tf.concat(tensorsToStack,paddingAxis)}))}},{"@tensorflow/tfjs-core":113}],363:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.shuffleArray=function(inputArray){for(var array=inputArray.slice(),i=array.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)),x=array[i];array[i]=array[j],array[j]=x}return array}},{}],364:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("./classes"),FaceDetection_1=require("./classes/FaceDetection"),FaceLandmarks_1=require("./classes/FaceLandmarks"),WithFaceDetection_1=require("./factories/WithFaceDetection"),WithFaceLandmarks_1=require("./factories/WithFaceLandmarks");exports.resizeResults=function resizeResults(results,dimensions){var _a=new classes_1.Dimensions(dimensions.width,dimensions.height),width=_a.width,height=_a.height;if(width<=0||height<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:width,height:height}));if(Array.isArray(results))return results.map((function(obj){return resizeResults(obj,{width:width,height:height})}));if(WithFaceLandmarks_1.isWithFaceLandmarks(results)){var resizedDetection=results.detection.forSize(width,height),resizedLandmarks=results.unshiftedLandmarks.forSize(resizedDetection.box.width,resizedDetection.box.height);return WithFaceLandmarks_1.extendWithFaceLandmarks(WithFaceDetection_1.extendWithFaceDetection(results,resizedDetection),resizedLandmarks)}return WithFaceDetection_1.isWithFaceDetection(results)?WithFaceDetection_1.extendWithFaceDetection(results,results.detection.forSize(width,height)):results instanceof FaceLandmarks_1.FaceLandmarks||results instanceof FaceDetection_1.FaceDetection?results.forSize(width,height):results}},{"./classes":241,"./classes/FaceDetection":230,"./classes/FaceLandmarks":231,"./factories/WithFaceDetection":319,"./factories/WithFaceLandmarks":321}],365:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),FaceDetection_1=require("../classes/FaceDetection"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),mobileNetV1_1=require("./mobileNetV1"),nonMaxSuppression_1=require("./nonMaxSuppression"),outputLayer_1=require("./outputLayer"),predictionLayer_1=require("./predictionLayer"),SsdMobilenetv1Options_1=require("./SsdMobilenetv1Options"),SsdMobilenetv1=function(_super){function SsdMobilenetv1(){return _super.call(this,"SsdMobilenetv1")||this}return tslib_1.__extends(SsdMobilenetv1,_super),SsdMobilenetv1.prototype.forwardInput=function(input){var params=this.params;if(!params)throw new Error("SsdMobilenetv1 - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(512,!1).toFloat(),x=tf.sub(tf.mul(batchTensor,tf.scalar(.007843137718737125)),tf.scalar(1)),features=mobileNetV1_1.mobileNetV1(x,params.mobilenetv1),_a=predictionLayer_1.predictionLayer(features.out,features.conv11,params.prediction_layer),boxPredictions=_a.boxPredictions,classPredictions=_a.classPredictions;return outputLayer_1.outputLayer(boxPredictions,classPredictions,params.output_layer)}))},SsdMobilenetv1.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},SsdMobilenetv1.prototype.locateFaces=function(input,options){return void 0===options&&(options={}),tslib_1.__awaiter(this,void 0,void 0,(function(){var _a,maxResults,minConfidence,netInput,_b,_boxes,_scores,boxes,scores,i,scoresData,_c,_d,indices,reshapedDims,inputSize,padX,padY,boxesData,results;return tslib_1.__generator(this,(function(_e){switch(_e.label){case 0:return _a=new SsdMobilenetv1Options_1.SsdMobilenetv1Options(options),maxResults=_a.maxResults,minConfidence=_a.minConfidence,[4,dom_1.toNetInput(input)];case 1:for(netInput=_e.sent(),_b=this.forwardInput(netInput),_boxes=_b.boxes,_scores=_b.scores,boxes=_boxes[0],scores=_scores[0],i=1;i<_boxes.length;i++)_boxes[i].dispose(),_scores[i].dispose();return _d=(_c=Array).from,[4,scores.data()];case 2:return scoresData=_d.apply(_c,[_e.sent()]),.5,indices=nonMaxSuppression_1.nonMaxSuppression(boxes,scoresData,maxResults,.5,minConfidence),reshapedDims=netInput.getReshapedInputDimensions(0),inputSize=netInput.inputSize,padX=inputSize/reshapedDims.width,padY=inputSize/reshapedDims.height,boxesData=boxes.arraySync(),results=indices.map((function(idx){var _a=[Math.max(0,boxesData[idx][0]),Math.min(1,boxesData[idx][2])].map((function(val){return val*padY})),top=_a[0],bottom=_a[1],_b=[Math.max(0,boxesData[idx][1]),Math.min(1,boxesData[idx][3])].map((function(val){return val*padX})),left=_b[0],right=_b[1];return new FaceDetection_1.FaceDetection(scoresData[idx],new classes_1.Rect(left,top,right-left,bottom-top),{height:netInput.getInputHeight(0),width:netInput.getInputWidth(0)})})),boxes.dispose(),scores.dispose(),[2,results]}}))}))},SsdMobilenetv1.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},SsdMobilenetv1.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap)},SsdMobilenetv1.prototype.extractParams=function(weights){return extractParams_1.extractParams(weights)},SsdMobilenetv1}(NeuralNetwork_1.NeuralNetwork);exports.SsdMobilenetv1=SsdMobilenetv1},{"../NeuralNetwork":221,"../classes":241,"../classes/FaceDetection":230,"../dom":269,"./SsdMobilenetv1Options":366,"./extractParams":368,"./extractParamsFromWeigthMap":369,"./mobileNetV1":371,"./nonMaxSuppression":372,"./outputLayer":373,"./predictionLayer":375,"@tensorflow/tfjs-core":113,tslib:406}],366:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var SsdMobilenetv1Options=function(){function SsdMobilenetv1Options(_a){var _b=void 0===_a?{}:_a,minConfidence=_b.minConfidence,maxResults=_b.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=minConfidence||.5,this._maxResults=maxResults||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(SsdMobilenetv1Options.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(SsdMobilenetv1Options.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),SsdMobilenetv1Options}();exports.SsdMobilenetv1Options=SsdMobilenetv1Options},{}],367:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common");exports.boxPredictionLayer=function(x,params){return tf.tidy((function(){var batchSize=x.shape[0];return{boxPredictionEncoding:tf.reshape(common_1.convLayer(x,params.box_encoding_predictor),[batchSize,-1,1,4]),classPrediction:tf.reshape(common_1.convLayer(x,params.class_predictor),[batchSize,-1,3])}}))}},{"../common":252,"@tensorflow/tfjs-core":113}],368:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common");function extractorsFactory(extractWeights,paramMappings){function extractConvParams(channelsIn,channelsOut,filterSize,mappedPrefix,isPointwiseConv){var filters=tf.tensor4d(extractWeights(channelsIn*channelsOut*filterSize*filterSize),[filterSize,filterSize,channelsIn,channelsOut]),bias=tf.tensor1d(extractWeights(channelsOut));return paramMappings.push({paramPath:mappedPrefix+"/filters"},{paramPath:mappedPrefix+"/"+(isPointwiseConv?"batch_norm_offset":"bias")}),{filters:filters,bias:bias}}function extractPointwiseConvParams(channelsIn,channelsOut,filterSize,mappedPrefix){var _a=extractConvParams(channelsIn,channelsOut,filterSize,mappedPrefix,!0);return{filters:_a.filters,batch_norm_offset:_a.bias}}function extractConvPairParams(channelsIn,channelsOut,mappedPrefix){var depthwise_conv=function(numChannels,mappedPrefix){var filters=tf.tensor4d(extractWeights(9*numChannels),[3,3,numChannels,1]),batch_norm_scale=tf.tensor1d(extractWeights(numChannels)),batch_norm_offset=tf.tensor1d(extractWeights(numChannels)),batch_norm_mean=tf.tensor1d(extractWeights(numChannels)),batch_norm_variance=tf.tensor1d(extractWeights(numChannels));return paramMappings.push({paramPath:mappedPrefix+"/filters"},{paramPath:mappedPrefix+"/batch_norm_scale"},{paramPath:mappedPrefix+"/batch_norm_offset"},{paramPath:mappedPrefix+"/batch_norm_mean"},{paramPath:mappedPrefix+"/batch_norm_variance"}),{filters:filters,batch_norm_scale:batch_norm_scale,batch_norm_offset:batch_norm_offset,batch_norm_mean:batch_norm_mean,batch_norm_variance:batch_norm_variance}}(channelsIn,mappedPrefix+"/depthwise_conv");return{depthwise_conv:depthwise_conv,pointwise_conv:extractPointwiseConvParams(channelsIn,channelsOut,1,mappedPrefix+"/pointwise_conv")}}return{extractMobilenetV1Params:function(){return{conv_0:extractPointwiseConvParams(3,32,3,"mobilenetv1/conv_0"),conv_1:extractConvPairParams(32,64,"mobilenetv1/conv_1"),conv_2:extractConvPairParams(64,128,"mobilenetv1/conv_2"),conv_3:extractConvPairParams(128,128,"mobilenetv1/conv_3"),conv_4:extractConvPairParams(128,256,"mobilenetv1/conv_4"),conv_5:extractConvPairParams(256,256,"mobilenetv1/conv_5"),conv_6:extractConvPairParams(256,512,"mobilenetv1/conv_6"),conv_7:extractConvPairParams(512,512,"mobilenetv1/conv_7"),conv_8:extractConvPairParams(512,512,"mobilenetv1/conv_8"),conv_9:extractConvPairParams(512,512,"mobilenetv1/conv_9"),conv_10:extractConvPairParams(512,512,"mobilenetv1/conv_10"),conv_11:extractConvPairParams(512,512,"mobilenetv1/conv_11"),conv_12:extractConvPairParams(512,1024,"mobilenetv1/conv_12"),conv_13:extractConvPairParams(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:extractPointwiseConvParams(1024,256,1,"prediction_layer/conv_0"),conv_1:extractPointwiseConvParams(256,512,3,"prediction_layer/conv_1"),conv_2:extractPointwiseConvParams(512,128,1,"prediction_layer/conv_2"),conv_3:extractPointwiseConvParams(128,256,3,"prediction_layer/conv_3"),conv_4:extractPointwiseConvParams(256,128,1,"prediction_layer/conv_4"),conv_5:extractPointwiseConvParams(128,256,3,"prediction_layer/conv_5"),conv_6:extractPointwiseConvParams(256,64,1,"prediction_layer/conv_6"),conv_7:extractPointwiseConvParams(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:extractConvParams(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:extractConvParams(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:extractConvParams(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:extractConvParams(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:extractConvParams(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:extractConvParams(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:extractConvParams(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:extractConvParams(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:extractConvParams(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:extractConvParams(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:extractConvParams(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:extractConvParams(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}exports.extractParams=function(weights){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,_b=extractorsFactory(extractWeights,paramMappings),extractMobilenetV1Params=_b.extractMobilenetV1Params,extractPredictionLayerParams=_b.extractPredictionLayerParams,mobilenetv1=extractMobilenetV1Params(),prediction_layer=extractPredictionLayerParams(),output_layer={extra_dim:tf.tensor3d(extractWeights(20472),[1,5118,4])};if(paramMappings.push({paramPath:"output_layer/extra_dim"}),0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{params:{mobilenetv1:mobilenetv1,prediction_layer:prediction_layer,output_layer:output_layer},paramMappings:paramMappings}}},{"../common":252,"@tensorflow/tfjs-core":113}],369:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),utils_1=require("../utils");exports.extractParamsFromWeigthMap=function(weightMap){var paramMappings=[],_a=function(weightMap,paramMappings){var extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings);function extractPointwiseConvParams(prefix,idx,mappedPrefix){return{filters:extractWeightEntry(prefix+"/Conv2d_"+idx+"_pointwise/weights",4,mappedPrefix+"/filters"),batch_norm_offset:extractWeightEntry(prefix+"/Conv2d_"+idx+"_pointwise/convolution_bn_offset",1,mappedPrefix+"/batch_norm_offset")}}function extractConvPairParams(idx){var mappedPrefix="mobilenetv1/conv_"+idx,prefixDepthwiseConv="MobilenetV1/Conv2d_"+idx+"_depthwise",mappedPrefixDepthwiseConv=mappedPrefix+"/depthwise_conv",mappedPrefixPointwiseConv=mappedPrefix+"/pointwise_conv";return{depthwise_conv:{filters:extractWeightEntry(prefixDepthwiseConv+"/depthwise_weights",4,mappedPrefixDepthwiseConv+"/filters"),batch_norm_scale:extractWeightEntry(prefixDepthwiseConv+"/BatchNorm/gamma",1,mappedPrefixDepthwiseConv+"/batch_norm_scale"),batch_norm_offset:extractWeightEntry(prefixDepthwiseConv+"/BatchNorm/beta",1,mappedPrefixDepthwiseConv+"/batch_norm_offset"),batch_norm_mean:extractWeightEntry(prefixDepthwiseConv+"/BatchNorm/moving_mean",1,mappedPrefixDepthwiseConv+"/batch_norm_mean"),batch_norm_variance:extractWeightEntry(prefixDepthwiseConv+"/BatchNorm/moving_variance",1,mappedPrefixDepthwiseConv+"/batch_norm_variance")},pointwise_conv:extractPointwiseConvParams("MobilenetV1",idx,mappedPrefixPointwiseConv)}}function extractConvParams(prefix,mappedPrefix){return{filters:extractWeightEntry(prefix+"/weights",4,mappedPrefix+"/filters"),bias:extractWeightEntry(prefix+"/biases",1,mappedPrefix+"/bias")}}function extractBoxPredictorParams(idx){return{box_encoding_predictor:extractConvParams("Prediction/BoxPredictor_"+idx+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+idx+"/box_encoding_predictor"),class_predictor:extractConvParams("Prediction/BoxPredictor_"+idx+"/ClassPredictor","prediction_layer/box_predictor_"+idx+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:extractPointwiseConvParams("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:extractConvPairParams(1),conv_2:extractConvPairParams(2),conv_3:extractConvPairParams(3),conv_4:extractConvPairParams(4),conv_5:extractConvPairParams(5),conv_6:extractConvPairParams(6),conv_7:extractConvPairParams(7),conv_8:extractConvPairParams(8),conv_9:extractConvPairParams(9),conv_10:extractConvPairParams(10),conv_11:extractConvPairParams(11),conv_12:extractConvPairParams(12),conv_13:extractConvPairParams(13)}},extractPredictionLayerParams:function(){return{conv_0:extractPointwiseConvParams("Prediction",0,"prediction_layer/conv_0"),conv_1:extractPointwiseConvParams("Prediction",1,"prediction_layer/conv_1"),conv_2:extractPointwiseConvParams("Prediction",2,"prediction_layer/conv_2"),conv_3:extractPointwiseConvParams("Prediction",3,"prediction_layer/conv_3"),conv_4:extractPointwiseConvParams("Prediction",4,"prediction_layer/conv_4"),conv_5:extractPointwiseConvParams("Prediction",5,"prediction_layer/conv_5"),conv_6:extractPointwiseConvParams("Prediction",6,"prediction_layer/conv_6"),conv_7:extractPointwiseConvParams("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:extractBoxPredictorParams(0),box_predictor_1:extractBoxPredictorParams(1),box_predictor_2:extractBoxPredictorParams(2),box_predictor_3:extractBoxPredictorParams(3),box_predictor_4:extractBoxPredictorParams(4),box_predictor_5:extractBoxPredictorParams(5)}}}}(weightMap,paramMappings),extractMobilenetV1Params=_a.extractMobilenetV1Params,extractPredictionLayerParams=_a.extractPredictionLayerParams,extra_dim=weightMap["Output/extra_dim"];if(paramMappings.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!utils_1.isTensor3D(extra_dim))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+extra_dim);var params={mobilenetv1:extractMobilenetV1Params(),prediction_layer:extractPredictionLayerParams(),output_layer:{extra_dim:extra_dim}};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common":252,"../utils":391}],370:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),SsdMobilenetv1_1=require("./SsdMobilenetv1");function createSsdMobilenetv1(weights){var net=new SsdMobilenetv1_1.SsdMobilenetv1;return net.extractWeights(weights),net}tslib_1.__exportStar(require("./SsdMobilenetv1"),exports),tslib_1.__exportStar(require("./SsdMobilenetv1Options"),exports),exports.createSsdMobilenetv1=createSsdMobilenetv1,exports.createFaceDetectionNet=function(weights){return createSsdMobilenetv1(weights)};var FaceDetectionNet=function(_super){function FaceDetectionNet(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_1.__extends(FaceDetectionNet,_super),FaceDetectionNet}(SsdMobilenetv1_1.SsdMobilenetv1);exports.FaceDetectionNet=FaceDetectionNet},{"./SsdMobilenetv1":365,"./SsdMobilenetv1Options":366,tslib:406}],371:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),pointwiseConvLayer_1=require("./pointwiseConvLayer");exports.mobileNetV1=function(x,params){return tf.tidy((function(){var conv11=null,out=pointwiseConvLayer_1.pointwiseConvLayer(x,params.conv_0,[2,2]);if([params.conv_1,params.conv_2,params.conv_3,params.conv_4,params.conv_5,params.conv_6,params.conv_7,params.conv_8,params.conv_9,params.conv_10,params.conv_11,params.conv_12,params.conv_13].forEach((function(param,i){var layerIdx=i+1,depthwiseConvStrides=function(layerIdx){return[2,4,6,12].some((function(idx){return idx===layerIdx}))?[2,2]:[1,1]}(layerIdx);out=function(x,params,strides){return tf.tidy((function(){var out=tf.depthwiseConv2d(x,params.filters,strides,"same");return out=tf.batchNorm(out,params.batch_norm_mean,params.batch_norm_variance,params.batch_norm_offset,params.batch_norm_scale,.0010000000474974513),tf.clipByValue(out,0,6)}))}(out,param.depthwise_conv,depthwiseConvStrides),out=pointwiseConvLayer_1.pointwiseConvLayer(out,param.pointwise_conv,[1,1]),11===layerIdx&&(conv11=out)})),null===conv11)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:out,conv11:conv11}}))}},{"./pointwiseConvLayer":374,"@tensorflow/tfjs-core":113}],372:[function(require,module,exports){"use strict";function IOU(boxes,i,j){var boxesData=boxes.arraySync(),yminI=Math.min(boxesData[i][0],boxesData[i][2]),xminI=Math.min(boxesData[i][1],boxesData[i][3]),ymaxI=Math.max(boxesData[i][0],boxesData[i][2]),xmaxI=Math.max(boxesData[i][1],boxesData[i][3]),yminJ=Math.min(boxesData[j][0],boxesData[j][2]),xminJ=Math.min(boxesData[j][1],boxesData[j][3]),ymaxJ=Math.max(boxesData[j][0],boxesData[j][2]),xmaxJ=Math.max(boxesData[j][1],boxesData[j][3]),areaI=(ymaxI-yminI)*(xmaxI-xminI),areaJ=(ymaxJ-yminJ)*(xmaxJ-xminJ);if(areaI<=0||areaJ<=0)return 0;var intersectionYmin=Math.max(yminI,yminJ),intersectionXmin=Math.max(xminI,xminJ),intersectionYmax=Math.min(ymaxI,ymaxJ),intersectionXmax=Math.min(xmaxI,xmaxJ),intersectionArea=Math.max(intersectionYmax-intersectionYmin,0)*Math.max(intersectionXmax-intersectionXmin,0);return intersectionArea/(areaI+areaJ-intersectionArea)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){var numBoxes=boxes.shape[0],outputSize=Math.min(maxOutputSize,numBoxes),candidates=scores.map((function(score,boxIndex){return{score:score,boxIndex:boxIndex}})).filter((function(c){return c.score>scoreThreshold})).sort((function(c1,c2){return c2.score-c1.score})),selected=[];return candidates.forEach((function(c){if(!(selected.length>=outputSize)){for(var originalScore=c.score,j=selected.length-1;j>=0;--j){var iou=IOU(boxes,c.boxIndex,selected[j]);if(0!==iou&&(c.score*=iou<=iouThreshold?1:0,c.score<=scoreThreshold))break}originalScore===c.score&&selected.push(c.boxIndex)}})),selected}},{}],373:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");function decodeBoxesLayer(x0,x1){var _a=function(x){var vec=tf.unstack(tf.transpose(x,[1,0])),sizes=[tf.sub(vec[2],vec[0]),tf.sub(vec[3],vec[1])];return{sizes:sizes,centers:[tf.add(vec[0],tf.div(sizes[0],tf.scalar(2))),tf.add(vec[1],tf.div(sizes[1],tf.scalar(2)))]}}(x0),sizes=_a.sizes,centers=_a.centers,vec=tf.unstack(tf.transpose(x1,[1,0])),div0_out=tf.div(tf.mul(tf.exp(tf.div(vec[2],tf.scalar(5))),sizes[0]),tf.scalar(2)),add0_out=tf.add(tf.mul(tf.div(vec[0],tf.scalar(10)),sizes[0]),centers[0]),div1_out=tf.div(tf.mul(tf.exp(tf.div(vec[3],tf.scalar(5))),sizes[1]),tf.scalar(2)),add1_out=tf.add(tf.mul(tf.div(vec[1],tf.scalar(10)),sizes[1]),centers[1]);return tf.transpose(tf.stack([tf.sub(add0_out,div0_out),tf.sub(add1_out,div1_out),tf.add(add0_out,div0_out),tf.add(add1_out,div1_out)]),[1,0])}exports.outputLayer=function(boxPredictions,classPredictions,params){return tf.tidy((function(){var batchSize=boxPredictions.shape[0],boxes=decodeBoxesLayer(tf.reshape(tf.tile(params.extra_dim,[batchSize,1,1]),[-1,4]),tf.reshape(boxPredictions,[-1,4]));boxes=tf.reshape(boxes,[batchSize,boxes.shape[0]/batchSize,4]);var scoresAndClasses=tf.sigmoid(tf.slice(classPredictions,[0,0,1],[-1,-1,-1])),scores=tf.slice(scoresAndClasses,[0,0,0],[-1,-1,1]);return scores=tf.reshape(scores,[batchSize,scores.shape[1]]),{boxes:tf.unstack(boxes),scores:tf.unstack(scores)}}))}},{"@tensorflow/tfjs-core":113}],374:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.pointwiseConvLayer=function(x,params,strides){return tf.tidy((function(){var out=tf.conv2d(x,params.filters,strides,"same");return out=tf.add(out,params.batch_norm_offset),tf.clipByValue(out,0,6)}))}},{"@tensorflow/tfjs-core":113}],375:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),boxPredictionLayer_1=require("./boxPredictionLayer"),pointwiseConvLayer_1=require("./pointwiseConvLayer");exports.predictionLayer=function(x,conv11,params){return tf.tidy((function(){var conv0=pointwiseConvLayer_1.pointwiseConvLayer(x,params.conv_0,[1,1]),conv1=pointwiseConvLayer_1.pointwiseConvLayer(conv0,params.conv_1,[2,2]),conv2=pointwiseConvLayer_1.pointwiseConvLayer(conv1,params.conv_2,[1,1]),conv3=pointwiseConvLayer_1.pointwiseConvLayer(conv2,params.conv_3,[2,2]),conv4=pointwiseConvLayer_1.pointwiseConvLayer(conv3,params.conv_4,[1,1]),conv5=pointwiseConvLayer_1.pointwiseConvLayer(conv4,params.conv_5,[2,2]),conv6=pointwiseConvLayer_1.pointwiseConvLayer(conv5,params.conv_6,[1,1]),conv7=pointwiseConvLayer_1.pointwiseConvLayer(conv6,params.conv_7,[2,2]),boxPrediction0=boxPredictionLayer_1.boxPredictionLayer(conv11,params.box_predictor_0),boxPrediction1=boxPredictionLayer_1.boxPredictionLayer(x,params.box_predictor_1),boxPrediction2=boxPredictionLayer_1.boxPredictionLayer(conv1,params.box_predictor_2),boxPrediction3=boxPredictionLayer_1.boxPredictionLayer(conv3,params.box_predictor_3),boxPrediction4=boxPredictionLayer_1.boxPredictionLayer(conv5,params.box_predictor_4),boxPrediction5=boxPredictionLayer_1.boxPredictionLayer(conv7,params.box_predictor_5);return{boxPredictions:tf.concat([boxPrediction0.boxPredictionEncoding,boxPrediction1.boxPredictionEncoding,boxPrediction2.boxPredictionEncoding,boxPrediction3.boxPredictionEncoding,boxPrediction4.boxPredictionEncoding,boxPrediction5.boxPredictionEncoding],1),classPredictions:tf.concat([boxPrediction0.classPrediction,boxPrediction1.classPrediction,boxPrediction2.classPrediction,boxPrediction3.classPrediction,boxPrediction4.classPrediction,boxPrediction5.classPrediction],1)}}))}},{"./boxPredictionLayer":367,"./pointwiseConvLayer":374,"@tensorflow/tfjs-core":113}],376:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),classes_1=require("../classes"),TinyYolov2Base_1=require("../tinyYolov2/TinyYolov2Base"),const_1=require("./const"),TinyFaceDetector=function(_super){function TinyFaceDetector(){var config={withSeparableConvs:!0,iouThreshold:const_1.IOU_THRESHOLD,classes:["face"],anchors:const_1.BOX_ANCHORS,meanRgb:const_1.MEAN_RGB,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};return _super.call(this,config)||this}return tslib_1.__extends(TinyFaceDetector,_super),Object.defineProperty(TinyFaceDetector.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),TinyFaceDetector.prototype.locateFaces=function(input,forwardParams){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.detect(input,forwardParams)];case 1:return[2,_a.sent().map((function(det){return new classes_1.FaceDetection(det.score,det.relativeBox,{width:det.imageWidth,height:det.imageHeight})}))]}}))}))},TinyFaceDetector.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},TinyFaceDetector.prototype.extractParamsFromWeigthMap=function(weightMap){return _super.prototype.extractParamsFromWeigthMap.call(this,weightMap)},TinyFaceDetector}(TinyYolov2Base_1.TinyYolov2Base);exports.TinyFaceDetector=TinyFaceDetector},{"../classes":241,"../tinyYolov2/TinyYolov2Base":381,"./const":378,tslib:406}],377:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),TinyFaceDetectorOptions=function(_super){function TinyFaceDetectorOptions(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this._name="TinyFaceDetectorOptions",_this}return tslib_1.__extends(TinyFaceDetectorOptions,_super),TinyFaceDetectorOptions}(require("../tinyYolov2").TinyYolov2Options);exports.TinyFaceDetectorOptions=TinyFaceDetectorOptions},{"../tinyYolov2":389,tslib:406}],378:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes");exports.IOU_THRESHOLD=.4,exports.BOX_ANCHORS=[new classes_1.Point(1.603231,2.094468),new classes_1.Point(6.041143,7.080126),new classes_1.Point(2.882459,3.518061),new classes_1.Point(4.266906,5.178857),new classes_1.Point(9.041765,10.66308)],exports.MEAN_RGB=[117.001,114.697,97.404]},{"../classes":241}],379:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),TinyFaceDetector_1=require("./TinyFaceDetector");tslib_1.__exportStar(require("./TinyFaceDetector"),exports),tslib_1.__exportStar(require("./TinyFaceDetectorOptions"),exports),exports.createTinyFaceDetector=function(weights){var net=new TinyFaceDetector_1.TinyFaceDetector;return net.extractWeights(weights),net}},{"./TinyFaceDetector":376,"./TinyFaceDetectorOptions":377,tslib:406}],380:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),classes_1=require("../classes"),const_1=require("./const"),TinyYolov2=function(_super){function TinyYolov2(withSeparableConvs){void 0===withSeparableConvs&&(withSeparableConvs=!0);var config=Object.assign({},{withSeparableConvs:withSeparableConvs,iouThreshold:const_1.IOU_THRESHOLD,classes:["face"]},withSeparableConvs?{anchors:const_1.BOX_ANCHORS_SEPARABLE,meanRgb:const_1.MEAN_RGB_SEPARABLE}:{anchors:const_1.BOX_ANCHORS,withClassScores:!0});return _super.call(this,config)||this}return tslib_1.__extends(TinyYolov2,_super),Object.defineProperty(TinyYolov2.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(TinyYolov2.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),TinyYolov2.prototype.locateFaces=function(input,forwardParams){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return[4,this.detect(input,forwardParams)];case 1:return[2,_a.sent().map((function(det){return new classes_1.FaceDetection(det.score,det.relativeBox,{width:det.imageWidth,height:det.imageHeight})}))]}}))}))},TinyYolov2.prototype.getDefaultModelName=function(){return this.withSeparableConvs?const_1.DEFAULT_MODEL_NAME_SEPARABLE_CONV:const_1.DEFAULT_MODEL_NAME},TinyYolov2.prototype.extractParamsFromWeigthMap=function(weightMap){return _super.prototype.extractParamsFromWeigthMap.call(this,weightMap)},TinyYolov2}(require("./TinyYolov2Base").TinyYolov2Base);exports.TinyYolov2=TinyYolov2},{"../classes":241,"./TinyYolov2Base":381,"./const":384,tslib:406}],381:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),BoundingBox_1=require("../classes/BoundingBox"),ObjectDetection_1=require("../classes/ObjectDetection"),common_1=require("../common"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),ops_1=require("../ops"),nonMaxSuppression_1=require("../ops/nonMaxSuppression"),normalize_1=require("../ops/normalize"),config_1=require("./config"),convWithBatchNorm_1=require("./convWithBatchNorm"),depthwiseSeparableConv_1=require("./depthwiseSeparableConv"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap"),leaky_1=require("./leaky"),TinyYolov2Options_1=require("./TinyYolov2Options"),TinyYolov2Base=function(_super){function TinyYolov2Base(config){var _this=_super.call(this,"TinyYolov2")||this;return config_1.validateConfig(config),_this._config=config,_this}return tslib_1.__extends(TinyYolov2Base,_super),Object.defineProperty(TinyYolov2Base.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(TinyYolov2Base.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(TinyYolov2Base.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),TinyYolov2Base.prototype.runTinyYolov2=function(x,params){var out=convWithBatchNorm_1.convWithBatchNorm(x,params.conv0);return out=tf.maxPool(out,[2,2],[2,2],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv1),out=tf.maxPool(out,[2,2],[2,2],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv2),out=tf.maxPool(out,[2,2],[2,2],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv3),out=tf.maxPool(out,[2,2],[2,2],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv4),out=tf.maxPool(out,[2,2],[2,2],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv5),out=tf.maxPool(out,[2,2],[1,1],"same"),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv6),out=convWithBatchNorm_1.convWithBatchNorm(out,params.conv7),common_1.convLayer(out,params.conv8,"valid",!1)},TinyYolov2Base.prototype.runMobilenet=function(x,params){var out=this.config.isFirstLayerConv2d?leaky_1.leaky(common_1.convLayer(x,params.conv0,"valid",!1)):depthwiseSeparableConv_1.depthwiseSeparableConv(x,params.conv0);return out=tf.maxPool(out,[2,2],[2,2],"same"),out=depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv1),out=tf.maxPool(out,[2,2],[2,2],"same"),out=depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv2),out=tf.maxPool(out,[2,2],[2,2],"same"),out=depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv3),out=tf.maxPool(out,[2,2],[2,2],"same"),out=depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv4),out=tf.maxPool(out,[2,2],[2,2],"same"),out=depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv5),out=tf.maxPool(out,[2,2],[1,1],"same"),out=params.conv6?depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv6):out,out=params.conv7?depthwiseSeparableConv_1.depthwiseSeparableConv(out,params.conv7):out,common_1.convLayer(out,params.conv8,"valid",!1)},TinyYolov2Base.prototype.forwardInput=function(input,inputSize){var _this=this,params=this.params;if(!params)throw new Error("TinyYolov2 - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(inputSize,!1).toFloat();return batchTensor=(batchTensor=_this.config.meanRgb?normalize_1.normalize(batchTensor,_this.config.meanRgb):batchTensor).div(tf.scalar(256)),_this.config.withSeparableConvs?_this.runMobilenet(batchTensor,params):_this.runTinyYolov2(batchTensor,params)}))},TinyYolov2Base.prototype.forward=function(input,inputSize){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[4,_a.apply(this,[_b.sent(),inputSize])];case 2:return[2,_b.sent()]}}))}))},TinyYolov2Base.prototype.detect=function(input,forwardParams){return void 0===forwardParams&&(forwardParams={}),tslib_1.__awaiter(this,void 0,void 0,(function(){var _a,inputSize,scoreThreshold,netInput,out,out0,inputDimensions,results,boxes,scores,classScores,classNames,indices,_this=this;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=new TinyYolov2Options_1.TinyYolov2Options(forwardParams),inputSize=_a.inputSize,scoreThreshold=_a.scoreThreshold,[4,dom_1.toNetInput(input)];case 1:return netInput=_b.sent(),[4,this.forwardInput(netInput,inputSize)];case 2:return out=_b.sent(),out0=tf.tidy((function(){return tf.unstack(out)[0].expandDims()})),inputDimensions={width:netInput.getInputWidth(0),height:netInput.getInputHeight(0)},[4,this.extractBoxes(out0,netInput.getReshapedInputDimensions(0),scoreThreshold)];case 3:return results=_b.sent(),out.dispose(),out0.dispose(),boxes=results.map((function(res){return res.box})),scores=results.map((function(res){return res.score})),classScores=results.map((function(res){return res.classScore})),classNames=results.map((function(res){return _this.config.classes[res.label]})),indices=nonMaxSuppression_1.nonMaxSuppression(boxes.map((function(box){return box.rescale(inputSize)})),scores,this.config.iouThreshold,!0),[2,indices.map((function(idx){return new ObjectDetection_1.ObjectDetection(scores[idx],classScores[idx],classNames[idx],boxes[idx],inputDimensions)}))]}}))}))},TinyYolov2Base.prototype.getDefaultModelName=function(){return""},TinyYolov2Base.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap,this.config)},TinyYolov2Base.prototype.extractParams=function(weights){var filterSizes=this.config.filterSizes||TinyYolov2Base.DEFAULT_FILTER_SIZES,numFilters=filterSizes?filterSizes.length:void 0;if(7!==numFilters&&8!==numFilters&&9!==numFilters)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+numFilters+" filterSizes in config");return extractParams_1.extractParams(weights,this.config,this.boxEncodingSize,filterSizes)},TinyYolov2Base.prototype.extractBoxes=function(outputTensor,inputBlobDimensions,scoreThreshold){return tslib_1.__awaiter(this,void 0,void 0,(function(){var width,height,inputSize,correctionFactorX,correctionFactorY,numCells,numBoxes,_a,boxesTensor,scoresTensor,classScoresTensor,results,scoresData,boxesData,row,col,anchor,score,ctX,ctY,width_1,height_1,x,y,pos,_b,classScore,label,_c,_this=this;return tslib_1.__generator(this,(function(_d){switch(_d.label){case 0:return width=inputBlobDimensions.width,height=inputBlobDimensions.height,inputSize=Math.max(width,height),correctionFactorX=inputSize/width,correctionFactorY=inputSize/height,numCells=outputTensor.shape[1],numBoxes=this.config.anchors.length,_a=tf.tidy((function(){var reshaped=outputTensor.reshape([numCells,numCells,numBoxes,_this.boxEncodingSize]);return[reshaped.slice([0,0,0,0],[numCells,numCells,numBoxes,4]),reshaped.slice([0,0,0,4],[numCells,numCells,numBoxes,1]),_this.withClassScores?tf.softmax(reshaped.slice([0,0,0,5],[numCells,numCells,numBoxes,_this.config.classes.length]),3):tf.scalar(0)]})),boxesTensor=_a[0],scoresTensor=_a[1],classScoresTensor=_a[2],results=[],[4,scoresTensor.array()];case 1:return scoresData=_d.sent(),[4,boxesTensor.array()];case 2:boxesData=_d.sent(),row=0,_d.label=3;case 3:if(!(row<numCells))return[3,12];col=0,_d.label=4;case 4:if(!(col<numCells))return[3,11];anchor=0,_d.label=5;case 5:return anchor<numBoxes?(score=ops_1.sigmoid(scoresData[row][col][anchor][0]),!scoreThreshold||score>scoreThreshold?(ctX=(col+ops_1.sigmoid(boxesData[row][col][anchor][0]))/numCells*correctionFactorX,ctY=(row+ops_1.sigmoid(boxesData[row][col][anchor][1]))/numCells*correctionFactorY,width_1=Math.exp(boxesData[row][col][anchor][2])*this.config.anchors[anchor].x/numCells*correctionFactorX,height_1=Math.exp(boxesData[row][col][anchor][3])*this.config.anchors[anchor].y/numCells*correctionFactorY,x=ctX-width_1/2,y=ctY-height_1/2,pos={row:row,col:col,anchor:anchor},this.withClassScores?[4,this.extractPredictedClass(classScoresTensor,pos)]:[3,7]):[3,9]):[3,10];case 6:return _c=_d.sent(),[3,8];case 7:_c={classScore:1,label:0},_d.label=8;case 8:classScore=(_b=_c).classScore,label=_b.label,results.push(tslib_1.__assign({box:new BoundingBox_1.BoundingBox(x,y,x+width_1,y+height_1),score:score,classScore:score*classScore,label:label},pos)),_d.label=9;case 9:return anchor++,[3,5];case 10:return col++,[3,4];case 11:return row++,[3,3];case 12:return boxesTensor.dispose(),scoresTensor.dispose(),classScoresTensor.dispose(),[2,results]}}))}))},TinyYolov2Base.prototype.extractPredictedClass=function(classesTensor,pos){return tslib_1.__awaiter(this,void 0,void 0,(function(){var row,col,anchor,classesData;return tslib_1.__generator(this,(function(_a){switch(_a.label){case 0:return row=pos.row,col=pos.col,anchor=pos.anchor,[4,classesTensor.array()];case 1:return classesData=_a.sent(),[2,Array(this.config.classes.length).fill(0).map((function(_,i){return classesData[row][col][anchor][i]})).map((function(classScore,label){return{classScore:classScore,label:label}})).reduce((function(max,curr){return max.classScore>curr.classScore?max:curr}))]}}))}))},TinyYolov2Base.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],TinyYolov2Base}(NeuralNetwork_1.NeuralNetwork);exports.TinyYolov2Base=TinyYolov2Base},{"../NeuralNetwork":221,"../classes/BoundingBox":227,"../classes/ObjectDetection":237,"../common":252,"../dom":269,"../ops":357,"../ops/nonMaxSuppression":360,"../ops/normalize":361,"./TinyYolov2Options":382,"./config":383,"./convWithBatchNorm":385,"./depthwiseSeparableConv":386,"./extractParams":387,"./extractParamsFromWeigthMap":388,"./leaky":390,"@tensorflow/tfjs-core":113,tslib:406}],382:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(TinyYolov2SizeType){TinyYolov2SizeType[TinyYolov2SizeType.XS=224]="XS",TinyYolov2SizeType[TinyYolov2SizeType.SM=320]="SM",TinyYolov2SizeType[TinyYolov2SizeType.MD=416]="MD",TinyYolov2SizeType[TinyYolov2SizeType.LG=608]="LG"}(exports.TinyYolov2SizeType||(exports.TinyYolov2SizeType={}));var TinyYolov2Options=function(){function TinyYolov2Options(_a){var _b=void 0===_a?{}:_a,inputSize=_b.inputSize,scoreThreshold=_b.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=inputSize||416,this._scoreThreshold=scoreThreshold||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(TinyYolov2Options.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(TinyYolov2Options.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),TinyYolov2Options}();exports.TinyYolov2Options=TinyYolov2Options},{}],383:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isNumber=function(arg){return"number"==typeof arg};exports.validateConfig=function(config){if(!config)throw new Error("invalid config: "+config);if("boolean"!=typeof config.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+config.withSeparableConvs);if(!isNumber(config.iouThreshold)||config.iouThreshold<0||config.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+config.iouThreshold);if(!Array.isArray(config.classes)||!config.classes.length||!config.classes.every((function(c){return"string"==typeof c})))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(config.classes));if(!Array.isArray(config.anchors)||!config.anchors.length||!config.anchors.map((function(a){return a||{}})).every((function(a){return isNumber(a.x)&&isNumber(a.y)})))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(config.anchors));if(config.meanRgb&&(!Array.isArray(config.meanRgb)||3!==config.meanRgb.length||!config.meanRgb.every(isNumber)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(config.meanRgb))}},{}],384:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classes_1=require("../classes");exports.IOU_THRESHOLD=.4,exports.BOX_ANCHORS=[new classes_1.Point(.738768,.874946),new classes_1.Point(2.42204,2.65704),new classes_1.Point(4.30971,7.04493),new classes_1.Point(10.246,4.59428),new classes_1.Point(12.6868,11.8741)],exports.BOX_ANCHORS_SEPARABLE=[new classes_1.Point(1.603231,2.094468),new classes_1.Point(6.041143,7.080126),new classes_1.Point(2.882459,3.518061),new classes_1.Point(4.266906,5.178857),new classes_1.Point(9.041765,10.66308)],exports.MEAN_RGB_SEPARABLE=[117.001,114.697,97.404],exports.DEFAULT_MODEL_NAME="tiny_yolov2_model",exports.DEFAULT_MODEL_NAME_SEPARABLE_CONV="tiny_yolov2_separable_conv_model"},{"../classes":241}],385:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),leaky_1=require("./leaky");exports.convWithBatchNorm=function(x,params){return tf.tidy((function(){var out=tf.pad(x,[[0,0],[1,1],[1,1],[0,0]]);return out=tf.conv2d(out,params.conv.filters,[1,1],"valid"),out=tf.sub(out,params.bn.sub),out=tf.mul(out,params.bn.truediv),out=tf.add(out,params.conv.bias),leaky_1.leaky(out)}))}},{"./leaky":390,"@tensorflow/tfjs-core":113}],386:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),leaky_1=require("./leaky");exports.depthwiseSeparableConv=function(x,params){return tf.tidy((function(){var out=tf.pad(x,[[0,0],[1,1],[1,1],[0,0]]);return out=tf.separableConv2d(out,params.depthwise_filter,params.pointwise_filter,[1,1],"valid"),out=tf.add(out,params.bias),leaky_1.leaky(out)}))}},{"./leaky":390,"@tensorflow/tfjs-core":113}],387:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),extractSeparableConvParamsFactory_1=require("../common/extractSeparableConvParamsFactory"),extractWeightsFactory_1=require("../common/extractWeightsFactory");function extractorsFactory(extractWeights,paramMappings){var extractConvParams=common_1.extractConvParamsFactory(extractWeights,paramMappings);var extractSeparableConvParams=extractSeparableConvParamsFactory_1.extractSeparableConvParamsFactory(extractWeights,paramMappings);return{extractConvParams:extractConvParams,extractConvWithBatchNormParams:function(channelsIn,channelsOut,mappedPrefix){var conv=extractConvParams(channelsIn,channelsOut,3,mappedPrefix+"/conv"),bn=function(size,mappedPrefix){var sub=tf.tensor1d(extractWeights(size)),truediv=tf.tensor1d(extractWeights(size));return paramMappings.push({paramPath:mappedPrefix+"/sub"},{paramPath:mappedPrefix+"/truediv"}),{sub:sub,truediv:truediv}}(channelsOut,mappedPrefix+"/bn");return{conv:conv,bn:bn}},extractSeparableConvParams:extractSeparableConvParams}}exports.extractParams=function(weights,config,boxEncodingSize,filterSizes){var params,_a=extractWeightsFactory_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,paramMappings=[],_b=extractorsFactory(extractWeights,paramMappings),extractConvParams=_b.extractConvParams,extractConvWithBatchNormParams=_b.extractConvWithBatchNormParams,extractSeparableConvParams=_b.extractSeparableConvParams;if(config.withSeparableConvs){var s0=filterSizes[0],s1=filterSizes[1],s2=filterSizes[2],s3=filterSizes[3],s4=filterSizes[4],s5=filterSizes[5],s6=filterSizes[6],s7=filterSizes[7],s8=filterSizes[8];params={conv0:config.isFirstLayerConv2d?extractConvParams(s0,s1,3,"conv0"):extractSeparableConvParams(s0,s1,"conv0"),conv1:extractSeparableConvParams(s1,s2,"conv1"),conv2:extractSeparableConvParams(s2,s3,"conv2"),conv3:extractSeparableConvParams(s3,s4,"conv3"),conv4:extractSeparableConvParams(s4,s5,"conv4"),conv5:extractSeparableConvParams(s5,s6,"conv5"),conv6:s7?extractSeparableConvParams(s6,s7,"conv6"):void 0,conv7:s8?extractSeparableConvParams(s7,s8,"conv7"):void 0,conv8:extractConvParams(s8||s7||s6,5*boxEncodingSize,1,"conv8")}}else{s0=filterSizes[0],s1=filterSizes[1],s2=filterSizes[2],s3=filterSizes[3],s4=filterSizes[4],s5=filterSizes[5],s6=filterSizes[6],s7=filterSizes[7],s8=filterSizes[8];params={conv0:extractConvWithBatchNormParams(s0,s1,"conv0"),conv1:extractConvWithBatchNormParams(s1,s2,"conv1"),conv2:extractConvWithBatchNormParams(s2,s3,"conv2"),conv3:extractConvWithBatchNormParams(s3,s4,"conv3"),conv4:extractConvWithBatchNormParams(s4,s5,"conv4"),conv5:extractConvWithBatchNormParams(s5,s6,"conv5"),conv6:extractConvWithBatchNormParams(s6,s7,"conv6"),conv7:extractConvWithBatchNormParams(s7,s8,"conv7"),conv8:extractConvParams(s8,5*boxEncodingSize,1,"conv8")}}if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{params:params,paramMappings:paramMappings}}},{"../common":252,"../common/extractSeparableConvParamsFactory":247,"../common/extractWeightsFactory":249,"@tensorflow/tfjs-core":113}],388:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var disposeUnusedWeightTensors_1=require("../common/disposeUnusedWeightTensors"),extractSeparableConvParamsFactory_1=require("../common/extractSeparableConvParamsFactory"),extractWeightEntryFactory_1=require("../common/extractWeightEntryFactory");function extractorsFactory(weightMap,paramMappings){var extractWeightEntry=extractWeightEntryFactory_1.extractWeightEntryFactory(weightMap,paramMappings);function extractConvParams(prefix){return{filters:extractWeightEntry(prefix+"/filters",4),bias:extractWeightEntry(prefix+"/bias",1)}}return{extractConvParams:extractConvParams,extractConvWithBatchNormParams:function(prefix){var conv=extractConvParams(prefix+"/conv"),bn=function(prefix){return{sub:extractWeightEntry(prefix+"/sub",1),truediv:extractWeightEntry(prefix+"/truediv",1)}}(prefix+"/bn");return{conv:conv,bn:bn}},extractSeparableConvParams:extractSeparableConvParamsFactory_1.loadSeparableConvParamsFactory(extractWeightEntry)}}exports.extractParamsFromWeigthMap=function(weightMap,config){var params,paramMappings=[],_a=extractorsFactory(weightMap,paramMappings),extractConvParams=_a.extractConvParams,extractConvWithBatchNormParams=_a.extractConvWithBatchNormParams,extractSeparableConvParams=_a.extractSeparableConvParams;if(config.withSeparableConvs){var numFilters=config.filterSizes&&config.filterSizes.length||9;params={conv0:config.isFirstLayerConv2d?extractConvParams("conv0"):extractSeparableConvParams("conv0"),conv1:extractSeparableConvParams("conv1"),conv2:extractSeparableConvParams("conv2"),conv3:extractSeparableConvParams("conv3"),conv4:extractSeparableConvParams("conv4"),conv5:extractSeparableConvParams("conv5"),conv6:numFilters>7?extractSeparableConvParams("conv6"):void 0,conv7:numFilters>8?extractSeparableConvParams("conv7"):void 0,conv8:extractConvParams("conv8")}}else params={conv0:extractConvWithBatchNormParams("conv0"),conv1:extractConvWithBatchNormParams("conv1"),conv2:extractConvWithBatchNormParams("conv2"),conv3:extractConvWithBatchNormParams("conv3"),conv4:extractConvWithBatchNormParams("conv4"),conv5:extractConvWithBatchNormParams("conv5"),conv6:extractConvWithBatchNormParams("conv6"),conv7:extractConvWithBatchNormParams("conv7"),conv8:extractConvParams("conv8")};return disposeUnusedWeightTensors_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:params,paramMappings:paramMappings}}},{"../common/disposeUnusedWeightTensors":244,"../common/extractSeparableConvParamsFactory":247,"../common/extractWeightEntryFactory":248}],389:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),TinyYolov2_1=require("./TinyYolov2");exports.TinyYolov2=TinyYolov2_1.TinyYolov2,tslib_1.__exportStar(require("./TinyYolov2Options"),exports),tslib_1.__exportStar(require("./config"),exports),exports.createTinyYolov2=function(weights,withSeparableConvs){void 0===withSeparableConvs&&(withSeparableConvs=!0);var net=new TinyYolov2_1.TinyYolov2(withSeparableConvs);return net.extractWeights(weights),net}},{"./TinyYolov2":380,"./TinyYolov2Options":382,"./config":383,tslib:406}],390:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");exports.leaky=function(x){return tf.tidy((function(){var min=tf.mul(x,tf.scalar(.10000000149011612));return tf.add(tf.relu(tf.sub(x,min)),min)}))}},{"@tensorflow/tfjs-core":113}],391:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),classes_1=require("../classes"),Dimensions_1=require("../classes/Dimensions");function isTensor(tensor,dim){return tensor instanceof tf.Tensor&&tensor.shape.length===dim}function isValidNumber(num){return!!num&&num!==1/0&&num!==-1/0&&!isNaN(num)||0===num}exports.isTensor=isTensor,exports.isTensor1D=function(tensor){return isTensor(tensor,1)},exports.isTensor2D=function(tensor){return isTensor(tensor,2)},exports.isTensor3D=function(tensor){return isTensor(tensor,3)},exports.isTensor4D=function(tensor){return isTensor(tensor,4)},exports.isFloat=function(num){return num%1!=0},exports.isEven=function(num){return num%2==0},exports.round=function(num,prec){void 0===prec&&(prec=2);var f=Math.pow(10,prec);return Math.floor(num*f)/f},exports.isDimensions=function(obj){return obj&&obj.width&&obj.height},exports.computeReshapedDimensions=function(_a,inputSize){var width=_a.width,height=_a.height,scale=inputSize/Math.max(height,width);return new Dimensions_1.Dimensions(Math.round(width*scale),Math.round(height*scale))},exports.getCenterPoint=function(pts){return pts.reduce((function(sum,pt){return sum.add(pt)}),new classes_1.Point(0,0)).div(new classes_1.Point(pts.length,pts.length))},exports.range=function(num,start,step){return Array(num).fill(0).map((function(_,i){return start+i*step}))},exports.isValidNumber=isValidNumber,exports.isValidProbablitiy=function(num){return isValidNumber(num)&&0<=num&&num<=1}},{"../classes":241,"../classes/Dimensions":229,"@tensorflow/tfjs-core":113}],392:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),tf=require("@tensorflow/tfjs-core"),common_1=require("../common"),dom_1=require("../dom"),NeuralNetwork_1=require("../NeuralNetwork"),ops_1=require("../ops"),utils_1=require("../utils"),extractParams_1=require("./extractParams"),extractParamsFromWeigthMap_1=require("./extractParamsFromWeigthMap");function conv(x,params,stride){return tf.add(tf.conv2d(x,params.filters,stride,"same"),params.bias)}function reductionBlock(x,params,isActivateInput){void 0===isActivateInput&&(isActivateInput=!0);var out=isActivateInput?tf.relu(x):x;return out=common_1.depthwiseSeparableConv(out,params.separable_conv0,[1,1]),out=common_1.depthwiseSeparableConv(tf.relu(out),params.separable_conv1,[1,1]),out=tf.maxPool(out,[3,3],[2,2],"same"),out=tf.add(out,conv(x,params.expansion_conv,[2,2]))}var TinyXception=function(_super){function TinyXception(numMainBlocks){var _this=_super.call(this,"TinyXception")||this;return _this._numMainBlocks=numMainBlocks,_this}return tslib_1.__extends(TinyXception,_super),TinyXception.prototype.forwardInput=function(input){var _this=this,params=this.params;if(!params)throw new Error("TinyXception - load model before inference");return tf.tidy((function(){var batchTensor=input.toBatchTensor(112,!0),normalized=ops_1.normalize(batchTensor,[122.782,117.001,104.298]).div(tf.scalar(256)),out=tf.relu(conv(normalized,params.entry_flow.conv_in,[2,2]));return out=reductionBlock(out,params.entry_flow.reduction_block_0,!1),out=reductionBlock(out,params.entry_flow.reduction_block_1),utils_1.range(_this._numMainBlocks,0,1).forEach((function(idx){out=function(x,params){var out=common_1.depthwiseSeparableConv(tf.relu(x),params.separable_conv0,[1,1]);return out=common_1.depthwiseSeparableConv(tf.relu(out),params.separable_conv1,[1,1]),out=common_1.depthwiseSeparableConv(tf.relu(out),params.separable_conv2,[1,1]),tf.add(out,x)}(out,params.middle_flow["main_block_"+idx])})),out=reductionBlock(out,params.exit_flow.reduction_block),out=tf.relu(common_1.depthwiseSeparableConv(out,params.exit_flow.separable_conv,[1,1]))}))},TinyXception.prototype.forward=function(input){return tslib_1.__awaiter(this,void 0,void 0,(function(){var _a;return tslib_1.__generator(this,(function(_b){switch(_b.label){case 0:return _a=this.forwardInput,[4,dom_1.toNetInput(input)];case 1:return[2,_a.apply(this,[_b.sent()])]}}))}))},TinyXception.prototype.getDefaultModelName=function(){return"tiny_xception_model"},TinyXception.prototype.extractParamsFromWeigthMap=function(weightMap){return extractParamsFromWeigthMap_1.extractParamsFromWeigthMap(weightMap,this._numMainBlocks)},TinyXception.prototype.extractParams=function(weights){return extractParams_1.extractParams(weights,this._numMainBlocks)},TinyXception}(NeuralNetwork_1.NeuralNetwork);exports.TinyXception=TinyXception},{"../NeuralNetwork":221,"../common":252,"../dom":269,"../ops":357,"../utils":391,"./extractParams":393,"./extractParamsFromWeigthMap":394,"@tensorflow/tfjs-core":113,tslib:406}],393:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),utils_1=require("../utils");exports.extractParams=function(weights,numMainBlocks){var paramMappings=[],_a=common_1.extractWeightsFactory(weights),extractWeights=_a.extractWeights,getRemainingWeights=_a.getRemainingWeights,_b=function(extractWeights,paramMappings){var extractConvParams=common_1.extractConvParamsFactory(extractWeights,paramMappings),extractSeparableConvParams=common_1.extractSeparableConvParamsFactory(extractWeights,paramMappings);return{extractConvParams:extractConvParams,extractSeparableConvParams:extractSeparableConvParams,extractReductionBlockParams:function(channelsIn,channelsOut,mappedPrefix){return{separable_conv0:extractSeparableConvParams(channelsIn,channelsOut,mappedPrefix+"/separable_conv0"),separable_conv1:extractSeparableConvParams(channelsOut,channelsOut,mappedPrefix+"/separable_conv1"),expansion_conv:extractConvParams(channelsIn,channelsOut,1,mappedPrefix+"/expansion_conv")}},extractMainBlockParams:function(channels,mappedPrefix){return{separable_conv0:extractSeparableConvParams(channels,channels,mappedPrefix+"/separable_conv0"),separable_conv1:extractSeparableConvParams(channels,channels,mappedPrefix+"/separable_conv1"),separable_conv2:extractSeparableConvParams(channels,channels,mappedPrefix+"/separable_conv2")}}}}(extractWeights,paramMappings),extractConvParams=_b.extractConvParams,extractSeparableConvParams=_b.extractSeparableConvParams,extractReductionBlockParams=_b.extractReductionBlockParams,extractMainBlockParams=_b.extractMainBlockParams,entry_flow={conv_in:extractConvParams(3,32,3,"entry_flow/conv_in"),reduction_block_0:extractReductionBlockParams(32,64,"entry_flow/reduction_block_0"),reduction_block_1:extractReductionBlockParams(64,128,"entry_flow/reduction_block_1")},middle_flow={};utils_1.range(numMainBlocks,0,1).forEach((function(idx){middle_flow["main_block_"+idx]=extractMainBlockParams(128,"middle_flow/main_block_"+idx)}));var exit_flow={reduction_block:extractReductionBlockParams(128,256,"exit_flow/reduction_block"),separable_conv:extractSeparableConvParams(256,512,"exit_flow/separable_conv")};if(0!==getRemainingWeights().length)throw new Error("weights remaing after extract: "+getRemainingWeights().length);return{paramMappings:paramMappings,params:{entry_flow:entry_flow,middle_flow:middle_flow,exit_flow:exit_flow}}}},{"../common":252,"../utils":391}],394:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("../common"),loadConvParamsFactory_1=require("../common/loadConvParamsFactory"),utils_1=require("../utils");exports.extractParamsFromWeigthMap=function(weightMap,numMainBlocks){var paramMappings=[],_a=function(weightMap,paramMappings){var extractWeightEntry=common_1.extractWeightEntryFactory(weightMap,paramMappings),extractConvParams=loadConvParamsFactory_1.loadConvParamsFactory(extractWeightEntry),extractSeparableConvParams=common_1.loadSeparableConvParamsFactory(extractWeightEntry);return{extractConvParams:extractConvParams,extractSeparableConvParams:extractSeparableConvParams,extractReductionBlockParams:function(mappedPrefix){return{separable_conv0:extractSeparableConvParams(mappedPrefix+"/separable_conv0"),separable_conv1:extractSeparableConvParams(mappedPrefix+"/separable_conv1"),expansion_conv:extractConvParams(mappedPrefix+"/expansion_conv")}},extractMainBlockParams:function(mappedPrefix){return{separable_conv0:extractSeparableConvParams(mappedPrefix+"/separable_conv0"),separable_conv1:extractSeparableConvParams(mappedPrefix+"/separable_conv1"),separable_conv2:extractSeparableConvParams(mappedPrefix+"/separable_conv2")}}}}(weightMap,paramMappings),extractConvParams=_a.extractConvParams,extractSeparableConvParams=_a.extractSeparableConvParams,extractReductionBlockParams=_a.extractReductionBlockParams,extractMainBlockParams=_a.extractMainBlockParams,entry_flow={conv_in:extractConvParams("entry_flow/conv_in"),reduction_block_0:extractReductionBlockParams("entry_flow/reduction_block_0"),reduction_block_1:extractReductionBlockParams("entry_flow/reduction_block_1")},middle_flow={};utils_1.range(numMainBlocks,0,1).forEach((function(idx){middle_flow["main_block_"+idx]=extractMainBlockParams("middle_flow/main_block_"+idx)}));var exit_flow={reduction_block:extractReductionBlockParams("exit_flow/reduction_block"),separable_conv:extractSeparableConvParams("exit_flow/separable_conv")};return common_1.disposeUnusedWeightTensors(weightMap,paramMappings),{params:{entry_flow:entry_flow,middle_flow:middle_flow,exit_flow:exit_flow},paramMappings:paramMappings}}},{"../common":252,"../common/loadConvParamsFactory":253,"../utils":391}],395:[function(require,module,exports){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],396:[function(require,module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],397:[function(require,module,exports){var alea=require("./lib/alea"),xor128=require("./lib/xor128"),xorwow=require("./lib/xorwow"),xorshift7=require("./lib/xorshift7"),xor4096=require("./lib/xor4096"),tychei=require("./lib/tychei"),sr=require("./seedrandom");sr.alea=alea,sr.xor128=xor128,sr.xorwow=xorwow,sr.xorshift7=xorshift7,sr.xor4096=xor4096,sr.tychei=tychei,module.exports=sr},{"./lib/alea":398,"./lib/tychei":399,"./lib/xor128":400,"./lib/xor4096":401,"./lib/xorshift7":402,"./lib/xorwow":403,"./seedrandom":404}],398:[function(require,module,exports){!function(global,module,define){function Alea(seed){var n,me=this,mash=(n=4022871197,function(data){data=data.toString();for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)});me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+11102230246251565e-32*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.alea=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],399:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var b=me.b,c=me.c,d=me.d,a=me.a;return b=b<<25^b>>>7^c,c=c-d|0,d=d<<24^d>>>8^a,a=a-b|0,me.b=b=b<<20^b>>>12^c,me.c=c=c-d|0,me.d=d<<16^c>>>16^a,me.a=a-b|0},me.a=0,me.b=0,me.c=-1640531527,me.d=1367130551,seed===Math.floor(seed)?(me.a=seed/4294967296|0,me.b=0|seed):strseed+=seed;for(var k=0;k<strseed.length+20;k++)me.b^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.a=f.a,t.b=f.b,t.c=f.c,t.d=f.d,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.tychei=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],400:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.x=0,me.y=0,me.z=0,me.w=0,me.next=function(){var t=me.x^me.x<<11;return me.x=me.y,me.y=me.z,me.z=me.w,me.w^=me.w>>>19^t^t>>>8},seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.xor128=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],401:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,w=me.w,X=me.X,i=me.i;return me.w=w=w+1640531527|0,v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,v=X[i]=v^t,me.i=i,v+(w^w>>>16)|0},function(me,seed){var t,v,i,j,w,X=[],limit=128;for(seed===(0|seed)?(v=seed,seed=null):(seed+="\0",v=0,limit=Math.max(limit,seed.length)),i=0,j=-32;j<limit;++j)seed&&(v^=seed.charCodeAt((j+32)%seed.length)),0===j&&(w=v),v^=v<<10,v^=v>>>15,v^=v<<4,v^=v>>>13,j>=0&&(w=w+1640531527|0,i=0==(t=X[127&j]^=v+w)?i+1:0);for(i>=128&&(X[127&(seed&&seed.length||0)]=-1),i=127,j=512;j>0;--j)v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,X[i]=v^t;me.w=w,me.X=X,me.i=i}(me,seed)}function copy(f,t){return t.i=f.i,t.w=f.w,t.X=f.X.slice(),t}function impl(seed,opts){null==seed&&(seed=+new Date);var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.X&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.xor4096=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],402:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,X=me.x,i=me.i;return t=X[i],v=(t^=t>>>7)^t<<24,v^=(t=X[i+1&7])^t>>>10,v^=(t=X[i+3&7])^t>>>3,v^=(t=X[i+4&7])^t<<7,t=X[i+7&7],v^=(t^=t<<13)^t<<9,X[i]=v,me.i=i+1&7,v},function(me,seed){var j,X=[];if(seed===(0|seed))X[0]=seed;else for(seed=""+seed,j=0;j<seed.length;++j)X[7&j]=X[7&j]<<15^seed.charCodeAt(j)+X[j+1&7]<<13;for(;X.length<8;)X.push(0);for(j=0;j<8&&0===X[j];++j);for(8==j?X[7]=-1:X[j],me.x=X,me.i=0,j=256;j>0;--j)me.next()}(me,seed)}function copy(f,t){return t.x=f.x.slice(),t.i=f.i,t}function impl(seed,opts){null==seed&&(seed=+new Date);var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.x&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.xorshift7=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],403:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var t=me.x^me.x>>>2;return me.x=me.y,me.y=me.z,me.z=me.w,me.w=me.v,(me.d=me.d+362437|0)+(me.v=me.v^me.v<<4^t^t<<1)|0},me.x=0,me.y=0,me.z=0,me.w=0,me.v=0,seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),k==strseed.length&&(me.d=me.x<<10^me.x>>>4),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t.v=f.v,t.d=f.d,t}function impl(seed,opts){var xg=new XorGen(seed),state=opts&&opts.state,prng=function(){return(xg.next()>>>0)/4294967296};return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define((function(){return impl})):this.xorwow=impl}(0,"object"==typeof module&&module,"function"==typeof define&&define)},{}],404:[function(require,module,exports){!function(pool,math){var nodecrypto,global=this,startdenom=math.pow(256,6),significance=math.pow(2,52),overflow=2*significance;function seedrandom(seed,options,callback){var key=[],shortseed=mixkey(flatten((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?function(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(256):(out=new Uint8Array(256),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}():seed,3),key),arc4=new ARC4(key),prng=function(){for(var n=arc4.g(6),d=startdenom,x=0;n<significance;)n=256*(n+x),d*=256,x=arc4.g(1);for(;n>=overflow;)n/=2,d/=2,x>>>=1;return(n+x)/d};return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math.random=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<256;)s[i]=i++;for(i=0;i<256;i++)s[i]=s[j=255&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=255&i+1],r=256*r+s[255&(s[i]=s[j=255&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(256)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[255&j]=255&(smear^=19*key[255&j])+stringseed.charCodeAt(j++);return tostring(key)}function tostring(a){return String.fromCharCode.apply(0,a)}if(math.seedrandom=seedrandom,mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else"function"==typeof define&&define.amd&&define((function(){return seedrandom}))}([],Math)},{crypto:218}],405:[function(require,module,exports){(function(setImmediate,clearImmediate){(function(){var nextTick=require("process/browser.js").nextTick,apply=Function.prototype.apply,slice=Array.prototype.slice,immediateIds={},nextImmediateId=0;function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(window,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;msecs>=0&&(item._idleTimeoutId=setTimeout((function(){item._onTimeout&&item._onTimeout()}),msecs))},exports.setImmediate="function"==typeof setImmediate?setImmediate:function(fn){var id=nextImmediateId++,args=!(arguments.length<2)&&slice.call(arguments,1);return immediateIds[id]=!0,nextTick((function(){immediateIds[id]&&(args?fn.apply(null,args):fn.call(null),exports.clearImmediate(id))})),id},exports.clearImmediate="function"==typeof clearImmediate?clearImmediate:function(id){delete immediateIds[id]}}).call(this)}).call(this,require("timers").setImmediate,require("timers").clearImmediate)},{"process/browser.js":396,timers:405}],406:[function(require,module,exports){(function(global){(function(){
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var __extends,__assign,__rest,__decorate,__param,__metadata,__awaiter,__generator,__exportStar,__values,__read,__spread,__spreadArrays,__await,__asyncGenerator,__asyncDelegator,__asyncValues,__makeTemplateObject,__importStar,__importDefault,__classPrivateFieldGet,__classPrivateFieldSet,__createBinding;!function(factory){var root="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:{};function createExporter(exports,previous){return exports!==root&&("function"==typeof Object.create?Object.defineProperty(exports,"__esModule",{value:!0}):exports.__esModule=!0),function(id,v){return exports[id]=previous?previous(id,v):v}}"function"==typeof define&&define.amd?define("tslib",["exports"],(function(exports){factory(createExporter(root,createExporter(exports)))})):"object"==typeof module&&"object"==typeof module.exports?factory(createExporter(root,createExporter(module.exports))):factory(createExporter(root))}((function(exporter){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};__extends=function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t},__decorate=function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__metadata=function(metadataKey,metadataValue){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)},__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__createBinding=function(o,m,k,k2){void 0===k2&&(k2=k),o[k2]=m[k]},__exportStar=function(m,exports){for(var p in m)"default"===p||exports.hasOwnProperty(p)||(exports[p]=m[p])},__values=function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__read=function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},__spread=function(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar},__spreadArrays=function(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;var r=Array(s),k=0;for(i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r},__await=function(v){return this instanceof __await?(this.v=v,this):new __await(v)},__asyncGenerator=function(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,g=generator.apply(thisArg,_arguments||[]),q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){g[n]&&(i[n]=function(v){return new Promise((function(a,b){q.push([n,v,a,b])>1||resume(n,v)}))})}function resume(n,v){try{(r=g[n](v)).value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}catch(e){settle(q[0][3],e)}var r}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){f(v),q.shift(),q.length&&resume(q[0][0],q[0][1])}},__asyncDelegator=function(o){var i,p;return i={},verb("next"),verb("throw",(function(e){throw e})),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:"return"===n}:f?f(v):v}:f}},__asyncValues=function(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,m=o[Symbol.asyncIterator];return m?m.call(o):(o=__values(o),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise((function(resolve,reject){(function(resolve,reject,d,v){Promise.resolve(v).then((function(v){resolve({value:v,done:d})}),reject)})(resolve,reject,(v=o[n](v)).done,v.value)}))}}},__makeTemplateObject=function(cooked,raw){return Object.defineProperty?Object.defineProperty(cooked,"raw",{value:raw}):cooked.raw=raw,cooked},__importStar=function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result},__importDefault=function(mod){return mod&&mod.__esModule?mod:{default:mod}},__classPrivateFieldGet=function(receiver,privateMap){if(!privateMap.has(receiver))throw new TypeError("attempted to get private field on non-instance");return privateMap.get(receiver)},__classPrivateFieldSet=function(receiver,privateMap,value){if(!privateMap.has(receiver))throw new TypeError("attempted to set private field on non-instance");return privateMap.set(receiver,value),value},exporter("__extends",__extends),exporter("__assign",__assign),exporter("__rest",__rest),exporter("__decorate",__decorate),exporter("__param",__param),exporter("__metadata",__metadata),exporter("__awaiter",__awaiter),exporter("__generator",__generator),exporter("__exportStar",__exportStar),exporter("__createBinding",__createBinding),exporter("__values",__values),exporter("__read",__read),exporter("__spread",__spread),exporter("__spreadArrays",__spreadArrays),exporter("__await",__await),exporter("__asyncGenerator",__asyncGenerator),exporter("__asyncDelegator",__asyncDelegator),exporter("__asyncValues",__asyncValues),exporter("__makeTemplateObject",__makeTemplateObject),exporter("__importStar",__importStar),exporter("__importDefault",__importDefault),exporter("__classPrivateFieldGet",__classPrivateFieldGet),exporter("__classPrivateFieldSet",__classPrivateFieldSet)}))}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],407:[function(require,module,exports){const faceapi=require("face-api.js"),sentimoodLib=require("./sentimood.js");window.Sent=class{static async loadModels(path="./src/models"){this.modelsLoaded=!0,await faceapi.loadFaceExpressionModel(path),await faceapi.loadSsdMobilenetv1Model(path),this.text=new sentimoodLib}static textPredict(text,verbose=!1){const res=this.text.analyze(text);return verbose?res:res.score}static async readFacialExpression(img,verbose=!1){const expressions=(await faceapi.detectSingleFace(img).withFaceExpressions()).expressions;return verbose?expressions:(expressionProbability=>{let maxValue=-1,primaryEmotion="";return["angry","disgusted","fearful","happy","neutral","sad","surprised"].forEach((e=>{expressionProbability[e]>maxValue&&(maxValue=expressionProbability[e],primaryEmotion=e)})),primaryEmotion})(expressions)}static getMood(){}static getTopSong(){}static getColor(){}}},{"./sentimood.js":408,"face-api.js":336}],408:[function(require,module,exports){module.exports=function(){var afinn;function Sentimood(){}return afinn={abandon:-2,abandoned:-2,abandons:-2,abducted:-2,abduction:-2,abductions:-2,abhor:-3,abhorred:-3,abhorrent:-3,abhors:-3,abilities:2,ability:2,aboard:1,absentee:-1,absentees:-1,absolve:2,absolved:2,absolves:2,absolving:2,absorbed:1,abuse:-3,abused:-3,abuses:-3,abusive:-3,accept:1,accepted:1,accepting:1,accepts:1,accident:-2,accidental:-2,accidentally:-2,accidents:-2,accomplish:2,accomplished:2,accomplishes:2,accusation:-2,accusations:-2,accuse:-2,accused:-2,accuses:-2,accusing:-2,ache:-2,achievable:1,aching:-2,acquit:2,acquits:2,acquitted:2,acquitting:2,acrimonious:-3,active:1,adequate:1,admire:3,admired:3,admires:3,admiring:3,admit:-1,admits:-1,admitted:-1,admonish:-2,admonished:-2,adopt:1,adopts:1,adorable:3,adore:3,adored:3,adores:3,advanced:1,advantage:2,advantages:2,adventure:2,adventures:2,adventurous:2,affected:-1,affection:3,affectionate:3,afflicted:-1,affronted:-1,afraid:-2,aggravate:-2,aggravated:-2,aggravates:-2,aggravating:-2,aggression:-2,aggressions:-2,aggressive:-2,aghast:-2,agog:2,agonise:-3,agonised:-3,agonises:-3,agonising:-3,agonize:-3,agonized:-3,agonizes:-3,agonizing:-3,agree:1,agreeable:2,agreed:1,agreement:1,agrees:1,alarm:-2,alarmed:-2,alarmist:-2,alarmists:-2,alas:-1,alert:-1,alienation:-2,alive:1,allergic:-2,allow:1,alone:-2,amaze:2,amazed:2,amazes:2,amazing:4,ambitious:2,ambivalent:-1,amuse:3,amused:3,amusement:3,amusements:3,anger:-3,angers:-3,angry:-3,anguish:-3,anguished:-3,animosity:-2,annoy:-2,annoyance:-2,annoyed:-2,annoying:-2,annoys:-2,antagonistic:-2,anti:-1,anticipation:1,anxiety:-2,anxious:-2,apathetic:-3,apathy:-3,apeshit:-3,apocalyptic:-2,apologise:-1,apologised:-1,apologises:-1,apologising:-1,apologize:-1,apologized:-1,apologizes:-1,apologizing:-1,apology:-1,appalled:-2,appalling:-2,appease:2,appeased:2,appeases:2,appeasing:2,applaud:2,applauded:2,applauding:2,applauds:2,applause:2,appreciate:2,appreciated:2,appreciates:2,appreciating:2,appreciation:2,apprehensive:-2,approval:2,approved:2,approves:2,ardent:1,arrest:-2,arrested:-3,arrests:-2,arrogant:-2,ashame:-2,ashamed:-2,ass:-4,assassination:-3,assassinations:-3,asset:2,assets:2,assfucking:-4,asshole:-4,astonished:2,astound:3,astounded:3,astounding:3,astoundingly:3,astounds:3,attack:-1,attacked:-1,attacking:-1,attacks:-1,attract:1,attracted:1,attracting:2,attraction:2,attractions:2,attracts:1,audacious:3,authority:1,avert:-1,averted:-1,averts:-1,avid:2,avoid:-1,avoided:-1,avoids:-1,await:-1,awaited:-1,awaits:-1,award:3,awarded:3,awards:3,awesome:4,awful:-3,awkward:-2,axe:-1,axed:-1,backed:1,backing:2,backs:1,bad:-3,badass:-3,badly:-3,bailout:-2,bamboozle:-2,bamboozled:-2,bamboozles:-2,ban:-2,banish:-1,bankrupt:-3,bankster:-3,banned:-2,bargain:2,barrier:-2,bastard:-5,bastards:-5,battle:-1,battles:-1,beaten:-2,beatific:3,beating:-1,beauties:3,beautiful:3,beautifully:3,beautify:3,belittle:-2,belittled:-2,beloved:3,benefit:2,benefits:2,benefitted:2,benefitting:2,bereave:-2,bereaved:-2,bereaves:-2,bereaving:-2,best:3,betray:-3,betrayal:-3,betrayed:-3,betraying:-3,betrays:-3,better:2,bias:-1,biased:-2,big:1,bitch:-5,bitches:-5,bitter:-2,bitterly:-2,bizarre:-2,blah:-2,blame:-2,blamed:-2,blames:-2,blaming:-2,bless:2,blesses:2,blessing:3,blind:-1,bliss:3,blissful:3,blithe:2,block:-1,blockbuster:3,blocked:-1,blocking:-1,blocks:-1,bloody:-3,blurry:-2,boastful:-2,bold:2,boldly:2,bomb:-1,boost:1,boosted:1,boosting:1,boosts:1,bore:-2,bored:-2,boring:-3,bother:-2,bothered:-2,bothers:-2,bothersome:-2,boycott:-2,boycotted:-2,boycotting:-2,boycotts:-2,brainwashing:-3,brave:2,breakthrough:3,breathtaking:5,bribe:-3,bright:1,brightest:2,brightness:1,brilliant:4,brisk:2,broke:-1,broken:-1,brooding:-2,bullied:-2,bullshit:-4,bully:-2,bullying:-2,bummer:-2,buoyant:2,burden:-2,burdened:-2,burdening:-2,burdens:-2,calm:2,calmed:2,calming:2,calms:2,cancel:-1,cancelled:-1,cancelling:-1,cancels:-1,cancer:-1,capable:1,captivated:3,care:2,carefree:1,careful:2,carefully:2,careless:-2,cares:2,casualty:-2,catastrophe:-3,catastrophic:-4,cautious:-1,celebrate:3,celebrated:3,celebrates:3,celebrating:3,censor:-2,censored:-2,censors:-2,certain:1,chagrin:-2,chagrined:-2,challenge:-1,chance:2,chances:2,chaos:-2,chaotic:-2,charged:-3,charges:-2,charm:3,charming:3,charmless:-3,chastise:-3,chastised:-3,chastises:-3,chastising:-3,cheat:-3,cheated:-3,cheater:-3,cheaters:-3,cheats:-3,cheer:2,cheered:2,cheerful:2,cheering:2,cheerless:-2,cheers:2,cheery:3,cherish:2,cherished:2,cherishes:2,cherishing:2,chic:2,childish:-2,chilling:-1,choke:-2,choked:-2,chokes:-2,choking:-2,clarifies:2,clarity:2,clash:-2,classy:3,clean:2,cleaner:2,clear:1,cleared:1,clearly:1,clears:1,clever:2,clouded:-1,clueless:-2,cock:-5,cocksucker:-5,cocksuckers:-5,cocky:-2,coerced:-2,collapse:-2,collapsed:-2,collapses:-2,collapsing:-2,collide:-1,collides:-1,colliding:-1,collision:-2,collisions:-2,colluding:-3,combat:-1,combats:-1,comedy:1,comfort:2,comfortable:2,comforting:2,comforts:2,commend:2,commended:2,commit:1,commitment:2,commits:1,committed:1,committing:1,compassionate:2,compelled:1,competent:2,competitive:2,complacent:-2,complain:-2,complained:-2,complains:-2,comprehensive:2,conciliate:2,conciliated:2,conciliates:2,conciliating:2,condemn:-2,condemnation:-2,condemned:-2,condemns:-2,confidence:2,confident:2,conflict:-2,conflicting:-2,conflictive:-2,conflicts:-2,confuse:-2,confused:-2,confusing:-2,congrats:2,congratulate:2,congratulation:2,congratulations:2,consent:2,consents:2,consolable:2,conspiracy:-3,constrained:-2,contagion:-2,contagions:-2,contagious:-1,contempt:-2,contemptuous:-2,contemptuously:-2,contend:-1,contender:-1,contending:-1,contentious:-2,contestable:-2,controversial:-2,controversially:-2,convince:1,convinced:1,convinces:1,convivial:2,cool:1,cornered:-2,corpse:-1,costly:-2,courage:2,courageous:2,courteous:2,courtesy:2,"cover-up":-3,coward:-2,cowardly:-2,coziness:2,cramp:-1,crap:-3,crash:-2,crazier:-2,craziest:-2,crazy:-2,creative:2,crestfallen:-2,cried:-2,cries:-2,crime:-3,criminal:-3,criminals:-3,crisis:-3,critic:-2,criticism:-2,criticize:-2,criticized:-2,criticizes:-2,criticizing:-2,critics:-2,cruel:-3,cruelty:-3,crush:-1,crushed:-2,crushes:-1,crushing:-1,cry:-1,crying:-2,cunt:-5,curious:1,curse:-1,cut:-1,cute:2,cuts:-1,cutting:-1,cynic:-2,cynical:-2,cynicism:-2,damage:-3,damages:-3,damn:-4,damned:-4,damnit:-4,danger:-2,daredevil:2,daring:2,darkest:-2,darkness:-1,dauntless:2,dead:-3,deadlock:-2,deafening:-1,dear:2,dearly:3,death:-2,debonair:2,debt:-2,deceit:-3,deceitful:-3,deceive:-3,deceived:-3,deceives:-3,deceiving:-3,deception:-3,decisive:1,dedicated:2,defeated:-2,defect:-3,defects:-3,defender:2,defenders:2,defenseless:-2,defer:-1,deferring:-1,defiant:-1,deficit:-2,degrade:-2,degraded:-2,degrades:-2,dehumanize:-2,dehumanized:-2,dehumanizes:-2,dehumanizing:-2,deject:-2,dejected:-2,dejecting:-2,dejects:-2,delay:-1,delayed:-1,delight:3,delighted:3,delighting:3,delights:3,demand:-1,demanded:-1,demanding:-1,demands:-1,demonstration:-1,demoralized:-2,denied:-2,denier:-2,deniers:-2,denies:-2,denounce:-2,denounces:-2,deny:-2,denying:-2,depressed:-2,depressing:-2,derail:-2,derailed:-2,derails:-2,deride:-2,derided:-2,derides:-2,deriding:-2,derision:-2,desirable:2,desire:1,desired:2,desirous:2,despair:-3,despairing:-3,despairs:-3,desperate:-3,desperately:-3,despondent:-3,destroy:-3,destroyed:-3,destroying:-3,destroys:-3,destruction:-3,destructive:-3,detached:-1,detain:-2,detained:-2,detention:-2,determined:2,devastate:-2,devastated:-2,devastating:-2,devoted:3,diamond:1,dick:-4,dickhead:-4,die:-3,died:-3,difficult:-1,diffident:-2,dilemma:-1,dipshit:-3,dire:-3,direful:-3,dirt:-2,dirtier:-2,dirtiest:-2,dirty:-2,disabling:-1,disadvantage:-2,disadvantaged:-2,disappear:-1,disappeared:-1,disappears:-1,disappoint:-2,disappointed:-2,disappointing:-2,disappointment:-2,disappointments:-2,disappoints:-2,disaster:-2,disasters:-2,disastrous:-3,disbelieve:-2,discard:-1,discarded:-1,discarding:-1,discards:-1,disconsolate:-2,disconsolation:-2,discontented:-2,discord:-2,discounted:-1,discouraged:-2,discredited:-2,disdain:-2,disgrace:-2,disgraced:-2,disguise:-1,disguised:-1,disguises:-1,disguising:-1,disgust:-3,disgusted:-3,disgusting:-3,disheartened:-2,dishonest:-2,disillusioned:-2,disinclined:-2,disjointed:-2,dislike:-2,dismal:-2,dismayed:-2,disorder:-2,disorganized:-2,disoriented:-2,disparage:-2,disparaged:-2,disparages:-2,disparaging:-2,displeased:-2,dispute:-2,disputed:-2,disputes:-2,disputing:-2,disqualified:-2,disquiet:-2,disregard:-2,disregarded:-2,disregarding:-2,disregards:-2,disrespect:-2,disrespected:-2,disruption:-2,disruptions:-2,disruptive:-2,dissatisfied:-2,distort:-2,distorted:-2,distorting:-2,distorts:-2,distract:-2,distracted:-2,distraction:-2,distracts:-2,distress:-2,distressed:-2,distresses:-2,distressing:-2,distrust:-3,distrustful:-3,disturb:-2,disturbed:-2,disturbing:-2,disturbs:-2,dithering:-2,dizzy:-1,dodging:-2,dodgy:-2,dolorous:-2,doom:-2,doomed:-2,doubt:-1,doubted:-1,doubtful:-1,doubting:-1,doubts:-1,douche:-3,douchebag:-3,downcast:-2,downhearted:-2,downside:-2,drag:-1,dragged:-1,drags:-1,drained:-2,dread:-2,dreaded:-2,dreadful:-3,dreading:-2,dream:1,dreams:1,dreary:-2,droopy:-2,drop:-1,drown:-2,drowned:-2,drowns:-2,drunk:-2,dubious:-2,dud:-2,dull:-2,dumb:-3,dumbass:-3,dump:-1,dumped:-2,dumps:-1,dupe:-2,duped:-2,dysfunction:-2,eager:2,earnest:2,ease:2,easy:1,ecstatic:4,eerie:-2,eery:-2,effective:2,effectively:2,elated:3,elation:3,elegant:2,elegantly:2,embarrass:-2,embarrassed:-2,embarrasses:-2,embarrassing:-2,embarrassment:-2,embittered:-2,embrace:1,emergency:-2,empathetic:2,emptiness:-1,empty:-1,enchanted:2,encourage:2,encouraged:2,encouragement:2,encourages:2,endorse:2,endorsed:2,endorsement:2,endorses:2,enemies:-2,enemy:-2,energetic:2,engage:1,engages:1,engrossed:1,enjoy:2,enjoying:2,enjoys:2,enlighten:2,enlightened:2,enlightening:2,enlightens:2,ennui:-2,enrage:-2,enraged:-2,enrages:-2,enraging:-2,enrapture:3,enslave:-2,enslaved:-2,enslaves:-2,ensure:1,ensuring:1,enterprising:1,entertaining:2,enthral:3,enthusiastic:3,entitled:1,entrusted:2,envies:-1,envious:-2,envy:-1,envying:-1,erroneous:-2,error:-2,errors:-2,escape:-1,escapes:-1,escaping:-1,esteemed:2,ethical:2,euphoria:3,euphoric:4,eviction:-1,evil:-3,exaggerate:-2,exaggerated:-2,exaggerates:-2,exaggerating:-2,exasperated:2,excellence:3,excellent:3,excite:3,excited:3,excitement:3,exciting:3,exclude:-1,excluded:-2,exclusion:-1,exclusive:2,excuse:-1,exempt:-1,exhausted:-2,exhilarated:3,exhilarates:3,exhilarating:3,exonerate:2,exonerated:2,exonerates:2,exonerating:2,expand:1,expands:1,expel:-2,expelled:-2,expelling:-2,expels:-2,exploit:-2,exploited:-2,exploiting:-2,exploits:-2,exploration:1,explorations:1,expose:-1,exposed:-1,exposes:-1,exposing:-1,extend:1,extends:1,exuberant:4,exultant:3,exultantly:3,fabulous:4,fad:-2,fag:-3,faggot:-3,faggots:-3,fail:-2,failed:-2,failing:-2,fails:-2,failure:-2,failures:-2,fainthearted:-2,fair:2,faith:1,faithful:3,fake:-3,fakes:-3,faking:-3,fallen:-2,falling:-1,falsified:-3,falsify:-3,fame:1,fan:3,fantastic:4,farce:-1,fascinate:3,fascinated:3,fascinates:3,fascinating:3,fascist:-2,fascists:-2,fatalities:-3,fatality:-3,fatigue:-2,fatigued:-2,fatigues:-2,fatiguing:-2,favor:2,favored:2,favorite:2,favorited:2,favorites:2,favors:2,fear:-2,fearful:-2,fearing:-2,fearless:2,fearsome:-2,feeble:-2,feeling:1,felonies:-3,felony:-3,fervent:2,fervid:2,festive:2,fiasco:-3,fidgety:-2,fight:-1,fine:2,fire:-2,fired:-2,firing:-2,fit:1,fitness:1,flagship:2,flees:-1,flop:-2,flops:-2,flu:-2,flustered:-2,focused:2,fond:2,fondness:2,fool:-2,foolish:-2,fools:-2,forced:-1,foreclosure:-2,foreclosures:-2,forget:-1,forgetful:-2,forgive:1,forgiving:1,forgotten:-1,fortunate:2,frantic:-1,fraud:-4,frauds:-4,fraudster:-4,fraudsters:-4,fraudulence:-4,fraudulent:-4,free:1,freedom:2,frenzy:-3,fresh:1,friendly:2,fright:-2,frightened:-2,frightening:-3,frikin:-2,frisky:2,frowning:-1,frustrate:-2,frustrated:-2,frustrates:-2,frustrating:-2,frustration:-2,ftw:3,fuck:-4,fucked:-4,fucker:-4,fuckers:-4,fuckface:-4,fuckhead:-4,fucking:-4,fucktard:-4,fud:-3,fuked:-4,fuking:-4,fulfill:2,fulfilled:2,fulfills:2,fuming:-2,fun:4,funeral:-1,funerals:-1,funky:2,funnier:4,funny:4,furious:-3,futile:2,gag:-2,gagged:-2,gain:2,gained:2,gaining:2,gains:2,gallant:3,gallantly:3,gallantry:3,generous:2,genial:3,ghost:-1,giddy:-2,gift:2,glad:3,glamorous:3,glamourous:3,glee:3,gleeful:3,gloom:-1,gloomy:-2,glorious:2,glory:2,glum:-2,god:1,goddamn:-3,godsend:4,good:3,goodness:3,grace:1,gracious:3,grand:3,grant:1,granted:1,granting:1,grants:1,grateful:3,gratification:2,grave:-2,gray:-1,great:3,greater:3,greatest:3,greed:-3,greedy:-2,greenwash:-3,greenwasher:-3,greenwashers:-3,greenwashing:-3,greet:1,greeted:1,greeting:1,greetings:2,greets:1,grey:-1,grief:-2,grieved:-2,gross:-2,growing:1,growth:2,guarantee:1,guilt:-3,guilty:-3,gullibility:-2,gullible:-2,gun:-1,ha:2,hacked:-1,haha:3,hahaha:3,hahahah:3,hail:2,hailed:2,hapless:-2,haplessness:-2,happiness:3,happy:3,hard:-1,hardier:2,hardship:-2,hardy:2,harm:-2,harmed:-2,harmful:-2,harming:-2,harms:-2,harried:-2,harsh:-2,harsher:-2,harshest:-2,hate:-3,hated:-3,haters:-3,hates:-3,hating:-3,haunt:-1,haunted:-2,haunting:1,haunts:-1,havoc:-2,healthy:2,heartbreaking:-3,heartbroken:-3,heartfelt:3,heaven:2,heavenly:4,heavyhearted:-2,hell:-4,help:2,helpful:2,helping:2,helpless:-2,helps:2,hero:2,heroes:2,heroic:3,hesitant:-2,hesitate:-2,hid:-1,hide:-1,hides:-1,hiding:-1,highlight:2,hilarious:2,hindrance:-2,hoax:-2,homesick:-2,honest:2,honor:2,honored:2,honoring:2,honour:2,honoured:2,honouring:2,hooligan:-2,hooliganism:-2,hooligans:-2,hope:2,hopeful:2,hopefully:2,hopeless:-2,hopelessness:-2,hopes:2,hoping:2,horrendous:-3,horrible:-3,horrific:-3,horrified:-3,hostile:-2,huckster:-2,hug:2,huge:1,hugs:2,humerous:3,humiliated:-3,humiliation:-3,humor:2,humorous:2,humour:2,humourous:2,hunger:-2,hurrah:5,hurt:-2,hurting:-2,hurts:-2,hypocritical:-2,hysteria:-3,hysterical:-3,hysterics:-3,idiot:-3,idiotic:-3,ignorance:-2,ignorant:-2,ignore:-1,ignored:-2,ignores:-1,ill:-2,illegal:-3,illiteracy:-2,illness:-2,illnesses:-2,imbecile:-3,immobilized:-1,immortal:2,immune:1,impatient:-2,imperfect:-2,importance:2,important:2,impose:-1,imposed:-1,imposes:-1,imposing:-1,impotent:-2,impress:3,impressed:3,impresses:3,impressive:3,imprisoned:-2,improve:2,improved:2,improvement:2,improves:2,improving:2,inability:-2,inaction:-2,inadequate:-2,incapable:-2,incapacitated:-2,incensed:-2,incompetence:-2,incompetent:-2,inconsiderate:-2,inconvenience:-2,inconvenient:-2,increase:1,increased:1,indecisive:-2,indestructible:2,indifference:-2,indifferent:-2,indignant:-2,indignation:-2,indoctrinate:-2,indoctrinated:-2,indoctrinates:-2,indoctrinating:-2,ineffective:-2,ineffectively:-2,infatuated:2,infatuation:2,infected:-2,inferior:-2,inflamed:-2,influential:2,infringement:-2,infuriate:-2,infuriated:-2,infuriates:-2,infuriating:-2,inhibit:-1,injured:-2,injury:-2,injustice:-2,innovate:1,innovates:1,innovation:1,innovative:2,inquisition:-2,inquisitive:2,insane:-2,insanity:-2,insecure:-2,insensitive:-2,insensitivity:-2,insignificant:-2,insipid:-2,inspiration:2,inspirational:2,inspire:2,inspired:2,inspires:2,inspiring:3,insult:-2,insulted:-2,insulting:-2,insults:-2,intact:2,integrity:2,intelligent:2,intense:1,interest:1,interested:2,interesting:2,interests:1,interrogated:-2,interrupt:-2,interrupted:-2,interrupting:-2,interruption:-2,interrupts:-2,intimidate:-2,intimidated:-2,intimidates:-2,intimidating:-2,intimidation:-2,intricate:2,intrigues:1,invincible:2,invite:1,inviting:1,invulnerable:2,irate:-3,ironic:-1,irony:-1,irrational:-1,irresistible:2,irresolute:-2,irresponsible:2,irreversible:-1,irritate:-3,irritated:-3,irritating:-3,isolated:-1,itchy:-2,jackass:-4,jackasses:-4,jailed:-2,jaunty:2,jealous:-2,jeopardy:-2,jerk:-3,jesus:1,jewel:1,jewels:1,jocular:2,join:1,joke:2,jokes:2,jolly:2,jovial:2,joy:3,joyful:3,joyfully:3,joyless:-2,joyous:3,jubilant:3,jumpy:-1,justice:2,justifiably:2,justified:2,keen:1,kill:-3,killed:-3,killing:-3,kills:-3,kind:2,kinder:2,kiss:2,kudos:3,lack:-2,lackadaisical:-2,lag:-1,lagged:-2,lagging:-2,lags:-2,lame:-2,landmark:2,laugh:1,laughed:1,laughing:1,laughs:1,laughting:1,launched:1,lawl:3,lawsuit:-2,lawsuits:-2,lazy:-1,leak:-1,leaked:-1,leave:-1,legal:1,legally:1,lenient:1,lethargic:-2,lethargy:-2,liar:-3,liars:-3,libelous:-2,lied:-2,lifesaver:4,lighthearted:1,like:2,liked:2,likes:2,limitation:-1,limited:-1,limits:-1,litigation:-1,litigious:-2,lively:2,livid:-2,lmao:4,lmfao:4,loathe:-3,loathed:-3,loathes:-3,loathing:-3,lobby:-2,lobbying:-2,lol:3,lonely:-2,lonesome:-2,longing:-1,loom:-1,loomed:-1,looming:-1,looms:-1,loose:-3,looses:-3,loser:-3,losing:-3,loss:-3,lost:-3,lovable:3,love:3,loved:3,lovelies:3,lovely:3,loving:2,lowest:-1,loyal:3,loyalty:3,luck:3,luckily:3,lucky:3,lugubrious:-2,lunatic:-3,lunatics:-3,lurk:-1,lurking:-1,lurks:-1,mad:-3,maddening:-3,"made-up":-1,madly:-3,madness:-3,mandatory:-1,manipulated:-1,manipulating:-1,manipulation:-1,marvel:3,marvelous:3,marvels:3,masterpiece:4,masterpieces:4,matter:1,matters:1,mature:2,meaningful:2,meaningless:-2,medal:3,mediocrity:-3,meditative:1,melancholy:-2,menace:-2,menaced:-2,mercy:2,merry:3,mess:-2,messed:-2,methodical:2,mindless:-2,miracle:4,mirth:3,mirthful:3,mirthfully:3,misbehave:-2,misbehaved:-2,misbehaves:-2,misbehaving:-2,mischief:-1,mischiefs:-1,miserable:-3,misery:-2,misgiving:-2,misinformation:-2,misinformed:-2,misinterpreted:-2,misleading:-3,misread:-1,misreporting:-2,misrepresentation:-2,miss:-2,missed:-2,missing:-2,mistake:-2,mistaken:-2,mistakes:-2,mistaking:-2,misunderstand:-2,misunderstanding:-2,misunderstands:-2,misunderstood:-2,moan:-2,moaned:-2,moaning:-2,moans:-2,mock:-2,mocked:-2,mocking:-2,mocks:-2,mongering:-2,monopolize:-2,monopolized:-2,monopolizes:-2,monopolizing:-2,moody:-1,mope:-1,moping:-1,moron:-3,motherfucker:-5,motherfucking:-5,motivate:1,motivated:2,motivating:2,motivation:1,mourn:-2,mourned:-2,mournful:-2,mourning:-2,mourns:-2,mumpish:-2,murder:-2,murderer:-2,murdering:-3,murderous:-3,murders:-2,myth:-1,n00b:-2,naive:-2,nasty:-3,natural:1,"naïve":-2,needy:-2,negative:-2,negativity:-2,neglect:-2,neglected:-2,neglecting:-2,neglects:-2,nerves:-1,nervous:-2,nervously:-2,nice:3,nifty:2,niggas:-5,nigger:-5,no:-1,noble:2,noisy:-1,nonsense:-2,noob:-2,nosey:-2,notorious:-2,novel:2,numb:-1,nuts:-3,obliterate:-2,obliterated:-2,obnoxious:-3,obscene:-2,obsessed:2,obsolete:-2,obstacle:-2,obstacles:-2,obstinate:-2,odd:-2,offend:-2,offended:-2,offender:-2,offending:-2,offends:-2,offline:-1,oks:2,ominous:3,"once-in-a-lifetime":3,opportunities:2,opportunity:2,oppressed:-2,oppressive:-2,optimism:2,optimistic:2,optionless:-2,outcry:-2,outmaneuvered:-2,outrage:-3,outraged:-3,outreach:2,outstanding:5,overjoyed:4,overload:-1,overlooked:-1,overreact:-2,overreacted:-2,overreaction:-2,overreacts:-2,oversell:-2,overselling:-2,oversells:-2,oversimplification:-2,oversimplified:-2,oversimplifies:-2,oversimplify:-2,overstatement:-2,overstatements:-2,overweight:-1,oxymoron:-1,pain:-2,pained:-2,panic:-3,panicked:-3,panics:-3,paradise:3,paradox:-1,pardon:2,pardoned:2,pardoning:2,pardons:2,parley:-1,passionate:2,passive:-1,passively:-1,pathetic:-2,pay:-1,peace:2,peaceful:2,peacefully:2,penalty:-2,pensive:-1,perfect:3,perfected:2,perfectly:3,perfects:2,peril:-2,perjury:-3,perpetrator:-2,perpetrators:-2,perplexed:-2,persecute:-2,persecuted:-2,persecutes:-2,persecuting:-2,perturbed:-2,pesky:-2,pessimism:-2,pessimistic:-2,petrified:-2,phobic:-2,picturesque:2,pileup:-1,pique:-2,piqued:-2,piss:-4,pissed:-4,pissing:-3,piteous:-2,pitied:-1,pity:-2,playful:2,pleasant:3,please:1,pleased:3,pleasure:3,poised:-2,poison:-2,poisoned:-2,poisons:-2,pollute:-2,polluted:-2,polluter:-2,polluters:-2,pollutes:-2,poor:-2,poorer:-2,poorest:-2,popular:3,positive:2,positively:2,possessive:-2,postpone:-1,postponed:-1,postpones:-1,postponing:-1,poverty:-1,powerful:2,powerless:-2,praise:3,praised:3,praises:3,praising:3,pray:1,praying:1,prays:1,prblm:-2,prblms:-2,prepared:1,pressure:-1,pressured:-2,pretend:-1,pretending:-1,pretends:-1,pretty:1,prevent:-1,prevented:-1,preventing:-1,prevents:-1,prick:-5,prison:-2,prisoner:-2,prisoners:-2,privileged:2,proactive:2,problem:-2,problems:-2,profiteer:-2,progress:2,prominent:2,promise:1,promised:1,promises:1,promote:1,promoted:1,promotes:1,promoting:1,propaganda:-2,prosecute:-1,prosecuted:-2,prosecutes:-1,prosecution:-1,prospect:1,prospects:1,prosperous:3,protect:1,protected:1,protects:1,protest:-2,protesters:-2,protesting:-2,protests:-2,proud:2,proudly:2,provoke:-1,provoked:-1,provokes:-1,provoking:-1,pseudoscience:-3,punish:-2,punished:-2,punishes:-2,punitive:-2,pushy:-1,puzzled:-2,quaking:-2,questionable:-2,questioned:-1,questioning:-1,racism:-3,racist:-3,racists:-3,rage:-2,rageful:-2,rainy:-1,rant:-3,ranter:-3,ranters:-3,rants:-3,rape:-4,rapist:-4,rapture:2,raptured:2,raptures:2,rapturous:4,rash:-2,ratified:2,reach:1,reached:1,reaches:1,reaching:1,reassure:1,reassured:1,reassures:1,reassuring:2,rebellion:-2,recession:-2,reckless:-2,recommend:2,recommended:2,recommends:2,redeemed:2,refuse:-2,refused:-2,refusing:-2,regret:-2,regretful:-2,regrets:-2,regretted:-2,regretting:-2,reject:-1,rejected:-1,rejecting:-1,rejects:-1,rejoice:4,rejoiced:4,rejoices:4,rejoicing:4,relaxed:2,relentless:-1,reliant:2,relieve:1,relieved:2,relieves:1,relieving:2,relishing:2,remarkable:2,remorse:-2,repulse:-1,repulsed:-2,rescue:2,rescued:2,rescues:2,resentful:-2,resign:-1,resigned:-1,resigning:-1,resigns:-1,resolute:2,resolve:2,resolved:2,resolves:2,resolving:2,respected:2,responsible:2,responsive:2,restful:2,restless:-2,restore:1,restored:1,restores:1,restoring:1,restrict:-2,restricted:-2,restricting:-2,restriction:-2,restricts:-2,retained:-1,retard:-2,retarded:-2,retreat:-1,revenge:-2,revengeful:-2,revered:2,revive:2,revives:2,reward:2,rewarded:2,rewarding:2,rewards:2,rich:2,ridiculous:-3,rig:-1,rigged:-1,rigorous:3,rigorously:3,riot:-2,riots:-2,risk:-2,risks:-2,rob:-2,robber:-2,robed:-2,robing:-2,robs:-2,robust:2,rofl:4,roflcopter:4,roflmao:4,romance:2,rotfl:4,rotflmfao:4,rotflol:4,ruin:-2,ruined:-2,ruining:-2,ruins:-2,sabotage:-2,sad:-2,sadden:-2,saddened:-2,sadly:-2,safe:1,safely:1,safety:1,salient:1,sappy:-1,sarcastic:-2,satisfied:2,save:2,saved:2,scam:-2,scams:-2,scandal:-3,scandalous:-3,scandals:-3,scapegoat:-2,scapegoats:-2,scare:-2,scared:-2,scary:-2,sceptical:-2,scold:-2,scoop:3,scorn:-2,scornful:-2,scream:-2,screamed:-2,screaming:-2,screams:-2,screwed:-2,scumbag:-4,secure:2,secured:2,secures:2,sedition:-2,seditious:-2,seduced:-1,"self-confident":2,"self-deluded":-2,selfish:-3,selfishness:-3,sentence:-2,sentenced:-2,sentences:-2,sentencing:-2,serene:2,severe:-2,sexy:3,shaky:-2,shame:-2,shamed:-2,shameful:-2,share:1,shared:1,shares:1,shattered:-2,shit:-4,shithead:-4,shitty:-3,shock:-2,shocked:-2,shocking:-2,shocks:-2,shoot:-1,"short-sighted":-2,"short-sightedness":-2,shortage:-2,shortages:-2,shrew:-4,shy:-1,sick:-2,sigh:-2,significance:1,significant:1,silencing:-1,silly:-1,sincere:2,sincerely:2,sincerest:2,sincerity:2,sinful:-3,singleminded:-2,skeptic:-2,skeptical:-2,skepticism:-2,skeptics:-2,slam:-2,slash:-2,slashed:-2,slashes:-2,slashing:-2,slavery:-3,sleeplessness:-2,slick:2,slicker:2,slickest:2,sluggish:-2,slut:-5,smart:1,smarter:2,smartest:2,smear:-2,smile:2,smiled:2,smiles:2,smiling:2,smog:-2,sneaky:-1,snub:-2,snubbed:-2,snubbing:-2,snubs:-2,sobering:1,solemn:-1,solid:2,solidarity:2,solution:1,solutions:1,solve:1,solved:1,solves:1,solving:1,somber:-2,"son-of-a-bitch":-5,soothe:3,soothed:3,soothing:3,sophisticated:2,sore:-1,sorrow:-2,sorrowful:-2,sorry:-1,spam:-2,spammer:-3,spammers:-3,spamming:-2,spark:1,sparkle:3,sparkles:3,sparkling:3,speculative:-2,spirit:1,spirited:2,spiritless:-2,spiteful:-2,splendid:3,sprightly:2,squelched:-1,stab:-2,stabbed:-2,stable:2,stabs:-2,stall:-2,stalled:-2,stalling:-2,stamina:2,stampede:-2,startled:-2,starve:-2,starved:-2,starves:-2,starving:-2,steadfast:2,steal:-2,steals:-2,stereotype:-2,stereotyped:-2,stifled:-1,stimulate:1,stimulated:1,stimulates:1,stimulating:2,stingy:-2,stolen:-2,stop:-1,stopped:-1,stopping:-1,stops:-1,stout:2,straight:1,strange:-1,strangely:-1,strangled:-2,strength:2,strengthen:2,strengthened:2,strengthening:2,strengthens:2,stressed:-2,stressor:-2,stressors:-2,stricken:-2,strike:-1,strikers:-2,strikes:-1,strong:2,stronger:2,strongest:2,struck:-1,struggle:-2,struggled:-2,struggles:-2,struggling:-2,stubborn:-2,stuck:-2,stunned:-2,stunning:4,stupid:-2,stupidly:-2,suave:2,substantial:1,substantially:1,subversive:-2,success:2,successful:3,suck:-3,sucks:-3,suffer:-2,suffering:-2,suffers:-2,suicidal:-2,suicide:-2,suing:-2,sulking:-2,sulky:-2,sullen:-2,sunshine:2,super:3,superb:5,superior:2,support:2,supported:2,supporter:1,supporters:1,supporting:1,supportive:2,supports:2,survived:2,surviving:2,survivor:2,suspect:-1,suspected:-1,suspecting:-1,suspects:-1,suspend:-1,suspended:-1,suspicious:-2,swear:-2,swearing:-2,swears:-2,sweet:2,swift:2,swiftly:2,swindle:-3,swindles:-3,swindling:-3,sympathetic:2,sympathy:2,tard:-2,tears:-2,tender:2,tense:-2,tension:-1,terrible:-3,terribly:-3,terrific:4,terrified:-3,terror:-3,terrorize:-3,terrorized:-3,terrorizes:-3,thank:2,thankful:2,thanks:2,thorny:-2,thoughtful:2,thoughtless:-2,threat:-2,threaten:-2,threatened:-2,threatening:-2,threatens:-2,threats:-2,thrilled:5,thwart:-2,thwarted:-2,thwarting:-2,thwarts:-2,timid:-2,timorous:-2,tired:-2,tits:-2,tolerant:2,toothless:-2,top:2,tops:2,torn:-2,torture:-4,tortured:-4,tortures:-4,torturing:-4,totalitarian:-2,totalitarianism:-2,tout:-2,touted:-2,touting:-2,touts:-2,tragedy:-2,tragic:-2,tranquil:2,trap:-1,trapped:-2,trauma:-3,traumatic:-3,travesty:-2,treason:-3,treasonous:-3,treasure:2,treasures:2,trembling:-2,tremulous:-2,tricked:-2,trickery:-2,triumph:4,triumphant:4,trouble:-2,troubled:-2,troubles:-2,true:2,trust:1,trusted:2,tumor:-2,twat:-5,ugly:-3,unacceptable:-2,unappreciated:-2,unapproved:-2,unaware:-2,unbelievable:-1,unbelieving:-1,unbiased:2,uncertain:-1,unclear:-1,uncomfortable:-2,unconcerned:-2,unconfirmed:-1,unconvinced:-1,uncredited:-1,undecided:-1,underestimate:-1,underestimated:-1,underestimates:-1,underestimating:-1,undermine:-2,undermined:-2,undermines:-2,undermining:-2,undeserving:-2,undesirable:-2,uneasy:-2,unemployment:-2,unequal:-1,unequaled:2,unethical:-2,unfair:-2,unfocused:-2,unfulfilled:-2,unhappy:-2,unhealthy:-2,unified:1,unimpressed:-2,unintelligent:-2,united:1,unjust:-2,unlovable:-2,unloved:-2,unmatched:1,unmotivated:-2,unprofessional:-2,unresearched:-2,unsatisfied:-2,unsecured:-2,unsettled:-1,unsophisticated:-2,unstable:-2,unstoppable:2,unsupported:-2,unsure:-1,untarnished:2,unwanted:-2,unworthy:-2,upset:-2,upsets:-2,upsetting:-2,uptight:-2,urgent:-1,useful:2,usefulness:2,useless:-2,uselessness:-2,vague:-2,validate:1,validated:1,validates:1,validating:1,verdict:-1,verdicts:-1,vested:1,vexation:-2,vexing:-2,vibrant:3,vicious:-2,victim:-3,victimize:-3,victimized:-3,victimizes:-3,victimizing:-3,victims:-3,vigilant:3,vile:-3,vindicate:2,vindicated:2,vindicates:2,vindicating:2,violate:-2,violated:-2,violates:-2,violating:-2,violence:-3,violent:-3,virtuous:2,virulent:-2,vision:1,visionary:3,visioning:1,visions:1,vitality:3,vitamin:1,vitriolic:-3,vivacious:3,vociferous:-1,vulnerability:-2,vulnerable:-2,walkout:-2,walkouts:-2,wanker:-3,want:1,war:-2,warfare:-2,warm:1,warmth:2,warn:-2,warned:-2,warning:-3,warnings:-3,warns:-2,waste:-1,wasted:-2,wasting:-2,wavering:-1,weak:-2,weakness:-2,wealth:3,wealthy:2,weary:-2,weep:-2,weeping:-2,weird:-2,welcome:2,welcomed:2,welcomes:2,whimsical:1,whitewash:-3,whore:-4,wicked:-2,widowed:-1,willingness:2,win:4,winner:4,winning:4,wins:4,winwin:3,wish:1,wishes:1,wishing:1,withdrawal:-3,woebegone:-2,woeful:-3,won:3,wonderful:4,woo:3,woohoo:3,wooo:4,woow:4,worn:-1,worried:-3,worry:-3,worrying:-3,worse:-3,worsen:-3,worsened:-3,worsening:-3,worsens:-3,worshiped:3,worst:-3,worth:2,worthless:-2,worthy:2,wow:4,wowow:4,wowww:4,wrathful:-3,wreck:-2,wrong:-2,wronged:-2,wtf:-4,yeah:1,yearning:1,yeees:2,yes:1,youthful:2,yucky:-2,yummy:3,zealot:-2,zealots:-2,zealous:2},Sentimood.prototype.negativity=function(phrase){var addPush,hits,i,item,j,len,tokens,words;for(addPush=function(t,score){return hits-=score,words.push(t)},tokens=phrase.replace(/[^a-zA-Z ]+/g," ").replace("/ {2,}/"," ").toLowerCase().split(" "),hits=0,words=[],i=j=0,len=tokens.length;j<len;i=++j)item=tokens[i],afinn.hasOwnProperty(item)&&afinn[item]<0&&addPush(item,afinn[item]);return{score:hits/Math.max(1,words.length)/5,words:words}},Sentimood.prototype.positivity=function(phrase){var addPush,hits,i,item,j,len,tokens,words;for(addPush=function(t,score){return hits+=score,words.push(t)},tokens=phrase.replace(/[^a-zA-Z ]+/g," ").replace("/ {2,}/"," ").toLowerCase().split(" "),hits=0,words=[],i=j=0,len=tokens.length;j<len;i=++j)item=tokens[i],afinn.hasOwnProperty(item)&&afinn[item]>0&&addPush(item,afinn[item]);return{score:hits/Math.max(1,words.length)/5,words:words}},Sentimood.prototype.analyze=function(phrase){var neg,pos;return pos=Sentimood.prototype.positivity(phrase),neg=Sentimood.prototype.negativity(phrase),{score:pos.score-neg.score,positive:pos,negative:neg}},Sentimood}()},{}]},{},[407]);